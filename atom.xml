<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Fox Home</title>
  
  <subtitle>清疚</subtitle>
  <link href="https://foolishfox.cn/atom.xml" rel="self"/>
  
  <link href="https://foolishfox.cn/"/>
  <updated>2024-02-12T07:36:52.000Z</updated>
  <id>https://foolishfox.cn/</id>
  
  <author>
    <name>YiHui Liu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hexo 配置 Typst 代码高亮</title>
    <link href="https://foolishfox.cn/posts/202402-typst-block.html"/>
    <id>https://foolishfox.cn/posts/202402-typst-block.html</id>
    <published>2024-02-12T07:36:52.000Z</published>
    <updated>2024-02-12T07:36:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>Hexo</code> 处理的代码块会被包裹在 <code>figure table tbody tr &gt; td.code pre</code> 中，每一行代码又被 <code>span</code> 包裹，如果需要加入对 <code>Typst</code> 的支持，需要将所有的代码重新提取出来，处理后之后再填入，有两种方法可以选择：</p><ol><li>前端修改：在 <code>html</code> 页面中读取代码块元素，提取代码处理后再填入<sup><a href="#refer-1">(1)</a></sup></li><li><a href="#%E6%A0%87%E7%AD%BE%E6%8F%92%E4%BB%B6">标签插件（<strong>推荐</strong>）</a>：在 <code>hexo</code> 生成的过程中使用标签插件 <sup><a href="#refer-2">(2)</a></sup> 处理</li></ol><h2 id="前端修改">前端修改<a class="header-anchor" href="#前端修改">¶</a></h2><div class="note danger flat"><p>此方法可能需要刷新才能正常显示<br>此方法会将所有的 <code>plaintext</code> 识别为 <code>typst</code>，可以通过在第一行加一行说明语言来处理</p></div><h3 id="引入js文件">引入<code>js</code>文件<a class="header-anchor" href="#引入js文件">¶</a></h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://foolishfox.cn/js/hl.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">&quot;script-main&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/@myriaddreamin/highlighter-typst/dist/cjs/contrib/hljs/typst.bundle.js&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="注册-Typst">注册 <code>Typst</code><a class="header-anchor" href="#注册-Typst">¶</a></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">run</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    $typst$parserModule.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        hljs.<span class="title function_">registerLanguage</span>(</span><br><span class="line">            <span class="string">&#x27;typst&#x27;</span>,</span><br><span class="line">            <span class="variable language_">window</span>.<span class="title function_">hljsTypst</span>(&#123;</span><br><span class="line">                <span class="attr">codeBlockDefaultLanguage</span>: <span class="string">&#x27;typst&#x27;</span>,</span><br><span class="line">            &#125;),</span><br><span class="line">        );</span><br><span class="line">        hljs.<span class="title function_">configure</span>(&#123;</span><br><span class="line">            <span class="attr">classPrefix</span>: <span class="string">&#x27;&#x27;</span> <span class="comment">// don&#x27;t append class prefix</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;figure table tbody tr &gt; td.code pre&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">el</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!el.<span class="title function_">getAttribute</span>(<span class="string">&#x27;data-highlighted&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">var</span> pre = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;pre&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> lang = el.<span class="property">parentNode</span>.<span class="property">parentNode</span>.<span class="property">parentNode</span>.<span class="property">parentNode</span>.<span class="property">parentNode</span>.<span class="property">classList</span>[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">var</span> code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; el.<span class="property">childElementCount</span>; i++)&#123;</span><br><span class="line">                    ch = el.<span class="property">children</span>[i];</span><br><span class="line">                    <span class="keyword">if</span> (ch.<span class="property">tagName</span> == <span class="string">&quot;SPAN&quot;</span>) code += ch.<span class="property">textContent</span>;</span><br><span class="line">                    <span class="keyword">if</span> (ch.<span class="property">tagName</span> == <span class="string">&quot;BR&quot;</span>) code += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (lang == <span class="string">&quot;plaintext&quot;</span>) &#123;</span><br><span class="line">                    lang = <span class="string">&quot;typst&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (lang != <span class="string">&quot;plaintext&quot;</span>) &#123;</span><br><span class="line">                    el.<span class="property">innerHTML</span> = hljs.<span class="title function_">highlight</span>(code, &#123;<span class="attr">language</span>: lang&#125;).<span class="property">value</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">run</span>();</span><br></pre></td></tr></table></figure><h2 id="标签插件">标签插件<a class="header-anchor" href="#标签插件">¶</a></h2><div class="note info flat"><p>文件下载：</p><ul><li><a href="https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.js">typst.js</a> <sup>修改自<a href="#refer-4">(4)</a></sup></li><li><a href="https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.bundle.js">typst.bundle.js</a> <sup>修改自<a href="#refer-3">(3)</a></sup><br>下载后放置在 <code>Hexo</code> 根目录下的 <code>scripts</code> 目录中</li></ul></div><p>查看 <code>Hexo</code> 原生处理代码块的逻辑 <sup><a href="#refer-4">(4)</a></sup>：</p><figure class="highlight js"><figcaption><span>register</span><a href="https://github.com/hexojs/hexo/blob/master/lib/plugins/tag/index.ts">plugins/tag/index.ts</a></figcaption><table><tr><td class="gutter"><pre><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> code = <span class="built_in">require</span>(<span class="string">&#x27;./code&#x27;</span>)(ctx);</span><br><span class="line"></span><br><span class="line">tag.<span class="title function_">register</span>(<span class="string">&#x27;code&#x27;</span>, code, <span class="literal">true</span>);</span><br><span class="line">tag.<span class="title function_">register</span>(<span class="string">&#x27;codeblock&#x27;</span>, code, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>在 <code>code</code> 模块中，先对传入的参数进行了解析，然后再调用 <code>hexo-utils</code> 的 <code>highlight</code> 进行渲染：</p><figure class="highlight js"><figcaption><span>code</span><a href="https://github.com/hexojs/hexo/blob/master/lib/plugins/tag/code.ts">plugins/tag/code.ts</a></figcaption><table><tr><td class="gutter"><pre><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseArgs</span>(<span class="params">args: string[]</span>): <span class="title class_">HighlightOptions</span> &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    lang,</span><br><span class="line">    language_attr,</span><br><span class="line">    firstLine,</span><br><span class="line">    caption,</span><br><span class="line">    line_number,</span><br><span class="line">    line_threshold,</span><br><span class="line">    mark,</span><br><span class="line">    wrap</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">ctx</span> =&gt;</span> <span class="keyword">function</span> <span class="title function_">codeTag</span>(<span class="params">args, content</span>) &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">const</span> options = <span class="title function_">parseArgs</span>(args);</span><br><span class="line">    options.<span class="property">lines_length</span> = content.<span class="title function_">split</span>(<span class="string">&#x27;\n&#x27;</span>).<span class="property">length</span>;</span><br><span class="line">    content = ctx.<span class="property">extend</span>.<span class="property">highlight</span>.<span class="title function_">exec</span>(ctx.<span class="property">config</span>.<span class="property">syntax_highlighter</span>, &#123;</span><br><span class="line">        <span class="attr">context</span>: ctx,</span><br><span class="line">        <span class="attr">args</span>: [content, options]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> content.<span class="title function_">replace</span>(<span class="regexp">/&#123;/g</span>, <span class="string">&#x27;&amp;#123;&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/&#125;/g</span>, <span class="string">&#x27;&amp;#125;&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>所以我们可以在返回 <code>content</code> 之前对其进行处理，处理的逻辑与前一种方法是类似的，首先导入所需要的模块：</p><figure class="highlight js"><figcaption><span>import</span><a href="https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.js">typst.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hljs = <span class="built_in">require</span>(<span class="string">&#x27;highlight.js&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> highlight = <span class="built_in">require</span>(<span class="string">&#x27;hexo-util&#x27;</span>).<span class="property">highlight</span>;</span><br><span class="line"><span class="keyword">const</span> typstBunlde = <span class="built_in">require</span>(<span class="string">&#x27;./typst.bundle&#x27;</span>);</span><br></pre></td></tr></table></figure><p>然后获取 <code>highlight</code> 处理过后的代码块：</p><figure class="highlight js"><figcaption><span>highlight process</span><a href="https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.js">typst.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">codeTypst</span> = (<span class="params">args, content</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> options = <span class="title function_">parseArgs</span>(args);</span><br><span class="line">    options.<span class="property">lines_length</span> = content.<span class="title function_">split</span>(<span class="string">&#x27;\n&#x27;</span>).<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> line_threshold = options.<span class="property">line_threshold</span> || <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> shouldUseLineNumbers = options.<span class="property">line_number</span>;</span><br><span class="line">    <span class="keyword">const</span> surpassesLineThreshold = options.<span class="property">lines_length</span> &gt; line_threshold;</span><br><span class="line">    <span class="keyword">const</span> gutter = shouldUseLineNumbers &amp;&amp; surpassesLineThreshold;</span><br><span class="line">    <span class="keyword">const</span> hljsOptions = &#123;</span><br><span class="line">        <span class="attr">caption</span>: options.<span class="property">caption</span>,</span><br><span class="line">        <span class="attr">firstLine</span>: options.<span class="property">firstLine</span>,</span><br><span class="line">        gutter,</span><br><span class="line">        <span class="attr">mark</span>: options.<span class="property">mark</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> contentHljs = <span class="title function_">highlight</span>(content, hljsOptions);</span><br><span class="line">    contentHljs = contentHljs.<span class="title function_">replace</span>(<span class="regexp">/&#123;/g</span>, <span class="string">&#x27;&amp;#123;&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/&#125;/g</span>, <span class="string">&#x27;&amp;#125;&#x27;</span>);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后注册 <code>Typst</code> 语言，并提取代码进行处理：</p><figure class="highlight js"><figcaption><span>extract and process</span><a href="https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.js">typst.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">codeTypst</span> = (<span class="params">args, content</span>) =&gt; &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> typstBunlde.<span class="property">parserModule</span>.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        hljs.<span class="title function_">registerLanguage</span>(</span><br><span class="line">            <span class="string">&#x27;typst&#x27;</span>,</span><br><span class="line">            typstBunlde.<span class="title function_">hljsTypst</span>(&#123;</span><br><span class="line">                <span class="attr">codeBlockDefaultLanguage</span>: <span class="string">&#x27;typst&#x27;</span>,</span><br><span class="line">            &#125;),</span><br><span class="line">        )</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> re = <span class="regexp">/&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;(.+)&lt;\/pre&gt;&lt;\/td&gt;/i</span>;</span><br><span class="line">        <span class="keyword">var</span> code = hljs.<span class="title function_">highlight</span>(content, &#123;<span class="attr">language</span>: <span class="string">&#x27;typst&#x27;</span>&#125;).<span class="property">value</span>;</span><br><span class="line">        contentHljs = contentHljs.<span class="title function_">replace</span>(<span class="string">&quot;highlight plaintext&quot;</span>, <span class="string">&quot;highlight typst&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> contentHljs.<span class="title function_">replace</span>(re, <span class="string">`&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;<span class="subst">$&#123;code&#125;</span>&lt;/pre&gt;&lt;/td&gt;`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后在 <code>Hexo</code> 中注册这个标签插件，由于注册 <code>Typst</code> 语言并处理的过程是异步的，所以这里也要开启异步选项：</p><figure class="highlight js"><figcaption><span>register with async</span><a href="https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.js">typst.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo.<span class="property">extend</span>.<span class="property">tag</span>.<span class="title function_">register</span>(<span class="string">&#x27;typst&#x27;</span>, codeTypst, &#123;<span class="attr">ends</span>: <span class="literal">true</span>, <span class="attr">async</span>: <span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure><h2 id="示例">示例<a class="header-anchor" href="#示例">¶</a></h2><h3 id="使用方法">使用方法<a class="header-anchor" href="#使用方法">¶</a></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Typst Code block tag</span></span><br><span class="line"><span class="comment"> * Syntax:</span></span><br><span class="line"><span class="comment"> * &#123;% typst [options] %&#125;</span></span><br><span class="line"><span class="comment"> * code snippet</span></span><br><span class="line"><span class="comment"> * &#123;% endtypst %&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; title Caption text</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; url Source link</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; link_text Text of the link</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; line_number Show line number, value must be a boolean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; first_line Specify the first line number, value must be a number</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; mark Line highlight specific line(s), each value separated by a comma. Specify number range using a dash</span></span><br><span class="line"><span class="comment"> * Example: `mark:1,4-7,10` will mark line 1, 4 to 7 and 10.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">String</span>&#125; Code snippet with code highlighting</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><h3 id="预览">预览<a class="header-anchor" href="#预览">¶</a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;% typst %&#125;</span><br><span class="line">#import &quot;@preview/tablex:0.0.6&quot;: tablex, rowspanx, colspanx, hlinex, vlinex</span><br><span class="line"></span><br><span class="line">#let three-line-table(columns, headers, contents, caption, lang: &quot;en&quot;,rows: auto) = &#123;figure(</span><br><span class="line">  tablex(</span><br><span class="line">    columns: columns,</span><br><span class="line">    rows: rows,</span><br><span class="line">    align: center + horizon,</span><br><span class="line">    auto-lines: false,</span><br><span class="line">    repeat-header: true,</span><br><span class="line">    hlinex(stroke: 1.5pt),</span><br><span class="line">    ..headers,</span><br><span class="line">    hlinex(stroke: 0.75pt),</span><br><span class="line">    ..contents,</span><br><span class="line">    hlinex(stroke: 1.5pt),</span><br><span class="line">  ),</span><br><span class="line">  kind: table,</span><br><span class="line">  supplement: [#if (lang == &quot;en&quot;) &#123;&quot;Table&quot;&#125; else &#123;&quot;表&quot;&#125;],</span><br><span class="line">  caption: caption,</span><br><span class="line">)&#125;</span><br><span class="line">&#123;% endtypst %&#125;</span><br></pre></td></tr></table></figure><figure class="highlight typst"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="keyword">#</span><span class="keyword">import</span> <span class="string">&quot;@preview/tablex:0.0.6&quot;</span><span class="punctuation">:</span> <span class="variable">tablex</span><span class="punctuation">,</span> <span class="variable">rowspanx</span><span class="punctuation">,</span> <span class="variable">colspanx</span><span class="punctuation">,</span> <span class="variable">hlinex</span><span class="punctuation">,</span> <span class="variable">vlinex</span><span class="keyword">#</span><span class="keyword">let</span> <span class="title function_">three-line-table</span><span class="punctuation">(</span><span class="variable">columns</span><span class="punctuation">,</span> <span class="variable">headers</span><span class="punctuation">,</span> <span class="variable">contents</span><span class="punctuation">,</span> <span class="variable">caption</span><span class="punctuation">,</span> <span class="variable">lang</span><span class="punctuation">:</span> <span class="string">&quot;en&quot;</span><span class="punctuation">,</span><span class="variable">rows</span><span class="punctuation">:</span> <span class="keyword">auto</span><span class="punctuation">)</span> <span class="operator">=</span> <span class="punctuation">{</span><span class="title function_">figure</span><span class="punctuation">(</span>  <span class="title function_">tablex</span><span class="punctuation">(</span>    <span class="variable">columns</span><span class="punctuation">:</span> <span class="variable">columns</span><span class="punctuation">,</span>    <span class="variable">rows</span><span class="punctuation">:</span> <span class="variable">rows</span><span class="punctuation">,</span>    <span class="variable">align</span><span class="punctuation">:</span> <span class="variable">center</span> <span class="operator">+</span> <span class="variable">horizon</span><span class="punctuation">,</span>    <span class="variable">auto-lines</span><span class="punctuation">:</span> <span class="literal">false</span><span class="punctuation">,</span>    <span class="variable">repeat-header</span><span class="punctuation">:</span> <span class="literal">true</span><span class="punctuation">,</span>    <span class="title function_">hlinex</span><span class="punctuation">(</span><span class="variable">stroke</span><span class="punctuation">:</span> <span class="number">1.5pt</span><span class="punctuation">)</span><span class="punctuation">,</span>    <span class="operator">..</span><span class="variable">headers</span><span class="punctuation">,</span>    <span class="title function_">hlinex</span><span class="punctuation">(</span><span class="variable">stroke</span><span class="punctuation">:</span> <span class="number">0.75pt</span><span class="punctuation">)</span><span class="punctuation">,</span>    <span class="operator">..</span><span class="variable">contents</span><span class="punctuation">,</span>    <span class="title function_">hlinex</span><span class="punctuation">(</span><span class="variable">stroke</span><span class="punctuation">:</span> <span class="number">1.5pt</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="punctuation">)</span><span class="punctuation">,</span>  <span class="variable">kind</span><span class="punctuation">:</span> <span class="variable">table</span><span class="punctuation">,</span>  <span class="variable">supplement</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="keyword">#</span><span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">lang</span> <span class="operator">==</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span> <span class="punctuation">{</span><span class="string">&quot;Table&quot;</span><span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span><span class="string">&quot;表&quot;</span><span class="punctuation">}</span><span class="punctuation">]</span><span class="punctuation">,</span>  <span class="variable">caption</span><span class="punctuation">:</span> <span class="variable">caption</span><span class="punctuation">,</span><span class="punctuation">)</span><span class="punctuation">}</span></pre></td></tr></table></figure><h2 id="参考资料">参考资料<a class="header-anchor" href="#参考资料">¶</a></h2><ol><li><span id="refer-1"><a href="https://www.el42.cc/posts/hugo-typst-highlight/">在 Hugo 中为 Typst 配置语法高亮（PaperMod 主题）</a></span></li><li><span id="refer-2"><a href="https://hexo.io/zh-cn/api/tag">标签插件（Tag）</a></span></li><li><span id="refer-3"><a href="https://github.com/Myriad-Dreamin/typst.ts/tree/main/projects/highlighter">highlighter</a></span></li><li><span id="refer-4"><a href="https://hexo.io/zh-cn/docs/syntax-highlight.html">代码高亮</a></span></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;code&gt;Hexo&lt;/code&gt; 处理的代码块会被包裹在 &lt;code&gt;figure table tbody tr &amp;gt; td.code pre&lt;/code&gt; 中，每一行代码又被 &lt;code&gt;span&lt;/code&gt; 包裹，如果需要加入对 &lt;code&gt;Typst&lt;/cod</summary>
      
    
    
    
    <category term="软件/程序" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/"/>
    
    
    <category term="教程" scheme="https://foolishfox.cn/tags/%E6%95%99%E7%A8%8B/"/>
    
    <category term="typst" scheme="https://foolishfox.cn/tags/typst/"/>
    
  </entry>
  
  <entry>
    <title>微信聊天记录分析：去年和你的猪聊了什么？</title>
    <link href="https://foolishfox.cn/posts/202402-WeChatMsgAnalysis.html"/>
    <id>https://foolishfox.cn/posts/202402-WeChatMsgAnalysis.html</id>
    <published>2024-02-01T02:58:56.000Z</published>
    <updated>2024-02-04T03:53:00.000Z</updated>
    
    <content type="html"><![CDATA[<div class="note danger flat"><p><strong>评论不填写邮箱，将收不到回复通知</strong></p></div><div class="note warning flat"><p><strong>多图预警</strong></p></div><div class="note info flat"><p><code>ipynb</code>文件<strong>最好从上往下依次运行，不要回过头来重新搞</strong>，获取方式：</p><ul><li>在 <a href="https://colab.research.google.com/drive/1hbvPPUOnW88CgQtwKNEa1Rzh7s5aOGHv?usp=sharing">Google Colab</a> 使用在线环境运行（推荐）</li><li>下载 <a href="https://gist.github.com/YiHui-Liu/1ed2f9484c5e20587d016e5d7854c273">ipynb文件</a> 直接运行</li><li>下载 <a href="https://api.foolishfox.cn/msg.zip">运行所需文件</a></li></ul></div><h2 id="准备">准备<a class="header-anchor" href="#准备">¶</a></h2><h3 id="导出聊天记录">导出聊天记录<a class="header-anchor" href="#导出聊天记录">¶</a></h3><p>依照 <a href="https://github.com/LC044/WeChatMsg">WeChatMsg</a> 的教程导出 <code>csv</code> 文件，只需要导出文本即可。</p><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb125a50b43.png" alt="图1 导出聊天记录" style="height:200px;"/></div><span class="image-caption">图1 导出聊天记录</span></div><h3 id="安装所需包">安装所需包<a class="header-anchor" href="#安装所需包">¶</a></h3><p>推荐在虚拟环境中安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install numpy seaborn pandas wordcloud tqdm paddlepaddle paddlenlp</span><br></pre></td></tr></table></figure><h3 id="引入包">引入包<a class="header-anchor" href="#引入包">¶</a></h3><ul><li>pandas: 基础数据框架</li><li>matplotlib &amp; seaborn: 绘图</li><li>jieba: 中文分词</li><li>wordcloud: 词云</li><li>paddlenlp: 情感分析</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> jieba.posseg <span class="keyword">as</span> pseg</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">import</span> matplotlib.ticker <span class="keyword">as</span> mticker</span><br><span class="line"><span class="keyword">import</span> matplotlib.transforms <span class="keyword">as</span> mtransforms</span><br><span class="line"><span class="keyword">from</span> matplotlib.colors <span class="keyword">import</span> ListedColormap</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> font_manager <span class="keyword">as</span> fm</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> paddlenlp <span class="keyword">import</span> Taskflow</span><br></pre></td></tr></table></figure><h3 id="绘图设置">绘图设置<a class="header-anchor" href="#绘图设置">¶</a></h3><ul><li><code>font</code>: 字体路径，至少支持中文，最好同时支持中文和emoji</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sns.set_theme(style=<span class="string">&quot;ticks&quot;</span>)</span><br><span class="line">font = <span class="string">&quot;/usr/share/fonts/winfont/simsun.ttc&quot;</span></span><br><span class="line">fp = fm.FontProperties(fname=font)</span><br><span class="line">plt.rcParams[<span class="string">&quot;axes.unicode_minus&quot;</span>] = <span class="literal">False</span></span><br></pre></td></tr></table></figure><h3 id="人名标签">人名标签<a class="header-anchor" href="#人名标签">¶</a></h3><p>在这里修改双方的称呼：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">labels = [<span class="string">&quot;LL&quot;</span>, <span class="string">&quot;FF&quot;</span>]</span><br></pre></td></tr></table></figure><h3 id="数据读取">数据读取<a class="header-anchor" href="#数据读取">¶</a></h3><ul><li><code>filePath</code>: 消息记录文件的路径</li><li><code>dStart</code>: 开始的时间</li><li><code>dEnd</code>: 结束的时间</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">filePath = <span class="string">&quot;msg.csv&quot;</span></span><br><span class="line">dStart = <span class="string">&quot;2023-01-01 00:00:00&quot;</span></span><br><span class="line">dEnd = <span class="string">&quot;2023-12-31 23:59:59&quot;</span></span><br><span class="line"></span><br><span class="line">df = pd.read_csv(filePath, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">df = df.query(</span><br><span class="line">    <span class="string">&quot;CreateTime &gt;= &#123;:d&#125; and CreateTime &lt;= &#123;:d&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        <span class="built_in">int</span>(time.mktime(time.strptime(dStart, <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>))),</span><br><span class="line">        <span class="built_in">int</span>(time.mktime(time.strptime(dEnd, <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>))),</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">df.loc[:, <span class="string">&quot;StrTime&quot;</span>] = pd.to_datetime(df[<span class="string">&quot;StrTime&quot;</span>])</span><br><span class="line">df.loc[:, <span class="string">&quot;day&quot;</span>] = df[<span class="string">&quot;StrTime&quot;</span>].dt.dayofweek</span><br><span class="line">df.loc[:, <span class="string">&quot;hour&quot;</span>] = df[<span class="string">&quot;StrTime&quot;</span>].dt.hour</span><br><span class="line">df.loc[:, <span class="string">&quot;Count&quot;</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果出错就用</span></span><br><span class="line">df[<span class="string">&quot;StrTime&quot;</span>] = pd.to_datetime(df[<span class="string">&quot;StrTime&quot;</span>])</span><br><span class="line">df[<span class="string">&quot;day&quot;</span>] = df[<span class="string">&quot;StrTime&quot;</span>].dt.dayofweek</span><br><span class="line">df[<span class="string">&quot;hour&quot;</span>] = df[<span class="string">&quot;StrTime&quot;</span>].dt.hour</span><br><span class="line">df[<span class="string">&quot;Count&quot;</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">dfs = [df.query(<span class="string">&quot;IsSender == 0&quot;</span>), df.query(<span class="string">&quot;IsSender == 1&quot;</span>)]</span><br></pre></td></tr></table></figure><h3 id="消息过滤">消息过滤<a class="header-anchor" href="#消息过滤">¶</a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">textFilter</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    text = text.lower()</span><br><span class="line">    <span class="comment"># 过滤 emoji</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        co = re.<span class="built_in">compile</span>(<span class="string">&quot;[\U00010000-\U0010ffff]&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> re.error:</span><br><span class="line">        co = re.<span class="built_in">compile</span>(<span class="string">&quot;[\uD800-\uDBFF][\uDC00-\uDFFF]&quot;</span>)</span><br><span class="line">    text = co.sub(<span class="string">&quot; &quot;</span>, text)</span><br><span class="line">    <span class="comment"># 过滤微信表情</span></span><br><span class="line">    co = re.<span class="built_in">compile</span>(<span class="string">&quot;\[[\u4e00-\u9fa5]+\]&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> co.sub(<span class="string">&quot; &quot;</span>, text)</span><br><span class="line"></span><br><span class="line">texts = [</span><br><span class="line">    [textFilter(i) <span class="keyword">for</span> i <span class="keyword">in</span> dfs[<span class="number">0</span>].query(<span class="string">&quot;Type == 1&quot;</span>)[<span class="string">&quot;StrContent&quot;</span>].to_list()],</span><br><span class="line">    [textFilter(i) <span class="keyword">for</span> i <span class="keyword">in</span> dfs[<span class="number">1</span>].query(<span class="string">&quot;Type == 1&quot;</span>)[<span class="string">&quot;StrContent&quot;</span>].to_list()],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="消息频率分析">消息频率分析<a class="header-anchor" href="#消息频率分析">¶</a></h2><h3 id="类型分析">类型分析<a class="header-anchor" href="#类型分析">¶</a></h3><p>根据消息的类型进行分类，可以看出喜欢发送的消息类型，同时也可以看出谁发的多</p><ul><li>1 = Text</li><li>3 = Image</li><li>34 = Voice</li><li>43 = Video</li><li>47 = Sticker</li><li>48 = Location</li><li>10000 = System</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    data[labels[i]] = [</span><br><span class="line">        <span class="built_in">len</span>(dfs[i].query(<span class="string">&quot;Type == 1&quot;</span>)),</span><br><span class="line">        <span class="built_in">len</span>(dfs[i].query(<span class="string">&quot;Type == 3&quot;</span>)),</span><br><span class="line">        <span class="built_in">len</span>(dfs[i].query(<span class="string">&quot;Type == 34&quot;</span>)),</span><br><span class="line">        <span class="built_in">len</span>(dfs[i].query(<span class="string">&quot;Type == 43&quot;</span>)),</span><br><span class="line">        <span class="built_in">len</span>(dfs[i].query(<span class="string">&quot;Type == 47&quot;</span>)),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">data = (</span><br><span class="line">    pd.DataFrame(data, index=[<span class="string">&quot;Text&quot;</span>, <span class="string">&quot;Image&quot;</span>, <span class="string">&quot;Voice&quot;</span>, <span class="string">&quot;Video&quot;</span>, <span class="string">&quot;Sticker&quot;</span>])</span><br><span class="line">    .reset_index()</span><br><span class="line">    .melt(<span class="string">&quot;index&quot;</span>)</span><br><span class="line">    .rename(columns=&#123;<span class="string">&quot;index&quot;</span>: <span class="string">&quot;Type&quot;</span>, <span class="string">&quot;variable&quot;</span>: <span class="string">&quot;Person&quot;</span>, <span class="string">&quot;value&quot;</span>: <span class="string">&quot;Count&quot;</span>&#125;)</span><br><span class="line">)</span><br><span class="line">g = sns.catplot(data, kind=<span class="string">&quot;bar&quot;</span>, x=<span class="string">&quot;Type&quot;</span>, y=<span class="string">&quot;Count&quot;</span>, hue=<span class="string">&quot;Person&quot;</span>, palette=<span class="string">&quot;dark&quot;</span>, alpha=<span class="number">0.6</span>, height=<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ax <span class="keyword">in</span> g.axes.ravel():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        ax.bar_label(ax.containers[i], fontsize=<span class="number">9</span>)</span><br><span class="line">sns.move_legend(g, <span class="string">&quot;upper right&quot;</span>)</span><br><span class="line">plt.yscale(<span class="string">&quot;log&quot;</span>)</span><br><span class="line"></span><br><span class="line">g.figure.set_size_inches(<span class="number">6</span>, <span class="number">5</span>)</span><br><span class="line">g.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb1395f1d68.png" alt="图2 消息类型" style="height:300px;"/></div><span class="image-caption">图2 消息类型</span></div><h3 id="消息长度分析">消息长度分析<a class="header-anchor" href="#消息长度分析">¶</a></h3><ul><li><code>sN</code>: 设置显示范围：</li></ul><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>μ</mi><mo>+</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">N</mi></mrow><mo>∗</mo><mi>σ</mi></mrow><annotation encoding="application/x-tex">\mu + \mathrm{sN} * \sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">μ</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathrm">s</span><span class="mord mathrm">N</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></span></p><ul><li><code>multiple</code>: 直方图堆叠格式</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">sN = <span class="number">3</span></span><br><span class="line">multiple = <span class="string">&quot;dodge&quot;</span></span><br><span class="line"></span><br><span class="line">mu, std = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">data = &#123;<span class="string">&quot;Length&quot;</span>: [], <span class="string">&quot;Person&quot;</span>: []&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    length = [<span class="built_in">len</span>(textFilter(i)) <span class="keyword">for</span> i <span class="keyword">in</span> texts[i]]</span><br><span class="line">    data[<span class="string">&quot;Length&quot;</span>] += length</span><br><span class="line">    data[<span class="string">&quot;Person&quot;</span>] += [labels[i]] * <span class="built_in">len</span>(length)</span><br><span class="line">    <span class="keyword">if</span> np.mean(length) + sN * np.std(length) &gt; mu + std:</span><br><span class="line">        mu, std = np.mean(length), np.std(length)</span><br><span class="line">xlim = <span class="built_in">int</span>(np.ceil(mu + sN * std))</span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(data)</span><br><span class="line">bins = np.linspace(<span class="number">0</span>, xlim, xlim + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ax = sns.histplot(</span><br><span class="line">    data=data,</span><br><span class="line">    x=<span class="string">&quot;Length&quot;</span>,</span><br><span class="line">    hue=<span class="string">&quot;Person&quot;</span>,</span><br><span class="line">    bins=bins,</span><br><span class="line">    multiple=multiple,</span><br><span class="line">    edgecolor=<span class="string">&quot;.3&quot;</span>,</span><br><span class="line">    linewidth=<span class="number">0.5</span>,</span><br><span class="line">    palette=<span class="string">&quot;dark&quot;</span>,</span><br><span class="line">    alpha=<span class="number">0.6</span>,</span><br><span class="line">)</span><br><span class="line">ax.set_xlim(<span class="number">0</span>, xlim)</span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Length of Message&quot;</span>)</span><br><span class="line"></span><br><span class="line">ax.figure.set_size_inches(<span class="number">8</span>, <span class="number">4</span>)</span><br><span class="line">ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb141cd3165.png" alt="图3 消息长度" style="height:300px;"/></div><span class="image-caption">图3 消息长度</span></div><h3 id="每日活跃分析">每日活跃分析<a class="header-anchor" href="#每日活跃分析">¶</a></h3><p>划分每日24小时内每小时发送的消息数，可以得知每天的活跃的时间段</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;<span class="string">&quot;Time&quot;</span>: [], <span class="string">&quot;Person&quot;</span>: []&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    hour = dfs[i][<span class="string">&quot;hour&quot;</span>].to_list()</span><br><span class="line">    data[<span class="string">&quot;Time&quot;</span>] += hour</span><br><span class="line">    data[<span class="string">&quot;Person&quot;</span>] += [labels[i]] * <span class="built_in">len</span>(hour)</span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(data)</span><br><span class="line">bins = np.arange(<span class="number">0</span>, <span class="number">25</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ax = sns.histplot(</span><br><span class="line">    data=data,</span><br><span class="line">    x=<span class="string">&quot;Time&quot;</span>,</span><br><span class="line">    hue=<span class="string">&quot;Person&quot;</span>,</span><br><span class="line">    bins=bins,</span><br><span class="line">    multiple=multiple,</span><br><span class="line">    edgecolor=<span class="string">&quot;.3&quot;</span>,</span><br><span class="line">    linewidth=<span class="number">0.5</span>,</span><br><span class="line">    palette=<span class="string">&quot;dark&quot;</span>,</span><br><span class="line">    alpha=<span class="number">0.6</span>,</span><br><span class="line">)</span><br><span class="line">ax.set_xticks(bins)</span><br><span class="line">ax.set_xticklabels(bins)</span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Hour&quot;</span>)</span><br><span class="line">ax.set_xlim(<span class="number">0</span>, <span class="number">24</span>)</span><br><span class="line">sns.move_legend(ax, loc=<span class="string">&quot;upper center&quot;</span>, bbox_to_anchor=(<span class="number">0.5</span>, <span class="number">1.2</span>), ncol=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">ax.figure.set_size_inches(<span class="number">8</span>, <span class="number">4</span>)</span><br><span class="line">ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb14564b8de.png" alt="图4 每日活跃时间" style="height:300px;"/></div><span class="image-caption">图4 每日活跃时间</span></div><h3 id="每周活跃分析">每周活跃分析<a class="header-anchor" href="#每周活跃分析">¶</a></h3><p>查看一周内从周一到周日每天发送的消息数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">grouper = pd.Grouper(key=<span class="string">&quot;day&quot;</span>)</span><br><span class="line">data = df.groupby(grouper)[<span class="string">&quot;Count&quot;</span>].<span class="built_in">sum</span>()</span><br><span class="line">data = data.sort_index()</span><br><span class="line">data.index = [<span class="string">&quot;Mon&quot;</span>, <span class="string">&quot;Tue&quot;</span>, <span class="string">&quot;Wed&quot;</span>, <span class="string">&quot;Thu&quot;</span>, <span class="string">&quot;Fri&quot;</span>, <span class="string">&quot;Sat&quot;</span>, <span class="string">&quot;Sun&quot;</span>]</span><br><span class="line"></span><br><span class="line">ax = sns.barplot(data=data, errorbar=<span class="literal">None</span>)</span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Weekday&quot;</span>)</span><br><span class="line">ax.bar_label(ax.containers[<span class="number">0</span>], fontsize=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">ax.figure.set_size_inches(<span class="number">5</span>, <span class="number">5</span>)</span><br><span class="line">ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb149541466.png" alt="图5 每周活跃分析" style="height:300px;"/></div><span class="image-caption">图5 每周活跃分析</span></div><h3 id="按周划分年度活跃分析">按周划分年度活跃分析<a class="header-anchor" href="#按周划分年度活跃分析">¶</a></h3><p>划分每7天内发送的消息数，可以得知每周的活跃的时间段</p><ul><li><code>wTicks</code>: 每个刻度相差的数值</li></ul><div class="note warning flat"><p><strong>请注意此处修改：</strong></p><ul><li><code>wStart</code>: <strong>当年</strong>或者<strong>聊天开始日期之后</strong>第一个周一的日期</li><li><code>wEnd</code>: <strong>次年</strong>或者<strong>聊天结束日期之后</strong>第一个周一的日期</li></ul></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">wTicks = <span class="number">500</span></span><br><span class="line">wStart = <span class="string">&quot;2023-01-02&quot;</span></span><br><span class="line">wEnd = <span class="string">&quot;2024-01-01&quot;</span></span><br><span class="line"></span><br><span class="line">grouper = pd.Grouper(key=<span class="string">&quot;StrTime&quot;</span>, freq=<span class="string">&quot;W-MON&quot;</span>)</span><br><span class="line">data = df.groupby(grouper)[<span class="string">&quot;Count&quot;</span>].<span class="built_in">sum</span>().to_frame()</span><br><span class="line">data.index = pd.date_range(start=wStart, end=wEnd, freq=<span class="string">&quot;W-MON&quot;</span>).strftime(<span class="string">&quot;%m-%d&quot;</span>)</span><br><span class="line">data.columns = [<span class="string">&quot;Count&quot;</span>]</span><br><span class="line"></span><br><span class="line">vM = np.ceil(data[<span class="string">&quot;Count&quot;</span>].<span class="built_in">max</span>() / wTicks) * wTicks</span><br><span class="line">norm = plt.Normalize(<span class="number">0</span>, vM)</span><br><span class="line">sm = plt.cm.ScalarMappable(cmap=<span class="string">&quot;Reds&quot;</span>, norm=norm)</span><br><span class="line"></span><br><span class="line">ax = sns.barplot(x=data.index, y=data[<span class="string">&quot;Count&quot;</span>], hue=data[<span class="string">&quot;Count&quot;</span>], hue_norm=norm, palette=<span class="string">&quot;Reds&quot;</span>)</span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Date&quot;</span>)</span><br><span class="line">plt.xticks(rotation=<span class="number">60</span>)</span><br><span class="line"><span class="keyword">for</span> bar <span class="keyword">in</span> ax.containers:</span><br><span class="line">    ax.bar_label(bar, fontsize=<span class="number">10</span>, fmt=<span class="string">&quot;%.0f&quot;</span>)</span><br><span class="line">ax.get_legend().remove()</span><br><span class="line"></span><br><span class="line">axpos = ax.get_position()</span><br><span class="line">caxpos = mtransforms.Bbox.from_extents(axpos.x1 + <span class="number">0.02</span>, axpos.y0, axpos.x1 + <span class="number">0.03</span>, axpos.y1)</span><br><span class="line">cax = ax.figure.add_axes(caxpos)</span><br><span class="line"></span><br><span class="line">locator = mticker.MultipleLocator(wTicks)</span><br><span class="line">formatter = mticker.StrMethodFormatter(<span class="string">&quot;&#123;x:.0f&#125;&quot;</span>)</span><br><span class="line">cax.figure.colorbar(sm, cax=cax, ticks=locator, <span class="built_in">format</span>=formatter)</span><br><span class="line"></span><br><span class="line">ax.figure.set_size_inches(<span class="number">20</span>, <span class="number">8</span>)</span><br><span class="line">ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb14cd53593.png" alt="图5 按周划分年度活跃分析" style="height:300px;"/></div><span class="image-caption">图5 按周划分年度活跃分析</span></div><h3 id="按周划分聊天热情分析">按周划分聊天热情分析<a class="header-anchor" href="#按周划分聊天热情分析">¶</a></h3><p>划分每7天内的聊天热情指数，聊天热情指数为发送的消息数减去收到的消息数与总消息数的比值：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo>=</mo><mfrac><mrow><msub><mi>Q</mi><mi mathvariant="normal">S</mi></msub><mo>−</mo><msub><mi>Q</mi><mi mathvariant="normal">R</mi></msub></mrow><mrow><msub><mi>Q</mi><mi mathvariant="normal">S</mi></msub><mo>+</mo><msub><mi>Q</mi><mi mathvariant="normal">R</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">E = \frac{Q_\mathrm{S} - Q_\mathrm{R}}{Q_\mathrm{S} + Q_\mathrm{R}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.24077em;vertical-align:-0.8804400000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603299999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">R</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">R</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804400000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">grouper = pd.Grouper(key=<span class="string">&quot;StrTime&quot;</span>, freq=<span class="string">&quot;W-MON&quot;</span>)</span><br><span class="line">df_W1 = dfs[<span class="number">0</span>].groupby(grouper)[<span class="string">&quot;Count&quot;</span>].<span class="built_in">sum</span>()</span><br><span class="line">df_W2 = dfs[<span class="number">1</span>].groupby(grouper)[<span class="string">&quot;Count&quot;</span>].<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(&#123;<span class="string">&quot;E&quot;</span>: (df_W1 - df_W2) / (df_W1 + df_W2)&#125;)</span><br><span class="line">data.index = pd.date_range(start=wStart, end=wEnd, freq=<span class="string">&quot;W-MON&quot;</span>).strftime(<span class="string">&quot;%m-%d&quot;</span>)</span><br><span class="line"></span><br><span class="line">vM = data[<span class="string">&quot;E&quot;</span>].<span class="built_in">abs</span>().<span class="built_in">max</span>()</span><br><span class="line">norm = plt.Normalize(-vM, vM)</span><br><span class="line">sm = plt.cm.ScalarMappable(cmap=<span class="string">&quot;coolwarm&quot;</span>, norm=norm)</span><br><span class="line"></span><br><span class="line">ax = sns.barplot(x=data.index, y=data[<span class="string">&quot;E&quot;</span>], hue=data[<span class="string">&quot;E&quot;</span>], hue_norm=norm, palette=<span class="string">&quot;coolwarm&quot;</span>)</span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Date&quot;</span>)</span><br><span class="line">plt.xticks(rotation=<span class="number">60</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&quot;Enthusiasm Index&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> bar <span class="keyword">in</span> ax.containers:</span><br><span class="line">    ax.bar_label(bar, fontsize=<span class="number">10</span>, fmt=<span class="string">&quot;%.2f&quot;</span>)</span><br><span class="line">ax.get_legend().remove()</span><br><span class="line"></span><br><span class="line">axpos = ax.get_position()</span><br><span class="line">caxpos = mtransforms.Bbox.from_extents(axpos.x1 + <span class="number">0.02</span>, axpos.y0, axpos.x1 + <span class="number">0.03</span>, axpos.y1)</span><br><span class="line">cax = ax.figure.add_axes(caxpos)</span><br><span class="line"></span><br><span class="line">locator = mticker.MultipleLocator(<span class="number">0.1</span>)</span><br><span class="line">formatter = mticker.StrMethodFormatter(<span class="string">&quot;&#123;x:.1f&#125;&quot;</span>)</span><br><span class="line">cax.figure.colorbar(sm, cax=cax, ticks=locator, <span class="built_in">format</span>=formatter)</span><br><span class="line"></span><br><span class="line">ax.figure.set_size_inches(<span class="number">20</span>, <span class="number">8</span>)</span><br><span class="line">ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb150cdc34d.png" alt="图6 按周划分聊天热情分析" style="height:300px;"/></div><span class="image-caption">图6 按周划分聊天热情分析</span></div><h3 id="按日划分年度活跃分析">按日划分年度活跃分析<a class="header-anchor" href="#按日划分年度活跃分析">¶</a></h3><p>以热力图的方式展示按日划分的年度活跃情况</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">grouper = pd.Grouper(key=<span class="string">&quot;StrTime&quot;</span>, freq=<span class="string">&quot;D&quot;</span>)</span><br><span class="line">data = df.groupby(grouper)[<span class="string">&quot;Count&quot;</span>].<span class="built_in">sum</span>()</span><br><span class="line">data = data.to_frame()</span><br><span class="line"></span><br><span class="line">data[<span class="string">&quot;date&quot;</span>] = data.index</span><br><span class="line">data[<span class="string">&quot;week&quot;</span>] = data[<span class="string">&quot;date&quot;</span>].dt.isocalendar()[<span class="string">&quot;week&quot;</span>]</span><br><span class="line">data[<span class="string">&quot;day&quot;</span>] = data[<span class="string">&quot;date&quot;</span>].dt.dayofweek</span><br><span class="line">data.index = <span class="built_in">range</span>(<span class="built_in">len</span>(data))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    <span class="keyword">if</span> data.loc[i, <span class="string">&quot;week&quot;</span>] &gt; <span class="number">1</span>:</span><br><span class="line">        data.loc[i, <span class="string">&quot;week&quot;</span>] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">data = data.pivot(index=<span class="string">&quot;day&quot;</span>, columns=<span class="string">&quot;week&quot;</span>, values=<span class="string">&quot;Count&quot;</span>)</span><br><span class="line">data.index = [<span class="string">&quot;Mon&quot;</span>, <span class="string">&quot;Tue&quot;</span>, <span class="string">&quot;Wed&quot;</span>, <span class="string">&quot;Thu&quot;</span>, <span class="string">&quot;Fri&quot;</span>, <span class="string">&quot;Sat&quot;</span>, <span class="string">&quot;Sun&quot;</span>]</span><br><span class="line">data.columns = pd.date_range(start=wStart, end=wEnd, freq=<span class="string">&quot;W-MON&quot;</span>).strftime(<span class="string">&quot;%m-%d&quot;</span>)</span><br><span class="line"></span><br><span class="line">ax = sns.heatmap(</span><br><span class="line">    data,</span><br><span class="line">    annot=<span class="literal">False</span>,</span><br><span class="line">    linewidths=<span class="number">0.5</span>,</span><br><span class="line">    cbar_kws=&#123;<span class="string">&quot;orientation&quot;</span>: <span class="string">&quot;vertical&quot;</span>, <span class="string">&quot;location&quot;</span>: <span class="string">&quot;left&quot;</span>, <span class="string">&quot;pad&quot;</span>: <span class="number">0.03</span>&#125;,</span><br><span class="line">    cmap=<span class="string">&quot;Reds&quot;</span>,</span><br><span class="line">)</span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Week&quot;</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&quot;Weekday&quot;</span>)</span><br><span class="line">ax.figure.set_size_inches(<span class="number">24</span>, <span class="number">4</span>)</span><br><span class="line">ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb155505c24.png" alt="图7 按日划分年度活跃分析" style="height:250px;"/></div><span class="image-caption">图7 按日划分年度活跃分析</span></div><h2 id="词语分析">词语分析<a class="header-anchor" href="#词语分析">¶</a></h2><h3 id="分词词典、停止词与去除词性">分词词典、停止词与去除词性<a class="header-anchor" href="#分词词典、停止词与去除词性">¶</a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jieba.load_userdict(<span class="string">&quot;thuocl.txt&quot;</span>)</span><br><span class="line">jieba.load_userdict(<span class="string">&quot;userdict.txt&quot;</span>)</span><br><span class="line">stopwords = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&quot;stopwords.txt&quot;</span>, <span class="string">&quot;r&quot;</span>).readlines()] + [<span class="string">&quot; &quot;</span>, <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\r\n&quot;</span>]</span><br><span class="line">wordclass = [<span class="string">&quot;v&quot;</span>, <span class="string">&quot;u&quot;</span>, <span class="string">&quot;vd&quot;</span>, <span class="string">&quot;r&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;w&quot;</span>]</span><br></pre></td></tr></table></figure><h3 id="分词函数">分词函数<a class="header-anchor" href="#分词函数">¶</a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">wordSplit</span>(<span class="params">texts, wordclass</span>):</span><br><span class="line">    words = []</span><br><span class="line">    pbar = tqdm(total=<span class="built_in">len</span>(texts))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(texts)):</span><br><span class="line">        res = pseg.lcut(texts[i])</span><br><span class="line">        <span class="keyword">for</span> pair <span class="keyword">in</span> res:</span><br><span class="line">            <span class="keyword">if</span> pair.word <span class="keyword">in</span> stopwords:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> pair.flag <span class="keyword">in</span> wordclass:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            words.append(pair.word)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">1000</span> == <span class="number">0</span>:</span><br><span class="line">            pbar.update(<span class="number">1000</span>)</span><br><span class="line">    pbar.close()</span><br><span class="line">    <span class="keyword">return</span> words</span><br><span class="line"></span><br><span class="line">words = [wordSplit(texts[i], wordclass) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)]</span><br></pre></td></tr></table></figure><h3 id="词云绘制">词云绘制<a class="header-anchor" href="#词云绘制">¶</a></h3><ul><li><code>mask</code>: 词云的蒙版，影响词云的形状</li><li><code>cmap</code>: 色阶</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">mask = np.array(Image.<span class="built_in">open</span>(<span class="string">&quot;mask.png&quot;</span>))</span><br><span class="line">masks = [np.array(Image.<span class="built_in">open</span>(<span class="string">&quot;mask_L.jpg&quot;</span>)), np.array(Image.<span class="built_in">open</span>(<span class="string">&quot;mask_F.jpg&quot;</span>))]</span><br><span class="line">cmap = ListedColormap(</span><br><span class="line">    [</span><br><span class="line">        <span class="string">&quot;#fac1cf&quot;</span>,</span><br><span class="line">        <span class="string">&quot;#a9d7ba&quot;</span>,</span><br><span class="line">        <span class="string">&quot;#58b1db&quot;</span>,</span><br><span class="line">        <span class="string">&quot;#f296ab&quot;</span>,</span><br><span class="line">        <span class="string">&quot;#5dab81&quot;</span>,</span><br><span class="line">        <span class="string">&quot;#3d9ec4&quot;</span>,</span><br><span class="line">        <span class="string">&quot;#e16a8d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;#237b50&quot;</span>,</span><br><span class="line">        <span class="string">&quot;#1e8299&quot;</span>,</span><br><span class="line">        <span class="string">&quot;#8d3549&quot;</span>,</span><br><span class="line">        <span class="string">&quot;#35563b&quot;</span>,</span><br><span class="line">        <span class="string">&quot;#2d5d73&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wordCloud</span>(<span class="params">text, font, mask, cmap</span>):</span><br><span class="line">    wc = WordCloud(</span><br><span class="line">        background_color=<span class="string">&quot;white&quot;</span>,</span><br><span class="line">        scale=<span class="number">5</span>,</span><br><span class="line">        font_path=font,</span><br><span class="line">        mask=mask,</span><br><span class="line">        colormap=cmap,</span><br><span class="line">        collocations=<span class="literal">False</span>,</span><br><span class="line">    ).generate(text)</span><br><span class="line">    plt.imshow(wc)</span><br><span class="line">    plt.axis(<span class="string">&quot;off&quot;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">wordCloud(<span class="string">&quot; &quot;</span>.join(words[<span class="number">0</span>] + words[<span class="number">1</span>]), font, mask, cmap)</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb17047a719.png" alt="图8 词云图" style="height:300px;"/></div><span class="image-caption">图8 词云图</span></div><h3 id="高频词排行">高频词排行<a class="header-anchor" href="#高频词排行">¶</a></h3><p>列出常用的 N 个词，并且展示双方的贡献</p><ul><li><code>wN</code>: 词的数目，默认为50</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">wN = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;words&quot;</span>: words[<span class="number">0</span>] + words[<span class="number">1</span>],</span><br><span class="line">        <span class="string">&quot;L&quot;</span>: [<span class="number">1</span>] * <span class="built_in">len</span>(words[<span class="number">0</span>]) + [<span class="number">0</span>] * <span class="built_in">len</span>(words[<span class="number">1</span>]),</span><br><span class="line">        <span class="string">&quot;F&quot;</span>: [<span class="number">0</span>] * <span class="built_in">len</span>(words[<span class="number">0</span>]) + [<span class="number">1</span>] * <span class="built_in">len</span>(words[<span class="number">1</span>]),</span><br><span class="line">        <span class="string">&quot;S&quot;</span>: [<span class="number">1</span>] * <span class="built_in">len</span>(words[<span class="number">0</span>]) + [<span class="number">1</span>] * <span class="built_in">len</span>(words[<span class="number">1</span>]),</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">grouper = pd.Grouper(key=<span class="string">&quot;words&quot;</span>)</span><br><span class="line">data = data.groupby(grouper).<span class="built_in">sum</span>()</span><br><span class="line">data = data.sort_values(by=<span class="string">&quot;S&quot;</span>, ascending=<span class="literal">False</span>)</span><br><span class="line">data = data.iloc[:wN]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将部分无法识别的 emoji 转化为文字</span></span><br><span class="line">tmp = data.index.to_list()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(wN):</span><br><span class="line">    <span class="keyword">if</span> tmp[i] == <span class="string">&quot;😘&quot;</span>:</span><br><span class="line">        tmp[i] = <span class="string">&quot;[亲亲]&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> tmp[i] == <span class="string">&quot;😂&quot;</span>:</span><br><span class="line">        tmp[i] = <span class="string">&quot;[笑哭]&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> tmp[i] == <span class="string">&quot;🤦&quot;</span>:</span><br><span class="line">        tmp[i] = <span class="string">&quot;[捂脸]&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> tmp[i] == <span class="string">&quot;😁&quot;</span>:</span><br><span class="line">        tmp[i] = <span class="string">&quot;[呲牙]&quot;</span></span><br><span class="line">data.index = tmp</span><br><span class="line"></span><br><span class="line">ratio = data[<span class="string">&quot;L&quot;</span>] / data[<span class="string">&quot;S&quot;</span>]</span><br><span class="line">norm = plt.Normalize(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">sm = plt.cm.ScalarMappable(cmap=<span class="string">&quot;coolwarm&quot;</span>, norm=norm)</span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize=(<span class="number">10</span>, <span class="number">10</span>), dpi=<span class="number">300</span>)</span><br><span class="line">grid = plt.GridSpec(<span class="number">1</span>, <span class="number">4</span>, wspace=<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">ax0 = fig.add_subplot(grid[<span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">sns.barplot(x=-data[<span class="string">&quot;L&quot;</span>], y=data.index, ax=ax0, hue=ratio, hue_norm=norm, palette=<span class="string">&quot;coolwarm&quot;</span>)</span><br><span class="line">ax1 = fig.add_subplot(grid[<span class="number">0</span>, <span class="number">1</span>:])</span><br><span class="line">sns.barplot(x=data[<span class="string">&quot;F&quot;</span>], y=data.index, ax=ax1, hue=(<span class="number">1</span> - ratio), hue_norm=norm, palette=<span class="string">&quot;coolwarm&quot;</span>)</span><br><span class="line"></span><br><span class="line">ax0.set_xlabel(<span class="string">&quot;词频&quot;</span>)</span><br><span class="line">ax0.set_ylabel(<span class="string">&quot;&quot;</span>)</span><br><span class="line">ax0.set_xticks(<span class="built_in">range</span>(-<span class="number">400</span>, <span class="number">1</span>, <span class="number">200</span>))</span><br><span class="line">ax0.set_xticklabels([<span class="number">400</span>, <span class="number">200</span>, <span class="number">0</span>])</span><br><span class="line">ax0.set_xlim(-<span class="number">400</span>, <span class="number">0</span>)</span><br><span class="line">ax0.set_yticks([])</span><br><span class="line">ax0.spines[<span class="string">&quot;left&quot;</span>].set_visible(<span class="literal">False</span>)</span><br><span class="line">ax0.spines[<span class="string">&quot;top&quot;</span>].set_visible(<span class="literal">False</span>)</span><br><span class="line">ax0.spines[<span class="string">&quot;right&quot;</span>].set_visible(<span class="literal">False</span>)</span><br><span class="line">ax0.set_title(<span class="string">&quot;LL&quot;</span>)</span><br><span class="line">ax0.get_legend().remove()</span><br><span class="line"></span><br><span class="line">ax1.set_xlabel(<span class="string">&quot;词频&quot;</span>)</span><br><span class="line">ax1.set_ylabel(<span class="string">&quot;&quot;</span>)</span><br><span class="line">ax1.set_xticks(<span class="built_in">range</span>(<span class="number">0</span>, <span class="number">1201</span>, <span class="number">200</span>))</span><br><span class="line">ax1.set_xticklabels([<span class="number">0</span>, <span class="number">200</span>, <span class="number">400</span>, <span class="number">600</span>, <span class="number">800</span>, <span class="number">1000</span>, <span class="number">1200</span>])</span><br><span class="line">ax1.set_xlim(<span class="number">0</span>, <span class="number">1200</span>)</span><br><span class="line">ax1.set_yticks([])</span><br><span class="line">ax1.spines[<span class="string">&quot;left&quot;</span>].set_visible(<span class="literal">False</span>)</span><br><span class="line">ax1.spines[<span class="string">&quot;top&quot;</span>].set_visible(<span class="literal">False</span>)</span><br><span class="line">ax1.spines[<span class="string">&quot;right&quot;</span>].set_visible(<span class="literal">False</span>)</span><br><span class="line">ax1.set_title(<span class="string">&quot;FF&quot;</span>)</span><br><span class="line">ax1.get_legend().remove()</span><br><span class="line"></span><br><span class="line">axpos = ax1.get_position()</span><br><span class="line">caxpos = mtransforms.Bbox.from_extents(axpos.x0 + <span class="number">0.06</span>, axpos.y0 + <span class="number">0.03</span>, axpos.x1, axpos.y0 + <span class="number">0.04</span>)</span><br><span class="line">cax = ax1.figure.add_axes(caxpos)</span><br><span class="line"></span><br><span class="line">locator = mticker.MultipleLocator(<span class="number">0.1</span>)</span><br><span class="line">formatter = mticker.StrMethodFormatter(<span class="string">&quot;&#123;x:.1f&#125;&quot;</span>)</span><br><span class="line">cax.figure.colorbar(sm, cax=cax, orientation=<span class="string">&quot;horizontal&quot;</span>, ticks=locator, <span class="built_in">format</span>=formatter)</span><br><span class="line">cax.set_title(<span class="string">&quot;ratio&quot;</span>)</span><br><span class="line"></span><br><span class="line">x0 = ax0.get_position().x1</span><br><span class="line">x1 = ax1.get_position().x0</span><br><span class="line">xm = (x0 + x1) / <span class="number">2</span></span><br><span class="line">y0 = ax0.get_position().y0</span><br><span class="line">y1 = ax0.get_position().y1</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(wN):</span><br><span class="line">    fig.text(</span><br><span class="line">        xm, y0 + (y1 - y0) * (wN - i - <span class="number">0.5</span>) / wN, data.index[i],</span><br><span class="line">        color=<span class="string">&quot;black&quot;</span>, ha=<span class="string">&quot;center&quot;</span>, va=<span class="string">&quot;center&quot;</span>, fontproperties=fp</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">fig.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb17553fc6f.png" alt="图9 高频词排行"/></div><span class="image-caption">图9 高频词排行</span></div><h2 id="情感分析">情感分析<a class="header-anchor" href="#情感分析">¶</a></h2><p>使用 <code>paddlenlp</code> 进行情感分析，得到的分数在 [-1, 1] 之间，越小越消极，越大越积极</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dfE = df.query(<span class="string">&quot;Type == 1&quot;</span>)[[<span class="string">&quot;IsSender&quot;</span>, <span class="string">&quot;StrContent&quot;</span>, <span class="string">&quot;StrTime&quot;</span>, <span class="string">&quot;hour&quot;</span>]]</span><br><span class="line">dfE.index = <span class="built_in">range</span>(<span class="built_in">len</span>(dfE))</span><br><span class="line"></span><br><span class="line">senta = Taskflow(<span class="string">&quot;sentiment_analysis&quot;</span>)</span><br><span class="line">scores = pd.DataFrame(senta([textFilter(i) <span class="keyword">for</span> i <span class="keyword">in</span> dfE[<span class="string">&quot;StrContent&quot;</span>].to_list()]))</span><br><span class="line">scores.loc[scores[<span class="string">&quot;label&quot;</span>] == <span class="string">&quot;negative&quot;</span>, <span class="string">&quot;score&quot;</span>] = <span class="number">1</span> - scores.loc[scores[<span class="string">&quot;label&quot;</span>] == <span class="string">&quot;negative&quot;</span>, <span class="string">&quot;score&quot;</span>]</span><br><span class="line"></span><br><span class="line">dfE[<span class="string">&quot;score&quot;</span>] = scores[<span class="string">&quot;score&quot;</span>]</span><br><span class="line">dfE[<span class="string">&quot;score&quot;</span>] = <span class="number">2</span> * dfE[<span class="string">&quot;score&quot;</span>] - <span class="number">1</span></span><br><span class="line">dfE[<span class="string">&quot;Person&quot;</span>] = dfE.apply(<span class="keyword">lambda</span> x: labels[x[<span class="string">&quot;IsSender&quot;</span>]], axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">dfEs = [dfE.query(<span class="string">&quot;IsSender == 0&quot;</span>), dfE.query(<span class="string">&quot;IsSender == 1&quot;</span>)]</span><br></pre></td></tr></table></figure><h3 id="年度总体情感分布">年度总体情感分布<a class="header-anchor" href="#年度总体情感分布">¶</a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ax = sns.histplot(data=dfE, x=<span class="string">&quot;score&quot;</span>, hue=<span class="string">&quot;Person&quot;</span>, palette=<span class="string">&quot;dark&quot;</span>, alpha=<span class="number">0.6</span>, bins=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Sentiment Score&quot;</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&quot;Count&quot;</span>)</span><br><span class="line">ax.set_title(<span class="string">&quot;Sentiment Distribution&quot;</span>)</span><br><span class="line">ax.set_xlim(-<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ax.figure.set_size_inches(<span class="number">8</span>, <span class="number">3</span>)</span><br><span class="line">ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb17b7df694.png" alt="图10 年度总体情感分布" style="height:300px;"/></div><span class="image-caption">图10 年度总体情感分布</span></div><h3 id="按周统计平均情感指数">按周统计平均情感指数<a class="header-anchor" href="#按周统计平均情感指数">¶</a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">weekAvgSenScore</span>(<span class="params">df</span>):</span><br><span class="line">    grouper = pd.Grouper(key=<span class="string">&quot;StrTime&quot;</span>, freq=<span class="string">&quot;W-MON&quot;</span>)</span><br><span class="line">    data = df.groupby(grouper)[<span class="string">&quot;score&quot;</span>].mean().to_frame()</span><br><span class="line">    data.index = pd.date_range(start=wStart, end=wEnd, freq=<span class="string">&quot;W-MON&quot;</span>).strftime(<span class="string">&quot;%m-%d&quot;</span>)</span><br><span class="line">    data.columns = [<span class="string">&quot;score&quot;</span>]</span><br><span class="line"></span><br><span class="line">    vM = data[<span class="string">&quot;score&quot;</span>].<span class="built_in">abs</span>().<span class="built_in">max</span>()</span><br><span class="line">    norm = plt.Normalize(-vM, vM)</span><br><span class="line">    sm = plt.cm.ScalarMappable(cmap=<span class="string">&quot;coolwarm&quot;</span>, norm=norm)</span><br><span class="line"></span><br><span class="line">    ax = sns.barplot(x=data.index, y=data[<span class="string">&quot;score&quot;</span>], hue=data[<span class="string">&quot;score&quot;</span>], hue_norm=norm, palette=<span class="string">&quot;coolwarm&quot;</span>)</span><br><span class="line">    ax.set_xlabel(<span class="string">&quot;Date&quot;</span>)</span><br><span class="line">    plt.xticks(rotation=<span class="number">60</span>)</span><br><span class="line">    <span class="keyword">for</span> bar <span class="keyword">in</span> ax.containers:</span><br><span class="line">        ax.bar_label(bar, fontsize=<span class="number">10</span>, fmt=<span class="string">&quot;%.2f&quot;</span>)</span><br><span class="line">    ax.get_legend().remove()</span><br><span class="line"></span><br><span class="line">    axpos = ax.get_position()</span><br><span class="line">    caxpos = mtransforms.Bbox.from_extents(axpos.x1 + <span class="number">0.02</span>, axpos.y0, axpos.x1 + <span class="number">0.03</span>, axpos.y1)</span><br><span class="line">    cax = ax.figure.add_axes(caxpos)</span><br><span class="line"></span><br><span class="line">    locator = mticker.MultipleLocator(<span class="number">0.05</span>)</span><br><span class="line">    formatter = mticker.StrMethodFormatter(<span class="string">&quot;&#123;x:.2f&#125;&quot;</span>)</span><br><span class="line">    cax.figure.colorbar(sm, cax=cax, ticks=locator, <span class="built_in">format</span>=formatter)</span><br><span class="line"></span><br><span class="line">    ax.figure.set_size_inches(<span class="number">20</span>, <span class="number">8</span>)</span><br><span class="line">    ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">    plt.show()</span><br><span class="line">    plt.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data[<span class="string">&quot;score&quot;</span>]</span><br><span class="line"></span><br><span class="line">avgSenScore0 = weekAvgSenScore(dfEs[<span class="number">0</span>])</span><br><span class="line">avgSenScore1 = weekAvgSenScore(dfEs[<span class="number">1</span>])</span><br><span class="line">_ = weekAvgSenScore(dfE)</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb180c8a248.png" alt="图11 按周统计平均情感指数" style="height:300px;"/></div><span class="image-caption">图11 按周统计平均情感指数</span></div><h3 id="平均情感指数变化折线图">平均情感指数变化折线图<a class="header-anchor" href="#平均情感指数变化折线图">¶</a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ax = sns.lineplot(data=avgSenScore0, linewidth=<span class="number">3</span>, marker=<span class="string">&quot;s&quot;</span>, markersize=<span class="number">15</span>, label=labels[<span class="number">0</span>])</span><br><span class="line">ax = sns.lineplot(data=avgSenScore1, linewidth=<span class="number">3</span>, marker=<span class="string">&quot;^&quot;</span>, markersize=<span class="number">15</span>, ax=ax, label=labels[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Date&quot;</span>)</span><br><span class="line">plt.xticks(rotation=<span class="number">60</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&quot;Average Sentiment Score&quot;</span>)</span><br><span class="line">ax.set_xlim(<span class="number">0</span>, <span class="number">52</span>)</span><br><span class="line">ax.legend(prop=&#123;<span class="string">&quot;size&quot;</span>: <span class="number">24</span>&#125;)</span><br><span class="line"></span><br><span class="line">ax.figure.set_size_inches(<span class="number">20</span>, <span class="number">8</span>)</span><br><span class="line">ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb185144ea8.png" alt="图12 平均变化折线图" style="height:300px;"/></div><span class="image-caption">图12 平均变化折线图</span></div><h3 id="按周统计累计情感指数">按周统计累计情感指数<a class="header-anchor" href="#按周统计累计情感指数">¶</a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">weekTotSenScore</span>(<span class="params">df</span>):</span><br><span class="line">    grouper = pd.Grouper(key=<span class="string">&quot;StrTime&quot;</span>, freq=<span class="string">&quot;W-MON&quot;</span>)</span><br><span class="line">    data = df.groupby(grouper)[<span class="string">&quot;score&quot;</span>].<span class="built_in">sum</span>().to_frame()</span><br><span class="line">    data.index = pd.date_range(start=wStart, end=wEnd, freq=<span class="string">&quot;W-MON&quot;</span>).strftime(<span class="string">&quot;%m-%d&quot;</span>)</span><br><span class="line">    data.columns = [<span class="string">&quot;score&quot;</span>]</span><br><span class="line"></span><br><span class="line">    vM = data[<span class="string">&quot;score&quot;</span>].<span class="built_in">abs</span>().<span class="built_in">max</span>()</span><br><span class="line">    norm = plt.Normalize(-vM, vM)</span><br><span class="line">    sm = plt.cm.ScalarMappable(cmap=<span class="string">&quot;coolwarm&quot;</span>, norm=norm)</span><br><span class="line"></span><br><span class="line">    ax = sns.barplot(x=data.index, y=data[<span class="string">&quot;score&quot;</span>], hue=data[<span class="string">&quot;score&quot;</span>], hue_norm=norm, palette=<span class="string">&quot;coolwarm&quot;</span>)</span><br><span class="line">    ax.set_xlabel(<span class="string">&quot;Date&quot;</span>)</span><br><span class="line">    plt.xticks(rotation=<span class="number">60</span>)</span><br><span class="line">    <span class="keyword">for</span> bar <span class="keyword">in</span> ax.containers:</span><br><span class="line">        ax.bar_label(bar, fontsize=<span class="number">10</span>, fmt=<span class="string">&quot;%.2f&quot;</span>)</span><br><span class="line">    ax.get_legend().remove()</span><br><span class="line"></span><br><span class="line">    axpos = ax.get_position()</span><br><span class="line">    caxpos = mtransforms.Bbox.from_extents(axpos.x1 + <span class="number">0.02</span>, axpos.y0, axpos.x1 + <span class="number">0.03</span>, axpos.y1)</span><br><span class="line">    cax = ax.figure.add_axes(caxpos)</span><br><span class="line"></span><br><span class="line">    locator = mticker.MultipleLocator(<span class="number">20</span>)</span><br><span class="line">    formatter = mticker.StrMethodFormatter(<span class="string">&quot;&#123;x:.2f&#125;&quot;</span>)</span><br><span class="line">    cax.figure.colorbar(sm, cax=cax, ticks=locator, <span class="built_in">format</span>=formatter)</span><br><span class="line"></span><br><span class="line">    ax.figure.set_size_inches(<span class="number">20</span>, <span class="number">8</span>)</span><br><span class="line">    ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">    plt.show()</span><br><span class="line">    plt.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data[<span class="string">&quot;score&quot;</span>]</span><br><span class="line"></span><br><span class="line">totSenScore0 = weekTotSenScore(dfEs[<span class="number">0</span>])</span><br><span class="line">totSenScore1 = weekTotSenScore(dfEs[<span class="number">1</span>])</span><br><span class="line">_ = weekTotSenScore(dfE)</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb188b7e6c1.png" alt="图13 按周统计累计情感指数" style="height:300px;"/></div><span class="image-caption">图13 按周统计累计情感指数</span></div><h3 id="累计情感指数变化折线图">累计情感指数变化折线图<a class="header-anchor" href="#累计情感指数变化折线图">¶</a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ax = sns.lineplot(data=totSenScore0, linewidth=<span class="number">3</span>, marker=<span class="string">&quot;s&quot;</span>, markersize=<span class="number">15</span>, label=labels[<span class="number">0</span>])</span><br><span class="line">ax = sns.lineplot(data=totSenScore1, linewidth=<span class="number">3</span>, marker=<span class="string">&quot;^&quot;</span>, markersize=<span class="number">15</span>, ax=ax, label=labels[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Date&quot;</span>)</span><br><span class="line">plt.xticks(rotation=<span class="number">60</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&quot;Total Sentiment Score&quot;</span>)</span><br><span class="line">ax.set_xlim(<span class="number">0</span>, <span class="number">52</span>)</span><br><span class="line">ax.legend(prop=&#123;<span class="string">&quot;size&quot;</span>: <span class="number">24</span>&#125;)</span><br><span class="line"></span><br><span class="line">ax.figure.set_size_inches(<span class="number">20</span>, <span class="number">8</span>)</span><br><span class="line">ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb18bf41a2b.png" alt="图14 累计变化折线图" style="height:300px;"/></div><span class="image-caption">图14 累计变化折线图</span></div><h3 id="每日平均情感分析">每日平均情感分析<a class="header-anchor" href="#每日平均情感分析">¶</a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">grouper = pd.Grouper(key=<span class="string">&quot;hour&quot;</span>)</span><br><span class="line"></span><br><span class="line">data = []</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    tmp = dfEs[k].groupby(grouper)[<span class="string">&quot;score&quot;</span>].mean().sort_index()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> tmp.index:</span><br><span class="line">            data.append(tmp[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data.append(<span class="number">0</span>)</span><br><span class="line">    data.append(<span class="number">0</span>)</span><br><span class="line">data = pd.DataFrame(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Score&quot;</span>: data,</span><br><span class="line">        <span class="string">&quot;Person&quot;</span>: [labels[<span class="number">0</span>]] * <span class="number">25</span> + [labels[<span class="number">1</span>]] * <span class="number">25</span>,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">xBins = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>)]</span><br><span class="line">ax = sns.histplot(</span><br><span class="line">    data=data,</span><br><span class="line">    x=xBins * <span class="number">2</span>,</span><br><span class="line">    bins=xBins,</span><br><span class="line">    weights=<span class="string">&quot;Score&quot;</span>,</span><br><span class="line">    hue=<span class="string">&quot;Person&quot;</span>,</span><br><span class="line">    multiple=multiple,</span><br><span class="line">    edgecolor=<span class="string">&quot;.3&quot;</span>,</span><br><span class="line">    linewidth=<span class="number">0.5</span>,</span><br><span class="line">    palette=<span class="string">&quot;dark&quot;</span>,</span><br><span class="line">    alpha=<span class="number">0.6</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">ax.set_xticks(<span class="built_in">range</span>(<span class="number">25</span>))</span><br><span class="line">ax.set_xticklabels(<span class="built_in">range</span>(<span class="number">25</span>))</span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Hour&quot;</span>)</span><br><span class="line">ax.set_xlim(<span class="number">0</span>, <span class="number">24</span>)</span><br><span class="line">ax.set_ylim(np.<span class="built_in">min</span>([<span class="number">0</span>, np.floor(data[<span class="string">&quot;Score&quot;</span>].<span class="built_in">min</span>() / <span class="number">0.05</span>) * <span class="number">0.05</span>]), np.ceil(data[<span class="string">&quot;Score&quot;</span>].<span class="built_in">max</span>() / <span class="number">0.05</span>) * <span class="number">0.05</span>)</span><br><span class="line">sns.move_legend(ax, loc=<span class="string">&quot;upper center&quot;</span>, bbox_to_anchor=(<span class="number">0.5</span>, <span class="number">1.2</span>), ncol=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">ax.figure.set_size_inches(<span class="number">8</span>, <span class="number">4</span>)</span><br><span class="line">ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb190954b05.png" alt="图15 每日平均情感分析" style="height:300px;"/></div><span class="image-caption">图15 每日平均情感分析</span></div><h3 id="每日累计情感分析">每日累计情感分析<a class="header-anchor" href="#每日累计情感分析">¶</a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">grouper = pd.Grouper(key=<span class="string">&quot;hour&quot;</span>)</span><br><span class="line"></span><br><span class="line">data = []</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    tmp = dfEs[k].groupby(grouper)[<span class="string">&quot;score&quot;</span>].<span class="built_in">sum</span>().sort_index()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> tmp.index:</span><br><span class="line">            data.append(tmp[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data.append(<span class="number">0</span>)</span><br><span class="line">    data.append(<span class="number">0</span>)</span><br><span class="line">data = pd.DataFrame(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Score&quot;</span>: data,</span><br><span class="line">        <span class="string">&quot;Person&quot;</span>: [labels[<span class="number">0</span>]] * <span class="number">25</span> + [labels[<span class="number">1</span>]] * <span class="number">25</span>,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">xBins = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>)]</span><br><span class="line">ax = sns.histplot(</span><br><span class="line">    data=data,</span><br><span class="line">    x=xBins * <span class="number">2</span>,</span><br><span class="line">    bins=xBins,</span><br><span class="line">    weights=<span class="string">&quot;Score&quot;</span>,</span><br><span class="line">    hue=<span class="string">&quot;Person&quot;</span>,</span><br><span class="line">    multiple=multiple,</span><br><span class="line">    edgecolor=<span class="string">&quot;.3&quot;</span>,</span><br><span class="line">    linewidth=<span class="number">0.5</span>,</span><br><span class="line">    palette=<span class="string">&quot;dark&quot;</span>,</span><br><span class="line">    alpha=<span class="number">0.6</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">ax.set_xticks(<span class="built_in">range</span>(<span class="number">25</span>))</span><br><span class="line">ax.set_xticklabels(<span class="built_in">range</span>(<span class="number">25</span>))</span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Hour&quot;</span>)</span><br><span class="line">ax.set_xlim(<span class="number">0</span>, <span class="number">24</span>)</span><br><span class="line">ax.set_ylim(np.<span class="built_in">min</span>([<span class="number">0</span>, np.floor(data[<span class="string">&quot;Score&quot;</span>].<span class="built_in">min</span>() / <span class="number">0.05</span>) * <span class="number">0.05</span>]), np.ceil(data[<span class="string">&quot;Score&quot;</span>].<span class="built_in">max</span>() / <span class="number">0.05</span>) * <span class="number">0.05</span>)</span><br><span class="line">sns.move_legend(ax, loc=<span class="string">&quot;upper center&quot;</span>, bbox_to_anchor=(<span class="number">0.5</span>, <span class="number">1.2</span>), ncol=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">ax.figure.set_size_inches(<span class="number">8</span>, <span class="number">4</span>)</span><br><span class="line">ax.figure.set_dpi(<span class="number">150</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/02/01/65bb1931b4174.png" alt="图16 每日累计情感分析" style="height:300px;"/></div><span class="image-caption">图16 每日累计情感分析</span></div><h2 id="工具">工具<a class="header-anchor" href="#工具">¶</a></h2><ol><li><a href="https://github.com/LC044/WeChatMsg">WeChatMsg</a></li><li><a href="https://github.com/PaddlePaddle/PaddleNLP">PaddleNLP</a></li><li><a href="http://thuocl.thunlp.org/">THUOCL：清华大学开放中文词库</a></li><li><a href="https://github.com/goto456/stopwords">中文常用停用词表</a></li><li><a href="https://github.com/fxsjy/jieba">jieba中文分词</a></li></ol><h2 id="参考资料">参考资料<a class="header-anchor" href="#参考资料">¶</a></h2><ol><li><a href="https://github.com/saturn-opposition/wechat_analysis">wechat_analysis</a></li><li><a href="http://xhslink.com/oC4OHA">Python制作日历图｜可视化聊天记录</a></li><li><a href="http://xhslink.com/ZNdPHA">1 年的聊天记录写成论文作为老婆生日礼物</a></li><li><a href="http://xhslink.com/KqhPHA">当我把和男朋友两年半的聊天记录可视化</a></li><li><a href="http://xhslink.com/IOkPHA">90万人看过的聊天记录可视化第二弹来啦</a></li><li><a href="https://stackoverflow.com/questions/49761221/make-seaborn-show-a-colorbar-instead-of-a-legend-when-using-hue-in-a-bar-plot">Make seaborn show a colorbar instead of a legend when using hue in a bar plot?</a></li><li><a href="https://zhajiman.github.io/post/matplotlib_colorbar/">Matplotlib 系列：colorbar 的设置</a></li><li><a href="https://blog.csdn.net/sinat_32570141/article/details/113048947">matplotlib 绘图之坐标变换</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;note danger flat&quot;&gt;&lt;p&gt;&lt;strong&gt;评论不填写邮箱，将收不到回复通知&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;note warning flat&quot;&gt;&lt;p&gt;&lt;strong&gt;多图预警&lt;/strong&gt;&lt;/p&gt;
&lt;/</summary>
      
    
    
    
    <category term="软件/程序" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/"/>
    
    
    <category term="教程" scheme="https://foolishfox.cn/tags/%E6%95%99%E7%A8%8B/"/>
    
    <category term="Python" scheme="https://foolishfox.cn/tags/Python/"/>
    
    <category term="Jupyter" scheme="https://foolishfox.cn/tags/Jupyter/"/>
    
    <category term="微信" scheme="https://foolishfox.cn/tags/%E5%BE%AE%E4%BF%A1/"/>
    
    <category term="聊天记录" scheme="https://foolishfox.cn/tags/%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>排版工具 Typst 教程与 Snippets</title>
    <link href="https://foolishfox.cn/posts/202401-typst.html"/>
    <id>https://foolishfox.cn/posts/202401-typst.html</id>
    <published>2024-01-04T04:36:34.000Z</published>
    <updated>2024-01-04T04:36:34.000Z</updated>
    
    <content type="html"><![CDATA[<div class="note info flat"><p>个人的自用模板代码可以查看 <a href="https://git.foolishfox.cn/fox/Typst-Snippets">Typst-Snippets</a></p></div><p>Typst 是 2019 年才出现的使用 Rust 编写的基于标记的排版语言，定位在 Markdown、Word 等初级工具和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding="application/x-tex">\LaTeX</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.89883em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">L</span><span class="mspace" style="margin-right:-0.36em;"></span><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.68333em;"><span style="top:-2.904999em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord"><span class="mord textrm mtight sizing reset-size6 size3">A</span></span></span></span></span></span><span class="mspace" style="margin-right:-0.15em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.46782999999999997em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span></span> 一类的高级工具之间，官方宣称其功能可以和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding="application/x-tex">\LaTeX</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.89883em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">L</span><span class="mspace" style="margin-right:-0.36em;"></span><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.68333em;"><span style="top:-2.904999em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord"><span class="mord textrm mtight sizing reset-size6 size3">A</span></span></span></span></span></span><span class="mspace" style="margin-right:-0.15em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.46782999999999997em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span></span> 一样强大，但是和 Markdown 一样简单、易用，主要应用于数学、物理和工程方面（特别是包含大量公式、图表）的论文、文章、作业、书籍和报告的编写。</p><h2 id="基础教程">基础教程<a class="header-anchor" href="#基础教程">¶</a></h2><p>MacOS 和 Arch Linux 用户可以使用包管理器进行安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># macOS or Linux using Homebrew</span></span><br><span class="line">brew install typst</span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch Linux</span></span><br><span class="line">pacman -S typst</span><br></pre></td></tr></table></figure><p>具体支持的发行版本可以查看 <a href="#refer-5">参考资料 (5)</a>。Ubuntu 目前还只能下载编译好的二进制文件，或者安装 Rust 后从源码编译进行安装。除此之外，还需要安装编辑器的插件实现代码提示、预览等功能，VS Code 上的主要插件有：</p><ul><li><a href="https://marketplace.visualstudio.com/items?itemName=nvarner.typst-lsp">Typst LSP</a></li><li><a href="https://marketplace.visualstudio.com/items?itemName=mgt19937.typst-preview">Typst Preview</a></li></ul><p>除此之外，还有 <a href="https://marketplace.visualstudio.com/items?itemName=OrangeX4.vscode-typst-sympy-calculator">Typst Sympy Calculator</a> 插件实现了和 Python 的 SymPy 库的联动，可以进行公式的转化和计算。</p><p>对于从 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding="application/x-tex">\LaTeX</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.89883em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">L</span><span class="mspace" style="margin-right:-0.36em;"></span><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.68333em;"><span style="top:-2.904999em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord"><span class="mord textrm mtight sizing reset-size6 size3">A</span></span></span></span></span></span><span class="mspace" style="margin-right:-0.15em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.46782999999999997em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span></span> 和 Markdown 迁移过来的用户，绝大部分语法内容都可以新学习，比较重要的区别有：</p><ol><li>公式中命令不需要 <code>\</code> 开头，直接使用即可，例如使用 <code>$e^(pi eta)$</code> 显示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mi>π</mi><mi>η</mi></mrow></msup></mrow><annotation encoding="application/x-tex">e^{\pi\eta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.664392em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">η</span></span></span></span></span></span></span></span></span></span></span></span>，要在公式中显示成段的，不是命令的字符，可以使用 <code>&quot;</code> 包裹起来。更具体而言，Typst 区分两种模式：「标记模式」和「代码模式」，前者是正常的文本模式，类似于 Markdown 的编写逻辑，后者以 <code>#</code> 开头，在该模式内的命令省略 <code>#</code>（个人认为，公式是一种特殊的代码模式，命令在公式中也可以省略 <code>#</code>）</li><li>函数定义要求函数名 + 括号，参数可以是位置参数或者命名参数，格式为 <code>myfunc(keya: valuea, keyb: valueb)</code></li><li>Typst 的代码模式十分强大，通过 <code>#if</code> 条件判断和 <code>#for</code> 循环语句，可以实现 <a href="#refer-7">参考资料 (7)</a> 中的效果：</li></ol><!-- autoplay="autoplay" loop="loop"  --><p><video src="https://asset.foolishfox.cn/2024/01/04/typst.mp4" controls="controls" style="max-width: 100%;display: block;margin: auto;max-height: 400px;">your browser does not support the video tag</video></p><p>具体的内容可以查看 <a href="#refer-3">参考资料 (3)</a>，入门的教程可以查看 <a href="#refer-2">参考资料 (2)</a>，一些 Typst、Markdown 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding="application/x-tex">\LaTeX</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.89883em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">L</span><span class="mspace" style="margin-right:-0.36em;"></span><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.68333em;"><span style="top:-2.904999em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord"><span class="mord textrm mtight sizing reset-size6 size3">A</span></span></span></span></span></span><span class="mspace" style="margin-right:-0.15em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.46782999999999997em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span></span> 之间的对比可以查看 <a href="#refer-7">参考资料 (7)</a></p><h2 id="常用代码">常用代码<a class="header-anchor" href="#常用代码">¶</a></h2><h3 id="官方模组">官方模组<a class="header-anchor" href="#官方模组">¶</a></h3><p>目前官方收录的模组可以在 <a href="https://typst.app/docs/packages/">Typst Packages</a> 进行查询，此外还有 <a href="https://github.com/qjcg/awesome-typst">Awesome Typst</a> 项目收录了很多实用了模组，下面列举了部分常用的模组，一些我进行了自定义的模组将会在 (<a href='#自定义模板'>下一小节</a>) 进行介绍。</p><ol><li><a href="https://github.com/OrangeX4/typst-pinit">Pinit</a> 包用于创建批注，在制作 slides 的时候特别有用，效果如下：</li></ol><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/04/65966b17c1a87.png" alt="Pinit" style="height:300px;"/></div><span class="image-caption">Pinit</span></div><ol start="2"><li><a href="https://github.com/Leedehai/typst-physics">Physics</a> 实现了向量、场、微分、导数、狄拉克符号等物理中常用符合的定义：</li></ol><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/04/65966bb4944a9.png" alt="Physics" style="height:300px;"/></div><span class="image-caption">Physics</span></div><ol start="3"><li><a href="https://github.com/Pablo-Gonzalez-Calderon/showybox-package">Showybox</a> 可以创建自定义的彩色盒，可以用于定义、定理等场景：</li></ol><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/04/65966cd4b1d0f.png" alt="Showybox" style="height:200px;"/></div><span class="image-caption">Showybox</span></div><ol start="4"><li><a href="https://github.com/PgBiel/typst-tablex">Tablex</a> 实现了高级的表格：</li></ol><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/04/65966d37a9441.png" alt="Tablex" style="height:300px;"/></div><span class="image-caption">Tablex</span></div><ol start="5"><li><a href="https://github.com/flavio20002/typst-orange-template">Typst orange template</a> 使用 Typst 实现了 <a href="https://www.latextemplates.com/template/legrand-orange-book">Legrand Orange Book</a>：</li></ol><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/05/6596e1628f3d8.png" alt="Typst orange template" style="height:300px;"/></div><span class="image-caption">Typst orange template</span></div><ol start="6"><li><a href="https://github.com/RubixDev/typst-i-figured">i-figured</a> 实现了图表、公式的按章节编号，参见 (<a href='#论文'>论文</a>)</li></ol><h3 id="自定义模板">自定义模板<a class="header-anchor" href="#自定义模板">¶</a></h3><h4 id="幻灯片">幻灯片<a class="header-anchor" href="#幻灯片">¶</a></h4><p><a href="https://github.com/qjcg/awesome-typst">Awesome Typst</a> 中推荐的幻灯片模板中，个人推荐使用 <a href="https://github.com/andreasKroepelin/polylux">Polylux</a> 模板，提供了多种主题，目前我常用的是 [University] 主题，并进行了一定的修改。</p><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/04/65966f57d4f07.png" alt="封面" style="height:300px;"/></div><span class="image-caption">封面</span></div><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/04/65966f5838ad1.png" alt="目录" style="height:300px;"/></div><span class="image-caption">目录</span></div><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/04/65966f589ecad.png" alt="分栏" style="height:300px;"/></div><span class="image-caption">分栏</span></div><ul><li>给分栏页加入页眉和页脚</li></ul><figure class="highlight typst"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="keyword">#</span><span class="keyword">let</span> <span class="title function_">matrix-slide</span><span class="punctuation">(</span>  <span class="variable">title</span><span class="punctuation">:</span> <span class="keyword">none</span><span class="punctuation">,</span>  <span class="variable">new-section</span><span class="punctuation">:</span> <span class="keyword">none</span><span class="punctuation">,</span>  <span class="variable">columns</span><span class="punctuation">:</span> <span class="keyword">none</span><span class="punctuation">,</span>  <span class="variable">rows</span><span class="punctuation">:</span> <span class="keyword">none</span><span class="punctuation">,</span>  <span class="operator">..</span><span class="variable">bodies</span><span class="punctuation">)</span> <span class="operator">=</span> <span class="punctuation">{</span>  <span class="keyword">let</span> <span class="variable">header</span> <span class="operator">=</span> <span class="punctuation">{</span>    <span class="keyword">set</span> <span class="title function_">align</span><span class="punctuation">(</span><span class="variable">top</span><span class="punctuation">)</span>    <span class="title function_">grid</span><span class="punctuation">(</span><span class="variable">rows</span><span class="punctuation">:</span> <span class="punctuation">(</span><span class="keyword">auto</span><span class="punctuation">,</span> <span class="keyword">auto</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="variable">row-gutter</span><span class="punctuation">:</span> <span class="number">3mm</span><span class="punctuation">,</span> <span class="variable">progress-barline</span><span class="punctuation">,</span> <span class="title function_">header-text</span><span class="punctuation">(</span><span class="variable">title</span><span class="punctuation">:</span> <span class="variable">title</span><span class="punctuation">,</span> <span class="variable">new-section</span><span class="punctuation">:</span> <span class="variable">new-section</span><span class="punctuation">)</span><span class="punctuation">)</span>  <span class="punctuation">}</span>  <span class="keyword">let</span> <span class="variable">footer</span> <span class="operator">=</span> <span class="punctuation">{</span>    <span class="keyword">set</span> <span class="title function_">text</span><span class="punctuation">(</span><span class="variable">size</span><span class="punctuation">:</span> <span class="number">10pt</span><span class="punctuation">)</span>    <span class="keyword">set</span> <span class="title function_">align</span><span class="punctuation">(</span><span class="variable">center</span> <span class="operator">+</span> <span class="variable">bottom</span><span class="punctuation">)</span>    <span class="keyword">let</span> <span class="title function_">cell</span><span class="punctuation">(</span><span class="variable">fill</span><span class="punctuation">:</span> <span class="keyword">none</span><span class="punctuation">,</span> <span class="variable">it</span><span class="punctuation">)</span> <span class="operator">=</span> <span class="title function_">rect</span><span class="punctuation">(</span>      <span class="variable">width</span><span class="punctuation">:</span> <span class="number">100%</span><span class="punctuation">,</span> <span class="variable">height</span><span class="punctuation">:</span> <span class="number">100%</span><span class="punctuation">,</span> <span class="variable">inset</span><span class="punctuation">:</span> <span class="number">1mm</span><span class="punctuation">,</span> <span class="variable">outset</span><span class="punctuation">:</span> <span class="number">0mm</span><span class="punctuation">,</span> <span class="variable">fill</span><span class="punctuation">:</span> <span class="variable">fill</span><span class="punctuation">,</span> <span class="variable">stroke</span><span class="punctuation">:</span> <span class="keyword">none</span><span class="punctuation">,</span>      <span class="title function_">align</span><span class="punctuation">(</span><span class="variable">horizon</span><span class="punctuation">,</span> <span class="title function_">text</span><span class="punctuation">(</span><span class="variable">fill</span><span class="punctuation">:</span> <span class="variable">white</span><span class="punctuation">,</span> <span class="variable">it</span><span class="punctuation">)</span><span class="punctuation">)</span>    <span class="punctuation">)</span>    <span class="title function_">locate</span><span class="punctuation">(</span> <span class="variable">loc</span> <span class="operator">=&gt;</span> <span class="punctuation">{</span>      <span class="keyword">let</span> <span class="variable">colors</span> <span class="operator">=</span> <span class="variable">uni</span><span class="operator">.</span><span class="variable">uni-colors</span><span class="operator">.</span><span class="title function_">at</span><span class="punctuation">(</span><span class="variable">loc</span><span class="punctuation">)</span>      <span class="keyword">show</span><span class="punctuation">:</span> <span class="variable">block</span><span class="operator">.</span><span class="title function_">with</span><span class="punctuation">(</span><span class="variable">width</span><span class="punctuation">:</span> <span class="number">100%</span><span class="punctuation">,</span> <span class="variable">height</span><span class="punctuation">:</span> <span class="keyword">auto</span><span class="punctuation">,</span> <span class="variable">fill</span><span class="punctuation">:</span> <span class="variable">colors</span><span class="operator">.</span><span class="variable">b</span><span class="punctuation">)</span>      <span class="title function_">grid</span><span class="punctuation">(</span>        <span class="variable">columns</span><span class="punctuation">:</span> <span class="punctuation">(</span><span class="number">25%</span><span class="punctuation">,</span> <span class="number">1fr</span><span class="punctuation">,</span> <span class="number">15%</span><span class="punctuation">,</span> <span class="number">10%</span><span class="punctuation">)</span><span class="punctuation">,</span>        <span class="variable">rows</span><span class="punctuation">:</span> <span class="punctuation">(</span><span class="number">1.5em</span><span class="punctuation">,</span> <span class="keyword">auto</span><span class="punctuation">)</span><span class="punctuation">,</span>        <span class="title function_">cell</span><span class="punctuation">(</span><span class="variable">fill</span><span class="punctuation">:</span> <span class="variable">colors</span><span class="operator">.</span><span class="variable">a</span><span class="punctuation">,</span> <span class="variable">uni</span><span class="operator">.</span><span class="variable">uni-short-author</span><span class="operator">.</span><span class="title function_">display</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span>        <span class="title function_">cell</span><span class="punctuation">(</span><span class="variable">uni</span><span class="operator">.</span><span class="variable">uni-short-title</span><span class="operator">.</span><span class="title function_">display</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span>        <span class="title function_">cell</span><span class="punctuation">(</span><span class="variable">uni</span><span class="operator">.</span><span class="variable">uni-short-date</span><span class="operator">.</span><span class="title function_">display</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span>        <span class="title function_">cell</span><span class="punctuation">(</span><span class="variable">logic</span><span class="operator">.</span><span class="variable">logical-slide</span><span class="operator">.</span><span class="title function_">display</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="punctuation">[</span><span class="char escape_">~</span>/<span class="char escape_">~</span><span class="punctuation">]</span> <span class="operator">+</span> <span class="variable">utils</span><span class="operator">.</span><span class="variable">last-slide-number</span><span class="punctuation">)</span>      <span class="punctuation">)</span>    <span class="punctuation">}</span><span class="punctuation">)</span>  <span class="punctuation">}</span>  <span class="keyword">set</span> <span class="title function_">page</span><span class="punctuation">(</span>    <span class="variable">margin</span><span class="punctuation">:</span> <span class="punctuation">(</span> <span class="variable">top</span><span class="punctuation">:</span> <span class="number">2em</span><span class="punctuation">,</span> <span class="variable">bottom</span><span class="punctuation">:</span> <span class="number">1em</span><span class="punctuation">,</span> <span class="variable">x</span><span class="punctuation">:</span> <span class="number">0em</span> <span class="punctuation">)</span><span class="punctuation">,</span>    <span class="variable">header</span><span class="punctuation">:</span> <span class="variable">header</span><span class="punctuation">,</span>    <span class="variable">footer</span><span class="punctuation">:</span> <span class="variable">footer</span><span class="punctuation">,</span><span class="keyword"></span>    <span class="variable">footer-descent</span><span class="punctuation">:</span> <span class="number">0em</span><span class="punctuation">,</span>    <span class="variable">header-ascent</span><span class="punctuation">:</span> <span class="number">.6em</span><span class="punctuation">,</span>  <span class="punctuation">)</span>  <span class="variable">uni</span><span class="operator">.</span><span class="title function_">matrix-slide</span><span class="punctuation">(</span><span class="operator">..</span><span class="variable">bodies</span><span class="punctuation">)</span><span class="punctuation">}</span></pre></td></tr></table></figure><ul><li>添加目录页</li></ul><figure class="highlight typst"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="keyword">#</span><span class="keyword">let</span> <span class="title function_">slide-outline-length</span><span class="punctuation">(</span><span class="variable">loc</span><span class="punctuation">)</span> <span class="operator">=</span> <span class="punctuation">{</span>  <span class="keyword">let</span> <span class="variable">section-state</span> <span class="operator">=</span> <span class="title function_">state</span><span class="punctuation">(</span><span class="string">&quot;polylux-sections&quot;</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span>  <span class="keyword">let</span> <span class="variable">sections</span> <span class="operator">=</span> <span class="variable">section-state</span><span class="operator">.</span><span class="title function_">final</span><span class="punctuation">(</span><span class="variable">loc</span><span class="punctuation">)</span>  <span class="variable">sections</span><span class="operator">.</span><span class="title function_">len</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">}</span><span class="keyword">#</span><span class="keyword">let</span> <span class="title function_">slide-outline</span><span class="punctuation">(</span><span class="variable">num</span><span class="punctuation">)</span> <span class="operator">=</span> <span class="punctuation">{</span>  <span class="keyword">set</span> <span class="title function_">text</span><span class="punctuation">(</span><span class="variable">font</span><span class="punctuation">:</span> <span class="string">&quot;Cascadia Mono&quot;</span><span class="punctuation">)</span>  <span class="title function_">locate</span><span class="punctuation">(</span><span class="variable">loc</span> <span class="operator">=&gt;</span> <span class="punctuation">{</span>    <span class="keyword">let</span> <span class="variable">section-state</span> <span class="operator">=</span> <span class="title function_">state</span><span class="punctuation">(</span><span class="string">&quot;polylux-sections&quot;</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span>    <span class="keyword">let</span> <span class="variable">sections</span> <span class="operator">=</span> <span class="variable">section-state</span><span class="operator">.</span><span class="title function_">final</span><span class="punctuation">(</span><span class="variable">loc</span><span class="punctuation">)</span>    <span class="keyword">for</span> <span class="variable">p</span> <span class="keyword">in</span> <span class="title function_">range</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="variable">num</span><span class="punctuation">)</span> <span class="punctuation">{</span>      <span class="keyword">let</span> <span class="variable">section</span> <span class="operator">=</span> <span class="variable">sections</span><span class="operator">.</span><span class="title function_">at</span><span class="punctuation">(</span><span class="variable">p</span><span class="punctuation">)</span>      <span class="keyword">let</span> <span class="variable">content</span> <span class="operator">=</span> <span class="punctuation">{</span>        <span class="keyword">let</span> <span class="variable">url</span> <span class="operator">=</span> <span class="title function_">link</span><span class="punctuation">(</span><span class="variable">section</span><span class="operator">.</span><span class="variable">loc</span><span class="punctuation">,</span> <span class="variable">section</span><span class="operator">.</span><span class="variable">body</span><span class="punctuation">)</span>        <span class="keyword">let</span> <span class="variable">page</span> <span class="operator">=</span> <span class="variable">logic</span><span class="operator">.</span><span class="variable">logical-slide</span><span class="operator">.</span><span class="title function_">at</span><span class="punctuation">(</span><span class="variable">section</span><span class="operator">.</span><span class="variable">loc</span><span class="punctuation">)</span><span class="operator">.</span><span class="title function_">at</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">)</span>        <span class="keyword">let</span> <span class="variable">length</span> <span class="operator">=</span> <span class="number">46</span> <span class="operator">-</span> <span class="title function_">str</span><span class="punctuation">(</span><span class="variable">page</span><span class="punctuation">)</span><span class="operator">.</span><span class="title function_">len</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="title function_">count-length</span><span class="punctuation">(</span><span class="variable">section</span><span class="operator">.</span><span class="variable">body</span><span class="punctuation">)</span>        <span class="keyword">let</span> <span class="variable">dots</span> <span class="operator">=</span> <span class="string">&quot; &quot;</span> <span class="operator">+</span> <span class="string">&quot;.&quot;</span> * <span class="title function_">length</span>        <span class="punctuation">[</span><span class="title function_">#</span><span class="title function_">grid</span><span class="punctuation">(</span>          <span class="variable">columns</span><span class="punctuation">:</span> <span class="punctuation">(</span><span class="keyword">auto</span><span class="punctuation">,</span> <span class="number">1fr</span><span class="punctuation">,</span> <span class="number">1fr</span><span class="punctuation">)</span><span class="punctuation">,</span>          <span class="variable">url</span><span class="punctuation">,</span> <span class="title function_">align</span><span class="punctuation">[</span><span class="variable">#</span><span class="variable">dots</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="title function_">align</span><span class="punctuation">(</span><span class="variable">right</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="variable">#</span><span class="variable">page</span><span class="punctuation">]</span>        <span class="punctuation">)</span><span class="punctuation">]</span>      <span class="punctuation">}</span>      <span class="punctuation">[</span><span class="bullet">+</span> <span class="variable">#</span><span class="variable">content</span> <span class="punctuation">]</span>    <span class="punctuation">}</span>  <span class="punctuation">}</span><span class="punctuation">)</span><span class="punctuation">}</span></pre></td></tr></table></figure><h4 id="论文">论文<a class="header-anchor" href="#论文">¶</a></h4><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/05/6596e1cb96028.png" alt="LaPreprint" style="height:400px;"/></div><span class="image-caption">LaPreprint</span></div><p><a href="https://github.com/LaPreprint/typst">LaPreprint</a> 是一个很美观的预印本模板，主要适用于英文，为了适应一些中文的需求，个人做出了一些修改：</p><ul><li>增加目录与语言选项</li></ul><figure class="highlight typst"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="keyword">#</span><span class="keyword">let</span> <span class="title function_">lapreprint</span><span class="punctuation">(</span>  <span class="comment">// ......</span>  <span class="comment">// The outline</span>  <span class="variable">outline-show</span><span class="punctuation">:</span> <span class="literal">true</span><span class="punctuation">,</span>  <span class="variable">outline-depth</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span>  <span class="comment">// Language of the document</span>  <span class="variable">lang</span><span class="punctuation">:</span> <span class="string">&quot;en&quot;</span><span class="punctuation">,</span>  <span class="comment">// The paper&#x27;s content.</span>  <span class="variable">body</span><span class="punctuation">)</span> <span class="operator">=</span> <span class="punctuation">{</span>  <span class="comment">// ......</span>  <span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">outline-show</span><span class="punctuation">)</span> <span class="punctuation">{</span><span class="title function_">outline</span><span class="punctuation">(</span>    <span class="variable">title</span><span class="punctuation">:</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">lang</span> <span class="operator">==</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span> <span class="punctuation">{</span><span class="string">&quot;Content&quot;</span><span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span><span class="string">&quot;目录&quot;</span><span class="punctuation">}</span><span class="punctuation">,</span>    <span class="variable">indent</span><span class="punctuation">:</span> <span class="number">2em</span><span class="punctuation">,</span>    <span class="variable">depth</span><span class="punctuation">:</span> <span class="variable">outline-depth</span><span class="punctuation">,</span>  <span class="punctuation">)</span><span class="punctuation">}</span>  <span class="comment">// ......</span><span class="punctuation">}</span></pre></td></tr></table></figure><ul><li>修改页边距</li></ul><figure class="highlight typst"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="comment">// 首页 &amp; 目录页</span><span class="title function_">#</span><span class="title function_">lapreprint</span><span class="punctuation">(</span>  <span class="keyword">set</span> <span class="title function_">page</span><span class="punctuation">(</span>    <span class="variable">paper-size</span><span class="punctuation">,</span>    <span class="variable">margin</span><span class="punctuation">:</span> <span class="punctuation">(</span><span class="variable">left</span><span class="punctuation">:</span> <span class="number">20%</span><span class="punctuation">,</span> <span class="variable">bottom</span><span class="punctuation">:</span> <span class="number">1.5cm</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="punctuation">)</span><span class="punctuation">)</span><span class="comment">// 后续页</span><span class="title function_">#</span><span class="title function_">lapreprint</span><span class="punctuation">(</span>  <span class="keyword">set</span> <span class="title function_">page</span><span class="punctuation">(</span>    <span class="variable">paper-size</span><span class="punctuation">,</span>    <span class="variable">margin</span><span class="punctuation">:</span> <span class="punctuation">(</span><span class="variable">left</span><span class="punctuation">:</span> <span class="keyword">auto</span><span class="punctuation">,</span> <span class="variable">bottom</span><span class="punctuation">:</span> <span class="number">1.5cm</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="punctuation">)</span><span class="punctuation">)</span></pre></td></tr></table></figure><ul><li>中文显示</li></ul><figure class="highlight typst"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="title function_">#</span><span class="title function_">lapreprint</span><span class="punctuation">(</span>  <span class="keyword">set</span> <span class="title function_">page</span><span class="punctuation">(</span>    <span class="comment">// ......</span>    <span class="variable">footer</span><span class="punctuation">:</span> <span class="title function_">block</span><span class="punctuation">(</span>      <span class="comment">// ......</span>                <span class="keyword">if</span><span class="punctuation">(</span><span class="variable">date</span> <span class="operator">!=</span> <span class="keyword">none</span><span class="punctuation">)</span> <span class="punctuation">{</span>                  <span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">lang</span> <span class="operator">==</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span> <span class="punctuation">{</span>                    <span class="variable">date</span><span class="operator">.</span><span class="title function_">display</span><span class="punctuation">(</span><span class="string">&quot;[month repr:short] [day], [year]&quot;</span><span class="punctuation">)</span>                  <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>                    <span class="punctuation">[</span><span class="variable">#</span><span class="variable">date</span><span class="operator">.</span><span class="title function_">year</span><span class="punctuation">(</span><span class="punctuation">)</span> 年 <span class="variable">#</span><span class="variable">date</span><span class="operator">.</span><span class="title function_">month</span><span class="punctuation">(</span><span class="punctuation">)</span> 月 <span class="variable">#</span><span class="variable">date</span><span class="operator">.</span><span class="title function_">day</span><span class="punctuation">(</span><span class="punctuation">)</span> 日<span class="punctuation">]</span>                  <span class="punctuation">}</span>                <span class="punctuation">}</span>      <span class="comment">// ......</span>    <span class="punctuation">)</span>  <span class="punctuation">)</span>  <span class="comment">// ......</span>  <span class="title function_">place</span><span class="punctuation">(</span>    <span class="comment">// ......</span>              <span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">lang</span> <span class="operator">==</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span> <span class="punctuation">{</span>                <span class="title function_">text</span><span class="punctuation">(</span><span class="variable">size</span><span class="punctuation">:</span> <span class="number">7pt</span><span class="punctuation">,</span> <span class="variable">d</span><span class="operator">.</span><span class="variable">date</span><span class="operator">.</span><span class="title function_">display</span><span class="punctuation">(</span><span class="string">&quot;[month repr:short] [day], [year]&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span>              <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span><span class="punctuation">[</span>                <span class="keyword">#</span><span class="keyword">set</span> <span class="title function_">text</span><span class="punctuation">(</span><span class="number">7pt</span><span class="punctuation">)</span>                <span class="variable">#</span><span class="variable">d</span><span class="operator">.</span><span class="variable">date</span><span class="operator">.</span><span class="title function_">year</span><span class="punctuation">(</span><span class="punctuation">)</span>-<span class="variable">#</span><span class="variable">d</span><span class="operator">.</span><span class="variable">date</span><span class="operator">.</span><span class="title function_">month</span><span class="punctuation">(</span><span class="punctuation">)</span>-<span class="variable">#</span><span class="variable">d</span><span class="operator">.</span><span class="variable">date</span><span class="operator">.</span><span class="title function_">day</span><span class="punctuation">(</span><span class="punctuation">)</span>              <span class="punctuation">]</span><span class="punctuation">}</span>    <span class="comment">// ......</span>  <span class="punctuation">)</span>  <span class="comment">// ......</span>  <span class="keyword">if</span> <span class="variable">abstracts</span> <span class="operator">!=</span> <span class="keyword">none</span> <span class="punctuation">{</span>    <span class="comment">// ......</span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">lang</span> <span class="operator">==</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span> <span class="punctuation">{</span>          <span class="title function_">text</span><span class="punctuation">(</span><span class="variable">fill</span><span class="punctuation">:</span> <span class="variable">theme</span><span class="punctuation">,</span> <span class="variable">weight</span><span class="punctuation">:</span> <span class="string">&quot;semibold&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Keywords&quot;</span><span class="punctuation">)</span>        <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>          <span class="title function_">text</span><span class="punctuation">(</span><span class="variable">fill</span><span class="punctuation">:</span> <span class="variable">theme</span><span class="punctuation">,</span> <span class="variable">weight</span><span class="punctuation">:</span> <span class="string">&quot;semibold&quot;</span><span class="punctuation">,</span> <span class="string">&quot;关键词&quot;</span><span class="punctuation">)</span>        <span class="punctuation">}</span>    <span class="comment">// ......</span>  <span class="punctuation">}</span><span class="punctuation">)</span></pre></td></tr></table></figure><ul><li>图表、公式编号，按章节区分</li></ul><figure class="highlight typst"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="title function_">#</span><span class="title function_">lapreprint</span><span class="punctuation">(</span>  <span class="comment">// Configure i-figured</span>  <span class="keyword">show</span> <span class="variable">figure</span><span class="punctuation">:</span> <span class="variable">i-figured</span><span class="operator">.</span><span class="variable">show-figure</span>  <span class="keyword">show</span> <span class="variable">figure</span><span class="operator">.</span><span class="title function_">where</span><span class="punctuation">(</span>    <span class="variable">kind</span><span class="punctuation">:</span> <span class="variable">table</span>  <span class="punctuation">)</span><span class="punctuation">:</span> <span class="keyword">set</span> <span class="variable">figure</span><span class="operator">.</span><span class="title function_">caption</span><span class="punctuation">(</span><span class="variable">position</span><span class="punctuation">:</span> <span class="variable">top</span><span class="punctuation">)</span>  <span class="keyword">show</span> <span class="variable">math</span><span class="operator">.</span><span class="variable">equation</span><span class="punctuation">:</span> <span class="variable">i-figured</span><span class="operator">.</span><span class="variable">show-equation</span><span class="punctuation">)</span></pre></td></tr></table></figure><ul><li>交叉引用</li></ul><figure class="highlight typst"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="title function_">#</span><span class="title function_">lapreprint</span><span class="punctuation">(</span>  <span class="comment">// Configure Reference Link</span>  <span class="keyword">show</span> <span class="variable">link</span><span class="punctuation">:</span> <span class="variable">it</span> <span class="operator">=&gt;</span> <span class="punctuation">[</span><span class="title function_">#</span><span class="title function_">text</span><span class="punctuation">(</span><span class="variable">fill</span><span class="punctuation">:</span> <span class="variable">theme</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="variable">#</span><span class="variable">it</span><span class="punctuation">]</span><span class="punctuation">]</span>  <span class="keyword">show</span> <span class="variable">ref</span><span class="punctuation">:</span> <span class="variable">it</span> <span class="operator">=&gt;</span> <span class="punctuation">[</span><span class="title function_">#</span><span class="title function_">text</span><span class="punctuation">(</span><span class="variable">fill</span><span class="punctuation">:</span> <span class="variable">theme</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="variable">#</span><span class="variable">it</span><span class="punctuation">]</span><span class="punctuation">]</span>  <span class="keyword">show</span> <span class="variable">ref</span><span class="punctuation">:</span> <span class="variable">it</span> <span class="operator">=&gt;</span> <span class="punctuation">{</span>    <span class="keyword">let</span> <span class="variable">el</span> <span class="operator">=</span> <span class="variable">it</span><span class="operator">.</span><span class="variable">element</span>    <span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">el</span> <span class="operator">!=</span> <span class="keyword">none</span><span class="punctuation">)</span> <span class="punctuation">{</span>      <span class="keyword">let</span> <span class="variable">fn</span> <span class="operator">=</span> <span class="title function_">repr</span><span class="punctuation">(</span><span class="variable">el</span><span class="operator">.</span><span class="title function_">func</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span>      <span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">fn</span> <span class="operator">==</span> <span class="string">&quot;equation&quot;</span><span class="punctuation">)</span> <span class="punctuation">{</span><span class="title function_">link</span><span class="punctuation">(</span>        <span class="variable">it</span><span class="operator">.</span><span class="variable">target</span><span class="punctuation">,</span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">lang</span> <span class="operator">==</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span> <span class="punctuation">{</span><span class="string">&quot;Eq.&quot;</span><span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span><span class="string">&quot;式 &quot;</span><span class="punctuation">}</span> <span class="operator">+</span>         <span class="title function_">numbering</span><span class="punctuation">(</span>          <span class="variable">el</span><span class="operator">.</span><span class="variable">numbering</span><span class="punctuation">,</span>          <span class="operator">..</span><span class="title function_">counter</span><span class="punctuation">(</span><span class="variable">math</span><span class="operator">.</span><span class="variable">equation</span><span class="punctuation">)</span><span class="operator">.</span><span class="title function_">at</span><span class="punctuation">(</span><span class="variable">el</span><span class="operator">.</span><span class="title function_">location</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span>        <span class="punctuation">)</span>      <span class="punctuation">)</span><span class="punctuation">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">fn</span> <span class="operator">==</span> <span class="string">&quot;heading&quot;</span><span class="punctuation">)</span> <span class="punctuation">{</span><span class="title function_">link</span><span class="punctuation">(</span>        <span class="variable">it</span><span class="operator">.</span><span class="variable">target</span><span class="punctuation">,</span>        <span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">lang</span> <span class="operator">==</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span> <span class="punctuation">{</span><span class="string">&quot;Section &quot;</span><span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span><span class="string">&quot;第 &quot;</span><span class="punctuation">}</span> <span class="operator">+</span>         <span class="title function_">numbering</span><span class="punctuation">(</span>          <span class="variable">el</span><span class="operator">.</span><span class="variable">numbering</span><span class="punctuation">,</span>          <span class="operator">..</span><span class="title function_">counter</span><span class="punctuation">(</span><span class="variable">heading</span><span class="punctuation">)</span><span class="operator">.</span><span class="title function_">at</span><span class="punctuation">(</span><span class="variable">el</span><span class="operator">.</span><span class="title function_">location</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span>        <span class="punctuation">)</span> <span class="operator">+</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">lang</span> <span class="operator">==</span> <span class="string">&quot;zh&quot;</span><span class="punctuation">)</span> <span class="punctuation">{</span><span class="string">&quot; 节&quot;</span><span class="punctuation">}</span>      <span class="punctuation">)</span><span class="punctuation">}</span>      <span class="keyword">else</span> <span class="punctuation">{</span> <span class="variable">it</span> <span class="punctuation">}</span>    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span><span class="variable">it</span><span class="punctuation">}</span>  <span class="punctuation">}</span><span class="punctuation">)</span></pre></td></tr></table></figure><h4 id="其他">其他<a class="header-anchor" href="#其他">¶</a></h4><ol><li>借助 <a href="https://github.com/PgBiel/typst-tablex">Tablex</a> 可以实现三线表的样式：</li></ol><figure class="highlight typst"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="comment">// 定义</span><span class="keyword">#</span><span class="keyword">import</span> <span class="string">&quot;@preview/tablex:0.0.6&quot;</span><span class="punctuation">:</span> <span class="variable">tablex</span><span class="punctuation">,</span> <span class="variable">rowspanx</span><span class="punctuation">,</span> <span class="variable">colspanx</span><span class="punctuation">,</span> <span class="variable">hlinex</span><span class="punctuation">,</span> <span class="variable">vlinex</span><span class="keyword">#</span><span class="keyword">let</span> <span class="title function_">three-line-table</span><span class="punctuation">(</span><span class="variable">columns</span><span class="punctuation">,</span> <span class="variable">headers</span><span class="punctuation">,</span> <span class="variable">contents</span><span class="punctuation">,</span> <span class="variable">caption</span><span class="punctuation">,</span> <span class="variable">lang</span><span class="punctuation">:</span> <span class="string">&quot;en&quot;</span><span class="punctuation">,</span><span class="variable">rows</span><span class="punctuation">:</span> <span class="keyword">auto</span><span class="punctuation">)</span> <span class="operator">=</span> <span class="punctuation">{</span><span class="title function_">figure</span><span class="punctuation">(</span>  <span class="title function_">tablex</span><span class="punctuation">(</span>    <span class="variable">columns</span><span class="punctuation">:</span> <span class="variable">columns</span><span class="punctuation">,</span>    <span class="variable">rows</span><span class="punctuation">:</span> <span class="variable">rows</span><span class="punctuation">,</span>    <span class="variable">align</span><span class="punctuation">:</span> <span class="variable">center</span> <span class="operator">+</span> <span class="variable">horizon</span><span class="punctuation">,</span>    <span class="variable">auto-lines</span><span class="punctuation">:</span> <span class="literal">false</span><span class="punctuation">,</span>    <span class="variable">repeat-header</span><span class="punctuation">:</span> <span class="literal">true</span><span class="punctuation">,</span>    <span class="title function_">hlinex</span><span class="punctuation">(</span><span class="variable">stroke</span><span class="punctuation">:</span> <span class="number">1.5pt</span><span class="punctuation">)</span><span class="punctuation">,</span>    <span class="operator">..</span><span class="variable">headers</span><span class="punctuation">,</span>    <span class="title function_">hlinex</span><span class="punctuation">(</span><span class="variable">stroke</span><span class="punctuation">:</span> <span class="number">0.75pt</span><span class="punctuation">)</span><span class="punctuation">,</span>    <span class="operator">..</span><span class="variable">contents</span><span class="punctuation">,</span>    <span class="title function_">hlinex</span><span class="punctuation">(</span><span class="variable">stroke</span><span class="punctuation">:</span> <span class="number">1.5pt</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="punctuation">)</span><span class="punctuation">,</span>  <span class="variable">kind</span><span class="punctuation">:</span> <span class="variable">table</span><span class="punctuation">,</span>  <span class="variable">supplement</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="keyword">#</span><span class="keyword">if</span> <span class="punctuation">(</span><span class="variable">lang</span> <span class="operator">==</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span> <span class="punctuation">{</span><span class="string">&quot;Table&quot;</span><span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span><span class="string">&quot;表&quot;</span><span class="punctuation">}</span><span class="punctuation">]</span><span class="punctuation">,</span>  <span class="variable">caption</span><span class="punctuation">:</span> <span class="variable">caption</span><span class="punctuation">,</span><span class="punctuation">)</span><span class="punctuation">}</span><span class="comment">// 使用</span><span class="title function_">#</span><span class="title function_">three-line-table</span><span class="punctuation">(</span>  <span class="number">2</span><span class="punctuation">,</span>  <span class="punctuation">(</span><span class="punctuation">[</span><span class="strong">*</span><span class="strong">参数</span><span class="strong">*</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="strong">*</span><span class="strong">结果</span><span class="strong">*</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="punctuation">(</span>    <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">sin</span><span class="formula">^</span><span class="formula">2</span><span class="formula">(</span><span class="formula">2</span><span class="formula"> </span><span class="formula">theta</span><span class="formula">_</span><span class="formula">(</span><span class="formula">12</span><span class="formula">)</span><span class="formula">)</span><span class="punctuation">$</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">0.857</span><span class="formula"> </span><span class="formula">pm</span><span class="formula"> </span><span class="formula">0.024</span><span class="punctuation">$</span><span class="punctuation">]</span><span class="punctuation">,</span>    <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">sin</span><span class="formula">^</span><span class="formula">2</span><span class="formula">(</span><span class="formula">2</span><span class="formula"> </span><span class="formula">theta</span><span class="formula">_</span><span class="formula">(</span><span class="formula">23</span><span class="formula">)</span><span class="formula">)</span><span class="punctuation">$</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">&gt;</span><span class="formula"> </span><span class="formula">0.95</span><span class="punctuation">$</span><span class="punctuation">]</span><span class="punctuation">,</span>    <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">sin</span><span class="formula">^</span><span class="formula">2</span><span class="formula">(</span><span class="formula">2</span><span class="formula"> </span><span class="formula">theta</span><span class="formula">_</span><span class="formula">(</span><span class="formula">13</span><span class="formula">)</span><span class="formula">)</span><span class="punctuation">$</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">0.098</span><span class="formula"> </span><span class="formula">pm</span><span class="formula"> </span><span class="formula">0.013</span><span class="punctuation">$</span><span class="punctuation">]</span><span class="punctuation">,</span>    <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">Delta</span><span class="formula">\m</span><span class="formula">_</span><span class="formula">(</span><span class="formula">12</span><span class="formula">)</span><span class="formula">^</span><span class="formula">2</span><span class="punctuation">$</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">(</span><span class="formula">7.50</span><span class="formula"> </span><span class="formula">pm</span><span class="formula"> </span><span class="formula">0.20</span><span class="formula">)</span><span class="formula"> </span><span class="formula">times</span><span class="formula"> </span><span class="formula">10</span><span class="formula">^</span><span class="formula">(</span><span class="formula">-</span><span class="formula">5</span><span class="formula">)</span><span class="formula"> </span><span class="formula">&quot;eV&quot;</span><span class="formula">^</span><span class="formula">2</span><span class="punctuation">$</span><span class="punctuation">]</span><span class="punctuation">,</span>    <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">Delta</span><span class="formula">\m</span><span class="formula">_</span><span class="formula">(</span><span class="formula">23</span><span class="formula">)</span><span class="formula">^</span><span class="formula">2</span><span class="punctuation">$</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">0.00232</span><span class="formula">_</span><span class="formula">(</span><span class="formula">-</span><span class="formula">0.00008</span><span class="formula">)</span><span class="formula">^</span><span class="formula">(</span><span class="formula">+</span><span class="formula">0.00012</span><span class="formula">)</span><span class="formula"> </span><span class="formula">&quot;eV&quot;</span><span class="formula">^</span><span class="formula">2</span><span class="punctuation">$</span><span class="punctuation">]</span><span class="punctuation">,</span>    <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">delta</span><span class="formula">\/</span><span class="formula">pi</span><span class="punctuation">$</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="punctuation">$</span><span class="formula">1.35</span><span class="formula">_</span><span class="formula">(</span><span class="formula">-</span><span class="formula">0.43</span><span class="formula">)</span><span class="formula">^</span><span class="formula">(</span><span class="formula">+</span><span class="formula">0.64</span><span class="formula">)</span><span class="punctuation">$</span><span class="punctuation">]</span>  <span class="punctuation">)</span><span class="punctuation">,</span>  <span class="punctuation">[</span>中微子振荡参数测量结果<span class="title function_">#</span><span class="title function_">super</span><span class="punctuation">[</span><span class="variable">@zqw2015daya</span> <span class="variable">@zym2018daya</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="keyword"></span>  <span class="variable">lang</span><span class="punctuation">:</span> <span class="string">&quot;zh&quot;</span><span class="punctuation">,</span><span class="punctuation">)</span> <span class="variable">&lt;nu_para&gt;</span></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/05/6596e6d81be91.png" alt="三线表" style="height:300px;"/></div><span class="image-caption">三线表</span></div><ol start="2"><li>公式块</li></ol><figure class="highlight typst"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="keyword">#</span><span class="keyword">let</span> <span class="title function_">box-quote</span><span class="punctuation">(</span><span class="variable">body</span><span class="punctuation">,</span> <span class="variable">width</span><span class="punctuation">:</span> <span class="number">100%</span><span class="punctuation">,</span> <span class="variable">inset</span><span class="punctuation">:</span> <span class="number">5pt</span><span class="punctuation">,</span> <span class="variable">outset</span><span class="punctuation">:</span> <span class="number">0pt</span><span class="punctuation">)</span> <span class="operator">=</span> <span class="punctuation">{</span><span class="title function_">block</span><span class="punctuation">(</span>  <span class="variable">fill</span><span class="punctuation">:</span> <span class="variable">green</span><span class="operator">.</span><span class="title function_">lighten</span><span class="punctuation">(</span><span class="number">80%</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="variable">width</span><span class="punctuation">:</span> <span class="variable">width</span><span class="punctuation">,</span>  <span class="variable">inset</span><span class="punctuation">:</span> <span class="variable">inset</span><span class="punctuation">,</span>  <span class="variable">outset</span><span class="punctuation">:</span> <span class="variable">outset</span><span class="punctuation">,</span>  <span class="variable">radius</span><span class="punctuation">:</span> <span class="number">4pt</span><span class="punctuation">,</span>  <span class="variable">stroke</span><span class="punctuation">:</span> <span class="variable">green</span><span class="operator">.</span><span class="title function_">darken</span><span class="punctuation">(</span><span class="number">60%</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="variable">breakable</span><span class="punctuation">:</span> <span class="literal">true</span><span class="punctuation">,</span>  <span class="variable">body</span><span class="punctuation">)</span><span class="punctuation">}</span><span class="comment">// 使用</span><span class="title function_">#</span><span class="title function_">box-quote</span><span class="punctuation">[</span><span class="punctuation">$</span><span class="formula"></span><span class="formula">P</span><span class="formula">_</span><span class="formula">(</span><span class="formula">nu</span><span class="formula">_</span><span class="formula">alpha</span><span class="formula"> </span><span class="formula">-&gt;</span><span class="formula"> </span><span class="formula">nu</span><span class="formula">_</span><span class="formula">beta</span><span class="formula">)</span><span class="formula"> </span><span class="formula">approx</span><span class="formula"> </span><span class="formula">sin</span><span class="formula">^</span><span class="formula">(</span><span class="formula">2</span><span class="formula">)</span><span class="formula">2</span><span class="formula">theta</span><span class="formula"> </span><span class="formula">sin</span><span class="formula">^</span><span class="formula">(</span><span class="formula">2</span><span class="formula">)</span><span class="formula">(</span><span class="formula">(</span><span class="formula">m</span><span class="formula">_</span><span class="formula">1</span><span class="formula">^</span><span class="formula">2</span><span class="formula">-</span><span class="formula">m</span><span class="formula">_</span><span class="formula">2</span><span class="formula">^</span><span class="formula">2</span><span class="formula">)</span><span class="formula">/</span><span class="formula">(</span><span class="formula">4</span><span class="formula">p</span><span class="formula">)</span><span class="formula">t</span><span class="formula">)</span><span class="formula"> </span><span class="formula">approx</span><span class="formula"> </span><span class="formula">sin</span><span class="formula">^</span><span class="formula">(</span><span class="formula">2</span><span class="formula">)</span><span class="formula">2</span><span class="formula">theta</span><span class="formula"> </span><span class="formula">sin</span><span class="formula">^</span><span class="formula">(</span><span class="formula">2</span><span class="formula">)</span><span class="formula">(</span><span class="formula">Delta</span><span class="formula">\m</span><span class="formula">^</span><span class="formula">2</span><span class="formula"> </span><span class="formula">L</span><span class="formula">/</span><span class="formula">(</span><span class="formula">4</span><span class="formula">E</span><span class="formula">)</span><span class="formula">)</span><span class="formula"></span><span class="punctuation">$</span> <span class="variable">&lt;2flavor_mix_4&gt;</span><span class="punctuation">]</span></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/05/6596e74850568.png" alt="公式块" style="width:80%;"/></div><span class="image-caption">公式块</span></div><ol start="3"><li>数学符号的简易别名</li></ol><figure class="highlight typst"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="keyword">#</span><span class="keyword">import</span> <span class="string">&quot;@preview/physica:0.9.0&quot;</span> <span class="keyword">as</span> <span class="variable">ph</span><span class="keyword">#</span><span class="keyword">let</span> <span class="variable">sp</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="title function_">#</span><span class="title function_">h</span><span class="punctuation">(</span><span class="number">0.5em</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="keyword">#</span><span class="keyword">let</span> <span class="variable">pm</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="variable">#</span><span class="variable">sym</span><span class="operator">.</span><span class="variable">plus</span><span class="operator">.</span><span class="variable">minus</span><span class="punctuation">]</span><span class="keyword">#</span><span class="keyword">let</span> <span class="variable">le</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="variable">#</span><span class="variable">sym</span><span class="operator">.</span><span class="variable">lt</span><span class="operator">.</span><span class="variable">eq</span><span class="operator">.</span><span class="variable">slant</span><span class="punctuation">]</span><span class="keyword">#</span><span class="keyword">let</span> <span class="variable">ge</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="variable">#</span><span class="variable">sym</span><span class="operator">.</span><span class="variable">gt</span><span class="operator">.</span><span class="variable">eq</span><span class="operator">.</span><span class="variable">slant</span><span class="punctuation">]</span><span class="keyword">#</span><span class="keyword">let</span> <span class="variable">sim</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="variable">#</span><span class="variable">sym</span><span class="operator">.</span><span class="variable">tilde</span><span class="operator">.</span><span class="variable">op</span><span class="punctuation">]</span><span class="keyword">#</span><span class="keyword">let</span> <span class="variable">inf</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="variable">#</span><span class="variable">sym</span><span class="operator">.</span><span class="variable">infinity</span><span class="punctuation">]</span><span class="keyword">#</span><span class="keyword">let</span> <span class="title function_">rm</span><span class="punctuation">(</span><span class="variable">body</span><span class="punctuation">)</span> <span class="operator">=</span> <span class="punctuation">{</span><span class="variable">math</span><span class="operator">.</span><span class="title function_">upright</span><span class="punctuation">(</span><span class="variable">body</span><span class="punctuation">)</span><span class="punctuation">}</span><span class="keyword">#</span><span class="keyword">let</span> <span class="title function_">iso</span><span class="punctuation">(</span><span class="variable">b</span><span class="punctuation">,</span> <span class="variable">A</span><span class="punctuation">)</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="variable">#</span><span class="variable">ph</span><span class="operator">.</span><span class="title function_">isotope</span><span class="punctuation">(</span><span class="variable">b</span><span class="punctuation">,</span> <span class="variable">a</span><span class="punctuation">:</span> <span class="variable">A</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="keyword">#</span><span class="keyword">let</span> <span class="title function_">isoz</span><span class="punctuation">(</span><span class="variable">b</span><span class="punctuation">,</span> <span class="variable">A</span><span class="punctuation">,</span> <span class="variable">Z</span><span class="punctuation">)</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="variable">#</span><span class="variable">ph</span><span class="operator">.</span><span class="title function_">isotope</span><span class="punctuation">(</span><span class="variable">b</span><span class="punctuation">,</span> <span class="variable">a</span><span class="punctuation">:</span> <span class="variable">A</span><span class="punctuation">,</span> <span class="variable">z</span><span class="punctuation">:</span> <span class="variable">Z</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="comment">// 使用</span><span class="title function_">#</span><span class="title function_">box-quote</span><span class="punctuation">[</span><span class="punctuation">$</span><span class="formula"></span><span class="formula">1</span><span class="formula"> </span><span class="formula">pm</span><span class="formula"> </span><span class="formula">2</span><span class="formula"> </span><span class="formula">le</span><span class="formula"> </span><span class="formula">3</span><span class="formula"> </span><span class="formula">ge</span><span class="formula"> </span><span class="formula">4</span><span class="formula"> </span><span class="formula">sim</span><span class="formula"> </span><span class="formula">5</span><span class="formula"> </span><span class="formula">inf</span><span class="formula"> </span><span class="formula">6</span><span class="formula"> </span><span class="formula">sp</span><span class="formula"> </span><span class="formula">rm</span><span class="formula">(</span><span class="formula">A</span><span class="formula">\b</span><span class="formula">)</span><span class="formula"> </span><span class="formula">sp</span><span class="formula"> </span><span class="formula">7</span><span class="formula"> </span><span class="formula">sp</span><span class="formula"> </span><span class="formula">&quot;Ab&quot;</span><span class="formula"> </span><span class="formula">8</span><span class="formula"> </span><span class="formula">sp</span><span class="formula"> </span><span class="formula">iso</span><span class="formula">(</span><span class="formula">U</span><span class="formula">,</span><span class="formula"> </span><span class="formula">235</span><span class="formula">)</span><span class="formula"> </span><span class="formula">sp</span><span class="formula"> </span><span class="formula">9</span><span class="formula"> </span><span class="formula">sp</span><span class="formula"> </span><span class="formula">isoz</span><span class="formula">(</span><span class="formula">L</span><span class="formula">\i</span><span class="formula">,</span><span class="formula"> </span><span class="formula">7</span><span class="formula">,</span><span class="formula"> </span><span class="formula">3</span><span class="formula">)</span><span class="formula"></span><span class="punctuation">$</span><span class="punctuation">]</span></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2024/01/05/6596e8661e0e6.png" alt="数学符号" style="width:80%;"/></div><span class="image-caption">数学符号</span></div><h2 id="参考资料">参考资料<a class="header-anchor" href="#参考资料">¶</a></h2><ol><li><span id="refer-1"><a href="https://github.com/typst/typst">Typst</a></span></li><li><span id="refer-2"><a href="https://typst.app/docs">Documentation</a></span></li><li><span id="refer-3"><a href="https://zhuanlan.zhihu.com/p/646119837">为LaTeX用户准备的Typst入门</a></span></li><li><span id="refer-4"><a href="https://www.el42.cc/posts/typst-tablex-usage/">Typst Tablex 简单教程</a></span></li><li><span id="refer-5"><a href="https://repology.org/project/typst/versions">Typst on Repology</a></span></li><li><span id="refer-6"><a href="https://typst-doc-cn.github.io/docs/chinese/">中文用户指南</a></span></li><li><span id="refer-7"><a href="https://zhuanlan.zhihu.com/p/618910802">Typst-&quot;超越&quot;LaTeX的文档排版工具</a></span></li><li><span id="refer-8"><a href="https://sitandr.github.io/typst-examples-book/book/">Typst Examples Book</a></span></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;note info flat&quot;&gt;&lt;p&gt;个人的自用模板代码可以查看 &lt;a href=&quot;https://git.foolishfox.cn/fox/Typst-Snippets&quot;&gt;Typst-Snippets&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Typst 是</summary>
      
    
    
    
    <category term="软件/程序" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/"/>
    
    
    <category term="教程" scheme="https://foolishfox.cn/tags/%E6%95%99%E7%A8%8B/"/>
    
    <category term="typst" scheme="https://foolishfox.cn/tags/typst/"/>
    
  </entry>
  
  <entry>
    <title>学习笔记 | 贝叶斯块算法</title>
    <link href="https://foolishfox.cn/posts/202310-bayesian-block.html"/>
    <id>https://foolishfox.cn/posts/202310-bayesian-block.html</id>
    <published>2023-10-23T07:44:34.000Z</published>
    <updated>2023-10-26T14:53:34.000Z</updated>
    
    <content type="html"><![CDATA[<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script><div class="note warning flat"><p>施工中</p></div><p>获取探测器的计数随时间或其他物理量的变化可以帮助了解发生的物理过程的各种性质。例如在 X 射线和 γ 射线天文学中十分关注光子计数随时间的变化，这一类变化被称为光变曲线，可以借此计算相应物理过程的空间尺度等性质。</p><h2 id="基础知识">基础知识<a class="header-anchor" href="#基础知识">¶</a></h2><h3 id="核辐射测量的统计性质">核辐射测量的统计性质<a class="header-anchor" href="#核辐射测量的统计性质">¶</a></h3><p>探测 X/γ 射线需要使用核辐射探测器，每探测到一个事例，探测器将会记录相应事例的物理信息，如时间、能量、径迹等。核辐射的测量充满了随机性，但是可以用统计分布来描述其中的随机性。单个放射性粒子的衰变过程是一个伯努利事件，其衰变常数为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span></span></span></span>，则在时间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>∼</mo><mi>t</mi></mrow><annotation encoding="application/x-tex">0\sim t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> 内发生衰变的可能性为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲p = 1 - e^{-\l…'>\begin{align}p = 1 - e^{-\lambda t}\end{align}</p><p>对于由 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">n_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 个放射性粒子组成的体系，彼此之间发生衰变是独立的，则体系的衰变过程是一个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">n_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 重伯努利过程，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> 时刻发生了衰变的粒子数目 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 满足二项分布：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}P…'>\begin{equation}\begin{split}P(n|n_0) &amp;= C_{n_0}^np^n(1-p)^{n_0-n} \\\mu &amp;= E(n) = n_0p \\\sigma^2 &amp;= D(n) = n_0p(1-p)\end{split}\end{equation}</p><p>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">n_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 足够大，而 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span> 足够小时，二项分布可以近似为泊松分布：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}P…'>\begin{equation}\begin{split}P(n) &amp;= \frac{\mu^n}{n!}e^{-\mu} \\\mu &amp;= n_0p \\\sigma &amp;= \sqrt{\mu}\end{split}\end{equation}</p><p>对于一般的物理过程而言，都满足该条件。当均值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">μ</span></span></span></span> 足够大时，泊松分布可以进一步近似为高斯分布。在辐射测量中，我们获取到的是探测时间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">d</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\mathrm{d}t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathnormal">t</span></span></span></span> 内的总计数，假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">d</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\mathrm{d}t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathnormal">t</span></span></span></span> 时间内源的强度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span></span></span></span> （单位为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="normal">s</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\mathrm{s}^{-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">s</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>）不变，则有：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>μ</mi><mo>=</mo><mi>λ</mi><mi mathvariant="normal">d</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\mu = \lambda\mathrm{d}t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">μ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathnormal">t</span></span></span></span></span></p><p>两个相邻事例的时间间隔为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 表示在第一个事例后 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>∼</mo><mi>T</mi></mrow><annotation encoding="application/x-tex">0\sim T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 时间内没有事例，而在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>∼</mo><mi>T</mi><mo>+</mo><mi mathvariant="normal">d</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">T\sim T+\mathrm{d}t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathnormal">t</span></span></span></span> 时间内有一个事例，其概率可以表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}P…'>\begin{equation}\begin{split}P(t\le T \le t+\mathrm{d}t) &amp;= P_t(0)\times P_{\mathrm{d}t}(1)\\P_t(0) = \frac{(\lambda t)^0}{0!}e^{-\lambda t} &amp;= e^{-\lambda t} \\P_{\mathrm{d}t}(1) = \frac{(\lambda\mathrm{d}t)^1}{1!}e^{-\lambda\mathrm{d}t} &amp;\approx \lambda\mathrm{d}t\quad(e^{-\lambda\mathrm{d}t} \to 1)\end{split}\end{equation}</p><p>设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span> 为概率密度函数，则有：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲f(t)\mathrm{d}…'>\begin{align}f(t)\mathrm{d}t = P(t\le T \le t+\mathrm{d}t) = \lambda e^{-\lambda t}\mathrm{d}t\end{align}</p><p>可见时间间隔 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 满足指数分布，可以求得其期望值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>t</mi><mo stretchy="true">‾</mo></mover><mo>=</mo><mfrac><mn>1</mn><mi>λ</mi></mfrac></mrow><annotation encoding="application/x-tex">\overline{t}=\frac{1}{\lambda}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.81508em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.81508em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">t</span></span></span><span style="top:-3.73508em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">λ</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。</p><h3 id="贝叶斯定理">贝叶斯定理<a class="header-anchor" href="#贝叶斯定理">¶</a></h3><p>对于一个模型 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">M</mi></mrow><annotation encoding="application/x-tex">\mathscr{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7em;vertical-align:0em;"></span><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span></span></span></span>，假设其所有参数构成向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span>。则根据已知数据 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span>，贝叶斯定理可以表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲P(\theta|D,\ma…'>\begin{align}P(\theta|D,\mathscr{M}) = \frac{P(D|\theta,\mathscr{M})P(\theta|\mathscr{M})}{P(D|\mathscr{M})}\end{align}</p><p id='eq-bayesian' class='anchor'>eq-bayesian</p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>θ</mi><mi mathvariant="normal">∣</mi><mi>D</mi><mo separator="true">,</mo><mi mathvariant="script">M</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(\theta|D,\mathscr{M})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="mclose">)</span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span> 的后验概率（已知 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span> 情况下 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span> 的条件概率）</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>θ</mi><mi mathvariant="normal">∣</mi><mi mathvariant="script">M</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(\theta|\mathscr{M})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mord">∣</span><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="mclose">)</span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span> 的先验概率</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>D</mi><mi mathvariant="normal">∣</mi><mi>θ</mi><mo separator="true">,</mo><mi mathvariant="script">M</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(D|\theta,\mathscr{M})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="mclose">)</span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span> 的后验概率或者在特定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span> 下，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span> 的似然性，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mi mathvariant="normal">∣</mi><mi>D</mi><mo separator="true">,</mo><mi mathvariant="script">M</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(\theta|D,\mathscr{M})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="mclose">)</span></span></span></span></li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>D</mi><mi mathvariant="normal">∣</mi><mi mathvariant="script">M</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(D|\mathscr{M})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord">∣</span><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="mclose">)</span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span> 的先验概率</li></ul><p>对于一组模型 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">M</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi mathvariant="script">M</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi mathvariant="script">M</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\mathscr{M}_1,\mathscr{M}_2,\dots,\mathscr{M}_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8944399999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，所有的约束、相关背景知识或者假设被称为信息背景，记作 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi></mrow><annotation encoding="application/x-tex">I</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span></span></span></span>。则在给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi></mrow><annotation encoding="application/x-tex">I</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span></span></span></span> 的情况下，不同模型的后验概率可以表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲P(\mathscr{M}_…'>\begin{align}P(\mathscr{M}_k|D,I) = \frac{P(D|\mathscr{M}_k,I)P(\mathscr{M}_k|I)}{P(D|I)}\end{align}</p><p>信息背景应当是不变的，所以我们可以省略。因此两种模型对数据的符合程度可以使用其后验概率的比值（即 odds ratio）表示：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\mathscr{O}_{i…'>\begin{align}\mathscr{O}_{ij} = \frac{P(\mathscr{M}_i|D)}{P(\mathscr{M}_j|D)} = \frac{P(D|\mathscr{M}_i)P(\mathscr{M}_i)}{P(D|\mathscr{M}_j)P(\mathscr{M}_j)}\end{align}</p><p>根据贝叶斯公式，由于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>θ</mi><mi>k</mi></msub><mi mathvariant="normal">∣</mi><mi>D</mi><mo separator="true">,</mo><msub><mi mathvariant="script">M</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(\theta_k|D,\mathscr{M}_k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 归一化，由式 (<a href='#eq-bayesian'>eq-bayesian</a>) 可以得到：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\mathscr{L}(\m…'>\begin{align}\mathscr{L}(\mathscr{M}_k|D) \equiv P(D|\mathscr{M}_k) = \int P(D|\theta_k,\mathscr{M}_k)P(\theta_k|\mathscr{M}_k)\mathrm{d}\theta_k \\J(\mathscr{M}_k|D) \equiv P(\mathscr{M}_k)\int P(D|\theta_k,\mathscr{M}_k)P(\theta_k|\mathscr{M}_k)\mathrm{d}\theta_k\end{align}</p><p id='eq-global-likelihood' class='anchor'>eq-global-likelihood</p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">L</mi><mo stretchy="false">(</mo><msub><mi mathvariant="script">M</mi><mi>k</mi></msub><mi mathvariant="normal">∣</mi><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathscr{L}(\mathscr{M}_k|D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathscr" style="margin-right:0.19189em;">L</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span> 被称为全局似然函数（global likelihood，叫边缘概率更多，marginal probability），<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo stretchy="false">(</mo><msub><mi mathvariant="script">M</mi><mi>k</mi></msub><mi mathvariant="normal">∣</mi><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">J(\mathscr{M}_k|D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span> 是数据和模型的联合概率（joint probability），包含了先验信息而与模型参数无关，则有：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\mathscr{O}_{i…'>\begin{align}\mathscr{O}_{ij} = \frac{\mathscr{L}(\mathscr{M}_i|D)}{\mathscr{L}(\mathscr{M}_j|D)}\rho\end{align}</p><p id='eq-odds-ratio' class='anchor'>eq-odds-ratio</p><p>其中：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\rho = \frac{P…'>\begin{align}\rho = \frac{P(\mathscr{M}_i)}{P(\mathscr{M}_j)}\end{align}</p><h3 id="光变曲线">光变曲线<a class="header-anchor" href="#光变曲线">¶</a></h3><p>一定时间范围内的计数随时间的变化曲线就是我们所需的光变曲线，因此光变曲线可以理解为探测事例根据时间绘制的频数分布直方图。直方图的每一组在这里被称为分箱（bin），组距被称为 bin 宽，各组的界限值被称为 bin edge，直方图一个很重要的特性的分箱之间是等距的。</p><p>对事例进行分箱的会丢弃大量信息，而且分箱的大小和位置对最终分析结果的影响很大。bin 宽越小，能够展现更精细的结构，但是单一分箱内的计数过少，统计性不足；bin 宽越大，统计性越强，但是丢失的物理信息更多。所以我们需要一种方法，既能够保证统计性，同时还能尽可能地展现精细的结构。这种方法应当允许分箱拥有不同的 bin 宽，而且 bin edge 能够根据数据自适应确定。</p><p>一个简单的想法是遍历每一种可能的分箱方案，而可能方案的总数为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">2^N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span></span></span> ，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> 为数据点的数目。显而易见随着数据量的增大，这种方法很快变得不可用。Scargle 在 1998 年提出了基于似然函数的迭代算法<sup><a href="#refer-1">(1)</a></sup>，能够在可接受的时间范围内得出近似解；而在 2013 年，Scargle 基于动态规划（<code>Dynamic Programming</code>）和块评价函数提出了一种新算法<sup><a href="#refer-2">(2)</a></sup>，能够在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 的时间内求出最优解。在本文中，前者称为近似算法，后者为DP算法，两者统称为贝叶斯块算法。</p><h3 id="贝叶斯块算法">贝叶斯块算法<a class="header-anchor" href="#贝叶斯块算法">¶</a></h3><p>贝叶斯块算法将光变曲线表示为亮度随时间的分段常数，可以用于估计背景水平以及物理事件的时间尺度、空间尺度与强度等信息。</p><p>在该算法中，单个的数据点被称为 <code>Cell</code>，而对数据进行分割的点被称为分割点 <code>Change Point</code>（简写为 <code>cp</code>），而相邻两个分割点之间（包括第一个分割点之前与最后一个分割点之后的）的所有数据点的集合被称为块 <code>Block</code>，某种特定的分割方案（或分割点的组合）被称为组合 <code>Partition</code>。</p><p>算法的关键思想是不同块之间的评价是独立的，仅取决于该块的性质（例如块的长度、数据的情况等）。例如简单的分段常数模型具有这些参数：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">N_\mathrm{cp}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>：分割点的数目</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mi>k</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">t^\mathrm{cp}_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.083608em;vertical-align:-0.3013079999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.3986920000000005em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3013079999999999em;"><span></span></span></span></span></span></span></span></span></span>：第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个块的起始点（即第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 个和第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个块的分割点）</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">X_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>：第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个块的信号强度</li></ul><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>∈</mo><mo stretchy="false">{</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>N</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi></mrow></msub><mo>+</mo><mn>1</mn><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">k\in\{1,2,\dots,N_\mathrm{cp}+1\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">{</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">}</span></span></span></span>，块最重要的两个参数是强度（即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">X_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）与长度（起始点与下一个分割点之间的间隔）。模型关键的问题在于要分多少个块，近似算法和DP算法对此的处理方式有所区别，具体参见后文。</p><h2 id="数据模式">数据模式<a class="header-anchor" href="#数据模式">¶</a></h2><h3 id="Time-Tagged-Event-Data">Time-Tagged Event Data<a class="header-anchor" href="#Time-Tagged-Event-Data">¶</a></h3><p>Time-Tagged Event（时间标记事件，TTE）是指记录事例入射时间的模式，表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲D_\mathrm{TTE}…'>\begin{align}D_\mathrm{TTE}: \{t_n,n=1\dots N\}\end{align}</p><p id='eq-tte-1' class='anchor'>eq-tte-1</p><p>事件记录的精度取决于采集系统的频率，以 20 MHz 的晶振为例，其时钟间隔 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi><mi>t</mi><mo>=</mo><mn>50</mn><mtext> </mtext><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">s</mi></mrow></mrow><annotation encoding="application/x-tex">\delta t = 50\ \mathrm{ns}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mspace"> </span><span class="mord"><span class="mord mathrm">n</span><span class="mord mathrm">s</span></span></span></span></span>，因此式 (<a href='#eq-tte-1'>eq-tte-1</a>) 可以表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲D_\mathrm{TTE}…'>\begin{align}D_\mathrm{TTE}: \{m_n,n=1\dots N\}\end{align}</p><p id='eq-tte-2' class='anchor'>eq-tte-2</p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">m_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为时间刻度（time ticks），其代表的时间与总的刻度数为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲t_m &amp;= m\delta…'>\begin{align}t_m &amp;= m\delta t \\M &amp;= \frac{T}{\delta t}\end{align}</p><p>进一步，式 (<a href='#eq-tte-1'>eq-tte-1</a>) 可以使用可观测量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">X_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲D_\mathrm{TTE}…'>\begin{align}D_\mathrm{TTE}: X_m = \begin{cases}0, \mathrm{no\ event\ during\ tick\ m} \\1, \mathrm{otherwise}\end{cases}\end{align}</p><p>其概率可以表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}P…'>\begin{equation}\begin{split}P(X_m=0|\Lambda) &amp;= e^{-\Lambda} = p_0 \\P(X_m=1|\Lambda) = 1 - p_0 &amp;= p_1 = e^{-\Lambda}\sum\limits_{k=1}^{\infty}\frac{\Lambda^k}{k!} \\\Lambda &amp;= \lambda\delta t\end{split}\end{equation}</p><p>由于时间间隔 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\delta t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="mord mathnormal">t</span></span></span></span> 极短，所以当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span></span></span></span> 不太大时，在一个时间间隔内多于 1 个入射事例的可能性相当低，则有：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲p_1 = 1 - e^{-…'>\begin{align}p_1 = 1 - e^{-\lambda\delta t} \approx \lambda\delta t = \Lambda\end{align}</p><p id='eq-tte-p1' class='anchor'>eq-tte-p1</p><h3 id="Binned-Data">Binned Data<a class="header-anchor" href="#Binned-Data">¶</a></h3><p>Binned Data 是已经分箱数据，将时间区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 均分为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> 个区间，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">X_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 表示第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span> 个区间的事例计数，则有：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲D_\mathrm{BIN}…'>\begin{align}D_\mathrm{BIN}: \{X_m,m=1,\dots,M\} \\P(X_m|\Lambda) = \frac{\Lambda^{X_m}}{X_m!}e^{-\Lambda}\end{align}</p><h3 id="Time-to-Spill-Data">Time-to-Spill Data<a class="header-anchor" href="#Time-to-Spill-Data">¶</a></h3><p>Time-to-Spill（TTS）是指为了减少数据量，而每隔 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> 个事例记录一个事例数据的模式，可表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲D_\mathrm{TTS}…'>\begin{align}D_\mathrm{TTS}: \{\tau_n,n=1,\dots,N-1\}\end{align}</p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>τ</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\tau_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 个和第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 个记录的事例之间的时间间隔（以刻度数表示，即实际时间间隔为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>τ</mi><mi>n</mi></msub><mi>δ</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\tau_n\delta t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="mord mathnormal">t</span></span></span></span>），其分布满足：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲P(\tau|\Lambda…'>\begin{align}P(\tau|\Lambda) = \frac{\Lambda^S}{\Gamma(S)}\tau^{S-1}e^{-\Lambda\tau}\end{align}</p><h3 id="混合模式">混合模式<a class="header-anchor" href="#混合模式">¶</a></h3><p>实际观测过程中，同一事件的数据模式可能会发生改变。例如计数率太高时可能从 TTE 模式更改为 BIN 或者 TTS 模式，但只要选择的块评价函数对于不同数据模式而言是一致的，则可以处理任意混合模式的数据。</p><h3 id="曝光">曝光<a class="header-anchor" href="#曝光">¶</a></h3><p>在观测过程中，受到各种因素的影响，仪器的相应并不是一致的，例如辐射源的强度可能会改变探测器的探测效率，天气和环境的改变也可能会造成遮挡或噪声。这些因素的综合影响被称为曝光（<code>Exposure</code>），可以直接从整个探测系统（包含环境）的性质出发进行计算得到，或者通过仪器的刻度与标定获得。在实际中我们可以将第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 个数据点的曝光表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲0\le e_n \le 1…'>\begin{align}0\le e_n \le 1\end{align}</p><p>在实际计算中，需要将曝光的影响进行归一化，即将计数率乘以一个因子 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><msub><mi>e</mi><mi>n</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{e_n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2902079999999998em;vertical-align:-0.44509999999999994em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.44509999999999994em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。对于 TTE 数据我们得到的只是离散的时间序列，为了将其转化为计数率，需要除以事例间隔长度，具体而言对于第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 个事例，其计数率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">C_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 可以表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲C_n &amp;= \frac{1…'>\begin{align}C_n &amp;= \frac{1}{e_n\Delta t_n} \\\Delta t_n &amp;= (t_{n+1}-t_{n-1}) / 2\end{align}</p><p>可以证明 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">C_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 满足一个仅与第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 个事例时的真实计数率相关的分布。</p><h2 id="近似算法">近似算法<a class="header-anchor" href="#近似算法">¶</a></h2><h3 id="常数泊松分布模型">常数泊松分布模型<a class="header-anchor" href="#常数泊松分布模型">¶</a></h3><p>假定在时间区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 内，辐射源的强度恒定不变，用单位时间的光子数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\lambda &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">λ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 表示。将观测时段以固定时间间隔 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>T</mi></mrow><annotation encoding="application/x-tex">\Delta T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 划分为若干子区间，每个子区间上的计数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 均满足泊松分布，即：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}P…'>\begin{equation}\begin{split}P(k|\Lambda) &amp;= \frac{\Lambda^ke^{-\Lambda}}{k!} \\\Lambda &amp;\equiv \lambda\Delta T\end{split}\end{equation}</p><p>使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">M</mi><mo stretchy="false">(</mo><mi mathvariant="normal">Λ</mi><mo separator="true">,</mo><mi>T</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathscr{M}(\Lambda, T)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="mopen">(</span><span class="mord">Λ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span></span></span></span> 表示该模型类。除了常数模型外，还有线性模型与指数模型等，其表达式分别为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\lambda(t) &amp;= …'>\begin{align}\lambda(t) &amp;= \lambda_0[1+a(t-t_0)] \\\lambda(t) &amp;= \lambda_0 e^{a(t-t_0)}\end{align}</p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\lambda_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是基准强度，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">t_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是基准时间，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> 是强度的变化速率。</p><h4 id="TTE-Data">TTE Data<a class="header-anchor" href="#TTE-Data">¶</a></h4><p>由于不同入射事例之间是彼此独立的，则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi mathvariant="normal">T</mi><mi mathvariant="normal">T</mi><mi mathvariant="normal">E</mi></mrow></msub></mrow><annotation encoding="application/x-tex">D_\mathrm{TTE}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span><span class="mord mathrm mtight">T</span><span class="mord mathrm mtight">E</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的联合概率可以表示为每一刻度上概率的乘积：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}P…'>\begin{equation}\begin{split}P[D_\mathrm{TTE}|\mathscr{M}(\Lambda, T)] &amp;= \prod\limits_{m=1}^MP(X_m|\Lambda) \\&amp;= p_1^Np_0^{M-N}\end{split}\end{equation}</p><p id='eq-tte-join' class='anchor'>eq-tte-join</p><p>可以发现与参数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 无关，模型类可简写为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">M</mi><mo stretchy="false">(</mo><mi mathvariant="normal">Λ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathscr{M}(\Lambda)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="mopen">(</span><span class="mord">Λ</span><span class="mclose">)</span></span></span></span>。由二项分布可知当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">p_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 满足：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\frac{N}{M+1}\…'>\begin{align}\frac{N}{M+1}\le p_1 \le \frac{N+1}{M+1}\end{align}</p><p>时，式 (<a href='#eq-tte-join'>eq-tte-join</a>) 有最大值，由于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> 都较大，不妨取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub><mo>=</mo><mfrac><mi>N</mi><mi>M</mi></mfrac></mrow><annotation encoding="application/x-tex">p_1=\frac{N}{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.217331em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。则由式 (<a href='#eq-tte-p1'>eq-tte-p1</a>) 有：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\lambda &amp;= -\f…'>\begin{align}\lambda &amp;= -\frac{1}{\delta t}\ln\left(1-\frac{N}{M}\right) \\&amp;\approx \frac{1}{\delta t}\frac{N}{M}\end{align}</p><p id='eq-tte-lambda-max-1' class='anchor'>eq-tte-lambda-max-1</p><p id='eq-tte-lambda-max-2' class='anchor'>eq-tte-lambda-max-2</p><p>使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">p_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 代替 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Λ</mi></mrow><annotation encoding="application/x-tex">\Lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Λ</span></span></span></span> 作为模型参数，设参数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">p_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的先验分布为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲P(p_1|\mathscr…'>\begin{align}P(p_1|\mathscr{M}) = \begin{cases}1, 0 \le p_1 \le 1 \\0, \mathrm{otherwise}\end{cases}\end{align}</p><p>代入式 (<a href='#eq-global-likelihood'>eq-global-likelihood</a>) 中的全局似然函数，可得：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}P…'>\begin{equation}\begin{split}P(D_\mathrm{TTE}|\mathscr{M}) &amp;= \int P[D_\mathrm{TTE}|\mathscr{M}(p_1)]P(p_1|\mathscr{M})\mathrm{d}p_1 \\&amp;= \int_0^1 p_1^N(1-p_1)^{M-N}\mathrm{d}p_1 \\&amp;= B(N+1, M-N+1)\end{split}\end{equation}</p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">B(x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span> 为贝塔函数，可以用伽马函数表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲B(x,y) = \frac…'>\begin{align}B(x,y) = \frac{\Gamma(x)\Gamma(y)}{\Gamma(x+y)}\end{align}</p><p>因此可得：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}\…'>\begin{equation}\begin{split}\mathscr{L}(\mathscr{M}|D_\mathrm{TTE}) &amp;= \frac{\Gamma(N+1)\Gamma(M-N+1)}{\Gamma(M+2)} \\&amp;= \frac{N!(M-N)!}{(M+1)!}\end{split}\end{equation}</p><p id='eq-tte-likelihood' class='anchor'>eq-tte-likelihood</p><h4 id="BIN-Data">BIN Data<a class="header-anchor" href="#BIN-Data">¶</a></h4><p>同上可得 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi mathvariant="normal">B</mi><mi mathvariant="normal">I</mi><mi mathvariant="normal">N</mi></mrow></msub></mrow><annotation encoding="application/x-tex">D_\mathrm{BIN}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">B</span><span class="mord mathrm mtight">I</span><span class="mord mathrm mtight">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的联合概率为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲P[D_{BIN}|\mat…'>\begin{align}P[D_{BIN}|\mathscr{M}(\Lambda)] = \frac{\Lambda^Ne^{-M\Lambda}}{\prod\limits_{m=1}^MX_m!},\ N = \sum\limits_{m=1}^MX_m\end{align}</p><p id='eq-bin-joint' class='anchor'>eq-bin-joint</p><p>将式 (<a href='#eq-bin-joint'>eq-bin-joint</a>) 中的分子对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Λ</mi></mrow><annotation encoding="application/x-tex">\Lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Λ</span></span></span></span> 求导可得：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\frac{\mathrm{…'>\begin{align}\frac{\mathrm{d}(\Lambda^Ne^{-M\Lambda})}{\mathrm{d}\Lambda} = N\Lambda^{N-1}e^{-M\Lambda}-M\Lambda^Ne^{-M\Lambda}\end{align}</p><p>令其等于 0 则可得最大概率的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Λ</mi></mrow><annotation encoding="application/x-tex">\Lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Λ</span></span></span></span> 取值为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\Lambda = \fra…'>\begin{align}\Lambda = \frac{N}{M}\end{align}</p><p id='eq-bin-lambda-max' class='anchor'>eq-bin-lambda-max</p><p>与式 (<a href='#eq-tte-lambda-max-2'>eq-tte-lambda-max-2</a>) 中的近似值一致。设参数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Λ</mi></mrow><annotation encoding="application/x-tex">\Lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Λ</span></span></span></span> 的先验分布为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲P(\Lambda|\mat…'>\begin{align}P(\Lambda|\mathscr{M}) = \begin{cases}\frac{e^{-\Lambda}}{1 - e^{-C}}, 0 \le\Lambda\le C \\0, \mathrm{otherwise}\end{cases}\end{align}</p><p id='eq-bin-prior' class='anchor'>eq-bin-prior</p><p>可以证明该分布等价于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">p_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>C</mi></mrow></msup><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[e^{-C},1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span> 上的均匀分布。此处的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> 可以近似用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>T</mi><mrow><mi>M</mi><msub><mi>t</mi><mi>d</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{T}{Mt_d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.323191em;vertical-align:-0.4508599999999999em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4508599999999999em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 表示，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">t_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 表示仪器的死时间。对于特定的一组数据，不同模型中式 (<a href='#eq-bin-joint'>eq-bin-joint</a>) 中的分母不会发生改变，可以略去。当考虑 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>→</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">C\to\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord">∞</span></span></span></span> 时，则有：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}\…'>\begin{equation}\begin{split}\mathscr{L}(M|D_\mathrm{BIN}) = \int_0^\infty\Lambda^Ne^{-(M+1)\Lambda}\mathrm{d}\Lambda = \frac{\Gamma(N+1)}{(M+1)^{N+1}}\end{split}\end{equation}</p><p id='eq-bin-likelihood' class='anchor'>eq-bin-likelihood</p><h4 id="TTS-Data">TTS Data<a class="header-anchor" href="#TTS-Data">¶</a></h4><p>同上可得 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi mathvariant="normal">T</mi><mi mathvariant="normal">T</mi><mi mathvariant="normal">S</mi></mrow></msub></mrow><annotation encoding="application/x-tex">D_\mathrm{TTS}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span><span class="mord mathrm mtight">T</span><span class="mord mathrm mtight">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的联合概率为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲P[D_\mathrm{TT…'>\begin{align}P[D_\mathrm{TTS}|\mathscr{M}(\Lambda)] = \left[\frac{\Lambda^S}{\Gamma(S)}\right]^{N-1}\left(\prod\limits_{n=1}^{N-1}\tau_n\right)^{S-1}e^{-\Lambda M},\ M=\sum\limits_{n=1}^{N-1}\tau_n\end{align}</p><p>同理可求得最大概率处 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Λ</mi></mrow><annotation encoding="application/x-tex">\Lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Λ</span></span></span></span> 的取值为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\Lambda = \fra…'>\begin{align}\Lambda = \frac{SN}{M}\end{align}</p><p id='eq-tts-lambda-max' class='anchor'>eq-tts-lambda-max</p><p>结合式 (<a href='#eq-bin-prior'>eq-bin-prior</a>)，当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>→</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">C\to\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord">∞</span></span></span></span> 时可求得似然函数为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\mathscr{L}(\m…'>\begin{align}\mathscr{L}(\mathscr{M}|D_\mathrm{TTS}) = \frac{\left(\prod_{n=1}^{N-1}\tau_n\right)^{S-1}}{\Gamma(S)^{N-1}}\frac{\Gamma[S(N-1)+1]}{(M+1)^{S(N-1)+1}}\end{align}</p><p id='eq-tts-likelihood' class='anchor'>eq-tts-likelihood</p><h4 id="总结">总结<a class="header-anchor" href="#总结">¶</a></h4><p>在常数泊松分布模型下，不同数据情况下的似然度仅取决于时间区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 的长度（以刻度数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> 表示）和区间内的事例数目 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>，因此可以写成：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\mathscr{L}(\m…'>\begin{align}\mathscr{L}(\mathscr{M}_1|D) = \phi_D(N,M)\end{align}</p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">M</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\mathscr{M}_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 代表常数泊松分布模型。不同 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span> 情况下的似然函数由式 (<a href='#eq-tte-likelihood'>eq-tte-likelihood</a>), (<a href='#eq-bin-likelihood'>eq-bin-likelihood</a>), (<a href='#eq-tts-likelihood'>eq-tts-likelihood</a>) 给出：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\phi_\mathrm{T…'>\begin{align}\phi_\mathrm{TTE} &amp;= \frac{\Gamma(N+1)\Gamma(M-N+1)}{\Gamma(M+2)} = \frac{N!(M-N)!}{(M+1)!} \\\phi_\mathrm{BIN} &amp;= \frac{\Gamma(N+1)}{(M+1)^{N+1}} \\\phi_\mathrm{TTS} &amp;= \frac{\left(\prod_{n=1}^{N-1}\tau_n\right)^{S-1}}{\Gamma(S)^{N-1}}\frac{\Gamma[S(N-1)+1]}{(M+1)^{S(N-1)+1}}\end{align}</p><h3 id="分段常数泊松分布模型">分段常数泊松分布模型<a class="header-anchor" href="#分段常数泊松分布模型">¶</a></h3><p>在未分段的常数泊松分布模型上改进，将整个时间区间分为若干子区间，每一个子区间内都是恒定的泊松分布模型。考虑最简单的二分段模型，可以使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">M</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi mathvariant="normal">Λ</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi mathvariant="normal">Λ</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>t</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathscr{M}_2(\Lambda_1,\Lambda_2,t_\mathrm{cp})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathscr" style="margin-right:0.15981em;">M</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord">Λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord">Λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 表示，该模型可以表示为两个简单模型的复合：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\mathscr{M}_2(…'>\begin{align}\mathscr{M}_2(\Lambda_1,\Lambda_2,t_\mathrm{cp}) = \mathscr{M}_1(\Lambda_1,M_1)\otimes\mathscr{M}_1(\Lambda_2,M_2)\end{align}</p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_\mathrm{cp}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 表示两段的分割点（Change Point），在该点处泊松分布的参数从 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Λ</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\Lambda_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord">Λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 改变为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Λ</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\Lambda_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord">Λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，前后两段的计数分别为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">N_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">N_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，长度分别为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">M_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">M_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。由于前后两个过程是独立的，因此复合模型的概率可以表示为两个子模型的乘积：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲P[D|\mathscr{M…'>\begin{align}P[D|\mathscr{M}_2(\Lambda_1,\Lambda_2,t_\mathrm{cp})] = P[D_1|\mathscr{M}_1(\Lambda_1,M_1)]\times P[D_2|\mathscr{M}_1(\Lambda_2,M_2)]\end{align}</p><p>进而可得到全局似然函数：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}\…'>\begin{equation}\begin{split}\mathscr{L}(\mathscr{M}_2|D) = &amp;\int\mathrm{d}t_\mathrm{cp}\int\mathrm{d}\Lambda_1\int\mathrm{d}\Lambda_2 P_\mathrm{cp}(t_\mathrm{cp}) \\&amp;\times P[D_1|\mathscr{M}_1(\Lambda_1,M_1)]P_\Lambda(\Lambda_1|\mathscr{M}_1) \\&amp;\times P[D_2|\mathscr{M}_1(\Lambda_2,M_2)]P_\Lambda(\Lambda_2|\mathscr{M}_1)\end{split}\end{equation}</p><p>积分后的表达式应当与参数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Λ</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\Lambda_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord">Λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Λ</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\Lambda_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord">Λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_\mathrm{cp}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 无关。两个子模型之间应当是无关的，因此可分离变量为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\psi(t_\mathrm…'>\begin{align}\psi(t_\mathrm{cp}) = \phi(N_1,M_1)\phi(N_2,M_2) \\\mathscr{L}(\mathscr{M}_2|D) = \int P_\mathrm{cp}(t_\mathrm{cp})\psi(t_\mathrm{cp})\mathrm{d}t_\mathrm{cp}\end{align}</p><p>实际上各种数据中时间点都是离散的，因此 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">d</mi><msub><mi>t</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{d}t_\mathrm{cp}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 的积分可以使用求和代替。考虑 TTE 情况下的数据，可以使用时间刻度来表示分割点。在没有事例记录的时间点进行分割是没有意义的，因此分割点应当在式 (<a href='#eq-tte-2'>eq-tte-2</a>) 表示的数据点中，使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi></mrow></msub><mo>=</mo><msub><mi>m</mi><msub><mi>n</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi></mrow></msub></msub></mrow><annotation encoding="application/x-tex">m_\mathrm{cp} = m_{n_\mathrm{cp}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7778799999999999em;vertical-align:-0.34731999999999996em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285716em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34731999999999996em;"><span></span></span></span></span></span></span></span></span></span> 表示，则有：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}N…'>\begin{equation}\begin{split}N_1 &amp;= n_\mathrm{cp} \\N_2 &amp;= N - N_1 \\M_1 &amp;= m_\mathrm{cp} \\M_2 &amp;= M - M_1\end{split}\end{equation}</p><p>设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">m_\mathrm{cp}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 的先验分布为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲P(m_\mathrm{cp…'>\begin{align}P(m_\mathrm{cp}|\mathscr{M}_2) = \begin{cases}\frac{1}{N}, m_\mathrm{cp}\in D_\mathrm{TTE} \\0, \mathrm{otherwise}\end{cases}\end{align}</p><p>则似然函数可以表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\psi(n_\mathrm…'>\begin{align}\psi(n_\mathrm{cp}) &amp;= \phi(N_1,M_1)\phi(N_2,M_2)\\\mathscr{L}(\mathscr{M}_2|D) &amp;= \frac{1}{N}\sum\limits_{n_\mathrm{cp}=1}^N\psi(n_\mathrm{cp})\Delta t_{n_\mathrm{cp}}\end{align}</p><p id='eq-piecewise-psi' class='anchor'>eq-piecewise-psi</p><p id='eq-piecewise-likelihood' class='anchor'>eq-piecewise-likelihood</p><p>式 (<a href='#eq-piecewise-likelihood'>eq-piecewise-likelihood</a>) 前的常数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mi>N</mi></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{N}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 可忽略，而 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><msub><mi>t</mi><msub><mi>n</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi></mrow></msub></msub></mrow><annotation encoding="application/x-tex">\Delta t_{n_\mathrm{cp}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.03065em;vertical-align:-0.34731999999999996em;"></span><span class="mord">Δ</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285716em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34731999999999996em;"><span></span></span></span></span></span></span></span></span></span> 是相邻两个事例间的时间间隔，一般而言是一个可忽略的小修正项。</p><h3 id="分块数目">分块数目<a class="header-anchor" href="#分块数目">¶</a></h3><p>根据式 (<a href='#eq-odds-ratio'>eq-odds-ratio</a>) 有：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\mathscr{O}_{2…'>\begin{align}\mathscr{O}_{21} = \frac{J(\mathscr{M}_2|D)}{J(\mathscr{M}_1|D)} = \rho\frac{\mathscr{L}(\mathscr{M}_2|D)}{\mathscr{L}(\mathscr{M}_1|D)}\end{align}</p><p>当先验概率比值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\rho=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ρ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 时，该比值被称为贝叶斯因子（Bayes Factor，BF）。如果分段模型更占优，则由式 (<a href='#eq-piecewise-psi'>eq-piecewise-psi</a>) 计算最可能的分段点的位置，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Λ</mi></mrow><annotation encoding="application/x-tex">\Lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Λ</span></span></span></span> 的最可几取值可由式 (<a href='#eq-tte-lambda-max-1'>eq-tte-lambda-max-1</a>)，(<a href='#eq-tte-lambda-max-2'>eq-tte-lambda-max-2</a>)，(<a href='#eq-bin-lambda-max'>eq-bin-lambda-max</a>)，(<a href='#eq-tts-lambda-max'>eq-tts-lambda-max</a>) 确定。对于具有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> 个分割点的模型，可以逐一求解分割点位置，也可以使用迭代的方法进行近似计算。</p><p>迭代方法对整体区间分为两段，如果 BF 更支持分段模型，则对分段后的子区间继续同样的过程，该方法得到的分段方案与直接计算得到的方案十分接近。结束条件可以是所有的子区间 BF 都更支持不分段模型，但是大量的数据显示绝大部分的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">O</mi><mn>21</mn></msub></mrow><annotation encoding="application/x-tex">\mathscr{O}_{21}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathscr" style="margin-right:0.08078em;">O</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 都比 1 大一点，因此会存在区间划分过细的问题。</p><p>一个方法是设置子区间允许的最小事例数目以保持良好的统计性，当事例数目达到或小于这一设定值时不再进行分段；另一种方案是改变模型的先验概率值使其更倾向于不分段的模型，即调整 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">O</mi><mn>21</mn></msub></mrow><annotation encoding="application/x-tex">\mathscr{O}_{21}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathscr" style="margin-right:0.08078em;">O</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding="application/x-tex">\rho</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ρ</span></span></span></span> 的大小。</p><h2 id="DP-算法">DP 算法<a class="header-anchor" href="#DP-算法">¶</a></h2><h3 id="块评价函数">块评价函数<a class="header-anchor" href="#块评价函数">¶</a></h3><p>块评价函数用于评价划分出的块的优劣，以此为基础解决分块的最优化问题。贝叶斯块算法要求块评价函数具有可加性（block-additive），即分组的整体评价是各个块的评价函数值之和。对于某个块评价函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msub><mi>B</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(B_k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 和某种分组 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>，分组的整体评价为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲F(P)=\sum\limi…'>\begin{align}F(P)=\sum\limits_{k=1}^{N_\mathrm{b}}f(B_k)\end{align}</p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">B_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ​代表第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个块，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi mathvariant="normal">b</mi></msub></mrow><annotation encoding="application/x-tex">N_\mathrm{b}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为分组 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> 中分块的数目。特定的分组方式被记为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_\mathrm{cps}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span> 表示前 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个数据点的分组方式。贝叶斯块算法的目标是选取恰当的分组方式，使得整体评价最优，可以表示为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲\max\limits_{\…'>\begin{align}\max\limits_{\mathrm{cps}}F(P_\mathrm{cps})\end{align}</p><h3 id="实现步骤">实现步骤<a class="header-anchor" href="#实现步骤">¶</a></h3><p>假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi></mrow></msub><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_\mathrm{opt}(k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span> 为前 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个点的最佳分组，根据 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi></mrow></msub><mo stretchy="false">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_\mathrm{opt}(k+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> 的定义，其最后一个块的右边界一定为第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 个点。定义 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> 满足 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi></mrow></msub><mo stretchy="false">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_\mathrm{opt}(k+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> 的最后一个块的左边界为第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> 个点，则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> 共有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 种可能，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">1,2,\dots,k+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，最后一个块的评价表示为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span>。</p><p>可以证明对于所有以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> 为最后一个块的左边界的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(k+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> 分组的集合，仅有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi></mrow></msub><mo stretchy="false">(</mo><mi>r</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_\mathrm{opt}(r-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> 与这最后一个块组成的方案才可能为最佳分组：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲F[P_\mathrm{cp…'>\begin{align}F[P_\mathrm{cps}(r-1)] &amp;\le F[P_\mathrm{opt}(r-1)] \nonumber \\F[P_\mathrm{cps}(r-1)] + f(r) &amp;\le F[P_\mathrm{opt}(r-1)] + f(r)\end{align}</p><p>由于块评价函数具有可加性，因此:</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: equation at position 7: \begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\begin{split}F…'>\begin{equation}\begin{split}F[P^r(k+1)] = f(r) + \begin{cases}0 &amp;; r=1\crF[P_\mathrm{opt}(r-1)] &amp;; r=2,3,...,R+1\end{cases}\end{split}\end{equation}</p><p>​当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">r=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 时，所有数据点都在同一个块中，不存在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">r-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 对应的块评价函数。遍历 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 种 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> 的取值可能，然后取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">r_\mathrm{opt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 满足：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲r_\mathrm{opt}…'>\begin{align}r_\mathrm{opt}=\mathop{\mathrm{argmax}}\limits_{r}F[P^r(k+1)]\end{align}</p><p>结合 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi></mrow></msub><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_\mathrm{opt}(r_\mathrm{opt}-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> 可得 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi></mrow></msub><mo stretchy="false">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_\mathrm{opt}(k+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>，进而得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi></mrow></msub><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>k</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">P_\mathrm{opt}(k), k=1,2,\dots,N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>，最优的分组方案即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi></mrow></msub><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_\mathrm{opt}(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>。</p><h3 id="分块数目-v2">分块数目<a class="header-anchor" href="#分块数目-v2">¶</a></h3><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi mathvariant="normal">b</mi></msub></mrow><annotation encoding="application/x-tex">N_\mathrm{b}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的先验分布，如：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲P(N_\mathrm{b}…'>\begin{align}P(N_\mathrm{b}) = P_0\gamma^{N_\mathrm{b}}\end{align}</p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>≤</mo><msub><mi>N</mi><mi mathvariant="normal">b</mi></msub><mo>≤</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">0 \le N_\mathrm{b} \le N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.78041em;vertical-align:-0.13597em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>≤</mo><mi>γ</mi><mo>≤</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0 \le \gamma \le 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.78041em;vertical-align:-0.13597em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8304100000000001em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 是唯一的参数，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">P_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mi>N</mi><mi mathvariant="normal">b</mi></msub><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{N_\mathrm{b}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.03333em;vertical-align:-0.15em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span> 可以计算得出：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲P_0 &amp;= \frac{1…'>\begin{align}P_0 &amp;= \frac{1 - \gamma}{1 - \gamma^{N+1}} \\\overline{N_\mathrm{b}} &amp;= \frac{N\gamma^{N+1}+1}{\gamma^{N+1}-1}+\frac{1}{1-\gamma}\end{align}</p><p>定义误报率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">p_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为，正确率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">p_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为：</p><p class='katex-block katex-error' title='ParseError: KaTeX parse error: No such environment: align at position 7: \begin{̲a̲l̲i̲g̲n̲}̲p_0 \equiv 1 -…'>\begin{align}p_0 \equiv 1 - p_1\end{align}</p><div class="note warning flat"><p>未完待续</p></div><h2 id="参考资料">参考资料<a class="header-anchor" href="#参考资料">¶</a></h2><ol><li><span id="refer-1">Scargle J D. Studies in astronomical time series analysis. V. Bayesian blocks, a new method to analyze structure in photon counting data[J]. The Astrophysical Journal, 1998, 504(1): 405.</span></li><li><span id="refer-2">Scargle J D, Norris J P, Jackson B, et al. Studies in astronomical time series analysis. VI. Bayesian Block representations[J]. The Astrophysical Journal, 2013, 764(2): 167.</span></li><li><a href="https://docs.astropy.org/en/stable/api/astropy.stats.bayesian_blocks.html#bayesian-blocks">bayesian_blocks</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;script defer src=&quot;https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js&quot;&gt;&lt;/script&gt;
&lt;script defer src=&quot;https://cdn.jsdelivr.net/npm/ka</summary>
      
    
    
    
    <category term="学习笔记" scheme="https://foolishfox.cn/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Python" scheme="https://foolishfox.cn/tags/Python/"/>
    
    <category term="核技术" scheme="https://foolishfox.cn/tags/%E6%A0%B8%E6%8A%80%E6%9C%AF/"/>
    
    <category term="贝叶斯分析" scheme="https://foolishfox.cn/tags/%E8%B4%9D%E5%8F%B6%E6%96%AF%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>使用 wine 安装 SRIM</title>
    <link href="https://foolishfox.cn/posts/202310-wine-srim.html"/>
    <id>https://foolishfox.cn/posts/202310-wine-srim.html</id>
    <published>2023-10-11T14:11:09.000Z</published>
    <updated>2023-10-14T08:56:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言<a class="header-anchor" href="#前言">¶</a></h2><p>SRIM 是一个 Windows 平台上用于计算带电粒子能损的软件包，典型的应用包括计算入射离子在靶材中的射程和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>E</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">dE/dx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span> 能损曲线等。由于这是一个单字节程序，因此在中文系统中会存在显示问题，可以通过更改系统的区域和语言为美国/英语重启之后解决<sup>[2]</sup>，但是会很麻烦，而且可能导致其他软件出现问题（例如部分软件可能读取到错误的区域），如下图所示。</p><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2023/10/12/6526c9256b3e9.png" alt="错误显示的 SRIM" style="height:200px;"/></div><span class="image-caption">错误显示的 SRIM</span></div><p>为了解决这个问题，我们可以选择在 WSL 上安装 wine，通过 wine 来调用 SRIM。请注意，此处需要 WSL 更新到最新版本以支持 <a href="https://learn.microsoft.com/zh-cn/windows/wsl/tutorials/gui-apps">WSLG</a>。</p><div class="note info flat"><p><strong>本机环境</strong><br>WSL: 1.2.5.0<br>WSLg: 1.0.51<br>Ubuntu: 20.04.6<br>wine: 8.0.2</p></div><h2 id="wine">wine<a class="header-anchor" href="#wine">¶</a></h2><p>wine 目前最新稳定版本更新至 8.0.2，但是 ubuntu 自带的软件源中仍为 5.0 版本。可以根据需要自行选择安装版本。</p><h3 id="wine-5-0">wine 5.0<a class="header-anchor" href="#wine-5-0">¶</a></h3><ol><li>更新与安装 wine。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt install wine -y</span><br></pre></td></tr></table></figure><ol start="2"><li>检查 wine32 是否安装，如果没有则另外安装。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg --add-architecture i386</span><br><span class="line">sudo apt update &amp;&amp; sudo apt install wine32 -y</span><br></pre></td></tr></table></figure><ol start="3"><li>配置 Windows 10 环境。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winecfg</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2023/10/12/6527510b561c9.png" alt="wine 配置" style="height:300px;"/></div><span class="image-caption">wine 配置</span></div><h3 id="wine-8-0">wine 8.0<a class="header-anchor" href="#wine-8-0">¶</a></h3><p>ubuntu 提供的 wine 已经落后了好几个版本，所以可以通过 WineHQ 自己的储存库安装较新版本的 wine。WineHQ 存储库仅提供适用于 AMD64 和 i386 的软件包，如果需要 ARM 版本，可以使用 Ubuntu 软件包。<sup>[4]</sup></p><ol><li>开启 32 位支持。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg --add-architecture i386 </span><br></pre></td></tr></table></figure><ol start="2"><li>下载并添加仓库密钥，随后添加仓库并更新。<sup>[5]</sup></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo wget -nc -O /usr/share/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key</span><br><span class="line">sudo su</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=amd64,i386 signed-by=/usr/share/keyrings/winehq-archive.key] https://mirrors.tuna.tsinghua.edu.cn/wine-builds/ubuntu/ focal main&quot;</span> &gt;&gt; /etc/apt/sources.list.d/winehq.list</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><ol start="3"><li>安装 wine 8.0。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Stable</span></span><br><span class="line">sudo apt install --install-recommends winehq-stable</span><br><span class="line"><span class="comment"># Develop</span></span><br><span class="line">sudo apt install --install-recommends winehq-devel</span><br></pre></td></tr></table></figure><ol start="4"><li>按照 5.0 中的设置选择 Windows 10。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winecfg</span><br></pre></td></tr></table></figure><h2 id="SRIM">SRIM<a class="header-anchor" href="#SRIM">¶</a></h2><h3 id="SRIM-2008-与-2013">SRIM 2008 与 2013<a class="header-anchor" href="#SRIM-2008-与-2013">¶</a></h3><p>直接安装 SRIM 2013 会提示组件缺失，而按照官方教程去安装组件较为繁琐，而且可能失败。因此一个取巧的方法是先安装 SRIM 2008，这一版本的 SRIM 附带有自动安装程序，完成后卸载 2008 版本并<strong>保留相关组件</strong>，随后再安装 SRIM 2013。两个版本的下载地址如下：</p><ul><li><a href="http://www.srim.org/SRIM/SRIM-2008.e">SRIM 2008</a></li><li><a href="http://www.srim.org/SRIM/SRIM-2013-Std.e">SRIM 2013</a></li></ul><p>下载完成之后，我们需要将其后缀名从 <code>e</code> 改为 <code>exe</code>，方便后续操作。</p><h3 id="SRIM-2008-的安装">SRIM 2008 的安装<a class="header-anchor" href="#SRIM-2008-的安装">¶</a></h3><ol><li>创建临时目录，下载安装包并运行命令提取安装包中的文件到目录中。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> srim08 &amp;&amp; <span class="built_in">cd</span> ~/srim08</span><br><span class="line">wget http://www.srim.org/SRIM/SRIM-2008.e</span><br><span class="line"><span class="built_in">mv</span> SRIM-2008.e SRIM-2008.exe</span><br><span class="line">wine SRIM-2008.exe</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2023/10/12/652754583809a.png" alt="提取 SRIM-2008 文件" style="height:200px;"/></div><span class="image-caption">提取 SRIM-2008 文件</span></div><ol start="2"><li>运行 <code>SETUP.exe</code> 进行安装，安装位置可以随意填写，例如 <code>~/.wine/drive_c/Program\ Files/SRIM</code>。如果提示图标安装失败，选择 <code>Ignore</code> 即可。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wine SETUP.exe</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2023/10/12/65277122f2257.png" alt="设置安装路径" style="height:200px;"/></div><span class="image-caption">设置安装路径</span></div><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2023/10/12/6527850161c98.png" alt="忽略错误" style="height:100px;"/></div><span class="image-caption">忽略错误</span></div><ol start="3"><li>检查组件是否安装到位，在 <code>~/.wine/drive_c/windows/syswow64</code> 目录中应当存在 4 个 <code>OCX</code> 文件。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/srim08 ❯ <span class="built_in">ls</span> ~/.wine/drive_c/windows/syswow64 | rg OCX</span><br><span class="line">.rw-r--r--   594Ki fox  fox   23 May  2000  COMCTL32.OCX</span><br><span class="line">.rw-r--r--   137Ki fox  fox   23 May  2000  COMDLG32.OCX</span><br><span class="line">.rw-r--r--   207Ki fox  fox   10 Mar  2004  RICHTX32.OCX</span><br><span class="line">.rw-r--r--   204Ki fox  fox   31 Aug  2001  TABCTL32.OCX</span><br></pre></td></tr></table></figure><ol start="4"><li>卸载 SRIM 2008。运行命令打开管理器，选中 SRIM 进行卸载。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wine uninstaller</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2023/10/12/652785737369d.png" alt="移除 SRIM 2008" style="height:200px;"/></div><span class="image-caption">移除 SRIM 2008</span></div><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2023/10/12/652786600379c.png" alt="保留组件" style="height:200px;"/></div><span class="image-caption">保留组件</span></div><h3 id="SRIM-2013-的安装与配置">SRIM 2013 的安装与配置<a class="header-anchor" href="#SRIM-2013-的安装与配置">¶</a></h3><ol><li>创建临时目录，下载安装包并运行命令提取安装包中的文件到目录中。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> srim13 &amp;&amp; <span class="built_in">cd</span> ~/srim13</span><br><span class="line">wget http://www.srim.org/SRIM/SRIM-2013-Std.e</span><br><span class="line"><span class="built_in">mv</span> SRIM-2013-Std.e SRIM-2013-Std.exe</span><br><span class="line">wine SRIM-2013-Std.exe</span><br></pre></td></tr></table></figure><ol start="2"><li>测试能否正常运行。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wine SRIM.exe</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2023/10/12/6527870506f8a.jpg" alt="SRIM 2013" style="height:200px;"/></div><span class="image-caption">SRIM 2013</span></div><ol start="3"><li>在 <code>.zshrc</code> （或者 <code>.bashrc</code>） 中添加指令。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias srim=&quot;wine ~/srim13/SRIM.exe&quot;</span><br></pre></td></tr></table></figure><h2 id="问题">问题<a class="header-anchor" href="#问题">¶</a></h2><ol><li>提示 <code>sh: 1: xdg-open: not found</code>，安装 <code>xdg-utils</code> <sup><a href="#参考资料">[6]</a></sup></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install xdg-utils</span><br></pre></td></tr></table></figure><h2 id="参考资料">参考资料<a class="header-anchor" href="#参考资料">¶</a></h2><ol><li><a href="https://blog.csdn.net/m0_37921318/article/details/115915223">Linux虚拟机用wine安装仿真软件SRIM</a></li><li><a href="https://blog.csdn.net/ytzlln/article/details/82870037">【离子注入】TRIM2013pro仿真卡屏解决方法（win10）</a></li><li><a href="https://appdb.winehq.org/objectManager.php?sClass=version&amp;iId=13202">SRIM - wineHQ</a></li><li><a href="https://wiki.winehq.org/Ubuntu_zhcn">Ubuntu - wineHQ</a></li><li><a href="https://mirrors-i.tuna.tsinghua.edu.cn/help/wine-builds/">Wine builds 软件仓库镜像使用帮助</a></li><li><a href="https://askubuntu.com/questions/704712/in-ubuntu-xdg-open-command-is-not-working">In Ubuntu, xdg-open command is not working</a></li></ol><!-- 6. [Wine Mono 环境安装并运行.Net WPF](https://blog.csdn.net/x740073529/article/details/119461344)7. [[分享]终于解决了wine慢的问题](https://forum.ubuntu.com.cn/viewtopic.php?t=18727) -->]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;a class=&quot;header-anchor&quot; href=&quot;#前言&quot;&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;SRIM 是一个 Windows 平台上用于计算带电粒子能损的软件包，典型的应用包括计算入射离子在靶材中的射程和 &lt;span class=&quot;katex&quot;</summary>
      
    
    
    
    <category term="软件/程序" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/"/>
    
    
    <category term="教程" scheme="https://foolishfox.cn/tags/%E6%95%99%E7%A8%8B/"/>
    
    <category term="核技术" scheme="https://foolishfox.cn/tags/%E6%A0%B8%E6%8A%80%E6%9C%AF/"/>
    
    <category term="SRIM" scheme="https://foolishfox.cn/tags/SRIM/"/>
    
  </entry>
  
  <entry>
    <title>CERN ROOT 的 Jupyter 环境</title>
    <link href="https://foolishfox.cn/posts/202309-root-jupyter.html"/>
    <id>https://foolishfox.cn/posts/202309-root-jupyter.html</id>
    <published>2023-09-20T01:48:56.000Z</published>
    <updated>2023-10-17T02:26:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言<a class="header-anchor" href="#前言">¶</a></h2><p>ROOT 是由 CERN 开发的用于实验大数据处理的框架，主要应用于核物理和高能物理领域。ROOT 主要由 C++ 编写，但较新版本中也提供了 Python 的借口，通过引入<code>pyroot</code>实现。</p><p>一般而言，通常在命令行输入<code>root</code>后，通过<code>TBrowser</code>浏览文件；或者使用 C++ 编写数据处理的函数，在 ROOT 中进行调用。而使用 Jupyter 来编写 ROOT 程序在学习和开发阶段较为便利。由于预编译版本的 ROOT 已经绑定了特定 Python 版本，有可能与本机的 Python 版本不匹配，所以通过源代码编译安装的方式能够避免绝大部分的兼容性问题。</p><h2 id="安装">安装<a class="header-anchor" href="#安装">¶</a></h2><div class="note info flat"><p><strong>本机环境</strong><br>Ubuntu 20.04.6<br>Python 3.10.11</p></div><p>目前 ROOT 的最新版本为 6.28，但为了兼容本机上的 Garfield Plus Plus，因此选择 6.26 版本。在 <a href="https://root.cern/install/all_releases/">ROOT Releases</a> 页面下载对应版本的安装包。</p><h3 id="依赖">依赖<a class="header-anchor" href="#依赖">¶</a></h3><p>在 <a href="https://root.cern/install/dependencies">ROOT Install Dependencies</a> 查看对应系统版本要求的依赖，对于 Ubuntu 使用一行命令解决必备依赖：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install dpkg-dev cmake g++ gcc binutils libx11-dev libxpm-dev \</span><br><span class="line">libxft-dev libxext-dev python libssl-dev</span><br></pre></td></tr></table></figure><p>其余推荐依赖按照需求进行安装，我只需要 ROOT 的基础功能，因此没有安装其他依赖，在后续编译过程中可以设置部分编译选项加快速度。此外推荐安装 <code>ccmake</code> 方便后续编译。</p><h3 id="编译">编译<a class="header-anchor" href="#编译">¶</a></h3><p>解压下载好的安装包，新建与安装包同级的目录 <code>build</code>，进入目录后进行编译安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf root_v6.26.10.source.tar.gz</span><br><span class="line"><span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">cmake -DCMAKE_INSTALL_PREFIX=<span class="variable">$INSTALL_PREFIX</span> -DCMAKE_CXX_STANDARD=17 -DCXX_STANDARD_STRING=17 -Ddavix=OFF -Dfftw3=OFF -Dgdml=OFF -Dgfal=OFF -Dmysql=OFF -Doracle=OFF -Dpgsql=OFF -Dpythia6=OFF -Dpythia8=OFF -Dxml=OFF -Dbuiltin_zstd=ON -Dbuiltin_glew=ON -Dbuiltin_gl2ps=ON -Dbuiltin_xrootd=ON -Dbuiltin_ftgl=ON ../root-6.26.10</span><br><span class="line">ccmake .</span><br></pre></td></tr></table></figure><p><code>$INSTALL_PREFIX</code>是需要安装到的目录，<code>CMAKE_CXX_STANDARD</code>根据自己的 gcc 版本和需要来选择，可以通过以下命令查看：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; gcc -E -dM - &lt;/dev/null | grep <span class="string">&quot;STDC_VERSION&quot;</span></span><br><span class="line"><span class="comment">#define __STDC_VERSION__ 201710L</span></span><br></pre></td></tr></table></figure><p><code>2017</code> 代表支持 c17 标准。<code>ccmake</code> 可以生成一个在命令行的简略界面方便我们对编译选项进行调整。调整完成后根据下方的提示操作，多次按<code>c</code>进行确认直至出现<code>Press [g] ... </code>的提示，此时可以按<code>g</code>生成相关文件，随后进行编译安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j 12</span><br><span class="line">make install -j 12</span><br></pre></td></tr></table></figure><p><code>-j</code>参数后面是使用的线程数，我的计算机有8核16线程，16GB内存。不推荐使用全部线程，因为编译会占用很大内存，可能会导致编译失败，可以根据线程数和内存大小酌情调整。最后修改自己的 shell 配置文件（例如<code>.bashrc</code>，<code>.zshrc</code>），在适当位置添加：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> <span class="variable">$INSTALL_PREFIX</span>/bin/thisroot.sh</span><br></pre></td></tr></table></figure><h3 id="添加内核">添加内核<a class="header-anchor" href="#添加内核">¶</a></h3><p>使用下列命令安装 Python 所需的包：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install jupyter metakernel</span><br></pre></td></tr></table></figure><p>安装后有两种方式可以在 Jupyter 中使用 ROOT：</p><ol><li>ROOT-flavored 的 notebook</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root --notebook</span><br></pre></td></tr></table></figure><ol start="2"><li>全功能的 Jupyter Lab（<strong>推荐</strong>）</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp -r $INSTALL_PREFIX/etc/notebook/kernels/root ~/.local/share/jupyter/kernels</span><br><span class="line">jupyter lab</span><br></pre></td></tr></table></figure><p>关于 Jupyter Lab 的相关配置，可以查看 <a href="/posts/202112-pyr_jupyter.html#%E6%9C%8D%E5%8A%A1%E4%B8%8E%E6%8F%92%E4%BB%B6">服务与插件</a>。</p><h3 id="试用">试用<a class="header-anchor" href="#试用">¶</a></h3><p>一个在 Jupyter ROOT Block 中绘制直方图的示例：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TCanvas c;</span><br><span class="line"><span class="function">TH1F <span class="title">h</span><span class="params">(<span class="string">&quot;h&quot;</span>,<span class="string">&quot;ROOT Histo;X;Y&quot;</span>,<span class="number">64</span>,<span class="number">-4</span>,<span class="number">4</span>)</span></span>;</span><br><span class="line">h.<span class="built_in">FillRandom</span>(<span class="string">&quot;gaus&quot;</span>);</span><br><span class="line">h.<span class="built_in">Draw</span>();</span><br><span class="line">c.<span class="built_in">Draw</span>();</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2023/09/20/650a62246e7d6.png" alt="效果图"/></div><span class="image-caption">效果图</span></div><h2 id="问题">问题<a class="header-anchor" href="#问题">¶</a></h2><ol><li>WSL 中使用 <code>new TBrowser</code> 将会开启 HTTP 服务而不是窗口<sup><a href="#参考资料">[3]</a></sup><br>在家目录（例如 <code>/home/fox</code>）下创建 <code>.rootrc</code> 文件并写入：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Browser.Name: TRootBrowser</span><br></pre></td></tr></table></figure><ol start="2"><li>ROOT 6.28 版本以下使用 Python 3.11 及以上版本编译安装时报错<sup><a href="#参考资料">[4,5,6]</a></sup></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[.....]/CPPOverload.cxx:<span class="number">5</span>:<span class="number">10</span>: fatal error: <span class="string">&#x27;code.h&#x27;</span> file not found</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;code.h&quot;</span> <span class="comment">// from Python</span></span></span><br><span class="line">^~~~~~~~</span><br></pre></td></tr></table></figure><p>修改 <code>CPPOverload.cxx</code> 文件，将原本的内容：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> PY_VERSION_HEX &gt;= 0x02050000</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;code.h&quot;</span>            <span class="comment">// from Python</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;compile.h&quot;</span>         <span class="comment">// from Python</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>修改为：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> PY_VERSION_HEX &lt; 0x02050000</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;compile.h&quot;</span>         <span class="comment">// from Python</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> PY_VERSION_HEX &lt; 0x030b0000</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;code.h&quot;</span>            <span class="comment">// from Python</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>这是因为 Python 3.11 及以上版本将其移动到了 <code>Include/cpython</code> 中，已经被 <code>Python.h</code> 包含。</p><h2 id="参考资料">参考资料<a class="header-anchor" href="#参考资料">¶</a></h2><ol><li><a href="https://root.cern/install/build_from_source">Building ROOT from source</a></li><li><a href="https://github.com/root-project/root/tree/master/bindings/jupyroot">JupyROOT</a></li><li><a href="https://root-forum.cern.ch/t/tbrowser-wsl-starts-in-the-web-browser/45243">TBrowser WSL starts in the web browser</a></li><li><a href="https://root-forum.cern.ch/t/include-code-h-and-python-3-11/52425">Include “code.h” and Python 3.11</a></li><li><a href="https://github.com/root-project/root/pull/12501">[v6-24][PyROOT] code.h must not be included directly in 3.11</a></li><li><a href="https://docs.python.org/3.11/whatsnew/3.11.html">What’s New In Python 3.11</a></li><li><a href="https://root.cern.ch/notebooks/HowTos/HowTo_ROOT-Notebooks.html">How to use ROOT in a Jupyter notebook</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;a class=&quot;header-anchor&quot; href=&quot;#前言&quot;&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;ROOT 是由 CERN 开发的用于实验大数据处理的框架，主要应用于核物理和高能物理领域。ROOT 主要由 C++ 编写，但较新版本中也提供了 Pyth</summary>
      
    
    
    
    <category term="软件/程序" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/"/>
    
    <category term="Jupyter" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/Jupyter/"/>
    
    <category term="ROOT" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/ROOT/"/>
    
    
    <category term="教程" scheme="https://foolishfox.cn/tags/%E6%95%99%E7%A8%8B/"/>
    
    <category term="核技术" scheme="https://foolishfox.cn/tags/%E6%A0%B8%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ROOT" scheme="https://foolishfox.cn/tags/ROOT/"/>
    
    <category term="Jupyter" scheme="https://foolishfox.cn/tags/Jupyter/"/>
    
  </entry>
  
  <entry>
    <title>博客成长日志 | 自建 Umami 统计</title>
    <link href="https://foolishfox.cn/posts/202209-umami.html"/>
    <id>https://foolishfox.cn/posts/202209-umami.html</id>
    <published>2022-09-28T08:46:25.000Z</published>
    <updated>2024-01-23T13:10:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>在一年多之前，我写了一篇博客（<a href="/posts/202105-visit.html">博客成长日志 | 准实时访问统计</a>）介绍如何使用百度统计的API实现准实时的访问统计与展示。然而今年百度统计宣布个人版只允许保存一年的数据，而且很多功能会被关闭（例如OS统计等），再加上其API使用也不方便，因此我开始谋求其他的站点统计系统。</p><p>与百度统计同类型的竞品还有谷歌统计、51La、CNZZ等，但是这些网站与百度统计也或多或少存在类似类似的问题，同时作为个人小站，也不需要收集过于精细的用户信息（如年龄、详细地区等），所以我开始寻找自建的统计工具。</p><span id="more"></span><p>目前常用的一些开源统计工具可以查看：<a href="https://www.imydl.com/wzjs/15065.html">5 款免费开源的网站流量分析统计工具</a>，在这其中<code>Umami</code>和<code>Plausible</code>是我认为不错的选择，再结合枋柚梓的<a href="https://inkss.cn/post/f7886cf2/">自建个人网站数据统计分析系统</a>，最终决定采用<code>Umami</code>。</p><div class="note warning flat"><p><code>Umami</code>也存在问题：</p><ol><li>只记录了 country，无法精确到省份</li><li>地图存在问题，如果使用要避免直接展示地图</li></ol></div><h2 id="介绍">介绍<a class="header-anchor" href="#介绍">¶</a></h2><div class="note quote flat"><p>Umami is an open source, privacy-focused alternative to Google Analytics. Umami provides you with a powerful web analytics solution that does not violate the privacy of your users. Additionally, when you self-host Umami you are in complete control of your data.</p></div><p><code>Umami</code>是一个开源的，关注隐私的谷歌统计替代品，由<code>Nodejs</code>编写，我们可以使用多种方式部署，包括<code>Server</code>自部署、<code>Docker</code>部署以及<code>SeverLess</code>服务部署。</p><p>在本文中，我们会在服务器上直接部署服务，使用<code>MySQL</code>作为数据库。</p><h2 id="安装">安装<a class="header-anchor" href="#安装">¶</a></h2><div class="note info flat"><p>环境要求：</p><ul><li>Nodejs</li><li>yarn</li></ul></div><ol><li>源代码</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/umami-software/umami.git</span><br><span class="line"><span class="built_in">cd</span> umami</span><br><span class="line">yarn install</span><br></pre></td></tr></table></figure><ol start="2"><li>环境变量<br>在目录下创建<code>.env</code>文件，写入内容：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PORT=8000</span><br><span class="line">DATABASE_URL=mysql://username:mypassword@localhost:3306/mydb</span><br></pre></td></tr></table></figure><ol start="3"><li>构建与运行</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn build</span><br><span class="line">yarn start-dev</span><br></pre></td></tr></table></figure><p>随后即可在<code>localhost:8000</code>上打开网页，初始默认用户名为<code>admin</code>，密码为<code>umami</code>。</p><h2 id="统计展示">统计展示<a class="header-anchor" href="#统计展示">¶</a></h2><h3 id="API">API<a class="header-anchor" href="#API">¶</a></h3><p><code>Umami</code>将通过<code>https://&lt;your-umami&gt;/api</code>调用API，并返回json格式的数据。在构建过程中，我们需要使用到以下三个API：</p><ol><li><code>POST /api/auth/login</code><br>通过这个API我们可以获取TOKEN，作为后续API的认证，使用Python获取：</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> request</span><br><span class="line">url = <span class="string">&quot;https://&lt;your-umami&gt;/api/auth/login&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;your-username&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;your-password&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">res = requests.post(url, data=data)</span><br><span class="line">res = json.loads(res.content)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure><ol start="2"><li><p><code>GET /api/website/&#123;id&#125;/pageviews</code><br>通过这个API，我们可以获取选定时段的访问量和访问人数等信息，时间颗粒度可以选择为月、天、小时等。</p></li><li><p><code>GET /api/website/&#123;id&#125;/metrics</code><br>通过这个API，我们可以进一步获取国家/地区、来源等信息。</p></li></ol><p>但是由于以下个原因，我们尽量避免直接使用API：</p><ol><li>保密token：使用API需要将token作为请求header，容易暴露</li><li>地图需要转换：Umami中国家/地区使用二字代码存储，而Echarts需要用到其他格式，需要一步转换</li><li>地图问题：涉及香港、澳门、台湾等地</li></ol><p>因此最终我们可以自建一个API，使用python的<code>FastAPI</code>库，代码如下：</p><details class="toggle" ><summary class="toggle-button" style="color: green">main.py</summary><div class="toggle-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.middleware.cors <span class="keyword">import</span> CORSMiddleware</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line">origins = [</span><br><span class="line">    <span class="string">&quot;http://localhost&quot;</span>,</span><br><span class="line">    <span class="string">&quot;example.com&quot;</span></span><br><span class="line">]</span><br><span class="line">app.add_middleware(</span><br><span class="line">    CORSMiddleware,</span><br><span class="line">    allow_origins=origins,</span><br><span class="line">    allow_credentials=<span class="literal">True</span>,</span><br><span class="line">    allow_methods=[<span class="string">&quot;GET&quot;</span>],</span><br><span class="line">    allow_headers=[<span class="string">&quot;*&quot;</span>],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">root_path = <span class="string">&quot;https://&lt;your-umami&gt;/api/website/1&quot;</span></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">&quot;accept&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">    <span class="string">&quot;authorization&quot;</span>: <span class="string">&quot;Bearer YOUR TOKEN&quot;</span>,</span><br><span class="line">    <span class="string">&quot;content-type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namemap = json.load(<span class="built_in">open</span>(<span class="string">&quot;world.json&quot;</span>, <span class="string">&quot;r&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/day_view&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>(<span class="params">start_at, end_at</span>):</span><br><span class="line">    url = root_path + <span class="string">&quot;/pageviews?start_at=&#123;:d&#125;&amp;end_at=&#123;:d&#125;&amp;unit=day&amp;tz=Asia/Shanghai&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        <span class="built_in">int</span>(start_at),</span><br><span class="line">        <span class="built_in">int</span>(end_at)</span><br><span class="line">    )</span><br><span class="line">    res = requests.get(url, headers=header)</span><br><span class="line">    res = json.loads(res.content)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/month_view&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>(<span class="params">start_at, end_at</span>):</span><br><span class="line">    url = root_path + <span class="string">&quot;/pageviews?start_at=&#123;:d&#125;&amp;end_at=&#123;:d&#125;&amp;unit=month&amp;tz=Asia/Shanghai&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        <span class="built_in">int</span>(start_at),</span><br><span class="line">        <span class="built_in">int</span>(end_at)</span><br><span class="line">    )</span><br><span class="line">    res = requests.get(url, headers=header)</span><br><span class="line">    res = json.loads(res.content)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/referrer&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>(<span class="params">start_at, end_at</span>):</span><br><span class="line">    url = root_path + <span class="string">&quot;/metrics?start_at=&#123;:d&#125;&amp;end_at=&#123;:d&#125;&amp;type=referrer&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        <span class="built_in">int</span>(start_at),</span><br><span class="line">        <span class="built_in">int</span>(end_at)</span><br><span class="line">    )</span><br><span class="line">    res = requests.get(url, headers=header)</span><br><span class="line">    res = json.loads(res.content)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/country&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>(<span class="params">start_at, end_at</span>):</span><br><span class="line">    url = root_path + <span class="string">&quot;/metrics?start_at=&#123;:d&#125;&amp;end_at=&#123;:d&#125;&amp;type=country&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        <span class="built_in">int</span>(start_at),</span><br><span class="line">        <span class="built_in">int</span>(end_at)</span><br><span class="line">    )</span><br><span class="line">    res = requests.get(url, headers=header)</span><br><span class="line">    res = json.loads(res.content)</span><br><span class="line">    ans = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> res:</span><br><span class="line">        name = namemap[item[<span class="string">&quot;x&quot;</span>]]</span><br><span class="line">        ans.append(&#123;</span><br><span class="line">            <span class="string">&quot;x&quot;</span>: name,</span><br><span class="line">            <span class="string">&quot;y&quot;</span>: item[<span class="string">&quot;y&quot;</span>]</span><br><span class="line">        &#125;)</span><br><span class="line">    china = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ans)):</span><br><span class="line">        item = ans[k]</span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">&quot;x&quot;</span>] <span class="keyword">in</span> [<span class="string">&quot;Hong Kong&quot;</span>, <span class="string">&quot;Taiwan&quot;</span>, <span class="string">&quot;Macau&quot;</span>]:</span><br><span class="line">            china += item[<span class="string">&quot;y&quot;</span>]</span><br><span class="line">            <span class="keyword">del</span> ans[k]</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> ans:</span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">&quot;x&quot;</span>] == <span class="string">&quot;China&quot;</span>:</span><br><span class="line">            item[<span class="string">&quot;y&quot;</span>] += china</span><br><span class="line">    <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure></div></details><p>其中<code>world.json</code>是一个用于国家/地区转换的文件，内容如下：</p><details class="toggle" ><summary class="toggle-button" style="color: blue">world.json</summary><div class="toggle-content"><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ES&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Spain&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;DE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Germany&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;IE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ireland&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;IT&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Italy&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AT&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Austria&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;FR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;France&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Belgium&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;FI&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Finland&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;DK&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Denmark&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CZ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Czech Republic&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;EE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Estonia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;HU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hungaryngary&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;JE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jersey&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Luxembourg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LV&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Latvia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MT&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Malta&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;NL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Netherlands&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;PT&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Portugal&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RO&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Romania&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SI&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Slovenia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SK&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Slovakia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;United Arab Emirates&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AF&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Afghanistan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Albania&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AM&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Armenia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AO&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Angola&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Argentina&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Australia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AZ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Azerbaijan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BD&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bangladesh&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BF&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Burkina Faso&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bulgaria&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BH&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bahrein&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BI&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Burundi&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BJ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Benin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Brunei Darussalam&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BO&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bolivia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Brazil&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BW&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Botswana&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Byelorussia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CA&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Canada&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CF&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Central Africa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Congo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CH&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Switzerland&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Chile&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CM&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cameroon&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;China&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CO&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Colombia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Costa Rica&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CS&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Czech Repubic&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cuba&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;CY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cyprus&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;DO&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Dominican Republic&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;DZ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Algeria&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;EC&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ecuador&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;EG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Egypt&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ET&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ethiopia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;FJ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fiji&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;GA&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Gabon&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;GB&quot;</span><span class="punctuation">:</span> <span class="string">&quot;United Kingdom&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;GD&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Grenada&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;GE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Georgia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;GH&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ghana&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;GN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Guinea&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;GR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Greece&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;GT&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Guatemala&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;HK&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hong Kong&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;HN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Honduras&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Indonesia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;IL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Israel&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;IN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;India&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;IQ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Iraq&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;IR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Iran&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;IS&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Iceland&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;JM&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jamaica&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;JO&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jordan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;JP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Japan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;KG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kyrgyzstan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;KH&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cambodia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;KP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Dem. Rep. Korea&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;KR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Korea&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;KT&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ivory Coast&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;KW&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kuwati&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;KZ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kazakhstan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LA&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Laos&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LB&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lebanon&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LC&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Saint Lueia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LI&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Liechtenstein&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LK&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sri Lanka&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Liberia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LT&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lithuania&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Libyan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MA&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Morocco&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MC&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Monaco&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MD&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Moldova&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Madagascar&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ML&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mali&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MM&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Myanmar&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mongolia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MO&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Macau&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mauritius&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MW&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Malawi&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MX&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mexico&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Malaysia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MZ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mozambique&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;NA&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Namibia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;NE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Niger&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;NG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Nigeria&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;NI&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Nicaragua&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;NO&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Norway&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;NP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Nepal&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;NZ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;New Zealand&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;OM&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Oman&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;PA&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Panama&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;PE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Peru&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;PG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Papua New Guinea&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;PH&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Philippines&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;PK&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Pakistan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;PL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Poland&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;PY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Paraguay&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;QA&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Qatar&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Russian Federation&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SA&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Saudi Arabia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SC&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Republic of Seychelles&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SD&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sudan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sweden&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Singapore&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SM&quot;</span><span class="punctuation">:</span> <span class="string">&quot;San Marino&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Senegal&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SO&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Somalia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Syria&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SZ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Swaziland&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TD&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Chad&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Togo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TH&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Thailand&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TJ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tajikistan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TM&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Turkmenistan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tunisia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Turkey&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TW&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Taiwan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TZ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tanzania&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;UA&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ukraine&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;UG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Uganda&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;US&quot;</span><span class="punctuation">:</span> <span class="string">&quot;United States&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;UY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Uruguay&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;UZ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Uzbekistan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;VC&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Saint Vincent&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;VE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Venezuela&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;VN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Viet Nam&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;YE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Yemen&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;YU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Yugoslavia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ZA&quot;</span><span class="punctuation">:</span> <span class="string">&quot;South Africa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ZM&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Zambia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ZR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Zaire&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ZW&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Zimbabwe&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div></details><h3 id="数据显示">数据显示<a class="header-anchor" href="#数据显示">¶</a></h3><p>构建完API后，我们开始改写之前的<code>census.js</code>，内容如下：</p><details class="toggle" ><summary class="toggle-button" style="color: red">census.js</summary><div class="toggle-content"><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 访问日历</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generatePieces</span>(<span class="params">maxValue, colorBox</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> pieces = [];</span><br><span class="line">    <span class="keyword">var</span> quotient = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> temp = &#123;<span class="string">&#x27;lt&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;label&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;color&#x27;</span>: colorBox[<span class="number">0</span>]&#125;;</span><br><span class="line">    pieces.<span class="title function_">push</span>(temp);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (maxValue &amp;&amp; maxValue &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">        quotient = <span class="title class_">Math</span>.<span class="title function_">floor</span>(maxValue / <span class="number">10</span>)+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> temp = &#123;&#125;;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">1</span>)   temp.<span class="property">gte</span> = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span>   temp.<span class="property">gte</span> = quotient * (i - <span class="number">1</span>);</span><br><span class="line">            temp.<span class="property">lte</span> = quotient * i;</span><br><span class="line">            temp.<span class="property">color</span> = colorBox[i];</span><br><span class="line">            pieces.<span class="title function_">push</span>(temp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(pieces);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">append_div_visitcalendar</span>(<span class="params">parent, text</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> text === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> temp = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">            temp.<span class="property">innerHTML</span> = text;</span><br><span class="line">            <span class="keyword">var</span> frag = <span class="variable language_">document</span>.<span class="title function_">createDocumentFragment</span>();</span><br><span class="line">            <span class="keyword">while</span> (temp.<span class="property">firstChild</span>) &#123;</span><br><span class="line">                frag.<span class="title function_">appendChild</span>(temp.<span class="property">firstChild</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            parent.<span class="title function_">appendChild</span>(frag);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            parent.<span class="title function_">appendChild</span>(text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">compareFunction</span>(<span class="params">propertyName</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">o1, o2</span>) &#123;</span><br><span class="line">        <span class="comment">//获取比较的值</span></span><br><span class="line">        <span class="keyword">var</span> v1 = o1[propertyName];</span><br><span class="line">        <span class="keyword">var</span> v2 = o2[propertyName];</span><br><span class="line">        <span class="keyword">return</span> v1 &gt; v2 ? <span class="number">1</span> : (v1 == v2 ? <span class="number">0</span> : -<span class="number">1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">filterTime</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(time)</span><br><span class="line">    <span class="keyword">const</span> Y = date.<span class="title function_">getFullYear</span>()</span><br><span class="line">    <span class="keyword">const</span> M = date.<span class="title function_">getMonth</span>() + <span class="number">1</span> &lt; <span class="number">10</span> ? <span class="string">&#x27;0&#x27;</span> + (date.<span class="title function_">getMonth</span>() + <span class="number">1</span>) : date.<span class="title function_">getMonth</span>() + <span class="number">1</span></span><br><span class="line">    <span class="keyword">const</span> D = date.<span class="title function_">getDate</span>() &lt; <span class="number">10</span> ? <span class="string">&#x27;0&#x27;</span> + (date.<span class="title function_">getDate</span>()) : date.<span class="title function_">getDate</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;Y&#125;</span>-<span class="subst">$&#123;M&#125;</span>-<span class="subst">$&#123;D&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">calChart</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">let</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    date.<span class="title function_">setFullYear</span>(now.<span class="title function_">getFullYear</span>() - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">let</span> start_at = date.<span class="title function_">getTime</span>() - <span class="number">3600</span> * <span class="number">24</span> * ((date.<span class="title function_">getDay</span>() + <span class="number">1</span>) % <span class="number">7</span>);</span><br><span class="line">    <span class="keyword">let</span> end_at = now.<span class="title function_">getTime</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// API根据自己的实际更改</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;https://api.foolishfox.cn/umami/day_view?start_at=&#x27;</span> + start_at + <span class="string">&#x27;&amp;end_at=&#x27;</span> + end_at).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> data.<span class="title function_">json</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        data = data.<span class="property">pageviews</span>;</span><br><span class="line">        data.<span class="title function_">sort</span>(<span class="title function_">compareFunction</span>(<span class="string">&quot;t&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> calArr = [];</span><br><span class="line">        <span class="keyword">let</span> maxValue = <span class="number">0</span>, total = <span class="number">0</span>, weekdatacore = <span class="number">0</span>, thisweekdatacore = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> colorBox = [<span class="string">&#x27;#EBEDF0&#x27;</span>, <span class="string">&#x27;#FFE9BB&#x27;</span>, <span class="string">&#x27;#FFD1A7&#x27;</span>, <span class="string">&#x27;#FFBB95&#x27;</span>, <span class="string">&#x27;#FFA383&#x27;</span>, <span class="string">&#x27;#FF8D70&#x27;</span>, <span class="string">&#x27;#FF745C&#x27;</span>, <span class="string">&#x27;#FF5C4A&#x27;</span>, <span class="string">&#x27;#FF4638&#x27;</span>, <span class="string">&#x27;#FF2E26&#x27;</span>, <span class="string">&#x27;#FF1812&#x27;</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> pre = <span class="keyword">new</span> <span class="title class_">Date</span>(data[i - <span class="number">1</span>].<span class="property">t</span>.<span class="title function_">replace</span>(<span class="regexp">/-/g</span>, <span class="string">&quot;/&quot;</span>));</span><br><span class="line">                <span class="keyword">let</span> tmp = <span class="keyword">new</span> <span class="title class_">Date</span>(data[i].<span class="property">t</span>.<span class="title function_">replace</span>(<span class="regexp">/-/g</span>, <span class="string">&quot;/&quot;</span>));</span><br><span class="line">                <span class="keyword">if</span> (tmp.<span class="title function_">getTime</span>() - pre.<span class="title function_">getTime</span>() != <span class="number">86400</span> * <span class="number">1000</span>)</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">let</span> k = <span class="number">1</span>; k &lt; (tmp.<span class="title function_">getTime</span>() - pre.<span class="title function_">getTime</span>()) / (<span class="number">86400</span> * <span class="number">1000</span>); k++) &#123;</span><br><span class="line">                        tmp = <span class="keyword">new</span> <span class="title class_">Date</span>(pre.<span class="title function_">getTime</span>() + <span class="number">86400</span> * <span class="number">1000</span> * k);</span><br><span class="line">                        calArr.<span class="title function_">push</span>([<span class="title function_">filterTime</span>(tmp), <span class="number">0</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            calArr.<span class="title function_">push</span>([data[i].<span class="property">t</span>, data[i].<span class="property">y</span>]);</span><br><span class="line">            maxValue = data[i].<span class="property">y</span> &gt; maxValue ? data[i].<span class="property">y</span> : maxValue;</span><br><span class="line">            total += data[i].<span class="property">y</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (calArr[calArr.<span class="property">length</span> - <span class="number">1</span>][<span class="number">0</span>] != <span class="title function_">filterTime</span>(now))   calArr.<span class="title function_">push</span>([<span class="title function_">filterTime</span>(now), <span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = calArr.<span class="property">length</span> - <span class="number">1</span>; i &gt;= calArr.<span class="property">length</span> - <span class="number">7</span>; i--)   weekdatacore += calArr[i][<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = calArr.<span class="property">length</span> - <span class="number">1</span>; i &gt;= calArr.<span class="property">length</span> - <span class="number">30</span>; i--)   thisweekdatacore += calArr[i][<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">let</span> calArrJson = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(calArr);</span><br><span class="line">        script.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">        var calChart = echarts.init(document.getElementById(&quot;calendar_container&quot;));</span></span><br><span class="line"><span class="string">        var option = &#123;</span></span><br><span class="line"><span class="string">            title: &#123; text: &#x27;访问日历&#x27;, x: &#x27;center&#x27; &#125;,</span></span><br><span class="line"><span class="string">            tooltip: &#123;</span></span><br><span class="line"><span class="string">                padding: 10,</span></span><br><span class="line"><span class="string">                backgroundColor: &#x27;#555&#x27;,</span></span><br><span class="line"><span class="string">                borderColor: &#x27;#777&#x27;,</span></span><br><span class="line"><span class="string">                borderWidth: 1,</span></span><br><span class="line"><span class="string">                textStyle: &#123; color: &#x27;#fff&#x27; &#125;,</span></span><br><span class="line"><span class="string">                formatter: function (obj) &#123;</span></span><br><span class="line"><span class="string">                    var value = obj.value;</span></span><br><span class="line"><span class="string">                    return &#x27;&lt;div style=&quot;font-size: 14px;&quot;&gt;&#x27; + value[0] + &#x27;: &#x27; + value[1] + &#x27;&lt;/div&gt;&#x27;;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            visualMap: &#123;</span></span><br><span class="line"><span class="string">                show: false,</span></span><br><span class="line"><span class="string">                showLabel: true,</span></span><br><span class="line"><span class="string">                min: 0,</span></span><br><span class="line"><span class="string">                max: <span class="subst">$&#123;maxValue&#125;</span>,</span></span><br><span class="line"><span class="string">                type: &#x27;piecewise&#x27;,</span></span><br><span class="line"><span class="string">                orient: &#x27;horizontal&#x27;,</span></span><br><span class="line"><span class="string">                left: &#x27;center&#x27;,</span></span><br><span class="line"><span class="string">                bottom: 0,</span></span><br><span class="line"><span class="string">                pieces: <span class="subst">$&#123;generatePieces(maxValue, colorBox)&#125;</span></span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            calendar: [&#123;</span></span><br><span class="line"><span class="string">                left: &#x27;center&#x27;,</span></span><br><span class="line"><span class="string">                range: [&#x27;<span class="subst">$&#123;calArr[<span class="number">0</span>][<span class="number">0</span>]&#125;</span>&#x27;, &#x27;<span class="subst">$&#123;calArr[calArr.length - <span class="number">1</span>][<span class="number">0</span>]&#125;</span>&#x27;],</span></span><br><span class="line"><span class="string">                cellSize: [14, 14],</span></span><br><span class="line"><span class="string">                splitLine: &#123;</span></span><br><span class="line"><span class="string">                    show: false</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                itemStyle: &#123;</span></span><br><span class="line"><span class="string">                    color: &#x27;#ebedf0&#x27;,</span></span><br><span class="line"><span class="string">                    borderColor: &#x27;#fff&#x27;,</span></span><br><span class="line"><span class="string">                    borderWidth: 2</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                yearLabel: &#123;</span></span><br><span class="line"><span class="string">                    show: false</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                monthLabel: &#123;</span></span><br><span class="line"><span class="string">                    nameMap: &#x27;cn&#x27;,</span></span><br><span class="line"><span class="string">                    fontSize: 11</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                dayLabel: &#123;</span></span><br><span class="line"><span class="string">                    formatter: &#x27;&#123;start&#125;  1st&#x27;,</span></span><br><span class="line"><span class="string">                    nameMap: &#x27;cn&#x27;,</span></span><br><span class="line"><span class="string">                    fontSize: 11</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;],</span></span><br><span class="line"><span class="string">            series: [&#123;</span></span><br><span class="line"><span class="string">                type: &#x27;heatmap&#x27;,</span></span><br><span class="line"><span class="string">                coordinateSystem: &#x27;calendar&#x27;,</span></span><br><span class="line"><span class="string">                calendarIndex: 0,</span></span><br><span class="line"><span class="string">                data: <span class="subst">$&#123;calArrJson&#125;</span>,</span></span><br><span class="line"><span class="string">            &#125;]</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">        calChart.setOption(option);`</span>;</span><br><span class="line">        <span class="keyword">let</span> style = <span class="string">&#x27;&lt;style&gt;.number&#123;margin-top: 10px;text-align:center;width:100%;padding:10px;margin:0 auto;&#125;.contrib-column&#123;text-align:center;border-left:1px solid #ddd;border-top:1px solid #ddd;&#125;.contrib-column-first&#123;border-left:0;&#125;.table-column&#123;padding:10px;display:table-cell;flex:1;vertical-align:top;&#125;.contrib-number&#123;font-weight:400;line-height:1.3em;font-size:24px;display:block;&#125;.left.text-muted&#123;float:left;margin-left:9px;color:#767676;&#125;.left.text-muted a&#123;color:#4078c0;text-decoration:none;&#125;.left.text-muted a:hover&#123;text-decoration:underline;&#125;h2.f4.text-normal.mb-3&#123;display:none;&#125;.float-left.text-gray&#123;float:left;&#125;.position-relative&#123;width:100%;&#125;@media screen and (max-width:650px)&#123;.contrib-column&#123;display:none&#125;&#125;&lt;/style&gt;&#x27;</span>;</span><br><span class="line">        style = <span class="string">&#x27;&lt;div style=&quot;display:flex;width:100%&quot; class=&quot;number&quot;&gt;&lt;div class=&quot;contrib-column contrib-column-first table-column&quot;&gt;&lt;span class=&quot;text-muted&quot;&gt;过去一年访问&lt;/span&gt;&lt;span class=&quot;contrib-number&quot;&gt;&#x27;</span> + total + <span class="string">&#x27;&lt;/span&gt;&lt;span class=&quot;text-muted&quot;&gt;&#x27;</span> + calArr[<span class="number">0</span>][<span class="number">0</span>] + <span class="string">&#x27;&amp;nbsp;-&amp;nbsp;&#x27;</span> + calArr[calArr.<span class="property">length</span> - <span class="number">1</span>][<span class="number">0</span>] + <span class="string">&#x27;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;contrib-column table-column&quot;&gt;&lt;span class=&quot;text-muted&quot;&gt;最近30天访问&lt;/span&gt;&lt;span class=&quot;contrib-number&quot;&gt;&#x27;</span> + thisweekdatacore + <span class="string">&#x27;&lt;/span&gt;&lt;span class=&quot;text-muted&quot;&gt;&#x27;</span> + calArr[calArr.<span class="property">length</span> - <span class="number">30</span>][<span class="number">0</span>] + <span class="string">&#x27;&amp;nbsp;-&amp;nbsp;&#x27;</span> + calArr[calArr.<span class="property">length</span> - <span class="number">1</span>][<span class="number">0</span>] + <span class="string">&#x27;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;contrib-column table-column&quot;&gt;&lt;span class=&quot;text-muted&quot;&gt;最近7天访问&lt;/span&gt;&lt;span class=&quot;contrib-number&quot;&gt;&#x27;</span> + weekdatacore + <span class="string">&#x27;&lt;/span&gt;&lt;span class=&quot;text-muted&quot;&gt;&#x27;</span> + calArr[calArr.<span class="property">length</span> - <span class="number">7</span>][<span class="number">0</span>] + <span class="string">&#x27;&amp;nbsp;-&amp;nbsp;&#x27;</span> + calArr[calArr.<span class="property">length</span> - <span class="number">1</span>][<span class="number">0</span>] + <span class="string">&#x27;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&#x27;</span> + style;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;calendar_container&quot;</span>).<span class="title function_">after</span>(script);</span><br><span class="line">        <span class="title function_">append_div_visitcalendar</span>(calendar_container, style);</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问地图</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mapChart</span> () &#123;</span><br><span class="line">    <span class="keyword">let</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">let</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="comment">// 这个根据自己开始的时间修改</span></span><br><span class="line">    date.<span class="title function_">setFullYear</span>(<span class="number">2021</span>, <span class="number">01</span>, <span class="number">01</span>);</span><br><span class="line">    <span class="keyword">let</span> start_at = date.<span class="title function_">getTime</span>();</span><br><span class="line">    <span class="keyword">let</span> end_at = now.<span class="title function_">getTime</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// API根据自己的实际更改</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;https://api.foolishfox.cn/umami/country?start_at=&#x27;</span> + start_at + <span class="string">&#x27;&amp;end_at=&#x27;</span> + end_at).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> data.<span class="title function_">json</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> mapArr = [];</span><br><span class="line">        <span class="keyword">let</span> maxValue = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            maxValue = data[i].<span class="property">y</span> &gt; maxValue ? data[i].<span class="property">y</span> : maxValue ;</span><br><span class="line">            mapArr.<span class="title function_">push</span>(&#123; <span class="attr">name</span>: data[i].<span class="property">x</span>, <span class="attr">value</span>: data[i].<span class="property">y</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> mapArrJson = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(mapArr);</span><br><span class="line">        script.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">        var mapChart = echarts.init(document.getElementById(&#x27;map_container&#x27;), &#x27;light&#x27;);</span></span><br><span class="line"><span class="string">        var mapOption = &#123;</span></span><br><span class="line"><span class="string">            title: &#123; text: &#x27;访问地点(按人数记)&#x27;, x: &#x27;center&#x27; &#125;,</span></span><br><span class="line"><span class="string">            tooltip: &#123; trigger: &#x27;item&#x27; &#125;,</span></span><br><span class="line"><span class="string">            visualMap: &#123;</span></span><br><span class="line"><span class="string">                min: 0,</span></span><br><span class="line"><span class="string">                max: <span class="subst">$&#123;maxValue&#125;</span>,</span></span><br><span class="line"><span class="string">                left: &#x27;left&#x27;,</span></span><br><span class="line"><span class="string">                top: &#x27;bottom&#x27;,</span></span><br><span class="line"><span class="string">                text: [&#x27;高&#x27;,&#x27;低&#x27;],</span></span><br><span class="line"><span class="string">                color: [&#x27;#1E90FF&#x27;, &#x27;#AAFAFA&#x27;],</span></span><br><span class="line"><span class="string">                calculable: true</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            series: [&#123;</span></span><br><span class="line"><span class="string">                name: &#x27;访问人数&#x27;,</span></span><br><span class="line"><span class="string">                type: &#x27;map&#x27;,</span></span><br><span class="line"><span class="string">                mapType: &#x27;world&#x27;,</span></span><br><span class="line"><span class="string">                showLegendSymbol: false,</span></span><br><span class="line"><span class="string">                label: &#123;</span></span><br><span class="line"><span class="string">                    emphasis: &#123; show: false &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                itemStyle: &#123;</span></span><br><span class="line"><span class="string">                    normal: &#123;</span></span><br><span class="line"><span class="string">                        areaColor: &#x27;rgba(255, 255, 255, 0.1)&#x27;,</span></span><br><span class="line"><span class="string">                        borderColor: &#x27;#121212&#x27;</span></span><br><span class="line"><span class="string">                    &#125;,</span></span><br><span class="line"><span class="string">                    emphasis: &#123; areaColor: &#x27;gold&#x27; &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                data: <span class="subst">$&#123;mapArrJson&#125;</span></span></span><br><span class="line"><span class="string">            &#125;]</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">        mapChart.setOption(mapOption);`</span>;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;map_container&#x27;</span>).<span class="title function_">after</span>(script);</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_year</span>(<span class="params">s</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parseInt</span>(s.<span class="title function_">substr</span>(<span class="number">0</span>, <span class="number">4</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_month</span>(<span class="params">s</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parseInt</span>(s.<span class="title function_">substr</span>(<span class="number">5</span>, <span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问趋势</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trendsChart</span> () &#123;</span><br><span class="line">    <span class="keyword">let</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">let</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="comment">// 这个根据自己开始的时间修改</span></span><br><span class="line">    date.<span class="title function_">setFullYear</span>(<span class="number">2021</span>, <span class="number">01</span>, <span class="number">01</span>);</span><br><span class="line">    <span class="keyword">let</span> start_at = date.<span class="title function_">getTime</span>();</span><br><span class="line">    <span class="keyword">let</span> end_at = now.<span class="title function_">getTime</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// API根据自己的实际更改</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;https://api.foolishfox.cn/umami/month_view?start_at=&#x27;</span> + start_at + <span class="string">&#x27;&amp;end_at=&#x27;</span> + end_at).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> data.<span class="title function_">json</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        data = data.<span class="property">pageviews</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="keyword">let</span> monthValueArr = &#123;&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i =<span class="number">2020</span>; i &lt;= date.<span class="title function_">getFullYear</span>(); i++)   monthValueArr[<span class="title class_">String</span>(i)] = [ ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  ];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> year = <span class="title function_">get_year</span>(data[i].<span class="property">t</span>);</span><br><span class="line">            <span class="keyword">let</span> month = <span class="title function_">get_month</span>(data[i].<span class="property">t</span>);</span><br><span class="line">            monthValueArr[<span class="title class_">String</span>(year)][<span class="title class_">String</span>(month-<span class="number">1</span>)] = data[i].<span class="property">y</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        script.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">        var trendsChart = echarts.init(document.getElementById(&#x27;trends_container&#x27;), &#x27;light&#x27;);</span></span><br><span class="line"><span class="string">        var trendsOption = &#123;</span></span><br><span class="line"><span class="string">            title: &#123; text: &#x27;访问趋势&#x27;, x: &#x27;center&#x27; &#125;,</span></span><br><span class="line"><span class="string">            tooltip: &#123; trigger: &#x27;axis&#x27; &#125;,</span></span><br><span class="line"><span class="string">            legend: &#123; data: [&#x27;2021&#x27;, &#x27;2022&#x27;], x: &#x27;right&#x27; &#125;,</span></span><br><span class="line"><span class="string">            xAxis: &#123;</span></span><br><span class="line"><span class="string">                name: &#x27;日期&#x27;, type: &#x27;category&#x27;, boundaryGap: false,</span></span><br><span class="line"><span class="string">                data: [&#x27;一月&#x27;, &#x27;二月&#x27;, &#x27;三月&#x27;, &#x27;四月&#x27;, &#x27;五月&#x27;, &#x27;六月&#x27;, &#x27;七月&#x27;, &#x27;八月&#x27;, &#x27;九月&#x27;, &#x27;十月&#x27;, &#x27;十一月&#x27;, &#x27;十二月&#x27;]</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            yAxis: &#123; name: &#x27;访问次数&#x27;, type: &#x27;value&#x27; &#125;,</span></span><br><span class="line"><span class="string">            series: [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    name: &#x27;2021&#x27;, type: &#x27;line&#x27;, smooth: true,</span></span><br><span class="line"><span class="string">                    data: [<span class="subst">$&#123;monthValueArr[<span class="string">&quot;2021&quot;</span>]&#125;</span>],</span></span><br><span class="line"><span class="string">                    markLine: &#123; data: [&#123;type: &#x27;average&#x27;, name: &#x27;平均值&#x27;&#125;] &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    name: &#x27;2022&#x27;, type: &#x27;line&#x27;, smooth: true,</span></span><br><span class="line"><span class="string">                    data: [<span class="subst">$&#123;monthValueArr[<span class="string">&quot;2022&quot;</span>]&#125;</span>],</span></span><br><span class="line"><span class="string">                    markLine: &#123; data: [&#123;type: &#x27;average&#x27;, name: &#x27;平均值&#x27;&#125;] &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">        trendsChart.setOption(trendsOption);`</span>;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;trends_container&#x27;</span>).<span class="title function_">after</span>(script);</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问来源</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sourcesChart</span> () &#123;</span><br><span class="line">    <span class="keyword">let</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> link = <span class="number">0</span>, direct = <span class="number">0</span>, search = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> google = <span class="number">0</span>, baidu = <span class="number">0</span>, bing = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> github = <span class="number">0</span>, travel = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">let</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="comment">// 这个根据自己开始的时间修改</span></span><br><span class="line">    date.<span class="title function_">setFullYear</span>(<span class="number">2021</span>, <span class="number">01</span>, <span class="number">01</span>);</span><br><span class="line">    <span class="keyword">let</span> start_at = date.<span class="title function_">getTime</span>();</span><br><span class="line">    <span class="keyword">let</span> end_at = now.<span class="title function_">getTime</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// API根据自己的实际更改</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;https://api.foolishfox.cn/umami/referrer?start_at=&#x27;</span> + start_at + <span class="string">&#x27;&amp;end_at=&#x27;</span> + end_at).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> data.<span class="title function_">json</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> ref = data[i].<span class="property">x</span>;</span><br><span class="line">            <span class="keyword">if</span>(ref == <span class="string">&quot;&quot;</span> || ref.<span class="title function_">includes</span>(<span class="string">&quot;foolishfox.cn&quot;</span>))  direct += data[i].<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(ref.<span class="title function_">includes</span>(<span class="string">&quot;bing.com&quot;</span>))   bing += data[i].<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(ref.<span class="title function_">includes</span>(<span class="string">&quot;baidu.com&quot;</span>))   baidu += data[i].<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(ref.<span class="title function_">includes</span>(<span class="string">&quot;google.com&quot;</span>))   google += data[i].<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(ref.<span class="title function_">includes</span>(<span class="string">&quot;sogou.com&quot;</span>) || ref.<span class="title function_">includes</span>(<span class="string">&quot;sm.cn&quot;</span>) || ref.<span class="title function_">includes</span>(<span class="string">&quot;toutiao.com&quot;</span>) || ref.<span class="title function_">includes</span>(<span class="string">&quot;so.com&quot;</span>))</span><br><span class="line">                search += data[i].<span class="property">y</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(ref.<span class="title function_">includes</span>(<span class="string">&quot;github.com&quot;</span>))   github += data[i].<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(ref.<span class="title function_">includes</span>(<span class="string">&quot;travellings&quot;</span>) || ref.<span class="title function_">includes</span>(<span class="string">&quot;foreverblog&quot;</span>))   travel += data[i].<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">else</span>   link += data[i].<span class="property">y</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        link += github + travel;</span><br><span class="line">        search += baidu + google + bing;</span><br><span class="line">        script.<span class="property">innerHTML</span> += <span class="string">`</span></span><br><span class="line"><span class="string">        var sourcesChart = echarts.init(document.getElementById(&#x27;sources_container&#x27;), &#x27;light&#x27;);</span></span><br><span class="line"><span class="string">        var sourcesOption = &#123;</span></span><br><span class="line"><span class="string">            title: &#123; text: &#x27;访问来源&#x27;, x: &#x27;center&#x27;, &#125;,</span></span><br><span class="line"><span class="string">            tooltip: &#123; trigger: &#x27;item&#x27;, formatter: &#x27;&#123;a&#125; &lt;br/&gt;&#123;b&#125;: &#123;c&#125; (&#123;d&#125;%)&#x27; &#125;,</span></span><br><span class="line"><span class="string">            legend: &#123;</span></span><br><span class="line"><span class="string">                data: [&#x27;直达&#x27;, &#x27;外链&#x27;, &#x27;搜索&#x27;, &#x27;百度&#x27;, &#x27;谷歌&#x27;, &#x27;必应&#x27;, &#x27;Github&#x27;, &#x27;开往/十年之约&#x27;],</span></span><br><span class="line"><span class="string">                y: &#x27;bottom&#x27;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            series: [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    name: &#x27;来源明细&#x27;, type: &#x27;pie&#x27;, radius: [&#x27;45%&#x27;, &#x27;60%&#x27;],</span></span><br><span class="line"><span class="string">                    labelLine: &#123; length: 30 &#125;,</span></span><br><span class="line"><span class="string">                    label: &#123;</span></span><br><span class="line"><span class="string">                        formatter: &#x27;&#123;a|&#123;a&#125;&#125;&#123;abg|&#125;\\n&#123;hr|&#125;\\n  &#123;b|&#123;b&#125;: &#125;&#123;c&#125;  &#123;per|&#123;d&#125;%&#125;  &#x27;,</span></span><br><span class="line"><span class="string">                        backgroundColor: &#x27;#F6F8FC&#x27;, borderColor: &#x27;#8C8D8E&#x27;,</span></span><br><span class="line"><span class="string">                        borderWidth: 1, borderRadius: 4,</span></span><br><span class="line"><span class="string">                        rich: &#123;</span></span><br><span class="line"><span class="string">                            a: &#123; color: &#x27;#6E7079&#x27;, lineHeight: 22, align: &#x27;center&#x27; &#125;,</span></span><br><span class="line"><span class="string">                            hr: &#123; borderColor: &#x27;#8C8D8E&#x27;, width: &#x27;100%&#x27;, borderWidth: 1, height: 0 &#125;,</span></span><br><span class="line"><span class="string">                            b: &#123; color: &#x27;#4C5058&#x27;, fontSize: 14, fontWeight: &#x27;bold&#x27;, lineHeight: 33 &#125;,</span></span><br><span class="line"><span class="string">                            per: &#123; color: &#x27;#fff&#x27;, backgroundColor: &#x27;#4C5058&#x27;, padding: [3, 4], borderRadius: 4 &#125;</span></span><br><span class="line"><span class="string">                        &#125;</span></span><br><span class="line"><span class="string">                    &#125;,</span></span><br><span class="line"><span class="string">                    data: [</span></span><br><span class="line"><span class="string">                        &#123;value: <span class="subst">$&#123;search - google - baidu - bing&#125;</span>, name: &#x27;其他&#x27;, itemStyle: &#123; color : &#x27;#008000&#x27; &#125;&#125;,</span></span><br><span class="line"><span class="string">                        &#123;value: <span class="subst">$&#123;google&#125;</span>, name: &#x27;谷歌&#x27;, itemStyle: &#123; color : &#x27;#009000&#x27; &#125;&#125;,</span></span><br><span class="line"><span class="string">                        &#123;value: <span class="subst">$&#123;baidu&#125;</span>, name: &#x27;百度&#x27;, itemStyle: &#123; color : &#x27;#00A000&#x27; &#125;&#125;,</span></span><br><span class="line"><span class="string">                        &#123;value: <span class="subst">$&#123;bing&#125;</span>, name: &#x27;必应&#x27;, itemStyle: &#123; color : &#x27;#00B000&#x27; &#125;&#125;,</span></span><br><span class="line"><span class="string">                        &#123;value: <span class="subst">$&#123;direct&#125;</span>, name: &#x27;直达&#x27;, itemStyle: &#123; color : &#x27;#FFDB5C&#x27; &#125;&#125;,</span></span><br><span class="line"><span class="string">                        &#123;value: <span class="subst">$&#123;github&#125;</span>, name: &#x27;Github&#x27;, itemStyle: &#123; color : &#x27;#10A3C7&#x27; &#125;&#125;,</span></span><br><span class="line"><span class="string">                        &#123;value: <span class="subst">$&#123;travel&#125;</span>, name: &#x27;开往/十年之约&#x27;, itemStyle: &#123; color : &#x27;#21B4D8&#x27; &#125;&#125;,</span></span><br><span class="line"><span class="string">                        &#123;value: <span class="subst">$&#123;link - github - travel&#125;</span>, name: &#x27;其他&#x27;, itemStyle: &#123; color : &#x27;#32C5E9&#x27; &#125;&#125;</span></span><br><span class="line"><span class="string">                    ]</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    name: &#x27;访问来源&#x27;, type: &#x27;pie&#x27;, selectedMode: &#x27;single&#x27;, radius: [0, &#x27;30%&#x27;],</span></span><br><span class="line"><span class="string">                    label: &#123; position: &#x27;inner&#x27;, fontSize: 14&#125;,</span></span><br><span class="line"><span class="string">                    labelLine: &#123; show: false &#125;,</span></span><br><span class="line"><span class="string">                    data: [</span></span><br><span class="line"><span class="string">                        &#123;value: <span class="subst">$&#123;search&#125;</span>, name: &#x27;搜索&#x27;, itemStyle: &#123; color : &#x27;#008000&#x27; &#125;&#125;,</span></span><br><span class="line"><span class="string">                        &#123;value: <span class="subst">$&#123;direct&#125;</span>, name: &#x27;直达&#x27;, itemStyle: &#123; color : &#x27;#FFDB5C&#x27; &#125;&#125;,</span></span><br><span class="line"><span class="string">                        &#123;value: <span class="subst">$&#123;link&#125;</span>, name: &#x27;外链&#x27;, itemStyle: &#123; color : &#x27;#32C5E9&#x27; &#125;&#125;</span></span><br><span class="line"><span class="string">                    ]</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">        sourcesChart.setOption(sourcesOption);</span></span><br><span class="line"><span class="string">        window.addEventListener(&quot;resize&quot;, () =&gt; &#123; </span></span><br><span class="line"><span class="string">            calChart.resize();</span></span><br><span class="line"><span class="string">            mapChart.resize();</span></span><br><span class="line"><span class="string">            trendsChart.resize();</span></span><br><span class="line"><span class="string">            sourcesChart.resize();</span></span><br><span class="line"><span class="string">        &#125;);`</span>;</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;sources_container&#x27;</span>).<span class="title function_">after</span>(script);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;calendar_container&quot;</span>))   <span class="title function_">calChart</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;map_container&#x27;</span>))   <span class="title function_">mapChart</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;trends_container&#x27;</span>))   <span class="title function_">trendsChart</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;sources_container&#x27;</span>))   <span class="title function_">sourcesChart</span>();</span><br></pre></td></tr></table></figure></div></details><h3 id="效果展示">效果展示<a class="header-anchor" href="#效果展示">¶</a></h3><p>动态展示页面：<a href="/s/statistics">戳这里</a></p><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/09/29/6334810a37e76.png" alt="日历图与地图"/></div><span class="image-caption">日历图与地图</span></div><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/09/29/6334810a85e69.png" alt="访问趋势与来源"/></div><span class="image-caption">访问趋势与来源</span></div><h2 id="V2-版本更新">V2 版本更新<a class="header-anchor" href="#V2-版本更新">¶</a></h2><h3 id="Umami-更新">Umami 更新<a class="header-anchor" href="#Umami-更新">¶</a></h3><p>本文安装时<code>Umami</code>的版本是<code>1.38.0</code>，目前已经更新到了<code>2.6.2</code>，跨大版本升级需要更新数据库，大致流程如下：</p><ol><li>拉取最新仓库：</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull</span><br></pre></td></tr></table></figure><ol start="2"><li>更新到<code>V1</code>的最新版本<code>1.40.0</code>：</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git checkout cc2be9f4</span><br><span class="line">yarn install</span><br><span class="line">yarn build</span><br></pre></td></tr></table></figure><ol start="3"><li>进行数据迁移</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx @umami/migrate-v1-v2@latest</span><br></pre></td></tr></table></figure><ol start="4"><li>升级到<code>V2</code>：</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git checkout master</span><br><span class="line">yarn install</span><br><span class="line">yarn build</span><br></pre></td></tr></table></figure><p>注意在安装<code>sharp</code>包时可能会由于网络下载相关内容超时导致失败，可以在<code>.npmrc</code>中添加：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sharp_binary_host=https://npm.taobao.org/mirrors/sharp</span><br><span class="line">sharp_libvips_binary_host=https://npm.taobao.org/mirrors/sharp-libvips</span><br></pre></td></tr></table></figure><h3 id="API程序更新">API程序更新<a class="header-anchor" href="#API程序更新">¶</a></h3><p>在升级之后，<code>Umami</code>的API也发生了改变，主要包括：</p><ol><li><code>GET /api/website/&#123;id&#125;/pageviews</code>中的<code>id</code>进行了修改，变成了由数字和字母组成的混合字符串，例如<code>74204a9f-8aca-4adf-9f03-d509f0a07116</code>，此外<code>website</code>变为了<code>websites</code></li><li>API中的时间起止从<code>start_at</code>和<code>end_at</code>改为了<code>startAt</code>和<code>endAt</code></li><li>API中的时区标识从<code>tz</code>改为<code>timezone</code></li><li><s>最长只能获取90天内的每日浏览数据，超过90天将会自动归并为每月的访问数据</s> <a href="https://github.com/umami-software/umami/issues/2294">Fixed in v2.9.0.</a></li><li>返回数据中时间标识从<code>t</code>改为了<code>x</code></li></ol><p>根据上述更新，我们需要对<code>main.py</code>和<code>census.js</code>进行修改，示例如下：</p><ul><li><code>main.py</code></li></ul><details class="toggle" ><summary class="toggle-button" style="color: green">main.py</summary><div class="toggle-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">root_path = <span class="string">&quot;https://&lt;your-umami&gt;/api/websites/&#123;&#125;&quot;</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/day_view&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>(<span class="params">startAt, endAt</span>):</span><br><span class="line">    url = root_path + <span class="string">&quot;/pageviews?startAt=&#123;:d&#125;&amp;endAt=&#123;:d&#125;&amp;unit=day&amp;timezone=Asia/Shanghai&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        <span class="built_in">int</span>(startAt),</span><br><span class="line">        <span class="built_in">int</span>(endAt)</span><br><span class="line">    )</span><br><span class="line">    res = requests.get(url, headers=header)</span><br><span class="line">    res = json.loads(res.content)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div></details><ul><li><code>census.js</code></li></ul><details class="toggle" ><summary class="toggle-button" style="color: red">census.js</summary><div class="toggle-content"><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">calChart</span>(<span class="params"></span>) &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">// 90 天版本</span></span><br><span class="line">    <span class="keyword">let</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">let</span> endAt = now.<span class="title function_">getTime</span>();</span><br><span class="line">    <span class="keyword">let</span> startAt = endAt - <span class="number">90</span> * <span class="number">86400</span> * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1 年版本</span></span><br><span class="line">    <span class="keyword">let</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">let</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    date.<span class="title function_">setFullYear</span>(now.<span class="title function_">getFullYear</span>() - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">let</span> startAt = date.<span class="title function_">getTime</span>() - <span class="number">3600</span> * <span class="number">24</span> * ((date.<span class="title function_">getDay</span>() + <span class="number">1</span>) % <span class="number">7</span>);</span><br><span class="line">    <span class="keyword">let</span> endAt = now.<span class="title function_">getTime</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// API根据自己的实际更改</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;https://api.foolishfox.cn/umami/day_view?startAt=&#x27;</span> + startAt + <span class="string">&#x27;&amp;endAt=&#x27;</span> + endAt).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> data.<span class="title function_">json</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        data = data.<span class="property">pageviews</span>;</span><br><span class="line">        data.<span class="title function_">sort</span>(<span class="title function_">compareFunction</span>(<span class="string">&quot;x&quot;</span>));</span><br><span class="line">...</span><br><span class="line">                <span class="keyword">let</span> pre = <span class="keyword">new</span> <span class="title class_">Date</span>(data[i - <span class="number">1</span>].<span class="property">x</span>.<span class="title function_">replace</span>(<span class="regexp">/-/g</span>, <span class="string">&quot;/&quot;</span>));</span><br><span class="line">                <span class="keyword">let</span> tmp = <span class="keyword">new</span> <span class="title class_">Date</span>(data[i].<span class="property">x</span>.<span class="title function_">replace</span>(<span class="regexp">/-/g</span>, <span class="string">&quot;/&quot;</span>));</span><br><span class="line">...</span><br><span class="line">            calArr.<span class="title function_">push</span>([data[i].<span class="property">x</span>, data[i].<span class="property">y</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div></details><h2 id="广告反屏蔽">广告反屏蔽<a class="header-anchor" href="#广告反屏蔽">¶</a></h2><p><code>Umami</code> 的默认跟踪代码提供的链接是 <code>https://umami.foolishfox.cn/script.js</code>，会被大多数的广告插件屏蔽（如 <code>AdGuard</code>），统计不到访客信息。通过设置 <code>TRACKER_SCRIPT_NAME</code> 可以修改链接，起到反屏蔽的效果，修改后的跟踪代码链接为<code>https://umami.foolishfox.cn/Bf5ZmaKLu245LG</code>。</p><figure class="highlight yaml"><figcaption><span>docker-compose.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.9&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">umami:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ghcr.io/umami-software/umami:mysql-latest</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">TRACKER_SCRIPT_NAME:</span> <span class="string">Bf5ZmaKLu245LG</span></span><br></pre></td></tr></table></figure><h2 id="参考资料">参考资料<a class="header-anchor" href="#参考资料">¶</a></h2><ol><li><a href="https://umami.is/docs/migrate-v1-v2">Migrating v1 to v2</a></li><li><a href="https://www.cnblogs.com/volta-lemon/p/16891023.html">一站式解决Node项目中遇到的 诸如sharp: Command failed.或Building fresh packages…始终执行问题</a></li><li><a href="https://umami.is/docs/environment-variables">Environment variables</a></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;在一年多之前，我写了一篇博客（&lt;a href=&quot;/posts/202105-visit.html&quot;&gt;博客成长日志 | 准实时访问统计&lt;/a&gt;）介绍如何使用百度统计的API实现准实时的访问统计与展示。然而今年百度统计宣布个人版只允许保存一年的数据，而且很多功能会被关闭（例如OS统计等），再加上其API使用也不方便，因此我开始谋求其他的站点统计系统。&lt;/p&gt;
&lt;p&gt;与百度统计同类型的竞品还有谷歌统计、51La、CNZZ等，但是这些网站与百度统计也或多或少存在类似类似的问题，同时作为个人小站，也不需要收集过于精细的用户信息（如年龄、详细地区等），所以我开始寻找自建的统计工具。&lt;/p&gt;</summary>
    
    
    
    <category term="软件/程序" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/"/>
    
    <category term="博客成长日志" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/%E5%8D%9A%E5%AE%A2%E6%88%90%E9%95%BF%E6%97%A5%E5%BF%97/"/>
    
    
    <category term="教程" scheme="https://foolishfox.cn/tags/%E6%95%99%E7%A8%8B/"/>
    
    <category term="站点统计" scheme="https://foolishfox.cn/tags/%E7%AB%99%E7%82%B9%E7%BB%9F%E8%AE%A1/"/>
    
    <category term="Umami" scheme="https://foolishfox.cn/tags/Umami/"/>
    
    <category term="Echarts" scheme="https://foolishfox.cn/tags/Echarts/"/>
    
  </entry>
  
  <entry>
    <title>Windows下Geant4的安装与示例</title>
    <link href="https://foolishfox.cn/posts/202204-g4b.html"/>
    <id>https://foolishfox.cn/posts/202204-g4b.html</id>
    <published>2022-04-27T16:54:48.000Z</published>
    <updated>2022-04-27T16:54:48.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>Geant4</code>(GEometry ANd Tracking，几何和跟踪)是由<code>CERN</code>(欧洲核子研究组织)基于<code>C++</code>面向对象技术开发的蒙特卡罗应用软件包，用于模拟粒子与物质的相互作用，在高能物理、加速器、核物理、辐射防护等多个领域都有着广泛的应用。</p><span id="more"></span><h2 id="安装">安装<a class="header-anchor" href="#安装">¶</a></h2><h3 id="环境要求">环境要求<a class="header-anchor" href="#环境要求">¶</a></h3><ul><li><a href="https://github.com/Geant4/geant4/releases">源代码</a></li><li><a href="https://www.visualstudio.com/">MSVC</a> 19</li><li><a href="https://cmake.org/">CMaKe</a> &gt;= 3.16</li><li><a href="https://download.qt.io/official_releases/online_installers/">Qt5</a>（<strong>optional，可选</strong>）</li></ul><div class="note info flat"><p><strong>MSVC</strong><br>只要求<code>MSVC</code>版本为<code>19.X.X.X</code>，不要求<code>Visual Studio</code>版本为<code>VS 2019</code>，通过在<code>VS</code>中打开<code>isual Studio Tools (工具) → Developer Command Prompt for VS201X (Visual Studio 命令提示)</code>可以查看<code>MSVC</code>版本：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;cl</span><br><span class="line">用于 x86 的 Microsoft (R) C/C++ 优化编译器 <span class="number">19</span>.<span class="number">31</span>.<span class="number">31104</span> 版</span><br><span class="line">版权所有(C) Microsoft Corporation。保留所有权利。</span><br><span class="line"></span><br><span class="line">用法: cl [ 选项... ] 文件名... [ /link 链接选项... ]</span><br></pre></td></tr></table></figure></div><div class="note warning flat"><p><strong>Qt</strong><br>必须是<code>Qt5</code>，目前暂不支持<code>Qt6</code>，推荐使用<code>Qt 5.15 LTS</code>。</p></div><h3 id="安装前准备">安装前准备<a class="header-anchor" href="#安装前准备">¶</a></h3><h4 id="CMaKe">CMaKe<a class="header-anchor" href="#CMaKe">¶</a></h4><p>推荐使用<a href="https://foolishfox.cn/posts/202101-a.html">Scoop</a>进行安装，可以方便的进行版本更新，自动添加环境变量等：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scoop install cmake</span><br></pre></td></tr></table></figure><h4 id="Qt（可选）">Qt（可选）<a class="header-anchor" href="#Qt（可选）">¶</a></h4><p><code>Qt</code>是一个可选项，可以美化<code>Geant4</code>的<code>GUI</code>显示，注意版本必须为<code>5.X.X</code>，目前最新的LTS版本是<code>5.15.3</code>。从<a href="https://download.qt.io/official_releases/online_installers/">下载页面</a>获取在线安装程序，本过程需要<code>Qt</code>账号，可以提前在官网注册好。</p><p>在选择组件界面可以选择<code>Qt</code>的版本，以<code>5.15.2</code>为例，我们只需要其中的<code>MSVC 2019</code>部分，其余可根据需要自行选择：</p><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/28/1651106237252.png" alt="图1 Qt的安装"/></div><span class="image-caption">图1 Qt的安装</span></div><p>安装完成后，找到安装目录下的动态链接库目录，如<code>D:\Qt\5.15.2\msvc2019_64\bin</code>，将其添加至环境变量中的<code>PATH</code>。</p><h4 id="Geant4">Geant4<a class="header-anchor" href="#Geant4">¶</a></h4><p>从<code>Github</code>下载<code>Geant4</code>的源代码文件，解压至<code>D:\Geant4\source</code>目录下。</p><h3 id="编译安装">编译安装<a class="header-anchor" href="#编译安装">¶</a></h3><h4 id="无Qt">无Qt<a class="header-anchor" href="#无Qt">¶</a></h4><p>无<code>Qt</code>版本的编译安装较为简单，进入<code>D:\Geant4</code>目录，创建<code>build</code>文件夹并进入：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">cd</span> D:\Geant4</span><br><span class="line">&gt; <span class="built_in">mkdir</span> build</span><br><span class="line">&gt; <span class="built_in">dir</span> /B</span><br><span class="line">build</span><br><span class="line">source</span><br><span class="line">&gt; <span class="built_in">cd</span> build</span><br></pre></td></tr></table></figure><p>随后运行<code>CMaKe</code>：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -DCMAKE_INSTALL_PREFIX=&quot;D:\Geant4\disk&quot; &quot;D:\Geant4\source&quot;</span><br></pre></td></tr></table></figure><p>其中<code>CMAKE_INSTALL_PREFIX</code>用于设置安装路径，即安装<code>Geant4</code>库、头文件和支持文件的目录，必须为<strong>绝对路径</strong>。后者为源代码的目录，可以为相对路径。<code>Geant4</code>还有很多的可选编译选项，可以查阅<a href="https://geant4-userdoc.web.cern.ch/UsersGuides/InstallationGuide/html/installguide.html#geant4buildoptions">Geant4 Build Options</a>。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; cmake -DCMAKE_INSTALL_PREFIX=&quot;D:\Geant4\disk&quot; &quot;D:\Geant4\source&quot;</span><br><span class="line">-- Building <span class="keyword">for</span>: Visual Studio <span class="number">17</span> <span class="number">2022</span></span><br><span class="line">-- Selecting Windows SDK version <span class="number">10</span>.<span class="number">0</span>.<span class="number">19041</span>.<span class="number">0</span> to target Windows <span class="number">10</span>.<span class="number">0</span>.<span class="number">19043</span>.</span><br><span class="line">-- The C compiler identification is MSVC <span class="number">19</span>.<span class="number">31</span>.<span class="number">31104</span>.<span class="number">0</span></span><br><span class="line">-- The CXX compiler identification is MSVC <span class="number">19</span>.<span class="number">31</span>.<span class="number">31104</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">-- The following Geant4 features are enabled:</span><br><span class="line"><span class="function">CMAKE_CXX_STANDARD: <span class="title">Compiling</span> <span class="title">against</span> <span class="title">C</span>++ <span class="title">Standard</span> &#x27;17&#x27;</span></span><br><span class="line"><span class="function"><span class="title">GEANT4_BUILD_MULTITHREADED</span>: <span class="title">Build</span> <span class="title">multithread</span> <span class="title">enabled</span> <span class="title">libraries</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-- <span class="title">Configuring</span> <span class="title">done</span></span></span><br><span class="line"><span class="function">-- <span class="title">Generating</span> <span class="title">done</span></span></span><br><span class="line"><span class="function">-- <span class="title">Build</span> <span class="title">files</span> <span class="title">have</span> <span class="title">been</span> <span class="title">written</span> <span class="title">to</span>: <span class="title">D</span>:/<span class="title">Geant4</span>/<span class="title">build</span></span></span><br></pre></td></tr></table></figure><p>一般情况下你会看到警告，这只是一个建议项，提醒我们安装进行模拟所必须的数据文件，不影响后续的安装，可以等到安装完成后自行下载解压。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">*WARNING*</span><br><span class="line">  Geant4 has been pre-configured to look for datasets</span><br><span class="line">  in the directory:</span><br><span class="line"></span><br><span class="line">  D:\Geant4\disk\share\Geant4-11.0.1\data</span><br><span class="line"></span><br><span class="line">  but the following datasets are NOT present on disk at</span><br><span class="line">  that location:</span><br></pre></td></tr></table></figure><p>经过上面的步骤，<code>CMaKe</code>会生成一个<code>Visual Studio</code>的解决方案，当然我们也可以通过命令行直接进行安装，注意我们选用了<code>Release</code>项，这是因为<code>Geant4</code>的<code>Debug</code>配置优化不是很好，不能带来最佳的性能。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; cmake --build . --config Release --target install</span><br></pre></td></tr></table></figure><h4 id="Qt">Qt<a class="header-anchor" href="#Qt">¶</a></h4><p>带有<code>Qt</code>的编译安装较为繁琐，所以我们可以借助<code>CMaKe-GUI</code>进行配置。选择源代码目录<code>D:\Geant4\source</code>和构建目录<code>D:\Geant4\source</code>后，我们添加一个配置项为<code>CMAKE_PREFIX_PATH</code>，类型为<code>PATH</code>，值为<code>Qt</code>动态链接库的上一级目录（如<code>D:\Qt\5.15.2\msvc2019_64</code>），随后点击左下角的<code>Configure</code>按钮。</p><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/28/1651108142644.png" alt="图2 CMAKE_PREFIX_PATH配置项" style="height:200px;"/></div><span class="image-caption">图2 CMAKE_PREFIX_PATH配置项</span></div><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/28/1651107988351.png" alt="图3 CMaKe的Qt配置" style="height:400px;"/></div><span class="image-caption">图3 CMaKe的Qt配置</span></div><p>随后，我们在自动添加的配置项中，将<code>CMAKE_INSTALL_PREFIX</code>（安装目录）设置为<code>D:\Geant4\disk</code>，将<code>GEANT4_BUILD_MULTITHREADED</code>（多线程编译）勾选，将<code>GEANT4_USE_OPENGL_WIN32</code>和<code>GEANT4_USE_QT</code>勾选启用<code>Qt</code>，再次点击左下角的<code>Configure</code>按钮，<code>CMaKe</code>会自动帮助进行<code>Qt</code>的进一步配置，确认无误后再次点击左下角的<code>Configure</code>按钮，当所有的配置项均变为白色时，则配置完成，点击<code>Configure</code>右侧的<code>Generate</code>进行生成。</p><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/28/6269ec165cfee.png" alt="图4 CMaKe的Qt配置2"/></div><span class="image-caption">图4 CMaKe的Qt配置2</span></div><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/28/6269ed5521256.png" alt="图5 CMaKe的Qt配置3"/></div><span class="image-caption">图5 CMaKe的Qt配置3</span></div><p>点击<code>Generate</code>右侧的<code>Open Project</code>在<code>Visual Studio</code>中打开项目，在解决方案资源管理器中，选中<code>ALL_BUILD</code>到<code>INSTALL</code>中间的所有项目，打开属性（上端的扳手按钮），启用多处理器编译选项。</p><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/28/6269ee9b6e977.png" alt="图6 CMaKe的Qt构建1"/></div><span class="image-caption">图6 CMaKe的Qt构建1</span></div><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/28/6269ef010934c.jpg" alt="图7 CMaKe的Qt构建2"/></div><span class="image-caption">图7 CMaKe的Qt构建2</span></div><p>然后在<code>ALL_BUILD</code>项目上点击右键，再点击生成(<code>Build</code>)，等待结束后在<code>INSTALL</code>项目上点击右键，再点击生成(<code>Build</code>)，即可完成编译安装。</p><h4 id="安装后配置">安装后配置<a class="header-anchor" href="#安装后配置">¶</a></h4><p>在环境变量中添加<code>D:\Geant4\dist\bin</code>。</p><p>在<a href="https://geant4.web.cern.ch/support/download">Download</a>页面下载好数据文件，目前总计12个，约2G大小，将其解压至<code>D:\Geant4\dist\share\Geant4-11.0.1\data</code>目录下（<code>data</code>文件夹可能需要自己创建），解压后目录结构如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">D:\GEANT4\DIST\SHARE\GEANT4-11.0.1\DATA</span><br><span class="line">|---G4ABLA3.1</span><br><span class="line">│   |---*.dat</span><br><span class="line">│   `---sub directory</span><br><span class="line">|---G4EMLOW8.0</span><br><span class="line">|---G4ENSDFSTATE2.3</span><br><span class="line">|---G4INCL1.0</span><br><span class="line">|---G4NDL4.6</span><br><span class="line">|---G4PARTICLEXS4.0</span><br><span class="line">|---G4PII1.3</span><br><span class="line">|---G4SAIDDATA2.0</span><br><span class="line">|---G4TENDL1.4</span><br><span class="line">|---PhotonEvaporation5.7</span><br><span class="line">|---RadioactiveDecay5.6</span><br><span class="line">`---RealSurface2.2</span><br></pre></td></tr></table></figure><p>随后运行<code>D:\Geant4\dist\bin</code>目录下的<code>geant4.csh</code>文件，复制设置环境变量的一段，并进行修改，将结果保存至<code>reg.bat</code>文件中并运行。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">setx G4NEUTRONHPDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4NDL4.6</span><br><span class="line">setx G4LEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4EMLOW8.0</span><br><span class="line">setx G4LEVELGAMMADATA D:/Geant4/dist/share/Geant4-11.0.1/data/PhotonEvaporation5.7</span><br><span class="line">setx G4RADIOACTIVEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/RadioactiveDecay5.6</span><br><span class="line">setx G4PARTICLEXSDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4PARTICLEXS4.0</span><br><span class="line">setx G4PIIDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4PII1.3</span><br><span class="line">setx G4REALSURFACEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/RealSurface2.2</span><br><span class="line">setx G4SAIDXSDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4SAIDDATA2.0</span><br><span class="line">setx G4ABLADATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4ABLA3.1</span><br><span class="line">setx G4INCLDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4INCL1.0</span><br><span class="line">setx G4ENSDFSTATEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4ENSDFSTATE2.3</span><br></pre></td></tr></table></figure><h2 id="示例">示例<a class="header-anchor" href="#示例">¶</a></h2><h3 id="example-B1">example B1<a class="header-anchor" href="#example-B1">¶</a></h3><p><code>B1</code>是用于计算吸收剂量的。几何模型可见图8，半透明的蓝色长方体中填充了水（<code>G4_WATER</code>），外界为空气。在长方体内部有两个物体，第一个圆台状物体的材料为人体组织（<code>G4_A-150_TISSUE</code>），第二个梯形状物体的材料为骨（<code>G4_BONE_COMPACT_ICRU</code>）。</p><p>粒子从圆台状物体的前方入射，分布范围是长方体前侧面积的80%，从图9可以看出，有些粒子在长方体内与水发生反应，直接散射出去；有些粒子直接射在骨中；有些粒子经过组织后入射到骨中。通过计算粒子在骨中沉积的能量，再除以骨的质量，我们可以得到整个骨的平均吸收剂量。</p><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/29/626bd4e893801.png" alt="图8 B1的几何体"/></div><span class="image-caption">图8 B1的几何体</span></div><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/29/626bd5dde6164.png" alt="图9 B1粒子入射模拟"/></div><span class="image-caption">图9 B1粒子入射模拟</span></div><h4 id="试运行">试运行<a class="header-anchor" href="#试运行">¶</a></h4><p>在<code>D:\Geant4\dist\share\Geant4-11.0.1\examples</code>目录下有很多<code>Geant4</code>的示例代码，我们将<code>basic/B1</code>示例复制到<code>~/exampleB1</code>目录下，改名为<code>source</code>，并创建同级目录<code>build</code>：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">mkdir</span> -p ~/exampleB1/source</span><br><span class="line">&gt; <span class="built_in">Copy</span>-Item D:\Geant4\dist\share\Geant4-<span class="number">11</span>.<span class="number">0</span>.<span class="number">1</span>\examples\B1 -Recurse ~/exampleB1/source</span><br><span class="line">&gt; <span class="built_in">mkdir</span> -p ~/exampleB1/build</span><br></pre></td></tr></table></figure><p>进入<code>build</code>目录进行构建，<code>Geant4_DIR</code>是<code>Geant4</code>库文件的安装目录，<code>CMAKE_INSTALL_PREFIX</code>是最终文件的目录：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">cd</span> build</span><br><span class="line">&gt; cmake -DGeant4_DIR=&quot;D:\Geant4\dist\lib\Geant4-<span class="number">11</span>.<span class="number">0</span>.<span class="number">1</span>&quot; -DCMAKE_INSTALL_PREFIX=&quot;~/exampleB1/disk&quot; &quot;~/exampleB1/source&quot;</span><br></pre></td></tr></table></figure><p>构建后会在<code>build</code>目录下生成一个<code>.sln</code>文件，可以使用<code>Visual Studio</code>打开并编译，也可以使用命令行如下：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; cmake --build . --config Release --target install</span><br></pre></td></tr></table></figure><p>编译后会在<code>~/exampleB1/disk/bin</code>目录下生成一个<code>.exe</code>文件，运行该文件还需要<code>.mac</code>文件，因此我们复制<code>build</code>目录下的所有<code>.mac</code>文件到<code>~/exampleB1/disk/bin</code>目录下，进入<code>~/exampleB1/disk/bin</code>目录，运行<code>.exe</code>文件。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; cp *.mac ~\exampleB1\disk\bin\</span><br><span class="line">&gt; <span class="built_in">cd</span> ~/exampleB1/disk/bin</span><br><span class="line">&gt; .\exampleB1.exe</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/28/6269f7268fadf.png" alt="图10 exampleB1"/></div><span class="image-caption">图10 exampleB1</span></div><h4 id="分析">分析<a class="header-anchor" href="#分析">¶</a></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">|-- include</span><br><span class="line">|   |-- *.hh</span><br><span class="line">|-- src</span><br><span class="line">|   `-- *.cc</span><br><span class="line">|-- CMakeLists.txt</span><br><span class="line">|-- GNUmakefile</span><br><span class="line">|-- exampleB1.cc</span><br><span class="line">`-- *.mac</span><br></pre></td></tr></table></figure><p>目录下主要有<code>include</code>和<code>src</code>两个目录，存放的是自定义的头文件及其源文件；<code>CMakeLists.txt</code>，<code>GNUmakefile</code>是用于编译的配置文件，我们只需要用到<code>CMakeLists.txt</code>；<code>exampleB1.cc</code>是程序的主文件，程序入口也在该文件中；<code>*.mac</code>可以存储需要运行的命令，作为脚本运行。</p><p><code>Geant4</code>中主要有4个概念，分别为<code>Run</code>，<code>Event</code>，<code>Step</code>，<code>Track</code>：</p><ul><li><code>Run</code>：一次模拟过程，注意一个程序中可以进行多次模拟</li><li><code>Event</code>：一次入射事件，每次入射事件可能入射多个粒子，注意包含次级粒子的反应过程</li><li><code>Step</code>：某个粒子一次模拟的过程，是模拟的最小单位，包含有起始位置、花费时间、能量增量等粒子信息</li><li><code>Track</code>：粒子的信息，包含有该粒子的<code>Step</code>的信息</li></ul><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/29/626bd9bbb87ad.png" alt="图11 Geant4概念的联系"/></div><span class="image-caption">图11 Geant4概念的联系</span></div><p>在<code>Geant4</code>中，有一些类需要有用户自行定义，其中某些类是必须的（强制类）。在主程序中，我们需要自己编写<code>main</code>函数，并至少创建运行管理类，将强制类设置到运行管理类中。下面我们按照模拟的流程介绍<code>B1</code>示例，其中<code>G4VUserDetectorConstruction</code>、<code>G4VUserPhysicsList</code>和<code>G4VUserPrimaryGeneratorAction</code>（或其派生类）是<code>Geant4</code>的3个强制类。</p><h5 id="几何体类">几何体类<a class="header-anchor" href="#几何体类">¶</a></h5><p>我们需要从<code>G4VUserDetectorConstruction</code>类派生出具体类，并且在虚函数<code>Construct</code>中定义几何体的几何框架、材料，并进行放置。在<code>DetectorConstruction.hh</code>文件中，我们定义了<code>DetectorConstruction</code>类，其中<code>Construct</code>将会实现具体的构造，而<code>fScoringVolume</code>用于计算剂量，指定为梯形状物体（即<code>shape2</code>）。</p><figure class="highlight cpp"><figcaption><span>DetectorConstruction.hh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DetectorConstruction</span> : <span class="keyword">public</span> G4VUserDetectorConstruction &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DetectorConstruction</span>();            <span class="comment">// 构造</span></span><br><span class="line">    ~<span class="built_in">DetectorConstruction</span>() <span class="keyword">override</span>;  <span class="comment">// 构析</span></span><br><span class="line">    <span class="function">G4VPhysicalVolume* <span class="title">Construct</span><span class="params">()</span> <span class="keyword">override</span></span>;  <span class="comment">// 函数，描述探测器，返回物理体</span></span><br><span class="line">    <span class="function">G4LogicalVolume* <span class="title">GetScoringVolume</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> fScoringVolume; &#125;  <span class="comment">// 自定义计数函数 返回指针fScoringVolume</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    G4LogicalVolume* fScoringVolume = <span class="literal">nullptr</span>;  <span class="comment">// 用于计数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>Geant4</code>中一个几何体需要设置几何框架（<code>solid</code>）、材料（<code>logic</code>）、放置（<code>physical</code>）等操作，其中最大的几何体被称为<code>World volume</code>，它应该所有其他的几何体。</p><p>定义几何框架首先需要指定形状，例如长方体、圆柱、空心圆柱、圆锥等等（可参见<a href="https://geant4-userdoc.web.cern.ch/UsersGuides/ForApplicationDeveloper/html/Detector/Geometry/geomSolids.html">Solids</a>）。在本例中使用的是长方体，需要注意的是尺寸都是半数：</p><figure class="highlight cpp"><figcaption><span>DetectorConstruction.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">G4Box* solidWorld = <span class="keyword">new</span> <span class="built_in">G4Box</span>(<span class="string">&quot;World&quot;</span>, x_length, y_length, z_length);</span><br></pre></td></tr></table></figure><p>随后我们需要查找材料，部分材料在前文已经提到过，例如水（<code>G4_WATER</code>）、组织（<code>G4_A-150_TISSUE</code>）、骨（<code>G4_BONE_COMPACT_ICRU</code>）和空气（<code>G4_AIR</code>）等等（可参见<a href="https://geant4-userdoc.web.cern.ch/UsersGuides/ForApplicationDeveloper/html/Detector/material.html">Material</a>）。材料的管理是通过<code>G4NistManager</code>类实现的：</p><figure class="highlight cpp"><figcaption><span>DetectorConstruction.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">G4NistManager* nist = G4NistManager::<span class="built_in">Instance</span>();</span><br><span class="line">G4Material* world_mat = nist-&gt;<span class="built_in">FindOrBuildMaterial</span>(<span class="string">&quot;G4_AIR&quot;</span>);</span><br></pre></td></tr></table></figure><p>然后将几何框架与材料结合，构建<code>Logical Volumes</code>，只负责记录物体的几何特性，并增加了物理特性，包括材料、探针、磁场等，而不记录物体的位置信息：</p><figure class="highlight cpp"><figcaption><span>DetectorConstruction.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">G4LogicalVolume* logicWorld = <span class="keyword">new</span> <span class="built_in">G4LogicalVolume</span>(solidWorld, world_mat, <span class="string">&quot;World&quot;</span>);</span><br></pre></td></tr></table></figure><p>最后需要将几何体放置到环境中，使用<code>G4PVPlacement</code>进行，返回值是一个<code>Logical Volumes</code>的实例，被称为<code>Physical Volume</code>。由于<code>Construct</code>函数需要返回最大环境的物理体，因此我们通过<code>physWorld</code>变量进行这一操作：</p><figure class="highlight cpp"><figcaption><span>DetectorConstruction.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">G4VPhysicalVolume* physWorld = <span class="keyword">new</span> <span class="built_in">G4PVPlacement</span>(<span class="number">0</span>,                <span class="comment">// 旋转</span></span><br><span class="line">                                                <span class="built_in">G4ThreeVector</span>(),  <span class="comment">// 中心位置，World必须在 (0,0,0)</span></span><br><span class="line">                                                logicWorld,       <span class="comment">// 材料</span></span><br><span class="line">                                                <span class="string">&quot;World&quot;</span>,          <span class="comment">// 名称</span></span><br><span class="line">                                                <span class="number">0</span>,                <span class="comment">// 母体环境（Mother Volume）</span></span><br><span class="line">                                                <span class="literal">false</span>,            <span class="comment">// no boolean operation</span></span><br><span class="line">                                                <span class="number">0</span>,                <span class="comment">// copy number</span></span><br><span class="line">                                                <span class="literal">true</span>);            <span class="comment">// overlaps checking</span></span><br></pre></td></tr></table></figure><p>仿照上面的过程，我们可以定义水箱<code>Envelope</code>、圆台状物体<code>Shape1</code>和梯形状物体<code>Shape2</code>，并且将它们放置在<code>Mother Logical Volumes</code>中，而且<code>Logical Volumes</code>中可以包含多个物体：</p><figure class="highlight cpp"><figcaption><span>DetectorConstruction.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">G4Material* env_mat = nist-&gt;<span class="built_in">FindOrBuildMaterial</span>(<span class="string">&quot;G4_WATER&quot;</span>);</span><br><span class="line">G4Box* solidEnv = <span class="keyword">new</span> <span class="built_in">G4Box</span>(<span class="string">&quot;Envelope&quot;</span>, x_length, y_length, z_length);</span><br><span class="line">G4LogicalVolume* logicEnv = <span class="keyword">new</span> <span class="built_in">G4LogicalVolume</span>(solidEnv,     <span class="comment">// 几何框架</span></span><br><span class="line">                                                env_mat,      <span class="comment">// 材料</span></span><br><span class="line">                                                <span class="string">&quot;Envelope&quot;</span>);  <span class="comment">// 名称</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">G4PVPlacement</span>(<span class="number">0</span>, <span class="built_in">G4ThreeVector</span>(), logicEnv, <span class="string">&quot;Envelope&quot;</span>, logicWorld,   <span class="comment">// Mother Logical Volumes，即 World</span></span><br><span class="line">                  <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">...shape1...</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">G4PVPlacement</span>(<span class="number">0</span>, pos1, logicShape1, <span class="string">&quot;Shape1&quot;</span>, logicEnv, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">...shape2...</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">G4PVPlacement</span>(<span class="number">0</span>, pos2, logicShape2, <span class="string">&quot;Shape2&quot;</span>, logicEnv, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h5 id="物理类">物理类<a class="header-anchor" href="#物理类">¶</a></h5><p><code>G4VUserPhysicsList</code>或其派生类用于定义模拟中使用的所有粒子、物理过程和截止范围，而物理过程用于描述粒子与材料的相互作用过程。<code>PhysicsList</code>是需要由用户指定或定义的类，一般情况下我们都会使用<code>Geant4</code>提供的物理过程，例如本例中的<code>QBBC</code>一般用于医学剂量评估和空间辐射物理的模拟，适用于需要精确模拟质子和中子的低能量传输的场景，对于薄靶实验，当粒子能量低于1 GeV时，有很好的效果。</p><figure class="highlight cpp"><figcaption><span>exampleB1.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">G4VModularPhysicsList* physicsList = <span class="keyword">new</span> QBBC;</span><br></pre></td></tr></table></figure><h5 id="主事件生成类">主事件生成类<a class="header-anchor" href="#主事件生成类">¶</a></h5><p>产生初级粒子的<code>Event</code>被称为<code>Primary Events</code>，我们可以理解为粒子源，由<code>G4VUserPrimaryGeneratorAction</code>或其派生类进行定义，而实际粒子的产生则有<code>G4VPrimaryGenerator</code>或其派生类负责。<code>G4VuserPrimaryGeneratorAction</code>有一个函数为<code>GeneratePrimaries</code>，在每个<code>Event</code>开始时都会调用此方法。</p><figure class="highlight cpp"><figcaption><span>PrimaryGeneratorAction.hh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PrimaryGeneratorAction</span> : <span class="keyword">public</span> G4VUserPrimaryGeneratorAction &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">PrimaryGeneratorAction</span>();</span><br><span class="line">    ~<span class="built_in">PrimaryGeneratorAction</span>() <span class="keyword">override</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">GeneratePrimaries</span><span class="params">(G4Event*)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> G4ParticleGun* <span class="title">GetParticleGun</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> fParticleGun; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    G4ParticleGun* fParticleGun = <span class="literal">nullptr</span>;</span><br><span class="line">    G4Box* fEnvelopeBox = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在<code>GeneratePrimaries</code>我们需要使用<code>G4VPrimaryGenerator</code>或其派生类生成实际的粒子。<code>Geant4</code>为我们提供了3个具体的类为：<code>G4ParticleGun</code>，<code>G4GeneralParticleSource</code>（被称为<code>GPS</code>）和<code>G4HEPEvtInterface</code>，在<code>B1</code>中使用的是<code>G4ParticleGun</code>。</p><p><code>G4ParticleGun</code>可以生成具有给定动量和位置的初级粒子，不提供任何类型的随机化过程，但是在实际应用中我们经常需要一定的位置、能量的随机化，在<code>B1</code>例子中就需要在长方体前向面的80%范围内随机粒子的位置。我们可以在<code>GeneratePrimaries</code>函数中，调用自己编写的随机函数，生成随机的位置赋予给<code>G4ParticleGun</code>，然后再生成粒子。与<code>G4ParticleGun</code>相比，<code>G4GeneralParticleSourceGPS</code>可以定义初级粒子的能谱、空间和角分布等信息，可以更加灵活地实现随机源的生成。</p><figure class="highlight cpp"><figcaption><span>PrimaryGeneratorAction.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrimaryGeneratorAction::GeneratePrimaries</span><span class="params">(G4Event* anEvent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 几何参数用于调整源的空间分布</span></span><br><span class="line">    G4double envSizeXY = xy;</span><br><span class="line">    G4double envSizeZ = z;</span><br><span class="line">    G4double size = <span class="number">0.8</span>;</span><br><span class="line">    G4double x0 = size * envSizeXY * (<span class="built_in">G4UniformRand</span>() - <span class="number">0.5</span>);</span><br><span class="line">    G4double y0 = size * envSizeXY * (<span class="built_in">G4UniformRand</span>() - <span class="number">0.5</span>);</span><br><span class="line">    G4double z0 = <span class="number">-0.5</span> * envSizeZ;</span><br><span class="line">    <span class="comment">// 设置此次的位置并发射</span></span><br><span class="line">    fParticleGun-&gt;<span class="built_in">SetParticlePosition</span>(<span class="built_in">G4ThreeVector</span>(x0, y0, z0));  </span><br><span class="line">    fParticleGun-&gt;<span class="built_in">GeneratePrimaryVertex</span>(anEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，在<code>Event</code>之前我们需要初始化，创建<code>G4ParticleGun</code>实例，并在<code>Event</code>结束后销毁。</p><figure class="highlight cpp"><figcaption><span>PrimaryGeneratorAction.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PrimaryGeneratorAction::<span class="built_in">PrimaryGeneratorAction</span>() &#123;</span><br><span class="line">    <span class="comment">// 初始化粒子枪，每个 event 有 n_particle 个粒子</span></span><br><span class="line">    G4int n_particle = <span class="number">1</span>;</span><br><span class="line">    fParticleGun = <span class="keyword">new</span> <span class="built_in">G4ParticleGun</span>(n_particle);</span><br><span class="line">    <span class="comment">// 粒子列表的查找器</span></span><br><span class="line">    G4ParticleTable* particleTable = G4ParticleTable::<span class="built_in">GetParticleTable</span>();</span><br><span class="line">    <span class="comment">// 设置为 6 MeV 沿 z 轴正方向的 gamma 源</span></span><br><span class="line">    G4ParticleDefinition* particle = particleTable-&gt;<span class="built_in">FindParticle</span>(<span class="string">&quot;gamma&quot;</span>);</span><br><span class="line">    fParticleGun-&gt;<span class="built_in">SetParticleDefinition</span>(particle);</span><br><span class="line">    fParticleGun-&gt;<span class="built_in">SetParticleMomentumDirection</span>(<span class="built_in">G4ThreeVector</span>(<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>));</span><br><span class="line">    fParticleGun-&gt;<span class="built_in">SetParticleEnergy</span>(<span class="number">6.</span> * MeV);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PrimaryGeneratorAction::~<span class="built_in">PrimaryGeneratorAction</span>() &#123; <span class="keyword">delete</span> fParticleGun; &#125;</span><br></pre></td></tr></table></figure><h5 id="用户行为类">用户行为类<a class="header-anchor" href="#用户行为类">¶</a></h5><p>对于模拟中<code>Run</code>，<code>Event</code>，<code>Step</code>，<code>Track</code>等各个阶段，我们都可以自定义相应的行为，来实现我们需要的效果，例如统计某个物体内的沉积能量，剂量随深度的变化曲线等等。</p><p>在<code>B1</code>中我们需要获取几何体<code>Shape2</code>的吸收剂量，所以我们需要获得粒子在其中损失的能量，这一部分信息被记录在<code>Step</code>中，因此可以根据以下的逻辑实现吸收剂量的统计：判断当前<code>Step</code>是否在<code>Shape2</code>中，如果在，则将沉积能量累加给当前<code>Event</code>的一个统计变量<code>eDep</code>，在当前<code>Event</code>结束时，再将<code>eDep</code>统计给当前<code>Run</code>，在当前<code>Run</code>结束时，通过计算总沉积能量与<code>Shape2</code>的质量比值来得到吸收剂量。</p><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/30/626d376a468eb.png" alt="图12 B1统计吸收剂量的流程"/></div><span class="image-caption">图12 B1统计吸收剂量的流程</span></div><p>相应的，我们需要在<code>Run</code>，<code>Event</code>，<code>Step</code>这3个阶段，定义行为来实现统计与返回：</p><figure class="highlight cpp"><figcaption><span>SteppingAction.hh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventAction</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SteppingAction</span> : <span class="keyword">public</span> G4UserSteppingAction &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SteppingAction</span>(EventAction* eventAction);</span><br><span class="line">    ~<span class="built_in">SteppingAction</span>() <span class="keyword">override</span>;</span><br><span class="line">    <span class="comment">// 每个 step 调用一次</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">UserSteppingAction</span><span class="params">(<span class="type">const</span> G4Step*)</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    EventAction* fEventAction = <span class="literal">nullptr</span>;</span><br><span class="line">    G4LogicalVolume* fScoringVolume = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SteppingAction.cc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 fEventAction，即获取到当前 Step 所在的 Event</span></span><br><span class="line">SteppingAction::<span class="built_in">SteppingAction</span>(EventAction* eventAction) : <span class="built_in">fEventAction</span>(eventAction) &#123;&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 每个 step 调用一次</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SteppingAction::UserSteppingAction</span><span class="params">(<span class="type">const</span> G4Step* step)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这段代码的目的是获得 Shape2 所代表的 Logical Volume</span></span><br><span class="line">    <span class="keyword">if</span> (!fScoringVolume) &#123;</span><br><span class="line">        <span class="type">const</span> DetectorConstruction* detConstruction =</span><br><span class="line">            <span class="built_in">static_cast</span>&lt;<span class="type">const</span> DetectorConstruction*&gt;(G4RunManager::<span class="built_in">GetRunManager</span>()-&gt;<span class="built_in">GetUserDetectorConstruction</span>());</span><br><span class="line">        fScoringVolume = detConstruction-&gt;<span class="built_in">GetScoringVolume</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取当前的 Volume</span></span><br><span class="line">    G4LogicalVolume* volume = step-&gt;<span class="built_in">GetPreStepPoint</span>()-&gt;<span class="built_in">GetTouchableHandle</span>()-&gt;<span class="built_in">GetVolume</span>()-&gt;<span class="built_in">GetLogicalVolume</span>();</span><br><span class="line">    <span class="comment">// 检查是否在计算的 Volume （Shape 2）</span></span><br><span class="line">    <span class="keyword">if</span> (volume != fScoringVolume) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 获取当前 step 的沉积能量</span></span><br><span class="line">    G4double edepStep = step-&gt;<span class="built_in">GetTotalEnergyDeposit</span>();</span><br><span class="line">    fEventAction-&gt;<span class="built_in">AddEdep</span>(edepStep);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption><span>EventAction.hh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RunAction</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventAction</span> : <span class="keyword">public</span> G4UserEventAction &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">EventAction</span>(RunAction* runAction);</span><br><span class="line">    ~<span class="built_in">EventAction</span>() <span class="keyword">override</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">BeginOfEventAction</span><span class="params">(<span class="type">const</span> G4Event* event)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">EndOfEventAction</span><span class="params">(<span class="type">const</span> G4Event* event)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="comment">// 对每个 step 累加，最后一个 step 输出一个 event 的能量沉积</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">AddEdep</span><span class="params">(G4double edep)</span> </span>&#123; fEdep += edep; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    RunAction* fRunAction = <span class="literal">nullptr</span>;</span><br><span class="line">    G4double fEdep = <span class="number">0.</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EventAction.cc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 fEventAction，即获取到当前 Event 所在的 Run</span></span><br><span class="line">EventAction::<span class="built_in">EventAction</span>(RunAction* runAction) : <span class="built_in">fRunAction</span>(runAction) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventAction::BeginOfEventAction</span><span class="params">(<span class="type">const</span> G4Event*)</span> </span>&#123; fEdep = <span class="number">0.</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventAction::EndOfEventAction</span><span class="params">(<span class="type">const</span> G4Event*)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 将 event 中的沉积能量返回给 run</span></span><br><span class="line">    fRunAction-&gt;<span class="built_in">AddEdep</span>(fEdep);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption><span>RunAction.hh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RunAction</span> : <span class="keyword">public</span> G4UserRunAction &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">RunAction</span>();</span><br><span class="line">    ~<span class="built_in">RunAction</span>() <span class="keyword">override</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">BeginOfRunAction</span><span class="params">(<span class="type">const</span> G4Run*)</span> <span class="keyword">override</span></span>;  <span class="comment">// Run 开始时执行</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">EndOfRunAction</span><span class="params">(<span class="type">const</span> G4Run*)</span> <span class="keyword">override</span></span>;    <span class="comment">// Run 结束时执行</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">AddEdep</span><span class="params">(G4double edep)</span></span>;  <span class="comment">// 计算累计沉积的能量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    G4Accumulable&lt;G4double&gt; fEdep = <span class="number">0.</span>;</span><br><span class="line">    G4Accumulable&lt;G4double&gt; fEdep2 = <span class="number">0.</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RunAction.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RunAction::EndOfRunAction</span><span class="params">(<span class="type">const</span> G4Run* run)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// event 的数目</span></span><br><span class="line">    G4int nofEvents = run-&gt;<span class="built_in">GetNumberOfEvent</span>();</span><br><span class="line">    <span class="keyword">if</span> (nofEvents == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 合并累加的值</span></span><br><span class="line">    G4AccumulableManager* accumulableManager = G4AccumulableManager::<span class="built_in">Instance</span>();</span><br><span class="line">    accumulableManager-&gt;<span class="built_in">Merge</span>();</span><br><span class="line">    <span class="comment">// 计算总沉积能量</span></span><br><span class="line">    G4double edep = fEdep.<span class="built_in">GetValue</span>();</span><br><span class="line">    <span class="comment">// 剂量 =  / 质量</span></span><br><span class="line">    <span class="type">const</span> DetectorConstruction* detConstruction =</span><br><span class="line">        <span class="built_in">static_cast</span>&lt;<span class="type">const</span> DetectorConstruction*&gt;(G4RunManager::<span class="built_in">GetRunManager</span>()-&gt;<span class="built_in">GetUserDetectorConstruction</span>());</span><br><span class="line">    G4double mass = detConstruction-&gt;<span class="built_in">GetScoringVolume</span>()-&gt;<span class="built_in">GetMass</span>();</span><br><span class="line">    G4double dose = edep / mass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="lazyload lazyload-gif zooming" src="https://asset.foolishfox.cn/2022/04/29/626bda2ae29da.png" alt="图13 统计过程中的调用关系（点击放大）"/></div><span class="image-caption">图13 统计过程中的调用关系（点击放大）</span></div><h5 id="初始化与管理类">初始化与管理类<a class="header-anchor" href="#初始化与管理类">¶</a></h5><p>实现了各种强制类和用户行为的定义后，我们需要回到<code>main</code>函数，将这些类添加到运行中，其中首先要做的就是创建<code>G4RunManager</code>类的一个实例，它负责管理整个模拟进程的运行与循环，有多线程下的<code>G4MTRunManager</code>类和其他情况下的<code>G4RunManager</code>类两种，通过<code>G4RunManagerFactory</code>可以自动识别是否创建多线程类。</p><figure class="highlight cpp"><figcaption><span>exampleB1.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span>* runManager = G4RunManagerFactory::<span class="built_in">CreateRunManager</span>(G4RunManagerType::Default);</span><br></pre></td></tr></table></figure><p><code>G4RunManager</code>还负责进行初始化，即前文所说的强制类与用户行为。为了方便进行初始化，我们从<code>G4VUserActionInitialization</code>派生出<code>ActionInitialization</code>用于统筹所有的用户自定义行为和粒子生成：</p><figure class="highlight cpp"><figcaption><span>ActionInitialization.hh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ActionInitialization</span> : <span class="keyword">public</span> G4VUserActionInitialization &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ActionInitialization</span>();</span><br><span class="line">    ~<span class="built_in">ActionInitialization</span>() <span class="keyword">override</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">BuildForMaster</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;  <span class="comment">// 多线程的用户行为初始化</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;           <span class="comment">// 单线程的用户行为初始化</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ActionInitialization::BuildForMaster</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    RunAction* runAction = <span class="keyword">new</span> RunAction;</span><br><span class="line">    <span class="built_in">SetUserAction</span>(runAction);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ActionInitialization.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ActionInitialization::Build</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="built_in">SetUserAction</span>(<span class="keyword">new</span> PrimaryGeneratorAction);</span><br><span class="line">    RunAction* runAction = <span class="keyword">new</span> RunAction;</span><br><span class="line">    <span class="built_in">SetUserAction</span>(runAction);</span><br><span class="line">    EventAction* eventAction = <span class="keyword">new</span> <span class="built_in">EventAction</span>(runAction);</span><br><span class="line">    <span class="built_in">SetUserAction</span>(eventAction);</span><br><span class="line">    <span class="built_in">SetUserAction</span>(<span class="keyword">new</span> <span class="built_in">SteppingAction</span>(eventAction));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>随后我们在<code>G4RunManager</code>中设置用户初始化为<code>ActionInitialization</code>，同时加入其他的强制类：</p><figure class="highlight cpp"><figcaption><span>exampleB1.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">runManager-&gt;<span class="built_in">SetUserInitialization</span>(<span class="keyword">new</span> <span class="built_in">DetectorConstruction</span>());</span><br><span class="line">runManager-&gt;<span class="built_in">SetUserInitialization</span>(<span class="keyword">new</span> QBBC);</span><br><span class="line">runManager-&gt;<span class="built_in">SetUserInitialization</span>(<span class="keyword">new</span> <span class="built_in">ActionInitialization</span>());</span><br></pre></td></tr></table></figure><h5 id="运行模式">运行模式<a class="header-anchor" href="#运行模式">¶</a></h5><p><code>Geant4</code>的运行可以分为4种模式：写在代码中的纯硬编码批处理模式、读取文件（<code>macro of commands</code>）的批处理模式、基于命令行的交互模式、基于图形界面的交互模式。一般情况下我们会使用图形界面的交互模式进行<code>Debug</code>与展示，通过读取文件的批处理模式进行实际模拟，因此我们也可以在代码中实现两种模式的切换。</p><p>在<code>main</code>函数的参数中，会有<code>argc</code>提供命令参数的个数，字符串数组<code>argv</code>提供具体的命令参数，而默认的第一个参数是可执行文件本身，因此我们可以根据参数的个数，进行模式的判断：</p><figure class="highlight cpp"><figcaption><span>exampleB1.cc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// argc 为 1 时，说明参数只有可执行文件本身，运行在GUI模式下</span></span><br><span class="line">    <span class="comment">// 如果 argc 不为 1，则运行在 batch mode，例如 example.exe run1.mac</span></span><br><span class="line">    G4UIExecutive* ui = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span>) &#123;</span><br><span class="line">        ui = <span class="keyword">new</span> <span class="built_in">G4UIExecutive</span>(argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 根据模式，选择开始进行模拟，或打开GUI</span></span><br><span class="line">    <span class="keyword">if</span> (!ui) &#123;</span><br><span class="line">        <span class="comment">// batch mode via reading a macro of commands</span></span><br><span class="line">        G4String command = <span class="string">&quot;/control/execute &quot;</span>;</span><br><span class="line">        G4String fileName = argv[<span class="number">1</span>];</span><br><span class="line">        UImanager-&gt;<span class="built_in">ApplyCommand</span>(command + fileName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// interactive mode via a Graphical User Interface</span></span><br><span class="line">        UImanager-&gt;<span class="built_in">ApplyCommand</span>(<span class="string">&quot;/control/execute init_vis.mac&quot;</span>);</span><br><span class="line">        ui-&gt;<span class="built_in">SessionStart</span>();</span><br><span class="line">        <span class="keyword">delete</span> ui;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="常用命令">常用命令<a class="header-anchor" href="#常用命令">¶</a></h5><p>在读取文件的批处理模式下，我们将需要用到的命令保存在<code>.mac</code>文件中，我们可以通过命令更改初始条件，指定发射粒子的类别、位置、能量等信息，改变几何、角度等。其中最常用的两条命令为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/run/initialize     // 初始化</span><br><span class="line">/run/beamOn 1000    // 运行一次模拟，包含1000个粒子</span><br></pre></td></tr></table></figure><p>此外，比较常用的命令还有：</p><ol><li>粒子枪</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/gun/particle proton   // 设定为光子</span><br><span class="line">/gun/energy 210 MeV    // 能量为 210 MeV</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ol start="2"><li>输出控制<br>许多类都有一个<code>verbose</code>表示，用于控制输出的详细程度，当<code>verbose=0</code>时，不会有任何输出，后面的数字越大输出越详细，最大为4。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/run/verbose 2</span><br><span class="line">/event/verbose 1</span><br><span class="line">/tracking/verbose 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ol start="3"><li>网格划分<br>推荐观看<a href="https://www.bilibili.com/video/BV1G54y1S7U2">在Geant4中关于Command-based Scoring基于命令计数器的用法</a></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/score/create/boxMesh water_box          // 定义一个网格</span><br><span class="line">/score/mesh/boxSize 319. 315. 277.5 mm   // 设置尺寸</span><br><span class="line">/score/mesh/nBin 1 1 555                 // 分bin的数目</span><br><span class="line"></span><br><span class="line">/score/quantity/energyDeposit eDep       // 想要获取的物理信息：剂量</span><br><span class="line">/score/quantity/doseDeposit Dose         // 想要获取的物理信息：沉积能量</span><br><span class="line"></span><br><span class="line">/score/dumpQuantityToFile water_box eDep eDep_1.txt   // 导出获取的物理信息：剂量</span><br><span class="line">/score/dumpQuantityToFile water_box Dose Dose_1.txt   // 导出获取的物理信息：沉积能量</span><br></pre></td></tr></table></figure><p>更多的命令或者命令的说明，可以在GUI模式下的左侧帮助手册中查询，也可以查看推荐阅读材料中的<code>Geant4 Commands</code>进行在线查询。</p><h3 id="水箱模型">水箱模型<a class="header-anchor" href="#水箱模型">¶</a></h3><p>放疗水箱常用于放疗装置的剂量校准，其尺寸为（x=638mm，y=630mm，z=555mm）。现假设一笔形束从x-y平面中心处，自水箱外向下射入放疗水箱。请用<code>Geant4</code>模拟计算不同能量的光子（1MeV、5MeV、10MeV）入射后在放疗水箱的z方向上的吸收剂量变化曲线。</p><p>这是一个非常简单的示例，首先定义几何体：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">G4NistManager* nist = G4NistManager::<span class="built_in">Instance</span>();</span><br><span class="line">G4Box* solid_world = <span class="keyword">new</span> <span class="built_in">G4Box</span>(<span class="string">&quot;world&quot;</span>, <span class="number">638</span> / <span class="number">2</span> * mm, <span class="number">630</span> / <span class="number">2</span> * mm, <span class="number">555.</span> / <span class="number">2</span> * mm);</span><br><span class="line">G4LogicalVolume* logic_world = <span class="keyword">new</span> <span class="built_in">G4LogicalVolume</span>(solid_world, nist-&gt;<span class="built_in">FindOrBuildMaterial</span>(<span class="string">&quot;G4_WATER&quot;</span>), <span class="string">&quot;world&quot;</span>);</span><br><span class="line">G4VPhysicalVolume* physics_world = <span class="keyword">new</span> <span class="built_in">G4PVPlacement</span>(<span class="number">0</span>, <span class="built_in">G4ThreeVector</span>(), logic_world, <span class="string">&quot;world&quot;</span>, <span class="number">0</span>, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>随后在<code>.mac</code>中进行网格划分与模拟：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/score/create/boxMesh water_box</span><br><span class="line">/score/mesh/boxSize 319. 315. 277.5 mm</span><br><span class="line">/score/mesh/nBin 1 1 555</span><br><span class="line">/score/quantity/energyDeposit eDep</span><br><span class="line">/score/quantity/doseDeposit Dose</span><br><span class="line">/score/close</span><br><span class="line"></span><br><span class="line">/gun/particle gamma</span><br><span class="line">/gun/energy 1 MeV</span><br><span class="line">/run/beamOn 100000</span><br><span class="line">/score/dumpQuantityToFile water_box eDep eDep_1.txt</span><br><span class="line">/score/dumpQuantityToFile water_box Dose Dose_1.txt</span><br><span class="line"></span><br><span class="line">/gun/energy 5 MeV</span><br><span class="line">/run/beamOn 100000</span><br><span class="line">/score/dumpQuantityToFile water_box eDep eDep_5.txt</span><br><span class="line">/score/dumpQuantityToFile water_box Dose Dose_5.txt</span><br><span class="line"></span><br><span class="line">/gun/particle gamma</span><br><span class="line">/gun/energy 10 MeV</span><br><span class="line">/run/beamOn 100000</span><br><span class="line">/score/dumpQuantityToFile water_box eDep eDep_10.txt</span><br><span class="line">/score/dumpQuantityToFile water_box Dose Dose_10.txt</span><br></pre></td></tr></table></figure><p>其余部分参考<code>B1</code>示例。</p><h2 id="附录">附录<a class="header-anchor" href="#附录">¶</a></h2><h3 id="示例源码">示例源码<a class="header-anchor" href="#示例源码">¶</a></h3><ol><li><a href="https://git.foolishfox.cn/fox/G4-ExampleB1">exampleB1带注释代码</a></li><li><a href="https://git.foolishfox.cn/fox/G4-ExampleB0">水箱模型</a></li></ol><h3 id="CMakeLists">CMakeLists<a class="header-anchor" href="#CMakeLists">¶</a></h3><p>很多人在尝试编译示例时，会有以下错误：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CMake Error at CMakeLists.txt:16 (find_package):</span><br><span class="line">By not providing &quot;FindGeant4.cmake&quot; in CMAKE_MODULE_PATH this project has</span><br><span class="line">asked CMake to find a package configuration file provided by &quot;Geant4&quot;, but</span><br><span class="line">CMake did not find one.</span><br><span class="line"></span><br><span class="line">Could not find a package configuration file provided by &quot;Geant4&quot; with any</span><br><span class="line">of the following names:</span><br><span class="line"></span><br><span class="line">Geant4Config.cmake</span><br><span class="line">geant4-config.cmake</span><br><span class="line"></span><br><span class="line">Add the installation prefix of &quot;Geant4&quot; to CMAKE_PREFIX_PATH or set</span><br><span class="line">&quot;Geant4_DIR&quot; to a directory containing one of the above files.  If &quot;Geant4&quot;</span><br><span class="line">provides a separate development package or SDK, be sure it has been</span><br><span class="line">installed.</span><br></pre></td></tr></table></figure><p>可以在<code>CMakeLists.txt</code>文件中添加一行即可解决：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.16</span>)</span><br><span class="line"><span class="keyword">set</span>(Geant4_DIR D:/Geant4/dist/lib/Geant4-<span class="number">11.0</span>.<span class="number">1</span>)</span><br><span class="line"><span class="keyword">project</span>(exampleB0)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="参考资料">参考资料<a class="header-anchor" href="#参考资料">¶</a></h2><ol><li><a href="https://geant4-userdoc.web.cern.ch/UsersGuides/InstallationGuide/html/index.html">Installation Guide</a></li><li><a href="https://www.bilibili.com/video/BV1yz4y1k7gP">Geant4入门教程</a></li><li><a href="https://blog.csdn.net/sinat_33249803/article/details/116067709">Geant4学习——入门(基本概念、Geant4工具包的结构、强制类、可选类)</a></li><li><a href="https://zhuanlan.zhihu.com/p/64271648">Geant4–是怎样使用的？–（1.信息抽取）</a></li><li><a href="https://zhuanlan.zhihu.com/p/60615096">Geant4入门讲解篇-1</a></li></ol><h2 id="推荐阅读">推荐阅读<a class="header-anchor" href="#推荐阅读">¶</a></h2><ol><li><a href="https://geant4-userdoc.web.cern.ch/UsersGuides/ForApplicationDeveloper/html/index.html">Book For Application Developers</a></li><li><a href="https://geant4-userdoc.web.cern.ch/UsersGuides/PhysicsReferenceManual/html/index.html">Physics Reference Manual</a></li><li><a href="https://geant4-userdoc.web.cern.ch/UsersGuides/PhysicsListGuide/html/index.html">Guide for Physics Lists</a></li><li><a href="https://www.hep.ph.ic.ac.uk/~yoshiu/COMET/comet_g4HTMLdoc/">Geant4 Commands</a></li><li><a href="https://space.bilibili.com/30515356">liuchangqi</a></li><li><a href="https://www.bilibili.com/video/BV1G54y1S7U2">在Geant4中关于Command-based Scoring基于命令计数器的用法</a></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;code&gt;Geant4&lt;/code&gt;(GEometry ANd Tracking，几何和跟踪)是由&lt;code&gt;CERN&lt;/code&gt;(欧洲核子研究组织)基于&lt;code&gt;C++&lt;/code&gt;面向对象技术开发的蒙特卡罗应用软件包，用于模拟粒子与物质的相互作用，在高能物理、加速器、核物理、辐射防护等多个领域都有着广泛的应用。&lt;/p&gt;</summary>
    
    
    
    <category term="软件/程序" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/"/>
    
    <category term="Geant4" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/Geant4/"/>
    
    
    <category term="教程" scheme="https://foolishfox.cn/tags/%E6%95%99%E7%A8%8B/"/>
    
    <category term="核技术" scheme="https://foolishfox.cn/tags/%E6%A0%B8%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Geant4" scheme="https://foolishfox.cn/tags/Geant4/"/>
    
  </entry>
  
  <entry>
    <title>服务器安装Jupyter Lab（Python与R环境）</title>
    <link href="https://foolishfox.cn/posts/202112-pyr_jupyter.html"/>
    <id>https://foolishfox.cn/posts/202112-pyr_jupyter.html</id>
    <published>2021-12-02T12:24:57.000Z</published>
    <updated>2021-12-02T12:24:57.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言<a class="header-anchor" href="#前言">¶</a></h2><p>这学期学的《概率论与数理统计》课有作业需要用到R，加上双十一从腾讯云搞了一台2H4G8M的机器，性能大大提升，因此打算打造一个云服务来运行Python，同时兼顾R。</p><p>在安装的过程中碰到了超级多的问题，所以下面介绍一下安装的流程，记录一些很久才解决的问题。</p><span id="more"></span><div class="note info flat"><p><strong>系统信息</strong><br>OS: Ubuntu 20.04<br>Python: 3.8.10</p></div><h2 id="方案">方案<a class="header-anchor" href="#方案">¶</a></h2><p>目前常用的方式是<code>Anaconda</code>+<code>R</code>(使用<code>apt</code>安装)，而<code>Anaconda</code>会安装很多不必要的包，而在服务器（无图形界面）使用<code>apt</code>安装的<code>R</code>中的画图功能需要安装<code>X11</code>的相关环境，还不一定能搞定，所以最终采用的方案如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./</span><br><span class="line">├─pycal              Python虚拟环境</span><br><span class="line">├─rsource            R安装包的源代码</span><br><span class="line">├─rcal               自定义安装的R</span><br><span class="line">├─project            项目文件夹</span><br><span class="line">│  ├─R               R项目</span><br><span class="line">│  └─Python          Python项目</span><br><span class="line">└─requirements.txt   Python需要的包</span><br></pre></td></tr></table></figure><h2 id="安装">安装<a class="header-anchor" href="#安装">¶</a></h2><h3 id="Python相关环境">Python相关环境<a class="header-anchor" href="#Python相关环境">¶</a></h3><h4 id="安装虚拟环境">安装虚拟环境<a class="header-anchor" href="#安装虚拟环境">¶</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python -m venv pycal</span><br><span class="line"><span class="built_in">source</span> pycal/bin/activate</span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure><h4 id="Jupyter初步配置">Jupyter初步配置<a class="header-anchor" href="#Jupyter初步配置">¶</a></h4><ol><li>生成配置文件</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter lab --generate-config</span><br></pre></td></tr></table></figure><p>如果是<code>root</code>用户，可以在后面添加<code>--allow-root</code>，完成后会返回配置文件位置。</p><div class="note danger flat"><p><code>ValueError: Can not patch loop of type &lt;class 'NoneType'&gt;</code><br>这是由于<code>nest_asyncio</code>的bug导致的，将其版本回退为<code>1.5.1</code>即可解决。<sup><a href="#fn3">[3]</a></sup></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip uninstall nest_asyncio</span><br><span class="line">pip install nest_asyncio==1.5.1</span><br></pre></td></tr></table></figure></div><ol start="2"><li>生成密码</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(pycal) ~/calhub ❯❯❯ ipython</span><br><span class="line">Python <span class="number">3.8</span><span class="number">.10</span> (default, Sep <span class="number">28</span> <span class="number">2021</span>, <span class="number">16</span>:<span class="number">10</span>:<span class="number">42</span>) </span><br><span class="line"><span class="type">Type</span> <span class="string">&#x27;copyright&#x27;</span>, <span class="string">&#x27;credits&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;license&#x27;</span> <span class="keyword">for</span> more information</span><br><span class="line">IPython <span class="number">7.30</span><span class="number">.0</span> -- An enhanced Interactive Python. <span class="type">Type</span> <span class="string">&#x27;?&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>.</span><br><span class="line"></span><br><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> notebook.auth <span class="keyword">import</span> passwd</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: passwd(<span class="string">&quot;password&quot;</span>, <span class="string">&#x27;sha1&#x27;</span>)</span><br><span class="line">Out[<span class="number">2</span>]: <span class="string">&#x27;sha1:c3354c486202:4ddc858c5be0eef7b78547c6210c0d65df1023e9&#x27;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>修改配置</li></ol><p>修改配置文件，路径在<code>2.1</code>中给出，一般为<code>~/.jupyter/jupyter_lab_config.py</code>；在这一步后可以启动<code>jupyter lab</code>，访问<code>http://[ip]:port</code>进行预览。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c.ServerApp.ip = <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line">c.ServerApp.open_browser = <span class="literal">False</span></span><br><span class="line">c.ServerApp.password = <span class="string">u&#x27;sha1:c3354c486202:4ddc858c5be0eef7b78547c6210c0d65df1023e9&#x27;</span> <span class="comment"># 2.2中得到的加密密码</span></span><br><span class="line">c.ServerApp.port = <span class="number">8080</span> <span class="comment"># 自定义端口</span></span><br><span class="line">c.ServerApp.root_dir = <span class="string">&#x27;~/calhub/project&#x27;</span> <span class="comment"># 自定义工作目录</span></span><br></pre></td></tr></table></figure><div class="note warning flat"><p>注意要在服务器的管理面板放行相关端口。</p></div><h3 id="R相关环境">R相关环境<a class="header-anchor" href="#R相关环境">¶</a></h3><h4 id="下载">下载<a class="header-anchor" href="#下载">¶</a></h4><p>为了避免<code>X11</code>的配置问题，采用编译安装<code>R</code>的方式。从<code>CRAN</code>下载源代码（推荐<a href="https://mirrors.tuna.tsinghua.edu.cn/CRAN/">清华镜像源</a>），将其解压：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/CRAN/src/base/R-4/R-4.1.2.tar.gz</span><br><span class="line">tar -zxvf R-4.1.2.tar.gz</span><br><span class="line"><span class="built_in">mv</span> R-4.1.2 rsource &amp;&amp; <span class="built_in">cd</span> rsource</span><br></pre></td></tr></table></figure><h4 id="安装前配置">安装前配置<a class="header-anchor" href="#安装前配置">¶</a></h4><div class="note info flat"><p>有问题，多看手册：<a href="https://cran.r-project.org/doc/manuals/r-release/R-admin.html">R Installation and Administration</a></p></div><p>在安装之前，我们需要先通过<code>rsource</code>目录下的<code>configure</code>文件生成安装的配置文件，在安装中我们需要指定<code>Cairo</code>代替<code>X11</code>环境（<code>--with-x=no</code>和<code>--with-cairo</code>），同时指定相应的图片格式（如<code>--with-libpng</code>代表<code>png</code>格式），还可以指定<code>R</code>的安装位置（<code>--prefix=your path</code>）。运行[^2]：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=~/calhub/rcal --with-libpng --with-jpeglib --with-libtiff --with-x=no --with-cairo</span><br></pre></td></tr></table></figure><div class="note warning flat"><p>在这一步骤前，请先确认服务器上安装有以下包：<code>libcairo2-dev</code>、<code>libjpeg-dev</code>、<code>libtiff-dev</code>、<code>libpng-dev</code>。</p></div><div class="note danger flat"><p><code>configure: error: No Fortran compiler found</code><br>直接安装<code>Fortran</code>的编译器即可，如<code>sudo apt install gfortran</code>。</p></div><div class="note danger flat"><p><code>configure: error: –with-readline=yes (default) and headers/libs are not available</code><br>安装<code>readline</code>：<code>sudo apt install libreadline6-dev</code></p></div><div class="note info flat"><p><code>configure: WARNING: you cannot build info or HTML versions of the R manuals</code><br>这个问题是无法获取<code>R</code>手册的html版本，通过<code>sudo apt install texinfo</code>解决。</p></div><h4 id="安装-v2">安装<a class="header-anchor" href="#安装-v2">¶</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make check</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h4 id="安装后配置">安装后配置<a class="header-anchor" href="#安装后配置">¶</a></h4><ol><li>确认正常</li></ol><p>进入<code>R</code>环境（可以将<code>~/calhub/rcal/bin</code>加入环境变量），查看<code>cairo</code>是否启用，各类图片是否支持。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">(</span>pycal<span class="punctuation">)</span> <span class="operator">~</span><span class="operator">/</span>calhub ❯❯❯ .<span class="operator">/</span>rcal<span class="operator">/</span>bin<span class="operator">/</span>R</span><br><span class="line">R version <span class="number">4.1</span>.2 <span class="punctuation">(</span><span class="number">2021</span><span class="operator">-</span><span class="number">11</span><span class="operator">-</span><span class="number">01</span><span class="punctuation">)</span> <span class="operator">-</span><span class="operator">-</span> <span class="string">&quot;Bird Hippie&quot;</span></span><br><span class="line">...</span><br><span class="line">Type <span class="string">&#x27;q()&#x27;</span> to quit R.</span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> capabilities<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">       jpeg         png        tiff       tcltk         X11        aqua </span><br><span class="line">       <span class="literal">TRUE</span>        <span class="literal">TRUE</span>        <span class="literal">TRUE</span>       <span class="literal">FALSE</span>       <span class="literal">FALSE</span>       <span class="literal">FALSE</span> </span><br><span class="line">   http<span class="operator">/</span>ftp     sockets      libxml        fifo      cledit       iconv </span><br><span class="line">       <span class="literal">TRUE</span>        <span class="literal">TRUE</span>        <span class="literal">TRUE</span>        <span class="literal">TRUE</span>        <span class="literal">TRUE</span>        <span class="literal">TRUE</span> </span><br><span class="line">        NLS       Rprof     profmem       cairo         ICU long.double </span><br><span class="line">       <span class="literal">TRUE</span>        <span class="literal">TRUE</span>       <span class="literal">FALSE</span>        <span class="literal">TRUE</span>        <span class="literal">TRUE</span>        <span class="literal">TRUE</span> </span><br><span class="line">    libcurl </span><br><span class="line">       <span class="literal">TRUE</span> </span><br></pre></td></tr></table></figure><ol start="2"><li>配置<code>~/.Rprofile</code></li></ol><p><code>.Rprofile</code>文件是<code>R</code>的开始配置文件（<code>Startup Configuration</code>），一般情况下在用户目录下建立该文件即可，也可以在工作目录或者<code>R</code>的安装目录编写[^3]。通过该文件，我们指定图片默认使用<code>cairo</code>，安装默认使用清华镜像源。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Set default &#x27;type&#x27; for png() calls - useful when X11 device is not available!</span></span><br><span class="line"><span class="comment">## <span class="doctag">NOTE:</span> Needs &#x27;cairo&#x27; capability</span></span><br><span class="line">options<span class="punctuation">(</span>bitmapType<span class="operator">=</span><span class="string">&#x27;cairo&#x27;</span><span class="punctuation">)</span></span><br><span class="line">options<span class="punctuation">(</span><span class="string">&quot;repos&quot;</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>CRAN<span class="operator">=</span><span class="string">&quot;https://mirrors.tuna.tsinghua.edu.cn/CRAN/&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;\nWelcome at&quot;</span><span class="punctuation">,</span> date<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><ol start="3"><li>安装<code>Cairo</code></li></ol><p>安装<code>Cairo</code>，并查看是否支持各类图片格式。（未尝试过不安装是否可以）</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> install.packages<span class="punctuation">(</span><span class="string">&quot;Cairo&quot;</span><span class="punctuation">)</span></span><br><span class="line">...</span><br><span class="line"><span class="operator">&gt;</span> library<span class="punctuation">(</span><span class="string">&quot;Cairo&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> Cairo.capabilities<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">   png   jpeg   tiff    pdf    svg     ps    x11    win raster </span><br><span class="line">  <span class="literal">TRUE</span>   <span class="literal">TRUE</span>   <span class="literal">TRUE</span>   <span class="literal">TRUE</span>   <span class="literal">TRUE</span>   <span class="literal">TRUE</span>   <span class="literal">TRUE</span>  <span class="literal">FALSE</span>   <span class="literal">TRUE</span></span><br></pre></td></tr></table></figure><div class="note danger flat"><p><code>ERROR: configuration failed for package ''Cairo'</code><br>服务器没有安装<code>cairo</code>的包，通过<code>sudo apt install libcairo2-dev</code>解决。</p></div><div class="note danger flat"><p><code>fatal error: X11/Intrinsic.h: No such file or directory</code><br>这个包是在编译安装<code>cairo</code>过程中需要用到的，通过<code>sudo apt install libxt-dev</code>解决。<sup><a href="#fn4">[4]</a></sup></p></div><h3 id="Jupyter配置">Jupyter配置<a class="header-anchor" href="#Jupyter配置">¶</a></h3><h4 id="添加R-kernel">添加<code>R kernel</code><a class="header-anchor" href="#添加R-kernel">¶</a></h4><ol><li>安装依赖包</li></ol><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> install.packages<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;repr&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;IRdisplay&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;evaluate&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;crayon&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;pbdZMQ&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;devtools&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;uuid&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;digest&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><div class="note danger flat"><p><code>installation of package 'devtools'/'gert'/'phangorn' had non-zero exit status</code><br>通过单独安装某个包（例如<code>install.packages(&quot;devtools&quot;)</code>）的方式，可以获取报错，发现都是因为<code>git2</code>导致的，通过<code>sudo apt install libgit2-dev</code>解决。<sup><a href="#fn5">[5]</a></sup></p></div><ol start="2"><li>安装<code>kernel</code></li></ol><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> devtools<span class="operator">::</span>install_github<span class="punctuation">(</span><span class="string">&#x27;IRkernel/IRkernel&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><div class="note warning flat"><p>这一步对网络的要求比较高，可以设置代理进行。</p></div><div class="note danger flat"><p><code>Error in loadNamespace(i, c(lib.loc, .libPaths()), versionCheck = vI[[i]]) : 载入了名字空间'rlang' 0.2.2，但需要的是&gt;= 0.3.0</code><br>先卸载<code>rlang</code>包，再重新安装：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> remove.packages<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;rlang&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span> lib<span class="operator">=</span>file.path<span class="punctuation">(</span><span class="string">&#x27;包所在位置&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="operator">&gt;</span> remove.packages<span class="punctuation">(</span><span class="string">&#x27;rlang&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> install.packages<span class="punctuation">(</span><span class="string">&#x27;rlang&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure></div><ol start="3"><li>添加<code>kernel</code></li></ol><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给自己安装</span></span><br><span class="line"><span class="operator">&gt;</span> IRkernel<span class="operator">::</span>installspec<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 给系统安装</span></span><br><span class="line"><span class="operator">&gt;</span> IRkernel<span class="operator">::</span>installspec<span class="punctuation">(</span>user <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>输出会给出<code>kernel</code>路径，如<code>Installed kernelspec ir in ~/.local/share/jupyter/kernels/ir</code>。</p><h4 id="Nginx配置">Nginx配置<a class="header-anchor" href="#Nginx配置">¶</a></h4><p>在完成上述步骤后，可以通过<code>http://ip:port</code>的方式进行访问，如果需要绑定域名，我们还需要对Nginx进行配置，主要是实现<code>WebSocker</code>转发。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> REMOTE-HOST <span class="variable">$remote_addr</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 持久化连接相关配置实现wss转发</span></span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span> <span class="number">30s</span>;</span><br><span class="line">    <span class="attribute">proxy_read_timeout</span> <span class="number">86400s</span>;</span><br><span class="line">    <span class="attribute">proxy_send_timeout</span> <span class="number">30s</span>;</span><br><span class="line">    <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">    <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">add_header</span> X-Cache <span class="variable">$upstream_cache_status</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#Set Nginx Cache</span></span><br><span class="line">    <span class="attribute">add_header</span> Cache-Control <span class="literal">no</span>-cache;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="服务与插件">服务与插件<a class="header-anchor" href="#服务与插件">¶</a></h2><h3 id="服务设置">服务设置<a class="header-anchor" href="#服务设置">¶</a></h3><p>为了使<code>Jupyter</code>在后台长期运行，可以选择使用<code>nohup</code>，或者使用类似于<code>tmux</code>的应用，也可以选择创建系统服务：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">## /usr/lib/systemd/system/jupyter.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Jupyter Lab</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=ubuntu</span><br><span class="line">Group=ubuntu</span><br><span class="line">WorkingDirectory=/home/ubuntu/calhub</span><br><span class="line">ExecStart=/home/ubuntu/calhub/pycal/bin/jupyter lab</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>随后运行<code>sudo systemctl daemon-reload</code>重载以下，后面就可以通过以下命令控制<code>Jupyter</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start jupyter    <span class="comment"># 启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> jupyter   <span class="comment"># 设置开机自启</span></span><br><span class="line">sudo systemctl status jupyter   <span class="comment"># 查看状态</span></span><br><span class="line">sudo journalctl -u jupyter      <span class="comment"># 查看日志</span></span><br></pre></td></tr></table></figure><h3 id="插件安装">插件安装<a class="header-anchor" href="#插件安装">¶</a></h3><p><code>Jupyter Lab</code>拥有众多的插件，在左侧的<code>Extension Manager</code>中可以对插件进行管理。目前安装了两个较为需要的插件。</p><h4 id="lsp">lsp<a class="header-anchor" href="#lsp">¶</a></h4><div class="note quote flat"><p>Coding assistance for JupyterLab (code navigation + hover suggestions + linters + autocompletion + rename) using Language Server Protocol</p></div><ol><li>首先安装插件本体：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install <span class="string">&#x27;jupyterlab&gt;=3.0.0,&lt;4.0.0a0&#x27;</span> jupyterlab-lsp</span><br></pre></td></tr></table></figure><ol start="2"><li>根据需要安装<code>LSP language server</code>，例如我需要<code>Python</code>以及<code>R</code>语言：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install <span class="string">&#x27;python-lsp-server[all]&#x27;</span></span><br><span class="line">R -e <span class="string">&#x27;install.packages(&quot;languageserver&quot;)&#x27;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>重启<code>Jupyter Lab</code>服务</li></ol><h4 id="system-monitor">system-monitor<a class="header-anchor" href="#system-monitor">¶</a></h4><ol><li>安装插件本体：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install jupyterlab-system-monitor</span><br></pre></td></tr></table></figure><ol start="2"><li>修改<code>Jupyter</code>配置<code>~/.jupyter/jupyter_lab_config.py</code>：</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># memory</span></span><br><span class="line">c.ResourceUseDisplay.mem_limit = &lt;size_in_GB&gt; *<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cpu</span></span><br><span class="line">c.ResourceUseDisplay.track_cpu_percent = <span class="literal">True</span></span><br><span class="line">c.ResourceUseDisplay.cpu_limit = &lt;number_of_cpus&gt;</span><br></pre></td></tr></table></figure><ol start="3"><li>修改插件配置：在<code>Settings</code>中选择<code>Advanced Settings Editor</code>，找到<code>System Monitor</code>，在右侧写入自己的配置：</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// CPU Settings</span></span><br><span class="line">    <span class="comment">// Settings for the CPU indicator</span></span><br><span class="line">    <span class="attr">&quot;cpu&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CPU Usage: &quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Memory Settings</span></span><br><span class="line">    <span class="comment">// Settings for the memory indicator</span></span><br><span class="line">    <span class="attr">&quot;memory&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Memory Usage: &quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Refresh Rate (ms)</span></span><br><span class="line">    <span class="comment">// Refresh Rate to sync metrics data</span></span><br><span class="line">    <span class="attr">&quot;refreshRate&quot;</span><span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="附录">附录<a class="header-anchor" href="#附录">¶</a></h2><h3 id="演示">演示<a class="header-anchor" href="#演示">¶</a></h3><p><img src="https://asset.foolishfox.cn/2021/12/jupyter_1.png" alt=""><br><img src="https://asset.foolishfox.cn/2021/12/jupyter_2.gif" alt=""></p><h3 id="requirements内容"><code>requirements</code>内容<a class="header-anchor" href="#requirements内容">¶</a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">numpy</span><br><span class="line">pandas</span><br><span class="line">matplotlib</span><br><span class="line">tables</span><br><span class="line">astropy</span><br><span class="line">handcalcs</span><br><span class="line">jupyterlab</span><br></pre></td></tr></table></figure><h3 id="保存文件失败">保存文件失败<a class="header-anchor" href="#保存文件失败">¶</a></h3><ol><li>防火墙设置</li></ol><p>宝塔的专业版防火墙和免费Nginx防火墙都有POST最大参数限制，查看错误日志（如<code>/www/wwwlogs/free_waf_log/</code>）发现有<code>参数值长度超过20w已被系统拦截</code>的字样，则说明防火墙出现问题，修改<code>/www/server/free_waf/init.lua</code>中的<code>200000</code>为更大的数字即可。</p><ol start="2"><li><code>websocket</code>问题</li></ol><p>可参考官方推荐配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">map</span> <span class="variable">$http_upgrade</span> <span class="variable">$connection_upgrade</span> &#123;</span><br><span class="line">        <span class="attribute">default</span> upgrade;</span><br><span class="line">        &#x27;&#x27;      close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> jupyter.somewhere.cool;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">                <span class="attribute">proxy_pass</span>            http://localhost:9999;</span><br><span class="line">                <span class="attribute">proxy_set_header</span>      Host <span class="variable">$host</span>;</span><br><span class="line">                <span class="attribute">proxy_http_version</span>    <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">                <span class="attribute">proxy_set_header</span>      Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">                <span class="attribute">proxy_set_header</span>      Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>权限问题</li></ol><p>请确认运行<code>jupyter lab</code>的用户拥有<code>.ipynb</code>文件的读写权限。</p><p><span hidden>脚注[^1][^4][^5]</span></p><h2 id="参考资料">参考资料<a class="header-anchor" href="#参考资料">¶</a></h2><ol><li><a href="https://zhuanlan.zhihu.com/p/434784775">【上云第1期】访问云上的 jupyter 环境（保姆级搭建教程）</a></li><li><a href="https://hijiangtao.github.io/2014/03/21/RSetupinLinux/">Linux环境下R语言安装笔记</a></li><li><a href="https://blog.csdn.net/s1164548515/article/details/100747987">jupyter中加入R语言kernel操作指南</a></li></ol><p>[^1]: <a href="https://github.com/jupyter/notebook/issues/6242">Can not launch notebook after nest_asyncio upgraded to 1.5.2</a><br>[^2]: <a href="https://stackoverflow.com/questions/26263934/compile-r-with-cairo-support-without-x11">Compile R with Cairo support without X11</a><br>[^3]: <a href="https://cran.r-project.org/web/packages/startup/vignettes/startup-intro.html">startup: Friendly R Startup Configuration</a><br>[^4]: <a href="https://blog.csdn.net/bedisdover/article/details/51840639">【解决】fatal error: X11/XXXX.h: No such file or directory</a><br>[^5]: <a href="https://stackoverflow.com/questions/65631688/ubuntu-how-to-deal-the-error-stdin110-fatal-error-git2-h-no-such-file-o">Ubuntu, how to deal the error “&lt;stdin&gt;:1:10: fatal error: git2.h: No such file or directory”?</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;a class=&quot;header-anchor&quot; href=&quot;#前言&quot;&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;这学期学的《概率论与数理统计》课有作业需要用到R，加上双十一从腾讯云搞了一台2H4G8M的机器，性能大大提升，因此打算打造一个云服务来运行Python，同时兼顾R。&lt;/p&gt;
&lt;p&gt;在安装的过程中碰到了超级多的问题，所以下面介绍一下安装的流程，记录一些很久才解决的问题。&lt;/p&gt;</summary>
    
    
    
    <category term="软件/程序" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/"/>
    
    <category term="Jupyter" scheme="https://foolishfox.cn/categories/%E8%BD%AF%E4%BB%B6-%E7%A8%8B%E5%BA%8F/Jupyter/"/>
    
    
    <category term="教程" scheme="https://foolishfox.cn/tags/%E6%95%99%E7%A8%8B/"/>
    
    <category term="Python" scheme="https://foolishfox.cn/tags/Python/"/>
    
    <category term="Jupyter" scheme="https://foolishfox.cn/tags/Jupyter/"/>
    
    <category term="R" scheme="https://foolishfox.cn/tags/R/"/>
    
  </entry>
  
  <entry>
    <title>随记 | 大熊座与小熊座</title>
    <link href="https://foolishfox.cn/posts/202105-constellation1.html"/>
    <id>https://foolishfox.cn/posts/202105-constellation1.html</id>
    <published>2021-05-28T16:05:20.000Z</published>
    <updated>2021-05-28T16:05:20.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="传说">传说<a class="header-anchor" href="#传说">¶</a></h2><p>在古代希腊的神话故事中，大熊是温柔美丽的少女卡力斯托的化身。传说卡力斯托被众神之王宙斯所爱，生下了儿子阿卡斯。宙斯的妻子赫拉知道后非常气愤，她决定要用法力对卡力斯托进行惩罚，于是她把卡力斯托白暂的双臂变成了长满黑毛的利爪，娇红的双唇变成了血盆似的大口，让卡力斯托变成了一只大母熊。后来宙斯知道了，就把大熊提升到天上，成为大熊星座。</p><span id="more"></span><p>而小熊是大熊卡力斯托的儿子阿卡斯。卡力斯托被宙斯的妻子赫拉所害变成一只大熊后，在悲哀和痛苦中度过了15个年头，这时卡力斯托的儿子阿卡斯长大了，成为一名英俊出色的猎手。一天，阿卡斯在林中打猎，被他的母亲卡力斯托看见了，她忘记了自己已经是熊身，便伸开双臂准备拥抱亲爱的孩子。但阿卡斯不知道这只大熊是自己的母亲，他急忙向大熊举起手中的长枪准备射击。幸亏宙斯，也就是阿卡斯的父亲，在天上看见了，他担心阿卡斯会杀死母亲，便用法术把阿卡斯也变成了一只小熊，并将母子俩一起都提升到天上，成为大熊座和小熊座。</p><p>赫拉看到卡力斯托母子都被弄到天上，嫉妒之心油然而生。 她去请自己的哥哥海神波塞冬帮忙：永远不让卡力斯托母子从天上下海来休息喝水。于是，母子俩只得永远在北极上空转圈，不能下海。尽管如此，赫拉还不满足，她又选派一个猎人带着两只凶猛的猎犬，紧跟在大熊和小熊的后面。这个猎人就是天上的牧夫座，而他牵着的两只猎犬就是猎犬座，猎人和猎犬忠实执行神后赫拉交付的任务：紧紧看守着大熊和小熊，不停地追捕着。</p><h2 id="星空">星空<a class="header-anchor" href="#星空">¶</a></h2><p>大熊座是北方天空中最明亮、最重要的星座之一,著名的北斗七星就在这个星座里。大熊座一年四季都能看到，春季黄昏后是观测它的最好时机。在星图上，大熊座的星星被想象为一只大熊，北斗七星的斗柄是大熊的长长的尾巴，斗勺的四颗星是大熊的身躯，另一些较暗的星构成了大熊的头和脚。<br><img src="https://asset.foolishfox.cn/2021/05/1622203030.jpg" alt=""></p><p>北斗七星从勺口到柄尾依次是天枢、天璇、天玑、天权、玉衡、开阳、摇光。前四颗组成了斗身，叫做魁；后三颗组成了斗柄，叫做杓。而开阳是一个奇特的目视双星系统，伴星叫做开阳增一（也称为辅）。后续的研究发现，开阳和辅实际上就是双星系统，开阳就被分为了开阳A（大熊座<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>ζ</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">\zeta&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07378em;">ζ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>）和开阳B（大熊座<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>ζ</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\zeta&#x27;&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07378em;">ζ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>）。</p><p>1989年光谱观测首先发现开阳A是分光双星，后来又发现开阳B也是分光双星，可能是三合星，所以开阳实际上是一个四合星甚至五合星系统。1996年通过极高分辨率的望远镜拍摄出开阳A的两颗子星A1和A2。<br><img src="https://asset.foolishfox.cn/2021/05/20210528194950.png" alt=""><br><img src="http://inews.gtimg.com/newsapp_match/0/8453683962/0.jpg" alt=""></p><p>小熊座的7颗星星也被称为小北斗，其中除<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span>是较亮的2等星外，其他都是较暗的星。因此，小熊座不如北斗七星那样耀眼，在明月之夜或大城市里就不容易看到。小熊座<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span>（勾陈一）就是现在的北极星，处于北斗七星中天枢和天璇的延长线上。<br><img src="https://asset.foolishfox.cn/2021/05/1622201708-1-.jpg" alt=""></p><p>在大熊星座的东南方向，有两个紧挨着的“邻居”：东边的是牧夫座，西边的是猎犬座。猎犬座原先是大熊座的一部份，是北天星座中的小星座。猎犬座也是最暗的星座之一，其中只有一颗三等星。<br><img src="https://asset.foolishfox.cn/2021/05/1622203502.jpg" alt=""></p><p>牧夫座的大角星是全天第四亮星，之所以叫做大角是因为它被看作是四象之一的东方苍龙的一只角。此外牧夫座还包括了8颗4等以上和21颗5等以上的亮星，其中几颗中等亮度的星构成了一个五边形，像个大风筝，而最亮的大角星就像挂在风筝下面的一盏明灯。5月下旬，沿着北斗七星斗柄几颗的曲线顺势延伸出去，画出一条大弧线，就可以在天顶附近的星空找到大角星。<br><img src="https://asset.foolishfox.cn/2021/05/1622203810.png" alt=""></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;传说&quot;&gt;传说&lt;a class=&quot;header-anchor&quot; href=&quot;#传说&quot;&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在古代希腊的神话故事中，大熊是温柔美丽的少女卡力斯托的化身。传说卡力斯托被众神之王宙斯所爱，生下了儿子阿卡斯。宙斯的妻子赫拉知道后非常气愤，她决定要用法力对卡力斯托进行惩罚，于是她把卡力斯托白暂的双臂变成了长满黑毛的利爪，娇红的双唇变成了血盆似的大口，让卡力斯托变成了一只大母熊。后来宙斯知道了，就把大熊提升到天上，成为大熊星座。&lt;/p&gt;</summary>
    
    
    
    <category term="随记" scheme="https://foolishfox.cn/categories/%E9%9A%8F%E8%AE%B0/"/>
    
    <category term="天文" scheme="https://foolishfox.cn/categories/%E9%9A%8F%E8%AE%B0/%E5%A4%A9%E6%96%87/"/>
    
    <category term="科普" scheme="https://foolishfox.cn/categories/%E9%9A%8F%E8%AE%B0/%E7%A7%91%E6%99%AE/"/>
    
    
    <category term="星座" scheme="https://foolishfox.cn/tags/%E6%98%9F%E5%BA%A7/"/>
    
    <category term="观星" scheme="https://foolishfox.cn/tags/%E8%A7%82%E6%98%9F/"/>
    
  </entry>
  
</feed>
