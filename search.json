[{"title":"世界，你好！","url":"/posts/202003-a.html","content":"\n","categories":["随记"]},{"title":"随记 | 大宋清平","url":"/posts/202004-a.html","content":"正文 ¶\n这学期选修了历史系方城峰老师的《宋元史》：前八周讲宋史，后八周讲北方民族史；这一周刚好结束了宋史部分的最后一讲：宋代文化专题；恰逢《清平乐》7 号开播，我们老师也在微信群里提到了这部剧，于是蹭蹭热度，来讲一讲这大宋，也当作是前半个学期的一些复习吧\n\n提到大宋，应该有很多人的第一印象是羸弱，乃至有很多人叫弱宋，更有甚者称之为 “弱怂”；他们认为，有宋一代，积贫积弱，重文轻武，尽管文化上十分发达，但是对外的软弱，导致了后来汉族的沉沦，这是从宋朝的结果来看，得出的最明显的结论；坚持这一观点的著名人物有钱穆，吕思勉，他们都是成长于中华民族备受外族凌辱，随时有可能国破家亡的时代[1]；因为，我们可以肯定，在他们坚持这一观点的背后，有一部分原因是想要 **“以古论今”，为当时的政治服务；南宋的学者叶适 ** 也曾发表过类似的言论，他说：“天下之弱势，历数古人之为国，无甚于本朝者。”\n也有很多人坚持富宋论，这一观点是英国学者伊懋可提出的；与之持类似观点的还有美国学者费正清，费正清认为宋代是 **“中国历史上最伟大的时期”；伊懋可主要是从经济角度去看待唐宋的变局 **，他认为，唐宋变革其实是经济的转型、技术的转型、生产模式的转型；经济转型的一个主要方面，就是江南的农业开发和市场的发展造成了中国经济重心的南移 [2]\n但值得注意的是，他们在研究这一段历史时，采用的是西方学者管用的冲击 - 回应模式 [3]，是为了解答为什么中国没有自主进入近现代化，反而在元朝之后陷入长久的停滞，费正清在他的《美国与中国》一书中也有所反映。他认为，“传统中国不是不变的，也不是静态的或停滞的。正相反，它曾经有过不断的变化，并且变化多端。可是变化总是在一个明显的文化形式与规章制度形式的范围之内。”\n在十九世纪末、二十世纪初，日本京都学派的内藤湖南提出了唐宋变革论[4]，也就是前文提及的唐宋变革的来源；内藤湖南在《概括的唐宋时代观》中提到：“唐和宋在文化上有显著差异：唐代是中世的结束，而宋代则是近世的开始，其间包含了唐末至五代一段过渡期…… 从政治上来说，在于贵族政治的式微和君主独裁的出现”；其实类似的观点，在宋明乃至民国时期就有人提出，北宋的郑樵在《通志》卷二十五《氏族略》称：“自隋唐而上，官有簿状，家有谱系，官之选举必由于簿状，家之婚姻必由于谱系。”“自五季[5] 以来，取士不问家世，婚姻不问阀阅。”\n明朝人陈邦瞻更是从中国历史发展的大势来看待唐宋之际的大变动，而且把中国历史分作三个阶段。他在《宋史纪事本末・序》中说 “然而未暇考其世已，宇宙[6] 风气，其变之大者有三：鸿荒[7] 一变而为唐、虞，以至于周，七国为极；再变而为汉，以至于唐，五季为极；宋其三变，而吾未其极也。变未极，则治不得不相为因。”\n民国大师陈寅恪，对宋代也有自己的见解，他认为：“华夏民族之文化，历数千载之演进，造极于赵宋之世。后渐衰微，终必复振。” 在建国后，胡如雷基于当时的政治形势，根据阶级斗争和土地所有制的变化，认为唐宋之际中国封建社会有着巨大变革\n本文不想在这些事情上有过多的讨论，也不想发表自己的意见；于是，顺着《清平乐》的脚步，将剧中的故事娓娓道来，逐一展开，成了一个很好的选择\n首先，关于这部剧的主角：宋仁宗，很多人不理解为什么要选这么一个主角。的确，在我们接受的小初高教育中，唯有秦皇汉武，唐宗宋祖，能够称之为天骄，才能够说对历史有重大贡献，至于高皇帝刘邦、宣帝刘洵、光武刘秀、三国三帝、北魏孝文、文帝杨坚、武后武曌、玄宗隆基，太祖重八、成祖朱棣、圣祖康熙、高宗乾隆也可以算是人杰\n至于北宋仁宗，没有秦皇汉武的丰功伟业，没有唐宗宋祖的雄才大略，反而被他手下的臣子、一个又一个巨星所掩盖；吕夷简、宋痒、庞籍、晏殊、范仲淹、欧阳修、韩琦、富弼、文彦博、曾公亮、包拯、狄青、苏轼、曾巩、王安石、司马光、柳永、周敦颐、邵雍、张载、程颢、程颐、章惇、韩绛、吕诲、梅尧臣、王尧臣、王拱辰…… 这一长串的名字，让我们迷失在他们璀璨的光辉中，不由自主地忽视了散发着微弱光芒的仁宗\n但是仁宗真的只是名声好，没有半点历史功绩吗？仁宗真的握着一手好牌，却打得稀巴烂吗？异国百姓、君王均为仁宗之死感到悲哀，是因为仁宗好欺负，难得遇上吗？这些问题，我们都可以在后面讲述的过程中，稍加思考；当然，仁者见仁智者见智，每个人得出的结论都会不一样，那就看各自的领悟啦\n参考资料 ¶\n\n 课件 &amp; 课堂讲授，清华大学历史系，方城峰\n唐宋变革论究竟是怎么回事，北京大学历史系，陆扬\n唐宋变革论的由来与发展，首都师范大学历史学院，李华瑞\n\n\n\n\n钱穆，1895-1900；吕思勉，1884-1957 ↩︎\n\n唐和北宋在实际上还没有完成经济重心南移的过程，实际上，在北宋，人口、科技、经济仍然集中在北方 ↩︎\n\n冲击 - 回应模式，强调了西方的冲击对中国进步的重要性 ↩︎\n\n除京都学派外，日本的东京学派也对中国的历史分期有所研究，但值得注意的是，两者在战前 &amp; 战时的学术研究，基本上是为了替日本侵略中国寻找合适的理由与借口 ↩︎\n\n五季，即五代，后梁、后唐、后晋、后汉、后周 ↩︎\n\n宇宙，宇代表空间，宙代表时间，与现在的宇宙有所不同 ↩︎\n\n鸿荒，指太古，混沌初开之世 ↩︎\n\n\n\n","categories":["随记","历史","科普"],"tags":["历史","宋朝","清平乐"]},{"title":"随记 | 天导星空照","url":"/posts/202004-d.html","content":"昨天是难得一遇的晴天，作为星空摄影小白的我，拿着手机去拍星空，也是为了我《天文学导论》的个人观星作业：\n在晴朗无月的夜晚，向北找到北极星和北斗七星，向南找到天狼星和猎户座，观测并记录这些星星在天球上的运行规律。分别在相距至少一个月的两个晴朗无月的夜晚，用相机拍摄（或手绘）以上星星组成的图像（手绘时注意各星的相对位置）\n\n\n在图像上，按照标准的星座方式把北斗七星和猎户座中的星星用线连接起来，并标出每颗星的中文名。在每个夜晚要选择两个间隔不少于 3 个小时的任意两个时间节点进行拍摄和手绘。特别提醒：图像中所标注的星星必须是裸眼可见的。为了表明星群位置是否有相对变化，图中需明确画出子午线和正北（正南）位置\n由于昨晚有课，下课就九点了，没有三个小时的间隔，那就只能采用手绘 + 拍摄的方式啦。下面是昨晚的情况：\n地点：28°20′58′′N111°50′44′′E28^{°}20^{'}58^{''}N   111^{°}50^{'}44^{''}E28°20′58′′N111°50′44′′E 时间：22:00−23:1022:00-23:1022:00−23:10\n首先找到的是北斗七星，这是北半球最常见，也是我们最熟悉的星象了：\n\n上面的是北斗七星，是大熊座的一部分。小时候还没有那么大的光污染，在老家能够轻而易举的看见明亮的勺状北斗；中间的是天龙座 (Dragon)，所以就会有 ζDra\\zeta DraζDra 这种名字；中心偏左的是小北斗，是小熊座的一部分，** 北极星 (勾陈一)** 是其中的一颗；这张图不太清晰，下面是一张相对而言更高清的图片：\n\n昨晚我拍照的时候，我的星座：狮子座就在我的头顶，但是没有把它拍下来；而且昨晚虽然不是满月，但是初八正巧是上弦月，月光也是蛮强的，对拍摄也造成了一定影响：\n\n天空中的最亮的那一块就是月亮了，旁边有两颗亮星。下方那颗是猎户座的参宿四，下方的电线中间，掩藏着猎户座的腰带三星；上方那颗是双子座的四只脚之一：井宿三，还有一只脚被月亮挡住了；月亮上方的两颗亮星是双子座的两个头：北河二、北河三\n左侧的电线杆旁边的亮星是天狼星，是整个夜空中最亮的一颗恒星，也是大犬座的一部分；而最上方的三根电线的中间那一根上面，有着小犬座仅有的两颗恒星之一：南河二，旁边的那颗亮星是小犬座的另一颗恒星：南河三\n现在让我们掉头，看向我们的身后，有一颗十分明亮的星星：大角星：\n\n上方那一个星座是牧夫座，大角星是牧夫座的主星；中间的星座因为看着就像一个皇冠一样，然后又在北天球，所以称之为北冕座；右侧的那一条直线，是室女座的一条腿；下方的三个星座中，左侧是武仙座的一条手臂和部分躯干；中间是巨蛇座的头；右边是天秤座的一颗亮星\n\n除了这些星座的照片，我还花了 10min 拍了一个星轨，但是这一切却被一辆车的车灯毁了，大哭😭，流泪😭，下面的人影是我自己，想着把车灯挡住，然而并没有起到什么效果：\n\n可以明显地看到，圆弧状的星轨都围绕着一个共同的圆心：北天极，北极星就是因为靠近北天极而得名，在南天极附近没有明显的亮星，所以大家是不是也没有听过南极星这个名字？而且北极星一直在不断变化，现在的北极星是勾陈一，而我们很熟悉的 “牛郎织女” 中的织女星也会在一段时间内成为北极星\n","categories":["随记","天文","科普"],"tags":["星空","星座"]},{"title":"本站指引","url":"/posts/202012-b.html","content":"如果您来自搜索引擎，可以再次使用右上角搜索内容\n\n订阅我 ¶\n你可以通过RSS 来订阅本站的内容\n推荐页面 ¶\n\n 关于我的介绍，戳这里\n我的锻炼记录，戳这里\n博客访问记录，戳这里\n\n更多页面请查看实验室\n\n","categories":["随记"]},{"title":"使用 Hexo 搭建博客","url":"/posts/202012-heog.html","content":"前言 ¶\n之前使用了很久的 WordPress，用起来很方便，但是也有一些不令我满意的地方。首先，WordPress 的源在国外，更新起来很慢很不方便，只好在服务器上面搭建了一个梯子。其次，WordPress 的后端加载速度实在是太慢了，有点无法忍受。而且 WordPress 写文章感觉也没有直接写markdown方便。所以，哪怕 WordPress 还是有很多的优点，但我还是决定放弃 WordPress。\n\n我知道有很多方法可以优化 WordPress 的加载速度，帮助更新，但是很麻烦不说，也不能从根本解决\n\n\n然后在偶然的机会下，接触到了 Hexo，看了一些示例文档，觉得不错，所以打算试一试，于是首先创建了一个 ECS 快照，防止操作失误数据丢失。然后趁此机会把服务器换回了我最常用的Ubuntu，安装了Hexo，按照教程进行之前数据的迁移和本身、主题等的配置，最终决定就用Hexo来搭建新博客。\n\n我在后面接触到了Hugo等其他静态博客的项目，感觉都不错，但是和Hexo相比没有碾压式的优越，所以也没有纠结，就继续采用Hexo\n\n安装 ¶\n安装路线 ¶\n\n安装 Node.js¶\n在安装Hexo之前需要安装好node.js。Windows可以直接在官方网站下载安装包，在安装的时候要记住加入环境变量中。Linux用户可以从NodeSource 安装。\n\nnode.js是基于Chrome V8引擎的Javascript运行环境，可以帮助我们在本地直接运行Javascript而不需要借助浏览器。\n\n我在我的Ubuntu服务器上安装的时候，下载速度简直无法忍受，只好去安装了一个命令行版本的科学上网工具：ssr-command-client。所以推荐Linux用户使用下载二进制文件的方式进行安装。\n\n在官网下载对应的二进制文件，可以在服务器使用wget的方式，也可以下载到本地，然后通过FTP工具上传。\n\n\n下载得到的是一个*.tar.xz文件，使用tar -xvf *.tar.zx进行安装，假设安装目录为/usr/local/nodejs/，然后添加环境变量，可以使用软链接：ln -s /usr/local/nodejs/bin/node /usr/local/bin/node，最后检查一下是否安装成功：\n\nroot@qjlyh:/usr/local/nodejs# node -vv14.15.1root@qjlyh:/usr/local/nodejs# npm -v6.14.8\n安装 Git¶\n直接下载安装包安装即可，依然注意环境变量的问题。Linux基本都自带了git，不用安装。所以关于Git的安装就不过多赘述。\n安装 Hexo¶\n直接按照Hexo官网的介绍安装即可：\nnpm install hexo-cli -g\n注意之后的操作一般都是在Hexo的初始化目录（或者项目根目录）下进行的。如果执行失败，可以通过以下命令更改环境变量：\necho 'PATH=\"$PATH:./node_modules/.bin\"' &gt;&gt; ~/.profile\n初始化 ¶\n使用下面的命令初始化你的项目文件夹，并且进入文件夹安装package.json中的包：\nhexo init &lt;folder&gt;cd &lt;folder&gt;npm install\n安装完成之后，项目的文件结构如下图：\nproject folder├── _config.yml   配置文件├── package.json  应用程序信息├── scaffolds     模板文件├── source        源代码│   ├── _drafts   草稿│   └── _posts    文章└── themes        主题\n常用命令 ¶\n写博客 ¶\nHexo 本体支持.md和.ejs两种格式的文件，但是只要安装了对应的渲染器插件，例如Hexo-renderer-pug，就可以使用.pug格式进行写作。\nscaffolds文件夹以及各个主题的layout文件夹下，是各种页面的模板。Hexo自带了 3 个模板，都是Markdown格式的，分别对应草稿、文章和页面，生成新文件的命令是：\nhexo new [layout] &lt;title&gt;\nlayout是可选参数，代表生成什么类型（草稿、文章或者页面），默认_config.yml中的default_layout参数；title是文件名。\n官方网站有很详细的说明！多读官方文档！！！\n生成 ¶\n我们写的博文源码都是.md或者.ejs一类的文件，然后通过Hexo按照主题的配置生成html、css和js文件，使用的命令如下：\n# hexo clean 可以清除缓存（删除/public目录下所有内容）hexo generatehexo g\n该命令会在根目录下生成public文件夹，该文件夹存储的就是网站所需要的文件了\n\n草稿很类似于所谓的私密文章，只有自己能够看到。如果想要将草稿发布，有两种办法：一种是直接将草稿从_drafts目录下移动到_posts目录，或者是使用hexo publish [layout] &lt;title&gt;的方式\n\n预览 ¶\nHexo 可以通过内置的server来预览生成的网站的效果：\nhexo server --draftshexo s\n默认情况下不会显示草稿，–drafts 参数可以强制显示草稿，或者是更改根目录下_config.yml的配置项：render_drafts: true\n部署 ¶\n最后一步就是将你创作的内容发布，一般是通过这一个步骤将静态文件（也就是public文件夹）推送到GitHub的一个仓库中，生成Github Pages，首先要更改根目录下_config.yml的配置：\ndeploy:  type: git  repo: &lt;repository url&gt;  branch: [branch]\n然后安装hexo-deployer-git插件，再执行下面的命令，就可以把public文件夹整体提交到GitHub的仓库中了：\nhexo deployhexo d\nQ&amp;A¶\n\n 为什么我不在本地搭建node.js环境，使用Github Pages搭建网站？\n首先是因为我不想在自己的电脑上安装太多的东西；其次是我通过阿里云的学生优惠，购买了一台 ECS，尽管配置不高，但是应付我这个小站肯定是可以的，所以我想把它利用上。所以最终我才用的方案是：本机VS Code远程连接服务器进行写作，在服务器上进行部署，同时推送源码到GitHub仓库备份（强烈吹一波VS Code）\n在本机 (Windows) 安装这些东西太麻烦，有没有什么简便的方法？\n答案肯定是有的，可以使用Chocolate或者Scoop进行安装，强烈推荐这种方法，可以很方便的管理这些应用，不用担心把你的 C 盘搞得一团糟。\n\n参考资料 ¶\n\n阿里云 ECS 服务器上安装 nodejs\nHEXO 折腾\nHexo 中文文档\n\n","categories":["技术笔记","博客成长日志"],"tags":["教程","Hexo"]},{"title":"折腾日志 | 利用 python 通过百度和必应 API 主动推送收录","url":"/posts/202012-a.html","content":"自己写了博客，一般总是希望被更多的人看到，而他人找到你的网站的最好方法就是通过搜索引擎。所以为了能够让你的网站被收录在搜索引擎中，需要向搜索引擎主动提交 (当然，如果你是 dl，大可不必如此麻烦)\n\n如果你是通过Hexo建立的网站，有很多的插件可以提供你使用，例如 hexo-submit-urls-to-search-engine，配置可以看插件的文档，除了这种方法之外，还可以自己用Python写一个自动提交的程序。\n流程 ¶\n\n目前国内主要的搜索引擎就是百度，必应和谷歌，如果需要主动推送谷歌的话，需要会科学上网，再加上个人觉得没什么必要，所以只添加了前两个的 push\n2020.12.19: 谷歌可以自动抓取，没必要主动推送\n依赖 ¶\nimport re, os, urllib, requestsfrom urllib import requestfrom bs4 import BeautifulSoupimport xml.dom.minidomfrom xml.dom.minidom import parse\n一般情况下，只要安装BeautifulSoup就好了\n收录情况 ¶\n在搜索引擎中输入site:example.com就可以查看你的网站的收录情况\n百度 ¶\ndata      = requests.get('http://www.baidu.com/s?wd=site:'+url)content   = data.content.decode('utf-8')soup      = BeautifulSoup(content,'lxml')link_list = soup.find_all('a')\n这部分实现的是查询site:example.com，并且获取页面中所有的链接\nsite_list = []for link in link_list :    url = link.get('href')    rul = re.compile(r'http://www.baidu.com/link\\?url=+.+')    url = rul.findall(url)\n这部分是将无关的链接全部排除；百度的搜索结果都是以http://www.baidu.com/link/?url=进行替换的，而我们要获得的是真实网址，所以下一步要通过访问这个链接，获取真实指向的网址：\ntry:    response = request.urlopen(url[0])    realurl  = response.geturl()    if realurl!='' :        site_list.append(realurl)except request.HTTPError as e :    print(e.code, e.reason)except urllib.error.URLError as e :    data = requests.get(url[0])\nurllib.error.URLError是为了防止有时候 DNS 解析不到某些域名的网址，导致程序直接退出\n必应 ¶\n必应和百度不同，搜索出来的结果直接就是页面链接，不需要获得真实网址：\ndata      = requests.get('https://cn.bing.com/search?q=site:{}&amp;first={}0'.format(url, page))content   = data.content.decode('utf-8')soup      = BeautifulSoup(content,'lxml')link_list = soup.find_all('a')site_list = []for link in link_list :    url = link.get('href')    if url==None :        continue    rul = re.compile(r'https://www.foolishfox.cn/+.+')    url = rul.findall(url)    if url==None or not url :        continue    site_list.append(url[0])return site_list\n站点链接 ¶\n可以通过很多手段获得站点地图。以我的网站为例，使用hexo-generator-sitemap直接获得了sitemap.xml文件\nDOMTree   = xml.dom.minidom.parse(path)sizemap   = DOMTree.getElementsByTagName('loc')site_list = []for i in range(0, len(sizemap), 1):    url = sizemap[i].firstChild.data    if 'tags' not in url and 'categories' not in url :        site_list.append(url)return site_list\n百度提交 ¶\ns_url = 'http://data.zz.baidu.com/urls?site=https://www.foolishfox.cn&amp;token='+os.environ['baidu_token']headers = {    'content-type' : 'text/plain',    'User-Agent'   : 'curl/7.12.1',    'Host'         : 'data.zz.baidu.com'    }url_string = ''for link in url_list :    url_string += link+'\\n'response = requests.request('POST', url=s_url, data=url_string, headers=headers)return response.text\n百度 API 的 token 我已经提前设置在了环境变量中，可以避免对外公开。需要注意的是，百度 API 的格式要求是字符串，所以我将list拼接成了string。\n必应提交 ¶\ns_url = 'https://ssl.bing.com/webmaster/api.svc/json/SubmitUrlbatch?apikey='+os.environ['bing_token']headers = {    'content-type' : 'application/json',    'User-Agent'   : 'curl/7.12.1'    }url_json = {    'siteUrl': 'https://www.foolishfox.cn',    'urlList': []}for link in url_list :    url_json['url'].append(link)response = requests.request('POST', url=s_url, json=url_json, headers=headers)return response.text\n必应可以采用xml和json两种格式提交，我用的是后者。如果提交单个链接，应该将s_url修改为https://ssl.bing.com/webmaster/api.svc/json/SubmitUrl?apikey=，将json中的urlList修改为url\n自动提交 ¶\n最简单的方式就是通过crontab了，如果使用Hexo，还可以用node.js监听hexo事件，实现提交：\ntry {\thexo.on('deployAfter', function() {\t\trun();\t});} catch (e) {\tconsole.log(\"Error: \" + e.toString());}\n更新 ¶\n\n2020.12.19: 修改代码中链接、流程和部分单词拼写错误\n\n参考资料 ¶\n\npython 主动推送链接至必应 Bing 平台\n\n","categories":["技术笔记"],"tags":["Python","站点统计"]},{"title":"折腾日志 | Windows 包管理器 Scoop 的安装与使用","url":"/posts/202101-a.html","content":"前言 ¶\nsudo apt updatesudo apt install git\n在Ubuntu安装软件的时候敲入上面的命令是一件令人舒适的事情，而且也很便捷，想要在MacOS上这样操作，也可以使用homebrew等诸多的包管理工具。然而如果想在Windows安装软件，你可能需要：\n\n打开百度搜索软件\n在搜索结果中找到无毒无捆绑的版本\n进行安装，不停点击Next或者下一步\n结束安装\n\n\n在这个过程中，你还要担心是否会混入病毒，是否会有捆绑软件同时下载；软件还很可能会索要管理员权限，把它自己安装在 C 盘的好位置；有些开发工具还可能会搞乱你的环境变量；最最重要的是，最后你要卸载它的时候不知道有多麻烦。\n所以就有天降猛男来解决这个问题，开发了Windows的包管理工具。在scoop之前，Windows上的包管理工具中比较出名的是Chocolaty。在scoop横空出世之后，由于其自定义程度高、拓展性强的特性而发展迅猛，目前社区中总计有 2000 + 的软件；另外scoop安装软件不依赖管理员权限，安装路径和环境变量管理也深得我这一类 “绿色用户” 的欢心。\n安装 scoop¶\n安装要求 ¶\n\nWindows 7 或更高版本\nPowerShell 5.0 或更高版本\n.NET Framework 4.5 或更高版本\nUser Name 不含中文字符\n确认打开了远程安装权限\n\n$PSVersionTable.PSVersion.Major                      # 查看Powershell版本$PSVersionTable.CLRVersion.Major                     # 查看.NET Framework版本set-executionpolicy remotesigned -scope currentuser  # 打开远程权限\n当然还有很重要的一点就是能够正常访问Github。\n配置 ¶\n默认情况下, scoop 以及大多数安装的软件都位于%USERPROFILE%\\scoop,全局安装的程序位于C:\\ProgramData\\scoop，当然我们也可以自定义安装位置：\n$env:scoop='D:\\scoop'[Environment]::SetEnvironmentVariable('scoop', $env:scoop, 'User')$env:scoop_GLOBAL='D:\\scoop\\GlobalApps'[Environment]::SetEnvironmentVariable('scoop_GLOBAL', $env:scoop_GLOBAL, 'Machine')\n安装 ¶\nInvoke-Expression (New-Object System.Net.WebClient).DownloadString('https://get.scoop.sh')# or the shorter:iwr -useb get.scoop.sh | iex\n卸载 ¶\n以毒攻毒，以scoop卸载scoop (先卸载其他软件)：\nscoop uninstall scoop\n基础 ¶\n常用命令 ¶\nscoop 的命令设计逻辑是scoop + command + [object] + [options]，例如scoop install git -g，常用的基础命令有：\n\n\n\n命令\n作用\n\n\n\n\nhelp \n查看帮助\n\n\nbucket add/rm [args]\n添加、删除仓库\n\n\nbucket list/know\n查看已有 / 已知仓库\n\n\nsearch \n匹配查找\n\n\ninfo \n查看详情\n\n\nhome \n查看主页\n\n\ninstall  [options]\n安装\n\n\nuninstall  [options]\n卸载\n\n\nupdate  [options]\n更新\n\n\nlist\n查看已安装软件\n\n\ncache show/rm [app]\n查看或删除缓存\n\n\ncleanup  [options]\n删除旧版本\n\n\ncheckup\n自检查\n\n\n\n\n\n\n安装位置 ¶\n在配置这一步中，我们设置了scoop的安装位置为D:\\Scoop，在这个文件夹下，会有这几个子目录：\n\napp就是软件的安装位置；buckets则是已添加的仓库（后文会提到，scoop的仓库实际上就是git的repository，所以该文件夹下其实就是一个一个git repository）；cache是下载缓存；GlobalApps是自定义的全局安装位置；persist则是一些配置文件；shim会创建一些应用的软链接，让应用之间不会互相干扰。\n加速 ¶\n使用 aria2¶\naria2 可以利用多线程加速下载：\nscoop install aria2# 关闭aria2（默认开启）scoop config aria2-enabled false# 配置aria2 ：重试秒数 单任务最大线程数(最大为16) 同一服务器最大连接数 最小文件分片大小scoop config aria2-retry-wait 4scoop config aria2-split 16scoop config aria2-max-connection-per-server 16scoop config aria2-min-split-size 4M\n设置代理 ¶\nscoop 在拉取仓库更新和下载大部分软件时，都需要从国外服务器下载，速度十分感人，因此使用代理可以大大加速下载。有两种方式可以在scoop下载时使用代理：\n\n在 Powershell 内设置环境变量：$Env:http_proxy=\"http://127.0.0.1:1080\";$Env:https_proxy=\"http://127.0.0.1:1080\"\n更改代理设置：scoop config proxy [username:password@]host:port，具体配置可以查看参考资料 5\n\nBucket 管理 ¶\n介绍 ¶\nBucket 其实就是一个git repository，主要组成就是描述如何安装软件的json文件。在安装scoop时已经附带安装main bucket，然后这个仓库的收录标准十分严格：\n\n主流的开发者工具\n维护中的最新版本的软件\n完整版本的软件\n不可以有 GUI\n……\n\n这使得我们只能在main中找到部分软件，不可以有GUI这一点使得大部分日常使用软件都无法下载，所以我们需要添加其他仓库，可以使用scoop bucket know查看官方维护的仓库，还可以在这里查看较受欢迎的仓库，较完整的仓库列表可以在这里查看。\n管理 ¶\n官方维护的仓库可以直接添加，例如scoop bucket add extras；对于社区维护的仓库，使用scoop bucket add &lt;name&gt; &lt;url&gt;进行添加，例如scoop bucket add dorado https://github.com/chawyehsu/dorado。\n每一次安装和更新软件之前，scoop首先会从github拉取已添加仓库的更新，然后再进行操作。如果碰到不同的仓库中拥有名字相同的软件，可以加上仓库名以示区分，例如scoop install main/git。\n建立自己的 bucket¶\n参考 scoop 进阶 - 建立自己 的 Bucket\nApp 查询 ¶\n为了在scoop的许多仓库中找到自己需要的软件，可以在这里查询安装脚本所在的 bucket。\nQ&amp;A¶\n\n 还有其他的包管理工具吗？\n有呀，例如 winget，是由官方推出的推出命令行安装工具，全称windows package manager client\n\n仓库 ¶\n\n\n\n 名称\n简介\n\n\n\n\ndorado\nYet another bucket for scoop.\n\n\nscoopet\nA Bucket for the Best Windows Package Manager scoop : Continuously Assisting in Academic Research.\n\n\nsushi\nA tasty and inclusive scoop bucket, providing various kinds of applications.\n\n\n\n参考资料 ¶\n\nWindows 下最好的包管理器–scoop\nscoop—— 强大的 Windows 命令行包管理工具\n给 scoop 加上这些软件仓库，让它变成强大的 Windows 软件管理器\nUsing scoop behind a proxy\nQuick Start\n再谈谈 scoop 这个 Windows 下的软件包管理器\nAria2 下载简述\n\n","categories":["技术笔记"],"tags":["教程","Scoop"]},{"title":"折腾日志 | 安装 MTProxy，轻松使用 Telegram","url":"/posts/202102-mtproxy.html","content":"前言 ¶\nTelegram 是一款类似于 QQ 和微信的即时通讯软件，中文名叫电报。Telegram 最大的特点，也是主打的招牌就是加密与安全：除了服务器本身加密外，还可以额外用户对用户加密，还支持设置阅后即焚，保证通信隐私安全。目前最新版本的客户端支持发送所有类型的文件和进行语音通话。\n\n不过正是由于 Telegram 的加密特性，导致不少地区都对 Telegram 进行封杀，必须使用特殊手段才能使用 Telegram，基于此类问题，电报官方开发了一款专门用于 Telegram 的代理工具 ——MTProxy。\nMTProxy 特别适合主要通过手机使用 Telegram 的用户，电脑一般一直开启科学上网工具，但手机不同，所以使用 MTProxy 可以让手机更方便地使用 Telegram。\n手动安装 ¶\n准备 ¶\n在安装之前，需要确认你的服务器上拥有一些基本工具：openssl、zlib、gcc等。\nBuild¶\n\n 拉取源码\n\ngit clone https://github.com/TelegramMessenger/MTProxy\n\n编译，生成的二进制文件是 objs/bin/mtproto-proxy\n\ncd MTProxymake &amp;&amp; cd objs/bin\nConfig¶\n\n 连接 Telegram 服务器，并获取配置文件\n\ncurl -s https://core.telegram.org/getProxySecret -o proxy-secretcurl -s https://core.telegram.org/getProxyConfig -o proxy-multi.conf\n\n生成密钥，一定要记得记录下来\n\nhead -c 16 /dev/urandom | xxd -ps\n\n创建 systemd 服务文件，并且填充内容\n\nnano /etc/systemd/system/MTProxy.service[Unit]Description=MTProxyAfter=network.target[Service]Type=simpleWorkingDirectory=/opt/MTProxyExecStart=/opt/MTProxy/mtproto-proxy -u $username -p $localport -H $connectport -S $secret --aes-pwd proxy-secret proxy-multi.conf -M $numRestart=on-failure[Install]WantedBy=multi-user.target\n\n\n\n变量名\n含义\n备注\n\n\n\n\nusername\n用户名\n\n\n\nlocalport\n统计端口\nwget localhost:8888/stats\n\n\nconnectport\n连接端口\n\n\n\nsecret\n密钥\n\n\n\nnum\n进程数目\n默认为 1 即可\n\n\n\nRun¶\n\n 重新加载进程守护（daemons）\n\nsystemctl daemon-reloadsystemctl start MTProxy.service     # 启动MTProxysystemctl stop MTProxy.service      # 停止MTProxysystemctl restart MTProxy.service   # 重启MTProxysystemctl status MTProxy.service    # 查看状态systemctl enable MTProxy.service    # 允许开机自启\n\n获取链接：tg://proxy?server=SERVER_IP/SERVER_DOMAIN&amp;port=PORT&amp;secret=SECRET，将其发送至任一 tg 聊天窗口，点击添加链接即可\n\nMTProxy Admin Bot¶\nMTProxy Admin Bot 是 Telegram 官方帮助使用代理的工具，搜索添加后，通过/newproxy命令生成代理链接：\n\n脚本安装 + TLS 伪装 ¶\n上面的安装过程略显繁琐，容易出错，而且更重要的问题是这样安装的代理使用的流量特征十分明显，特别容易被 GFW 识别，导致服务器端口甚至 IP 被封，最好使用其他方法进行伪装，所以可以使用一键安装脚本，例如MTProxy TLS 或者mtproxy，安装过程与上面类似，使用方法在 Github 主页中有描述：\nbash mtproxy.sh startbash mtproxy.sh debugbash mtproxy.sh stopbash mtproxy.sh restart\nQ&amp;A¶\n\n 脚本安装之后无法启动\n\n可以使用bash mtproxy.sh debug命令查看问题，一般问题都是类似这样：\n\n这是因为脚本下载的 mtproto-proxy 版本太老了，可以看到是用 gcc-8 编译的去年的老版本，可能和你的电脑不匹配，我的解决方案是：\n  ①. 下载原版：git clone https://github.com/TelegramMessenger/MTProxy\n  ②. 使用服务器上的 gcc 进行编译，将编译产生的 mtproto-proxy 二进制文件复制到一键管理脚本所在目录下，再次启动\n  ③. 有可能出现无法运行的情况，可以将原版代码中 common / pid.c 中的这一行注释掉，重新编译，重复上面的步骤：\nassert (!(p &amp; 0xffff0000));\n参考资料 ¶\n\nMTProxy\nMTProxy TLS 绿色版一键安装脚本\nmtproxy\nMTProxy + FakeTLS|Telegram 稳定代理配置教程\nSystemd 入门教程：命令篇\n\n","categories":["技术笔记"],"tags":["教程","MTProxy"]},{"title":"AE9/AP9/SPM | 介绍与安装","url":"/posts/202102-ae9-1.html","content":"前言 ¶\nAE9/AP9/SPM 是由美国空军研究实验室 (Air Force Research Laboratory) 开发的，用于模拟近地空间辐射的模型。AE9/AP9/SPM分别用于模拟高能电子，高能质子和等离子体模型，给定卫星轨道根数或星历表，该模型将返回指定量的通量，注量或剂量，并为这些量选择适合的统计数据。AE9/AP9/SPM提供了两种安装模式：命令行版本和 GUI 版本。在国际合作者加入该项目之后，该模型被重命名为近地国际辐射环境 (IRENE)。\n\n下载 ¶\nAE9/AP9/SPM 的项目地址位于VDL，该网站需要使用美国 IP 才可进行访问。我们选择使用Public AE9AP9 Account进行下载，而不使用VDL Account，因为后者需要年满 18 周岁的美国政府雇员，承包商或学术人员才能够申请注册。\n在填写Public AE9AP9 Account注册信息时，注意邮箱不能使用国内邮箱或者 hotmail、yahoo，Zip Code 填写为 00000 即可。注册完成之后，密码将会通过注册邮箱发送给你，由于不可知的原因你很有可能无法收到邮件，你可以向ae9ap9@vdl.afrl.af.mil发送邮件进行询问，在得到回复之后选择重置密码即可。\n\nAE9/AP9/SPM默认只提供 Windows 版本，源代码或者 Linux 版本需要发邮件索求之后自行编译。\n第三方依赖 ¶\n只有编译源代码才需要安装依赖，否则直接使用即可!\n\nCMake¶\nCMake 版本不低于 2.6，推荐选择下载 Binary distributions，源代码需要编译才能使用。\nVisual Studio 2012¶\n下载旧版本的Visual Studio 2012或者 2008。\nA Windows-based FORTRAN compiler is also needed for a full source code compilation, but unfortunately, is not freely available. However, by default, the build process links to an included pre-compiled library of these FORTRAN-based routines.\n\nPython (Recommended)¶\n推荐下载Miniconda，并且更改源：\npip config set global.index-url https://mirrors.aliyun.com/pypi/simple/\nQt and Qwt (optional)¶\nQTW 是 QT 的一个第三方库，两者都可以直接下载安装。\nHDF5 1.8.8¶\nHDF 的全程是Hierarchical Data Format，可以存储不同类型的图像和数码数据的文件格式，文件后缀名为.hdf，下载二进制版本安装即可。\nBoost 1.58.0¶\nBoost 是为 C++ 标准库提供扩展的程序库，下载解压后目录如图所示，依照参考资料 5 安装即可。\n\n解压 ¶\n下载得到的是一个压缩文件，解压后目录结构为：\nAe9Ap9  bin    win32 - 预编译32位二进制文件(Windows XP/7)    win64 - 预编译64位二进制文件(Windows 7)  documents - 发行说明, 用户指南, 编译指南, 版权说明等  modelData - 模型数据文件  samples   - 模型样例  unitTests - 模型的拓展数据集  source    - 源代码根目录构建脚本(基础发行版中不存在源代码)    Ae9Ap9Mpi      - Ae9Ap9 源代码    SpWx_Ae9Ap9    - Ae9Ap9 所依赖的空间天气模型的源代码    Ae9Ap9GuiMpi   - GUI 应用源代码    buildAe9Ap9.py - Python 脚本, 用于linux, win32和win64平台的自动构建\n编译 ¶\n只有编译源代码才需要安装依赖，否则直接使用即可!\n\n\nTaking note of the include and library paths for the third-party dependencies installed in the previous step, using a plain text editor, update these in the three build script configuration files:\n\nAe9Ap9/source/SpWx_Ae9Ap9/Common/internal_utils.cmake\nThe configuration file contains several platform-specific sections of commands that set these paths.\n\n Scroll down in the file to where these lines are showing:############################################################### config_include_lib_pathsFrom here, all settings that may require modification are preceded with this line:# &lt;&lt;== END-USER MODIFIABLE ==&gt;&gt;\n For Windows, use forward slashes (/) in path references.Note the set of the EXT_LIBS_ROOT variable, and its subsequent reference $(EXT_LIBS_ROOT), for ease of use in multiple places. For Windows, it is suggested to set EXT_LIBS_ROOT to C:/Program Files.\n\n\nAe9Ap9/source/Ae9Ap9Mpi/internal_utils.cmake\nThis file is updated in the same way as the previous file, if the GUI application is desired.\nAe9Ap9/source/Ae9Ap9GuiMpi/trunk/Ae9Ap9Gui.pro\nThe Ae9Ap9Gui source tree utilizes qmake (part of the Qt development environment) for the build process, and thus uses a slightly different file and syntax for defining the include and library paths. Important: on Linux systems, verify that the correct qmake version is being used; update the path environment variable as necessary.\nThe Qt include and library paths will be automatically set properly with the installation of the Qt software. This file must only explicitly set paths for the Qwt include and library paths, as shown below. Note the platform-specific sections are also present here.\n\n win32 {  INCLUDEPATH += c:\\Qt\\qwt-5.2.1\\src  LIBS += \"c:\\Qt\\qwt-5.2.1\\lib\\libqwt5.a\"}win64 {  INCLUDEPATH += c:\\Qt64\\qwt-5.2.1\\src  LIBS += \"c:\\Qt64\\qwt-5.2.1\\lib\\libqwt5.a\"}unix {  INCLUDEPATH += /nas/ExternalLibs/Qt/qwt-5.2/src  LIBS += /nas/ExternalLibs/Qt/qwt-5.2/lib/libqwt.so}\n\nAutomated Build\nThe preferred method of building a source distribution of IRENE (AE9/AP9/SPM) on a supported platform is to utilize the python script called buildAe9Ap9.py, located in the Ae9Ap9/source directory of the distribution. This script will build the model library and the command-line and gui driver applications, then place them in a platform-specific subdirectory under Ae9Ap9/bin in the distribution.\nDuring the build process, the script will generate a log file called buildAe9Ap9.log in the Ae9Ap9/source directory; this can be used to identify any build errors encountered. At a command prompt in the Ae9Ap9/source directory, invoke the python build script, specifying the operating system name and, if needed, the mode (defaults to release): python buildAe9Ap9.py --os=&lt;platform_name&gt; [ --mode= ] [ --nompi ] [ --nogui ] where &lt;platform_name&gt; can be linux , win32 or win64, and  can be release or debug.\nBy default, both the single- and multi-threaded versions of the programs are built, unless the optional argument --nompi (required for win32 builds) is specified. The GUI application is also built by default; to skip this, specify the optional argument --nogui. For RedHat EL or CentOS 5.x installations only, the --gcc=gcc44 option should also be included.\n\ndebug mode increases program execution time by a factor of 10 to 20.\n\n安装测试 ¶\nCLI¶\n根据所用平台，在 PowerShell 中进入对应的二进制文件所在的目录 (例如Ae9Ap9\\bin\\win64)，输入命令：\n.\\CmdLineAe9Ap9.exe -i ..\\..\\samples\\Ap9ShortInput.txt\n生成的输出文件位于Ae9Ap9\\samples文件夹下，可以根据文件生成时间判断。我们可以通过验证生成的文件数量以及相应的文件内容是否与位于Ae9Ap9\\samples\\expectedOutput目录中以Ap9ShortOutput为前缀的文件是否相同来判断是否工作正常。\nGUI¶\n在同一命令行中，可以运行Ae9Ap9Gui.exe来启动 GUI 程序\n\n其他 ¶\n在Ae9Ap9\\bin\\win64目录下还有很多其他文件，其中只有CmdLineAe9Ap9.exe、Ae9Ap9Gui.exe、TotalDose.exe、IntegralPlasma.exe、ConvertToXlsx.py需要用到，其他的都是辅助程序。\n\n\n\n参数\n说明\n\n\n\n\n-h\n帮助，列出所有参数说明\n\n\n-v\n输出版本信息\n\n\n-i \n指定模型输入文件\n\n\n-n \n指定要使用的处理器数量（默认为 1） 使用多线程时包括一个主处理器，会覆盖输入文件中的 NumProc 参数\n\n\n\n在运行时不要更改输入输入文件，因为应用程序可能会多次访问该文件\n\n下载地址 ¶\n\n\n\nName\nVersion\nURL\n\n\n\n\nAE9/AP9/SPM\n1.50.1\nhttps://www.vdl.afrl.af.mil/programs/ae9ap9/downloads.php\n\n\nCMake\n≥2.6\nhttps://cmake.org/download/\n\n\nVisual Studio\n2008 or 2012\nhttps://visualstudio.microsoft.com/zh-hans/vs/older-downloads/\n\n\nMiniconda\n\nhttps://mirrors.tuna.tsinghua.edu.cn/help/anaconda/\n\n\nQt\n4.6.2\nhttps://download.qt.io/archive/qt/4.6/\n\n\nQtW\n5.2.1\nhttps://sourceforge.net/projects/qwt/files/qwt/5.2.1/\n\n\nHDF5\n1.8.8\nhttps://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8/hdf5-1.8.8/\n\n\nBoost\n1.58.0\nhttps://sourceforge.net/projects/boost/files/boost/1.58.0/\n\n\n\n参考资料 ¶\n\nAE9/AP9/SPM\nQT 第三方库：Qwt 的安装与使用\nWindows 下 HDF5 静态库的封装与测试\n在 windows 平台使用 CMAKE 安装 HDF5\nWindows 环境下 Boost 的安装\n\n","categories":["核物理","工具软件"],"tags":["教程","AE9/AP9/SPM"]},{"title":"服务器迁移","url":"/posts/202103-move.html","content":"本文记录迁移过程备忘，方便后面再次迁移\n\n前言 ¶\n阿里云 ECS 学生机要过期了，由于自己曾经升级过 ECS 的带宽（从 1M 到 3M），所以不能享受续费优惠，无奈之下，只能选择进行服务器迁移。备选的方案有腾讯云 CVM、阿里云轻量应用服务器和硅云 ECS。\n\n硅云最早被 Pass，毕竟和前面两家大厂相比不论是产品可选择性还是可靠性都略显不足，只能放在次要选择。腾讯云有学生优惠，2H4G3M 服务器 400 + 一年，还可以同样价格续费，很实惠。不过最终综合价格和便捷，还是选择了阿里云，初购 96 / 年的轻量应用服务器，毕竟我的 RDS 数据库和 OSS（被我用又拍云云储存顶替了）都是阿里云的。\n准备 ¶\n买好服务器后，首先配置一下 shh 免密码登录，方便后面的过程进行。\n下一步查看一下有哪些东西需要进行迁移。我的服务都已经添加了监控，可以直接在监控 - 服务看到：\n\n仔细清点过后，需要进行迁移的服务有：\n\nAPI-Img: 图片、视频等静态文件 API，阿里云 OSS -&gt; 又拍云云储存\nAPI-Waline: 评论后台，ECS -&gt; swas\nSite-Blog: 博客主体，ECS -&gt; swas\nSite-Editor: 在线编辑器，ECS -&gt; swas\nSite-Guard: ServerStatus，ECS -&gt; swas\nSite-Travel: 旅行地图，ECS -&gt; swas\n\n迁移 ¶\nAPI-Img¶\n根据又拍云文档创建云储存服务，更改 asset.foolishfox.cn 的 CNAME 的解析，备份文件即可。\nSite-Blog¶\n又进行一次之前的迁移，可以看之前的文章。\n为了方便下一步的安装，可以选择安装n进行Node.js的版本管理，另外还可以更改npm源为淘宝源，加快下载、安装速度。\n\nSite-Editor¶\n进行了上一步之后，服务器已经安装好了Node.js环境，剩下的只需要安照文档安装即可。\n使用pm2启动后，需要设置Nginx反向代理，方便通过域名进行访问。例如winwin-hexo-editor运行在 8900 端口，设置write.foolishfox.cn的反向代理为127.0.0.1:8900。\nSite-Guard¶\nServerStatus 一开始是一个老外的项目，可以理解为多服务器探针、多服务器云监控。后来国人进行了汉化和修改，我这里使用的是nyawork 开发的ServerStatus-Hotaru 版本。安装十分简单，只需要下载好文件，按照步骤进行即可。\nroot@vultr:~# wget https://raw.githubusercontent.com/nyawork/ServerStatus-Hotaru/master/status.shroot@vultr:~# chmod +x status.sh\n因为要从 Github 下载文件，所以安装速度比较慢。例如下载master.zip，可以打开status.sh文件找到下载链接，下载好之后更改文件名为master.zip，再上传到/tmp文件夹下，这样速度会快很多。除了master.zip，还有一个文件是jq，事先创建好/usr/local/ServerStatus文件夹，将下载好的文件重命名后放在该文件下。\n\n要修改的话，可以直接更改/usr/local/ServerStatus/server/config.json文件，重启status.sh即可。\nAPI-Waline¶\nwaline 是由lizheming 开发的博客评论系统，是最难配置的一部分。Waline 有多达 48 钟部署方式，下面介绍两种部署方式：\nDocker¶\n由于有自己的服务器和数据库，最开始选择了 Waline / client + Docker + MySQL 的方式进行部署。\n\n修改Node.js淘宝源\n构建镜像\n\ngit clone https://github.com/lizheming/waline.gitcd walinedocker build -t lizheming/waline -f packages/server/Dockerfile .\n\n修改配置packages/client/.env\n\nSITE_NAME=Fox HomeSITE_URL=https://www.foolishfox.cn# 配置参考：# https://waline.js.org/server/databases.html# https://waline.js.org/server/notification.htmlMYSQL_HOST=127.0.0.1MYSQL_DB=db_nameMYSQL_USER=db_userMYSQL_PASSWORD=passwordSC_KEY=SCK232027Td54bfab83cfabf0aereq2c31b6552cd35fe1a43720074AUTHOR_EMAIL=fox@foolishfox.cn\n\n运行镜像\n\ndocker run --env-file ./packages/client/.env -p 8360:8360 -d lizheming/waline\n\n设置反向目录代理，将waline.foolishfox.cn指向127.0.0.1:8360\n\n独立部署 ¶\n由于方便对配置进行修改，不需要更新镜像等原因，后来弃用了 Docker 部署，改为直接使用Node.js运行。\n\n安装 waline\n\nmkdir walinejs &amp;&amp; cd walinejscnpm install @waline/vercel --save\n\n编辑.bashrc，添加环境变量，最好将字符串用\"或者'包起来，避免$、&amp;等字符的影响\n创建软链接，方便后续操作\n\nln -s node_modules/@waline/vercel ./walinecd waline\n\n配置服务端vim config.js\n\nmodule.exports = {    secureDomains: [        'localhost',        '127.0.0.1'    ]};\n\n修改主程序vanilla.js\n\nconst path = require('path');const Application = require('thinkjs');...let config = {}try {    config = require('./config.js');} catch(e) {}...\n\n使用 pm2 运行程序\n\ncnpm install -g pm2pm2 start vanilla.js --name waline\n\n设置反向目录代理，将waline.foolishfox.cn指向127.0.0.1:8360\n\n参考资料 ¶\n\nWindows SSH 免密登录详解\n从 WordPress 搬迁 —— 使用 Hexo 搭建博客\n如何利用 n 轻松切换 nodejs 的版本\nwinwin-hexo-editor\nServerStatus-Hotaru\nfootprint\nwaline\n\n","categories":["技术笔记","博客成长日志"],"tags":["教程","Hexo","Waline"]},{"title":"折腾日志 | 使用 Echarts 绘制名侦探柯南人物关系图","url":"/posts/202104-conan.html","content":"前言 ¶\n《名侦探柯南绯色的子弹》就要上映了，npy 想要和我一起去看，但是她又搞不懂人物关系，所以就用Echarts做一个柯南的人物关系表了解一下。\nECharts是使用JavaScript实现的开源可视化库，可以做出很多精巧的图片，最初由百度团队开源，后于 2018 年初捐赠给 Apache 基金会，成为 ASF 孵化级项目。\n\n步骤 ¶\n\n 引入jquery和echarts的 js 文件\n\n&lt;script type=\"text/javascript\" src=\"https://cdn.jsdelivr.net/npm/jquery@v3.6.0/dist/jquery.min.js\"&gt;&lt;/script&gt;&lt;script type=\"text/javascript\" src=\"https://cdn.bootcdn.net/ajax/libs/echarts/5.0.2/echarts.min.js\"&gt;&lt;/script&gt;\n\n获取人物关系 json 文件\n\njson 文件中主要分为 3 部分，分别是nodes表示人物，links表示关系连接，categories表示阵营 / 类别。\n\nnodes\n\n{    // 必填，二选一    \"id\": \"0\",   // 人物id    \"name\": \"柯南\",   // 人物名称    // 选填    \"symbolSize\": 50,   // 点的大小    \"value\": 100,   // 力引导布局(force)中连线长度    \"category\": 0,   // 人物类别    \"itemStyle\": {   // 自定义样式        \"normal\": {            \"color\": \"blue\"        }    }}\n\nlinks\n\n{    // 必填    \"source\": \"1\",   // 源节点名称或者id    \"target\": \"0\",   // 目标节点名称或者id    // 选填    \"value\": 100,   // 力引导布局(force)中连线长度    \"name\": \"伙伴\"   // 关系名称}\n\ncategories\n\n{    // 必填    \"name\": \"黑衣组织\",   // 类别名称    // 选填    \"symbol\": \"circle\",   // 类目节点标记的图形    \"symbolSize\": 10,   // 类目节点的默认大小}\n\n配置前端\n\n&lt;div id=\"conan_container\"&gt;&lt;/div&gt;\nvar conan = echarts.init(document.getElementById(\"conan_container\"));    var option;    conan.showLoading();    $.getJSON('https://asset.foolishfox.cn/files/2021/Detective-Conan.json', function (graph) {        conan.hideLoading();        option = {            // 图表标题与位置            title: {                text: 'Detective Conan',                top: 'bottom',                left: 'right'            },            tooltip: {},            legend: [{                // selectedMode: 'single',                data: graph.categories.map(function (a) {                    return a.name;                })            }],            animationDuration: 1500,            animationEasingUpdate: 'quinticInOut',            series: [                {                    name: 'Detective Conan',                    type: 'graph',                    // 布局，none使用节点中提供的x、y作为节点的位置；circular采用环形布局；force采用力引导布局                    layout: 'circular',                    data: graph.nodes,                    links: graph.links,                    categories: graph.categories,                    symbolSize: 15,                    value: 30,                    roam: true,                    label: {                        show: true,                        position: 'right',                        formatter: '{b}'                    },                    labelLayout: {                        hideOverlap: true                    },                    lineStyle: {                        color: 'source',                        curveness: 0.3                    },                    // 突出显示有连接的人物                    emphasis: {                        focus: 'adjacency',                        lineStyle: {                            width: 10                        }                    },                    // 缩放限制                    scaleLimit: {                        min: 0.6,                        max: 3                    }                    // 显示links的名称                    // edgeSymbolSize: [4, 10],                    // edgeLabel: {                    //     show: true,                    //     formatter: function (x) {                    //         return x.data.name;                    //     },                    //     textStyle: {                    //         fontSize: 20                    //     }                    // },                    // 力引导布局的设置                    // force: {                    //     repulsion: 2500,                    //     edgeLength: [10, 50]                    // },                }            ]        };        conan.setOption(option);    });    if (option &amp;&amp; typeof option === 'object') {        conan.setOption(option);    }\n效果展示 ¶\n\n\n\n\n\n\n    var conan = echarts.init(document.getElementById(\"conan_container\"));\n    var option;\n    conan.showLoading();\n    $.getJSON('https://asset.foolishfox.cn/files/2021/Detective-Conan.json', function (graph) {\n        conan.hideLoading();\n        option = {\n            title: {\n                text: 'Detective Conan',\n                top: 'bottom',\n                left: 'right'\n            },\n            tooltip: {\n                formatter: function (x) {\n                    return x.data.des;\n                }\n            },\n            legend: [{\n                // selectedMode: 'single',\n                data: graph.categories.map(function (a) {\n                    return a.name;\n                })\n            }],\n            animationDuration: 1500,\n            animationEasingUpdate: 'quinticInOut',\n            series: [\n                {\n                    name: 'Detective Conan',\n                    type: 'graph',\n                    layout: 'circular',\n                    data: graph.nodes,\n                    links: graph.links,\n                    categories: graph.categories,\n                    symbolSize: 15,\n                    value: 30,\n                    roam: true,\n                    label: {\n                        show: true,\n                        position: 'right',\n                        formatter: '{b}'\n                    },\n                    labelLayout: {\n                        hideOverlap: true\n                    },\n                    lineStyle: {\n                        color: 'source',\n                        curveness: 0.3\n                    },\n                    emphasis: {\n                        focus: 'adjacency',\n                        lineStyle: {\n                            width: 10\n                        }\n                    },\n                    scaleLimit: {\n                        min: 0.6,\n                        max: 3\n                    }\n                }\n            ]\n        };\n        conan.setOption(option);\n    });\n    if (option && typeof option === 'object') {\n        conan.setOption(option);\n    }\n\n\n\n参考资料 ¶\n\n人物关系图谱: ECharts 实现\nEcharts 文档\nEcharts 示例\n\n","categories":["技术笔记"],"tags":["Echarts","名侦探柯南"]},{"title":"宝塔 Nginx 反向代理导致资源等重定向过多","url":"/posts/202104-redirect.html","content":"前言 ¶\n在之前的文章博客服务器迁移过程中介绍了footprint打造旅行地图，然后使用 Nginx 反向代理，将ff.cn/travel指向127.0.0.1:886，原本访问一切正常，但是昨天碰到了一个新的问题：css/js/png 等文件请求 301 重定向过多，花了蛮久才解决问题，所以记下来提醒自己。\n\n复现 ¶\n在网站/travel/目录下创建hello.js文件，请求ff.cn/travel/hello.js，显示ff.cn 将您重定向的次数过多。\n\n在开发者模式下查看网络请求，发现服务器将ff.cn/travel/hello.js重定向给自身，导致出现死循环。\n\n解决 ¶\n\n 清除 cookie (无效)\n\n当相应网页尝试对您进行重定向的次数过多时，您就会看到这条错误消息。\n有时，网页打不开是因为 Cookie 出问题了。要修正该错误，请尝试清除 Cookie。\n\n\n刷新 DNS / 更换 DNS (无效)\n\n重定向过多可能发生了 DNS 劫持，可以刷新 DNS 或者换一个 DNS 地址。\n\nSSL 证书问题 (无效)\n\n如果开启了强制访问 HTTPS 或者 SSL 证书更换，可能导致前后端接口不一致，陷入反复跳转，造成重定向过多，可以重置 SSL 证书或者重启强制访问 HTTPS。\n分析 ¶\n查看 Nginx 日志，发现浏览器发出请求ff.cn/travel/hello.js时，本应该转给127.0.0.1:886/hello.js，然而日志中显示回应请求的链接是127.0.0.1:80/travel/hello.js，怀疑是代理设置出现问题。\n查看ff.cn的配置文件如下：\nconfigurationserver{    listen 80;\tlisten 443 ssl http2;    server_name ff.cn;    index index.php index.html index.htm default.php default.htm default.html;    root /ff.cn;        #SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则    #error_page 404/404.html;    #HTTP_TO_HTTPS_START    if ($server_port !~ 443){        rewrite ^(/.*)$ https://$host$1 permanent;    }    #SSL-END        #ERROR-PAGE-START  错误页配置，可以注释、删除或修改    #error_page 404 /404.html;    #error_page 502 /502.html;    #ERROR-PAGE-END        #PHP-INFO-START  PHP引用配置，可以注释或修改    #清理缓存规则    location ~ /purge(/.*) {        proxy_cache_purge cache_one $host$1$is_args$args;        #access_log  /www/wwwlogs/ff.cn_purge_cache.log;    }    #引用反向代理规则，注释后配置的反向代理将无效    include /www/server/panel/vhost/nginx/proxy/ff.cn/*.conf;    include enable-php-00.conf;    #PHP-INFO-END        #REWRITE-START URL重写规则引用,修改后将导致面板设置的伪静态规则失效    include /www/server/panel/vhost/rewrite/ff.cn.conf;    #REWRITE-END        #禁止访问的文件或目录    location ~ ^/(\\.user.ini|\\.htaccess|\\.git|\\.svn|\\.project|LICENSE|README.md)    {        return 404;    }        #一键申请SSL证书验证目录相关设置    location ~ \\.well-known{        allow all;    }        access_log  /www/wwwlogs/ff.cn.log;    error_log  /www/wwwlogs/ff.cn.error.log;}\nconfiguration#PROXY-START/travel/location  ~* \\.(php|jsp|js|css|png|cgi|asp|aspx)${    proxy_pass http://127.0.0.1;    proxy_set_header Host $host;    proxy_set_header X-Real-IP $remote_addr;    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;    proxy_set_header REMOTE-HOST $remote_addr;}location /travel/{    proxy_pass http://127.0.0.1:886/;    proxy_set_header Host $host;    proxy_set_header X-Real-IP $remote_addr;    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;    proxy_set_header REMOTE-HOST $remote_addr;        add_header X-Cache $upstream_cache_status;        #Set Nginx Cache    add_header Cache-Control no-cache;}#PROXY-END/travel/\n可以发现，问题出现在了代理配置中的location  ~* \\.(php|jsp|js|css|png|cgi|asp|aspx)$这一块。当接受到ff.cn/travel/hello.js请求时，根据代理配置进行转发，js/css/png 等文件匹配上了第一条规则，于是请求被发往127.0.0.1:80/travel/hello.js，也就刚好是ff.cn/travel/hello.js自身，造成了死循环。将这一片段或者js|css|png删除即可解决\n后记 ¶\n宝塔确实有点诡异，上一秒还好好访问的，结果突然就重定向了。以后碰到问题多看日志，更容易发现问题所在的地方。\n","categories":["技术笔记","博客成长日志"],"tags":["Nginx","反向代理"]},{"title":"随记 | 大熊座与小熊座","url":"/posts/202105-constellation1.html","content":"传说 ¶\n在古代希腊的神话故事中，大熊是温柔美丽的少女卡力斯托的化身。传说卡力斯托被众神之王宙斯所爱，生下了儿子阿卡斯。宙斯的妻子赫拉知道后非常气愤，她决定要用法力对卡力斯托进行惩罚，于是她把卡力斯托白暂的双臂变成了长满黑毛的利爪，娇红的双唇变成了血盆似的大口，让卡力斯托变成了一只大母熊。后来宙斯知道了，就把大熊提升到天上，成为大熊星座。\n\n而小熊是大熊卡力斯托的儿子阿卡斯。卡力斯托被宙斯的妻子赫拉所害变成一只大熊后，在悲哀和痛苦中度过了 15 个年头，这时卡力斯托的儿子阿卡斯长大了，成为一名英俊出色的猎手。一天，阿卡斯在林中打猎，被他的母亲卡力斯托看见了，她忘记了自己已经是熊身，便伸开双臂准备拥抱亲爱的孩子。但阿卡斯不知道这只大熊是自己的母亲，他急忙向大熊举起手中的长枪准备射击。幸亏宙斯，也就是阿卡斯的父亲，在天上看见了，他担心阿卡斯会杀死母亲，便用法术把阿卡斯也变成了一只小熊，并将母子俩一起都提升到天上，成为大熊座和小熊座。\n赫拉看到卡力斯托母子都被弄到天上，嫉妒之心油然而生。 她去请自己的哥哥海神波塞冬帮忙：永远不让卡力斯托母子从天上下海来休息喝水。于是，母子俩只得永远在北极上空转圈，不能下海。尽管如此，赫拉还不满足，她又选派一个猎人带着两只凶猛的猎犬，紧跟在大熊和小熊的后面。这个猎人就是天上的牧夫座，而他牵着的两只猎犬就是猎犬座，猎人和猎犬忠实执行神后赫拉交付的任务：紧紧看守着大熊和小熊，不停地追捕着。\n星空 ¶\n大熊座是北方天空中最明亮、最重要的星座之一, 著名的北斗七星就在这个星座里。大熊座一年四季都能看到，春季黄昏后是观测它的最好时机。在星图上，大熊座的星星被想象为一只大熊，北斗七星的斗柄是大熊的长长的尾巴，斗勺的四颗星是大熊的身躯，另一些较暗的星构成了大熊的头和脚。\n\n北斗七星从勺口到柄尾依次是天枢、天璇、天玑、天权、玉衡、开阳、摇光。前四颗组成了斗身，叫做魁；后三颗组成了斗柄，叫做杓。而开阳是一个奇特的目视双星系统，伴星叫做开阳增一（也称为辅）。后续的研究发现，开阳和辅实际上就是双星系统，开阳就被分为了开阳 A（大熊座 ζ′\\zeta'ζ′）和开阳 B（大熊座 ζ′′\\zeta''ζ′′）。\n1989 年光谱观测首先发现开阳 A 是分光双星，后来又发现开阳 B 也是分光双星，可能是三合星，所以开阳实际上是一个四合星甚至五合星系统。1996 年通过极高分辨率的望远镜拍摄出开阳 A 的两颗子星 A1 和 A2。\n\n\n小熊座的 7 颗星星也被称为小北斗，其中除 α\\alphaα、β\\betaβ 是较亮的 2 等星外，其他都是较暗的星。因此，小熊座不如北斗七星那样耀眼，在明月之夜或大城市里就不容易看到。小熊座 α\\alphaα（勾陈一）就是现在的北极星，处于北斗七星中天枢和天璇的延长线上。\n\n在大熊星座的东南方向，有两个紧挨着的 “邻居”：东边的是牧夫座，西边的是猎犬座。猎犬座原先是大熊座的一部份，是北天星座中的小星座。猎犬座也是最暗的星座之一，其中只有一颗三等星。\n\n牧夫座的大角星是全天第四亮星，之所以叫做大角是因为它被看作是四象之一的东方苍龙的一只角。此外牧夫座还包括了 8 颗 4 等以上和 21 颗 5 等以上的亮星，其中几颗中等亮度的星构成了一个五边形，像个大风筝，而最亮的大角星就像挂在风筝下面的一盏明灯。5 月下旬，沿着北斗七星斗柄几颗的曲线顺势延伸出去，画出一条大弧线，就可以在天顶附近的星空找到大角星。\n\n","categories":["随记","天文","科普"],"tags":["星座","观星"]},{"title":"评论系统 Waline","url":"/posts/202104-waline.html","content":"前言 ¶\nwaline 是由lizheming 开发的博客评论系统，从Valine 衍生的带后端评论系统。可以将Waline等价成With backend Valine。\nWaline 的服务端可以部署在Vercel、CloudBase 或者服务器上，数据库可以使用LeanCloud、MySQL 等，总计有多达 48 钟部署方式。在官方教程中，使用云服务部署都介绍的比较详细，下面介绍两种本地部署方式，可以自定义端口，配合多种数据库使用。\n\n直接部署 ¶\n直接部署方便对配置进行修改，不需要更新镜像，安装好模块后使用Node.js运行模块内的vanilla.js文件即可。\n\n安装 waline\n\nmkdir walinejs &amp;&amp; cd walinejscnpm install @waline/vercel --save\n\n创建软链接，方便后续操作\n\nln -s node_modules/@waline/vercel ./walinecd waline\n\n创建config.js文件，在里面可以添加自定义 Hook，方便用户根据自身业务需求对 Waline 服务端行为进行定制，可以参考评论 Hooks，以下为示例：\n\nconfig.jsforbiddenNicks = [    \"forbidden\"]forbiddenMails = [    \"forbidden@example.com\"]module.exports = {    // 禁止昵称或邮箱    async preSave(comment) {        const nick = comment.nick;        const mail = comment.mail;        const regNick = new RegExp('(' + forbiddenNicks.join('|') + ')', 'ig');        const regMail = new RegExp('(' + forbiddenMails.join('|') + ')', 'ig');        if (regNick.test(nick) || regMail.test(mail)) {            think.logger.debug(`Comment nick or mail check result: spam`);            return \"403\";        }    },    // 自动获取QQ邮箱，优先级高于 Gravatar    async avatarUrl(comment) {        const mail = comment.mail;        const regQQ = new RegExp('(\\\\d+)@qq\\\\.com$', 'i');        if (regQQ.test(mail)) {            const q = mail.replace(/@qq\\.com/i, '').toLowerCase();            return 'https://q1.qlogo.cn/headimg_dl?dst_uin=' + q + '&amp;spec=4';        }    },};\n\n 创建ecosystem.config.js文件，内容如下：\n\n如果你想使用配置中的邮件模板，请注意修改各种链接与标题等\n\necosystem.config.jsmodule.exports = {    apps : [{        name: 'Waline',        cwd: './',        script: './vanilla.js',                watch: false,        error_file: \"./logs/error.log\",        out_file: \"./logs/out.log\",        log_date_format: \"Z\",        merge_logs: true,        env: {            port: 8360,            NODE_ENV: 'production',            IPQPS: 180,            secureDomains: [                'foolishfox.cn',                'waline.foolishfox.cn'            ],            forbiddenWords: [                '空包',                '快递'            ],            disallowIPList: [                '171.110.238.38'            ],            SITE_NAME: 'Fox Home',            SITE_URL: 'https://www.foolishfox.cn',            AUTHOR_EMAIL: 'fox@foolishfox.cn',            AVATAR_PROXY: false,            GRAVATAR_STR: 'https://cravatar.cn/avatar/{{mail|md5}}',            MYSQL_HOST: 'localhost',            MYSQL_DB: 'db',            MYSQL_USER: 'user',            MYSQL_PASSWORD: 'password',            SMTP_USER: 'fox@foolishfox.cn',            SMTP_PASS: 'password',            mailSubject: '叮咚！『Fox Home』上有人@了你',            mailTemplate: `&lt;div&gt;            &lt;style&gt;                .box{background-color:white;border-bottom:2px solid #EB6844;border-radius:10px;box-shadow:rgba(0, 0, 0, 0.08) 0 0 18px;line-height:180%;width:500px;margin:50px auto;color:#555555;font-family:'Century Gothic','Trebuchet MS','Hiragino Sans GB',微软雅黑,'Microsoft Yahei',Tahoma,Helvetica,Arial,'SimSun',sans-serif;font-size:12px;}                .box .head{border-bottom:1px solid whitesmoke;font-size:14px;font-weight:normal;padding-bottom:15px;margin-bottom:15px;text-align: center;line-height: 28px;}                .box .head h3{margin-bottom: 0;margin: 0;}                .box .head .title{color: #EB6844;font-weight:bold;}                .box .body{padding:0 15px}                .box .body .content{background-color: #f5f5f5;padding: 10px 15px;margin:18px 0;word-wrap:break-word;}                a{text-decoration:none; color:#EB6844}                img{max-width: 100%;display:block;margin:0 auto;border-radius: inherit;border-bottom-left-radius:unset;border-bottom-right-radius:unset;}                .button:hover{background:#EB6844;color:#ffffff}                .button{display: block;margin: 0 auto;width: 15%;line-height: 35px;padding: 0 15px;border:1px solid currentColor;border-radius: 50px;text-align: center;font-weight: bold;}                .vemoji{display: inline-block;vertical-align: middle;width: 1.25em;margin: 0.25em;}            &lt;/style&gt;            &lt;div class=\"box\"&gt;                &lt;img src=\"https://asset.foolishfox.cn/images/static/fox_paint.jpg\"&gt;                &lt;div class=\"head\"&gt;                    &lt;h3&gt; {{parent.nick}} ，&lt;/h3&gt;有人回复了你在 &lt;a href=\"https://www.foolishfox.cn\" target=\"_blank\"&gt; Fox Home &lt;/a&gt;上的评论！                &lt;/div&gt;                &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;你评论的：                &lt;div class=\"body\"&gt;                    &lt;div class=\"content\"&gt;{{parent.comment | safe}}&lt;/div&gt;                    &lt;p&gt;被 &lt;strong&gt; {{self.nick}} &lt;/strong&gt;回复：&lt;/p&gt;                    &lt;div class=\"content\"&gt;{{self.comment | safe}}&lt;/div&gt;                    &lt;p style=\"margin:20px auto\"&gt;                        &lt;a class=\"button\" href=\"https://www.foolishfox.cn{{self.url}}\" target=\"_blank\"&gt; 点击查看 &lt;/a&gt;                        &lt;/p&gt;                            &lt;center&gt;欢迎再来 &lt;a href=\"https://www.foolishfox.cn\" target=\"_blank\"&gt;Fox Home&lt;/a&gt; ！ &lt;/center&gt;                        &lt;p&gt;                    &lt;/p&gt;                &lt;/div&gt;            &lt;/div&gt;            &lt;/div&gt;`,            MAIL_SUBJECT_ADMIN: '叮咚！『Fox Home』上有新评论啦~',            MAIL_TEMPLATE_ADMIN: `&lt;div&gt;            &lt;style&gt;                .box{background-color:white;border-bottom:2px solid #EB6844;border-radius:10px;box-shadow:rgba(0, 0, 0, 0.08) 0 0 18px;line-height:180%;width:500px;margin:50px auto;color:#555555;font-family:'Century Gothic','Trebuchet MS','Hiragino Sans GB',微软雅黑,'Microsoft Yahei',Tahoma,Helvetica,Arial,'SimSun',sans-serif;font-size:12px;}                .box .head{border-bottom:1px solid whitesmoke;font-size:14px;font-weight:normal;padding-bottom:15px;margin-bottom:15px;text-align: center;line-height: 28px;}                .box .head h3{margin-bottom: 0;margin: 0;}                .box .head .title{color: #EB6844;font-weight:bold;}                .box .body{padding:0 15px}                .box .body .content{background-color: #f5f5f5;padding: 10px 15px;margin:18px 0;word-wrap:break-word;}                a{text-decoration:none; color:#EB6844}                img{max-width: 100%;display:block;margin:0 auto;border-radius: inherit;border-bottom-left-radius:unset;border-bottom-right-radius:unset;}                .button:hover{background:#EB6844;color:#ffffff}                .button{display: block;margin: 0 auto;width: 15%;line-height: 35px;padding: 0 15px;border:1px solid currentColor;border-radius: 50px;text-align: center;font-weight: bold;}                .vemoji{display: inline-block;vertical-align: middle;width: 1.25em;margin: 0.25em;}            &lt;/style&gt;            &lt;div class=\"box\"&gt;                &lt;img src=\"https://asset.foolishfox.cn/static/fox_paint.jpg\"&gt;                &lt;div class=\"head\"&gt;                    &lt;h3&gt; {{self.nick}} ，&lt;/h3&gt;在 &lt;a href=\"https://www.foolishfox.cn\" target=\"_blank\"&gt; Fox Home &lt;/a&gt;上评论了！                &lt;/div&gt;                &lt;div class=\"body\"&gt;                    &lt;div class=\"content\"&gt;{{self.comment | safe}}&lt;/div&gt;                    &lt;p style=\"margin:20px auto\"&gt;                        &lt;a class=\"button\" href=\"https://www.foolishfox.cn{{self.url}}\" target=\"_blank\"&gt; 点击查看 &lt;/a&gt;                    &lt;/p&gt;                &lt;/div&gt;            &lt;/div&gt;            &lt;/div&gt;`        },    }],    deploy : {        production : {            user : 'SSH_USERNAME',            host : 'SSH_HOSTMACHINE',            ref    : 'origin/master',            repo : 'GIT_REPOSITORY',            path : 'DESTINATION_PATH',            'pre-deploy-local': '',            'post-deploy' : 'npm install &amp;&amp; pm2 reload ecosystem.config.js --env production',            'pre-setup': ''        }    }};\n\n 使用 pm2 运行程序\n\ncnpm install -g pm2pm2 start ecosystem.config.js\n\n设置反向目录代理，将waline.foolishfox.cn指向127.0.0.1:8360\n\nDocker¶\n关于 Docker 的相关信息已经过时\n\ndocker 配置在 Docker 容器内运行vanilla.js文件。\n\n修改Node.js淘宝源\n\n# 单次使用npm install module_name --registry=https://registry.npm.taobao.org# 永久修改npm config set registry https://registry.npm.taobao.org# 使用cnpm，安装了cnpm之后，npm install 都可以换成cnpm installnpm install -g cnpm --registry=https://registry.npm.taobao.org\n\n构建镜像\n\ngit clone https://github.com/lizheming/waline.gitcd walinedocker build -t image_name -f packages/server/Dockerfile .\n\n修改配置packages/client/.env，参考文档中所需环境变量配置即可\n\n.envSKIP_PREFLIGHT_CHECK=true# 数据库配置，参考https://waline.js.org/server/databases.htmlMYSQL_HOST=127.0.0.1MYSQL_DB=db_nameMYSQL_USER=db_userMYSQL_PASSWORD=passwordAKISMET_KEY=guessSITE_NAME=Fox HomeSITE_URL=https://www.foolishfox.cnAUTHOR_EMAIL=fox@foolishfox.cnSC_KEY=SCK232027Td54bfab83cfabf0aereq2c31b6552cd35fe1a43720074SMTP_HOST=smtp.ym.163.comSMTP_PORT=465SMTP_USER=fox@foolishfox.cnSMTP_PASS=passwordSENDER_NAME=foxSENDER_EMAIL=fox@foolishfox.cn\n\n 运行镜像\n\ndocker run --env-file ./packages/client/.env -p 8360:8360 -d image_name\n\n设置反向目录代理，将waline.foolishfox.cn指向127.0.0.1:8360\n进入容器\n\n# 查看容器idroot@iZ2ze8k2vy63cz277rsw8zZ:$ docker ps -aCONTAINER ID   IMAGE              COMMAND                  CREATED          STATUS          PORTS                    NAMEScebd15a83483   lizheming/waline   \"docker-entrypoint.s…\"   44 seconds ago   Up 42 seconds   0.0.0.0:8360-&gt;8360/tcp   admiring_noether# 进入容器root@iZ2ze8k2vy63cz277rsw8zZ:$ docker exec -it cebd15a83483 /bin/bash\n\n安装vim（可跳过）与验证组件\n\napt updateapt install vimapt install apt-transport-https ca-certificates\n\n更新软件源（使用清华源）\n\n# 备份mv /etc/apt/sources.list /etc/apt/sources.list.bak# vim修改vim /etc/apt/sources.list# echo修改echo \"deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free\" &gt;/etc/apt/sources.list# 更新apt update...\n# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-freedeb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-freedeb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-freedeb https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free\n\n配置config.js，路径为：node_modules/@waline/vercel/config.js，参考服务端配置\n\nmodule.exports = {    secureDomains: [        'foolishfox.cn',        'waline.foolishfox.cn',        'localhost',        '127.0.0.1'    ],    forbiddenWords: [        '空包',        '快递',        '下单'    ],    disallowIPList: [        '8.8.8.8'    ]};\n\n修改主程序vanilla.js，导入自定义配置（已提交 PR 进行修复，无需再进行更改）\n\nconst path = require('path');const Application = require('thinkjs');...let config = {}try {    config = require('./config.js');} catch(e) {}...\n前端配置 ¶\n参考文档，需要注意的有：\n\n本地 (localhost) 访问不增加计数（以hexo为例）\n\nnew Waline({    el: '#waline',    path: location.pathname,    serverURL: 'https://your-serverURL.domain.com',    visitor: location.hostname!=='localhost' &amp;&amp; !{ theme.waline.visitor }});\n参考资料 ¶\n\nwaline\n博客服务器迁移过程\npm2 入门\n\n","categories":["技术笔记","博客成长日志"],"tags":["教程","Waline"]},{"title":"折腾日志 | Termux 安装云探针","url":"/posts/202105-termux-status.html","content":"有关 Termux 的详细教程，请查看Termux 高级终端安装使用配置教程 - 国光\n以下内容可适用于其他 Linux 发行版\n\n前言 ¶\nServerStatus 可以实时监控服务器的网络、负载、内存占用等信息，也被称为云探针、多服务器探针、云监控、多服务器云监控，本人追溯到最早源自于BotoX 的项目。\nDisplay and monitor your servers statistics in a beatiful way\n\n\n后人经过多位大佬的修改、汉化和美化，已经有多个版本的 ServerStatus 可供部署，本文采用的是由CokeMine 开发的ServerStatus-Hotaru 版本。\n安装 ¶\n服务端 ¶\n\n 获取文件\n\nwget https://raw.githubusercontent.com/CokeMine/ServerStatus-Hotaru/master/status.shchmod +x status.sh\n\n安装服务端\n\n运行./status.sh s，配置按推荐即可，如果服务器上有 Nginx / Apache，则不需要安装 Caddy，否则建议选择 Y 一键配置 HTTP 服务\n\n\n添加客户端信息：打开/usr/local/ServerStatus/server/config.json，修改如下:\n\n{\"servers\": [  {   \"username\": \"A\",   \"password\": \"A\",   \"name\": \"Fox Home\",   \"type\": \"KVM\",  // 现在一般云服务器都是KVM   \"host\": \"\",   \"location\": \"杭州\",   \"disabled\": false,   \"region\": \"CN\"   // region信息在文件/usr/local/ServerStatus/region.json中  },  {    \"username\": \"B\",    \"password\": \"B\",    \"name\": \"Fox Lab\",    \"type\": \"KVM\",    \"host\": \"\",    \"location\": \"香港\",    \"disabled\": false,    \"region\": \"HK\"   } ]}\n\n启动服务端\n\n客户端 ¶\n运行./status.sh c安装客户端，配置信息按照前文服务端配置（username和password）填写即可\n其他 ¶\nTermux 适配 ¶\nTermux 端不建议按照服务端\n\n从仓库中下载 status-client.py，对一下内容进行修改：\n...def get_hdd():    p = subprocess.check_output(['df']).decode('utf-8')    # 在终端中运行df命令，查看/data对应的那一行的行号就是X+1    total = p.splitlines()[X]    used = int(total.split()[2])/1024    size = int(total.split()[1])/1024    return int(size), int(used)def get_load():    p = subprocess.check_output(['uptime']).decode('utf-8')    return round(float(p.split(', ')[3].split(': ')[1]), 2)*100...\n修改前端 / 主题 ¶\n由于前端文件已经被打包过了，所以不建议直接修改格式化打包后的 js / css 文件，建议自行下载修改再打包，复制 dist 目录到服务器。\ngit clone https://github.com/CokeMine/Hotaru_theme.gitcd ./Hotaru_theme &amp;&amp; npm install# 修改完成之后npm run build\nWindows 适配 ¶\n使用Psutil 版即可使 ServerStatus 客户端在 Windows 等平台运行\npip install psutil# 修改status-psutil.pypython status-psutil.py\n参考资料 ¶\n\nServerStatus-Hotaru\nServerStatus-Hotaru 云探针的安装与配置\n想改网页内的几个字 如何操作\n\n","categories":["技术笔记","Termux"],"tags":["教程","Python","ServerStatus","Termux"]},{"title":"折腾日志 | Yourls—— 短链接生成器与短域名获取","url":"/posts/202105-yourls.html","content":"前言 ¶\n你是否遇到过这样的场景？你有一个链接，例如https://detail.tmall.com/item.htm?spm=a230r.1.14.1.16b64046kb50gr&amp;id=563033197139&amp;ns=1&amp;abbucket=5，需要分享给朋友，这个链接长而且不好记忆，需要经常用到的时候也不方便，假设你需要发微博，由于字数限制，链接长度越短越好，这时候如果有一个链接https://short.cn/tmall经过重定向可以指向前文的网址，那边就会很美观且方便，而这就需要用到短链接生成技术。\n\n其实短链接的作用主要在于数据统计、控制访问、便于管理。另外相同的页面，短链接与原链接生成的二维码的复杂度也大大不同。目前市面上主要的短链接服务可以参考：短网址服务，我们该怎么选？，其中安照优先级介绍了部分优质的服务提供商。\n除了使用服务商提供的短链接生成服务外，我们其实还可以自己搭建一个这样的服务。原理很简单，通过某种算法将长链接A转化为一个短字符串B，浏览器结合域名C访问C/B，服务器响应跳转至A，并在过程中完成数据的统计。目前有很多开源的短链接服务，其中之一就是今天的主角Yourls。\n\nYourls¶\n\nYOURLS stands for Your Own URL Shortener. It is a small set of PHP scripts that will allow you to run your own URL shortening service (a la TinyURL or Bitly).\nRunning your own URL shortener is fun, geeky and useful: you own your data and do not depend on third-party services. It is also a great way to add branding to your short URLs, instead of using the same public URL shortener everyone uses.\n\nYourls的特性是开源免费，可以管理、统计每一个短链接的数量，提供 API 接口，而且具有众多插件，便于进行二次开发，下面就一起搭建一个自己的软链接服务。\n准备 ¶\nYourls 是基于 PHP 和 MySQL 开发的，所以需要提前准备好：\n\nApache（2.4 版本及以上）或 Nginx 服务器\nPHP（7.4 版本及以上）\nMySQL（5.0 版本及以上）\n\n另外如果需要使用 API 接口，还需要安装 PHP cURL 拓展。\n安装 ¶\n下载 ¶\n从Releases 下载最新版本的安装包，目前使用的是 1.8.1 版本，并解压至工作目录\n配置文件 ¶\n将user目录下的config-sample.php复制备份命名为config.php，修改配置如下，更多设置请参考 Config\n// 数据库配置define( 'YOURLS_DB_USER', 'yourls' );   //用户名define( 'YOURLS_DB_PASS', 'xxxxxxxx' );   //密码define( 'YOURLS_DB_NAME', 'yourls' );   //数据库名define( 'YOURLS_DB_HOST', 'localhost' );   //地址define( 'YOURLS_DB_PREFIX', 'yourls_' );   //表前缀// 站点设置#设置站点define( 'YOURLS_SITE', 'http://ozh.in' );   //域名define( 'YOURLS_LANG', '' );   //语言define( 'YOURLS_UNIQUE_URLS', true );   //是否允许长链接对应多个短链接define( 'YOURLS_HOURS_OFFSET', '-5' );   //时区偏移define( 'YOURLS_PRIVATE', 'true' );   //是否私有，如果私有的，则api接口需要传递用户名和密码，如果公开，则可以自由访问后台define( 'YOURLS_COOKIEKEY', 'modify this text with something random' );   //设置cookie，可访问http://yourls.org/cookie生成// 用户设置$yourls_user_passwords = array(    'username' =&gt; 'password',   //用户名=&gt;密码，可填多个，登录成功后这里的明文密码会被加密    );define( 'YOURLS_DEBUG', false );   //是否开启调试define( 'YOURLS_URL_CONVERT', 62 );   //短链接字符串使用36进制或2进制，建议62进制$yourls_reserved_URL = array(    'porn', 'faggot', 'sex', 'nigger', 'fuck', 'cunt', 'dick',   //黑名单);\n服务器设置 ¶\n\nApache\n需要开启mod_rewrite模块，编辑.htaccess 文件：\n\nconfiguration# 根目录http://yoursite/# BEGIN YOURLS&lt;IfModule mod_rewrite.c&gt;RewriteEngine OnRewriteBase /RewriteCond %{REQUEST_FILENAME} !-fRewriteCond %{REQUEST_FILENAME} !-dRewriteRule ^.*$ /yourls-loader.php [L]&lt;/IfModule&gt;# END YOURLS# 二级目录http://yoursite/somedir/# BEGIN YOURLS&lt;IfModule mod_rewrite.c&gt;RewriteEngine OnRewriteBase /somedir/RewriteCond %{REQUEST_FILENAME} !-fRewriteCond %{REQUEST_FILENAME} !-dRewriteRule ^.*$ /somedir/yourls-loader.php [L]&lt;/IfModule&gt;# END YOURLS\n\nNginx\n请注意宝塔用户安照文档中的操作可能无效，可以更改为：\n\nconfigurationserver {  # HTTP over IPv4 &amp; IPv6  listen 80;  listen [::]:80;  # HTTPS over IPv4 &amp; IPv6  # MUST BE EDITED TO REFLECT YOUR CONFIGURATION  listen 443 ssl;  listen [::]:443 ssl;  ssl_certificate     example.com.crt;  ssl_certificate_key example.com.key;  # Server names  # MUST BE EDITED TO REFLECT YOUR CONFIGURATION  server_name example.com www.example.com;  # Root directory  # MUST BE EDITED TO REFLECT YOUR CONFIGURATION  root /path/to/yourls/files;  # 更改部分在这里！！！  # 更改部分在这里！！！  # 更改部分在这里！！！  location /    {      if (!-f $request_filename){      set $rule_0 1$rule_0;    }    if (!-d $request_filename){      set $rule_0 2$rule_0;    }    if ($rule_0 = \"21\"){      rewrite ^/.*$ /yourls-loader.php last;    }  }  # PHP engine  location ~ \\.php$ {    include fastcgi.conf;    # OR    # include fastcgi_params;        fastcgi_index index.php;        # MUST BE EDITED TO REFLECT YOUR CONFIGURATION    fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;  }}\n安装 ¶\n访问http://domain.com/admin完成初安装，输入配置文件设置的账号、密码登陆后台。如果安装出错，可能是 PHP 或者 MySQL 版本不符合要求，或者是数据库初始化失败，可以按照参考资料 3 进行解决。\n短域名 ¶\n短链接最重要的还是根域名要短，但是以.com、.cn、.org、.top、.xyz等常见一级域名的短域名基本已经抢注完成，剩下的价格也很昂贵。为了减小这个问题带来的影响，有两种解决方案。\n付费域名 ¶\n在我国的.cn域名下有一类特殊的二级域名：按照国家各个省级行政区划分的行政区划域名，例如bj.cn代表北京，sh.cn代表上海等。这些域名注册比较少，一些比较短的域名（例如fox.hn.cn，湖南）很有可能没有被注册，而且价格很便宜。目前西部数码、域趣网络等都提供这一类域名的注册。\n免费域名 ¶\n由于特殊原因，Freenom 目前已经停止注册新的免费域名。\n\nFreenom 是国际著名的免费域名提供商，可以提供.tk（托克劳）、.ml（马里）、.ga（加蓬）、.cf（中非共和国）、.gq（赤道几内亚）等国家一级域名，除特殊域名（少于 4 个字母，特殊含义等）外均可免费获取。\n\n在 Freenom 获取免费域名有几个需要注意的地方：\n1. 需要科学上网\n2. 注册账号时，填写的地址信息一定要与科学上网后的 IP 地址保持一致，最好在美国! 最好在美国! 最好在美国!\n3. 点击上图的现在获取会显示不可用，此时你只需要在搜索框中输入ffox.ga就可以解决，自动帮你添加购物车\n\n拓展与配置 ¶\nYourls 具有丰富的插件和主题，还有各种语言的翻译包，所有的插件都能在awesome-yourls 找到介绍与项目地址。下面介绍一些我使用的拓展。\n插件 ¶\n\nAllow Hyphens in Short URLs\n\n自带的插件，允许短链接中出现连字符。\n\nRandom ShortURLs\n\n默认情况下，短链接按照顺序生成，从 1 开始，但是更好的方式是使用时间戳或随机字符串，这一个插件就可以随机生成短链接字符串，还可以设置字符串的长度。\n\nCache stat pages\n\n后台查看统计报表的数据都是实时统计的，此插件可以将缓存统计报表，加快访问速度。\n\nYOURLS Static Titles\n\n当你输入一个长链接生成短链时，YOURLS 会抓取长链接对应页面的标题信息，所以创建短链接的速度会受到页面访问速度的影响，此插件可以经过设置跳过抓取标题，加快生成速度。除了这一种方案以外，还可以根据参考资料 4 进行配置。\n翻译 ¶\n下载汉化包中的zh_CN.mo文件，移动至/user/languages文件夹下，设置配置文件中的语言为zh_CN即可。\n主题 ¶\n目前官方页面的主题只有 3 个，大家可以搜寻比较好看的。我使用的主题是 Sleeky，不仅很好看而且还会添加前端首页。\n\n下载文件\n移动sleeky-frontend文件夹到网站根目录下\n配置frontend/config.php\n移动sleeky-backend文件夹至user/plugins/目录\n在后台管理中example.com/admin/plugins.php启用插件\n\n\n其他 ¶\n查看统计数据，可以在后台的管理界面中数据统计查看，也可以在短链接后面添加+查看，例如https://short.cn/tmall+，包括访问量、地区和来源等。\n\n参考资料 ¶\n\nYOURLS: Your Own URL Shortener\nYOURLS Wiki\n用 yourls 搭建短链接地址服务\n关于 yourls 生成短链耗时太长问题解决\nHEXO 博客引用 B 站视频并自动适配\n\n","categories":["技术笔记"],"tags":["教程","Yourls","短域名"]},{"title":"准实时访问统计","url":"/posts/202105-visit.html","content":"由于百度统计改版，对数据作出限制，已弃用该方案。目前使用自建服务进行统计，可查看自建 Umami 统计\n\n前言 ¶\n通过百度统计、CNZZ 等服务，我们可以记录站点的访问地图、访问量和来源，如果想要展示数据，可以选择直接导向服务商提供的公开页面，但是样式丑陋，所以本文通过百度统计 API，使用 Echarts 制作站点访问准实时统计页面，效果可以参考统计。\n\n之所以说是准实时统计，是因为为了解决跨域问题（CROS error），本文采用的方法是定时通过百度统计 API 将数据下载保存为 json 文件，放置在网站目录下（后续可能会发展为 vercel api，挖坑）。不过作为个人博客，方式访问量不会很大，没有必要实时更新，目前本站设置是每隔 6 小时更新一次。\n数据获取 ¶\n百度统计 ¶\n在设置样式之前首先需要获取统计数据，使用百度账号登陆百度统计，根据参考资料 4 进行操作，获取 token 与 site_id，具体教程可以查看参考资料 1。\n下载文件 ¶\n通过 6 个链接，我们可以获取：一年内每日访问统计、访问地图数据、月度访问统计、来源分类统计、搜索引擎访问统计和外部链接访问统计；通过 python 或者 nodejs 都可以很方便的下载文件保存，以下为 python 的示例：\nimport requestsimport time, datetime# 开始统计的日期start_date   = '20201218'date         = datetime.datetime.now()# 结束统计的日期end_date     = str(date.year) + (str(date.month) if date.month &gt; 9 else ('0' + str(date.month))) + (str(date.day) if date.day &gt; 9 else ('0' + str(date.day)))# token和siteidaccess_token = '121.6e...'site_id      = '16******'# 百度统计APIdataUrl      = 'https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=' + access_token + '&amp;site_id=' + site_id# 统计访问次数 PV 填写 'pv_count'，统计访客数 UV 填写 'visitor_count'，二选一metrics      = 'pv_count'def downFile(url, fileName, prefix='/home/API/data/'):    print('downloading :', url)    down_res = requests.get(url)    with open(prefix+fileName, 'wb') as f:        f.write(down_res.content)    print('writing :', prefix+fileName)# 访客地图downFile(dataUrl + '&amp;start_date=' + start_date + '&amp;end_date=' + end_date + '&amp;metrics=' + metrics + '&amp;method=visit/district/a',     'map.json')# 访问趋势downFile(dataUrl + '&amp;start_date=' + start_date + '&amp;end_date=' + end_date + '&amp;metrics=' + metrics + '&amp;method=trend/time/a&amp;gran=month',     'trends.json')# 访问来源downFile(dataUrl + '&amp;start_date=' + start_date + '&amp;end_date=' + end_date + '&amp;metrics=' + metrics + '&amp;method=source/all/a',     'sources.json')## 搜索引擎downFile(dataUrl + '&amp;start_date=' + start_date + '&amp;end_date=' + end_date + '&amp;metrics=' + metrics + '&amp;method=source/engine/a',     'engine.json')## 外部链接downFile(dataUrl + '&amp;start_date=' + start_date + '&amp;end_date=' + end_date + '&amp;metrics=' + metrics + '&amp;method=source/link/a',     'link.json')# 访问日历'''访问日历需要获取一年内的数据，按照一年365天计算，大概为52周多一点，所以前面有完整的52排，获取方式只要通过开始日期年份-1即可然后就是第53排的处理，python中的date.weekday()获取的星期几是0对应周一，所以通过(date.weekday()+1)%7即可转换到0对应周日于是在52周的基础上，减去星期数，就可以得到新的start_date'''date       = datetime.datetime(date.year-1, date.month, date.day)date       = datetime.datetime.fromtimestamp(date.timestamp()-3600*24*((date.weekday()+1)%7))start_date = str(date.year) + (str(date.month) if date.month &gt; 9 else ('0' + str(date.month))) + (str(date.day) if date.day &gt; 9 else ('0' + str(date.day)))downFile(dataUrl + '&amp;method=overview/getTimeTrendRpt' + '&amp;metrics=' + metrics + '&amp;start_date=' + start_date + '&amp;end_date=' + end_date,    'calendar.json')\n自动更新 ¶\n在 Linux 中可以通过crontab设置定时任务，以下为每整 6 小时的 0 点执行一次任务：\n0 0 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log0 6 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log0 12 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log0 18 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log# 或者0 0,6,12,18 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log# 或者0 */6 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log\n数据展示 ¶\n统计图容器 ¶\n在 html 代码中插入：\n&lt;script src=\"https://cdn.jsdelivr.net/npm/echarts@4.7.0/dist/echarts.min.js\"&gt;&lt;/script&gt;&lt;script src=\"https://cdn.jsdelivr.net/npm/echarts@4.7.0/map/js/china.js\"&gt;&lt;/script&gt;&lt;div style=\"max-width: 90%;margin: 0 auto;\"&gt;    &lt;div id=\"calendar_container\" class=\"data-container\"&gt;&lt;/div&gt;    &lt;div id=\"map_container\" class=\"data-container\" style=\"height: 500px;\"&gt;&lt;/div&gt;    &lt;div id=\"trends_container\" class=\"data-container\" style=\"height: 350px;\"&gt;&lt;/div&gt;    &lt;div id=\"sources_container\" class=\"data-container\" style=\"height: 450px;\"&gt;&lt;/div&gt;&lt;/div&gt;&lt;!-- 更新：两个js文件合一 --&gt;&lt;script src=\"https://www.foolishfox.cn/js/census.js\"&gt;&lt;/script&gt;\n访问日历 ¶\n访问日历类似于 Github 贡献日历，有两种方法实现。\n\n源自于hexo-githubcalendar 插件，由Eurkon 修改，原文见参考资料 3。需要修改的地方有：\n\n...// 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模fetch('https://api.foolishfox.cn/data/calendar.json?date'+new Date()).then(data =&gt; data.json()).then(res =&gt; {...// 统计访问次数 PV 填写 'pv_count'，统计访客数 UV 填写 'visitor_count'，二选一visit_calendar('pv_count', visit_color);...\n另外，需要更改容器 id 可以直接搜索替换即可。\n\n通过census.js 进行设置，包括后续的访问地图、访问趋势（访问次数）和访问来源都是基于此文件通过 Echarts 实现的。\n\n// 统计访问次数 PV 填写 'pv_count'，统计访客数 UV 填写 'visitor_count'，二选一var metrics     = 'pv_count'var metricsName = (metrics === 'pv_count' ? '访问次数' : (metrics === 'visitor_count' ? '访客数' : ''))...function calChart () {    let script = document.createElement(\"script\")    // 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模    fetch('https://api.foolishfox.cn/data/calendar.json?date'+new Date()).then(data =&gt; data.json()).then(data =&gt; {        ...        // 颜色盒，用于设置不同数据的展示颜色，可更改        let colorBox = ['#EBEDF0', '#FFE9BB', '#FFD1A7', '#FFBB95', '#FFA383', '#FF8D70', '#FF745C', '#FF5C4A', '#FF4638', '#FF2E26', '#FF1812'];\n访问地图 ¶\n最简单的就是访问地图，直接修改 json 文件的请求 url 即可：\n// 访问地图function mapChart () {    let script = document.createElement(\"script\")    // 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模    fetch('https://api.foolishfox.cn/data/map.json?date'+new Date()).then(data =&gt; data.json()).then(data =&gt; {\n访问趋势 ¶\n访问趋势中按照年份，将 12 个月的数据展开，需要从 json 中获取到年份和月份信息，由于时间日期格式是固定的，所以可以直接截取。本部分代码以下列展示的为准：\n// 获取年份和月份function get_year(s) {    return parseInt(s.substr(0, 4))}function get_month(s) {    return parseInt(s.substr(5, 2))}// 访问趋势function trendsChart () {    let script = document.createElement(\"script\")    // 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模    fetch('https://api.foolishfox.cn/data/trends.json?date'+new Date()).then(data =&gt; data.json()).then(data =&gt; {        let date = new Date();        let monthValueArr = {};        let monthName = data.result.items[0];        let monthValue = data.result.items[1];        // 2020是起始年份，改为你自己的        for (let i =2020; i &lt;= date.getFullYear(); i++)   monthValueArr[String(i)] = [ ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  ];        monthValueArr        for (let i = 0; i &lt; monthName.length; i++) {            let year = get_year(monthName[i][0]);            let month = get_month(monthName[i][0]);            monthValueArr[String(year)][String(month-1)] = monthValue[i][0];        }        // 以后每过一年，需要手动添加以下legend和series        script.innerHTML = `        var trendsChart = echarts.init(document.getElementById('trends_container'), 'light');        var trendsOption = {            title: { text: '访问趋势', x: 'center' },            tooltip: { trigger: 'axis' },            legend: { data: ['2020', '2021', '2022'], x: 'right' },            xAxis: {                name: '日期', type: 'category', boundaryGap: false,                data: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月']            },            yAxis: { name: '${metricsName}', type: 'value' },            series: [                {                    name: '2020', type: 'line', smooth: true,                    data: [${monthValueArr[\"2020\"]}],                    markLine: { data: [{type: 'average', name: '平均值'}] }                },                {                    name: '2021', type: 'line', smooth: true,                    data: [${monthValueArr[\"2021\"]}],                    markLine: { data: [{type: 'average', name: '平均值'}] }                },                {                    name: '2022', type: 'line', smooth: true,                    data: [${monthValueArr[\"2022\"]}],                    markLine: { data: [{type: 'average', name: '平均值'}] }                }            ]        };        trendsChart.setOption(trendsOption);        window.addEventListener(\"resize\", () =&gt; {             trendsChart.resize();        });`        document.getElementById('trends_container').after(script);    }).catch(function (error) {        console.log(error);    });}\n访问来源 ¶\n留在最后的是最复杂的访问来源，实际上百度的全部来源 (source/all/a) API 可以将来源分为：直达、外部链接和搜索引擎三个部分，直接使用并不困难。但是百度统计会将必应（cn.bing.com和www.bing.com）的来源归类到外部链接而不是搜索引擎，而且我自己还想统计来自于 Github、十年之约等网站的流量，所以需要获取多个数据文件。\n...// 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模fetch('https://api.foolishfox.cn/data/sources.json?date'+new Date()).then(data =&gt; data.json()).then(data =&gt; {    let sourcesName = data.result.items[0];    let sourcesValue = data.result.items[1];    let sourcesArr = [];    for (let i = 0; i &lt; sourcesName.length; i++)        sourcesArr.push({ name: sourcesName[i][0].name, value: sourcesValue[i][0] });    // 记录总体数据，方便后续调用（使用var定义在fetch外面）    link = sourcesArr[1]['value'] ;    search = sourcesArr[2]['value'];    direct = sourcesArr[0]['value'];...// 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模fetch('https://api.foolishfox.cn/data/link.json?date'+new Date()).then(data =&gt; data.json()).then(data =&gt; {    let linksName = data.result.items[0];    let linksValue = data.result.items[1];    let linksArr = {};    for (let i = 0; i &lt; linksName.length; i++)        linksArr[linksName[i][0].name] = linksValue[i][0];    // 除必应外，其他的都是自己想要统计的网站，都是http链接    let sum = data.result.sum[0][0];    let bing = linksArr['http://cn.bing.com']+linksArr['http://www.bing.com'];    let github = linksArr['http://github.com'];    let travel = linksArr['http://travellings.now.sh']+linksArr['http://travellings.vercel.app']+linksArr['http://www.foreverblog.cn'];    innerHTML += `                    {value: ${bing}, name: '必应'},                    {value: ${direct}, name: '直达'},                    {value: ${github}, name: 'Github'},                    {value: ${travel}, name: '开往/十年之约'},`+                    // 将来自于必应的访问减去                    `{value: ${sum-bing-github-travel}, name: '其他'}                ]            },            {                name: '访问来源', type: 'pie', selectedMode: 'single', radius: [0, '30%'],                label: { position: 'inner', fontSize: 14},                labelLine: { show: false },                data: [`+                    // 将来自于必应的访问从外链中减去，加入搜索中                    `{value: ${search+bing}, name: '搜索', itemStyle: { color : 'green' }},                    {value: ${direct}, name: '直达', itemStyle: { color : '#FFDB5C' }},                    {value: ${link-bing}, name: '外链', itemStyle: { color : '#32C5E9' }}                ]            },        ]    };...\nQ&amp;A¶\n\n 不想使用 python 下载文件保存，想要实时统计\n\n根据参考资料 2 中 4.3 节 —— 自建 Vercel API（可选）进行设置，替换上述文件中的 url 即可（感谢秋水）\n根据参考资料 2 中 5.3 节进行设置，替换上述js文件中的url即可，具体形式可参考参考资料 2 中 4.2 节。\n\n依然出现跨域问题？\n\n请务必保证通过 2.2 节获取的文件保存在博客的网站目录下，并通过 url 可以访问；如果想要向我一样通过其他域名（例如api.foolishfox.cn/data/*.json）访问，需要对服务器进行设置，以 Nginx 为例：\nconfiguration#data CROSlocation ~ ^/data/ {    if ($http_origin ~* (http://localhost:4000|https://www.foolishfox.cn)) {        add_header 'Access-Control-Allow-Origin' \"$http_origin\";        add_header 'Access-Control-Allow-Credentials' 'true';        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';        add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';    }}\n\n 地图显示错误\n\n务必注意，Echarts 目前已经不提供地图 js / json 文件的下载，所以要通过 npm 获取到旧版本中的China.js文件，因此 Echarts 的版本最好也保持一致\n\nEcharts 绘制的访问日历无法自动适应窗口大小\n\n正在积极解决中…\n更新 ¶\n\n2021.6.1：访问趋势中第 23 行代码应改为：\n\nmonthValueArr[String(year)][String(month-1)] = monthValue[i][0] === '--' ? 0 : monthValue[i][0];\n\n自动更新token\n百度统计的token需要每个月更新一次，手动更新很麻烦，所以可以在代码中添加这一功能。首先更改downFile函数：\n\ndef downFile(url, fileName, prefix='./'):    res = requests.get(url)    res = json.loads(res.content)    if('error_code' in res.keys()):        update(prefix=prefix)        downFile(url, fileName, prefix)    with open(prefix+fileName, 'w') as f:        json.dump(res, f)\n当发现token错误时，我们执行update函数：\ndef update(prefix, url=updateUrl):    res = requests.get(url)    res = json.loads(res.content)    print(res)    config['access']  = res['access_token']    config['refresh'] = res['refresh_token']    with open(prefix + 'token.json', 'w') as f:        json.dump(config, f)\nconfig是通过json加载了目录下的token.json文件，格式如下所示，注意添加访问权限（例如Nginx中添加该路径返回403）。\n// config = json.load(open('./token.json')){    \"access\": \"access token\",    \"refresh\": \"refresh token\",    \"site_id\": \"site id\",    \"api_key\": \"api key\",    \"serect_key\": \"serect key\"}\nupdateUrl是自动更新的url：\nupdateUrl  = 'http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&amp;refresh_token=' + config['refresh'] + '&amp;client_id=' + config['api_key'] + '&amp;client_secret=' + config['serect_key']\n完整的py文件可以点击下载。\n参考资料 ¶\n\nHexo 博客访问统计图\nHexo 博客实时访问统计图\nHexo 博客访问日历图\n百度统计用户手册\nEcharts 文档\n\n","categories":["技术笔记","博客成长日志"],"tags":["Hexo","站点统计","Echarts"]},{"title":"Windows 下 Geant4 的安装与示例","url":"/posts/202204-g4b.html","content":"Geant4(GEometry ANd Tracking，几何和跟踪) 是由CERN (欧洲核子研究组织) 基于C++面向对象技术开发的蒙特卡罗应用软件包，用于模拟粒子与物质的相互作用，在高能物理、加速器、核物理、辐射防护等多个领域都有着广泛的应用。\n\n安装 ¶\n环境要求 ¶\n\n源代码\nMSVC 19\nCMaKe &gt;= 3.16\nQt5（optional，可选）\n\nMSVC\n只要求MSVC版本为19.X.X.X，不要求Visual Studio版本为VS 2019，通过在VS中打开isual Studio Tools (工具) → Developer Command Prompt for VS201X (Visual Studio 命令提示)可以查看MSVC版本：\n&gt;cl用于 x86 的 Microsoft (R) C/C++ 优化编译器 19.31.31104 版版权所有(C) Microsoft Corporation。保留所有权利。用法: cl [ 选项... ] 文件名... [ /link 链接选项... ]\nQt\n必须是Qt5，目前暂不支持Qt6，推荐使用Qt 5.15 LTS。\n\n安装前准备 ¶\nCMaKe¶\n推荐使用Scoop 进行安装，可以方便的进行版本更新，自动添加环境变量等：\nscoop install cmake\nQt（可选）¶\nQt 是一个可选项，可以美化Geant4的GUI显示，注意版本必须为5.X.X，目前最新的 LTS 版本是5.15.3。从下载页面获取在线安装程序，本过程需要Qt账号，可以提前在官网注册好。\n在选择组件界面可以选择Qt的版本，以5.15.2为例，我们只需要其中的MSVC 2019部分，其余可根据需要自行选择：\n图 1 Qt 的安装\n安装完成后，找到安装目录下的动态链接库目录，如D:\\Qt\\5.15.2\\msvc2019_64\\bin，将其添加至环境变量中的PATH。\nGeant4¶\n从Github下载Geant4的源代码文件，解压至D:\\Geant4\\source目录下。\n编译安装 ¶\n无 Qt¶\n无Qt版本的编译安装较为简单，进入D:\\Geant4目录，创建build文件夹并进入：\n&gt; cd D:\\Geant4&gt; mkdir build&gt; dir /Bbuildsource&gt; cd build\n随后运行CMaKe：\ncmake -DCMAKE_INSTALL_PREFIX=\"D:\\Geant4\\disk\" \"D:\\Geant4\\source\"\n其中CMAKE_INSTALL_PREFIX用于设置安装路径，即安装Geant4库、头文件和支持文件的目录，必须为绝对路径。后者为源代码的目录，可以为相对路径。Geant4还有很多的可选编译选项，可以查阅 Geant4 Build Options。\n&gt; cmake -DCMAKE_INSTALL_PREFIX=\"D:\\Geant4\\disk\" \"D:\\Geant4\\source\"-- Building for: Visual Studio 17 2022-- Selecting Windows SDK version 10.0.19041.0 to target Windows 10.0.19043.-- The C compiler identification is MSVC 19.31.31104.0-- The CXX compiler identification is MSVC 19.31.31104.0......-- The following Geant4 features are enabled:CMAKE_CXX_STANDARD: Compiling against C++ Standard '17'GEANT4_BUILD_MULTITHREADED: Build multithread enabled libraries-- Configuring done-- Generating done-- Build files have been written to: D:/Geant4/build\n一般情况下你会看到警告，这只是一个建议项，提醒我们安装进行模拟所必须的数据文件，不影响后续的安装，可以等到安装完成后自行下载解压。\n*WARNING*  Geant4 has been pre-configured to look for datasets  in the directory:  D:\\Geant4\\disk\\share\\Geant4-11.0.1\\data  but the following datasets are NOT present on disk at  that location:\n经过上面的步骤，CMaKe会生成一个Visual Studio的解决方案，当然我们也可以通过命令行直接进行安装，注意我们选用了Release项，这是因为Geant4的Debug配置优化不是很好，不能带来最佳的性能。\n&gt; cmake --build . --config Release --target install\nQt¶\n带有Qt的编译安装较为繁琐，所以我们可以借助CMaKe-GUI进行配置。选择源代码目录D:\\Geant4\\source和构建目录D:\\Geant4\\source后，我们添加一个配置项为CMAKE_PREFIX_PATH，类型为PATH，值为Qt动态链接库的上一级目录（如D:\\Qt\\5.15.2\\msvc2019_64），随后点击左下角的Configure按钮。\n图 2 CMAKE_PREFIX_PATH 配置项\n图 3 CMaKe 的 Qt 配置\n随后，我们在自动添加的配置项中，将CMAKE_INSTALL_PREFIX（安装目录）设置为D:\\Geant4\\disk，将GEANT4_BUILD_MULTITHREADED（多线程编译）勾选，将GEANT4_USE_OPENGL_WIN32和GEANT4_USE_QT勾选启用Qt，再次点击左下角的Configure按钮，CMaKe会自动帮助进行Qt的进一步配置，确认无误后再次点击左下角的Configure按钮，当所有的配置项均变为白色时，则配置完成，点击Configure右侧的Generate进行生成。\n图 4 CMaKe 的 Qt 配置 2\n图 5 CMaKe 的 Qt 配置 3\n点击Generate右侧的Open Project在Visual Studio中打开项目，在解决方案资源管理器中，选中ALL_BUILD到INSTALL中间的所有项目，打开属性（上端的扳手按钮），启用多处理器编译选项。\n图 6 CMaKe 的 Qt 构建 1\n图 7 CMaKe 的 Qt 构建 2\n然后在ALL_BUILD项目上点击右键，再点击生成 (Build)，等待结束后在INSTALL项目上点击右键，再点击生成 (Build)，即可完成编译安装。\n安装后配置 ¶\n在环境变量中添加D:\\Geant4\\dist\\bin。\n在Download 页面下载好数据文件，目前总计 12 个，约 2G 大小，将其解压至D:\\Geant4\\dist\\share\\Geant4-11.0.1\\data目录下（data文件夹可能需要自己创建），解压后目录结构如下：\nD:\\GEANT4\\DIST\\SHARE\\GEANT4-11.0.1\\DATA|---G4ABLA3.1│   |---*.dat│   `---sub directory|---G4EMLOW8.0|---G4ENSDFSTATE2.3|---G4INCL1.0|---G4NDL4.6|---G4PARTICLEXS4.0|---G4PII1.3|---G4SAIDDATA2.0|---G4TENDL1.4|---PhotonEvaporation5.7|---RadioactiveDecay5.6`---RealSurface2.2\n随后运行D:\\Geant4\\dist\\bin目录下的geant4.csh文件，复制设置环境变量的一段，并进行修改，将结果保存至reg.bat文件中并运行。\nsetx G4NEUTRONHPDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4NDL4.6setx G4LEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4EMLOW8.0setx G4LEVELGAMMADATA D:/Geant4/dist/share/Geant4-11.0.1/data/PhotonEvaporation5.7setx G4RADIOACTIVEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/RadioactiveDecay5.6setx G4PARTICLEXSDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4PARTICLEXS4.0setx G4PIIDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4PII1.3setx G4REALSURFACEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/RealSurface2.2setx G4SAIDXSDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4SAIDDATA2.0setx G4ABLADATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4ABLA3.1setx G4INCLDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4INCL1.0setx G4ENSDFSTATEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4ENSDFSTATE2.3\n示例 ¶\nexample B1¶\nB1 是用于计算吸收剂量的。几何模型可见图 8，半透明的蓝色长方体中填充了水（G4_WATER），外界为空气。在长方体内部有两个物体，第一个圆台状物体的材料为人体组织（G4_A-150_TISSUE），第二个梯形状物体的材料为骨（G4_BONE_COMPACT_ICRU）。\n粒子从圆台状物体的前方入射，分布范围是长方体前侧面积的 80%，从图 9 可以看出，有些粒子在长方体内与水发生反应，直接散射出去；有些粒子直接射在骨中；有些粒子经过组织后入射到骨中。通过计算粒子在骨中沉积的能量，再除以骨的质量，我们可以得到整个骨的平均吸收剂量。\n图 8 B1 的几何体\n图 9 B1 粒子入射模拟\n试运行 ¶\n在D:\\Geant4\\dist\\share\\Geant4-11.0.1\\examples目录下有很多Geant4的示例代码，我们将basic/B1示例复制到~/exampleB1目录下，改名为source，并创建同级目录build：\n&gt; mkdir -p ~/exampleB1/source&gt; Copy-Item D:\\Geant4\\dist\\share\\Geant4-11.0.1\\examples\\B1 -Recurse ~/exampleB1/source&gt; mkdir -p ~/exampleB1/build\n进入build目录进行构建，Geant4_DIR是Geant4库文件的安装目录，CMAKE_INSTALL_PREFIX是最终文件的目录：\n&gt; cd build&gt; cmake -DGeant4_DIR=\"D:\\Geant4\\dist\\lib\\Geant4-11.0.1\" -DCMAKE_INSTALL_PREFIX=\"~/exampleB1/disk\" \"~/exampleB1/source\"\n构建后会在build目录下生成一个.sln文件，可以使用Visual Studio打开并编译，也可以使用命令行如下：\n&gt; cmake --build . --config Release --target install\n编译后会在~/exampleB1/disk/bin目录下生成一个.exe文件，运行该文件还需要.mac文件，因此我们复制build目录下的所有.mac文件到~/exampleB1/disk/bin目录下，进入~/exampleB1/disk/bin目录，运行.exe文件。\n&gt; cp *.mac ~\\exampleB1\\disk\\bin\\&gt; cd ~/exampleB1/disk/bin&gt; .\\exampleB1.exe\n图 10 exampleB1\n分析 ¶\n.|-- include|   |-- *.hh|-- src|   `-- *.cc|-- CMakeLists.txt|-- GNUmakefile|-- exampleB1.cc`-- *.mac\n目录下主要有include和src两个目录，存放的是自定义的头文件及其源文件；CMakeLists.txt，GNUmakefile是用于编译的配置文件，我们只需要用到CMakeLists.txt；exampleB1.cc是程序的主文件，程序入口也在该文件中；*.mac可以存储需要运行的命令，作为脚本运行。\nGeant4中主要有 4 个概念，分别为Run，Event，Step，Track：\n\nRun：一次模拟过程，注意一个程序中可以进行多次模拟\nEvent：一次入射事件，每次入射事件可能入射多个粒子，注意包含次级粒子的反应过程\nStep：某个粒子一次模拟的过程，是模拟的最小单位，包含有起始位置、花费时间、能量增量等粒子信息\nTrack：粒子的信息，包含有该粒子的Step的信息\n\n图 11 Geant4 概念的联系\n在Geant4中，有一些类需要有用户自行定义，其中某些类是必须的（强制类）。在主程序中，我们需要自己编写main函数，并至少创建运行管理类，将强制类设置到运行管理类中。下面我们按照模拟的流程介绍B1示例，其中G4VUserDetectorConstruction、G4VUserPhysicsList和G4VUserPrimaryGeneratorAction（或其派生类）是Geant4的 3 个强制类。\n几何体类 ¶\n我们需要从G4VUserDetectorConstruction类派生出具体类，并且在虚函数Construct中定义几何体的几何框架、材料，并进行放置。在DetectorConstruction.hh文件中，我们定义了DetectorConstruction类，其中Construct将会实现具体的构造，而fScoringVolume用于计算剂量，指定为梯形状物体（即shape2）。\nDetectorConstruction.hhclass DetectorConstruction : public G4VUserDetectorConstruction {public:    DetectorConstruction();            // 构造    ~DetectorConstruction() override;  // 构析    G4VPhysicalVolume* Construct() override;  // 函数，描述探测器，返回物理体    G4LogicalVolume* GetScoringVolume() const { return fScoringVolume; }  // 自定义计数函数 返回指针fScoringVolumeprotected:    G4LogicalVolume* fScoringVolume = nullptr;  // 用于计数};\nGeant4 中一个几何体需要设置几何框架（solid）、材料（logic）、放置（physical）等操作，其中最大的几何体被称为World volume，它应该所有其他的几何体。\n定义几何框架首先需要指定形状，例如长方体、圆柱、空心圆柱、圆锥等等（可参见 Solids）。在本例中使用的是长方体，需要注意的是尺寸都是半数：\nDetectorConstruction.ccG4Box* solidWorld = new G4Box(\"World\", x_length, y_length, z_length);\n随后我们需要查找材料，部分材料在前文已经提到过，例如水（G4_WATER）、组织（G4_A-150_TISSUE）、骨（G4_BONE_COMPACT_ICRU）和空气（G4_AIR）等等（可参见 Material）。材料的管理是通过G4NistManager类实现的：\nDetectorConstruction.ccG4NistManager* nist = G4NistManager::Instance();G4Material* world_mat = nist-&gt;FindOrBuildMaterial(\"G4_AIR\");\n然后将几何框架与材料结合，构建Logical Volumes，只负责记录物体的几何特性，并增加了物理特性，包括材料、探针、磁场等，而不记录物体的位置信息：\nDetectorConstruction.ccG4LogicalVolume* logicWorld = new G4LogicalVolume(solidWorld, world_mat, \"World\");\n最后需要将几何体放置到环境中，使用G4PVPlacement进行，返回值是一个Logical Volumes的实例，被称为Physical Volume。由于Construct函数需要返回最大环境的物理体，因此我们通过physWorld变量进行这一操作：\nDetectorConstruction.ccG4VPhysicalVolume* physWorld = new G4PVPlacement(0,                // 旋转                                                G4ThreeVector(),  // 中心位置，World必须在 (0,0,0)                                                logicWorld,       // 材料                                                \"World\",          // 名称                                                0,                // 母体环境（Mother Volume）                                                false,            // no boolean operation                                                0,                // copy number                                                true);            // overlaps checking\n仿照上面的过程，我们可以定义水箱Envelope、圆台状物体Shape1和梯形状物体Shape2，并且将它们放置在Mother Logical Volumes中，而且Logical Volumes中可以包含多个物体：\nDetectorConstruction.ccG4Material* env_mat = nist-&gt;FindOrBuildMaterial(\"G4_WATER\");G4Box* solidEnv = new G4Box(\"Envelope\", x_length, y_length, z_length);G4LogicalVolume* logicEnv = new G4LogicalVolume(solidEnv,     // 几何框架                                                env_mat,      // 材料                                                \"Envelope\");  // 名称new G4PVPlacement(0, G4ThreeVector(), logicEnv, \"Envelope\", logicWorld,   // Mother Logical Volumes，即 World                  false, 0, true);...shape1...new G4PVPlacement(0, pos1, logicShape1, \"Shape1\", logicEnv, false, 0, true);...shape2...new G4PVPlacement(0, pos2, logicShape2, \"Shape2\", logicEnv, false, 0, true);\n物理类 ¶\nG4VUserPhysicsList 或其派生类用于定义模拟中使用的所有粒子、物理过程和截止范围，而物理过程用于描述粒子与材料的相互作用过程。PhysicsList是需要由用户指定或定义的类，一般情况下我们都会使用Geant4提供的物理过程，例如本例中的QBBC一般用于医学剂量评估和空间辐射物理的模拟，适用于需要精确模拟质子和中子的低能量传输的场景，对于薄靶实验，当粒子能量低于 1 GeV 时，有很好的效果。\nexampleB1.ccG4VModularPhysicsList* physicsList = new QBBC;\n主事件生成类 ¶\n产生初级粒子的Event被称为Primary Events，我们可以理解为粒子源，由G4VUserPrimaryGeneratorAction或其派生类进行定义，而实际粒子的产生则有G4VPrimaryGenerator或其派生类负责。G4VuserPrimaryGeneratorAction有一个函数为GeneratePrimaries，在每个Event开始时都会调用此方法。\nPrimaryGeneratorAction.hhclass PrimaryGeneratorAction : public G4VUserPrimaryGeneratorAction {public:    PrimaryGeneratorAction();    ~PrimaryGeneratorAction() override;    void GeneratePrimaries(G4Event*) override;    const G4ParticleGun* GetParticleGun() const { return fParticleGun; }private:    G4ParticleGun* fParticleGun = nullptr;    G4Box* fEnvelopeBox = nullptr;};\n在GeneratePrimaries我们需要使用G4VPrimaryGenerator或其派生类生成实际的粒子。Geant4为我们提供了 3 个具体的类为：G4ParticleGun，G4GeneralParticleSource（被称为GPS）和G4HEPEvtInterface，在B1中使用的是G4ParticleGun。\nG4ParticleGun可以生成具有给定动量和位置的初级粒子，不提供任何类型的随机化过程，但是在实际应用中我们经常需要一定的位置、能量的随机化，在B1例子中就需要在长方体前向面的 80% 范围内随机粒子的位置。我们可以在GeneratePrimaries函数中，调用自己编写的随机函数，生成随机的位置赋予给G4ParticleGun，然后再生成粒子。与G4ParticleGun相比，G4GeneralParticleSourceGPS可以定义初级粒子的能谱、空间和角分布等信息，可以更加灵活地实现随机源的生成。\nPrimaryGeneratorAction.ccvoid PrimaryGeneratorAction::GeneratePrimaries(G4Event* anEvent) {    // 几何参数用于调整源的空间分布    G4double envSizeXY = xy;    G4double envSizeZ = z;    G4double size = 0.8;    G4double x0 = size * envSizeXY * (G4UniformRand() - 0.5);    G4double y0 = size * envSizeXY * (G4UniformRand() - 0.5);    G4double z0 = -0.5 * envSizeZ;    // 设置此次的位置并发射    fParticleGun-&gt;SetParticlePosition(G4ThreeVector(x0, y0, z0));      fParticleGun-&gt;GeneratePrimaryVertex(anEvent);}\n当然，在Event之前我们需要初始化，创建G4ParticleGun实例，并在Event结束后销毁。\nPrimaryGeneratorAction.ccPrimaryGeneratorAction::PrimaryGeneratorAction() {    // 初始化粒子枪，每个 event 有 n_particle 个粒子    G4int n_particle = 1;    fParticleGun = new G4ParticleGun(n_particle);    // 粒子列表的查找器    G4ParticleTable* particleTable = G4ParticleTable::GetParticleTable();    // 设置为 6 MeV 沿 z 轴正方向的 gamma 源    G4ParticleDefinition* particle = particleTable-&gt;FindParticle(\"gamma\");    fParticleGun-&gt;SetParticleDefinition(particle);    fParticleGun-&gt;SetParticleMomentumDirection(G4ThreeVector(0., 0., 1.));    fParticleGun-&gt;SetParticleEnergy(6. * MeV);}PrimaryGeneratorAction::~PrimaryGeneratorAction() { delete fParticleGun; }\n用户行为类 ¶\n对于模拟中Run，Event，Step，Track等各个阶段，我们都可以自定义相应的行为，来实现我们需要的效果，例如统计某个物体内的沉积能量，剂量随深度的变化曲线等等。\n在B1中我们需要获取几何体Shape2的吸收剂量，所以我们需要获得粒子在其中损失的能量，这一部分信息被记录在Step中，因此可以根据以下的逻辑实现吸收剂量的统计：判断当前Step是否在Shape2中，如果在，则将沉积能量累加给当前Event的一个统计变量eDep，在当前Event结束时，再将eDep统计给当前Run，在当前Run结束时，通过计算总沉积能量与Shape2的质量比值来得到吸收剂量。\n图 12 B1 统计吸收剂量的流程\n相应的，我们需要在Run，Event，Step这 3 个阶段，定义行为来实现统计与返回：\nSteppingAction.hhclass EventAction;class SteppingAction : public G4UserSteppingAction {public:    SteppingAction(EventAction* eventAction);    ~SteppingAction() override;    // 每个 step 调用一次    void UserSteppingAction(const G4Step*) override;private:    EventAction* fEventAction = nullptr;    G4LogicalVolume* fScoringVolume = nullptr;};// SteppingAction.cc// 初始化 fEventAction，即获取到当前 Step 所在的 EventSteppingAction::SteppingAction(EventAction* eventAction) : fEventAction(eventAction) {}  // 每个 step 调用一次void SteppingAction::UserSteppingAction(const G4Step* step) {    // 这段代码的目的是获得 Shape2 所代表的 Logical Volume    if (!fScoringVolume) {        const DetectorConstruction* detConstruction =            static_cast&lt;const DetectorConstruction*&gt;(G4RunManager::GetRunManager()-&gt;GetUserDetectorConstruction());        fScoringVolume = detConstruction-&gt;GetScoringVolume();    }    // 获取当前的 Volume    G4LogicalVolume* volume = step-&gt;GetPreStepPoint()-&gt;GetTouchableHandle()-&gt;GetVolume()-&gt;GetLogicalVolume();    // 检查是否在计算的 Volume （Shape 2）    if (volume != fScoringVolume) return;    // 获取当前 step 的沉积能量    G4double edepStep = step-&gt;GetTotalEnergyDeposit();    fEventAction-&gt;AddEdep(edepStep);}\nEventAction.hhclass RunAction;class EventAction : public G4UserEventAction {public:    EventAction(RunAction* runAction);    ~EventAction() override;    void BeginOfEventAction(const G4Event* event) override;    void EndOfEventAction(const G4Event* event) override;    // 对每个 step 累加，最后一个 step 输出一个 event 的能量沉积    void AddEdep(G4double edep) { fEdep += edep; }private:    RunAction* fRunAction = nullptr;    G4double fEdep = 0.;};// EventAction.cc// 初始化 fEventAction，即获取到当前 Event 所在的 RunEventAction::EventAction(RunAction* runAction) : fRunAction(runAction) {}void EventAction::BeginOfEventAction(const G4Event*) { fEdep = 0.; }void EventAction::EndOfEventAction(const G4Event*) {    // 将 event 中的沉积能量返回给 run    fRunAction-&gt;AddEdep(fEdep);}\nRunAction.hhclass RunAction : public G4UserRunAction {public:    RunAction();    ~RunAction() override;    void BeginOfRunAction(const G4Run*) override;  // Run 开始时执行    void EndOfRunAction(const G4Run*) override;    // Run 结束时执行    void AddEdep(G4double edep);  // 计算累计沉积的能量private:    G4Accumulable&lt;G4double&gt; fEdep = 0.;    G4Accumulable&lt;G4double&gt; fEdep2 = 0.;};// RunAction.ccvoid RunAction::EndOfRunAction(const G4Run* run) {    // event 的数目    G4int nofEvents = run-&gt;GetNumberOfEvent();    if (nofEvents == 0) return;    // 合并累加的值    G4AccumulableManager* accumulableManager = G4AccumulableManager::Instance();    accumulableManager-&gt;Merge();    // 计算总沉积能量    G4double edep = fEdep.GetValue();    // 剂量 =  / 质量    const DetectorConstruction* detConstruction =        static_cast&lt;const DetectorConstruction*&gt;(G4RunManager::GetRunManager()-&gt;GetUserDetectorConstruction());    G4double mass = detConstruction-&gt;GetScoringVolume()-&gt;GetMass();    G4double dose = edep / mass;}\n图 13 统计过程中的调用关系（点击放大）\n初始化与管理类 ¶\n实现了各种强制类和用户行为的定义后，我们需要回到main函数，将这些类添加到运行中，其中首先要做的就是创建G4RunManager类的一个实例，它负责管理整个模拟进程的运行与循环，有多线程下的G4MTRunManager类和其他情况下的G4RunManager类两种，通过G4RunManagerFactory可以自动识别是否创建多线程类。\nexampleB1.ccauto* runManager = G4RunManagerFactory::CreateRunManager(G4RunManagerType::Default);\nG4RunManager 还负责进行初始化，即前文所说的强制类与用户行为。为了方便进行初始化，我们从G4VUserActionInitialization派生出ActionInitialization用于统筹所有的用户自定义行为和粒子生成：\nActionInitialization.hhclass ActionInitialization : public G4VUserActionInitialization {public:    ActionInitialization();    ~ActionInitialization() override;    void BuildForMaster() const override;  // 多线程的用户行为初始化    void Build() const override;           // 单线程的用户行为初始化};void ActionInitialization::BuildForMaster() const {    RunAction* runAction = new RunAction;    SetUserAction(runAction);}// ActionInitialization.ccvoid ActionInitialization::Build() const {    SetUserAction(new PrimaryGeneratorAction);    RunAction* runAction = new RunAction;    SetUserAction(runAction);    EventAction* eventAction = new EventAction(runAction);    SetUserAction(eventAction);    SetUserAction(new SteppingAction(eventAction));}\n随后我们在G4RunManager中设置用户初始化为ActionInitialization，同时加入其他的强制类：\nexampleB1.ccrunManager-&gt;SetUserInitialization(new DetectorConstruction());runManager-&gt;SetUserInitialization(new QBBC);runManager-&gt;SetUserInitialization(new ActionInitialization());\n运行模式 ¶\nGeant4 的运行可以分为 4 种模式：写在代码中的纯硬编码批处理模式、读取文件（macro of commands）的批处理模式、基于命令行的交互模式、基于图形界面的交互模式。一般情况下我们会使用图形界面的交互模式进行Debug与展示，通过读取文件的批处理模式进行实际模拟，因此我们也可以在代码中实现两种模式的切换。\n在main函数的参数中，会有argc提供命令参数的个数，字符串数组argv提供具体的命令参数，而默认的第一个参数是可执行文件本身，因此我们可以根据参数的个数，进行模式的判断：\nexampleB1.ccint main(int argc, char** argv) {    // argc 为 1 时，说明参数只有可执行文件本身，运行在GUI模式下    // 如果 argc 不为 1，则运行在 batch mode，例如 example.exe run1.mac    G4UIExecutive* ui = nullptr;    if (argc == 1) {        ui = new G4UIExecutive(argc, argv);    }    ...    // 根据模式，选择开始进行模拟，或打开GUI    if (!ui) {        // batch mode via reading a macro of commands        G4String command = \"/control/execute \";        G4String fileName = argv[1];        UImanager-&gt;ApplyCommand(command + fileName);    } else {        // interactive mode via a Graphical User Interface        UImanager-&gt;ApplyCommand(\"/control/execute init_vis.mac\");        ui-&gt;SessionStart();        delete ui;    }}\n常用命令 ¶\n在读取文件的批处理模式下，我们将需要用到的命令保存在.mac文件中，我们可以通过命令更改初始条件，指定发射粒子的类别、位置、能量等信息，改变几何、角度等。其中最常用的两条命令为：\n/run/initialize     // 初始化/run/beamOn 1000    // 运行一次模拟，包含1000个粒子\n此外，比较常用的命令还有：\n\n粒子枪\n\n/gun/particle proton   // 设定为光子/gun/energy 210 MeV    // 能量为 210 MeV...\n\n输出控制\n许多类都有一个verbose表示，用于控制输出的详细程度，当verbose=0时，不会有任何输出，后面的数字越大输出越详细，最大为 4。\n\n/run/verbose 2/event/verbose 1/tracking/verbose 0...\n\n网格划分\n推荐观看在 Geant4 中关于 Command-based Scoring 基于命令计数器的用法\n\n/score/create/boxMesh water_box          // 定义一个网格/score/mesh/boxSize 319. 315. 277.5 mm   // 设置尺寸/score/mesh/nBin 1 1 555                 // 分bin的数目/score/quantity/energyDeposit eDep       // 想要获取的物理信息：剂量/score/quantity/doseDeposit Dose         // 想要获取的物理信息：沉积能量/score/dumpQuantityToFile water_box eDep eDep_1.txt   // 导出获取的物理信息：剂量/score/dumpQuantityToFile water_box Dose Dose_1.txt   // 导出获取的物理信息：沉积能量\n更多的命令或者命令的说明，可以在 GUI 模式下的左侧帮助手册中查询，也可以查看推荐阅读材料中的Geant4 Commands进行在线查询。\n水箱模型 ¶\n放疗水箱常用于放疗装置的剂量校准，其尺寸为（x = 638mm，y = 630mm，z = 555mm）。现假设一笔形束从 x-y 平面中心处，自水箱外向下射入放疗水箱。请用Geant4模拟计算不同能量的光子（1MeV、5MeV、10MeV）入射后在放疗水箱的 z 方向上的吸收剂量变化曲线。\n这是一个非常简单的示例，首先定义几何体：\nG4NistManager* nist = G4NistManager::Instance();G4Box* solid_world = new G4Box(\"world\", 638 / 2 * mm, 630 / 2 * mm, 555. / 2 * mm);G4LogicalVolume* logic_world = new G4LogicalVolume(solid_world, nist-&gt;FindOrBuildMaterial(\"G4_WATER\"), \"world\");G4VPhysicalVolume* physics_world = new G4PVPlacement(0, G4ThreeVector(), logic_world, \"world\", 0, false, 0, true);\n随后在.mac中进行网格划分与模拟：\n/score/create/boxMesh water_box/score/mesh/boxSize 319. 315. 277.5 mm/score/mesh/nBin 1 1 555/score/quantity/energyDeposit eDep/score/quantity/doseDeposit Dose/score/close/gun/particle gamma/gun/energy 1 MeV/run/beamOn 100000/score/dumpQuantityToFile water_box eDep eDep_1.txt/score/dumpQuantityToFile water_box Dose Dose_1.txt/gun/energy 5 MeV/run/beamOn 100000/score/dumpQuantityToFile water_box eDep eDep_5.txt/score/dumpQuantityToFile water_box Dose Dose_5.txt/gun/particle gamma/gun/energy 10 MeV/run/beamOn 100000/score/dumpQuantityToFile water_box eDep eDep_10.txt/score/dumpQuantityToFile water_box Dose Dose_10.txt\n其余部分参考B1示例。\n附录 ¶\n示例源码 ¶\n\nexampleB1 带注释代码\n水箱模型\n\nCMakeLists¶\n很多人在尝试编译示例时，会有以下错误：\nCMake Error at CMakeLists.txt:16 (find_package):By not providing \"FindGeant4.cmake\" in CMAKE_MODULE_PATH this project hasasked CMake to find a package configuration file provided by \"Geant4\", butCMake did not find one.Could not find a package configuration file provided by \"Geant4\" with anyof the following names:Geant4Config.cmakegeant4-config.cmakeAdd the installation prefix of \"Geant4\" to CMAKE_PREFIX_PATH or set\"Geant4_DIR\" to a directory containing one of the above files.  If \"Geant4\"provides a separate development package or SDK, be sure it has beeninstalled.\n可以在CMakeLists.txt文件中添加一行即可解决：\ncmake_minimum_required(VERSION 3.16)set(Geant4_DIR D:/Geant4/dist/lib/Geant4-11.0.1)project(exampleB0)...\n参考资料 ¶\n\nInstallation Guide\nGeant4 入门教程\nGeant4 学习 —— 入门 (基本概念、Geant4 工具包的结构、强制类、可选类)\nGeant4–是怎样使用的？–（1. 信息抽取）\nGeant4 入门讲解篇 - 1\n\n推荐阅读 ¶\n\nBook For Application Developers\nPhysics Reference Manual\nGuide for Physics Lists\nGeant4 Commands\nliuchangqi\n在 Geant4 中关于 Command-based Scoring 基于命令计数器的用法\n\n","categories":["核物理","Geant4"],"tags":["教程","核技术","Geant4"]},{"title":"SiPM 在空间科学与天文中的应用","url":"/posts/202201-sipm-space.html","content":"SiPM 介绍 ¶\nSiPM（硅光电倍增管）是一类新型光电转化器件，由工作在 G - M 反向偏置状态的若干雪崩二极管阵列组成，具有结构紧凑、高增益、高灵敏、低电压等特点，因此广泛地应用于小型辐射探测器、微光探测、核医学、天体物理等诸多领域。\n\nSiPM 的基本组成单元是自猝灭的单光子雪崩光电二极管（SAPD），这样的一个单元称为像素，每个 SAPD 都工作在高于击穿电压的状态，另外串联接入猝息电阻。一个 SiPM 通常由数千个 SAPD 并联组成。\n图 1 标准 SiPM 的结构示意图\nSiPM 的结构，使得其能够同时探测多个光子，其输出信号的幅度与像素接受到的光子数目在一定范围内呈线性关系。但是在没有光的条件下，由于热运动或其他因素的扰动，会产生随机的电子 - 空穴对，当载流子出现在灵敏体积内（高电场区域）时，将会触发雪崩，进而输出一个信号，这种计数被称为暗计数，暗计数的存在限制了 SiPM 的能量分辨率。\nSiPM 的应用 ¶\n空间科学采用 SiPM 的主要考量因素是其体积小、偏压低的特点，能够显著地减小探测器的体积，简化电源设计，降低设计难度与制作成本。而其高灵敏度的特性能被应用于天文领域微弱光信号对的探测。下面将介绍 SiPM 在空间科学与天文研究中的部分应用。\n碘化锶辐射仪（SIRI-1）¶\n碘化锶辐射仪（Strontium Iodide Radiation Instrumentation，简称为 SIRI-1）是由美国海军研究实验室开发的用于空间伽马射线测量的立方星，采用的技术方案是掺有铕的碘化锶闪烁体 + 硅光电倍增管，能够测量 40-4000 keV 范围的伽马光子。\nSIRI 是第一批使用 SiPM 的空间项目，相比于传统的同类空间科学项目，具有成本低、体积小、效率高的特点，这主要是得益于 SiPM 的特性。SIRI 的主要目的是为了验证碘化锶闪烁体 + SiPM 技术应用于空间科学的可行性，并通过为期一年左右的在轨监控，研究 SiPM 在空间辐射环境下的性能。[1]\nSIRI 采用的碘化锶闪烁体会发生潮解，因此在实际使用过程中用铝制作了密闭封装，在晶体的前表面是石英材质的光学窗，铝层内部贴有特氟龙胶带，能够漫反射闪烁光子，提高闪烁光子的收集效率。\n图 2 SIRI-1 的结构示意图\n在碘化锶闪烁体后是一个 2×2 的 SiPM 阵列，通过电源模块加有 28.5V 的偏压，地面试验数据显示对 662 keV 的伽马光子能够实现 4.2% 的能量分辨率（如图 3 所示），略差于同等条件下 PMT 的 3.2%，这主要是由于暗计数的噪声和光耦合的因素导致的。\n图 3 SIRI-1 地面测量的 Cs-137 能谱\n天格计划 ¶\n空间伽马暴是天空中某一方向的伽马射线强度在短时间内突然增强，随后又迅速减弱的现象，呈现各向同性分布。对于伽马射线的探测最早开展于上世纪 60 年代的美国军方 Vela 卫星，随后陆续通过数颗卫星进行了伽马暴的研究。[2]\n天格计划是一个小型化的伽马暴探测方案，使用 SiPM 替换了传统探测方案中的 PMT，实现了对于载荷的小型化，发射成本低，因此可以做到多星组网，实现对伽马暴的全天观测与多星定位。[3]\n天格计划的探测器有上总计有 4 个探测单元，每个单元由掺有铈的 GAGG 晶体（GAGG:Ce）和 4×4 的 SiPM 阵列组成，两者之间有光耦合层。为了简化电路设计，减小后端电子学部分的大小，每个通道的 SiPM 阵列并联接入了电流灵敏前置放大器、整形与峰位保持电路，而这会导致 SiPM 的暗噪声叠加，电容增大，进而获得较差的能量分辨率。\n图 4 天格探测器的模型\n另外天格采用的 GAGG 晶体的光产额一般不低于 24000/MeV，而 SIRI 使用的碘化锶晶体可以达到 80000/MeV，因此相较而言 SIRI 可以做到更高的能量分辨率。同样对于 Cs-137 的 662 keV，只能达到 20% 的分辨率（如图 5 所示）。\n图 5 天格探测器地面测量的 Cs-137 能谱\n为了改善能量分辨率，可以从多个方面入手：\n\n前端电子部分：主要分为前置放大器、低通滤波器和峰位保持器三个部分。通过改变反馈电阻的大小，可以操纵信噪比，进而达到较好的能量分辨率\n更改晶体与 SiPM 之间的光耦合层\n增加对于 SiPM 的温度修正\n\n通过上述的方案，可以将探测器的能量分辨率提高到 9%@662keV。\n切伦科夫望远镜阵列 ¶\n切伦科夫光（或切伦科夫辐射）介质中运动的物体速度超过光在该介质中速度时发出的电磁辐射。在核电站启动时观察到液体中的蓝色辉光就是切伦科夫光，而江门中微子实验的原理也是通过 PMT 捕捉中微子与物质反应的产物在液闪中产生的切伦科夫光。\n来自宇宙的高能粒子，在进入大气层之后，其速度很有可能超过了高层大气介质中的光速，因此同样会放出切伦科夫光，这一特性可以被应用于高能光子的地面探测。\n地球大气层对以伽马暴为代表的伽马光子透明度并不高，因此传统方案主要是通过探空气球以及卫星进行高能光子的观测。而宇宙射线引发的大气粒子级联（广延大气簇射）放出的切伦科夫光在大气层内就可以进行观测，因此可以利用这一点进行高能光子的间接探测。[5]\n切伦科夫望远镜阵列（Cherenkov telescope array，简称 CAT）是目前新一代的成像大气切伦科夫望远镜，涵盖有四种不同尺寸的望远镜，能够实现高灵敏度和宽能量范围。由于 SiPM 的光电转换效率高，能够捕捉到大气中少量的切伦科夫光子，同时光污染、明亮天体等导致夜空辉光的强度远大于 SiPM 的暗噪声，因此 SiPM 是实现大气切伦科夫光探测的理想器件。但是受限于 SiPM 的尺寸和大的并联等效电容，目前只在尺寸较小的两类望远镜上（主要为 SST）使用了这一器件，较大的望远镜仍然使用 PMT 作为光电转换器件。[6]\n图 6 CAT 技术方案\nSST 的每个像素单元共有 36840 个 50 μm 大小的 SiPM，如果直接将所有的 SiPM 阵列并联接入后续的电路，其等效电容将会达到 nF 量级。因此 SST 将每个像素的 SiPM 阵列划分为 4 个单元各自接入后续电路，再通过低噪声跨导放大器和差分放大器进行信号的合并与放大，能够显著的提高望远镜的能量分辨率。[7]\nSiPM 的特性 ¶\n温度补偿 ¶\n由于 SiPM 的击穿电压对温度较为敏感（如图 7 所示），另外较高的温度还将增加由于热产生的电荷载流子而导致发生暗计数的可能性。因此控制温度或者修正温度变化的影响对于 SiPM 的使用十分重要，尤其是对于前文所述的空间探测器，空间环境中向阳面与背阳面的温差可以达到数百 K，尽管有隔热与保温的措施，但是温度变换仍旧很大。\n图 7 同一 SiPM 探测器在不同温度和偏压下对 Am-241 的探测峰值\n解决这一问题，主要有三种手段：\n\n增加恒温装置，稳定 SiPM 的工作状态；但是这一方案需要增加额外的器件，这对空间任务而言是不利的。\n测量击穿电压随温度的变化关系，根据实时温度，动态调整加载在 SiPM 上的偏压，实现增益的稳定；这一方案需要进行额外的实验获取 V - T 的关系（V=V0+(T−T0)kV=V_0+(T-T_0 )kV=V0​+(T−T0​)k），通过适当的电路设计，可以将温度变换系数降低到 10 mV/℃量级。CAT 即采用这一方案。[7]\n 测量不同温度 - 偏压条件下的增益，使用该关系式修正探测结果；这一方案不需要增加额外的部件，可以维持探测器的小型化，但是实验过程繁琐，内容多，而且温度 - 偏压响应的拟合精度难以保证，因此适用于低成本的小型空间任务。天格即采用这一方案。[8]\n\n辐射损伤 ¶\n空间任务除温度以外，不能忽略的一个问题即空间辐射。空间辐射的主要来源包括太阳辐射、宇宙辐射与近地辐射带（部分宇宙射线、宇宙射线与地球磁场和大气层作用产生的带电粒子被地磁场俘获，形成的辐射带）。空间辐射的特点是重带电粒子为主，高能带电粒子与高能光子较为常见，能够对在轨的航天器、航天员造成较大的伤害。[9, 10]\n对于半导体而言，辐射可以通过电离能量损失（IEL）和非电离能量损失（NIEL）两种途径造成伤害。前者主要是由于低能光子、电子造成，通常作用于表面，后者以高能辐射为主，可以对整体造成损失，推动晶体原子造成位移，进而破坏晶体结构。[11]\n图 8 位移损失的原理（左 a）与结果（右 b）\n以 MOSFET 为例，入射产生的电子 - 空穴对由于电场迅速分离，电子快速漂移，而空穴较慢。高能辐射造成 MOSFET 位移损伤，出现晶体缺陷，而漂移较慢的空穴容易被困在这些位置，形成带正电的孔洞（即复合中心），降低了载流子的数目，进而导致噪声增加，增益减小，探测器的能量分辨率变坏。[11]\n图 9 N 沟道 MOSFET 辐射损伤的前（左 a）后（右 b）对比图\n对于 SiPM，辐射损伤的影响主要体现在电流的增大，根据 SIRI-1 传回的在轨数据与 SIRI-2 的地面实验，SiPM 工作电流的变化速度可以达到 ΔI∼44 μA / month，在经过长时间的辐射损伤后，电流可以达到 mA 级别 [12]。解决这一问题，有以下几种方案：\n\n设计轨道，避开辐射较高的区域，或者在辐射较高的区域关闭探测器以达到保护的目的；但由于 Van Allen 带与实际发射因素的影响，这一点往往难以做到。\n设计屏蔽层，将容易对探测器造成伤害的辐射阻挡在外；这一方案会显著提高探测器的质量、体积与成本，同时可能对探测过程造成影响。\n通过长时间在轨的监测数据，获取辐射损伤的程度，对探测结果进行修正；目前 SIRI-1 和天格计划的卫星（GRID-02）都有记录探测器工作状态（如温度、电流等）的部件，可以进行后续的分析。\n\n总结 ¶\nSiPM 得益于其体积小、高灵敏度、低偏压的特点，在空间任务与天文观测中有广阔的应用空间，但是受限于其尺寸与暗计数的影响，难以通过较低成本达到高的能量分辨率。同时 SiPM 也需要考虑温度、辐射等诸多环境因素对工作稳定性的影响。但随着 SiPM 制作工艺的进步以及后续电路的发展，SiPM 将在更多领域具有应用的潜力。\n参考文献 ¶\n\nMITCHELL L J, PHLIPS B F, WOOLF R S, et al. Strontium Iodide Radiation Instrumentation (SIRI); proceedings of the UV, X-Ray, and Gamma-Ray Space Instrumentation for Astronomy XX, F, 2017 [C]. International Society for Optics and Photonics.\nKLEBESADEL R W, STRONG I B. Observations of cosmic gamma-ray bursts [J]. Astrophysics and Space Science, 1976, 42(1): 3-15.\nWEN J, LONG X, ZHENG X, et al. GRID: a student project to monitor the transient gamma-ray sky in the multi-messenger astronomy era [J]. Experimental Astronomy, 2019, 48(1): 77-95.\nWEN J-X, ZHENG X-T, YU J-D, et al. Compact CubeSat Gamma-ray detector for GRID mission [J]. Nuclear Science and Techniques, 2021, 32(9): 1-11.\n高启, 陈天禄, 刘茂元, et al. 甚高能 γ 射线天文观测的利器 —— 成像大气切伦科夫望远镜 [J]. 天文学进展, 2021, 39 (03): 350-76.\nAMBROSI G, CORTI D, IONICA M, et al. Large size sipm matrix for imaging atmospheric Cherenkov telescopes applications [J]. Nuclear Instruments and Methods in Physics Research Section A: Accelerators, Spectrometers, Detectors and Associated Equipment, 2016, 824: 125-7.\nSCHIOPPA E, HELLER M, PUJADAS I T, et al. An innovative SiPM-based camera for gamma-ray astronomy with the small size telescopes of the Cherenkov Telescope Array [J]. Journal of Instrumentation, 2016, 11(01): C01038.\nGAO H, YANG D, WEN J, et al. On-ground calibrations of the GRID-02 gamma-ray detector [J]. Experimental Astronomy, 2021: 1-14.\nBOURDARIE S, XAPSOS M. The near-earth space radiation environment [J]. IEEE transactions on nuclear science, 2008, 55(4): 1810-32.\n程彭超, 闵锐. 近地空间辐射环境与防护方法概述 [J]. 辐射防护通讯, 2017, 37 (01): 14-21.\nMAURER R H, FRAEMAN M E, MARTIN M N, et al. Harsh Environments: Space Radiation [J]. Johns Hopkins APL technical digest, 2008, 28(1): 17.\nMITCHELL L, PHLIPS B, JOHNSON W N, et al. Radiation damage assessment of SensL SiPMs [J]. Nuclear Instruments and Methods in Physics Research Section A: Accelerators, Spectrometers, Detectors and Associated Equipment, 2021, 988: 164798.\n\n","categories":["核物理","探测器"],"tags":["核技术","SiPM","伽马暴","空间科学","天文","闪烁体"]},{"title":"中国空间站模拟剂量评估","url":"/posts/202207-descss.html","content":"本文仅为某次课程大作业，有诸多不严谨、遗漏之处，全文仅供参考！\n\n2021 年发射中国空间站天和核心舱，标志着中国空间站全面建设正式开启。随后神舟十二号乘组和神舟十三号乘组先后在轨工作了 3 个月与 6 个月，并且在将来将会实现空间站的长期在轨驻留和轮换 (1)。在此背景下，空间站舱内外辐射环境，以及航天员在轨工作期间关键器官的辐射剂量与效应研究非常重要。\n\n由于空间任务的特殊性，难以实地进行实验以获取剂量数据，因此主要方式是通过探测器获取轨道上辐射环境情况，随后建立空间站模型与人体模型，在传统的载人任务中，常使用BRYNTRN、HZETRN等基于Boltzmann输运方程的程序进行模拟，而Geant4等基于Monte Carlo方法的模拟工具在近些年来也备受人们关注。\nSun(2) 等人在 2012 年建立了Visible Chinese Human Adult Female Astronaut（VCH-FA）体模，用于模拟女性航天员在神舟飞船类的剂量。石苗(3) 根据中国成年男性数字化人体模型，结合航天员的实际情况，建立了航天员关键器官的数学参数化模型，借助Mulassis一维多层辐射屏蔽仿真程序和Geant4模拟程序计算了在各类情况下的辐射粒子在航天员关键器官内的能量沉积、吸收剂量等参数。\n欧洲航空局（European Space Agency，ESA）的T. Ersmark等人曾进行了Dose Estimation by Simulation of the ISS Radiation Environment（DESIRE）项目用于模拟国际空间站（ISS）哥伦布舱，（Columbus module）的辐射粒子通量和剂量 (4-7)。\n该项目可以划分为 4 个部分：\n\n测试Geant4用于模拟空间任务的准确性，与NASA的HZETRN、俄罗斯的SHIELD等模拟程序以及实验数据进行比较 (4)。\n建立哥伦布舱的不同详细程度的模型，进行模拟比较 [5]。\n使用SPENVIS等工具，获取ISS轨道上外部辐射场的模型 [6]。\n结合人体模型和粒子能谱，使用Geant4工具计算辐射剂量 [7]。\n\n本文以T. Ersmark等人的工作作为参考，结合石苗文中提供的部分中国航天的信息，建立了空间站天和核心舱的大致模型，通过SPENVIS模拟了 2022 年 5 月空间站轨道上的辐射环境，并使用MIRD体模进行了模拟。本文将分为 5 个部分，第 1 部分为轨道和空间辐射环境情况，第 2 部分为Geant4模型的建立，第 3 部分为Geant4模拟流程，第 4 部分为结果分析，第 5 部分为总结。\n空间站轨道与空间辐射环境 ¶\n轨道参数 ¶\n航天器的轨道是进行空间任务模拟的必要条件。用于确定轨道的各类参数被称为轨道参数（轨道根数），一般情况下为了确定一个开普勒轨道（椭圆轨道）需要 6 个轨道参数，根据选取的测量装置不同，有若干种方式可以定义轨道参数。\n两行轨道参数（Two Line Elements，TLE）是一种常用的表示轨道的方法，最初由NASA和北美防空司令部为部分较大的地球轨道航天器生成并公布，如今众多航天机构也在采用这一格式。\nTLE格式的数据主体有两行，另外还可能添加表示航天器名称的第 0 行。随后两行提供了若干信息。中国载人航天工程在官方网站[1] 公布了中国空间站的TLE信息，查询得到 2022 年 5 月 11 日的轨道参数如图 1 所示，从中可以获得表 1 的信息。\n图 1 中国空间站 TLE 参数\n表 1 提取的轨道信息时间倾角 (deg) 升交点赤经 (deg) 偏心率近地点辐角 (deg) 平近点角 (deg) 真近点角 (deg)22.5.11 00:0041.469684.98020.001152308.145644.415944.4629\n为了便于后续的分析，我们需要进一步转化，得到常用的六轨道根数。平近点角 MMM 与偏近点角 $E 满足：\nM=E−e⋅sin⁡EM=E-e\\cdot\\sin{E}\nM=E−e⋅sinE\n真近点角 TTT 与偏近点角 EEE 满足：\ntan⁡T2=1+e1−etan⁡E2\\tan{\\frac{T}{2}}=\\sqrt{\\frac{1+e}{1-e}}\\tan{\\frac{E}{2}}\ntan2T​=1−e1+e​​tan2E​\n由此可以计算得到轨道的真近点角。除此之外也可借助轨道模型，由上述数据计算得到轨道近地点、远地点，过程较为复杂，本文不做描述。最终结果如表 2 所示。通过表 2 中参数，我们可以使用SPENVIS[2] 的Coordinate generators生成空间站的预计轨道，总计 30 天。\n表 2 处理后的轨道信息倾角 (deg) 升交点赤经 (deg) 偏心率近地点辐角 (deg) 近地点 (km) 远地点 (km) 真近点角 (deg)41.469684.98020.001152308.1456379.2393.844.4629\n空间辐射环境 ¶\n空间辐射环境主要包括地球辐射带（Van Allen radiation belt）、太阳粒子事件（Solar Particle Event，SPE）和银河宇宙射线（Galactic cosmic rays，GCR）。辐射的强度不是恒定的，受太阳活动影响很大，需要考虑太阳活动极小时或极大时等极端情况，但在本文中只考虑模拟阶段 30 天的情况。\n银河宇宙射线 ¶\n银河宇宙射线是从系外进入太阳系的高能带电粒子，其通量与太阳活动负相关，主要由质子、电子和完全电离的原子核组成，其中核成分约占 98%，分别为 H（≈87%）、He（≈12%）和少量较重的原子核（≈1%）(8)。\nGCR一般各向同性，通量约为 1-10 cm-2s-1，以高能粒子为主（可达到 1011 GeV），贡献绝大部分有效剂量，一般在太阳活动极小时最大，除此之外还取决太阳磁性 (8)。\nGCR中还包含有所谓异常成分（anomalous component），星际间的中性粒子进入太阳系后，太阳辐射使其失去电子，离子太阳风作用和碰撞加速，其穿透地磁场的能力比其他成分更大，又可分为部分电离（singly-ionized anomalous component）和完全电离（fully-ionized anomalous component）。\nGCR常使用的模型有ISO-15390模型、CRÈME[3] 模型 和Nymmik模型等。ISO-15390模型不包含异常成分，而异常成分是有效剂量的主要来源；Nymmik模型与ISO-15390模型基本相同，但是在能量低于 10 MeV / u 时，通量随着能量降低而增加；而CRÈME模型是美国海军研究实验室负责开发的，基于Nymmik模型，但额外考虑了GCR中的异常成分。\n借助CRÈME86模型，我们可以得到其在 M = 3 情况下的GCR通量，该情况表示在任意情况下，只有 10% 的概率实际通量会超过这一值。在SPENVIS中使用CRÈME86模型可以生成 1 号~ 28 号元素的通量，其中 H 和 He 的通量如图 2 所示。\n图 2 GCR 中 H 和 He 的通量\n太阳辐射 ¶\n太阳辐射的主要来源是日冕抛射和太阳耀斑，太阳辐射以质子为主（90~95%），通量可达 10 9 cm-2s-1；其次为 α 粒子（5~8%），另外还有少量电子和 Z &gt; 2 的离子(9)。太阳活动具有明显的周期性，主要的周期有 11 年、22 年等，当太阳活动较强时，质子的比例会上升 (9)。\n主要考虑太阳质子和 α 粒子事件，其模型主要有King模型、JPL模型、ESP模型和SAPPHIRE模型等。SAPPHIRE是一个较新的模型，参考了其他模型太阳活动周期的规定，由于SAPPHIRE模型能够提供任务期间累计太阳质子注量，因此我们使用这一模型生成任务期间总通量，实际情况只有 5% 的可能大于这一估计值，结果如图 3。\n图 3 太阳质子和 α 粒子通量\n可以发现整个任务期间的总通量不超过 10 3 cm-2，远远小于银河宇宙射线和地球辐射带的通量，因此在后续模拟中忽略这一因素的剂量。\n地球辐射带 ¶\n近地地球辐射带被称为Van Allen带，是部分宇宙射线、宇宙射线与地球磁场和大气层作用产生的带电粒子被地磁场俘获形成的辐射带，分为内外两个辐射带 (8)。\n内带的高度一般在 600 km 以上，但是在高纬度地区和南大西洋地区，由于地磁异常，内带高度会下降至约 300 km，因此只有经过这些区域时才会有明显的俘获带电粒子通量(8)（见图 4），为方便计算，将通量平均到整个轨道上。\n图 4 空间站轨道上辐射带质子（左）和电子（右）的分布 \n近地地球辐射带的常用模型是AE/AP系列模型，这是由NASA综合 20 多颗不同卫星的轨道探测数据得到的，目前最新版本是AE9/AP9模型。使用该模型计算轨道上平均通量，结果如图 5 所示。\n图 5 AE9 / AP9 得到的质子（左）和电子（右）微分通量\n辐射模型的拟合 ¶\n上述模型得到的结果是分立的，Geant4中可以使用General Particle Source（GPS）进行直方图的拟合，也可以自行编写函数，使用Particle Gun进行。考虑到本文所述部分模型较为复杂，同时便于获取发射粒子的能谱、位置、方向等信息，因此采用自行编写的方法。\n银河宇宙射线 ¶\n定义粒子刚度（particle rigidity）R=pcZeR=\\frac{pc}{Ze}R=Zepc​，其中 ppp 为粒子动量，ccc 为光速，ZeZeZe 为粒子电荷量，则有：(10)\nF(p,t)=CiβαiR(p)γi[R(p)R(p)+(0.37+3×10−4W(t)1.45)]b⋅W(t)+cAiZi1βF\\left(p,t\\right)=\\frac{C_i\\beta^{\\alpha_i}}{R\\left(p\\right)^{\\gamma_i}}\\left[\\frac{R\\left(p\\right)}{R\\left(p\\right)+\\left(0.37+3\\times{10}^{-4}W\\left(t\\right)^{1.45}\\right)}\\right]^{b\\cdot W\\left(t\\right)+c}\\frac{A_i}{Z_i}\\frac{1}{\\beta}\nF(p,t)=R(p)γi​Ci​βαi​​⎣⎢⎡​R(p)+(0.37+3×10−4W(t)1.45)R(p)​⎦⎥⎤​b⋅W(t)+cZi​Ai​​β1​\n其中 pc=2m0c2E+E2pc=\\sqrt{2m_0c^2E+E^2}pc=2m0​c2E+E2​，EEE 为粒子动能；W(t)W\\left(t\\right)W(t) 为表征太阳活动的量，本文由于时长（30 天）远小于太阳周期，因此可认为是常数；CiC_iCi​，γi\\gamma_iγi​，αi\\alpha_iαi​为与粒子有关的常数，AiA_iAi​，ZiZ_iZi​分别为质量数与电荷数，β=vc=pcm02c4+E2\\beta=\\frac{v}{c}=\\frac{pc}{\\sqrt{m_0^2c^4+E^2}}β=cv​=m02​c4+E2​pc​，则可简化为：\nF(pc)=C1βα−1pc(pcpc+C2)C3F\\left(pc\\right)=\\frac{C_1\\beta^{\\alpha-1}}{pc}\\left(\\frac{pc}{pc+C_2}\\right)^{C_3}\nF(pc)=pcC1​βα−1​(pc+C2​pc​)C3​\n同时考虑双指数模型：\nF(E)=C1e−C2E(1−e−C3E+C4)F\\left(E\\right)=C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)\nF(E)=C1​e−C2​E(1−e−C3​E+C4​)\n两个模型同时进行拟合，随后进行贝叶斯信息准则测试（BIC），最终发现 H 使用简化模型效果较好，其余元素均使用双指数模型。\n地球辐射带电子 ¶\n定义 LLL 为轨道高度（含地球半径）与地球半径的比值。当 L&gt;2.5L&gt;2.5L&gt;2.5 时，有 64% 的能谱呈现指数分布，有 32% 的能谱呈现bump‐on‐tail（BOT）分布，剩余 4% 呈现幂律分布 (11)。\n中国空间站轨道较低（L≈1.06L\\approx1.06L≈1.06），不考虑较为复杂的BOT分布，使用指数分布（j=j0e−EE0j=j_0e^{-\\frac{E}{E_0}}j=j0​e−E0​E​）和幂律分布（j=j0E−αj=j_0E^{-\\alpha}j=j0​E−α）同时进行拟合，最终选择采用BIC值较低的指数分布模型。\n地球辐射带质子 ¶\n由于未搜索到低轨道质子能谱的相关资料，因此采用与电子类似的方法，考虑增加平移项将幂律分布模型修改为 j=j0(E−β)−αj=j_0\\left(E-\\beta\\right)^{-\\alpha}j=j0​(E−β)−α，最终选用BIC值较低的幂律分布模型。\nGeant4 模型 ¶\n空间站 ¶\n空间站核心舱模型包括几何模型与材料填充，由于核心舱公开资料少，因此参考网络资料、ISS舱段以及石苗文中提供的信息，进行核心舱的建模。\n几何尺寸 ¶\n核心舱分区如图 6 所示。DESIRE项目通过建立三个不同详细程度的哥伦布舱模型，研究了几何模型对模拟结果的影响(5)，结果显示舱段细节对剂量率模拟基本没有影响，尤其是边角处的部件重要性有限，因此将天和核心舱简化为 5 个部分，几何模型与尺寸见表 3。\n图 6 核心舱分区\n表 3 核心舱模型部位几何模型尺寸 (m) 大柱段圆柱形 Φ4.2×L&nbsp;6.72\\Phi4.2\\times L\\ 6.72Φ4.2×L&nbsp;6.72 小柱段圆柱形 Φ2.8×L&nbsp;5.18\\Phi2.8\\times L\\ 5.18Φ2.8×L&nbsp;5.18 节点舱球形 Φ2.8\\Phi2.8Φ2.8 过渡段 1 圆台形 Φ2.8−2.13×L&nbsp;0.815\\Phi2.8-2.13\\times L\\ 0.815Φ2.8−2.13×L&nbsp;0.815 过渡段 2 圆台形 Φ4.2−2.8×L&nbsp;0.815\\Phi4.2-2.8\\times L\\ 0.815Φ4.2−2.8×L&nbsp;0.815\n材料 ¶\n空间站主要可分为外壳、填充材料与中间区域 3 个部分，中间区域主要为空气，填充区域主要为各类金属与有机材料，外壳较为复杂。ISS舱段外壳如图 7 所示，均由 3 层组成，内外为 Al 合金，中间为Kevlar等有机材料。\n国内Kevlar类产品主要有Taparan（泰普龙）等，其分子式为 [C14H10N2O2]n\\left[C_{14}H_{10}N_2O_2\\right]_n[C14​H10​N2​O2​]n​，密度为 1.44 g / cm3。外壳主要为 5 系铝合金，在本文中给直接使用纯 Al，最终外壳为 3 层，为 2 mm 铝与 10 mm Taparan + 5 mm 铝。模型总重为 22.1 吨，与实际质量相当。\n图 7 ISS 舱段外壳\n辐射源 ¶\n通量 ¶\n考虑各类粒子均为各向同性入射，核心舱全长 16.6 m，因此设置粒子均匀分布在半径为 12 m 的球面上，并保证粒子入射方向为球内，则每秒钟入射的粒子数目为：\nF=A∫EbEaϕ(E)d&nbsp;E,&nbsp;A=4π&nbsp;R2F=A\\int_{E_b}^{E_a}\\phi\\left(E\\right)\\mathrm{d}\\ E,\\ A=4\\pi\\ R^2\nF=A∫Eb​Ea​​ϕ(E)d&nbsp;E,&nbsp;A=4π&nbsp;R2\n经测试，外壳能够屏蔽 50 MeV 以下的质子和 100 keV 以下的电子，结合CRÈME86等模型的能量区间，对于不同粒子设定各自的能区。\n由于各类粒子通量相差极大，因此将其通量进行放缩，得到缩放因子（ZF），并保证每一类粒子的模拟数目不小于 106。模拟得到剂量率后，乘以缩放系数和任务时长，即可得到任务期间的剂量。\n表 4 各类粒子的模型、能区与缩放因子（ZF）粒子模型 R2R^2R2EbE_bEb​(MeV)EaE_aEa​(MeV) 模拟数目 ZFe−e^-e−j=j0e−EE0j=j_0e^{-\\frac{E}{E_0}}j=j0​e−E0​E​0.981070.110923242099999.98096pj=j0(E−β)−αj=j_0\\left(E-\\beta\\right)^{-\\alpha}j=j0​(E−β)−α0.99883501000100000042.85399415HC1βα−1pc(pcpc+C2)C3\\frac{C_1\\beta^{\\alpha-1}}{pc}\\left(\\frac{pc}{pc+C_2}\\right)^{C_3}pcC1​βα−1​(pc+C2​pc​)C3​0.98915220100000100000012.85431092HeC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9893622010000010000001.720188128LiC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9975522010000010000000.01298897BeC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9970822010000010000000.006691177BC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9956922010000010000000.017105837CC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9893622010000010000000.052286554NC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9889222010000010000000.013576554OC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9893622010000010000000.048846635FC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9932322010000010000000.001123492NeC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9901422010000010000000.008071585NaC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9926322010000010000000.00186687MgC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9897222010000010000000.01093646AlC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9921722010000010000000.001940381SiC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9887322010000010000000.008269257PC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9918322010000010000000.00041389SC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9887322010000010000000.00166099ClC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9908722010000010000000.000372027ArC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9943222010000010000000.000751798KC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9896322010000010000000.000466712CaC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9893522010000010000000.001161901ScC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9925122010000010000000.000231554TiC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.993422010000010000000.000829281VC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9942422010000010000000.000404172CrC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9931322010000010000000.00078409MnC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9938522010000010000000.000570973FeC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9935122010000010000000.00602806CoC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9942622010000010000002.09E-05NiC1e−C2E(1−e−C3E+C4)C_1e^{-C_2E}\\left(1-e^{-C_3E+C_4}\\right)C1​e−C2​E(1−e−C3​E+C4​)0.9923122010000010000000.000292996\n能谱与位置 ¶\n对于一个在 [a,b]\\left[a,b\\right][a,b] 的分布，设其概率密度函数 (PDF) 为 F(x)F\\left(x\\right)F(x)，要生成符合该分布的随机数，主要有两种方法：\n\n\nInverse Transform Method（ITM）\n对PDF积分可获得累积分布函数 (CDF)，记为 y=C(x)=∫axF(u)d&nbsp;uy=C\\left(x\\right)=\\int_{a}^{x}F\\left(u\\right)\\mathrm{d}\\ uy=C(x)=∫ax​F(u)d&nbsp;u，其反函数为 C−1(y)C^{-1}\\left(y\\right)C−1(y)。设 yyy 为 [0,1)\\left[0,1\\right)[0,1) 上均匀分布的随机数，则 x=C−1(y)x=C^{-1}\\left(y\\right)x=C−1(y) 满足 F(x)F\\left(x\\right)F(x) 的分布。\n\n\nAcceptance-Rejection Method（ARM）\n生成一个均匀分布随机数 X∼U(xmin,xmax)X\\sim U\\left(x_{min},x_{max}\\right)X∼U(xmin​,xmax​)，随后独立生成另一个均匀分布随机数 Y∼U(ymin,ymax)Y\\sim U\\left(y_{min},y_{max}\\right)Y∼U(ymin​,ymax​)，如果 Y≤F(X)Y\\le F\\left(X\\right)Y≤F(X)，则保留 XXX，保留下来的 XXX 满足 F(x)F\\left(x\\right)F(x) 的分布。\n\n\nITM也被称为反演法，关键是需要获取累积分布函数的逆函数，效率较高；ARM本质上是一种模拟算法，效率很低，但是适应性更广，特别是对于一些复杂分布函数。\n位置 ¶\n发射位置要求在球面上均匀分布，因此可以采用ITM方法生成位置，可以得到 θ\\thetaθ 的反函数为 C−1(z)=cos⁡−1(z)C^{-1}\\left(z\\right)=\\cos^{-1}{\\left(z\\right)}C−1(z)=cos−1(z)，而 ϕ\\phiϕ 在 [0,2π)\\left[0,2\\pi\\right)[0,2π) 上均匀分布。\n方向 (12)¶\n在Geant4中使用的坐标系是以中心为原点的三维坐标系（简称为W系），而我们随机生成的符合均匀分布的指向是在以粒子的位置矢量 r⃗\\vec{r}r 反方向作为 z 轴正方向建立的右手坐标系（简称为P系）中。\n为了保证发射方向 d⃗\\vec{d}d 朝向球内，因此需要限制 θ\\thetaθ 的最大角度为 90∘90^\\circ90∘。随后需要将 d⃗\\vec{d}d 转化到W系中，已知两个坐标系有两个公共点，在W系中表示为原点 OOO 和发射点 r⃗=(x0,y0,z0)\\vec{r}=\\left(x_0,y_0,z_0\\right)r=(x0​,y0​,z0​)，在P系中则为 (0,0,ρ)\\left(0,0,\\rho\\right)(0,0,ρ) 和原点 O′O^\\primeO′,则有：\n[xyz]=λR[uvw]+[x0y0z0]⋯(1)\\left[\\begin{matrix}x\\\\y\\\\z\\\\\\end{matrix}\\right]=\\lambda R\\left[\\begin{matrix}u\\\\v\\\\w\\\\\\end{matrix}\\right]+\\left[\\begin{matrix}x_0\\\\y_0\\\\z_0\\\\\\end{matrix}\\right]\\quad\\cdots\\quad(1)\n⎣⎢⎡​xyz​⎦⎥⎤​=λR⎣⎢⎡​uvw​⎦⎥⎤​+⎣⎢⎡​x0​y0​z0​​⎦⎥⎤​⋯(1)\n其中 λ\\lambdaλ 为尺度比例因子，设置为 1；RRR 被称为罗德里格矩阵，定义反对称矩阵：\nS=[0,−c,−bc,0,−ab,a,0]S=\\left[\\begin{matrix}0,&amp;-c,&amp;-b\\\\c,&amp;0,&amp;-a\\\\b,&amp;a,&amp;0\\\\\\end{matrix}\\right]\nS=⎣⎢⎡​0,c,b,​−c,0,a,​−b−a0​⎦⎥⎤​\n则 R 可表示为 R=(I+S)(I−S)−1R=\\left(I+S\\right)\\left(I-S\\right)^{-1}R=(I+S)(I−S)−1，展开后则有：\nR=11+a2+b2+c2[1+a2−b2−c2,−2c−2ab,−2b+2ac2c−2ab,1−a2+b2−c2,−2a−2bc2b+2ac,2a−2bc,1−a2−b2+c2]⋯(2)R=\\frac{1}{1+a^2+b^2+c^2}\\left[\\begin{matrix}1+a^2-b^2-c^2,-2c-2ab,-2b+2ac\\\\2c-2ab,1-a^2+b^2-c^2,-2a-2bc\\\\2b+2ac,2a-2bc,1-a^2-b^2+c^2\\\\\\end{matrix}\\right]\\quad\\cdots\\quad(2)\nR=1+a2+b2+c21​⎣⎢⎡​1+a2−b2−c2,−2c−2ab,−2b+2ac2c−2ab,1−a2+b2−c2,−2a−2bc2b+2ac,2a−2bc,1−a2−b2+c2​⎦⎥⎤​⋯(2)\n将两个公共点代入 (1)，相减则可消去平移项，可得到：\n[x2−x1y2−y1z2−z1]=R[u2−u1v2−v1w2−w1]\\left[\\begin{matrix}x_2-x_1\\\\y_2-y_1\\\\z_2-z_1\\\\\\end{matrix}\\right]=R\\left[\\begin{matrix}u_2-u_1\\\\v_2-v_1\\\\w_2-w_1\\\\\\end{matrix}\\right]\n⎣⎢⎡​x2​−x1​y2​−y1​z2​−z1​​⎦⎥⎤​=R⎣⎢⎡​u2​−u1​v2​−v1​w2​−w1​​⎦⎥⎤​\n随后代入 (2) 中，可得到（u21=u2−u1u_{21}=u_2-u_1u21​=u2​−u1​）：\n[0,w21+z21,v21+y21w21+z21,0,−u21−x21−v21−y21,−u21−x21,0][abc]=[u21−x21v21−y21w21−z21]\\left[\\begin{matrix}0,&amp;w_{21}+z_{21},&amp;v_{21}+y_{21}\\\\w_{21}+z_{21},&amp;0,&amp;-u_{21}-x_{21}\\\\-v_{21}-y_{21},&amp;-u_{21}-x_{21},&amp;0\\\\\\end{matrix}\\right]\\left[\\begin{matrix}a\\\\b\\\\c\\\\\\end{matrix}\\right]=\\left[\\begin{matrix}u_{21}-x_{21}\\\\v_{21}-y_{21}\\\\w_{21}-z_{21}\\\\\\end{matrix}\\right]\n⎣⎢⎡​0,w21​+z21​,−v21​−y21​,​w21​+z21​,0,−u21​−x21​,​v21​+y21​−u21​−x21​0​⎦⎥⎤​⎣⎢⎡​abc​⎦⎥⎤​=⎣⎢⎡​u21​−x21​v21​−y21​w21​−z21​​⎦⎥⎤​\n代入本文中则有：\n[0,−ρ+z0,y0−ρ+z0,0,−x0−y0,−x0,0][abc]=[−x0−y0−ρ−z0]\\left[\\begin{matrix}0,&amp;-\\rho+z_0,&amp;y_0\\\\-\\rho+z_0,&amp;0,&amp;-x_0\\\\-y_0,&amp;-x_0,&amp;0\\\\\\end{matrix}\\right]\\left[\\begin{matrix}a\\\\b\\\\c\\\\\\end{matrix}\\right]=\\left[\\begin{matrix}-x_0\\\\-y_0\\\\-\\rho-z_0\\\\\\end{matrix}\\right]\n⎣⎢⎡​0,−ρ+z0​,−y0​,​−ρ+z0​,0,−x0​,​y0​−x0​0​⎦⎥⎤​⎣⎢⎡​abc​⎦⎥⎤​=⎣⎢⎡​−x0​−y0​−ρ−z0​​⎦⎥⎤​\n令 a=1a=1a=1，则可得：\n{b=z0+ρ−y0x0c=z0−ρ+y0x0\\begin{cases}\nb=z_0+\\rho-y_0x_0 \\\\\nc=z_0-\\rho+y_0x_0\n\\end{cases}\n{b=z0​+ρ−y0​x0​c=z0​−ρ+y0​x0​​\n计算得到 RRR，继而根据 (1) 计算得到 d⃗\\vec{d}d 在W系中的表达式。\n能谱 ¶\n地球辐射带电子和质子的能谱较为简单，采用ITM方法，其CDF逆函数分别为：\n{−E0ln⁡(C−yj0E0),&nbsp;C=j0E0e−a/E0(y+C)(1−α)j01−α+β,&nbsp;C=j0(a−β)1−α1−α\\begin{cases}\n-E_0\\ln{\\left(\\frac{C-y}{j_0E_0}\\right)},\\ C=j_0E_0e^{-a/E_0} \\\\\n\\sqrt[1-\\alpha]{\\frac{\\left(y+C\\right)\\left(1-\\alpha\\right)}{j_0}}+\\beta,\\ C=\\frac{j_0\\left(a-\\beta\\right)^{1-\\alpha}}{1-\\alpha}\n\\end{cases}\n⎩⎪⎨⎪⎧​−E0​ln(j0​E0​C−y​),&nbsp;C=j0​E0​e−a/E0​1−αj0​(y+C)(1−α)​​+β,&nbsp;C=1−αj0​(a−β)1−α​​\n其中系数 j0j_0j0​均已归一化。GCR中各类粒子的函数较为复杂，因此采用ARM方法。粒子能谱的随机结果见图 9。\n图 9 各类粒子能谱随机结果\n人体模型 ¶\n模拟中可以使用ICRU球进行剂量的大概估算，也可以使用人体模型。辐射防护用虚拟人体模型经历了从简单的数学模型到复杂的面元模型的发展。\n在Geant4的示例中，附带有MIRD体模，效果见图 8。MIRD模型是由橡树岭国家实验室（ORNL）基于白种人参考模型建立的数学模型，在外照射问题上的转换系数相当精确 (13)，符合本文情况。\n图 8 Geant4 中 MIRD 体模\n由于工作量的问题，在本文中只是用MIRD男性全身体模进行模拟，身体各器官的体积与质量见表 5。MIRD体模中，除肺之外的各类器官使用 ICRU 规定的软组织材料进行填充；肺使用专用材料；骨使用ICRU规定的骨质，而包裹在外的头部、躯干和四肢则使用脂肪、水等材料，使得人体总重约为 86.8 kg。\n表 5 MIRD 男性体模各器官信息器官质量 (g) 体积 (cm3\\mathrm{cm^3}cm3) 器官质量 (g) 体积 (cm3\\mathrm{cm^3}cm3) 头颅 4595.484656.48 骨盆 897.554603.925 头骨 1256.16845.219 胃 396.856402.124 大脑 14511470.27 上大肠 429.223434.92 躯干 43406.143982.3 下大肠 339.834344.345(左 / 右) 腿 10252.110388.2 脾脏 173.625175.929(左 / 右) 手臂骨 1217.78819.39 胰腺 60.241461.0411(左 / 右) 腿骨 2080.291399.74 肝脏 1440.351459.47 上脊椎 187.947126.462 左肾脏 142.102143.988 左肩胛骨 152.24102.436 右肾脏 142.091143.977 右肩胛骨 154.486103.947 膀胱 45.440946.044(左 / 右) 肾上腺 7.751097.85398 心脏 362.795367.611 胸腺 24.803525.1327 左肺 499.7431689.46(左 / 右) 锁骨 20.309913.6657 右肺 499.8141689.7 小肠 1006.851020.22 甲状腺 12.742112.9113 胸腔 1021.01686.992 男性生殖器 226.245229.248 中低脊椎 1120.57753.982(左 / 右) 睾丸 18.540618.7867\nGeant4 模拟流程 ¶\n使用Geant4实现前文所述核心舱建模、人体建模与粒子定义，最终模型如图 10 所示，图中从前往后以此为节点舱、过渡段 1、小柱段、过渡段 2 与大柱段。人体模型站立在大柱段与过渡段 2 的交界处，如图 11 所示。\n对 30 种粒子依次模拟，通过Sensitive Detector记录进入人体模型的粒子，最终在User Run Action中将结果输出至文件中。\n图 10 核心舱建模效果\n图 11 人体模型位置\n结果与分析 ¶\n使用Python对数据进行处理，得到按粒子、器官分类的沉积能量信息，同时加入缩放因子和任务时长的因素，得到 30 天内航天员各器官沉积能量结果，按器官分类的结果如图 12 所示，按粒子分类的结果如图 13 所示。\n图 12 按器官分类的沉积能量结果\n图 13 按粒子分类的沉积能量结果\n吸收剂量 ¶\n通过表 5 中各器官的质量，可以计算得到各类器官的吸收剂量，按器官分类的结果如图 14 所示，按粒子分类的结果如图 15 所示。\n图 14 按器官分类的吸收剂量结果\n图 15 按粒子分类的吸收剂量结果\n吸收剂量受通量的影响很大。由于地球辐射带电子的通量远大于其余粒子，因此吸收剂量中地球辐射带电子占据的份额最大。\n当量剂量 ¶\n考虑粒子的辐射权重因子 ωR\\omega_RωR​，由此可以计算得到各器官的当量剂量。按器官分类的结果如图 16 所示，按粒子分类的结果如图 17 所示。\n由于电子、质子的 ωR\\omega_RωR​较小，而重离子的 ωR=20\\omega_R=20ωR​=20，因此当量剂量中重离子占据了相当大的份额，电子的贡献显著减小。\n图 16 按器官分类的当量剂量结果\n图 17 按粒子分类的当量剂量结果\n有效剂量 ¶\n结合不同器官的组织权重因子 ωT\\omega_TωT​，可以得到人体的有效剂量。按器官分类的结果如图 18 所示，按粒子分类的结果如图 19 所示。\n在计算中，男性生殖器的 ωT\\omega_TωT​使用性腺的 ωT\\omega_TωT​为 0.08，躯干、头颅、四肢的 ωT\\omega_TωT​使用皮肤的 ωT\\omega_TωT​为 0.01，其余器官的 ωT\\omega_TωT​来自于ICRP 103报告。\n图 18 按器官分类的有效剂量结果\n图 19 按粒子分类的有效剂量结果\n分析 ¶\n对结果的分类分析中可以发现一些现象：\n左右不对称 ¶\n由于粒子入射是各向同性，而核心舱模型也是各向同性的，理论上左右对称的器官应当有大致相同的能量沉积，但在结果中却发现左右腿等部分的沉积能量存在较大差异[4]，如表 6 所示。\n表 6 左右部位吸收剂量差异值部位左右差异腿 0.0259290550.03098487519.50 手臂骨 0.0003338580.00024384836.91 腿骨 0.0005267970.00075606443.52 肩胛骨 0.0001273650.000095932.81 肾上腺 00.0000463\\ 锁骨 0.0000000770\\ 睾丸 0.000001120\\\n对于如腿、手、肩胛骨等靠外侧的部位，可能是由于单次模拟的随机性造成的；而对于肾上腺，由于其位于人体内，由于肝脏、胰腺等器官并不左右对称，因此可能会导致左右不等。通过多次独立的模拟取均值的方式，可以验证这一问题的产生原因。\n男性生殖器 ¶\n在图 16 和图 18 中可以发现，男性生殖器的剂量是所有器官中最高的，特别是贡献了近 2 / 3 的有效剂量。这一结果可能是由于单次模拟的随机性造成的，同样需要多次独立模拟的验证。\n总体而言，在此次 30 天的任务期间，航天员全程站立于大柱段与过渡段 2 的交界处所受到的全身当量剂量为 287.6 mSv，而有效剂量为 8.57 mSv。假设其每 5 年平均在轨工作 12 个月，则年平均剂量为 20.568 a-1，略高于国家对于职业照射的剂量限值要求。\n总结 ¶\n本文使用SPENVIS建立了空间站天和核心舱轨道辐射环境的模型，并在Geant4中建立了核心舱简易几何模型与MIRD人体模型进行航天员辐射剂量的模拟。\n模拟结果显示，在所有种类的射线中，地球辐射带的电子由于其通量大，贡献了绝大部分的沉积能量，但是由于电子难以穿透皮肤，因此主要贡献在表层。相反，质子、α 粒子等重离子通量可观，能量高，因此在体内的器官中贡献了相当大一部分的有效剂量。\n附录 ¶\n参考文献 ¶\n\n 中国空间站建造进展情况新闻发布会召开_中国载人航天官方网站 [EB / OL]. [2022-04-17]. http://www.cmse.gov.cn/xwzx/202204/t20220418_49553.html.\nSUN W, JIA X, XIE T, 等. Construction of boundary-surface-based Chinese female astronaut computational phantom and proton dose estimation [J/OL]. Journal of Radiation Research, 2013, 54 (2): 383-397. DOI:10.1093/jrr/rrs100.\n石苗. 空间站航天员关键器官辐射剂量学研究 [D]. 南京航空航天大学, 2013.\nERSMARK T, CARLSON P, DALY E, 等. Status of the DESIRE project: Geant4 physics validation studies and first results from Columbus/ISS radiation Simulations [J/OL]. IEEE Transactions on Nuclear Science, 2004, 51 (4): 1378-1384. DOI:10.1109/TNS.2004.832648.\nERSMARK T, CARLSON P, DALY E, 等. Influence of geometry model approximations on Geant4 simulation results of the Columbus/ISS radiation environment [J/OL]. Radiation Measurements, 2007, 42 (8): 1342-1350. DOI:10.1016/j.radmeas.2007.06.001.\nERSMARK T, CARLSON P, DALY E, 等. Geant4 Monte Carlo Simulations of the Belt Proton Radiation Environment On Board the International Space Station/Columbus [J/OL]. IEEE Transactions on Nuclear Science, 2007, 54 (4): 1444-1453. DOI:10.1109/TNS.2007.896344.\nERSMARK T, CARLSON P, DALY E, 等. Geant4 Monte Carlo Simulations of the Galactic Cosmic Ray Radiation Environment On-Board the International Space Station/Columbus [J/OL]. IEEE Transactions on Nuclear Science, 2007, 54 (5): 1854-1862. DOI:10.1109/TNS.2007.906276.\n程彭超, 闵锐. 近地空间辐射环境与防护方法概述 [J]. 辐射防护通讯, 2017, 37 (01): 14-21.\nBOURDARIE Sé, XAPSOS M. The Near-Earth Space Radiation Environment[J/OL]. IEEE Transactions on Nuclear Science, 2008, 55(4): 1810-1832. DOI:10.1109/TNS.2008.2001409.\nMATTHIÄ D, BERGER T, MRIGAKSHI A I, 等. A ready-to-use galactic cosmic ray model [J/OL]. Advances in Space Research, 2013, 51 (3): 329-338. DOI:10.1016/j.asr.2012.09.022.\nZHAO H, JOHNSTON W R, BAKER D N, 等. Characterization and Evolution of Radiation Belt Electron Energy Spectra Based on the Van Allen Probes Measurements [J/OL]. Journal of Geophysical Research: Space Physics, 2019, 124 (6): 4217-4232. DOI:10.1029/2019JA026697.\n韩梦泽, 李克昭. 基于罗德里格矩阵的空间坐标转换 [J/OL]. 测绘工程, 2016, 25 (04): 25-27. DOI:10.19349/j.cnki.issn1006-7949.2016.04.006.\n徐玉海, 李桃生. 辐射防护用虚拟人体模型的发展研究 [Z]. 中国辐射卫生: 卷 21. 2012: 119-120.\n\n部分缩写列表 ¶\n\nDESCSS : Dose Estimation by Simulation of China Space Station\nDESIRE : Dose Estimation by Simulation of the ISS Radiation Environment\nISS : International Space Station 国际空间站\nTLE : Two Line Elements 两行轨道参数\nSPE : Solar Particle Event 太阳粒子事件\nGCR : Galactic cosmic rays 银河宇宙射线\nGPS : General Particle Source 通用粒子源\nBIC : Bayesian information criterion 贝叶斯信息量准则\nZF : Zoom Factor 缩放因子\nITM : Inverse Transform Method\nARM : Acceptance-Rejection Method\n\n\n\n\nhttp://www.cmse.gov.cn/gfgg/zgkjzgdcs/ ↩︎\n\nhttps://www.spenvis.oma.be/ ↩︎\n\nhttps://creme.isde.vanderbilt.edu/ ↩︎\n\n差异 η=max−minmin\\eta=\\frac{max-min}{min}η=minmax−min​ ↩︎\n\n\n\n","categories":["核物理","Geant4"],"tags":["核技术","Geant4","辐射防护"]},{"title":"CERN ROOT 的 Jupyter 环境","url":"/posts/202309-root-jupyter.html","content":"前言 ¶\nROOT 是由 CERN 开发的用于实验大数据处理的框架，主要应用于核物理和高能物理领域。ROOT 主要由 C++ 编写，但较新版本中也提供了 Python 的借口，通过引入pyroot实现。\n一般而言，通常在命令行输入root后，通过TBrowser浏览文件；或者使用 C++ 编写数据处理的函数，在 ROOT 中进行调用。而使用 Jupyter 来编写 ROOT 程序在学习和开发阶段较为便利。由于预编译版本的 ROOT 已经绑定了特定 Python 版本，有可能与本机的 Python 版本不匹配，所以通过源代码编译安装的方式能够避免绝大部分的兼容性问题。\n安装 ¶\n本机环境\nUbuntu 20.04.6\nPython 3.10.11\n\n目前 ROOT 的最新版本为 6.28，但为了兼容本机上的 Garfield Plus Plus，因此选择 6.26 版本。在 ROOT Releases 页面下载对应版本的安装包。\n依赖 ¶\n在 ROOT Install Dependencies 查看对应系统版本要求的依赖，对于 Ubuntu 使用一行命令解决必备依赖：\nsudo apt-get install dpkg-dev cmake g++ gcc binutils libx11-dev libxpm-dev \\libxft-dev libxext-dev python libssl-dev\n其余推荐依赖按照需求进行安装，我只需要 ROOT 的基础功能，因此没有安装其他依赖，在后续编译过程中可以设置部分编译选项加快速度。此外推荐安装 ccmake 方便后续编译。\n编译 ¶\n解压下载好的安装包，新建与安装包同级的目录 build，进入目录后进行编译安装：\ntar -zxvf root_v6.26.10.source.tar.gzmkdir build &amp;&amp; cd buildcmake -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX -DCMAKE_CXX_STANDARD=17 -DCXX_STANDARD_STRING=17 -Ddavix=OFF -Dfftw3=OFF -Dgdml=OFF -Dgfal=OFF -Dmysql=OFF -Doracle=OFF -Dpgsql=OFF -Dpythia6=OFF -Dpythia8=OFF -Dxml=OFF -Dbuiltin_zstd=ON -Dbuiltin_glew=ON -Dbuiltin_gl2ps=ON -Dbuiltin_xrootd=ON -Dbuiltin_ftgl=ON ../root-6.26.10ccmake .\n$INSTALL_PREFIX是需要安装到的目录，CMAKE_CXX_STANDARD根据自己的 gcc 版本和需要来选择，可以通过以下命令查看：\n&gt; gcc -E -dM - &lt;/dev/null | grep \"STDC_VERSION\"#define __STDC_VERSION__ 201710L\n2017 代表支持 c17 标准。ccmake 可以生成一个在命令行的简略界面方便我们对编译选项进行调整。调整完成后根据下方的提示操作，多次按c进行确认直至出现Press [g] ... 的提示，此时可以按g生成相关文件，随后进行编译安装：\nmake -j 12make install -j 12\n-j参数后面是使用的线程数，我的计算机有 8 核 16 线程，16GB 内存。不推荐使用全部线程，因为编译会占用很大内存，可能会导致编译失败，可以根据线程数和内存大小酌情调整。最后修改自己的 shell 配置文件（例如.bashrc，.zshrc），在适当位置添加：\nsource $INSTALL_PREFIX/bin/thisroot.sh\n添加内核 ¶\n使用下列命令安装 Python 所需的包：\npip install jupyter metakernel\n安装后有两种方式可以在 Jupyter 中使用 ROOT：\n\nROOT-flavored 的 notebook\n\nroot --notebook\n\n全功能的 Jupyter Lab（推荐）\n\ncp -r $INSTALL_PREFIX/etc/notebook/kernels/root ~/.local/share/jupyter/kernelsjupyter lab\n关于 Jupyter Lab 的相关配置，可以查看 服务与插件。\n试用 ¶\n一个在 Jupyter ROOT Block 中绘制直方图的示例：\nTCanvas c;TH1F h(\"h\",\"ROOT Histo;X;Y\",64,-4,4);h.FillRandom(\"gaus\");h.Draw();c.Draw();\n效果图\n问题 ¶\n\nWSL 中使用 new TBrowser 将会开启 HTTP 服务而不是窗口[3]\n在家目录（例如 /home/fox）下创建 .rootrc 文件并写入：\n\nBrowser.Name: TRootBrowser\n\nROOT 6.28 版本以下使用 Python 3.11 及以上版本编译安装时报错 [4,5,6]\n\n[.....]/CPPOverload.cxx:5:10: fatal error: 'code.h' file not found#include \"code.h\" // from Python^~~~~~~~\n修改 CPPOverload.cxx 文件，将原本的内容：\n#if PY_VERSION_HEX &gt;= 0x02050000#include \"code.h\"            // from Python#else#include \"compile.h\"         // from Python#endif\n修改为：\n#if PY_VERSION_HEX &lt; 0x02050000#include \"compile.h\"         // from Python#elif PY_VERSION_HEX &lt; 0x030b0000#include \"code.h\"            // from Python#endif\n这是因为 Python 3.11 及以上版本将其移动到了 Include/cpython 中，已经被 Python.h 包含。\n参考资料 ¶\n\nBuilding ROOT from source\nJupyROOT\nTBrowser WSL starts in the web browser\nInclude “code.h” and Python 3.11\n[v6-24][PyROOT] code.h must not be included directly in 3.11\nWhat’s New In Python 3.11\nHow to use ROOT in a Jupyter notebook\n\n","categories":["核物理","工具软件"],"tags":["教程","核技术","ROOT","Jupyter"]},{"title":"学习笔记 | 贝叶斯块算法","url":"/posts/202310-bayesian-block.html","content":"\n\n施工中\n\n获取探测器的计数随时间或其他物理量的变化可以帮助了解发生的物理过程的各种性质。例如在 X 射线和 γ 射线天文学中十分关注光子计数随时间的变化，这一类变化被称为光变曲线，可以借此计算相应物理过程的空间尺度等性质。\n基础知识 ¶\n核辐射测量的统计性质 ¶\n探测 X/γ 射线需要使用核辐射探测器，每探测到一个事例，探测器将会记录相应事例的物理信息，如时间、能量、径迹等。核辐射的测量充满了随机性，但是可以用统计分布来描述其中的随机性。单个放射性粒子的衰变过程是一个伯努利事件，其衰变常数为 λ\\lambdaλ，则在时间 0∼t0\\sim t0∼t 内发生衰变的可能性为：\n\\begin{align}\np = 1 - e^{-\\lambda t}\n\\end{align}\n\n对于由 n0n_0n0​ 个放射性粒子组成的体系，彼此之间发生衰变是独立的，则体系的衰变过程是一个 n0n_0n0​ 重伯努利过程，即 ttt 时刻发生了衰变的粒子数目 nnn 满足二项分布：\n\\begin{equation}\\begin{split}\nP(n|n_0) &amp;= C_{n_0}^np^n(1-p)^{n_0-n} \\\\\n\\mu &amp;= E(n) = n_0p \\\\\n\\sigma^2 &amp;= D(n) = n_0p(1-p)\n\\end{split}\\end{equation}\n\n当 n0n_0n0​ 足够大，而 ppp 足够小时，二项分布可以近似为泊松分布：\n\\begin{equation}\\begin{split}\nP(n) &amp;= \\frac{\\mu^n}{n!}e^{-\\mu} \\\\\n\\mu &amp;= n_0p \\\\\n\\sigma &amp;= \\sqrt{\\mu}\n\\end{split}\\end{equation}\n\n对于一般的物理过程而言，都满足该条件。当均值 μ\\muμ 足够大时，泊松分布可以进一步近似为高斯分布。在辐射测量中，我们获取到的是探测时间 dt\\mathrm{d}tdt 内的总计数，假设 dt\\mathrm{d}tdt 时间内源的强度 λ\\lambdaλ （单位为 s−1\\mathrm{s}^{-1}s−1）不变，则有：\nμ=λdt\\mu = \\lambda\\mathrm{d}t\nμ=λdt\n两个相邻事例的时间间隔为 TTT 表示在第一个事例后 0∼T0\\sim T0∼T 时间内没有事例，而在 T∼T+dtT\\sim T+\\mathrm{d}tT∼T+dt 时间内有一个事例，其概率可以表示为：\n\\begin{equation}\\begin{split}\nP(t\\le T \\le t+\\mathrm{d}t) &amp;= P_t(0)\\times P_{\\mathrm{d}t}(1)\\\\\nP_t(0) = \\frac{(\\lambda t)^0}{0!}e^{-\\lambda t} &amp;= e^{-\\lambda t} \\\\\nP_{\\mathrm{d}t}(1) = \\frac{(\\lambda\\mathrm{d}t)^1}{1!}e^{-\\lambda\\mathrm{d}t} &amp;\\approx \\lambda\\mathrm{d}t\\quad(e^{-\\lambda\\mathrm{d}t} \\to 1)\n\\end{split}\\end{equation}\n\n设 f(t)f(t)f(t) 为概率密度函数，则有：\n\\begin{align}\nf(t)\\mathrm{d}t = P(t\\le T \\le t+\\mathrm{d}t) = \\lambda e^{-\\lambda t}\\mathrm{d}t\n\\end{align}\n\n可见时间间隔 TTT 满足指数分布，可以求得其期望值 t‾=1λ\\overline{t}=\\frac{1}{\\lambda}t=λ1​。\n贝叶斯定理 ¶\n对于一个模型 M\\mathscr{M}M，假设其所有参数构成向量 θ\\thetaθ。则根据已知数据 DDD，贝叶斯定理可以表示为：\n\\begin{align}\nP(\\theta|D,\\mathscr{M}) = \\frac{P(D|\\theta,\\mathscr{M})P(\\theta|\\mathscr{M})}{P(D|\\mathscr{M})}\n\\end{align}\n\neq-bayesian\n其中：\n\nP(θ∣D,M)P(\\theta|D,\\mathscr{M})P(θ∣D,M) 为 θ\\thetaθ 的后验概率（已知 DDD 情况下 θ\\thetaθ 的条件概率）\nP(θ∣M)P(\\theta|\\mathscr{M})P(θ∣M) 为 θ\\thetaθ 的先验概率\nP(D∣θ,M)P(D|\\theta,\\mathscr{M})P(D∣θ,M) 为 DDD 的后验概率或者在特定 DDD 下，θ\\thetaθ 的似然性，即 L(θ∣D,M)L(\\theta|D,\\mathscr{M})L(θ∣D,M)\nP(D∣M)P(D|\\mathscr{M})P(D∣M) 为 DDD 的先验概率\n\n对于一组模型 M1,M2,…,Mn\\mathscr{M}_1,\\mathscr{M}_2,\\dots,\\mathscr{M}_nM1​,M2​,…,Mn​，所有的约束、相关背景知识或者假设被称为信息背景，记作 III。则在给定 DDD 和 III 的情况下，不同模型的后验概率可以表示为：\n\\begin{align}\nP(\\mathscr{M}_k|D,I) = \\frac{P(D|\\mathscr{M}_k,I)P(\\mathscr{M}_k|I)}{P(D|I)}\n\\end{align}\n\n信息背景应当是不变的，所以我们可以省略。因此两种模型对数据的符合程度可以使用其后验概率的比值（即 odds ratio）表示：\n\\begin{align}\n\\mathscr{O}_{ij} = \\frac{P(\\mathscr{M}_i|D)}{P(\\mathscr{M}_j|D)} = \\frac{P(D|\\mathscr{M}_i)P(\\mathscr{M}_i)}{P(D|\\mathscr{M}_j)P(\\mathscr{M}_j)}\n\\end{align}\n\n根据贝叶斯公式，由于 P(θk∣D,Mk)P(\\theta_k|D,\\mathscr{M}_k)P(θk​∣D,Mk​) 归一化，由式 (eq-bayesian) 可以得到：\n\\begin{align}\n\\mathscr{L}(\\mathscr{M}_k|D) \\equiv P(D|\\mathscr{M}_k) = \\int P(D|\\theta_k,\\mathscr{M}_k)P(\\theta_k|\\mathscr{M}_k)\\mathrm{d}\\theta_k \\\\\nJ(\\mathscr{M}_k|D) \\equiv P(\\mathscr{M}_k)\\int P(D|\\theta_k,\\mathscr{M}_k)P(\\theta_k|\\mathscr{M}_k)\\mathrm{d}\\theta_k\n\\end{align}\n\neq-global-likelihood\n其中 L(Mk∣D)\\mathscr{L}(\\mathscr{M}_k|D)L(Mk​∣D) 被称为全局似然函数（global likelihood，叫边缘概率更多，marginal probability），J(Mk∣D)J(\\mathscr{M}_k|D)J(Mk​∣D) 是数据和模型的联合概率（joint probability），包含了先验信息而与模型参数无关，则有：\n\\begin{align}\n\\mathscr{O}_{ij} = \\frac{\\mathscr{L}(\\mathscr{M}_i|D)}{\\mathscr{L}(\\mathscr{M}_j|D)}\\rho\n\\end{align}\n\neq-odds-ratio\n其中：\n\\begin{align}\n\\rho = \\frac{P(\\mathscr{M}_i)}{P(\\mathscr{M}_j)}\n\\end{align}\n\n光变曲线 ¶\n一定时间范围内的计数随时间的变化曲线就是我们所需的光变曲线，因此光变曲线可以理解为探测事例根据时间绘制的频数分布直方图。直方图的每一组在这里被称为分箱（bin），组距被称为 bin 宽，各组的界限值被称为 bin edge，直方图一个很重要的特性的分箱之间是等距的。\n对事例进行分箱的会丢弃大量信息，而且分箱的大小和位置对最终分析结果的影响很大。bin 宽越小，能够展现更精细的结构，但是单一分箱内的计数过少，统计性不足；bin 宽越大，统计性越强，但是丢失的物理信息更多。所以我们需要一种方法，既能够保证统计性，同时还能尽可能地展现精细的结构。这种方法应当允许分箱拥有不同的 bin 宽，而且 bin edge 能够根据数据自适应确定。\n一个简单的想法是遍历每一种可能的分箱方案，而可能方案的总数为 2N2^N2N ，其中 NNN 为数据点的数目。显而易见随着数据量的增大，这种方法很快变得不可用。Scargle 在 1998 年提出了基于似然函数的迭代算法(1)，能够在可接受的时间范围内得出近似解；而在 2013 年，Scargle 基于动态规划（Dynamic Programming）和块评价函数提出了一种新算法(2)，能够在 O(N2)O(N^2)O(N2) 的时间内求出最优解。在本文中，前者称为近似算法，后者为 DP 算法，两者统称为贝叶斯块算法。\n贝叶斯块算法 ¶\n贝叶斯块算法将光变曲线表示为亮度随时间的分段常数，可以用于估计背景水平以及物理事件的时间尺度、空间尺度与强度等信息。\n在该算法中，单个的数据点被称为 Cell，而对数据进行分割的点被称为分割点 Change Point（简写为 cp），而相邻两个分割点之间（包括第一个分割点之前与最后一个分割点之后的）的所有数据点的集合被称为块 Block，某种特定的分割方案（或分割点的组合）被称为组合 Partition。\n算法的关键思想是不同块之间的评价是独立的，仅取决于该块的性质（例如块的长度、数据的情况等）。例如简单的分段常数模型具有这些参数：\n\nNcpN_\\mathrm{cp}Ncp​：分割点的数目\ntkcpt^\\mathrm{cp}_ktkcp​：第 kkk 个块的起始点（即第 k−1k-1k−1 个和第 kkk 个块的分割点）\nXkX_kXk​：第 kkk 个块的信号强度\n\n其中 k∈{1,2,…,Ncp+1}k\\in\\{1,2,\\dots,N_\\mathrm{cp}+1\\}k∈{1,2,…,Ncp​+1}，块最重要的两个参数是强度（即 XkX_kXk​）与长度（起始点与下一个分割点之间的间隔）。模型关键的问题在于要分多少个块，近似算法和 DP 算法对此的处理方式有所区别，具体参见后文。\n数据模式 ¶\nTime-Tagged Event Data¶\nTime-Tagged Event（时间标记事件，TTE）是指记录事例入射时间的模式，表示为：\n\\begin{align}\nD_\\mathrm{TTE}: \\{t_n,n=1\\dots N\\}\n\\end{align}\n\neq-tte-1\n事件记录的精度取决于采集系统的频率，以 20 MHz 的晶振为例，其时钟间隔 δt=50&nbsp;ns\\delta t = 50\\ \\mathrm{ns}δt=50&nbsp;ns，因此式 (eq-tte-1) 可以表示为：\n\\begin{align}\nD_\\mathrm{TTE}: \\{m_n,n=1\\dots N\\}\n\\end{align}\n\neq-tte-2\n其中 mnm_nmn​ 为时间刻度（time ticks），其代表的时间与总的刻度数为：\n\\begin{align}\nt_m &amp;= m\\delta t \\\\\nM &amp;= \\frac{T}{\\delta t}\n\\end{align}\n\n进一步，式 (eq-tte-1) 可以使用可观测量 XmX_mXm​ 表示为：\n\\begin{align}\nD_\\mathrm{TTE}: X_m = \\begin{cases}\n0, \\mathrm{no\\ event\\ during\\ tick\\ m} \\\\\n1, \\mathrm{otherwise}\n\\end{cases}\n\\end{align}\n\n其概率可以表示为：\n\\begin{equation}\\begin{split}\nP(X_m=0|\\Lambda) &amp;= e^{-\\Lambda} = p_0 \\\\\nP(X_m=1|\\Lambda) = 1 - p_0 &amp;= p_1 = e^{-\\Lambda}\\sum\\limits_{k=1}^{\\infty}\\frac{\\Lambda^k}{k!} \\\\\n\\Lambda &amp;= \\lambda\\delta t\n\\end{split}\\end{equation}\n\n由于时间间隔 δt\\delta tδt 极短，所以当 λ\\lambdaλ 不太大时，在一个时间间隔内多于 1 个入射事例的可能性相当低，则有：\n\\begin{align}\np_1 = 1 - e^{-\\lambda\\delta t} \\approx \\lambda\\delta t = \\Lambda\n\\end{align}\n\neq-tte-p1\nBinned Data¶\nBinned Data 是已经分箱数据，将时间区间 TTT 均分为 MMM 个区间，XmX_mXm​ 表示第 mmm 个区间的事例计数，则有：\n\\begin{align}\nD_\\mathrm{BIN}: \\{X_m,m=1,\\dots,M\\} \\\\\nP(X_m|\\Lambda) = \\frac{\\Lambda^{X_m}}{X_m!}e^{-\\Lambda}\n\\end{align}\n\nTime-to-Spill Data¶\nTime-to-Spill（TTS）是指为了减少数据量，而每隔 SSS 个事例记录一个事例数据的模式，可表示为：\n\\begin{align}\nD_\\mathrm{TTS}: \\{\\tau_n,n=1,\\dots,N-1\\}\n\\end{align}\n\nτn\\tau_nτn​ 是第 nnn 个和第 n+1n+1n+1 个记录的事例之间的时间间隔（以刻度数表示，即实际时间间隔为 τnδt\\tau_n\\delta tτn​δt），其分布满足：\n\\begin{align}\nP(\\tau|\\Lambda) = \\frac{\\Lambda^S}{\\Gamma(S)}\\tau^{S-1}e^{-\\Lambda\\tau}\n\\end{align}\n\n混合模式 ¶\n实际观测过程中，同一事件的数据模式可能会发生改变。例如计数率太高时可能从 TTE 模式更改为 BIN 或者 TTS 模式，但只要选择的块评价函数对于不同数据模式而言是一致的，则可以处理任意混合模式的数据。\n曝光 ¶\n在观测过程中，受到各种因素的影响，仪器的相应并不是一致的，例如辐射源的强度可能会改变探测器的探测效率，天气和环境的改变也可能会造成遮挡或噪声。这些因素的综合影响被称为曝光（Exposure），可以直接从整个探测系统（包含环境）的性质出发进行计算得到，或者通过仪器的刻度与标定获得。在实际中我们可以将第 nnn 个数据点的曝光表示为：\n\\begin{align}\n0\\le e_n \\le 1\n\\end{align}\n\n在实际计算中，需要将曝光的影响进行归一化，即将计数率乘以一个因子 1en\\frac{1}{e_n}en​1​。对于 TTE 数据我们得到的只是离散的时间序列，为了将其转化为计数率，需要除以事例间隔长度，具体而言对于第 nnn 个事例，其计数率 CnC_nCn​ 可以表示为：\n\\begin{align}\nC_n &amp;= \\frac{1}{e_n\\Delta t_n} \\\\\n\\Delta t_n &amp;= (t_{n+1}-t_{n-1}) / 2\n\\end{align}\n\n可以证明 CnC_nCn​ 满足一个仅与第 nnn 个事例时的真实计数率相关的分布。\n近似算法 ¶\n常数泊松分布模型 ¶\n假定在时间区间 TTT 内，辐射源的强度恒定不变，用单位时间的光子数 λ&gt;0\\lambda &gt; 0λ&gt;0 表示。将观测时段以固定时间间隔 ΔT\\Delta TΔT 划分为若干子区间，每个子区间上的计数 kkk 均满足泊松分布，即：\n\\begin{equation}\\begin{split}\nP(k|\\Lambda) &amp;= \\frac{\\Lambda^ke^{-\\Lambda}}{k!} \\\\\n\\Lambda &amp;\\equiv \\lambda\\Delta T\n\\end{split}\\end{equation}\n\n使用 M(Λ,T)\\mathscr{M}(\\Lambda, T)M(Λ,T) 表示该模型类。除了常数模型外，还有线性模型与指数模型等，其表达式分别为：\n\\begin{align}\n\\lambda(t) &amp;= \\lambda_0[1+a(t-t_0)] \\\\\n\\lambda(t) &amp;= \\lambda_0 e^{a(t-t_0)}\n\\end{align}\n\n其中 λ0\\lambda_0λ0​ 是基准强度，t0t_0t0​ 是基准时间，aaa 是强度的变化速率。\nTTE Data¶\n由于不同入射事例之间是彼此独立的，则 DTTED_\\mathrm{TTE}DTTE​ 的联合概率可以表示为每一刻度上概率的乘积：\n\\begin{equation}\\begin{split}\nP[D_\\mathrm{TTE}|\\mathscr{M}(\\Lambda, T)] &amp;= \\prod\\limits_{m=1}^MP(X_m|\\Lambda) \\\\\n&amp;= p_1^Np_0^{M-N}\n\\end{split}\\end{equation}\n\neq-tte-join\n可以发现与参数 TTT 无关，模型类可简写为 M(Λ)\\mathscr{M}(\\Lambda)M(Λ)。由二项分布可知当 p1p_1p1​ 满足：\n\\begin{align}\n\\frac{N}{M+1}\\le p_1 \\le \\frac{N+1}{M+1}\n\\end{align}\n\n时，式 (eq-tte-join) 有最大值，由于 NNN 和 MMM 都较大，不妨取 p1=NMp_1=\\frac{N}{M}p1​=MN​。则由式 (eq-tte-p1) 有：\n\\begin{align}\n\\lambda &amp;= -\\frac{1}{\\delta t}\\ln\\left(1-\\frac{N}{M}\\right) \\\\\n&amp;\\approx \\frac{1}{\\delta t}\\frac{N}{M}\n\\end{align}\n\neq-tte-lambda-max-1\neq-tte-lambda-max-2\n使用 p1p_1p1​ 代替 Λ\\LambdaΛ 作为模型参数，设参数 p1p_1p1​ 的先验分布为：\n\\begin{align}\nP(p_1|\\mathscr{M}) = \\begin{cases}\n1, 0 \\le p_1 \\le 1 \\\\\n0, \\mathrm{otherwise}\n\\end{cases}\n\\end{align}\n\n代入式 (eq-global-likelihood) 中的全局似然函数，可得：\n\\begin{equation}\\begin{split}\nP(D_\\mathrm{TTE}|\\mathscr{M}) &amp;= \\int P[D_\\mathrm{TTE}|\\mathscr{M}(p_1)]P(p_1|\\mathscr{M})\\mathrm{d}p_1 \\\\\n&amp;= \\int_0^1 p_1^N(1-p_1)^{M-N}\\mathrm{d}p_1 \\\\\n&amp;= B(N+1, M-N+1)\n\\end{split}\\end{equation}\n\n其中 B(x,y)B(x,y)B(x,y) 为贝塔函数，可以用伽马函数表示为：\n\\begin{align}\nB(x,y) = \\frac{\\Gamma(x)\\Gamma(y)}{\\Gamma(x+y)}\n\\end{align}\n\n因此可得：\n\\begin{equation}\\begin{split}\n\\mathscr{L}(\\mathscr{M}|D_\\mathrm{TTE}) &amp;= \\frac{\\Gamma(N+1)\\Gamma(M-N+1)}{\\Gamma(M+2)} \\\\\n&amp;= \\frac{N!(M-N)!}{(M+1)!}\n\\end{split}\\end{equation}\n\neq-tte-likelihood\nBIN Data¶\n同上可得 DBIND_\\mathrm{BIN}DBIN​ 的联合概率为：\n\\begin{align}\nP[D_{BIN}|\\mathscr{M}(\\Lambda)] = \\frac{\\Lambda^Ne^{-M\\Lambda}}{\\prod\\limits_{m=1}^MX_m!},\\ N = \\sum\\limits_{m=1}^MX_m\n\\end{align}\n\neq-bin-joint\n将式 (eq-bin-joint) 中的分子对 Λ\\LambdaΛ 求导可得：\n\\begin{align}\n\\frac{\\mathrm{d}(\\Lambda^Ne^{-M\\Lambda})}{\\mathrm{d}\\Lambda} = N\\Lambda^{N-1}e^{-M\\Lambda}-M\\Lambda^Ne^{-M\\Lambda}\n\\end{align}\n\n令其等于 0 则可得最大概率的 Λ\\LambdaΛ 取值为：\n\\begin{align}\n\\Lambda = \\frac{N}{M}\n\\end{align}\n\neq-bin-lambda-max\n与式 (eq-tte-lambda-max-2) 中的近似值一致。设参数 Λ\\LambdaΛ 的先验分布为：\n\\begin{align}\nP(\\Lambda|\\mathscr{M}) = \\begin{cases}\n\\frac{e^{-\\Lambda}}{1 - e^{-C}}, 0 \\le\\Lambda\\le C \\\\\n0, \\mathrm{otherwise}\n\\end{cases}\n\\end{align}\n\neq-bin-prior\n可以证明该分布等价于 p0p_0p0​ 在 [e−C,1][e^{-C},1][e−C,1] 上的均匀分布。此处的 CCC 可以近似用 TMtd\\frac{T}{Mt_d}Mtd​T​ 表示，其中 tdt_dtd​ 表示仪器的死时间。对于特定的一组数据，不同模型中式 (eq-bin-joint) 中的分母不会发生改变，可以略去。当考虑 C→∞C\\to\\inftyC→∞ 时，则有：\n\\begin{equation}\\begin{split}\n\\mathscr{L}(M|D_\\mathrm{BIN}) = \\int_0^\\infty\\Lambda^Ne^{-(M+1)\\Lambda}\\mathrm{d}\\Lambda = \\frac{\\Gamma(N+1)}{(M+1)^{N+1}}\n\\end{split}\\end{equation}\n\neq-bin-likelihood\nTTS Data¶\n同上可得 DTTSD_\\mathrm{TTS}DTTS​ 的联合概率为：\n\\begin{align}\nP[D_\\mathrm{TTS}|\\mathscr{M}(\\Lambda)] = \\left[\\frac{\\Lambda^S}{\\Gamma(S)}\\right]^{N-1}\\left(\\prod\\limits_{n=1}^{N-1}\\tau_n\\right)^{S-1}e^{-\\Lambda M},\\ M=\\sum\\limits_{n=1}^{N-1}\\tau_n\n\\end{align}\n\n同理可求得最大概率处 Λ\\LambdaΛ 的取值为：\n\\begin{align}\n\\Lambda = \\frac{SN}{M}\n\\end{align}\n\neq-tts-lambda-max\n结合式 (eq-bin-prior)，当 C→∞C\\to\\inftyC→∞ 时可求得似然函数为：\n\\begin{align}\n\\mathscr{L}(\\mathscr{M}|D_\\mathrm{TTS}) = \\frac{\\left(\\prod_{n=1}^{N-1}\\tau_n\\right)^{S-1}}{\\Gamma(S)^{N-1}}\\frac{\\Gamma[S(N-1)+1]}{(M+1)^{S(N-1)+1}}\n\\end{align}\n\neq-tts-likelihood\n总结 ¶\n在常数泊松分布模型下，不同数据情况下的似然度仅取决于时间区间 TTT 的长度（以刻度数 MMM 表示）和区间内的事例数目 NNN，因此可以写成：\n\\begin{align}\n\\mathscr{L}(\\mathscr{M}_1|D) = \\phi_D(N,M)\n\\end{align}\n\n其中 M1\\mathscr{M}_1M1​ 代表常数泊松分布模型。不同 DDD 情况下的似然函数由式 (eq-tte-likelihood), (eq-bin-likelihood), (eq-tts-likelihood) 给出：\n\\begin{align}\n\\phi_\\mathrm{TTE} &amp;= \\frac{\\Gamma(N+1)\\Gamma(M-N+1)}{\\Gamma(M+2)} = \\frac{N!(M-N)!}{(M+1)!} \\\\\n\\phi_\\mathrm{BIN} &amp;= \\frac{\\Gamma(N+1)}{(M+1)^{N+1}} \\\\\n\\phi_\\mathrm{TTS} &amp;= \\frac{\\left(\\prod_{n=1}^{N-1}\\tau_n\\right)^{S-1}}{\\Gamma(S)^{N-1}}\\frac{\\Gamma[S(N-1)+1]}{(M+1)^{S(N-1)+1}}\n\\end{align}\n\n分段常数泊松分布模型 ¶\n在未分段的常数泊松分布模型上改进，将整个时间区间分为若干子区间，每一个子区间内都是恒定的泊松分布模型。考虑最简单的二分段模型，可以使用 M2(Λ1,Λ2,tcp)\\mathscr{M}_2(\\Lambda_1,\\Lambda_2,t_\\mathrm{cp})M2​(Λ1​,Λ2​,tcp​) 表示，该模型可以表示为两个简单模型的复合：\n\\begin{align}\n\\mathscr{M}_2(\\Lambda_1,\\Lambda_2,t_\\mathrm{cp}) = \\mathscr{M}_1(\\Lambda_1,M_1)\\otimes\\mathscr{M}_1(\\Lambda_2,M_2)\n\\end{align}\n\n其中 tcpt_\\mathrm{cp}tcp​ 表示两段的分割点（Change Point），在该点处泊松分布的参数从 Λ1\\Lambda_1Λ1​ 改变为 Λ2\\Lambda_2Λ2​，前后两段的计数分别为 N1N_1N1​ 与 N2N_2N2​，长度分别为 M1M_1M1​ 与 M2M_2M2​。由于前后两个过程是独立的，因此复合模型的概率可以表示为两个子模型的乘积：\n\\begin{align}\nP[D|\\mathscr{M}_2(\\Lambda_1,\\Lambda_2,t_\\mathrm{cp})] = P[D_1|\\mathscr{M}_1(\\Lambda_1,M_1)]\\times P[D_2|\\mathscr{M}_1(\\Lambda_2,M_2)]\n\\end{align}\n\n进而可得到全局似然函数：\n\\begin{equation}\\begin{split}\n\\mathscr{L}(\\mathscr{M}_2|D) = &amp;\\int\\mathrm{d}t_\\mathrm{cp}\\int\\mathrm{d}\\Lambda_1\\int\\mathrm{d}\\Lambda_2 P_\\mathrm{cp}(t_\\mathrm{cp}) \\\\\n&amp;\\times P[D_1|\\mathscr{M}_1(\\Lambda_1,M_1)]P_\\Lambda(\\Lambda_1|\\mathscr{M}_1) \\\\\n&amp;\\times P[D_2|\\mathscr{M}_1(\\Lambda_2,M_2)]P_\\Lambda(\\Lambda_2|\\mathscr{M}_1)\n\\end{split}\\end{equation}\n\n积分后的表达式应当与参数 Λ1\\Lambda_1Λ1​， Λ2\\Lambda_2Λ2​ 和 tcpt_\\mathrm{cp}tcp​ 无关。两个子模型之间应当是无关的，因此可分离变量为：\n\\begin{align}\n\\psi(t_\\mathrm{cp}) = \\phi(N_1,M_1)\\phi(N_2,M_2) \\\\\n\\mathscr{L}(\\mathscr{M}_2|D) = \\int P_\\mathrm{cp}(t_\\mathrm{cp})\\psi(t_\\mathrm{cp})\\mathrm{d}t_\\mathrm{cp}\n\\end{align}\n\n实际上各种数据中时间点都是离散的，因此 dtcp\\mathrm{d}t_\\mathrm{cp}dtcp​ 的积分可以使用求和代替。考虑 TTE 情况下的数据，可以使用时间刻度来表示分割点。在没有事例记录的时间点进行分割是没有意义的，因此分割点应当在式 (eq-tte-2) 表示的数据点中，使用 mcp=mncpm_\\mathrm{cp} = m_{n_\\mathrm{cp}}mcp​=mncp​​ 表示，则有：\n\\begin{equation}\\begin{split}\nN_1 &amp;= n_\\mathrm{cp} \\\\\nN_2 &amp;= N - N_1 \\\\\nM_1 &amp;= m_\\mathrm{cp} \\\\\nM_2 &amp;= M - M_1\n\\end{split}\\end{equation}\n\n设 mcpm_\\mathrm{cp}mcp​ 的先验分布为：\n\\begin{align}\nP(m_\\mathrm{cp}|\\mathscr{M}_2) = \\begin{cases}\n\\frac{1}{N}, m_\\mathrm{cp}\\in D_\\mathrm{TTE} \\\\\n0, \\mathrm{otherwise}\n\\end{cases}\n\\end{align}\n\n则似然函数可以表示为：\n\\begin{align}\n\\psi(n_\\mathrm{cp}) &amp;= \\phi(N_1,M_1)\\phi(N_2,M_2)\\\\\n\\mathscr{L}(\\mathscr{M}_2|D) &amp;= \\frac{1}{N}\\sum\\limits_{n_\\mathrm{cp}=1}^N\\psi(n_\\mathrm{cp})\\Delta t_{n_\\mathrm{cp}}\n\\end{align}\n\neq-piecewise-psi\neq-piecewise-likelihood\n式 (eq-piecewise-likelihood) 前的常数 1N\\frac{1}{N}N1​ 可忽略，而 Δtncp\\Delta t_{n_\\mathrm{cp}}Δtncp​​ 是相邻两个事例间的时间间隔，一般而言是一个可忽略的小修正项。\n分块数目 ¶\n根据式 (eq-odds-ratio) 有：\n\\begin{align}\n\\mathscr{O}_{21} = \\frac{J(\\mathscr{M}_2|D)}{J(\\mathscr{M}_1|D)} = \\rho\\frac{\\mathscr{L}(\\mathscr{M}_2|D)}{\\mathscr{L}(\\mathscr{M}_1|D)}\n\\end{align}\n\n当先验概率比值 ρ=1\\rho=1ρ=1 时，该比值被称为贝叶斯因子（Bayes Factor，BF）。如果分段模型更占优，则由式 (eq-piecewise-psi) 计算最可能的分段点的位置，Λ\\LambdaΛ 的最可几取值可由式 (eq-tte-lambda-max-1)，(eq-tte-lambda-max-2)，(eq-bin-lambda-max)，(eq-tts-lambda-max) 确定。对于具有 NNN 个分割点的模型，可以逐一求解分割点位置，也可以使用迭代的方法进行近似计算。\n迭代方法对整体区间分为两段，如果 BF 更支持分段模型，则对分段后的子区间继续同样的过程，该方法得到的分段方案与直接计算得到的方案十分接近。结束条件可以是所有的子区间 BF 都更支持不分段模型，但是大量的数据显示绝大部分的 O21\\mathscr{O}_{21}O21​ 都比 1 大一点，因此会存在区间划分过细的问题。\n一个方法是设置子区间允许的最小事例数目以保持良好的统计性，当事例数目达到或小于这一设定值时不再进行分段；另一种方案是改变模型的先验概率值使其更倾向于不分段的模型，即调整 O21\\mathscr{O}_{21}O21​ 中 ρ\\rhoρ 的大小。\nDP 算法 ¶\n块评价函数 ¶\n块评价函数用于评价划分出的块的优劣，以此为基础解决分块的最优化问题。贝叶斯块算法要求块评价函数具有可加性（block-additive），即分组的整体评价是各个块的评价函数值之和。对于某个块评价函数 f(Bk)f(B_k)f(Bk​) 和某种分组 PPP，分组的整体评价为：\n\\begin{align}\nF(P)=\\sum\\limits_{k=1}^{N_\\mathrm{b}}f(B_k)\n\\end{align}\n\n其中 BkB_kBk​ ​代表第 kkk 个块，NbN_\\mathrm{b}Nb​ 为分组 PPP 中分块的数目。特定的分组方式被记为 PcpsP_\\mathrm{cps}Pcps​，P(k)P(k)P(k) 表示前 kkk 个数据点的分组方式。贝叶斯块算法的目标是选取恰当的分组方式，使得整体评价最优，可以表示为：\n\\begin{align}\n\\max\\limits_{\\mathrm{cps}}F(P_\\mathrm{cps})\n\\end{align}\n\n实现步骤 ¶\n假设 Popt(k)P_\\mathrm{opt}(k)Popt​(k) 为前 kkk 个点的最佳分组，根据 Popt(k+1)P_\\mathrm{opt}(k+1)Popt​(k+1) 的定义，其最后一个块的右边界一定为第 k+1k+1k+1 个点。定义 rrr 满足 Popt(k+1)P_\\mathrm{opt}(k+1)Popt​(k+1) 的最后一个块的左边界为第 rrr 个点，则 rrr 共有 k+1k+1k+1 种可能，即 1,2,…,k+11,2,\\dots,k+11,2,…,k+1，最后一个块的评价表示为 f(r)f(r)f(r)。\n可以证明对于所有以 rrr 为最后一个块的左边界的 P(k+1)P(k+1)P(k+1) 分组的集合，仅有 Popt(r−1)P_\\mathrm{opt}(r-1)Popt​(r−1) 与这最后一个块组成的方案才可能为最佳分组：\n\\begin{align}\nF[P_\\mathrm{cps}(r-1)] &amp;\\le F[P_\\mathrm{opt}(r-1)] \\nonumber \\\\\nF[P_\\mathrm{cps}(r-1)] + f(r) &amp;\\le F[P_\\mathrm{opt}(r-1)] + f(r)\n\\end{align}\n\n由于块评价函数具有可加性，因此:\n\\begin{equation}\\begin{split}\nF[P^r(k+1)] = f(r) + \\begin{cases}\n0 &amp;; r=1\\cr\nF[P_\\mathrm{opt}(r-1)] &amp;; r=2,3,...,R+1\n\\end{cases}\n\\end{split}\\end{equation}\n\n​当 r=1r=1r=1 时，所有数据点都在同一个块中，不存在 r−1r-1r−1 对应的块评价函数。遍历 k+1k+1k+1 种 rrr 的取值可能，然后取 roptr_\\mathrm{opt}ropt​ 满足：\n\\begin{align}\nr_\\mathrm{opt}=\\mathop{\\mathrm{argmax}}\\limits_{r}F[P^r(k+1)]\n\\end{align}\n\n结合 Popt(ropt−1)P_\\mathrm{opt}(r_\\mathrm{opt}-1)Popt​(ropt​−1) 可得 Popt(k+1)P_\\mathrm{opt}(k+1)Popt​(k+1)，进而得到 Popt(k),k=1,2,…,NP_\\mathrm{opt}(k), k=1,2,\\dots,NPopt​(k),k=1,2,…,N，最优的分组方案即 Popt(N)P_\\mathrm{opt}(N)Popt​(N)。\n分块数目 ¶\nNbN_\\mathrm{b}Nb​ 的先验分布，如：\n\\begin{align}\nP(N_\\mathrm{b}) = P_0\\gamma^{N_\\mathrm{b}}\n\\end{align}\n\n其中 0≤Nb≤N0 \\le N_\\mathrm{b} \\le N0≤Nb​≤N，0≤γ≤10 \\le \\gamma \\le 10≤γ≤1 是唯一的参数，P0P_0P0​ 和 Nb‾\\overline{N_\\mathrm{b}}Nb​​ 可以计算得出：\n\\begin{align}\nP_0 &amp;= \\frac{1 - \\gamma}{1 - \\gamma^{N+1}} \\\\\n\\overline{N_\\mathrm{b}} &amp;= \\frac{N\\gamma^{N+1}+1}{\\gamma^{N+1}-1}+\\frac{1}{1-\\gamma}\n\\end{align}\n\n定义误报率 p1p_1p1​ 为，正确率 p0p_0p0​ 为：\n\\begin{align}\np_0 \\equiv 1 - p_1\n\\end{align}\n\n未完待续\n\n参考资料 ¶\n\nScargle J D. Studies in astronomical time series analysis. V. Bayesian blocks, a new method to analyze structure in photon counting data[J]. The Astrophysical Journal, 1998, 504(1): 405.\nScargle J D, Norris J P, Jackson B, et al. Studies in astronomical time series analysis. VI. Bayesian Block representations[J]. The Astrophysical Journal, 2013, 764(2): 167.\nbayesian_blocks\n\n","categories":["核物理","统计基础"],"tags":["Python","核技术","贝叶斯分析"]},{"title":"使用 wine 安装 SRIM","url":"/posts/202310-wine-srim.html","content":"前言 ¶\nSRIM 是一个 Windows 平台上用于计算带电粒子能损的软件包，典型的应用包括计算入射离子在靶材中的射程和 dE/dxdE/dxdE/dx 能损曲线等。由于这是一个单字节程序，因此在中文系统中会存在显示问题，可以通过更改系统的区域和语言为美国 / 英语重启之后解决 [2]，但是会很麻烦，而且可能导致其他软件出现问题（例如部分软件可能读取到错误的区域），如下图所示。\n错误显示的 SRIM\n为了解决这个问题，我们可以选择在 WSL 上安装 wine，通过 wine 来调用 SRIM。请注意，此处需要 WSL 更新到最新版本以支持 WSLG。\n本机环境\nWSL: 1.2.5.0\nWSLg: 1.0.51\nUbuntu: 20.04.6\nwine: 8.0.2\n\nwine¶\nwine 目前最新稳定版本更新至 8.0.2，但是 ubuntu 自带的软件源中仍为 5.0 版本。可以根据需要自行选择安装版本。\nwine 5.0¶\n\n 更新与安装 wine。\n\nsudo apt update &amp;&amp; sudo apt install wine -y\n\n检查 wine32 是否安装，如果没有则另外安装。\n\nsudo dpkg --add-architecture i386sudo apt update &amp;&amp; sudo apt install wine32 -y\n\n配置 Windows 10 环境。\n\nwinecfg\nwine 配置\nwine 8.0¶\nubuntu 提供的 wine 已经落后了好几个版本，所以可以通过 WineHQ 自己的储存库安装较新版本的 wine。WineHQ 存储库仅提供适用于 AMD64 和 i386 的软件包，如果需要 ARM 版本，可以使用 Ubuntu 软件包。[4]\n\n开启 32 位支持。\n\nsudo dpkg --add-architecture i386 \n\n下载并添加仓库密钥，随后添加仓库并更新。[5]\n\nsudo wget -nc -O /usr/share/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.keysudo suecho \"deb [arch=amd64,i386 signed-by=/usr/share/keyrings/winehq-archive.key] https://mirrors.tuna.tsinghua.edu.cn/wine-builds/ubuntu/ focal main\" &gt;&gt; /etc/apt/sources.list.d/winehq.listexitsudo apt update\n\n安装 wine 8.0。\n\n# Stablesudo apt install --install-recommends winehq-stable# Developsudo apt install --install-recommends winehq-devel\n\n按照 5.0 中的设置选择 Windows 10。\n\nwinecfg\nSRIM¶\nSRIM 2008 与 2013¶\n直接安装 SRIM 2013 会提示组件缺失，而按照官方教程去安装组件较为繁琐，而且可能失败。因此一个取巧的方法是先安装 SRIM 2008，这一版本的 SRIM 附带有自动安装程序，完成后卸载 2008 版本并保留相关组件，随后再安装 SRIM 2013。两个版本的下载地址如下：\n\nSRIM 2008\nSRIM 2013\n\n下载完成之后，我们需要将其后缀名从 e 改为 exe，方便后续操作。\nSRIM 2008 的安装 ¶\n\n 创建临时目录，下载安装包并运行命令提取安装包中的文件到目录中。\n\nmkdir srim08 &amp;&amp; cd ~/srim08wget http://www.srim.org/SRIM/SRIM-2008.emv SRIM-2008.e SRIM-2008.exewine SRIM-2008.exe\n提取 SRIM-2008 文件\n\n运行 SETUP.exe 进行安装，安装位置可以随意填写，例如 ~/.wine/drive_c/Program\\ Files/SRIM。如果提示图标安装失败，选择 Ignore 即可。\n\nwine SETUP.exe\n设置安装路径\n忽略错误\n\n检查组件是否安装到位，在 ~/.wine/drive_c/windows/syswow64 目录中应当存在 4 个 OCX 文件。\n\n~/srim08 ❯ ls ~/.wine/drive_c/windows/syswow64 | rg OCX.rw-r--r--   594Ki fox  fox   23 May  2000  COMCTL32.OCX.rw-r--r--   137Ki fox  fox   23 May  2000  COMDLG32.OCX.rw-r--r--   207Ki fox  fox   10 Mar  2004  RICHTX32.OCX.rw-r--r--   204Ki fox  fox   31 Aug  2001  TABCTL32.OCX\n\n卸载 SRIM 2008。运行命令打开管理器，选中 SRIM 进行卸载。\n\nwine uninstaller\n移除 SRIM 2008\n保留组件\nSRIM 2013 的安装与配置 ¶\n\n 创建临时目录，下载安装包并运行命令提取安装包中的文件到目录中。\n\nmkdir srim13 &amp;&amp; cd ~/srim13wget http://www.srim.org/SRIM/SRIM-2013-Std.emv SRIM-2013-Std.e SRIM-2013-Std.exewine SRIM-2013-Std.exe\n\n测试能否正常运行。\n\nwine SRIM.exe\nSRIM 2013\n\n在 .zshrc （或者 .bashrc） 中添加指令。\n\nalias srim=\"wine ~/srim13/SRIM.exe\"\n问题 ¶\n\n 提示 sh: 1: xdg-open: not found，安装 xdg-utils [6]\n\nsudo apt-get install xdg-utils\n参考资料 ¶\n\nLinux 虚拟机用 wine 安装仿真软件 SRIM\n【离子注入】TRIM2013pro 仿真卡屏解决方法（win10）\nSRIM - wineHQ\nUbuntu - wineHQ\nWine builds 软件仓库镜像使用帮助\nIn Ubuntu, xdg-open command is not working\n\n\n","categories":["核物理","工具软件"],"tags":["教程","核技术","SRIM"]},{"title":"Hexo 配置 Typst 代码高亮","url":"/posts/202402-typst-block.html","content":"Hexo 处理的代码块会被包裹在 figure table tbody tr &gt; td.code pre 中，每一行代码又被 span 包裹，如果需要加入对 Typst 的支持，需要将所有的代码重新提取出来，处理后之后再填入，有两种方法可以选择：\n\n前端修改：在 html 页面中读取代码块元素，提取代码处理后再填入 (1)\n标签插件（推荐）：在 hexo 生成的过程中使用标签插件 (2) 处理\n\n前端修改 ¶\n此方法可能需要刷新才能正常显示\n此方法会将所有的 plaintext 识别为 typst，可以通过在第一行加一行说明语言来处理\n\n引入js文件 ¶\n&lt;script crossorigin=\"anonymous\" src=\"https://www.foolishfox.cn/js/hl.js\"&gt;&lt;/script&gt;&lt;script  id=\"script-main\"  src=\"https://cdn.jsdelivr.net/npm/@myriaddreamin/highlighter-typst/dist/cjs/contrib/hljs/typst.bundle.js\"&gt;&lt;/script&gt;\n注册 Typst¶\nconst run = () =&gt; {    $typst$parserModule.then(() =&gt; {        hljs.registerLanguage(            'typst',            window.hljsTypst({                codeBlockDefaultLanguage: 'typst',            }),        );        hljs.configure({            classPrefix: '' // don't append class prefix        });    }).then(() =&gt; {        document.querySelectorAll('figure table tbody tr &gt; td.code pre').forEach(el =&gt; {            if (!el.getAttribute('data-highlighted')) {                var pre = document.createElement(\"pre\");                var lang = el.parentNode.parentNode.parentNode.parentNode.parentNode.classList[1];                var code = \"\";                for (i = 0; i &lt; el.childElementCount; i++){                    ch = el.children[i];                    if (ch.tagName == \"SPAN\") code += ch.textContent;                    if (ch.tagName == \"BR\") code += \"\\n\";                }                if (lang == \"plaintext\") {                    lang = \"typst\";                }                if (lang != \"plaintext\") {                    el.innerHTML = hljs.highlight(code, {language: lang}).value                }            }        });    });}run();\n标签插件 ¶\n文件下载：\n\ntypst.js  修改自 (4)\ntypst.bundle.js  修改自 (3)\n下载后放置在 Hexo 根目录下的 scripts 目录中\n\n\n查看 Hexo 原生处理代码块的逻辑 (4)：\nregisterplugins/tag/index.tsconst code = require('./code')(ctx);tag.register('code', code, true);tag.register('codeblock', code, true);\n在 code 模块中，先对传入的参数进行了解析，然后再调用 hexo-utils 的 highlight 进行渲染：\ncodeplugins/tag/code.tsfunction parseArgs(args: string[]): HighlightOptions {  ......  return {    lang,    language_attr,    firstLine,    caption,    line_number,    line_threshold,    mark,    wrap  };}module.exports = ctx =&gt; function codeTag(args, content) {    ......    const options = parseArgs(args);    options.lines_length = content.split('\\n').length;    content = ctx.extend.highlight.exec(ctx.config.syntax_highlighter, {        context: ctx,        args: [content, options]    });    return content.replace(/{/g, '&amp;#123;').replace(/}/g, '&amp;#125;');};\n所以我们可以在返回 content 之前对其进行处理，处理的逻辑与前一种方法是类似的，首先导入所需要的模块：\nimporttypst.jsconst hljs = require('highlight.js');const highlight = require('hexo-util').highlight;const typstBunlde = require('./typst.bundle');\n然后获取 highlight 处理过后的代码块：\nhighlight processtypst.jsconst codeTypst = (args, content) =&gt; {    const options = parseArgs(args);    options.lines_length = content.split('\\n').length;    const line_threshold = options.line_threshold || 0;    const shouldUseLineNumbers = options.line_number;    const surpassesLineThreshold = options.lines_length &gt; line_threshold;    const gutter = shouldUseLineNumbers &amp;&amp; surpassesLineThreshold;    const hljsOptions = {        caption: options.caption,        firstLine: options.firstLine,        gutter,        mark: options.mark,    };    var contentHljs = highlight(content, hljsOptions);    contentHljs = contentHljs.replace(/{/g, '&amp;#123;').replace(/}/g, '&amp;#125;');    ......}\n然后注册 Typst 语言，并提取代码进行处理：\nextract and processtypst.jsconst codeTypst = (args, content) =&gt; {    ......    return typstBunlde.parserModule.then(() =&gt; {        hljs.registerLanguage(            'typst',            typstBunlde.hljsTypst({                codeBlockDefaultLanguage: 'typst',            }),        )    }).then(() =&gt; {        var re = /&lt;td class=\"code\"&gt;&lt;pre&gt;(.+)&lt;\\/pre&gt;&lt;\\/td&gt;/i;        var code = hljs.highlight(content, {language: 'typst'}).value;        contentHljs = contentHljs.replace(\"highlight plaintext\", \"highlight typst\")        return contentHljs.replace(re, `&lt;td class=\"code\"&gt;&lt;pre&gt;${code}&lt;/pre&gt;&lt;/td&gt;`);    });}\n最后在 Hexo 中注册这个标签插件，由于注册 Typst 语言并处理的过程是异步的，所以这里也要开启异步选项：\nregister with asynctypst.jshexo.extend.tag.register('typst', codeTypst, {ends: true, async: true});\n示例 ¶\n使用方法 ¶\n/** * Typst Code block tag * Syntax: * {% typst [options] %} * code snippet * {% endtypst %} * @param {String} title Caption text * @param {String} url Source link * @param {String} link_text Text of the link * @param {Object} line_number Show line number, value must be a boolean * @param {Object} first_line Specify the first line number, value must be a number * @param {Object} mark Line highlight specific line(s), each value separated by a comma. Specify number range using a dash * Example: `mark:1,4-7,10` will mark line 1, 4 to 7 and 10. * @returns {String} Code snippet with code highlighting*/\n预览 ¶\n{% typst %}#import \"@preview/tablex:0.0.6\": tablex, rowspanx, colspanx, hlinex, vlinex#let three-line-table(columns, headers, contents, caption, lang: \"en\",rows: auto) = {figure(  tablex(    columns: columns,    rows: rows,    align: center + horizon,    auto-lines: false,    repeat-header: true,    hlinex(stroke: 1.5pt),    ..headers,    hlinex(stroke: 0.75pt),    ..contents,    hlinex(stroke: 1.5pt),  ),  kind: table,  supplement: [#if (lang == \"en\") {\"Table\"} else {\"表\"}],  caption: caption,)}{% endtypst %}\n#import \"@preview/tablex:0.0.6\": tablex, rowspanx, colspanx, hlinex, vlinex\n\n#let three-line-table(columns, headers, contents, caption, lang: \"en\",rows: auto) = {figure(\n  tablex(\n    columns: columns,\n    rows: rows,\n    align: center + horizon,\n    auto-lines: false,\n    repeat-header: true,\n    hlinex(stroke: 1.5pt),\n    ..headers,\n    hlinex(stroke: 0.75pt),\n    ..contents,\n    hlinex(stroke: 1.5pt),\n  ),\n  kind: table,\n  supplement: [#if (lang == \"en\") {\"Table\"} else {\"表\"}],\n  caption: caption,\n)}\n参考资料 ¶\n\n在 Hugo 中为 Typst 配置语法高亮（PaperMod 主题）\n标签插件（Tag）\nhighlighter\n代码高亮\n\n","categories":["技术笔记"],"tags":["教程","typst"]},{"title":"排版工具 Typst 教程与 Snippets","url":"/posts/202401-typst.html","content":"个人的自用模板代码可以查看 Typst-Snippets\n\nTypst 是 2019 年才出现的使用 Rust 编写的基于标记的排版语言，定位在 Markdown、Word 等初级工具和 LaTeX\\LaTeXLATE​X 一类的高级工具之间，官方宣称其功能可以和 LaTeX\\LaTeXLATE​X 一样强大，但是和 Markdown 一样简单、易用，主要应用于数学、物理和工程方面（特别是包含大量公式、图表）的论文、文章、作业、书籍和报告的编写。\n基础教程 ¶\nMacOS 和 Arch Linux 用户可以使用包管理器进行安装：\n# macOS or Linux using Homebrewbrew install typst# Arch Linuxpacman -S typst\n具体支持的发行版本可以查看 参考资料 (5)。Ubuntu 目前还只能下载编译好的二进制文件，或者安装 Rust 后从源码编译进行安装。除此之外，还需要安装编辑器的插件实现代码提示、预览等功能，VS Code 上的主要插件有：\n\nTypst LSP\nTypst Preview\n\n除此之外，还有 Typst Sympy Calculator 插件实现了和 Python 的 SymPy 库的联动，可以进行公式的转化和计算。\n对于从 LaTeX\\LaTeXLATE​X 和 Markdown 迁移过来的用户，绝大部分语法内容都可以新学习，比较重要的区别有：\n\n公式中命令不需要 \\ 开头，直接使用即可，例如使用 $e^(pi eta)$ 显示 eπηe^{\\pi\\eta}eπη，要在公式中显示成段的，不是命令的字符，可以使用 \" 包裹起来。更具体而言，Typst 区分两种模式：「标记模式」和「代码模式」，前者是正常的文本模式，类似于 Markdown 的编写逻辑，后者以 # 开头，在该模式内的命令省略 #（个人认为，公式是一种特殊的代码模式，命令在公式中也可以省略 #）\n函数定义要求函数名 + 括号，参数可以是位置参数或者命名参数，格式为 myfunc(keya: valuea, keyb: valueb)\nTypst 的代码模式十分强大，通过 #if 条件判断和 #for 循环语句，可以实现 参考资料 (7) 中的效果：\n\n\nyour browser does not support the video tag\n具体的内容可以查看 参考资料 (3)，入门的教程可以查看 参考资料 (2)，一些 Typst、Markdown 和 LaTeX\\LaTeXLATE​X 之间的对比可以查看 参考资料 (7)\n常用代码 ¶\n官方模组 ¶\n目前官方收录的模组可以在 Typst Packages 进行查询，此外还有 Awesome Typst 项目收录了很多实用了模组，下面列举了部分常用的模组，一些我进行了自定义的模组将会在 (下一小节) 进行介绍。\n\nPinit 包用于创建批注，在制作 slides 的时候特别有用，效果如下：\n\nPinit\n\nPhysics 实现了向量、场、微分、导数、狄拉克符号等物理中常用符合的定义：\n\nPhysics\n\nShowybox 可以创建自定义的彩色盒，可以用于定义、定理等场景：\n\nShowybox\n\nTablex 实现了高级的表格：\n\nTablex\n\nTypst orange template 使用 Typst 实现了 Legrand Orange Book：\n\nTypst orange template\n\ni-figured 实现了图表、公式的按章节编号，参见 (论文)\n\n自定义模板 ¶\n幻灯片 ¶\nAwesome Typst 中推荐的幻灯片模板中，个人推荐使用 Polylux 模板，提供了多种主题，目前我常用的是 [University] 主题，并进行了一定的修改。\n封面\n目录\n分栏\n\n给分栏页加入页眉和页脚\n\n#let matrix-slide(\n  title: none,\n  new-section: none,\n  columns: none,\n  rows: none,\n  ..bodies\n) = {\n  let header = {\n    set align(top)\n    grid(rows: (auto, auto), row-gutter: 3mm, progress-barline, header-text(title: title, new-section: new-section))\n  }\n\n  let footer = {\n    set text(size: 10pt)\n    set align(center + bottom)\n    let cell(fill: none, it) = rect(\n      width: 100%, height: 100%, inset: 1mm, outset: 0mm, fill: fill, stroke: none,\n      align(horizon, text(fill: white, it))\n    )\n    locate( loc =&gt; {\n      let colors = uni.uni-colors.at(loc)\n\n      show: block.with(width: 100%, height: auto, fill: colors.b)\n      grid(\n        columns: (25%, 1fr, 15%, 10%),\n        rows: (1.5em, auto),\n        cell(fill: colors.a, uni.uni-short-author.display()),\n        cell(uni.uni-short-title.display()),\n        cell(uni.uni-short-date.display()),\n        cell(logic.logical-slide.display() + [~/~] + utils.last-slide-number)\n      )\n    })\n  }\n\n  set page(\n    margin: ( top: 2em, bottom: 1em, x: 0em ),\n    header: header,\n    footer: footer,\n    footer-descent: 0em,\n    header-ascent: .6em,\n  )\n\n  uni.matrix-slide(..bodies)\n}\n\n添加目录页\n\n#let slide-outline-length(loc) = {\n  let section-state = state(\"polylux-sections\", ())\n  let sections = section-state.final(loc)\n  sections.len() - 1\n}\n\n#let slide-outline(num) = {\n  set text(font: \"Cascadia Mono\")\n  locate(loc =&gt; {\n    let section-state = state(\"polylux-sections\", ())\n    let sections = section-state.final(loc)\n    for p in range(0, num) {\n      let section = sections.at(p)\n      let content = {\n        let url = link(section.loc, section.body)\n        let page = logic.logical-slide.at(section.loc).at(0)\n        let length = 46 - str(page).len() - count-length(section.body)\n        let dots = \" \" + \".\" * length\n        [#grid(\n          columns: (auto, 1fr, 1fr),\n          url, align[#dots], align(right)[#page]\n        )]\n      }\n      [+ #content ]\n    }\n  })\n}\n论文 ¶\nLaPreprint\nLaPreprint 是一个很美观的预印本模板，主要适用于英文，为了适应一些中文的需求，个人做出了一些修改：\n\n增加目录与语言选项\n\n#let lapreprint(\n  // ......\n  // The outline\n  outline-show: true,\n  outline-depth: 2,\n  // Language of the document\n  lang: \"en\",\n  // The paper's content.\n  body\n) = {\n  // ......\n  if (outline-show) {outline(\n    title: if (lang == \"en\") {\"Content\"} else {\"目录\"},\n    indent: 2em,\n    depth: outline-depth,\n  )}\n  // ......\n}\n\n修改页边距\n\n// 首页 &amp; 目录页\n#lapreprint(\n  set page(\n    paper-size,\n    margin: (left: 20%, bottom: 1.5cm),\n  )\n)\n\n// 后续页\n#lapreprint(\n  set page(\n    paper-size,\n    margin: (left: auto, bottom: 1.5cm),\n  )\n)\n\n中文显示\n\n#lapreprint(\n  set page(\n    // ......\n    footer: block(\n      // ......\n                if(date != none) {\n                  if (lang == \"en\") {\n                    date.display(\"[month repr:short] [day], [year]\")\n                  } else {\n                    [#date.year() 年 #date.month() 月 #date.day() 日]\n                  }\n                }\n      // ......\n    )\n  )\n\n  // ......\n  place(\n    // ......\n              if (lang == \"en\") {\n                text(size: 7pt, d.date.display(\"[month repr:short] [day], [year]\"))\n              } else {[\n                #set text(7pt)\n                #d.date.year()-#d.date.month()-#d.date.day()\n              ]}\n    // ......\n  )\n\n  // ......\n  if abstracts != none {\n    // ......\n        if (lang == \"en\") {\n          text(fill: theme, weight: \"semibold\", \"Keywords\")\n        } else {\n          text(fill: theme, weight: \"semibold\", \"关键词\")\n        }\n    // ......\n  }\n)\n\n图表、公式编号，按章节区分\n\n#lapreprint(\n  // Configure i-figured\n  show figure: i-figured.show-figure\n  show figure.where(\n    kind: table\n  ): set figure.caption(position: top)\n  show math.equation: i-figured.show-equation\n)\n\n交叉引用\n\n#lapreprint(\n  // Configure Reference Link\n  show link: it =&gt; [#text(fill: theme)[#it]]\n  show ref: it =&gt; [#text(fill: theme)[#it]]\n  show ref: it =&gt; {\n    let el = it.element\n    if (el != none) {\n      let fn = repr(el.func())\n      if (fn == \"equation\") {link(\n        it.target,\n        if (lang == \"en\") {\"Eq.\"} else {\"式 \"} + \n        numbering(\n          el.numbering,\n          ..counter(math.equation).at(el.location())\n        )\n      )} else if (fn == \"heading\") {link(\n        it.target,\n        if (lang == \"en\") {\"Section \"} else {\"第 \"} + \n        numbering(\n          el.numbering,\n          ..counter(heading).at(el.location())\n        ) + if (lang == \"zh\") {\" 节\"}\n      )}\n      else { it }\n    } else {it}\n  }\n)\n其他 ¶\n\n 借助 Tablex 可以实现三线表的样式：\n\n// 定义\n#import \"@preview/tablex:0.0.6\": tablex, rowspanx, colspanx, hlinex, vlinex\n\n#let three-line-table(columns, headers, contents, caption, lang: \"en\",rows: auto) = {figure(\n  tablex(\n    columns: columns,\n    rows: rows,\n    align: center + horizon,\n    auto-lines: false,\n    repeat-header: true,\n    hlinex(stroke: 1.5pt),\n    ..headers,\n    hlinex(stroke: 0.75pt),\n    ..contents,\n    hlinex(stroke: 1.5pt),\n  ),\n  kind: table,\n  supplement: [#if (lang == \"en\") {\"Table\"} else {\"表\"}],\n  caption: caption,\n)}\n\n// 使用\n#three-line-table(\n  2,\n  ([*参数*], [*结果*]),\n  (\n    [$sin^2(2 theta_(12))$], [$0.857 pm 0.024$],\n    [$sin^2(2 theta_(23))$], [$&gt; 0.95$],\n    [$sin^2(2 theta_(13))$], [$0.098 pm 0.013$],\n    [$Delta\\m_(12)^2$], [$(7.50 pm 0.20) times 10^(-5) \"eV\"^2$],\n    [$Delta\\m_(23)^2$], [$0.00232_(-0.00008)^(+0.00012) \"eV\"^2$],\n    [$delta\\/pi$], [$1.35_(-0.43)^(+0.64)$]\n  ),\n  [中微子振荡参数测量结果#super[@zqw2015daya @zym2018daya]],\n  lang: \"zh\",\n) &lt;nu_para&gt;\n三线表\n\n公式块\n\n#let box-quote(body, width: 100%, inset: 5pt, outset: 0pt) = {block(\n  fill: green.lighten(80%),\n  width: width,\n  inset: inset,\n  outset: outset,\n  radius: 4pt,\n  stroke: green.darken(60%),\n  breakable: true,\n  body\n)}\n\n// 使用\n#box-quote[$\nP_(nu_alpha -&gt; nu_beta) approx sin^(2)2theta sin^(2)((m_1^2-m_2^2)/(4p)t) approx sin^(2)2theta sin^(2)(Delta\\m^2 L/(4E))\n$ &lt;2flavor_mix_4&gt;]\n公式块\n\n数学符号的简易别名\n\n#import \"@preview/physica:0.9.0\" as ph\n#let sp = [#h(0.5em)]\n#let pm = [#sym.plus.minus]\n#let le = [#sym.lt.eq.slant]\n#let ge = [#sym.gt.eq.slant]\n#let sim = [#sym.tilde.op]\n#let inf = [#sym.infinity]\n#let rm(body) = {math.upright(body)}\n#let iso(b, A) = [#ph.isotope(b, a: A)]\n#let isoz(b, A, Z) = [#ph.isotope(b, a: A, z: Z)]\n\n// 使用\n#box-quote[$\n1 pm 2 le 3 ge 4 sim 5 inf 6 sp rm(A\\b) sp 7 sp \"Ab\" 8 sp iso(U, 235) sp 9 sp isoz(L\\i, 7, 3)\n$]\n数学符号\n参考资料 ¶\n\nTypst\nDocumentation\n为 LaTeX 用户准备的 Typst 入门\nTypst Tablex 简单教程\nTypst on Repology\n中文用户指南\nTypst-\"超越\" LaTeX 的文档排版工具\nTypst Examples Book\n\n","categories":["技术笔记"],"tags":["教程","typst"]},{"title":"微信聊天记录分析：去年和你的猪聊了什么？","url":"/posts/202402-WeChatMsgAnalysis.html","content":"评论不填写邮箱，将收不到回复通知\n\n多图预警\n\nipynb文件最好从上往下依次运行，不要回过头来重新搞，获取方式：\n\n在 Google Colab 使用在线环境运行（推荐）\n下载 ipynb 文件 直接运行\n下载 运行所需文件\n\n\n准备 ¶\n导出聊天记录 ¶\n依照 WeChatMsg 的教程导出 csv 文件，只需要导出文本即可。\n图 1 导出聊天记录\n安装所需包 ¶\n推荐在虚拟环境中安装。\npip install numpy seaborn pandas wordcloud tqdm paddlepaddle paddlenlp\n引入包 ¶\n\npandas: 基础数据框架\nmatplotlib &amp; seaborn: 绘图\njieba: 中文分词\nwordcloud: 词云\npaddlenlp: 情感分析\n\nimport reimport timeimport numpy as npimport pandas as pdimport jiebaimport jieba.posseg as psegfrom PIL import Imagefrom wordcloud import WordCloudimport seaborn as snsimport matplotlib.ticker as mtickerimport matplotlib.transforms as mtransformsfrom matplotlib.colors import ListedColormapfrom matplotlib import pyplot as pltfrom matplotlib import font_manager as fmfrom tqdm import tqdmfrom paddlenlp import Taskflow\n绘图设置 ¶\n\nfont: 字体路径，至少支持中文，最好同时支持中文和 emoji\n\nsns.set_theme(style=\"ticks\")font = \"/usr/share/fonts/winfont/simsun.ttc\"fp = fm.FontProperties(fname=font)plt.rcParams[\"axes.unicode_minus\"] = False\n人名标签 ¶\n在这里修改双方的称呼：\nlabels = [\"LL\", \"FF\"]\n数据读取 ¶\n\nfilePath: 消息记录文件的路径\ndStart: 开始的时间\ndEnd: 结束的时间\n\nfilePath = \"msg.csv\"dStart = \"2023-01-01 00:00:00\"dEnd = \"2023-12-31 23:59:59\"df = pd.read_csv(filePath, encoding=\"utf-8\")df = df.query(    \"CreateTime &gt;= {:d} and CreateTime &lt;= {:d}\".format(        int(time.mktime(time.strptime(dStart, \"%Y-%m-%d %H:%M:%S\"))),        int(time.mktime(time.strptime(dEnd, \"%Y-%m-%d %H:%M:%S\"))),    ))df.loc[:, \"StrTime\"] = pd.to_datetime(df[\"StrTime\"])df.loc[:, \"day\"] = df[\"StrTime\"].dt.dayofweekdf.loc[:, \"hour\"] = df[\"StrTime\"].dt.hourdf.loc[:, \"Count\"] = 1# 如果出错就用df[\"StrTime\"] = pd.to_datetime(df[\"StrTime\"])df[\"day\"] = df[\"StrTime\"].dt.dayofweekdf[\"hour\"] = df[\"StrTime\"].dt.hourdf[\"Count\"] = 1dfs = [df.query(\"IsSender == 0\"), df.query(\"IsSender == 1\")]\n消息过滤 ¶\ndef textFilter(text: str):    text = text.lower()    # 过滤 emoji    try:        co = re.compile(\"[\\U00010000-\\U0010ffff]\")    except re.error:        co = re.compile(\"[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]\")    text = co.sub(\" \", text)    # 过滤微信表情    co = re.compile(\"\\[[\\u4e00-\\u9fa5]+\\]\")    return co.sub(\" \", text)texts = [    [textFilter(i) for i in dfs[0].query(\"Type == 1\")[\"StrContent\"].to_list()],    [textFilter(i) for i in dfs[1].query(\"Type == 1\")[\"StrContent\"].to_list()],]\n消息频率分析 ¶\n类型分析 ¶\n根据消息的类型进行分类，可以看出喜欢发送的消息类型，同时也可以看出谁发的多\n\n1 = Text\n3 = Image\n34 = Voice\n43 = Video\n47 = Sticker\n48 = Location\n10000 = System\n\ndata = {}for i in range(2):    data[labels[i]] = [        len(dfs[i].query(\"Type == 1\")),        len(dfs[i].query(\"Type == 3\")),        len(dfs[i].query(\"Type == 34\")),        len(dfs[i].query(\"Type == 43\")),        len(dfs[i].query(\"Type == 47\")),    ]data = (    pd.DataFrame(data, index=[\"Text\", \"Image\", \"Voice\", \"Video\", \"Sticker\"])    .reset_index()    .melt(\"index\")    .rename(columns={\"index\": \"Type\", \"variable\": \"Person\", \"value\": \"Count\"}))g = sns.catplot(data, kind=\"bar\", x=\"Type\", y=\"Count\", hue=\"Person\", palette=\"dark\", alpha=0.6, height=6)for ax in g.axes.ravel():    for i in range(2):        ax.bar_label(ax.containers[i], fontsize=9)sns.move_legend(g, \"upper right\")plt.yscale(\"log\")g.figure.set_size_inches(6, 5)g.figure.set_dpi(150)plt.show()plt.close()\n图 2 消息类型\n消息长度分析 ¶\n\nsN: 设置显示范围：\n\nμ+sN∗σ\\mu + \\mathrm{sN} * \\sigma\nμ+sN∗σ\n\nmultiple: 直方图堆叠格式\n\nsN = 3multiple = \"dodge\"mu, std = 0, 0data = {\"Length\": [], \"Person\": []}for i in range(2):    length = [len(textFilter(i)) for i in texts[i]]    data[\"Length\"] += length    data[\"Person\"] += [labels[i]] * len(length)    if np.mean(length) + sN * np.std(length) &gt; mu + std:        mu, std = np.mean(length), np.std(length)xlim = int(np.ceil(mu + sN * std))data = pd.DataFrame(data)bins = np.linspace(0, xlim, xlim + 1)ax = sns.histplot(    data=data,    x=\"Length\",    hue=\"Person\",    bins=bins,    multiple=multiple,    edgecolor=\".3\",    linewidth=0.5,    palette=\"dark\",    alpha=0.6,)ax.set_xlim(0, xlim)ax.set_xlabel(\"Length of Message\")ax.figure.set_size_inches(8, 4)ax.figure.set_dpi(150)plt.show()plt.close()\n图 3 消息长度\n每日活跃分析 ¶\n划分每日 24 小时内每小时发送的消息数，可以得知每天的活跃的时间段\ndata = {\"Time\": [], \"Person\": []}for i in range(2):    hour = dfs[i][\"hour\"].to_list()    data[\"Time\"] += hour    data[\"Person\"] += [labels[i]] * len(hour)data = pd.DataFrame(data)bins = np.arange(0, 25, 1)ax = sns.histplot(    data=data,    x=\"Time\",    hue=\"Person\",    bins=bins,    multiple=multiple,    edgecolor=\".3\",    linewidth=0.5,    palette=\"dark\",    alpha=0.6,)ax.set_xticks(bins)ax.set_xticklabels(bins)ax.set_xlabel(\"Hour\")ax.set_xlim(0, 24)sns.move_legend(ax, loc=\"upper center\", bbox_to_anchor=(0.5, 1.2), ncol=2)ax.figure.set_size_inches(8, 4)ax.figure.set_dpi(150)plt.show()plt.close()\n图 4 每日活跃时间\n每周活跃分析 ¶\n查看一周内从周一到周日每天发送的消息数\ngrouper = pd.Grouper(key=\"day\")data = df.groupby(grouper)[\"Count\"].sum()data = data.sort_index()data.index = [\"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\", \"Sun\"]ax = sns.barplot(data=data, errorbar=None)ax.set_xlabel(\"Weekday\")ax.bar_label(ax.containers[0], fontsize=10)ax.figure.set_size_inches(5, 5)ax.figure.set_dpi(150)plt.show()plt.close()\n图 5 每周活跃分析\n按周划分年度活跃分析 ¶\n划分每 7 天内发送的消息数，可以得知每周的活跃的时间段\n\nwTicks: 每个刻度相差的数值\n\n请注意此处修改：\n\nwStart: 当年或者聊天开始日期之后第一个周一的日期\nwEnd: 次年或者聊天结束日期之后第一个周一的日期\n\n\nwTicks = 500wStart = \"2023-01-02\"wEnd = \"2024-01-01\"grouper = pd.Grouper(key=\"StrTime\", freq=\"W-MON\")data = df.groupby(grouper)[\"Count\"].sum().to_frame()data.index = pd.date_range(start=wStart, end=wEnd, freq=\"W-MON\").strftime(\"%m-%d\")data.columns = [\"Count\"]vM = np.ceil(data[\"Count\"].max() / wTicks) * wTicksnorm = plt.Normalize(0, vM)sm = plt.cm.ScalarMappable(cmap=\"Reds\", norm=norm)ax = sns.barplot(x=data.index, y=data[\"Count\"], hue=data[\"Count\"], hue_norm=norm, palette=\"Reds\")ax.set_xlabel(\"Date\")plt.xticks(rotation=60)for bar in ax.containers:    ax.bar_label(bar, fontsize=10, fmt=\"%.0f\")ax.get_legend().remove()axpos = ax.get_position()caxpos = mtransforms.Bbox.from_extents(axpos.x1 + 0.02, axpos.y0, axpos.x1 + 0.03, axpos.y1)cax = ax.figure.add_axes(caxpos)locator = mticker.MultipleLocator(wTicks)formatter = mticker.StrMethodFormatter(\"{x:.0f}\")cax.figure.colorbar(sm, cax=cax, ticks=locator, format=formatter)ax.figure.set_size_inches(20, 8)ax.figure.set_dpi(150)plt.show()plt.close()\n图 5 按周划分年度活跃分析\n按周划分聊天热情分析 ¶\n划分每 7 天内的聊天热情指数，聊天热情指数为发送的消息数减去收到的消息数与总消息数的比值：\nE=QS−QRQS+QRE = \\frac{Q_\\mathrm{S} - Q_\\mathrm{R}}{Q_\\mathrm{S} + Q_\\mathrm{R}}\nE=QS​+QR​QS​−QR​​\ngrouper = pd.Grouper(key=\"StrTime\", freq=\"W-MON\")df_W1 = dfs[0].groupby(grouper)[\"Count\"].sum()df_W2 = dfs[1].groupby(grouper)[\"Count\"].sum()data = pd.DataFrame({\"E\": (df_W1 - df_W2) / (df_W1 + df_W2)})data.index = pd.date_range(start=wStart, end=wEnd, freq=\"W-MON\").strftime(\"%m-%d\")vM = data[\"E\"].abs().max()norm = plt.Normalize(-vM, vM)sm = plt.cm.ScalarMappable(cmap=\"coolwarm\", norm=norm)ax = sns.barplot(x=data.index, y=data[\"E\"], hue=data[\"E\"], hue_norm=norm, palette=\"coolwarm\")ax.set_xlabel(\"Date\")plt.xticks(rotation=60)ax.set_ylabel(\"Enthusiasm Index\")for bar in ax.containers:    ax.bar_label(bar, fontsize=10, fmt=\"%.2f\")ax.get_legend().remove()axpos = ax.get_position()caxpos = mtransforms.Bbox.from_extents(axpos.x1 + 0.02, axpos.y0, axpos.x1 + 0.03, axpos.y1)cax = ax.figure.add_axes(caxpos)locator = mticker.MultipleLocator(0.1)formatter = mticker.StrMethodFormatter(\"{x:.1f}\")cax.figure.colorbar(sm, cax=cax, ticks=locator, format=formatter)ax.figure.set_size_inches(20, 8)ax.figure.set_dpi(150)plt.show()plt.close()\n图 6 按周划分聊天热情分析\n按日划分年度活跃分析 ¶\n以热力图的方式展示按日划分的年度活跃情况\ngrouper = pd.Grouper(key=\"StrTime\", freq=\"D\")data = df.groupby(grouper)[\"Count\"].sum()data = data.to_frame()data[\"date\"] = data.indexdata[\"week\"] = data[\"date\"].dt.isocalendar()[\"week\"]data[\"day\"] = data[\"date\"].dt.dayofweekdata.index = range(len(data))for i in range(7):    if data.loc[i, \"week\"] &gt; 1:        data.loc[i, \"week\"] = 0data = data.pivot(index=\"day\", columns=\"week\", values=\"Count\")data.index = [\"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\", \"Sun\"]data.columns = pd.date_range(start=wStart, end=wEnd, freq=\"W-MON\").strftime(\"%m-%d\")ax = sns.heatmap(    data,    annot=False,    linewidths=0.5,    cbar_kws={\"orientation\": \"vertical\", \"location\": \"left\", \"pad\": 0.03},    cmap=\"Reds\",)ax.set_xlabel(\"Week\")ax.set_ylabel(\"Weekday\")ax.figure.set_size_inches(24, 4)ax.figure.set_dpi(150)plt.show()plt.close()\n图 7 按日划分年度活跃分析\n词语分析 ¶\n分词词典、停止词与去除词性 ¶\njieba.load_userdict(\"thuocl.txt\")jieba.load_userdict(\"userdict.txt\")stopwords = [line.strip() for line in open(\"stopwords.txt\", \"r\").readlines()] + [\" \", \"\\n\", \"\\r\\n\"]wordclass = [\"v\", \"u\", \"vd\", \"r\", \"p\", \"w\"]\n分词函数 ¶\ndef wordSplit(texts, wordclass):    words = []    pbar = tqdm(total=len(texts))    for i in range(len(texts)):        res = pseg.lcut(texts[i])        for pair in res:            if pair.word in stopwords:                continue            if pair.flag in wordclass:                continue            words.append(pair.word)        if i % 1000 == 0:            pbar.update(1000)    pbar.close()    return wordswords = [wordSplit(texts[i], wordclass) for i in range(2)]\n词云绘制 ¶\n\nmask: 词云的蒙版，影响词云的形状\ncmap: 色阶\n\nmask = np.array(Image.open(\"mask.png\"))masks = [np.array(Image.open(\"mask_L.jpg\")), np.array(Image.open(\"mask_F.jpg\"))]cmap = ListedColormap(    [        \"#fac1cf\",        \"#a9d7ba\",        \"#58b1db\",        \"#f296ab\",        \"#5dab81\",        \"#3d9ec4\",        \"#e16a8d\",        \"#237b50\",        \"#1e8299\",        \"#8d3549\",        \"#35563b\",        \"#2d5d73\",    ])def wordCloud(text, font, mask, cmap):    wc = WordCloud(        background_color=\"white\",        scale=5,        font_path=font,        mask=mask,        colormap=cmap,        collocations=False,    ).generate(text)    plt.imshow(wc)    plt.axis(\"off\")    plt.show()wordCloud(\" \".join(words[0] + words[1]), font, mask, cmap)\n图 8 词云图\n高频词排行 ¶\n列出常用的 N 个词，并且展示双方的贡献\n\nwN: 词的数目，默认为 50\n\nwN = 50data = pd.DataFrame(    {        \"words\": words[0] + words[1],        \"L\": [1] * len(words[0]) + [0] * len(words[1]),        \"F\": [0] * len(words[0]) + [1] * len(words[1]),        \"S\": [1] * len(words[0]) + [1] * len(words[1]),    })grouper = pd.Grouper(key=\"words\")data = data.groupby(grouper).sum()data = data.sort_values(by=\"S\", ascending=False)data = data.iloc[:wN]# 将部分无法识别的 emoji 转化为文字tmp = data.index.to_list()for i in range(wN):    if tmp[i] == \"😘\":        tmp[i] = \"[亲亲]\"    elif tmp[i] == \"😂\":        tmp[i] = \"[笑哭]\"    elif tmp[i] == \"🤦\":        tmp[i] = \"[捂脸]\"    elif tmp[i] == \"😁\":        tmp[i] = \"[呲牙]\"data.index = tmpratio = data[\"L\"] / data[\"S\"]norm = plt.Normalize(0, 1)sm = plt.cm.ScalarMappable(cmap=\"coolwarm\", norm=norm)fig = plt.figure(figsize=(10, 10), dpi=300)grid = plt.GridSpec(1, 4, wspace=0.5)ax0 = fig.add_subplot(grid[0, 0])sns.barplot(x=-data[\"L\"], y=data.index, ax=ax0, hue=ratio, hue_norm=norm, palette=\"coolwarm\")ax1 = fig.add_subplot(grid[0, 1:])sns.barplot(x=data[\"F\"], y=data.index, ax=ax1, hue=(1 - ratio), hue_norm=norm, palette=\"coolwarm\")ax0.set_xlabel(\"词频\")ax0.set_ylabel(\"\")ax0.set_xticks(range(-400, 1, 200))ax0.set_xticklabels([400, 200, 0])ax0.set_xlim(-400, 0)ax0.set_yticks([])ax0.spines[\"left\"].set_visible(False)ax0.spines[\"top\"].set_visible(False)ax0.spines[\"right\"].set_visible(False)ax0.set_title(\"LL\")ax0.get_legend().remove()ax1.set_xlabel(\"词频\")ax1.set_ylabel(\"\")ax1.set_xticks(range(0, 1201, 200))ax1.set_xticklabels([0, 200, 400, 600, 800, 1000, 1200])ax1.set_xlim(0, 1200)ax1.set_yticks([])ax1.spines[\"left\"].set_visible(False)ax1.spines[\"top\"].set_visible(False)ax1.spines[\"right\"].set_visible(False)ax1.set_title(\"FF\")ax1.get_legend().remove()axpos = ax1.get_position()caxpos = mtransforms.Bbox.from_extents(axpos.x0 + 0.06, axpos.y0 + 0.03, axpos.x1, axpos.y0 + 0.04)cax = ax1.figure.add_axes(caxpos)locator = mticker.MultipleLocator(0.1)formatter = mticker.StrMethodFormatter(\"{x:.1f}\")cax.figure.colorbar(sm, cax=cax, orientation=\"horizontal\", ticks=locator, format=formatter)cax.set_title(\"ratio\")x0 = ax0.get_position().x1x1 = ax1.get_position().x0xm = (x0 + x1) / 2y0 = ax0.get_position().y0y1 = ax0.get_position().y1for i in range(wN):    fig.text(        xm, y0 + (y1 - y0) * (wN - i - 0.5) / wN, data.index[i],        color=\"black\", ha=\"center\", va=\"center\", fontproperties=fp    )fig.set_dpi(150)plt.show()plt.close()\n图 9 高频词排行\n情感分析 ¶\n使用 paddlenlp 进行情感分析，得到的分数在 [-1, 1] 之间，越小越消极，越大越积极\ndfE = df.query(\"Type == 1\")[[\"IsSender\", \"StrContent\", \"StrTime\", \"hour\"]]dfE.index = range(len(dfE))senta = Taskflow(\"sentiment_analysis\")scores = pd.DataFrame(senta([textFilter(i) for i in dfE[\"StrContent\"].to_list()]))scores.loc[scores[\"label\"] == \"negative\", \"score\"] = 1 - scores.loc[scores[\"label\"] == \"negative\", \"score\"]dfE[\"score\"] = scores[\"score\"]dfE[\"score\"] = 2 * dfE[\"score\"] - 1dfE[\"Person\"] = dfE.apply(lambda x: labels[x[\"IsSender\"]], axis=1)dfEs = [dfE.query(\"IsSender == 0\"), dfE.query(\"IsSender == 1\")]\n年度总体情感分布 ¶\nax = sns.histplot(data=dfE, x=\"score\", hue=\"Person\", palette=\"dark\", alpha=0.6, bins=100)ax.set_xlabel(\"Sentiment Score\")ax.set_ylabel(\"Count\")ax.set_title(\"Sentiment Distribution\")ax.set_xlim(-1, 1)ax.figure.set_size_inches(8, 3)ax.figure.set_dpi(150)plt.show()\n图 10 年度总体情感分布\n按周统计平均情感指数 ¶\ndef weekAvgSenScore(df):    grouper = pd.Grouper(key=\"StrTime\", freq=\"W-MON\")    data = df.groupby(grouper)[\"score\"].mean().to_frame()    data.index = pd.date_range(start=wStart, end=wEnd, freq=\"W-MON\").strftime(\"%m-%d\")    data.columns = [\"score\"]    vM = data[\"score\"].abs().max()    norm = plt.Normalize(-vM, vM)    sm = plt.cm.ScalarMappable(cmap=\"coolwarm\", norm=norm)    ax = sns.barplot(x=data.index, y=data[\"score\"], hue=data[\"score\"], hue_norm=norm, palette=\"coolwarm\")    ax.set_xlabel(\"Date\")    plt.xticks(rotation=60)    for bar in ax.containers:        ax.bar_label(bar, fontsize=10, fmt=\"%.2f\")    ax.get_legend().remove()    axpos = ax.get_position()    caxpos = mtransforms.Bbox.from_extents(axpos.x1 + 0.02, axpos.y0, axpos.x1 + 0.03, axpos.y1)    cax = ax.figure.add_axes(caxpos)    locator = mticker.MultipleLocator(0.05)    formatter = mticker.StrMethodFormatter(\"{x:.2f}\")    cax.figure.colorbar(sm, cax=cax, ticks=locator, format=formatter)    ax.figure.set_size_inches(20, 8)    ax.figure.set_dpi(150)    plt.show()    plt.close()    return data[\"score\"]avgSenScore0 = weekAvgSenScore(dfEs[0])avgSenScore1 = weekAvgSenScore(dfEs[1])_ = weekAvgSenScore(dfE)\n图 11 按周统计平均情感指数\n平均情感指数变化折线图 ¶\nax = sns.lineplot(data=avgSenScore0, linewidth=3, marker=\"s\", markersize=15, label=labels[0])ax = sns.lineplot(data=avgSenScore1, linewidth=3, marker=\"^\", markersize=15, ax=ax, label=labels[1])ax.set_xlabel(\"Date\")plt.xticks(rotation=60)ax.set_ylabel(\"Average Sentiment Score\")ax.set_xlim(0, 52)ax.legend(prop={\"size\": 24})ax.figure.set_size_inches(20, 8)ax.figure.set_dpi(150)plt.show()plt.close()\n图 12 平均变化折线图\n按周统计累计情感指数 ¶\ndef weekTotSenScore(df):    grouper = pd.Grouper(key=\"StrTime\", freq=\"W-MON\")    data = df.groupby(grouper)[\"score\"].sum().to_frame()    data.index = pd.date_range(start=wStart, end=wEnd, freq=\"W-MON\").strftime(\"%m-%d\")    data.columns = [\"score\"]    vM = data[\"score\"].abs().max()    norm = plt.Normalize(-vM, vM)    sm = plt.cm.ScalarMappable(cmap=\"coolwarm\", norm=norm)    ax = sns.barplot(x=data.index, y=data[\"score\"], hue=data[\"score\"], hue_norm=norm, palette=\"coolwarm\")    ax.set_xlabel(\"Date\")    plt.xticks(rotation=60)    for bar in ax.containers:        ax.bar_label(bar, fontsize=10, fmt=\"%.2f\")    ax.get_legend().remove()    axpos = ax.get_position()    caxpos = mtransforms.Bbox.from_extents(axpos.x1 + 0.02, axpos.y0, axpos.x1 + 0.03, axpos.y1)    cax = ax.figure.add_axes(caxpos)    locator = mticker.MultipleLocator(20)    formatter = mticker.StrMethodFormatter(\"{x:.2f}\")    cax.figure.colorbar(sm, cax=cax, ticks=locator, format=formatter)    ax.figure.set_size_inches(20, 8)    ax.figure.set_dpi(150)    plt.show()    plt.close()    return data[\"score\"]totSenScore0 = weekTotSenScore(dfEs[0])totSenScore1 = weekTotSenScore(dfEs[1])_ = weekTotSenScore(dfE)\n图 13 按周统计累计情感指数\n累计情感指数变化折线图 ¶\nax = sns.lineplot(data=totSenScore0, linewidth=3, marker=\"s\", markersize=15, label=labels[0])ax = sns.lineplot(data=totSenScore1, linewidth=3, marker=\"^\", markersize=15, ax=ax, label=labels[1])ax.set_xlabel(\"Date\")plt.xticks(rotation=60)ax.set_ylabel(\"Total Sentiment Score\")ax.set_xlim(0, 52)ax.legend(prop={\"size\": 24})ax.figure.set_size_inches(20, 8)ax.figure.set_dpi(150)plt.show()plt.close()\n图 14 累计变化折线图\n每日平均情感分析 ¶\ngrouper = pd.Grouper(key=\"hour\")data = []for k in range(2):    tmp = dfEs[k].groupby(grouper)[\"score\"].mean().sort_index()    for i in range(24):        if i in tmp.index:            data.append(tmp[i])        else:            data.append(0)    data.append(0)data = pd.DataFrame(    {        \"Score\": data,        \"Person\": [labels[0]] * 25 + [labels[1]] * 25,    })xBins = [i for i in range(25)]ax = sns.histplot(    data=data,    x=xBins * 2,    bins=xBins,    weights=\"Score\",    hue=\"Person\",    multiple=multiple,    edgecolor=\".3\",    linewidth=0.5,    palette=\"dark\",    alpha=0.6,)ax.set_xticks(range(25))ax.set_xticklabels(range(25))ax.set_xlabel(\"Hour\")ax.set_xlim(0, 24)ax.set_ylim(np.min([0, np.floor(data[\"Score\"].min() / 0.05) * 0.05]), np.ceil(data[\"Score\"].max() / 0.05) * 0.05)sns.move_legend(ax, loc=\"upper center\", bbox_to_anchor=(0.5, 1.2), ncol=2)ax.figure.set_size_inches(8, 4)ax.figure.set_dpi(150)plt.show()plt.close()\n图 15 每日平均情感分析\n每日累计情感分析 ¶\ngrouper = pd.Grouper(key=\"hour\")data = []for k in range(2):    tmp = dfEs[k].groupby(grouper)[\"score\"].sum().sort_index()    for i in range(24):        if i in tmp.index:            data.append(tmp[i])        else:            data.append(0)    data.append(0)data = pd.DataFrame(    {        \"Score\": data,        \"Person\": [labels[0]] * 25 + [labels[1]] * 25,    })xBins = [i for i in range(25)]ax = sns.histplot(    data=data,    x=xBins * 2,    bins=xBins,    weights=\"Score\",    hue=\"Person\",    multiple=multiple,    edgecolor=\".3\",    linewidth=0.5,    palette=\"dark\",    alpha=0.6,)ax.set_xticks(range(25))ax.set_xticklabels(range(25))ax.set_xlabel(\"Hour\")ax.set_xlim(0, 24)ax.set_ylim(np.min([0, np.floor(data[\"Score\"].min() / 0.05) * 0.05]), np.ceil(data[\"Score\"].max() / 0.05) * 0.05)sns.move_legend(ax, loc=\"upper center\", bbox_to_anchor=(0.5, 1.2), ncol=2)ax.figure.set_size_inches(8, 4)ax.figure.set_dpi(150)plt.show()plt.close()\n图 16 每日累计情感分析\n工具 ¶\n\nWeChatMsg\nPaddleNLP\nTHUOCL：清华大学开放中文词库\n中文常用停用词表\njieba 中文分词\n\n参考资料 ¶\n\nwechat_analysis\nPython 制作日历图｜可视化聊天记录\n1 年的聊天记录写成论文作为老婆生日礼物\n当我把和男朋友两年半的聊天记录可视化\n90 万人看过的聊天记录可视化第二弹来啦\nMake seaborn show a colorbar instead of a legend when using hue in a bar plot?\nMatplotlib 系列：colorbar 的设置\nmatplotlib 绘图之坐标变换\n\n","categories":["技术笔记"],"tags":["教程","Python","Jupyter","微信","聊天记录"]},{"title":"使用油猴脚本优化期刊阅读体验","url":"/posts/202408-journalviewer.html","content":"安装浏览器油猴（TemperMonkey）拓展请参考：\n\n全网最完整 Tampermonkey 油猴脚本管理器安装教程\nTampermonkey 油猴插件 —— 安装与使用教程\n\n\n使用油猴脚本请谨慎辨别安全性，使用前仔细阅读脚本的说明文档。\n完整代码可以通过 Greasy Fork 获得：Journal Viewer\n\n在 PC 网页端在线阅读一些期刊时，往往会有一些侧边栏占据了很大的空间，极其影响阅读体验。但是通过查看网页元素，可以发现这些侧边栏存在很明显的特征，我们可以通过 JavaScript 代码来获取这些元素并删除，同时调整正文的样式，获取更好的阅读体验。\n图 1 APS 原始界面\n图 2 Science Direct 原始界面\n图 3 Nature 原始界面\n对于 APS 旗下的期刊，可以使用以下代码：\nlet aps_sidebar = document.getElementById(\"article-sidebar\");aps_sidebar.remove();let aps_content = document.getElementById(\"article-content\");aps_content.style.width = \"100%\";\n效果如下图所示。\n图 4 APS 优化后界面\n同理可以优化其他期刊。\n","categories":["技术笔记","工具"],"tags":["TemperMonkey","油猴","脚本","文献","期刊"]},{"title":"自建 Umami 统计","url":"/posts/202209-umami.html","content":"\n第一次更新：Umami 从 V1 升级到 V2，请见 V2 版本更新\n第二次更新：Umami 从 V2 升级到 V3，请见 V3 版本更新\n\n\n在一年多之前，我写了一篇博客（准实时访问统计）介绍如何使用百度统计的 API 实现准实时的访问统计与展示。然而今年百度统计宣布个人版只允许保存一年的数据，而且很多功能会被关闭（例如 OS 统计等），再加上其 API 使用也不方便，因此我开始谋求其他的站点统计系统。\n与百度统计同类型的竞品还有谷歌统计、51La、CNZZ 等，但是这些网站与百度统计也或多或少存在类似类似的问题，同时作为个人小站，也不需要收集过于精细的用户信息（如年龄、详细地区等），所以我开始寻找自建的统计工具。\n\n目前常用的一些开源统计工具可以查看：5 款免费开源的网站流量分析统计工具，在这其中Umami和Plausible是我认为不错的选择，再结合枋柚梓的自建个人网站数据统计分析系统，最终决定采用Umami。\nUmami也存在问题：\n\n只记录了 country，无法精确到省份\n地图存在问题，如果使用要避免直接展示地图\n\n\n介绍 ¶\nUmami is an open source, privacy-focused alternative to Google Analytics. Umami provides you with a powerful web analytics solution that does not violate the privacy of your users. Additionally, when you self-host Umami you are in complete control of your data.\n\nUmami是一个开源的，关注隐私的谷歌统计替代品，由Nodejs编写，我们可以使用多种方式部署，包括Server自部署、Docker部署以及SeverLess服务部署。\n在本文中，我们会在服务器上直接部署服务，使用MySQL作为数据库。\n安装 ¶\n现在更推荐使用 docker + postgresql 安装\n\n环境要求：Nodejs 和 yarn\n\n源代码\n\ngit clone https://github.com/umami-software/umami.gitcd umamiyarn install\n\n环境变量\n在目录下创建.env文件，写入内容：\n\nPORT=8000DATABASE_URL=mysql://username:mypassword@localhost:3306/mydb\n\n构建与运行\n\nyarn buildyarn start-dev\n随后即可在localhost:8000上打开网页，初始默认用户名为admin，密码为umami。\n统计展示 ¶\nAPI¶\nUmami 将通过https://&lt;your-umami&gt;/api调用 API，并返回 json 格式的数据。在构建过程中，我们需要使用到以下三个 API：\n\nPOST /api/auth/login\n通过这个 API 我们可以获取 TOKEN，作为后续 API 的认证，使用 Python 获取：\n\nimport jsonimport requesturl = \"https://&lt;your-umami&gt;/api/auth/login\"data = {    \"username\": \"your-username\",    \"password\": \"your-password\"}res = requests.post(url, data=data)res = json.loads(res.content)print(res)\n\n\nGET /api/website/{id}/pageviews\n通过这个 API，我们可以获取选定时段的访问量和访问人数等信息，时间颗粒度可以选择为月、天、小时等。\n\n\nGET /api/website/{id}/metrics\n通过这个 API，我们可以进一步获取国家 / 地区、来源等信息。\n\n\n但是由于以下个原因，我们尽量避免直接使用 API：\n\n保密 token：使用 API 需要将 token 作为请求 header，容易暴露\n地图需要转换：Umami 中国家 / 地区使用二字代码存储，而 Echarts 需要用到其他格式，需要一步转换\n地图问题：涉及香港、澳门、台湾等地\n\n因此最终我们可以自建一个 API，使用 python 的FastAPI库，代码如下：\nmain.pyimport jsonimport requestsfrom fastapi import FastAPIfrom fastapi.middleware.cors import CORSMiddlewareapp = FastAPI()origins = [    \"http://localhost\",    \"example.com\"]app.add_middleware(    CORSMiddleware,    allow_origins=origins,    allow_credentials=True,    allow_methods=[\"GET\"],    allow_headers=[\"*\"],)root_path = \"https://&lt;your-umami&gt;/api/website/1\"header = {    \"accept\": \"application/json\",    \"authorization\": \"Bearer YOUR TOKEN\",    \"content-type\": \"application/json\"}namemap = json.load(open(\"world.json\", \"r\"))@app.get(\"/day_view\")async def root(start_at, end_at):    url = root_path + \"/pageviews?start_at={:d}&amp;end_at={:d}&amp;unit=day&amp;tz=Asia/Shanghai\".format(        int(start_at),        int(end_at)    )    res = requests.get(url, headers=header)    res = json.loads(res.content)    return res@app.get(\"/month_view\")async def root(start_at, end_at):    url = root_path + \"/pageviews?start_at={:d}&amp;end_at={:d}&amp;unit=month&amp;tz=Asia/Shanghai\".format(        int(start_at),        int(end_at)    )    res = requests.get(url, headers=header)    res = json.loads(res.content)    return res@app.get(\"/referrer\")async def root(start_at, end_at):    url = root_path + \"/metrics?start_at={:d}&amp;end_at={:d}&amp;type=referrer\".format(        int(start_at),        int(end_at)    )    res = requests.get(url, headers=header)    res = json.loads(res.content)    return res@app.get(\"/country\")async def root(start_at, end_at):    url = root_path + \"/metrics?start_at={:d}&amp;end_at={:d}&amp;type=country\".format(        int(start_at),        int(end_at)    )    res = requests.get(url, headers=header)    res = json.loads(res.content)    ans = []    for item in res:        name = namemap[item[\"x\"]]        ans.append({            \"x\": name,            \"y\": item[\"y\"]        })    china = 0    for k in range(len(ans)):        item = ans[k]        if item[\"x\"] in [\"Hong Kong\", \"Taiwan\", \"Macau\"]:            china += item[\"y\"]            del ans[k]    for item in ans:        if item[\"x\"] == \"China\":            item[\"y\"] += china    return ans\n其中world.json是一个用于国家 / 地区转换的文件，内容如下：\nworld.json{    \"ES\": \"Spain\",    \"DE\": \"Germany\",    \"IE\": \"Ireland\",    \"IT\": \"Italy\",    \"AT\": \"Austria\",    \"FR\": \"France\",    \"BE\": \"Belgium\",    \"FI\": \"Finland\",    \"DK\": \"Denmark\",    \"CZ\": \"Czech Republic\",    \"EE\": \"Estonia\",    \"HU\": \"Hungaryngary\",    \"JE\": \"Jersey\",    \"LU\": \"Luxembourg\",    \"LV\": \"Latvia\",    \"MT\": \"Malta\",    \"NL\": \"Netherlands\",    \"PT\": \"Portugal\",    \"RO\": \"Romania\",    \"SI\": \"Slovenia\",    \"SK\": \"Slovakia\",    \"AE\": \"United Arab Emirates\",    \"AF\": \"Afghanistan\",    \"AL\": \"Albania\",    \"AM\": \"Armenia\",    \"AO\": \"Angola\",    \"AR\": \"Argentina\",    \"AU\": \"Australia\",    \"AZ\": \"Azerbaijan\",    \"BD\": \"Bangladesh\",    \"BF\": \"Burkina Faso\",    \"BG\": \"Bulgaria\",    \"BH\": \"Bahrein\",    \"BI\": \"Burundi\",    \"BJ\": \"Benin\",    \"BN\": \"Brunei Darussalam\",    \"BO\": \"Bolivia\",    \"BR\": \"Brazil\",    \"BW\": \"Botswana\",    \"BY\": \"Byelorussia\",    \"CA\": \"Canada\",    \"CF\": \"Central Africa\",    \"CG\": \"Congo\",    \"CH\": \"Switzerland\",    \"CL\": \"Chile\",    \"CM\": \"Cameroon\",    \"CN\": \"China\",    \"CO\": \"Colombia\",    \"CR\": \"Costa Rica\",    \"CS\": \"Czech Repubic\",    \"CU\": \"Cuba\",    \"CY\": \"Cyprus\",    \"DO\": \"Dominican Republic\",    \"DZ\": \"Algeria\",    \"EC\": \"Ecuador\",    \"EG\": \"Egypt\",    \"ET\": \"Ethiopia\",    \"FJ\": \"Fiji\",    \"GA\": \"Gabon\",    \"GB\": \"United Kingdom\",    \"GD\": \"Grenada\",    \"GE\": \"Georgia\",    \"GH\": \"Ghana\",    \"GN\": \"Guinea\",    \"GR\": \"Greece\",    \"GT\": \"Guatemala\",    \"HK\": \"Hong Kong\",    \"HN\": \"Honduras\",    \"ID\": \"Indonesia\",    \"IL\": \"Israel\",    \"IN\": \"India\",    \"IQ\": \"Iraq\",    \"IR\": \"Iran\",    \"IS\": \"Iceland\",    \"JM\": \"Jamaica\",    \"JO\": \"Jordan\",    \"JP\": \"Japan\",    \"KG\": \"Kyrgyzstan\",    \"KH\": \"Cambodia\",    \"KP\": \"Dem. Rep. Korea\",    \"KR\": \"Korea\",    \"KT\": \"Ivory Coast\",    \"KW\": \"Kuwati\",    \"KZ\": \"Kazakhstan\",    \"LA\": \"Laos\",    \"LB\": \"Lebanon\",    \"LC\": \"Saint Lueia\",    \"LI\": \"Liechtenstein\",    \"LK\": \"Sri Lanka\",    \"LR\": \"Liberia\",    \"LT\": \"Lithuania\",    \"LY\": \"Libyan\",    \"MA\": \"Morocco\",    \"MC\": \"Monaco\",    \"MD\": \"Moldova\",    \"MG\": \"Madagascar\",    \"ML\": \"Mali\",    \"MM\": \"Myanmar\",    \"MN\": \"Mongolia\",    \"MO\": \"Macau\",    \"MU\": \"Mauritius\",    \"MW\": \"Malawi\",    \"MX\": \"Mexico\",    \"MY\": \"Malaysia\",    \"MZ\": \"Mozambique\",    \"NA\": \"Namibia\",    \"NE\": \"Niger\",    \"NG\": \"Nigeria\",    \"NI\": \"Nicaragua\",    \"NO\": \"Norway\",    \"NP\": \"Nepal\",    \"NZ\": \"New Zealand\",    \"OM\": \"Oman\",    \"PA\": \"Panama\",    \"PE\": \"Peru\",    \"PG\": \"Papua New Guinea\",    \"PH\": \"Philippines\",    \"PK\": \"Pakistan\",    \"PL\": \"Poland\",    \"PY\": \"Paraguay\",    \"QA\": \"Qatar\",    \"RU\": \"Russian Federation\",    \"SA\": \"Saudi Arabia\",    \"SC\": \"Republic of Seychelles\",    \"SD\": \"Sudan\",    \"SE\": \"Sweden\",    \"SG\": \"Singapore\",    \"SM\": \"San Marino\",    \"SN\": \"Senegal\",    \"SO\": \"Somalia\",    \"SY\": \"Syria\",    \"SZ\": \"Swaziland\",    \"TD\": \"Chad\",    \"TG\": \"Togo\",    \"TH\": \"Thailand\",    \"TJ\": \"Tajikistan\",    \"TM\": \"Turkmenistan\",    \"TN\": \"Tunisia\",    \"TR\": \"Turkey\",    \"TW\": \"Taiwan\",    \"TZ\": \"Tanzania\",    \"UA\": \"Ukraine\",    \"UG\": \"Uganda\",    \"US\": \"United States\",    \"UY\": \"Uruguay\",    \"UZ\": \"Uzbekistan\",    \"VC\": \"Saint Vincent\",    \"VE\": \"Venezuela\",    \"VN\": \"Viet Nam\",    \"YE\": \"Yemen\",    \"YU\": \"Yugoslavia\",    \"ZA\": \"South Africa\",    \"ZM\": \"Zambia\",    \"ZR\": \"Zaire\",    \"ZW\": \"Zimbabwe\"}\n数据显示 ¶\n构建完 API 后，我们开始改写之前的census.js，内容如下：\ncensus.js// 访问日历function generatePieces(maxValue, colorBox) {    var pieces = [];    var quotient = 1;    var temp = {'lt': 1, 'label': '0', 'color': colorBox[0]};    pieces.push(temp);     if (maxValue &amp;&amp; maxValue &gt;= 10) {        quotient = Math.floor(maxValue / 10)+1;        for (var i = 1; i &lt;= 10; i++) {            var temp = {};            if (i == 1)   temp.gte = 1;            else   temp.gte = quotient * (i - 1);            temp.lte = quotient * i;            temp.color = colorBox[i];            pieces.push(temp);        }    }    return JSON.stringify(pieces);}function append_div_visitcalendar(parent, text) {    if (parent !== null) {        if (typeof text === 'string') {            var temp = document.createElement('div');            temp.innerHTML = text;            var frag = document.createDocumentFragment();            while (temp.firstChild) {                frag.appendChild(temp.firstChild);            }            parent.appendChild(frag);        } else {            parent.appendChild(text);        }    }};function compareFunction(propertyName){    return function (o1, o2) {        //获取比较的值        var v1 = o1[propertyName];        var v2 = o2[propertyName];        return v1 &gt; v2 ? 1 : (v1 == v2 ? 0 : -1);    };}function filterTime(time) {    const date = new Date(time)    const Y = date.getFullYear()    const M = date.getMonth() + 1 &lt; 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1    const D = date.getDate() &lt; 10 ? '0' + (date.getDate()) : date.getDate()    return `${Y}-${M}-${D}`}function calChart() {    let script = document.createElement(\"script\");    let now = new Date();    let date = new Date();    date.setFullYear(now.getFullYear() - 1);    let start_at = date.getTime() - 3600 * 24 * ((date.getDay() + 1) % 7);    let end_at = now.getTime();    // API根据自己的实际更改    fetch('https://api.foolishfox.cn/umami/day_view?start_at=' + start_at + '&amp;end_at=' + end_at).then(data =&gt; data.json()).then(data =&gt; {        data = data.pageviews;        data.sort(compareFunction(\"t\"));        let calArr = [];        let maxValue = 0, total = 0, weekdatacore = 0, thisweekdatacore = 0;        let colorBox = ['#EBEDF0', '#FFE9BB', '#FFD1A7', '#FFBB95', '#FFA383', '#FF8D70', '#FF745C', '#FF5C4A', '#FF4638', '#FF2E26', '#FF1812'];        for (let i = 0; i &lt; data.length; i++) {            if (i &gt; 0) {                let pre = new Date(data[i - 1].t.replace(/-/g, \"/\"));                let tmp = new Date(data[i].t.replace(/-/g, \"/\"));                if (tmp.getTime() - pre.getTime() != 86400 * 1000)                    for (let k = 1; k &lt; (tmp.getTime() - pre.getTime()) / (86400 * 1000); k++) {                        tmp = new Date(pre.getTime() + 86400 * 1000 * k);                        calArr.push([filterTime(tmp), 0]);                    }            }            calArr.push([data[i].t, data[i].y]);            maxValue = data[i].y &gt; maxValue ? data[i].y : maxValue;            total += data[i].y;        }        if (calArr[calArr.length - 1][0] != filterTime(now))   calArr.push([filterTime(now), 0]);        for (let i = calArr.length - 1; i &gt;= calArr.length - 7; i--)   weekdatacore += calArr[i][1];        for (let i = calArr.length - 1; i &gt;= calArr.length - 30; i--)   thisweekdatacore += calArr[i][1];        let calArrJson = JSON.stringify(calArr);        script.innerHTML = `        var calChart = echarts.init(document.getElementById(\"calendar_container\"));        var option = {            title: { text: '访问日历', x: 'center' },            tooltip: {                padding: 10,                backgroundColor: '#555',                borderColor: '#777',                borderWidth: 1,                textStyle: { color: '#fff' },                formatter: function (obj) {                    var value = obj.value;                    return '&lt;div style=\"font-size: 14px;\"&gt;' + value[0] + ': ' + value[1] + '&lt;/div&gt;';                }            },            visualMap: {                show: false,                showLabel: true,                min: 0,                max: ${maxValue},                type: 'piecewise',                orient: 'horizontal',                left: 'center',                bottom: 0,                pieces: ${generatePieces(maxValue, colorBox)}            },            calendar: [{                left: 'center',                range: ['${calArr[0][0]}', '${calArr[calArr.length - 1][0]}'],                cellSize: [14, 14],                splitLine: {                    show: false                },                itemStyle: {                    color: '#ebedf0',                    borderColor: '#fff',                    borderWidth: 2                },                yearLabel: {                    show: false                },                monthLabel: {                    nameMap: 'cn',                    fontSize: 11                },                dayLabel: {                    formatter: '{start}  1st',                    nameMap: 'cn',                    fontSize: 11                }            }],            series: [{                type: 'heatmap',                coordinateSystem: 'calendar',                calendarIndex: 0,                data: ${calArrJson},            }]        };        calChart.setOption(option);`;        let style = '&lt;style&gt;.number{margin-top: 10px;text-align:center;width:100%;padding:10px;margin:0 auto;}.contrib-column{text-align:center;border-left:1px solid #ddd;border-top:1px solid #ddd;}.contrib-column-first{border-left:0;}.table-column{padding:10px;display:table-cell;flex:1;vertical-align:top;}.contrib-number{font-weight:400;line-height:1.3em;font-size:24px;display:block;}.left.text-muted{float:left;margin-left:9px;color:#767676;}.left.text-muted a{color:#4078c0;text-decoration:none;}.left.text-muted a:hover{text-decoration:underline;}h2.f4.text-normal.mb-3{display:none;}.float-left.text-gray{float:left;}.position-relative{width:100%;}@media screen and (max-width:650px){.contrib-column{display:none}}&lt;/style&gt;';        style = '&lt;div style=\"display:flex;width:100%\" class=\"number\"&gt;&lt;div class=\"contrib-column contrib-column-first table-column\"&gt;&lt;span class=\"text-muted\"&gt;过去一年访问&lt;/span&gt;&lt;span class=\"contrib-number\"&gt;' + total + '&lt;/span&gt;&lt;span class=\"text-muted\"&gt;' + calArr[0][0] + '&amp;nbsp;-&amp;nbsp;' + calArr[calArr.length - 1][0] + '&lt;/span&gt;&lt;/div&gt;&lt;div class=\"contrib-column table-column\"&gt;&lt;span class=\"text-muted\"&gt;最近30天访问&lt;/span&gt;&lt;span class=\"contrib-number\"&gt;' + thisweekdatacore + '&lt;/span&gt;&lt;span class=\"text-muted\"&gt;' + calArr[calArr.length - 30][0] + '&amp;nbsp;-&amp;nbsp;' + calArr[calArr.length - 1][0] + '&lt;/span&gt;&lt;/div&gt;&lt;div class=\"contrib-column table-column\"&gt;&lt;span class=\"text-muted\"&gt;最近7天访问&lt;/span&gt;&lt;span class=\"contrib-number\"&gt;' + weekdatacore + '&lt;/span&gt;&lt;span class=\"text-muted\"&gt;' + calArr[calArr.length - 7][0] + '&amp;nbsp;-&amp;nbsp;' + calArr[calArr.length - 1][0] + '&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;' + style;        document.getElementById(\"calendar_container\").after(script);        append_div_visitcalendar(calendar_container, style);    }).catch(function (error) {        console.log(error);    });}// 访问地图function mapChart () {    let script = document.createElement(\"script\");    let now = new Date();    let date = new Date();    // 这个根据自己开始的时间修改    date.setFullYear(2021, 01, 01);    let start_at = date.getTime();    let end_at = now.getTime();    // API根据自己的实际更改    fetch('https://api.foolishfox.cn/umami/country?start_at=' + start_at + '&amp;end_at=' + end_at).then(data =&gt; data.json()).then(data =&gt; {        let mapArr = [];        let maxValue = 0;        for (let i = 0; i &lt; data.length; i++) {            maxValue = data[i].y &gt; maxValue ? data[i].y : maxValue ;            mapArr.push({ name: data[i].x, value: data[i].y });        }        let mapArrJson = JSON.stringify(mapArr);        script.innerHTML = `        var mapChart = echarts.init(document.getElementById('map_container'), 'light');        var mapOption = {            title: { text: '访问地点(按人数记)', x: 'center' },            tooltip: { trigger: 'item' },            visualMap: {                min: 0,                max: ${maxValue},                left: 'left',                top: 'bottom',                text: ['高','低'],                color: ['#1E90FF', '#AAFAFA'],                calculable: true            },            series: [{                name: '访问人数',                type: 'map',                mapType: 'world',                showLegendSymbol: false,                label: {                    emphasis: { show: false }                },                itemStyle: {                    normal: {                        areaColor: 'rgba(255, 255, 255, 0.1)',                        borderColor: '#121212'                    },                    emphasis: { areaColor: 'gold' }                },                data: ${mapArrJson}            }]        };        mapChart.setOption(mapOption);`;        document.getElementById('map_container').after(script);    }).catch(function (error) {        console.log(error);    });}function get_year(s) {    return parseInt(s.substr(0, 4));}function get_month(s) {    return parseInt(s.substr(5, 2));}// 访问趋势function trendsChart () {    let script = document.createElement(\"script\");    let now = new Date();    let date = new Date();    // 这个根据自己开始的时间修改    date.setFullYear(2021, 01, 01);    let start_at = date.getTime();    let end_at = now.getTime();    // API根据自己的实际更改    fetch('https://api.foolishfox.cn/umami/month_view?start_at=' + start_at + '&amp;end_at=' + end_at).then(data =&gt; data.json()).then(data =&gt; {        data = data.pageviews;        let date = new Date();        let monthValueArr = {};        for (let i =2020; i &lt;= date.getFullYear(); i++)   monthValueArr[String(i)] = [ ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  ];        for (let i = 0; i &lt; data.length; i++) {            let year = get_year(data[i].t);            let month = get_month(data[i].t);            monthValueArr[String(year)][String(month-1)] = data[i].y;        }        script.innerHTML = `        var trendsChart = echarts.init(document.getElementById('trends_container'), 'light');        var trendsOption = {            title: { text: '访问趋势', x: 'center' },            tooltip: { trigger: 'axis' },            legend: { data: ['2021', '2022'], x: 'right' },            xAxis: {                name: '日期', type: 'category', boundaryGap: false,                data: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月']            },            yAxis: { name: '访问次数', type: 'value' },            series: [                {                    name: '2021', type: 'line', smooth: true,                    data: [${monthValueArr[\"2021\"]}],                    markLine: { data: [{type: 'average', name: '平均值'}] }                },                {                    name: '2022', type: 'line', smooth: true,                    data: [${monthValueArr[\"2022\"]}],                    markLine: { data: [{type: 'average', name: '平均值'}] }                }            ]        };        trendsChart.setOption(trendsOption);`;        document.getElementById('trends_container').after(script);    }).catch(function (error) {        console.log(error);    });}// 访问来源function sourcesChart () {    let script = document.createElement(\"script\");    var link = 0, direct = 0, search = 0;    var google = 0, baidu = 0, bing = 0;    var github = 0, travel = 0;    let now = new Date();    let date = new Date();    // 这个根据自己开始的时间修改    date.setFullYear(2021, 01, 01);    let start_at = date.getTime();    let end_at = now.getTime();    // API根据自己的实际更改    fetch('https://api.foolishfox.cn/umami/referrer?start_at=' + start_at + '&amp;end_at=' + end_at).then(data =&gt; data.json()).then(data =&gt; {        for (let i = 0; i &lt; data.length; i++) {            var ref = data[i].x;            if(ref == \"\" || ref.includes(\"foolishfox.cn\"))  direct += data[i].y;            else if(ref.includes(\"bing.com\"))   bing += data[i].y;            else if(ref.includes(\"baidu.com\"))   baidu += data[i].y;            else if(ref.includes(\"google.com\"))   google += data[i].y;            else if(ref.includes(\"sogou.com\") || ref.includes(\"sm.cn\") || ref.includes(\"toutiao.com\") || ref.includes(\"so.com\"))                search += data[i].y            else if(ref.includes(\"github.com\"))   github += data[i].y;            else if(ref.includes(\"travellings\") || ref.includes(\"foreverblog\"))   travel += data[i].y;            else   link += data[i].y        }        link += github + travel;        search += baidu + google + bing;        script.innerHTML += `        var sourcesChart = echarts.init(document.getElementById('sources_container'), 'light');        var sourcesOption = {            title: { text: '访问来源', x: 'center', },            tooltip: { trigger: 'item', formatter: '{a} &lt;br/&gt;{b}: {c} ({d}%)' },            legend: {                data: ['直达', '外链', '搜索', '百度', '谷歌', '必应', 'Github', '开往/十年之约'],                y: 'bottom'            },            series: [                {                    name: '来源明细', type: 'pie', radius: ['45%', '60%'],                    labelLine: { length: 30 },                    label: {                        formatter: '{a|{a}}{abg|}\\\\n{hr|}\\\\n  {b|{b}: }{c}  {per|{d}%}  ',                        backgroundColor: '#F6F8FC', borderColor: '#8C8D8E',                        borderWidth: 1, borderRadius: 4,                        rich: {                            a: { color: '#6E7079', lineHeight: 22, align: 'center' },                            hr: { borderColor: '#8C8D8E', width: '100%', borderWidth: 1, height: 0 },                            b: { color: '#4C5058', fontSize: 14, fontWeight: 'bold', lineHeight: 33 },                            per: { color: '#fff', backgroundColor: '#4C5058', padding: [3, 4], borderRadius: 4 }                        }                    },                    data: [                        {value: ${search - google - baidu - bing}, name: '其他', itemStyle: { color : '#008000' }},                        {value: ${google}, name: '谷歌', itemStyle: { color : '#009000' }},                        {value: ${baidu}, name: '百度', itemStyle: { color : '#00A000' }},                        {value: ${bing}, name: '必应', itemStyle: { color : '#00B000' }},                        {value: ${direct}, name: '直达', itemStyle: { color : '#FFDB5C' }},                        {value: ${github}, name: 'Github', itemStyle: { color : '#10A3C7' }},                        {value: ${travel}, name: '开往/十年之约', itemStyle: { color : '#21B4D8' }},                        {value: ${link - github - travel}, name: '其他', itemStyle: { color : '#32C5E9' }}                    ]                },                {                    name: '访问来源', type: 'pie', selectedMode: 'single', radius: [0, '30%'],                    label: { position: 'inner', fontSize: 14},                    labelLine: { show: false },                    data: [                        {value: ${search}, name: '搜索', itemStyle: { color : '#008000' }},                        {value: ${direct}, name: '直达', itemStyle: { color : '#FFDB5C' }},                        {value: ${link}, name: '外链', itemStyle: { color : '#32C5E9' }}                    ]                },            ]        };        sourcesChart.setOption(sourcesOption);        window.addEventListener(\"resize\", () =&gt; {             calChart.resize();            mapChart.resize();            trendsChart.resize();            sourcesChart.resize();        });`;    }).catch(function (error) {        console.log(error);    });    document.getElementById('sources_container').after(script);}if (document.getElementById(\"calendar_container\"))   calChart();if (document.getElementById('map_container'))   mapChart();if (document.getElementById('trends_container'))   trendsChart();if (document.getElementById('sources_container'))   sourcesChart();\n效果展示 ¶\n动态展示页面：戳这里\n日历图与地图\n访问趋势与来源\nV2 版本更新 ¶\nUmami 更新 ¶\n本文安装时Umami的版本是1.38.0，目前已经更新到了2.6.2，跨大版本升级需要更新数据库，大致流程如下：\n\n拉取最新仓库：\n\ngit pull\n\n更新到V1的最新版本1.40.0：\n\ngit checkout cc2be9f4yarn installyarn build\n\n进行数据迁移\n\nnpx @umami/migrate-v1-v2@latest\n\n升级到V2：\n\ngit checkout masteryarn installyarn build\n注意在安装sharp包时可能会由于网络下载相关内容超时导致失败，可以在.npmrc中添加：\nsharp_binary_host=https://npm.taobao.org/mirrors/sharpsharp_libvips_binary_host=https://npm.taobao.org/mirrors/sharp-libvips\nAPI 程序更新 ¶\n在升级之后，Umami的 API 也发生了改变，主要包括：\n\nGET /api/website/{id}/pageviews中的id进行了修改，变成了由数字和字母组成的混合字符串，例如74204a9f-8aca-4adf-9f03-d509f0a07116，此外website变为了websites\n API 中的时间起止从start_at和end_at改为了startAt和endAt\n API 中的时区标识从tz改为timezone\n最长只能获取 90 天内的每日浏览数据，超过 90 天将会自动归并为每月的访问数据  Fixed in v2.9.0.\n返回数据中时间标识从t改为了x\n\n根据上述更新，我们需要对main.py和census.js进行修改，示例如下：\nmain.py...root_path = \"https://&lt;your-umami&gt;/api/websites/{}\"...@app.get(\"/day_view\")async def root(startAt, endAt):    url = root_path + \"/pageviews?startAt={:d}&amp;endAt={:d}&amp;unit=day&amp;timezone=Asia/Shanghai\".format(        int(startAt),        int(endAt)    )    res = requests.get(url, headers=header)    res = json.loads(res.content)    return res...\ncensus.js...function calChart() {...    // 90 天版本    let now = new Date();    let endAt = now.getTime();    let startAt = endAt - 90 * 86400 * 1000;    // 1 年版本    let now = new Date();    let date = new Date();    date.setFullYear(now.getFullYear() - 1);    let startAt = date.getTime() - 3600 * 24 * ((date.getDay() + 1) % 7);    let endAt = now.getTime();    // API根据自己的实际更改    fetch('https://api.foolishfox.cn/umami/day_view?startAt=' + startAt + '&amp;endAt=' + endAt).then(data =&gt; data.json()).then(data =&gt; {        data = data.pageviews;        data.sort(compareFunction(\"x\"));...                let pre = new Date(data[i - 1].x.replace(/-/g, \"/\"));                let tmp = new Date(data[i].x.replace(/-/g, \"/\"));...            calArr.push([data[i].x, data[i].y]);        }...    }...\nV3 版本更新 ¶\n有关 Umami 从 Mariadb 迁移至 Postgresql，并且升级至 V3 版本的教程，请参考：升级 Umami | 从 Mariadb 迁移至 Postgresql。脚本的主要更新如下：\n\n将科索沃（Kosovo）映射到塞尔维亚（Serbia）\n修复访问来源无法得到 ref 为空的情况\n实现世界地图的对数化显示\n代码请见：FoxHub fox/umami-stats-scripts\n\n广告反屏蔽 ¶\nUmami 的默认跟踪代码提供的链接是 https://umami.foolishfox.cn/script.js，会被大多数的广告插件屏蔽（如 AdGuard），统计不到访客信息。通过设置 TRACKER_SCRIPT_NAME 可以修改链接，起到反屏蔽的效果，修改后的跟踪代码链接为https://umami.foolishfox.cn/Bf5ZmaKLu245LG。\ndocker-compose.ymlversion: \"3.9\"services:    umami:        image: ghcr.io/umami-software/umami:mysql-latest        environment:            TRACKER_SCRIPT_NAME: Bf5ZmaKLu245LG\n参考资料 ¶\n\nMigrating v1 to v2\n一站式解决 Node 项目中遇到的 诸如 sharp: Command failed. 或 Building fresh packages… 始终执行问题\nEnvironment variables\n\n","categories":["技术笔记","博客成长日志"],"tags":["教程","站点统计","Echarts","Umami"]},{"title":"独立博客自省问卷 15 题 - 2024","url":"/posts/202410-refle-24.html","content":"\n以下问卷纯粹自省自娱，自我调侃，勿对号入座。\n如有不适，请及时关闭浏览器窗口。\n如有启发，建议每隔一段时间服用一次。\nFrom 独立博客自省问卷 15 题\n\n\n你的博客更新频率是多少？\nA. 每周更新\nB. 一周数篇\nC. 一月 1-2 篇\n✅ D. 几个月一篇\n\n\n一直很想写，但是懒…… 发Memos 更多了。\n\n\n你的博客上次更新是什么时候？\nA. 本周\nB. 上周\nC. 上个月\n✅ D. 上季度\n\n\n现在手上还有两三个内容等着写，咕咕咕（这不又水了一篇\n\n\n你的博客文章是原创的吗？\n✅ A. 坚持原创\nB. 部分借鉴\nC.AI 帮我写的\nD. 搬运别人的，而且不署名\n\n\n坚决抵制学术博客不端，内容原创，参考留名\n\n\n你觉得自己的文章对他人有帮助吗？\nA. 旨在对他人有启示\n✅ B. 多少有点意义\nC. 每日每周流水账\n✅ D. 自我陶醉就好，管他呢\n\n\n自己以后用得上也是意义\n\n\n你上次换博客主题 / 程序是什么时候？\nA. 上周\nB. 上个月\n✅ C. 去年\nD. 凭良心说，我多年都是一个主题\n\n\n从stun 迁移过来的，主要像侧边栏widget之类的自己写太麻烦，最终找了个现成的\n\n\n你上一次捣腾博客主题代码是什么时候？\nA. 昨天，撸代码到凌晨\nB. 每周必捣腾\nC. 每月有那么一次\n✅ D. 一年有那么一次\n\n\n个人博客的意义在于记录与折腾\n\n\n你会对博客主题进行二次开发？\nA. 直接配置使用，省心不折腾\n✅ B. 时不时自己改改，搞点新花样，换图片，换字体，爽\nC. 删除主题作者版权信息，改改样式，然后自我感觉良好\nD. 改得面目全非，但保留原作者版权信息或注明\n\n\n同上，有些功能也得自己加，例如首页的Memos轮播\n\n\n你多久打开自己博客自我陶醉一次？\nA. 每天数次\n✅ B. 每周一次\nC. 看心情\nD. 一般都是照镜子，不看博客\n\n\n因为有 Moments 朋友圈的存在，每周都会打开看看博友们发了什么新文章\n\n\n你近期对自己博客域名什么感受？\nA. 想搞到一个 .COM 的域名\n✅ B. 如果域名能再短几个字符就更好了\nC. 今年才换双拼域名了，明年再看看\nD. 目前挺好，没想法\n\n\n现在域名虽然好记，但是确实有点太长了，但是又没有什么缩短的方向，ff.cn？还是ff.sh.cn或者ffox之类的\n\n\n你每天都会看网站的流量统计吗？\nA. 每天看几次，今天又多了 100PV\n✅ B. 每周回顾，看看流量趋势\nC. 记得就看看\nD. 没有搞流量统计，都是浮云\n\n\n虽然没什么人，但是自建了Umami 和统计，并且每天会自动给我发送报告\n\n通过 Server 酱发送每日报告\n\n你通过博客的广告赚到钱了吗？\nA. 有，能覆盖建站费用\nB. 有，但付出大于收入\nC. 没考虑通过博客流量赚钱\n✅ D. 拒绝广告，保证阅读体验\n\n\n主要是接不到广告\n\n\n你去浏览别人的博客 / 网站主要为什么？\n✅ A. 学习别人分享的知识\nB. 搬运别人的内容\n✅ C. 看看别人怎么装修博客，自己也抄一下，感觉都比自己的好\nD. 不爱看别人博客，自己爱写啥写啥\n\n\n两者大概三比一吧\n\n\n看到别人分享了一篇文章，你打开第一反应是什么？\nA. 哇，这域名真不错，怎么我没想到\nB. 哇，这网站速度真快，图片延迟加载丝滑\n✅ C. 哇，这程序/主题不错，我也要抄一抄/留言问问哪里搞的\n✅ D. 看看文章内容\n\n\n首看内容，然后跑偏……\n\n\n你觉得博客哪方面更重要？\nA. 域名\n✅ B. 服务器\nC. 主题\n✅ D. 内容\n\n\n首重内容，但是也要能打开😂\n\n\n近期通过写博客有哪些新收获？\n✅ A. 知识面有拓展\n✅ B. 认识了新朋友\n✅ C. 写作水平提升\nD. 通过知识变现\n\n\n就是主打一个与 Money 无缘\n\n"},{"title":"阻止 Bing / Google 收录自建 Gitea 链接","url":"/posts/202501-bing-gitea.html","content":"\n.imgdiv a {\n    width: 45%;\n}\n\n最近去检查 Bing 和 Google 的网站收录情况，发现收录了一大堆自建的 Gitea 和 Memos 链接，这些链接不太希望直接发布在收索引擎中，而且变换比较快，参考意义不大，所以想阻止被收录。\n\n\n\n\n临时删除 ¶\n如果只需要临时删除这些索引，Google 和 Bing 都提供了入口，不过需要每一定时间手动延期。\n\n\n\n\n\n\n\n\n永久阻止 ¶\n对于使用 docker 部署的 Gitea，按照官网的安装教程挂载了卷，例如：\ndocker-compose.yml...services:  server:    image: docker.io/gitea/gitea:1.23.1    ...    volumes:      - ./gitea:/data    ...\n容器中的/data/gitea目录与宿主机的./gitea/gitea目录对应，这个目录是用于存放自定义文件的，创建目录templates/custom，在该目录下创建header.tmpl文件，并写入：\nheader.tmpl&lt;meta name=\"robots\" content=\"noindex\"&gt;\n重启 Gitea 查看效果即可：\n\n搜索过程 ¶\n在 Google 和 Bing 的官方文档中都提到了不要使用robots.txt作为屏蔽机制，而推荐了三种方法：\n\n将noindex元标记添加到页面的&lt;head&gt;部分，安全性较低，还可能被收录\n禁止访问（例如需要密码），但操作不现实，除非全部私有化仓库\n移除网站，404 Not Found，更不可行\n\n所以下一步是查找怎么在 Gitea 中找到页面&lt;head&gt;部分并且修改。右键查看自建 Gitea 网页的源代码，找到已有的元标记，然后在 Gitea 的官方 Github 仓库中搜索，找到包含这部分的文件，即templates/base/head.tmpl。\n\n\n\n\n在代码中包含了这样一段：\ntemplates/base/head.tmpl&lt;!DOCTYPE html&gt;&lt;html lang=\"{{ctx.Locale.Lang}}\" data-theme=\"{{UserThemeName .SignedUser}}\"&gt;&lt;head&gt;    ...    {{template \"base/head_opengraph\" .}}    {{template \"base/head_style\" .}}    {{template \"custom/header\" .}}&lt;/head&gt;\n结合 Gitea 自定义模板的内容，在自定义目录下创建templates/custom，并在其中创建header.tmpl文件，写入：\nheader.tmpl&lt;meta name=\"robots\" content=\"noindex\"&gt;\n即可实现效果。\n参考资料 ¶\n\nInstallation with Docker\n“移除” 工具和 “安全搜索” 举报工具\nBlock URLs from Bing\ntemplates/base/head.tmpl\n\n","categories":["技术笔记","工具"],"tags":["网站收录","bing","google","gitea"]},{"title":"又一次服务器迁移","url":"/posts/202411-migrate-24.html","content":"之前本站一直使用的腾讯云轻量应用服务器服务器一次性买了 3 年，这个月月底就要到期了，但是一看续费的价格，十分的美丽。其实服务器的 4 个核心一直负载都不大，但是内存使用经常在 3G 作用，因此综合考虑下决定入手一个 2H4G 的服务器，再通过自定义镜像迁移过去。\n图 1 同配置续费 3 年的价格\n图 2 双十一活动新购服务器\n但是正当我购置好了服务器，正打算用自定义镜像重装系统的时候，请注意图中两个服务器的硬盘大小，旧的服务器硬盘是 80 GB，虽然我只使用了 40+ GB，但是导出的镜像是完整的 80 GB，而新的服务器硬盘只有 70 GB😒😒😒。\n于是只好手动把所有的内容同步到新的服务器上去了，幸好基本大部分的数据都在 home 目录下，同时万分感谢自己在从阿里云迁移到腾讯云的时候将所有的服务都使用 Docker 进行了容器化，所以一行命令迁移：\nscp -r $HOME/docker user@IP:/home/user\n然后在新服务器上安装 Docker，启动所有的容器就解决了大部分的工作，仅剩的是一些 Docker 的配置文件，也使用 scp 复制过去就行，两台服务器都在同一个区域，直接使用内网 IP 的传输速度还是挺快的，哪怕有很多的小文件。\nso，that’s all，新的服务器已经（看上去）正常运行。如果算上一次同价续费和拼团赠送的 3 个月有效期，这次又能苟 2 年多，希望不要有什么问题。\nPS：腾讯云最近开放了 IPv6 的测试申请，已经通过了，后面捣鼓一下看看有啥用处。下一期讲一下在 Portainer 里面 TLS 连接远程的 Docker 服务。\n","categories":["技术笔记","博客成长日志"],"tags":["服务器","Docker","腾讯云"]},{"title":"使君与府君，到底该怎么喊？","url":"/posts/202407-nameresearch.html","content":"前言 ¶\n三国演义中有一段经典剧情青梅煮酒论英雄，说献帝的舅舅董承与刘备暗中结盟欲除去曹操，刘备怕曹操生疑，因此每日浇水种豆。曹操听说后请刘备饮酒，议论天下英雄：\n\n  随至小亭，已设樽俎：盘置青梅，一樽煮酒。二人对坐，开怀畅饮。酒至半酣，忽阴云漠漠，骤雨将至。从人遥指天外龙挂，操与玄德凭栏观之。操曰：“使君知龙之变化否？” 玄德曰：“未知其详。” 操曰：“龙能大能小，能升能隐；大则兴云吐雾，小则隐介藏形；升则飞腾于宇宙之间，隐则潜伏于波涛之内。方今春深，龙乘时变化，犹人得志而纵横四海。龙之为物，可比世之英雄。玄德久历四方，必知当世英雄。请试指言之。” 玄德曰：“备肉眼安识英雄？” 操曰：“休得过谦。” 玄德曰：“备叨恩庇，得仕于朝。天下英雄，实有未知。” 操曰：“既不识其面，亦闻其名。” 玄德曰：“淮南袁术，兵粮足备，可为英雄？” 操笑曰：“冢中枯骨，吾早晚必擒之！” 玄德曰：“河北袁绍，四世三公，门多故吏；今虎踞冀州之地，部下能事者极多，可为英雄？“操笑曰：“袁绍色厉胆薄，好谋无断；干大事而惜身，见小利而忘命：非英雄也。玄德曰：“有一人名称七俊，威镇九州：刘景升可为英雄？” 操曰：“刘表虚名无实，非英雄也。” 玄德曰：“有一人血气方刚，江东领袖 —— 孙伯符乃英雄也？” 操曰：“孙策藉父之名，非英雄也。” 玄德曰：“益州刘季玉，可为英雄乎？” 操曰：“刘璋虽系宗室，乃守户之犬耳，何足为英雄！” 玄德曰：“如张绣、张鲁、韩遂等辈皆何如？” 操鼓掌大笑曰：“此等碌碌小人，何足挂齿！” 玄德曰：“舍此之外，备实不知。” 操曰：“夫英雄者，胸怀大志，腹有良谋，有包藏宇宙之机，吞吐天地之志者也。” 玄德曰：“谁能当之？” 操以手指玄德，后自指，曰：“今天下英雄，惟使君与操耳！” 玄德闻言，吃了一惊，手中所执匙箸，不觉落于地下。时正值天雨将至，雷声大作。玄德乃从容俯首拾箸曰：“一震之威，乃至于此。” 操曰：“丈夫亦畏雷乎？” 玄德曰：“圣人迅雷风烈必变，安得不畏？” 将闻言失箸缘故，轻轻掩饰过了。操遂不疑玄德。\n\n这一段内容在《三国志・蜀志二・先主传》中也有记载 [1]：\n\n  先主未出时，献帝舅车骑将军董承臣松之按：董承，汉灵帝母董太后之侄，于献帝为丈人。盖古无丈人之名，故谓之舅也。辞受帝衣带中密诏，当诛曹公。先主未发。是时曹公从容谓先主曰：「今天下英雄，惟使君与操耳。本初之徒，不足数也。」\n\n前段时间看小说的时候，和人讨论了这么一个问题，因此去查找了《后汉书》和《三国志》中的原文看看是什么情况，顺带也查看了一下《汉书》中的用法。\n\n使君 ¶\n使君可以理解为身负使命的官员，特别是代表皇帝出使或者巡视地方的官员。元封五年（公元前 107 年），汉武帝将天下划分为 13 州，每州各派刺史一人监察所属州的郡国官员 [2]。在众多地方官员中，刺史身负皇命，直接向皇帝负责，因此被称为使君，此外监察北军的北军中候，领护西羌的护羌校尉等被皇帝授予特殊使命的官员也被称为使君。\n使君最早出现在汉书中是在《汉书・卷六十六》。武帝末年，各地郡县盗贼群起，武帝任命暴胜之为直指使者，穿著绣衣，持御赐上方斧，故称为绣衣御史。暴胜之巡查各地，追捕盗贼诛杀两千石以下不听从命令的官吏。当暴胜之来到被阳时想要诛杀时任被阳县令王欣，而王欣已经解开衣服趴在案上，跟暴胜之说：“使君手握生杀的权利，已经威震郡国，今天再把我杀了，不足以增添您的权威。不如根据情况有所宽大，表明您的仁义，我愿意以后尽全力报答”。颜师古在此处作注称，暴胜之是皇帝的使者，故称为使君。[3] 汉书中还有一处称呼使君的地方，出自《汉书・卷七十二》。王莽掌权后，故渤海太守、光禄大夫龚胜辞官回乡。等到王莽篡国，王莽多次派遣五威将帅、使者慰问龚胜，并征召龚胜担任太子师友祭酒，龚胜屡次拒绝，最终绝食而死。[4]\n《后汉书》、《三国志》中有关使君的记载统计如下：\n\n《后汉书・卷四十六》护羌校尉邓训 [5]\n《后汉书・卷四十六》更始帝使者 [6]\n《后汉书・卷六十一》并州牧郭伋 [7]\n《后汉书・卷七十一》兖州刺史第五种 [8]\n《后汉书・卷八十二》司隶校尉陈禅 [9]\n《后汉书・卷八十八》凉州刺史耿鄙 [10]\n《后汉书・卷八十八》凉州刺史梁鹄 [11]\n《后汉书・卷八十八》凉州刺史左昌 [12]\n《后汉书・卷一百》兖州牧曹操 [13]\n《后汉书・卷一百四》荆州刺史刘表 [14]\n《后汉书・卷一百五》扬州牧袁术 [15]\n《后汉书・卷一百十三》冀州刺史 [16]\n《后汉书・卷一百十七》中郎将任尚 [17]\n《三国志・魏志八》引韦曜《吴书》徐州牧陶谦 [18]\n《三国志・魏志十》兖州牧曹操 [19]\n《三国志・魏志十一》青州牧袁谭 [20]\n《三国志・魏志十四》兖州牧曹操 [21]\n《三国志・魏志二十三》引傅畅《晋诸公赞》代指上司 [22]\n《三国志・魏志二十四》幽州刺史崔林 [23]\n《三国志・魏志二十五》引皇甫谧《列女传》凉州刺史韦康 [24]\n《三国志・魏志二十八》引《魏略》兖州刺史令狐愚 [25][26]\n《三国志・魏志二十九》冀州刺史裴徽 [27]\n《三国志・魏志三十》辅国将军鲜于辅 [28]\n《三国志・蜀志一》益州牧刘璋 [29]\n《三国志・蜀志二》豫州刺史刘备 [30]\n《三国志・蜀志二》左将军、豫州牧刘备 [1:1]\n《三国志・蜀志二》益州牧刘璋 [31]\n《三国志・蜀志十五》尚书邓芝 [32]\n《三国志・吴志一》引张勃《吴录》荆州刺史王叡 [33]\n《三国志・吴志一》引虞溥《江表传》扬州刺史、徐州伯袁术 [34][35]\n《三国志・吴志四》兖州刺史 [36]\n《三国志・吴志七》豫州牧诸葛瑾 [37]\n《三国志・吴志十五》大司马、扬州牧曹休 [38]\n《三国志・吴志十九》荆州牧诸葛恪 [39]\n\n上述统计中共出现刺史 13 人、司隶校尉 1 人、州牧 10 人、护羌校尉 1 人、中郎将 1 人、辅国将军 1 人、尚书 1 人、使者 1 人、不明上司 1 人（曹操、袁术、刘璋重复出现总计 4 次）。其中刺史为中央派至地方的监察官；司隶校尉是监察中央和司隶地区[40] 官员的监察官[41]；州牧由刺史升格而来；护羌校尉管理西羌事务，在晋惠帝元康时期被并入凉州刺史职责中 [42]；中郎将、辅国将军、尚书职责变化较大，但任尚、鲜于辅等人也应当有监察西羌、鲜卑各部的职责。\n府君 ¶\n府君在汉代多是对国相、太守的尊称，在《后汉书》和《三国志》的例子包括：\n\n《后汉书・卷三》郁林太守刘外（光武帝刘秀曾祖父，景帝曾孙，长沙定王刘发之孙，舂陵节侯刘买次子）[43]\n《后汉书・卷五》郁林太守刘外 [44]\n《后汉书・卷四十六》上谷太守耿况 [6:1]\n《后汉书・卷六十七》沛国相郭府君 [45]\n《后汉书・卷六十九》彭城太守孙萌 [46]\n《后汉书・卷七十三》南阳太守阮况 [47]\n《后汉书・卷八十六》南阳太守王畅 [48]\n《三国志・魏志二十三》河内太守王匡 [49]\n《三国志・魏志二十九》广陵太守陈登 [50]\n《三国志・吴志四》交址太守士燮 [51]\n\n总结 ¶\n总体而言，在两汉三国时期，使君多用于称呼刺史以及与刺史同一级别的，带有监察性质或特殊使命的官员，而府君多用于称呼太守、国相。在两汉之后，使君、府君的使用范围逐渐扩大，演变为对他人的泛用尊称，例如：\n\n《世说新语・规茂》:\n  闻贺司空出，至破冈，连名诣贺诉。贺曰 “身被微作礼官，不关此事。” 群小叩头曰：“若府君复不见治，便无所诉。”\n\n\n《宋史・外戚列传第二百二十二》:\n  知青涧城种世衡又遣王嵩以枣及画龟为书置蜡丸中遗旺荣，谕以早归之意，欲元昊得之，疑旺荣。旺荣得之笑曰：「种使君亦长矣，何为此儿戏耶！」\n\n参考资料 ¶\n\n曹操为什么称呼刘备 “使君”，而 “使君” 一般代指何人？\n颜师古注《汉书》\n李贤注《后汉书》\n裴松之注《三国志》\n吴会娟. 中古汉语谦敬称谓研究 [D].南京师范大学, 2008.\n田顺芝.《三国演义》称谓词研究 [D].山东大学, 2007.\n\n参考典籍所注内容字号均小于原文，位于下标位置。\n\n\n\n\n《三国志・蜀志二》：先主未出时，献帝舅车骑将军董承臣松之按：董承，汉灵帝母董太后之侄，于献帝为丈人。盖古无丈人之名，故谓之舅也。辞受帝衣带中密诏，当诛曹公。先主未发。是时曹公从容谓先主曰：「今天下英雄，惟使君与操耳。本初之徒，不足数也。」 ↩︎ ↩︎\n\n《汉书・卷六・武帝纪》：初置刺史部十三州。师古曰：「汉旧仪云初分十三州，假刺史印绶，有常治所。常以秋分行部，御史为驾四封乘传。到所部，郡国各遣一吏迎之界上，所察六条。」 ↩︎\n\n《汉书・卷六十六・公孙刘田王杨蔡陈郑传第三十六》：武帝末，军旅数发，郡国盗贼羣起，绣衣御史暴胜之使持斧逐捕盗贼，以军兴从事，诛二千石以下。胜之过被阳，欲斩欣，欣已解衣伏质师古曰：「质，鍖也，欲斩人皆伏于鍖上也。鍖音竹林反。」，仰言曰：「使君颛杀生之柄师古曰：「为使者，故谓之使君。使音所吏反。颛与专同。」，威震郡国，今复斩一欣，不足以增威，不如时有所宽，以明恩贷师古曰：「贷犹假也，言饶假之。贷音土戴反。」，令尽死力。」 ↩︎\n\n《汉书・卷七十二・王贡两龚鲍传第四十二》：使者入户，西行南面立，致诏付玺书，迁延再拜奉印绶，内安车驷马，进谓胜曰：「圣朝未甞忘君，制作未定，待君为政，思闻所欲施行，以安海内。」胜对曰：「素愚，加以年老被病，命在朝夕，随使君上道师古曰：「示若尊敬使者，故谓之使君。」，必死道路，无益万分。」 ↩︎\n\n《后汉书・卷四十六・邓𡨥列传第六》：由是湟中诸胡湟中，月氏胡所居，今鄯州湟水县也。皆言：「汉家常欲鬬我曹，今邓使君待我以恩信，开门内我妻子，乃得父母！」咸欢喜叩头曰：「唯使君所命。」训遂抚养其中少年勇者数百人，以为义从。 ↩︎\n\n《后汉书・卷四十六・邓𡨥列传第六》：王莽败，更始立，使使者徇郡国，曰「先降者复爵位」。恂从耿况迎使者于界上，况上印绶，使者纳之，一宿无还意。恂勒兵入见使者，就请之。使者不与，曰：「天王使者，功曹欲胁之邪？」恂曰：「非敢胁使君君者，尊之称也。，窃伤计之不详也。今天下初定，国信未宣，使君建节衔命以临四方，郡国莫不延颈倾耳，望风归命。今始至上谷而先堕大信堕，毁也。，沮向化之心，生离畔之隙，将复何以号令它郡乎？且耿府君在上谷，乆为吏人所亲，今易之，得贤则造次未安，不贤则秖更生乱。为使君计，莫若复之以安百姓。」 ↩︎ ↩︎\n\n《后汉书・卷六十一・郭杜孔张廉王苏羊贾陆列传》：始至行部，到西河美稷，有童儿数百，各骑竹马，道次迎拜。伋问「儿曹何自远来」曹，辈也。。对曰：「闻使君到，喜，故来奉迎。」伋辞谢之。及事讫，诸儿复送至郭外，问「使君何日当还」。伋谓别驾从事，计日当告之。 ↩︎\n\n《后汉书・卷七十一・第五锺离宋寒列传》：初，种为衞相，以门下掾孙斌贤，善遇之。及当徙斥，斌具闻超谋，乃谓其友人同县闾子直及高密甄子然曰：「盖盗憎其主，从来旧矣。第五使君当投裔土，而单超外属为彼郡守。夫危者易仆，可为寒心。吾今方追使君，庶免其难。若奉使君以还，将以付子。」 ↩︎\n\n《后汉书・卷八十二・崔駰列传》：时陈禅为司隷校尉，召瑗谓曰：「弟听祇上书，禅请为之证。」弟，但也。司马相如传曰：「弟如临邛。」瑗曰：「此譬犹儿妾屏语耳，愿使君勿复出口。」遂辞归，不复应州郡命。 ↩︎\n\n《后汉书・卷八十八・虞傅盖臧列传》：时刺史耿鄙委任治中程球，球为通奸利，士人怨之汉官曰，司隷功曹从事，即持中也。。中平四年，鄙率六郡兵讨金城贼王国、韩遂等。爕知鄙失衆，必败，谏曰：「使君统政日浅，人未知敎。孔子曰：『不敎人战，是谓弃之。』今率不习之人，越大陇之阻，将十举十危，而贼闻大军将至，必万人一心。边兵多勇，其锋难当，而新合之衆，上下未和，万一内变，虽悔无及。不若息军养德，明赏必罚。贼得宽挺挺，解也。，必谓我怯，羣恶争埶，其离可必。然后率已敎之人，讨已离之贼，其功可坐而待也。今不为万全之福，而就必危之祸，窃为使君不取。」鄙不从。行至狄道，果有反者，先杀程球，次害鄙，贼遂进围汉阳。城中兵少粮尽，爕犹固守。 ↩︎\n\n《后汉书・卷八十八・虞傅盖臧列传》：凉州刺史梁鹄畏惧贵戚，欲杀正和以免其负，乃访之于勋。勋素与正和有仇，或劝勋可因此报隙。勋曰：「不可。谋事杀良，非忠也；乘人之危，非仁也。」乃谏鹄曰：「夫绁食鹰鸢欲其鸷绁，系也。广雅曰：「鸷，执也。」苍颉解诂曰：「鸢，鸱也。」食音嗣。，鸷而亨之，将何用哉？」鹄从其言。正和喜于得免，而诣勋求谢。勋不见，曰：「吾为梁使君谋，不为苏正和也。」怨之如初。 ↩︎\n\n《后汉书・卷八十八・虞傅盖臧列传》：中平元年，北地羌胡与边章等寇乱陇右，刺史左昌因军兴断盗数千万断谓割截。。…… 皆曰：「左使君若早从君言，以兵临我，庶可自改。今罪已重，不得降也。」乃解围而去。昌坐断盗徵，以扶风宋枭代之续汉书「枭」字作「泉」也。。 ↩︎\n\n《后汉书・卷一百・郑孔荀列传》：兴平元年，操东击陶谦，使彧守甄城县名，属济阴郡，今濮州县也。「甄」今作「鄄」，音绢。，任以留事。会张邈、陈宫以兖州反操典略「宫字公台，东郡人。刚直烈壮，少与海内知名之士皆相连结」也。，而潜迎吕布。布旣至，诸城悉应之。邈乃使人谲彧曰谲，诈也。：「吕将军来助曹使君击陶谦，宜亟供军实。」 ↩︎\n\n《后汉书・卷一百四・袁绍刘表列传下》：初平元年，长沙太守孙坚杀荆州刺史王睿王氏谱曰：「睿字通曜，晋太保祥之伯父也。」吴录曰：「睿见执，惊曰：『我何罪？』坚曰：『坐无所知。』睿穷迫，刮金饮之而死。」，诏书以表为荆州刺史。时江南宗贼大盛，宗党共为贼。又袁术阻兵屯鲁阳，表不能得至，乃单马入宜城宜城，县，属南郡，本鄢，惠帝三年改名宜城。，请南郡人蒯越、襄阳人蔡瑁与共谋画傅子曰：「越字异度，魏太祖平荆州，与荀彧书曰：『不喜得荆州，喜得异度耳。』」。表谓越曰：「宗贼虽盛而衆不附，若袁术因之，祸必至矣。吾欲徵兵，恐不能集，其策焉出？」对曰：「理平者先仁义，理乱者先权谋。兵不在多，贵乎得人。袁术骄而无谋，宗贼率多贪暴。越有所素养者，使人示之以利，必持衆来。使君诛其无道，施其才用，威德旣行，襁负而至矣。兵集衆附，南据江陵，北守襄阳，荆州八郡汉官仪曰，荆州管长沙、零陵、桂阳、南阳、江夏、武陵、南郡、章陵等是也。可传檄而定。公路虽至，无能为也。」表曰：「善。」 ↩︎\n\n《后汉书・卷一百五・刘焉袁术吕布列传》：自孙坚死，子策复领其部曲，术遣击杨州刺史刘繇，破之，策因据江东。策闻术将欲僭号，与书谏曰：「董卓无道，陵虐王室，祸加太后，暴及弘农，天子播越，左传曰，王子朝云「兹不谷震荡播越」。播，迁也。越，逸也。言失其所居。宫庙焚毁，是以豪桀发愤，沛然俱起。沛然，自恣纵貌也。沛音片害反。元恶旣毙，幼主东顾，乃使王人奉命，宣明朝恩，偃武修文，与之更始。然而河北异谋于黑山，谓袁绍为兾州牧，与黑山贼相连。曹操毒被于东徐，刘表僭乱于南荆，公孙叛逆于朔北，正礼阻兵，刘繇也。玄德争盟，刘备也。是以未获从命，櫜弓戢戈。当谓使君与国同规，而舍是弗恤，完然有自取之志，完然，自得貌。惧非海内企望之意也。成汤讨桀，称『有夏多罪』；尚书汤誓曰：「有夏多罪，天命殛之。」武王伐纣，曰『殷有重罚』。史记曰：「武王遍告诸侯曰：『殷有重罚，不可不伐。』」此二王者，虽有圣德，假使时无失道之过，无由逼而取也。今主上非有恶于天下，徒以幼子胁于强臣，异于汤武之时也。又闻幼主明智聦敏，有夙成之德，夙，早也。天下虽未被其恩，咸归心焉。若辅而兴之，则旦、奭之美，率土所望也。使君五世相承，安生京，京生汤，汤生逢，逢生术，凡五代。为汉宰辅，荣宠之盛，莫与为比，宜効忠守节，以报王室。时人多惑图纬之言，妄牵非类之文，苟以恱主为美，不顾成败之计，古今所慎，可不孰虑！忠言逆耳，驳议致憎，驳，杂也，议不同也。前书张良曰：「忠言逆耳利于行，良药苦口利于病。」苟有益于尊明，无所敢辞。」术不纳，策遂绝之。 ↩︎\n\n《后汉书・卷一百十三・逸民列传》：台佟字孝威，佟音大冬反。魏郡邺人也。隐于武安山，武安县之山也。凿穴为居，采药自业。建初中，州辟不就。刺史行部，乃使从事致谒。佟载病往谢。刺史乃执贽见佟曰：嵇康高士传曰：「刺史执枣栗之贽往。」「孝威居身如是，甚苦，如何？」佟曰：「佟幸得保终性命，存神养和。如明使君奉宣诏书，夕惕庶事，反不苦邪？」遂去，隐逸，终不见。 ↩︎\n\n《后汉书・卷一百十七・西羌传》：后遣任尚为中郎将，将羽林、缇骑、五营子弟三千五百人，代班雄屯三辅。尚临行，怀令虞诩说尚曰：「使君频奉国命讨逐寇贼，三州屯兵二十馀万人，弃农桑，疲苦徭役，而未有功効，劳费日滋。若此出不克，诚为使君危之。」尚曰：「忧惶乆矣，不知所如。」诩曰：「兵法弱不攻强，走不逐飞，自然之埶也。今虏皆马骑，日行数百，来如风雨，去如绝弦，以步追之，埶不相及，所以旷而无功也。为使君计者，莫如罢诸郡兵，各令出钱数千，二十人共市一马，如此，可舍甲胄，驰轻兵，以万骑之衆，逐数千之虏，追尾掩𢧵，尾犹寻也。其道自穷。便人利事，大功立矣。」尚大喜，即上言用其计。乃遣轻骑钞击杜季贡于丁奚城，斩首四百馀级，获牛马羊数千头。 ↩︎\n\n《三国志・魏志八》：兴平元年，复东征，略定琅邪、东海诸县。谦恐，欲走归丹杨。会张邈叛迎吕布，太祖还击布。是岁，谦病死。吴书曰：谦死时，年六十三，张昭等为之哀辞曰：“猗欤使君，君侯将军，膺秉懿德，允武允文，体足刚直，守以温仁。令舒及卢，遗爱于民；牧幽曁徐，甘棠是均。憬憬夷貊，赖侯以清；蠢蠢妖寇，匪侯不宁。唯帝念绩，爵命以章，旣牧且侯，启土溧阳。遂升上将，受号安东，将平世难，社稷是崇。降年不永，奄忽殂薨，丧覆失恃，民知困穷。曾不旬日，五郡溃崩，哀我人斯，将谁仰凭？追思靡及，仰叫皇穹。呜呼哀哉！” 谦二子：商、应，皆不仕。 ↩︎\n\n《三国志・魏志十》：明年，太祖领兖州牧，后为镇东将军，彧常以司马从。兴平元年，太祖征陶谦，任彧留事。会张邈、陈宫以兖州反，潜迎吕布。布旣至，邈乃使刘翊告彧曰：「吕将军来助曹使君击陶谦，宜亟供其军食。」 ↩︎\n\n《三国志・魏志十一》：谭复欲攻尚，修谏曰：「兄弟还相攻击，是败亡之道也。」谭不恱，然知其忠节。后又问修：「计安出？」修曰：「夫兄弟者，左右手也。譬人将鬬而断其右手，而曰『我必胜』，若是者可乎？夫弃兄弟而不亲，天下其谁亲之！属有谗人，固将交鬬其间，以求一朝之利，愿明使君塞耳勿听也。若斩佞臣数人，复相亲睦，以御四方，可以横行天下。」谭不听，遂与尚相攻击，请救于太祖。 ↩︎\n\n《三国志・魏志十四》：刘岱为黄巾所杀。太祖临兖州，辟昱。…… 昱乃归，过范，说其令靳允曰：「闻吕布执君母弟妻子，孝子诚不可为心！今天下大乱，英雄并起，必有命世，能息天下之乱者，此智者所详择也。得主者昌，失主者亡。陈宫叛迎吕布而百城皆应，似能有为，然以君观之，布何如人哉！夫布，粗中少亲，刚而无礼，匹夫之雄耳。宫等以势假合，不能相君也。兵虽衆，终必无成。曹使君智略不世出，殆天所授！君必固范，我守东阿，则田单之功可立也。孰与违忠从恶而母子俱亡乎？唯君详虑之！」允流涕曰：「不敢有贰心。」时泛嶷已在县，允乃见嶷，伏兵刺杀之，归勒兵守。 ↩︎\n\n《三国志・魏志二十三》：繇为人机捷，善持论，而干讷口，临时屈无以应。繇谓干曰：「公羊高竟为左丘明服矣。」干曰：「直故吏为明使君服耳，公羊未肯也。」 ↩︎\n\n《三国志・魏志二十四》：文帝践阼，拜尚书，出为幽州刺史。北中郎将吴质统河北军事，涿郡太守王雄谓林别驾曰：「吴中郎将，上所亲重，国之贵臣也。杖节统事，州郡莫不奉笺致敬，而崔使君初不与相闻。若以边塞不修斩卿，使君宁能护卿邪？」 ↩︎\n\n《三国志・魏志二十五》：陇右平定，太祖封讨超之功，侯者十一人，赐阜爵关内侯。阜让曰：「阜君存无捍难之功，君亡无死节之効，于义当绌，于法当诛；超又不死，无宜苟荷爵禄。」太祖报曰：「君与羣贤共建大功，西土之人以为美谈。子贡辞赏，仲尼谓之止善。君其剖心以顺国命。姜叙之母，劝叙早发，明智乃尔，虽杨敞之妻盖不过此。贤哉，贤哉！良史记录，必不坠于地矣。」皇甫谧列女传曰：姜叙母者，天水姜伯弈之母也。建安中，马超攻兾，害凉州刺史韦康，州人凄然，莫不感愤。叙为抚夷将军，拥兵屯历。叙姑子杨阜，故为康从事，同等十馀人，皆略属超，阴相结为康报仇，未有闲。会阜妻死，辞超宁归西，因过至历，候叙母，说康被害及兾中之难，相对泣良乆。姜叙举室感悲，叙母曰：「咄！伯弈，韦使君遇难，岂一州之耻，亦汝之负，岂独义山哉？汝无顾我，事淹变生。人谁不死？死国，忠义之大者。但当速发，我自为汝当之，不以馀年累汝也。」 ↩︎\n\n《三国志・魏志二十八》：魏书曰：愚字公浩，本名浚，黄初中，为和戎护军。乌丸校尉田豫讨胡有功，小违节度，愚以法绳之。帝怒，械系愚，免官治罪，诏曰「浚何愚」！遂以名之。正始中，为曹爽长史，后出为兖州刺史。魏畧曰：愚闻楚王彪有智勇。初东郡有譌言云：「白马河出妖马，夜过官牧边鸣呼，衆马皆应，明日见其迹，大如斛，行数里，还入河中。」又有谣言：「白马素羁西南驰，其谁乘者朱虎骑。」楚王小字朱虎，故愚与王淩阴谋立楚王。乃先使人通意于王，言「使君谢王，天下事不可知，愿王自爱」！彪亦阴知其意，荅言「谢使君，知厚意也。」 ↩︎\n\n《三国志・魏志二十八》：魏畧载：山阳单固，字恭夏，为人有器实。正始中，兖州刺史令狐愚与固父伯龙善，辟固，欲以为别驾。固不乐为州吏，辞以疾。愚礼意愈厚，固不欲应。固母夏侯氏谓固曰：「使君与汝父乆善，故命汝不止，汝亦故当仕进，自可往耳。」固不获已，遂往，与兼治中从事杨康并为愚腹心。后愚与王淩通谋，康、固皆知其计。会愚病，康应司徒召诣洛阳，固亦以疾解禄。康在京师露其事，太傅乃东取王淩。到寿春，固见太傅，太傅问曰：「卿知其事为邪？」固对不知。太傅曰：「且置近事。问卿，令狐反乎？」固又曰无。而杨康白，事事与固连。遂收捕固及家属，皆系廷尉，考实数十，固故云无有。太傅录杨康，与固对相诘。固辞穷，乃骂康曰：「老庸旣负使君，又灭我族，顾汝当活邪！」 ↩︎\n\n《三国志・魏志二十九》：当此之时，辂之邻里，外户不闭，无相偷窃者。清河太守华表，召辂为文学掾。安平赵孔曜荐辂于兾州刺史裴徽曰：「辂雅性宽大，与世无忌，仰观天文则同妙甘公、石申，俯览周易则齐思季主。今明使君方垂神幽薮，留精九臯，辂宜蒙阴和之应，得及羽仪之时。」徽于是辟为文学从事，引与相见，大善友之。徙部钜鹿，迁治中别驾。 ↩︎\n\n《三国志・魏志三十》：比能使别小帅琐奴拒豫，豫进讨，破走之，由是怀贰。乃与辅国将军鲜于辅书曰：「夷狄不识文字，故校尉阎柔保我于天子。我与素利为雠，往年攻击之，而田校尉助素利。我临阵使琐奴往，闻使君来，即便引军退。步度根数数钞盗，又杀我弟，而诬我以钞盗。我夷狄虽不知礼义，兄弟子孙受天子印绶，牛马尚知美水草，况我有人心邪！将军当保明我于天子。」辅得书以闻帝，帝复使豫招纳安慰。 ↩︎\n\n《三国志・蜀志一》：州大吏赵韪等贪璋温仁，共上璋为益州刺史，诏书因以为监军使者，领益州牧，以韪为征东中郎将，率衆击刘表。…… 璋复遣别驾张松诣曹公，曹公时已定荆州，走先主，不复存录松，松以此怨。会曹公军不利于赤壁，兼以疫死。松还，疵毁曹公，劝璋自绝，汉书春秋曰：张松见曹公，曹公方自矜伐，不存录松。松归，乃劝璋自绝。习凿齿曰：昔齐桓一矜其功而叛者九国，曹操暂自骄伐而天下三分，皆勤之于数十年之内而弃之于俯仰之顷，岂不惜乎！是以君子劳谦日仄，虑以下人，功高而居之以让，势尊而守之以卑。情近于物，故虽贵而人不猒其重；德洽羣生，故业广而天下愈欣其庆。夫然，故能有以富贵，保其功业，隆显当时，传福百世，何骄矜之有哉！君子是以知曹操之不能遂兼天下者也。因说璋曰：「刘豫州，使君之肺腑，可与交通。」璋皆然之，遣法正连好先主，寻又令正及孟达送兵数千助先主守御，正遂还。 ↩︎\n\n《三国志・蜀志二》：谦表先主为豫州刺史，屯小沛。谦病笃，谓别驾麋竺曰：「非刘备不能安此州也。」谦死，竺率州人迎先主，先主未敢当。下邳陈登谓先主曰：「今汉室陵迟，海内倾覆，立功立事，在于今日。彼州殷富，户口百万，欲屈使君抚临州事。」先主曰：「袁公路近在寿春，此君四世五公，海内所归，君可以州与之。」登曰：「公路骄豪，非治乱之主。今欲为使君合步骑十万，上可以匡主济民，成五霸之业，下可以割地守境，书功于竹帛。若使君不见听许，登亦未敢听使君也。」 ↩︎\n\n《三国志・蜀志二》：十六年，益州牧刘璋遥闻曹公将遣锺繇等向汉中讨张鲁，内怀恐惧。别驾从事蜀郡张松说璋曰：「曹公兵强无敌于天下，若因张鲁之资以取蜀土，谁能御之者乎？」璋曰：「吾固忧之而未有计。」松曰：「刘豫州，使君之宗室而曹公之深雠也，善用兵，若使之讨鲁，鲁必破。鲁破，则益州强，曹公虽来，无能为也。」璋然之，遣法正将四千人迎先主，前后赂遗以巨亿计。正因陈益州可取之策。 ↩︎\n\n《三国志・蜀志十五》：（芝）所在清严有治绩，入为尚书。先主薨于永安。先是，吴王孙权请和，先主累遣宋玮、费禕等与相报荅。丞相诸葛亮深虑权闻先主殂陨，恐有异计，未知所如。芝见亮曰：「今主上幼弱，初在位，宜遣大使重申吴好。」亮荅之曰：「吾思之乆矣，未得其人耳，今日始得之。」芝问其人为谁？亮曰：「即使君也。」乃遣芝修好于权。 ↩︎\n\n《三国志・吴志一》：灵帝崩，卓擅朝政，横恣京城。诸州郡并兴义兵，欲以讨卓。江表传曰：坚闻之，拊膺叹曰：「张公昔从吾言，朝廷今无此难也。」坚亦举兵。荆州刺史王睿素遇坚无礼，坚过杀之。案王氏谱，睿字通耀，晋太保祥伯父也。吴录曰：睿先与坚共击零、桂贼，以坚武官，言颇轻之。及睿举兵欲讨卓，素与武陵太守曹寅不相能，杨言当先杀寅。寅惧，诈作案行使者光禄大夫温毅檄，移坚，说睿罪过，令收行刑讫，以状上。坚即承檄勒兵袭睿。睿闻兵至，登楼望之，遣问欲何为，坚前部荅曰：「兵乆战劳苦，所得赏，不足以为衣服，诣使君更乞资直耳。」睿曰：「刺史岂有所吝？」便开库藏，使自入视之，知有所遗不。兵进及楼下，睿见坚，惊曰：「兵自求赏，孙府君何以在其中？」坚曰：「被使者檄诛君。」睿曰：「我何罪？」坚曰：「坐无所知。」睿穷迫，刮金饮之而死。 ↩︎\n\n《三国志・吴志一》：徐州牧陶谦深忌策。策舅吴景，时为丹杨太守，策乃载母徙曲阿，与吕范、孙河俱就景，因缘召募得数百人。兴平元年，从袁术。术甚奇之，以坚部曲还策。江表传曰：策径到寿春见袁术，涕泣而言曰：「亡父昔从长沙入讨董卓，与使君会于南阳，同盟结好；不幸遇难，勋业不终。策感惟先人旧恩，欲自凭结，愿明使君垂察其诚。」术甚贵异之，然未肯还其父兵。术谓策曰：「孤始用贵舅为丹杨太守，贤从伯阳为都尉，彼精兵之地，可还依召募。」策遂诣丹杨依舅，得数百人，而为泾县大帅祖郎所袭，几至危殆。于是复往见术，术以坚馀兵千馀人还策。 ↩︎\n\n《三国志・吴志一》：策乃说术，乞助景等平定江东。江表传曰：策说术云：「家有旧恩在东，愿助舅讨横江；横江拔，因投本土召募，可得三万兵，以佐明使君匡济汉室。」术知其恨，而以刘繇据曲阿，王朗在会稽，谓策未必能定，故许之。 ↩︎\n\n《三国志・吴志四》：平原陶丘洪荐繇，欲令举茂才。刺史曰：「前年举公山，柰何复举正礼乎？」洪曰：「若明使君用公山于前，擢正礼于后，所谓御二龙于长涂，骋骐骥于千里，不亦可乎！」 ↩︎\n\n《三国志・吴志七》：颍川周昭著书称步骘及严畯等曰：「古今贤士大夫所以失名丧身倾家害国者，其由非一也，然要其大归，总其常患，四者而已。急而论议一也，争名势二也，重朋党三也，务欲速四也。急论议则伤人，争名势则败友，重朋党则蔽主，务欲速则失德，此四者不除，未有能全也。当世君子能不然者，亦比有之，岂独古人乎！然论其绝异，未若顾豫章、诸葛使君、步丞相、严衞尉、张奋威之为美也。论语言『夫子恂恂然善诱人』，又曰『成人之美，不成人之恶』，豫章有之矣。『望之俨然，即之也温，听其言也厉』，使君体之矣。『恭而安，威而不猛』，丞相履之矣。学不求禄，心无苟得，衞尉、奋威蹈之矣。此五君者，虽德实有差，轻重不同，至于趣舍大检，不犯四者，俱一揆也。昔丁諝出于孤家，吾粲由于牧竖，豫章扬其善，以并陆、全之列，是以人无幽滞而风俗厚焉。使君、丞相、衞尉三君，昔以布衣俱相友善，诸论者因各叙其优劣。初，先衞尉，次丞相，而后有使君也；其后并事明主，经营世务，出处之才有不同，先后之名须反其初，此世常人所决勤薄也。至于三君分好，卒无亏损，岂非古人交哉！又鲁横江昔杖万兵，屯据陆口，当世之美业也，能与不能，孰不愿焉？而横江旣亡，衞尉应其选，自以才非将帅，深辞固让，终于不就。后徙九列，迁典八座，荣不足以自曜，禄不足以自奉。至于二君，皆位为上将，穷富极贵。衞尉旣无求欲，二君又不称荐，各守所志，保其名好。孔子曰：『君子矜而不争，羣而不党。』斯有风矣。又奋威之名，亦三君之次也，当一方之戍，受上将之任，与使君、丞相不异也。然历国事，论功劳，实有先后，故爵位之荣殊焉。而奋威将处此，决能明其部分，心无失道之欲，事无充诎之求，每升朝堂，循礼而动，辞气謇謇，罔不惟忠。叔嗣虽亲贵，言忧其败，蔡文至虽疏贱，谈称其贤。女配太子，受礼若吊，慷忾之趋，惟笃人物，成败得失，皆如所虑，可谓守道见机，好古之士也。若乃经国家，当军旅，于驰骛之际，立霸王之功，此五者未为过人。至其纯粹履道，求不苟得，升降当世，保全名行，邈然绝俗，实有所师。故粗论其事，以示后之君子。」周昭者字恭远，与韦曜、薛莹、华核并述吴书，后为中书郎，坐事下狱，核表救之，孙休不听，遂伏法云。 ↩︎\n\n《三国志・吴志十五》：被命密求山中旧族名帅为北敌所闻知者，令谲挑魏大司马扬州牧曹休。鲂答，恐民帅小丑不足仗任，事或漏泄，不能致休，乞遣亲人赍笺七条以诱休：…… 一则伤慈损计，二则杜绝向化者心，惟明使君远览前世，矜而愍之，留神所质，速赐秘报。…… 愿明使君少垂详察，忖度其言。今此郡民，虽外名降首，而故在山草，看伺空隙，欲复为乱，为乱之日，鲂命讫矣。…… 若明使君以万兵从皖南首江渚，鲂便从此率厉吏民，以为内应。此方诸郡，前后举事，垂成而败者，由无外援使其然耳；若北军临境，传檄属城，思咏之民，谁不企踵？愿明使君上观天时，下察人事，中参蓍龟，则足昭往言之不虚也。…… 私恐使君未深保明，岑、南二人可留其一，以为后信。…… 今使君若从皖道进住江上，鲂当从南对岸历口为应。…… 明使君速垂救济，诚宜疾密。王靖之变，其鉴不远。今鲂归命，非复在天，正在明使君耳。若见救以往，则功可必成，如见救不时，则与靖等同祸。前彭绮时，闻旌麾在逢龙，此郡民大小欢喜，并思立效。若留一月日间，事当大成，恨去电速，东得增衆专力讨绮，绮始败耳。愿使君深察此言。 ↩︎\n\n《三国志・吴志十九》：会逊卒，恪迁大将军，假节，驻武昌，代逊领荆州事。……\t及将见，驻车宫门，峻已伏兵于帷中，恐恪不时入，事泄，自出见恪曰：「使君若尊体不安，自可须后，峻当具白主上。」欲以甞知恪。恪荅曰：「当自力入。」散骑常侍张约、朱恩等密书与恪曰：「今日张设非常，疑有他故。」恪省书而去。未出路门，逢太常滕胤，恪曰：「卒腹痛，不任入。」胤不知峻阴计，谓恪曰：「君自行旋未见，今上置酒请君，君已至门，宜当力进。」恪踌躇而还，劒履上殿，谢亮，还坐。设酒，恪疑未饮，峻因曰：「使君病未善平，当有常服药酒，自可取之。」 ↩︎\n\n司隶地区：首都及其周边地区，在两汉指三辅、三河以及弘农地区，包括京兆尹、左冯翊、右扶风、河东、河南、河内和弘农。 ↩︎\n\n《汉书・百官公卿表》：司隶校尉，周官，武帝征和四年初置。持节，从中都官徒千二百人，捕巫蛊，督大奸猾。后罢其兵。察三辅、三河、弘农。元帝初元四年去节。成帝元延四年省。绥和二年，哀帝复置，但为司隶，冠进贤冠，属大司空，比司直。 ↩︎\n\n《晋书・志第十四・职官》：护羌、夷、蛮等校尉，案武帝置南蛮校尉于襄阳，西戎校尉于长安，南夷校尉于宁州。元康中，护羌校尉为凉州刺史，西戎校尉为雍州刺史，南蛮校尉为荆州刺史。及江左初，省南蛮校尉，寻又置于江陵，改南夷校尉曰镇蛮校尉。及安帝时，于襄阳置宁蛮校尉。 ↩︎\n\n《后汉书・卷三・帝纪第三肃宗孝章皇帝》：辛丑，幸章陵，祠旧宅园庙，见宗室故人，赏赐各有差。冬十月己未，进幸江陵，诏庐江太守祠南岳，又诏长沙、零陵太守祠长沙定王、舂陵节侯、郁林府君。还，幸宛。十一月己丑，车驾还宫，赐从者各有差。 ↩︎\n\n《后汉书・卷三・帝纪第五孝安皇帝》：庚申，幸宛，帝不豫。辛酉，令大将军耿宝行太尉事。祠章陵园庙，告长沙、零陵太守，祠定王、节侯、郁林府君。乙丑，自宛还。丁卯，幸叶，帝崩于乘舆，年三十二。 ↩︎\n\n《后汉书・卷六十七・桓荣丁鸿列传第二十七》：父麟，字元凤，早有才惠。华峤书曰「酆生麟」也。桓帝初，为议郎，入侍讲禁中，以直道啎左右，出为许令，许，县名，今许州许昌县也。病免。会母终，麟不胜丧，未祥而卒，年四十一。所著碑、诔、赞、说、书凡二十一篇。案挚虞文章志，麟文见在者十八篇，有碑九首，诔七首，七说一首，沛相郭府君书一首。 ↩︎\n\n《后汉书・卷六十九・刘赵淳于江刘周赵列传第二十九》：建武初，平狄将军庞萌反于彭城，攻败郡守孙萌。平时复为郡吏，冒白刃伏萌身上，被七创，困顿不知所为，号泣请曰：「愿以身代府君。」贼乃敛兵止，曰：「此义士也，勿杀。」遂解去。萌伤甚气绝，有顷苏，渴求饮。平倾其创血以饮之。后数日萌竟死，平乃裹创，扶送萌丧，至其本县。 ↩︎\n\n《后汉书・卷七十三・朱乐何列传第三十三》：朱晖字文季，南阳宛人也。…… 后为郡吏，太守阮况甞欲市晖婢，晖不从。东观记曰：「晖为督邮，况当归女，欲买晖婢，晖不敢与。后况卒，晖送其家金三斤。」及况卒，晖乃厚赠送其家。人或讥焉，晖曰：「前阮府君有求于我，所以不敢闻命，诚恐以财货汚君。今而相送，明吾非有爱也。」 ↩︎\n\n《后汉书・卷八十六・张王种陈列传第四十六》：畅字叔茂。…… 由是复为尚书。寻拜南阳太守。…… 郡中豪族多以奢靡相尚，畅常布衣皮褥，车马羸败，以矫其敝。同郡刘表时年十七，从畅受学。进谏曰：「夫奢不僭上，俭不逼下，礼记曰「君子上不僭上，下不逼下」也。循道行礼，贵处可否之闲。蘧伯玉耻独为君子。府君不希孔圣之明训，而慕夷齐之末操，论语孔子曰：「奢则不逊，俭则固。」言仲尼得奢俭之中，而夷齐饥死，是末操也。无乃皎然自贵于世乎？」畅曰：「昔公仪休在鲁，拔园葵，去织妇；史记曰，鲁相公仪休之其家，见织帛，怒而出其妇，食于舍而茹葵，愠而拔其葵，曰：「吾已食禄，又夺园夫女子利乎？」孙叔敖相楚，其子被裘刈薪。史记曰，孙叔敖为楚相，且死，属其子曰：「我死，汝贫困，往见优孟，言孙叔敖子也。」居数年，其子贫，负薪逢优孟。优孟言之于王，封之寝丘四百户也。夫以约失之鲜矣。论语孔子之辞也。言俭则无失。闻伯夷之风者，贪夫廉，懦夫有立志。孟子之辞。虽以不德，敢慕遗烈。」 ↩︎\n\n《三国志・魏志二十三》：常林字伯槐，河内温人也。…… 太守王匡起兵讨董卓，遣诸生于属县微伺吏民罪负，便收之，考责钱谷赎罪，稽迟则夷灭宗族，以崇威严。林叔父檛客，为诸生所白，匡怒收治。举宗惶怖，不知所责多少，惧系者不救。林往见匡同县胡母彪曰：“王府君以文武高才，临吾鄙郡。鄙郡表里山河，土广民殷，又多贤能，惟所择用。今主上幼冲，贼臣虎据，华夏震栗，雄才奋用之秋也。若欲诛天下之贼，扶王室之微，智者望风，应之若响，克乱在和，何征不捷。苟无恩德，任失其人，覆亡将至，何暇匡翼朝廷，崇立功名乎？君其藏之！” 因说叔父见拘之意。 ↩︎\n\n《三国志・魏志二十九》：广陵太守陈登得病，胷中烦懑，靣赤不食。佗脉之曰：“府君胃中有虫数升，欲成内疽，食腥物所为也。” 即作汤二升，先服一升，斯须尽服之。食顷，吐出三升许虫，赤头皆动，半身是生鱼脍也，所苦便愈。佗曰：“此病后三期当发，遇良医乃可济救。” 依期果发动，时佗不在，如言而死。 ↩︎\n\n《三国志・吴志四》：父赐丧阕后，举茂才，除巫令，迁交址太守。…… 燮体器宽厚，谦虚下士，中国士人往依避难者以百数。耽玩春秋，为之注解。陈国袁徽与尚书令荀彧书曰：“交址士府君旣学问优博，又达于从政，处大乱之中，保全一郡，二十馀年疆埸无事，民不失业，羁旅之徒，皆蒙其庆，虽窦融保河西，曷以加之？官事小阕，辄玩习书传，春秋左氏传尤简练精微，吾数以咨问传中诸疑，皆有师说，意思甚密。又尚书兼通古今，大义详备。闻京师古今之学是非忿争，今欲条左氏、尚书长义上之。” 其见称如此。 ↩︎\n\n\n\n","categories":["随记","历史"],"tags":["历史","三国","汉朝","使君","称呼","礼仪"]},{"title":"升级 Umami | 从 Mariadb 迁移至 Postgresql","url":"/posts/202511-umami-migration.html","content":"\n感谢 Gemini Pro 生成的封面图。\n实时统计页面的更新请见V3 版本更新以及 FoxHub fox/umami-stats-scripts\n\n\nUmami 最近升级大版本，从 v3 开始彻底抛弃了 MySQL / Mariadb，转而使用 Postgresql 作为默认数据库。之前有几个别的服务也推荐使用 Postgresql，一直在纠结要不要切过去，但是每次都被庞大的工作量劝阻了（而且还要学很多东西）。现在只能决定折腾一下数据库的迁移了。\n注意：在进行数据库迁移之前，请务必备份数据，以防止意外数据丢失。\n\n以下操作过程均以通过docker compose部署的 Umami 为例，其他部署方式请根据实际情况调整命令，可以参考官方文档。\n\n\n备份现有数据：在进行任何迁移操作之前，确保已经备份了当前的 Mariadb 数据库数据：\n\nmariadb --no-create-info --default-character-set=utf8mb4 --quick --skip-add-locks -u username -p mydb &gt; mydbdump.sql\n\n安装 Postgresql：通过 docker 安装 Postgresql 数据库：\n\nservices:    postgresql:        container_name: postgresql        image: postgres:latest        restart: always        volumes:            - ./data:/var/lib/postgresql            - ./conf:/etc/postgresql/conf.d        environment:            TZ: Asia/Shanghai            POSTGRES_USER: root            POSTGRES_PASSWORD: password...\n\n创建 Umami 数据库：进入 Postgresql 容器，创建 Umami 所需的数据库和用户：\n\ndocker exec -it postgresql psql -U rootCREATE USER umami WITH PASSWORD 'password';CREATE DATABASE umami OWNER umami;\n\n准备一个新的 Umami 实例：使用 Postgresql 作为数据库，启动一个新的 Umami 实例（版本和之前使用 MySQL 或者 Mariadb 的版本一致）：\n\nservices:    umami-postgres:        container_name: umami        image: docker.umami.is/umami-software/umami:postgresql-v2.19.0  # 这里切换成自己之前使用的版本号        restart: always        environment:            DATABASE_URL: postgresql://umami:password@postgresql:5432/umami            DATABASE_TYPE: postgresql            APP_SECRET: 7MbJDvq9P7Ercw            TRACKER_SCRIPT_NAME: Bf5ZmaKLu245LG            TZ: Asia/Shanghai...\n\n截断 Postgresql 中的表：进入新的 Umami 容器，截断 Postgresql 数据库中的部分表：\n\ndocker exec -it postgresql psql -U umami -d umamitruncate table \"_prisma_migrations\";truncate table \"user\";\n本文使用pgloader 工具进行数据迁移，确保已经安装了该工具。Debian / Ubuntu 用户可以使用apt命令安装。\n除此之外，也可使用 Navicat Premium 等图形化工具进行数据迁移，参考 Docker 部署 Umami，切换数据库至 PgSQL。\n\n\n创建导入文件：创建pgloader的配置文件umami.load，内容如下：\n\nLOAD DATABASE     FROM mysql://umami:password@172.19.0.2:3306/umami     INTO pgsql://umami:password@172.19.0.22:5432/umami WITH data only,      create tables,      include no dropALTER SCHEMA 'umami' RENAME TO 'public';\n在 MariaDB / MySQL 数据库中，website_event表的visit_id字段可以为NULL，而在 Postgresql 中该字段不允许为NULL。所以在执行数据迁移时可能报错。为了解决这个问题，可以在迁移前将visit_id字段中的NULL值更新为一个默认值：\nUPDATE website_event SET visit_id = UUID() WHERE visit_id IS NULL;\n但这可能会导致不可知的数据关联问题，请根据实际情况谨慎操作，也可以选择抛弃这部分数据：\nDELETE FROM website_event WHERE visit_id IS NULL;\n\n执行数据迁移：运行pgloader命令，开始迁移数据：\n\npgloader umami.load\n\n验证数据完整性：迁移完成后，检查 Postgresql 数据库中的数据是否完整，确保所有数据都已成功迁移。例如，可以使用以下命令检查表中的记录数：\n\ndocker exec -it postgresql psql -U umami -d umamiSELECT COUNT(*) FROM website_event;\n\nUmami 服务迁移：停止旧的 Umami 服务，启动新的 Umami 服务，确保其连接到 Postgresql 数据库：\n\ndocker compose down umami-mariadbdocker compose up -d umami-postgres\n\n升级 Umami 版本：如果需要升级 Umami 版本，可以在新的 Postgresql 实例上进行升级操作，确保数据和配置保持一致。\n\n","categories":["技术笔记","博客成长日志"],"tags":["Umami","数据库迁移","Postgresql","Mariadb"]},{"title":"Geant4 综合模板","url":"/posts/202502-g4template.html","content":"几年前在 Geant4 示例 中我介绍了 Windows 下 Geant4 的安装与示例。今天分享一个 Geant4 综合模板，帮助快速开始一个项目，实现了以下功能：\n\n构建模块化的 TAS 探测器\n统计模拟过程中的核反应信息，包括类型、反应道、产物能量分布、伽马射线母核统计等 (1, 2)\n利用 Sensitive Detector 统计粒子在探测器中的沉积能量 (3)\n通过 Analysis Manager 保存数据到 ROOT 文件 (4, 5)\n\n模板的核心功能时序图如下：\nsequenceDiagram\nautonumber\npar\n    RunManager-&gt;&gt;RunStat: Initialization\nand\n    RunManager-&gt;&gt;AnalysisManager: Initialization\nend\nRunManager-&gt;&gt;+Run: Begin run\nrect rgb(200, 150, 255)\nRun-&gt;&gt;SD: Initialization\nend\nloop Number of particles\n    Run-&gt;&gt;+Event: Primary Generator\n    Event-&gt;&gt;+Step: Particle Transport\n    loop Particle alive\n        rect rgb(191, 223, 255)\n        alt Have secondary particles\n            Step--&gt;&gt;RunStat: Reaction information\n        else In SD\n            Step--&gt;&gt;SD: Step information\n        end\n        end\n        Step-&gt;&gt;Step: Particle Transport\n    end\n    Step-&gt;&gt;-Event: E = 0 or been absorbed\n    rect rgb(200, 150, 255)\n    SD--&gt;&gt;AnalysisManager: SD statistics\n    end\n    Event-&gt;&gt;-Run: End event\nend\nAnalysisManager--&gt;&gt;Output: Data file (root format or others)\nRun-&gt;&gt;-RunManager: End run\nRunStat--&gt;&gt;Output: Reaction statistics\n\n\n.mermaid {\n    background: var(--heo-background) !important;\n}\n\n\n    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';\n\n主要功能 ¶\nSD，Hits 与 Analysis Manager¶\nSensitive detector 和 Hits 是 Geant4 中的重要工具，用于统计粒子径迹在我们感兴趣的区域沉积的能量。在模板中，我们定义了一个 Sensitive detector: TemplateSD，用于划定感兴趣的区域；以及一个 Hits 类: TemplateHit，用于记录所需要的信息（例如沉积能量、粒子类别、名称等）。\n由于不同人员的需求以及工具喜好不同，Geant4 并没有提供一个完备的数据分析工具，但是通过G4AnalysisManager实现了对于数据的管理。数据可以分为两类：n-tuple和histogram，前者类似于表格，行是每一个事件，列是各种物理信息；后者是对于某一物理量的统计，例如能量分布、角度分布等。G4AnalysisManager类是线程安全的，并且可以自动合并多线程的数据。(5)\nTemplateSD::ProcessHits函数将TemplateHit的信息收集到TemplateHitsCollection中，随后在EventAction::EndOfEventAction函数中读出，并且通过analysisManager（G4AnalysisManager类的实例）保存，最后在RunAction::EndOfRunAction中输出到 ROOT 文件中。\n核反应统计 ¶\n统计的过程完全发生在SteppingAction::UserSteppingAction方法中，并定义了RunStat类进行协助。RunStat类的主要功能是记录核反应的信息（例如反应类型、反应道与 Q 值）以及核反应产物的信息（例如产物能量、数量，以及伽马射线的母核统计），这些信息在RunStat::print中输出到日志文件中，同时也保存在analysisManager中。\n示例 ¶\n探测器构建 ¶\n\n 靶\n\nΦ\\PhiΦ 15 mm\n样品: 100% 98Mo^{98}\\mathrm{Mo}98Mo, 1.5 um 绿色 (红色)\n衬底: Al, 5 um 绿色 (蓝色)\n\n\n探测器\n\nSi: 10 mm ×\\times× 10 mm ×\\times× 3 mm (白色)\nBGO: 100 mm ×\\times× 100 mm ×\\times× 200 mm, 六边形\n\n中心: 束流孔 Φ\\PhiΦ 40 mm (黄色，1 个)\n外层 (灰色，总计 6 个)\n\n\n\n\n屏蔽\n\nPEEK: Φ\\PhiΦ 20 ~ 35 mm, 200 mm 长 (青色)\nPb: 50 mm 厚 (绿色)\n\n\n\n探测器侧视图\n核反应统计 ¶\n入射粒子为 13 MeV 的质子，反应主要以库伦散射为主，质子非弹主要以 98Mo^{98}\\mathrm{Mo}98Mo 的 (n,p) 反应为主，产物为 98Tc^{98}\\mathrm{Tc}98Tc\n&gt;&gt;&gt; Process calls frequency:         CoulombScat =     103207     Radioactivation =       2522        ...&gt;&gt;&gt; List of nuclear reactions:                          As75[264.658] --&gt; N gamma or e- + As75 / Radioactivation:       1   Q =      264.658 keV                         ...                                                   gamma --&gt; N gamma or e- / phot:  121754   Q =     -249.463 eV                                           gamma --&gt; gamma + N gamma or e- / compt:   46219   Q =            0 eV                                           ...               proton + Mo98 --&gt; N gamma or e- + neutron + Tc98 / protonInelastic:    5106   Q =     -3.47829 MeV               ...&gt;&gt;&gt; List of generated particles:               As75 :        18  Emean =      9.91766 eV \t(  501.954 meV --&gt;  15.9164 eV )               ...&gt;&gt;&gt; List of gamma parents:     0 :            Tc98 up     ...\n伽马能谱与母核 ¶\nMo-98 的伽马能谱（产物为 Mo-98 基态）\n单块 BGO 伽马总能谱\n1.607~1.610 MeV 伽马射线母核统计\n参考资料 ¶\n\nExample Hadr03\nDifferences with physics list choice in Hadr03 example\nExample B2\nExample B4\nANALYSIS\n\n","categories":["核物理","Geant4"],"tags":["核技术","Geant4","C/C++"]},{"title":"在 zsh 中自动补全命令参数","url":"/posts/202501-zsh-comp.html","content":"z.lua 是一个很好的工具，可以快速地进入想要的目录。我在本机 WSL 和多个服务器上都安装了这个程序，但是在执行一些命令（例如z -c，在当前目录下的子目录中选择）的时候，自动补全有时候可以用，有时候不能用，很不方便。所以我决定自己写一个 zsh 的自动补全脚本。\n实现 ¶\n首先，通过which z命令拿到实际的命令执行函数：\n\n在 z.lua 脚本中给出了如何对 z 命令进行补全的方法：\n_zlua_zsh_tab_completion() {\t# tab completion\t(( $+compstate )) &amp;&amp; compstate[insert]=menu # no expand\tlocal -a tmp=(${(f)\"$(_zlua --complete \"${words/_zlua/z}\")\"})\t_describe \"directory\" tmp -U}if [ \"${+functions[compdef]}\" -ne 0 ]; then\tcompdef _zlua_zsh_tab_completion _zlua 2&gt; /dev/null\tcompdef ${_ZL_CMD:-z}=_zluafi\n其中：\n\n_zlua_zsh_tab_completion 是自动补全函数；\n${(f)\"$(_zlua --complete \"${words/_zlua/z}\")\"} 是获取补全的内容，并且按照每行分割转化为数组；\n_describe 是定义补全的内容，第一个参数是描述，第二个参数是补全的内容；\ncompdef 是定义自动补全函数，第一个参数是自动补全函数，第二个参数是实际的命令执行函数。\n\n参照上面的内容写了一个自动补全脚本：\n_z_comp() {    local -a list=(${(f)\"$(_zlua --complete \"${words/_zlua/z}\")\"})    _describe \"directory\" list -U}_zc_comp() {    local -a list=(\"${(@f)$(fdfind -t d -d 1 .)}\")    for ((i=1;i&lt;=$#list;i++)){        list[i]=${list[i]/\\//}    }    _describe \"subdirectory\" list -U}_zlua_comp() {    _arguments -C -S -s \\        '*:enter directory order by frecent:_z_comp'  \\        '-c:enter subdirectory:_zc_comp'}compdef _zlua_comp _zlua &gt; /dev/null 2&gt;&amp;1compdef ${_ZL_CMD:-z}=_zlua\n首先定义了两个补全函数 _z_comp 和 _zc_comp，分别对应 z 和 z -c 命令的补全内容。然后定义了一个 _zlua_comp 函数，通过 _arguments 定义了命令的参数和补全内容。最后通过 compdef 定义了自动补全函数。需要注意的是，_zc_comp 函数中得到的子目录是带有/的，所以需要去掉/，否则可能会进入到所选择子目录下的深度更深的目录：\n\n最后在脚本末尾加入：\nautoload -Uz compinit &amp;&amp; compinit\n这样就可以实现自动补全：\n\nFZF¶\n如果想要使用 fzf，同样可以参考 z.lua 中的 script_fzf_complete_zsh 脚本，一个示例如下：\nbindkey '\\e[0n' kill-whole-line_z_comp() {    local list=$(_zlua -l ${words[2,-1]})    if [ -n \"$list\" ]; then        local selected=$(print $list | ${=zlua_fzf} | sed 's/^[0-9,.]* *//')        if [ -n \"$selected\" ]; then            cd ${selected}            printf '\\e[5n'        fi    fi}_zc_comp() {    local -a list=(\"${(@f)$(fdfind -t d -d 1 .)}\")    for ((i=1;i&lt;=$#list;i++)){        list[i]=${list[i]/\\//}    }    if [ -n \"$list\" ]; then        local selected=$(print $list | awk -F \" \" '{for(row=1;row&lt;=NF;row++) print $row;}' | ${=zlua_fzf})        if [ -n \"$selected\" ]; then            cd ${selected}            printf '\\e[5n'        fi    fi}_zlua_comp() {    _arguments -C -S -s \\        '*:enter directory order by frecent:_z_comp'  \\        '-c:enter subdirectory:_zc_comp'}compdef _zlua_comp _zlua &gt; /dev/null 2&gt;&amp;1compdef ${_ZL_CMD:-z}=_zlua\n参考资料 ¶\n\nCompletion System\n给 zsh 自定义命令添加参数自动补全\n命令行自动补全原理\nA Guide to the Zsh Completion with Examples\n\n","categories":["技术笔记","工具"],"tags":["zsh","shell","linux"]},{"title":"服务器安装 Jupyter Lab（Python 与 R 环境）","url":"/posts/202112-pyr_jupyter.html","content":"前言 ¶\n这学期学的《概率论与数理统计》课有作业需要用到 R，加上双十一从腾讯云搞了一台 2H4G8M 的机器，性能大大提升，因此打算打造一个云服务来运行 Python，同时兼顾 R。\n在安装的过程中碰到了超级多的问题，所以下面介绍一下安装的流程，记录一些很久才解决的问题。\n\n系统信息\nOS: Ubuntu 20.04\nPython: 3.8.10\n\n方案 ¶\n目前常用的方式是Anaconda +R(使用apt安装)，而Anaconda会安装很多不必要的包，而在服务器（无图形界面）使用apt安装的R中的画图功能需要安装X11的相关环境，还不一定能搞定，所以最终采用的方案如下：\n./├─pycal              Python虚拟环境├─rsource            R安装包的源代码├─rcal               自定义安装的R├─project            项目文件夹│  ├─R               R项目│  └─Python          Python项目└─requirements.txt   Python需要的包\n安装 ¶\nPython 相关环境 ¶\n安装虚拟环境 ¶\npython -m venv pycalsource pycal/bin/activatepip install -r requirements.txt\nJupyter 初步配置 ¶\n\n 生成配置文件\n\njupyter lab --generate-config\n如果是root用户，可以在后面添加--allow-root，完成后会返回配置文件位置。\nValueError: Can not patch loop of type &lt;class 'NoneType'&gt;\n这是由于nest_asyncio的 bug 导致的，将其版本回退为1.5.1即可解决。[3]\npip uninstall nest_asynciopip install nest_asyncio==1.5.1\n\n 生成密码\n\n(pycal) ~/calhub ❯❯❯ ipythonPython 3.8.10 (default, Sep 28 2021, 16:10:42) Type 'copyright', 'credits' or 'license' for more informationIPython 7.30.0 -- An enhanced Interactive Python. Type '?' for help.In [1]: from notebook.auth import passwdIn [2]: passwd(\"password\", 'sha1')Out[2]: 'sha1:c3354c486202:4ddc858c5be0eef7b78547c6210c0d65df1023e9'\n\n修改配置\n\n修改配置文件，路径在2.1中给出，一般为~/.jupyter/jupyter_lab_config.py；在这一步后可以启动jupyter lab，访问http://[ip]:port进行预览。\nc.ServerApp.ip = '0.0.0.0'c.ServerApp.open_browser = Falsec.ServerApp.password = u'sha1:c3354c486202:4ddc858c5be0eef7b78547c6210c0d65df1023e9' # 2.2中得到的加密密码c.ServerApp.port = 8080 # 自定义端口c.ServerApp.root_dir = '~/calhub/project' # 自定义工作目录\n注意要在服务器的管理面板放行相关端口。\n\nR 相关环境 ¶\n下载 ¶\n为了避免X11的配置问题，采用编译安装R的方式。从CRAN下载源代码（推荐清华镜像源），将其解压：\nwget https://mirrors.tuna.tsinghua.edu.cn/CRAN/src/base/R-4/R-4.1.2.tar.gztar -zxvf R-4.1.2.tar.gzmv R-4.1.2 rsource &amp;&amp; cd rsource\n安装前配置 ¶\n有问题，多看手册：R Installation and Administration\n\n在安装之前，我们需要先通过rsource目录下的configure文件生成安装的配置文件，在安装中我们需要指定Cairo代替X11环境（--with-x=no和--with-cairo），同时指定相应的图片格式（如--with-libpng代表png格式），还可以指定R的安装位置（--prefix=your path）。运行 [1]：\n./configure --prefix=~/calhub/rcal --with-libpng --with-jpeglib --with-libtiff --with-x=no --with-cairo\n在这一步骤前，请先确认服务器上安装有以下包：libcairo2-dev、libjpeg-dev、libtiff-dev、libpng-dev。\n\nconfigure: error: No Fortran compiler found\n直接安装Fortran的编译器即可，如sudo apt install gfortran。\n\nconfigure: error: –with-readline=yes (default) and headers/libs are not available\n安装readline：sudo apt install libreadline6-dev\n\nconfigure: WARNING: you cannot build info or HTML versions of the R manuals\n这个问题是无法获取R手册的 html 版本，通过sudo apt install texinfo解决。\n\n安装 ¶\nmakemake checkmake install\n安装后配置 ¶\n\n 确认正常\n\n进入R环境（可以将~/calhub/rcal/bin加入环境变量），查看cairo是否启用，各类图片是否支持。\n(pycal) ~/calhub ❯❯❯ ./rcal/bin/RR version 4.1.2 (2021-11-01) -- \"Bird Hippie\"...Type 'q()' to quit R.&gt; capabilities()       jpeg         png        tiff       tcltk         X11        aqua        TRUE        TRUE        TRUE       FALSE       FALSE       FALSE    http/ftp     sockets      libxml        fifo      cledit       iconv        TRUE        TRUE        TRUE        TRUE        TRUE        TRUE         NLS       Rprof     profmem       cairo         ICU long.double        TRUE        TRUE       FALSE        TRUE        TRUE        TRUE     libcurl        TRUE \n\n配置~/.Rprofile\n\n.Rprofile文件是R的开始配置文件（Startup Configuration），一般情况下在用户目录下建立该文件即可，也可以在工作目录或者R的安装目录编写 [2]。通过该文件，我们指定图片默认使用cairo，安装默认使用清华镜像源。\n## Set default 'type' for png() calls - useful when X11 device is not available!## NOTE: Needs 'cairo' capabilityoptions(bitmapType='cairo')options(\"repos\" = c(CRAN=\"https://mirrors.tuna.tsinghua.edu.cn/CRAN/\"))cat(\"\\nWelcome at\", date(), \"\\n\")\n\n安装Cairo\n\n安装Cairo，并查看是否支持各类图片格式。（未尝试过不安装是否可以）\n&gt; install.packages(\"Cairo\")...&gt; library(\"Cairo\")&gt; Cairo.capabilities()   png   jpeg   tiff    pdf    svg     ps    x11    win raster   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE  FALSE   TRUE\nERROR: configuration failed for package ''Cairo'\n服务器没有安装cairo的包，通过sudo apt install libcairo2-dev解决。\n\nfatal error: X11/Intrinsic.h: No such file or directory\n这个包是在编译安装cairo过程中需要用到的，通过sudo apt install libxt-dev解决。[4]\n\nJupyter 配置 ¶\n添加 R kernel¶\n\n 安装依赖包\n\n&gt; install.packages(c('repr', 'IRdisplay', 'evaluate', 'crayon', 'pbdZMQ', 'devtools', 'uuid', 'digest'))\ninstallation of package 'devtools'/'gert'/'phangorn' had non-zero exit status\n通过单独安装某个包（例如install.packages(\"devtools\")）的方式，可以获取报错，发现都是因为git2导致的，通过sudo apt install libgit2-dev解决。[5]\n\n\n 安装kernel\n\n&gt; devtools::install_github('IRkernel/IRkernel')\n这一步对网络的要求比较高，可以设置代理进行。\n\nError in loadNamespace(i, c(lib.loc, .libPaths()), versionCheck = vI[[i]]) : 载入了名字空间'rlang' 0.2.2，但需要的是&gt;= 0.3.0\n先卸载rlang包，再重新安装：\n&gt; remove.packages(c('rlang'), lib=file.path('包所在位置')) # 或&gt; remove.packages('rlang')&gt; install.packages('rlang')\n\n添加kernel\n\n# 给自己安装&gt; IRkernel::installspec()# 给系统安装&gt; IRkernel::installspec(user = FALSE)\n输出会给出kernel路径，如Installed kernelspec ir in ~/.local/share/jupyter/kernels/ir。\nNginx 配置 ¶\n在完成上述步骤后，可以通过http://ip:port的方式进行访问，如果需要绑定域名，我们还需要对 Nginx 进行配置，主要是实现WebSocker转发。\nlocation /{    proxy_pass http://127.0.0.1:8080;    proxy_set_header Host $host;    proxy_set_header X-Real-IP $remote_addr;    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;    proxy_set_header REMOTE-HOST $remote_addr;        # 持久化连接相关配置实现wss转发    proxy_connect_timeout 30s;    proxy_read_timeout 86400s;    proxy_send_timeout 30s;    proxy_http_version 1.1;    proxy_set_header Upgrade $http_upgrade;    proxy_set_header Connection \"upgrade\";    proxy_redirect off;        add_header X-Cache $upstream_cache_status;        #Set Nginx Cache    add_header Cache-Control no-cache;    }\n服务与插件 ¶\n服务设置 ¶\n为了使Jupyter在后台长期运行，可以选择使用nohup，或者使用类似于tmux的应用，也可以选择创建系统服务：\n## /usr/lib/systemd/system/jupyter.service[Unit]Description=Jupyter Lab[Service]User=ubuntuGroup=ubuntuWorkingDirectory=/home/ubuntu/calhubExecStart=/home/ubuntu/calhub/pycal/bin/jupyter labRestart=on-failureRestartSec=10[Install]WantedBy=multi-user.target\n随后运行sudo systemctl daemon-reload重载以下，后面就可以通过以下命令控制Jupyter:\nsudo systemctl start jupyter    # 启动sudo systemctl enable jupyter   # 设置开机自启sudo systemctl status jupyter   # 查看状态sudo journalctl -u jupyter      # 查看日志\n插件安装 ¶\nJupyter Lab 拥有众多的插件，在左侧的Extension Manager中可以对插件进行管理。目前安装了两个较为需要的插件。\nlsp¶\nCoding assistance for JupyterLab (code navigation + hover suggestions + linters + autocompletion + rename) using Language Server Protocol\n\n\n首先安装插件本体：\n\npip install 'jupyterlab&gt;=3.0.0,&lt;4.0.0a0' jupyterlab-lsp\n\n根据需要安装LSP language server，例如我需要Python以及R语言：\n\npip install 'python-lsp-server[all]'R -e 'install.packages(\"languageserver\")'\n\n重启Jupyter Lab服务\n\nsystem-monitor¶\n\n 安装插件本体：\n\npip install jupyterlab-system-monitor\n\n修改Jupyter配置~/.jupyter/jupyter_lab_config.py：\n\n# memoryc.ResourceUseDisplay.mem_limit = &lt;size_in_GB&gt; *1024*1024*1024# cpuc.ResourceUseDisplay.track_cpu_percent = Truec.ResourceUseDisplay.cpu_limit = &lt;number_of_cpus&gt;\n\n修改插件配置：在Settings中选择Advanced Settings Editor，找到System Monitor，在右侧写入自己的配置：\n\n{    // CPU Settings    // Settings for the CPU indicator    \"cpu\": {        \"label\": \"CPU Usage: \"    },    // Memory Settings    // Settings for the memory indicator    \"memory\": {        \"label\": \"Memory Usage: \"    },    // Refresh Rate (ms)    // Refresh Rate to sync metrics data    \"refreshRate\": 1000}\n附录 ¶\n演示 ¶\n\n\nrequirements 内容 ¶\nnumpypandasmatplotlibtablesastropyhandcalcsjupyterlab\n保存文件失败 ¶\n\n 防火墙设置\n\n宝塔的专业版防火墙和免费 Nginx 防火墙都有 POST 最大参数限制，查看错误日志（如/www/wwwlogs/free_waf_log/）发现有参数值长度超过20w已被系统拦截的字样，则说明防火墙出现问题，修改/www/server/free_waf/init.lua中的200000为更大的数字即可。\n\nwebsocket问题\n\n可参考官方推荐配置：\nmap $http_upgrade $connection_upgrade {        default upgrade;        ''      close;}server {        listen 80;        server_name jupyter.somewhere.cool;        location / {                proxy_pass            http://localhost:9999;                proxy_set_header      Host $host;                proxy_http_version    1.1;                proxy_set_header      Upgrade $http_upgrade;                proxy_set_header      Connection $connection_upgrade;        }}\n\n权限问题\n\n请确认运行jupyter lab的用户拥有.ipynb文件的读写权限。\n脚注 [3][4][5]\n参考资料 ¶\n\n【上云第 1 期】访问云上的 jupyter 环境（保姆级搭建教程）\nLinux 环境下 R 语言安装笔记\njupyter 中加入 R 语言 kernel 操作指南\n\n\n\n\nCompile R with Cairo support without X11 ↩︎\n\nstartup: Friendly R Startup Configuration ↩︎\n\nCan not launch notebook after nest_asyncio upgraded to 1.5.2 ↩︎\n\n【解决】fatal error: X11 / XXXX.h: No such file or directory ↩︎\n\nUbuntu, how to deal the error “&lt;stdin&gt;:1:10: fatal error: git2.h: No such file or directory”? ↩︎\n\n\n\n","categories":["技术笔记","Jupyter"],"tags":["教程","Python","Jupyter","R"]}]