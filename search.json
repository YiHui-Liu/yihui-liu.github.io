[{"title":"世界，你好！","url":"/posts/202003-a.html","content":"<p><img src=\"https://asset.foolishfox.cn/static/fox_paint.jpg\" alt=\"\"></p>\n","categories":["随记"]},{"title":"随记 | 大宋清平","url":"/posts/202004-a.html","content":"<h2 id=\"正文\">正文 <a class=\"header-anchor\" href=\"#正文\">¶</a></h2>\n<p>这学期选修了历史系方城峰老师的《宋元史》：前八周讲宋史，后八周讲北方民族史；这一周刚好结束了宋史部分的最后一讲：宋代文化专题；恰逢《清平乐》7 号开播，我们老师也在微信群里提到了这部剧，于是蹭蹭热度，来讲一讲这大宋，也当作是前半个学期的一些复习吧</p>\n<span id=\"more\"></span>\n<p>提到大宋，应该有很多人的第一印象是羸弱，乃至有很多人叫弱宋，更有甚者称之为 “弱怂”；他们认为，<strong>有宋一代，积贫积弱，重文轻武，尽管文化上十分发达，但是对外的软弱，导致了后来汉族的沉沦</strong>，这是从宋朝的结果来看，得出的最明显的结论；坚持这一观点的著名人物有<strong>钱穆</strong>，<strong>吕思勉</strong>，他们都是成长于<strong>中华民族备受外族凌辱，随时有可能国破家亡</strong>的时代 <sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup>；因为，我们可以肯定，在他们坚持这一观点的背后，有一部分原因是想要 **“以古论今”<strong>，为当时的政治服务；南宋的学者</strong>叶适 ** 也曾发表过类似的言论，他说：“天下之弱势，历数古人之为国，无甚于本朝者。”</p>\n<p>也有很多人坚持<strong>富宋论</strong>，这一观点是英国学者<strong>伊懋可</strong>提出的；与之持类似观点的还有美国学者<strong>费正清</strong>，费正清认为宋代是 **“中国历史上最伟大的时期”<strong>；伊懋可主要是从</strong>经济<strong>角度去看待</strong>唐宋的变局 **，他认为，<strong>唐宋变革</strong>其实是经济的转型、技术的转型、生产模式的转型；经济转型的一个主要方面，就是江南的农业开发和市场的发展造成了中国经济重心的南移 <sup class=\"footnote-ref\"><a href=\"#fn2\" id=\"fnref2\">[2]</a></sup></p>\n<p>但值得注意的是，他们在研究这一段历史时，采用的是西方学者管用的<strong>冲击 - 回应模式 </strong><sup class=\"footnote-ref\"><a href=\"#fn3\" id=\"fnref3\">[3]</a></sup>，是为了解答为什么中国没有自主进入近现代化，反而在元朝之后陷入长久的停滞，费正清在他的《美国与中国》一书中也有所反映。他认为，“传统中国不是不变的，也不是静态的或停滞的。正相反，它曾经有过不断的变化，并且变化多端。可是变化总是在一个明显的文化形式与规章制度形式的范围之内。”</p>\n<p>在十九世纪末、二十世纪初，日本<strong>京都学派</strong>的<strong>内藤湖南</strong>提出了<strong>唐宋变革论 </strong><sup class=\"footnote-ref\"><a href=\"#fn4\" id=\"fnref4\">[4]</a></sup>，也就是前文提及的<strong>唐宋变革</strong>的来源；内藤湖南在《概括的唐宋时代观》中提到：“唐和宋在文化上有显著差异：唐代是中世的结束，而宋代则是近世的开始，其间包含了唐末至五代一段过渡期…… 从政治上来说，在于贵族政治的式微和君主独裁的出现”；其实类似的观点，在宋明乃至民国时期就有人提出，北宋的<strong>郑樵</strong>在《通志》卷二十五《氏族略》称：“自隋唐而上，官有簿状，家有谱系，官之选举必由于簿状，家之婚姻必由于谱系。”“自五季 <sup class=\"footnote-ref\"><a href=\"#fn5\" id=\"fnref5\">[5]</a></sup> 以来，取士不问家世，婚姻不问阀阅。”</p>\n<p>明朝人<strong>陈邦瞻</strong>更是从中国历史发展的大势来看待唐宋之际的大变动，而且把中国历史分作三个阶段。他在《宋史纪事本末・序》中说 “然而未暇考其世已，宇宙 <sup class=\"footnote-ref\"><a href=\"#fn6\" id=\"fnref6\">[6]</a></sup> 风气，其变之大者有三：鸿荒 <sup class=\"footnote-ref\"><a href=\"#fn7\" id=\"fnref7\">[7]</a></sup> 一变而为唐、虞，以至于周，七国为极；再变而为汉，以至于唐，五季为极；宋其三变，而吾未其极也。变未极，则治不得不相为因。”</p>\n<p>民国大师<strong>陈寅恪</strong>，对宋代也有自己的见解，他认为：“华夏民族之文化，历数千载之演进，<strong>造极于赵宋之世</strong>。后渐衰微，终必复振。” 在建国后，<strong>胡如雷</strong>基于当时的政治形势，根据阶级斗争和土地所有制的变化，认为唐宋之际中国封建社会有着巨大变革</p>\n<p>本文不想在这些事情上有过多的讨论，也不想发表自己的意见；于是，顺着《清平乐》的脚步，将剧中的故事娓娓道来，逐一展开，成了一个很好的选择</p>\n<p>首先，关于这部剧的主角：宋仁宗，很多人不理解为什么要选这么一个主角。的确，在我们接受的小初高教育中，唯有秦皇汉武，唐宗宋祖，能够称之为天骄，才能够说对历史有重大贡献，至于高皇帝刘邦、宣帝刘洵、光武刘秀、三国三帝、北魏孝文、文帝杨坚、武后武曌、玄宗隆基，太祖重八、成祖朱棣、圣祖康熙、高宗乾隆也可以算是人杰</p>\n<p>至于北宋仁宗，没有秦皇汉武的丰功伟业，没有唐宗宋祖的雄才大略，反而被他手下的臣子、一个又一个巨星所掩盖；吕夷简、宋痒、庞籍、晏殊、范仲淹、欧阳修、韩琦、富弼、文彦博、曾公亮、包拯、狄青、苏轼、曾巩、王安石、司马光、柳永、周敦颐、邵雍、张载、程颢、程颐、章惇、韩绛、吕诲、梅尧臣、王尧臣、王拱辰…… 这一长串的名字，让我们迷失在他们璀璨的光辉中，不由自主地忽视了散发着微弱光芒的仁宗</p>\n<p>但是仁宗真的只是名声好，没有半点历史功绩吗？仁宗真的握着一手好牌，却打得稀巴烂吗？异国百姓、君王均为仁宗之死感到悲哀，是因为仁宗好欺负，难得遇上吗？这些问题，我们都可以在后面讲述的过程中，稍加思考；当然，仁者见仁智者见智，每个人得出的结论都会不一样，那就看各自的领悟啦</p>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ul>\n<li> 课件 &amp; 课堂讲授，清华大学历史系，方城峰</li>\n<li>唐宋变革论究竟是怎么回事，北京大学历史系，陆扬</li>\n<li>唐宋变革论的由来与发展，首都师范大学历史学院，李华瑞</li>\n</ul>\n<hr class=\"footnotes-sep\">\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p>钱穆，1895-1900；吕思勉，1884-1957 <a href=\"#fnref1\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn2\" class=\"footnote-item\"><p>唐和北宋在实际上还没有完成经济重心南移的过程，实际上，在北宋，人口、科技、经济仍然集中在北方 <a href=\"#fnref2\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn3\" class=\"footnote-item\"><p>冲击 - 回应模式，强调了西方的冲击对中国进步的重要性 <a href=\"#fnref3\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn4\" class=\"footnote-item\"><p>除京都学派外，日本的东京学派也对中国的历史分期有所研究，但值得注意的是，两者在战前 &amp; 战时的学术研究，基本上是为了替日本侵略中国寻找合适的理由与借口 <a href=\"#fnref4\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn5\" class=\"footnote-item\"><p>五季，即五代，后梁、后唐、后晋、后汉、后周 <a href=\"#fnref5\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn6\" class=\"footnote-item\"><p>宇宙，宇代表空间，宙代表时间，与现在的宇宙有所不同 <a href=\"#fnref6\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn7\" class=\"footnote-item\"><p>鸿荒，指太古，混沌初开之世 <a href=\"#fnref7\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n</ol>\n</section>\n","categories":["随记","历史","科普"],"tags":["历史","宋朝","清平乐"]},{"title":"随记 | 天导星空照","url":"/posts/202004-d.html","content":"<p>昨天是难得一遇的晴天，作为星空摄影小白的我，拿着手机去拍星空，也是为了我《天文学导论》的个人观星作业：</p>\n<div class=\"note quote flat\"><p>在晴朗无月的夜晚，向北找到<strong>北极星和北斗七星</strong>，向南找到<strong>天狼星和猎户座</strong>，观测并记录<strong>这些星星在天球上的运行规律</strong>。分别在<strong>相距至少一个月的两个晴朗无月</strong>的夜晚，用相机拍摄（或手绘）以上星星组成的图像（手绘时注意各星的相对位置）</p>\n</div>\n<span id=\"more\"></span>\n<p>在图像上，按照标准的星座方式把<strong>北斗七星和猎户座中的星星用线连接起来，并标出每颗星的中文名</strong>。在每个夜晚要选择两个<strong>间隔不少于 3 个小时的任意两个时间节点</strong>进行拍摄和手绘。特别提醒：图像中所标注的星星必须是<strong>裸眼可见</strong>的。为了表明<strong>星群位置是否有相对变化</strong>，图中需明确画出<strong>子午线和正北（正南）位置</strong><br>\n由于昨晚有课，下课就九点了，没有三个小时的间隔，那就只能采用手绘 + 拍摄的方式啦。下面是昨晚的情况：<br>\n地点：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><msup><mn>8</mn><mi mathvariant=\"normal\">°</mi></msup><mn>2</mn><msup><mn>0</mn><msup><mrow></mrow><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup></msup><mn>5</mn><msup><mn>8</mn><msup><mrow></mrow><mrow><mo mathvariant=\"normal\">′</mo><mo mathvariant=\"normal\">′</mo></mrow></msup></msup><mi>N</mi><mn>11</mn><msup><mn>1</mn><mi mathvariant=\"normal\">°</mi></msup><mn>5</mn><msup><mn>0</mn><msup><mrow></mrow><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup></msup><mn>4</mn><msup><mn>4</mn><msup><mrow></mrow><mrow><mo mathvariant=\"normal\">′</mo><mo mathvariant=\"normal\">′</mo></mrow></msup></msup><mi>E</mi></mrow><annotation encoding=\"application/x-tex\">28^{°}20^{'}58^{''}N   111^{°}50^{'}44^{''}E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.94248em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mord\"><span class=\"mord\">8</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.849108em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">°</span></span></span></span></span></span></span></span></span><span class=\"mord\">2</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.94248em;\"><span style=\"top:-2.94248em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.57948em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8278285714285715em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=\"mord\">5</span><span class=\"mord\"><span class=\"mord\">8</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.94248em;\"><span style=\"top:-2.94248em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.57948em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8278285714285715em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.849108em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">°</span></span></span></span></span></span></span></span></span><span class=\"mord\">5</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.94248em;\"><span style=\"top:-2.94248em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.57948em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8278285714285715em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=\"mord\">4</span><span class=\"mord\"><span class=\"mord\">4</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.94248em;\"><span style=\"top:-2.94248em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.57948em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8278285714285715em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span></span></span></span> 时间：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>22</mn><mo>:</mo><mn>00</mn><mo>−</mo><mn>23</mn><mo>:</mo><mn>10</mn></mrow><annotation encoding=\"application/x-tex\">22:00-23:10</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">:</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">:</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span></span></span></span><br>\n首先找到的是<strong>北斗七星</strong>，这是北半球最常见，也是我们最熟悉的星象了：</p>\n<p><img src=\"https://asset.foolishfox.cn/2020/04/star-1.jpg\" alt=\"\"></p>\n<p>上面的是<strong>北斗七星</strong>，是<strong>大熊座</strong>的一部分。小时候还没有那么大的光污染，在老家能够轻而易举的看见明亮的勺状北斗；中间的是<strong>天龙座 (Dragon)</strong>，所以就会有<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi> ζ</mi><mi>D</mi><mi>r</mi><mi>a</mi></mrow><annotation encoding=\"application/x-tex\">\\zeta Dra</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07378em;\">ζ</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span></span></span></span> 这种名字；中心偏左的是<strong>小北斗</strong>，是<strong>小熊座</strong>的一部分，** 北极星 (勾陈一)** 是其中的一颗；这张图不太清晰，下面是一张相对而言更高清的图片：</p>\n<p><img src=\"https://asset.foolishfox.cn/2020/04/star-2.jpg\" alt=\"\"></p>\n<p>昨晚我拍照的时候，我的星座：<strong>狮子座</strong>就在我的头顶，但是没有把它拍下来；而且昨晚虽然不是满月，但是初八正巧是上弦月，月光也是蛮强的，对拍摄也造成了一定影响：</p>\n<p><img src=\"https://asset.foolishfox.cn/2020/04/star-3.jpg\" alt=\"\"></p>\n<p>天空中的最亮的那一块就是月亮了，旁边有两颗亮星。下方那颗是<strong>猎户座</strong>的<strong>参宿四</strong>，下方的电线中间，掩藏着<strong>猎户座</strong>的<strong>腰带三星</strong>；上方那颗是<strong>双子座</strong>的四只脚之一：<strong>井宿三</strong>，还有一只脚被月亮挡住了；月亮上方的两颗亮星是<strong>双子座</strong>的两个头：<strong>北河二</strong>、<strong>北河三</strong><br>\n左侧的电线杆旁边的亮星是<strong>天狼星</strong>，是整个夜空中最亮的一颗恒星，也是<strong>大犬座</strong>的一部分；而最上方的三根电线的中间那一根上面，有着<strong>小犬座</strong>仅有的两颗恒星之一：<strong>南河二</strong>，旁边的那颗亮星是<strong>小犬座</strong>的另一颗恒星：<strong>南河三</strong><br>\n现在让我们掉头，看向我们的身后，有一颗十分明亮的星星：<strong>大角星</strong>：</p>\n<p><img src=\"https://asset.foolishfox.cn/2020/04/star-4.jpg\" alt=\"\"></p>\n<p>上方那一个星座是<strong>牧夫座</strong>，<strong>大角星</strong>是<strong>牧夫座</strong>的主星；中间的星座因为看着就像一个皇冠一样，然后又在北天球，所以称之为<strong>北冕座</strong>；右侧的那一条直线，是<strong>室女座</strong>的一条腿；下方的三个星座中，左侧是<strong>武仙座</strong>的一条手臂和部分躯干；中间是<strong>巨蛇座</strong>的头；右边是<strong>天秤座</strong>的一颗亮星</p>\n<p><img src=\"https://asset.foolishfox.cn/2020/04/star-5.jpg\" alt=\"\"></p>\n<p>除了这些星座的照片，我还花了 10min 拍了一个<strong>星轨</strong>，但是这一切却被一辆车的车灯毁了，大哭😭，流泪😭，下面的人影是我自己，想着把车灯挡住，然而并没有起到什么效果：</p>\n<p><img src=\"https://asset.foolishfox.cn/2020/04/star-6.jpg\" alt=\"\"></p>\n<p>可以明显地看到，圆弧状的<strong>星轨</strong>都围绕着一个共同的圆心：<strong>北天极</strong>，<strong>北极星</strong>就是因为靠近<strong>北天极</strong>而得名，在<strong>南天极</strong>附近没有明显的亮星，所以大家是不是也没有听过<strong>南极星</strong>这个名字？而且<strong>北极星</strong>一直在不断变化，现在的<strong>北极星</strong>是<strong>勾陈一</strong>，而我们很熟悉的 “牛郎织女” 中的<strong>织女星</strong>也会在一段时间内成为<strong>北极星</strong></p>\n","categories":["随记","天文","科普"],"tags":["星空","星座"]},{"title":"本站指引","url":"/posts/202012-b.html","content":"<div class=\"note info flat\"><p>如果您来自搜索引擎，可以再次使用右上角搜索内容</p>\n</div>\n<h2 id=\"订阅我\">订阅我 <a class=\"header-anchor\" href=\"#订阅我\">¶</a></h2>\n<p>你可以通过 <a href=\"/atom.xml\">RSS</a> 来订阅本站的内容</p>\n<h2 id=\"推荐页面\">推荐页面 <a class=\"header-anchor\" href=\"#推荐页面\">¶</a></h2>\n<ol>\n<li> 关于我的介绍，<a href=\"/about\">戳这里</a></li>\n<li>我的锻炼记录，<a href=\"https://work.foolishfox.cn/\">戳这里</a></li>\n<li>博客访问记录，<a href=\"/statistics\">戳这里</a></li>\n</ol>\n<p>更多页面请查看<a href=\"/lab/\">实验室</a></p>\n<span id=\"more\"></span>\n","categories":["随记"]},{"title":"博客成长日志 | 使用 Hexo 搭建博客","url":"/posts/202012-heog.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>之前使用了很久的 WordPress，用起来很方便，但是也有一些不令我满意的地方。首先，WordPress 的源在国外，更新起来很慢很不方便，只好在服务器上面搭建了一个梯子。其次，WordPress 的后端加载速度实在是太慢了，有点无法忍受。而且 WordPress 写文章感觉也没有直接写 <code>markdown</code> 方便。所以，哪怕 WordPress 还是有很多的优点，但我还是决定放弃 WordPress。</p>\n<blockquote>\n<p>我知道有很多方法可以优化 WordPress 的加载速度，帮助更新，但是很麻烦不说，也不能从根本解决</p>\n</blockquote>\n<span id=\"more\"></span>\n<p>然后在偶然的机会下，接触到了 <a href=\"https://hexo.io/zh-cn/\">Hexo</a>，看了一些示例文档，觉得不错，所以打算试一试，于是<strong>首先创建了一个 ECS 快照</strong>，防止操作失误数据丢失。然后趁此机会把服务器换回了我最常用的 <code>Ubuntu</code>，安装了 <code>Hexo</code>，按照教程进行之前数据的迁移和本身、主题等的配置，最终决定就用 <code>Hexo</code> 来搭建新博客。</p>\n<blockquote>\n<p>我在后面接触到了 <code>Hugo</code> 等其他静态博客的项目，感觉都不错，但是和 <code>Hexo</code> 相比没有碾压式的优越，所以也没有纠结，就继续采用 <code>Hexo</code></p>\n</blockquote>\n<h2 id=\"安装\">安装 <a class=\"header-anchor\" href=\"#安装\">¶</a></h2>\n<h3 id=\"安装路线\">安装路线 <a class=\"header-anchor\" href=\"#安装路线\">¶</a></h3>\n<p><img src=\"https://asset.foolishfox.cn/2020/12/hexoblog.png\" alt=\"流程\"></p>\n<h3 id=\"安装Node-js\">安装 Node.js<a class=\"header-anchor\" href=\"#安装Node-js\">¶</a></h3>\n<p>在安装 <code>Hexo</code> 之前需要安装好 <code>node.js</code>。<code>Windows</code> 可以直接在<a href=\"https://nodejs.org/zh-cn/\">官方网站</a>下载安装包，在安装的时候要记住<strong>加入环境变量</strong>中。<code>Linux</code> 用户可以从 <a href=\"https://github.com/nodesource/distributions\">NodeSource</a> 安装。</p>\n<blockquote>\n<p><code>node.js</code> 是基于 <code>Chrome V8</code> 引擎的 <code>Javascript</code> 运行环境，可以帮助我们在本地直接运行 <code>Javascript</code> 而不需要借助浏览器。</p>\n</blockquote>\n<p>我在我的 <code>Ubuntu</code> 服务器上安装的时候，下载速度简直无法忍受，只好去安装了一个命令行版本的科学上网工具：<a href=\"https://github.com/TyrantLucifer/ssr-command-client\">ssr-command-client</a>。所以推荐 <code>Linux</code> 用户使用下载二进制文件的方式进行安装。</p>\n<blockquote>\n<p>在<a href=\"https://nodejs.org/en/download/\">官网</a>下载对应的二进制文件，可以在服务器使用 <code>wget</code> 的方式，也可以下载到本地，然后通过 <code>FTP</code> 工具上传。</p>\n</blockquote>\n<blockquote>\n<p>下载得到的是一个 <code>*.tar.xz</code> 文件，使用 <code>tar -xvf *.tar.zx</code> 进行安装，假设安装目录为 <code>/usr/local/nodejs/</code>，然后添加环境变量，可以使用软链接：<code>ln -s /usr/local/nodejs/bin/node /usr/local/bin/node</code>，最后检查一下是否安装成功：</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">root@qjlyh:/usr/local/nodejs# node -v</span><br><span class=\"line\">v14.15.1</span><br><span class=\"line\">root@qjlyh:/usr/local/nodejs# npm -v</span><br><span class=\"line\">6.14.8</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"安装Git\">安装 Git<a class=\"header-anchor\" href=\"#安装Git\">¶</a></h3>\n<p>直接下载安装包安装即可，依然注意<strong>环境变量</strong>的问题。<code>Linux</code> 基本都自带了 <code>git</code>，不用安装。所以关于 <code>Git</code> 的安装就不过多赘述。</p>\n<h3 id=\"安装Hexo\">安装 Hexo<a class=\"header-anchor\" href=\"#安装Hexo\">¶</a></h3>\n<p>直接按照 <code>Hexo</code> 官网的<a href=\"https://hexo.io/zh-cn/docs/#%E5%AE%89%E8%A3%85-Hexo\">介绍</a>安装即可：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">npm install hexo-cli -g</span><br></pre></td></tr></tbody></table></figure>\n<p>注意之后的操作一般都是在 <code>Hexo</code> 的<strong>初始化目录（或者项目根目录）下进行的</strong>。如果执行失败，可以通过以下命令更改环境变量：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">'PATH=\"$PATH:./node_modules/.bin\"'</span> &gt;&gt; ~/.profile</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"初始化\">初始化 <a class=\"header-anchor\" href=\"#初始化\">¶</a></h3>\n<p>使用下面的命令初始化你的项目文件夹，并且进入文件夹安装 <code>package.json</code> 中的包：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">hexo init &lt;folder&gt;</span><br><span class=\"line\"><span class=\"built_in\">cd</span> &lt;folder&gt;</span><br><span class=\"line\">npm install</span><br></pre></td></tr></tbody></table></figure>\n<p>安装完成之后，项目的文件结构如下图：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">project folder</span><br><span class=\"line\">├── _config.yml   配置文件</span><br><span class=\"line\">├── package.json  应用程序信息</span><br><span class=\"line\">├── scaffolds     模板文件</span><br><span class=\"line\">├── source        源代码</span><br><span class=\"line\">│   ├── _drafts   草稿</span><br><span class=\"line\">│   └── _posts    文章</span><br><span class=\"line\">└── themes        主题</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"常用命令\">常用命令 <a class=\"header-anchor\" href=\"#常用命令\">¶</a></h2>\n<h3 id=\"写博客\">写博客 <a class=\"header-anchor\" href=\"#写博客\">¶</a></h3>\n<p><code>Hexo</code> 本体支持<code>.md</code> 和<code>.ejs</code> 两种格式的文件，但是只要安装了对应的渲染器插件，例如 <code>Hexo-renderer-pug</code>，就可以使用<code>.pug</code> 格式进行写作。<br>\n<code>scaffolds</code> 文件夹以及各个主题的 <code>layout</code> 文件夹下，是各种页面的模板。<code>Hexo</code> 自带了 3 个模板，都是 <code>Markdown</code> 格式的，分别对应草稿、文章和页面，生成新文件的命令是：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">hexo new [layout] &lt;title&gt;</span><br></pre></td></tr></tbody></table></figure>\n<p><code>layout</code> 是可选参数，代表生成什么类型（草稿、文章或者页面），默认<code>_config.yml</code> 中的 <code>default_layout</code> 参数；<code>title</code> 是文件名。<br>\n<strong>官方网站有很详细的说明！多读官方文档！！！</strong></p>\n<h3 id=\"生成\">生成 <a class=\"header-anchor\" href=\"#生成\">¶</a></h3>\n<p>我们写的博文源码都是<code>.md</code> 或者<code>.ejs</code> 一类的文件，然后通过 <code>Hexo</code> 按照主题的配置生成 <code>html</code>、<code>css</code> 和 <code>js</code> 文件，使用的命令如下：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># hexo clean 可以清除缓存（删除/public目录下所有内容）</span></span><br><span class=\"line\">hexo generate</span><br><span class=\"line\">hexo g</span><br></pre></td></tr></tbody></table></figure>\n<p>该命令会在根目录下生成 <code>public</code> 文件夹，该文件夹存储的就是网站所需要的文件了</p>\n<blockquote>\n<p>草稿很类似于所谓的私密文章，只有自己能够看到。如果想要将草稿发布，有两种办法：一种是直接将草稿从<code>_drafts</code> 目录下移动到<code>_posts</code> 目录，或者是使用 <code>hexo publish [layout] &lt;title&gt;</code> 的方式</p>\n</blockquote>\n<h3 id=\"预览\">预览 <a class=\"header-anchor\" href=\"#预览\">¶</a></h3>\n<p><code>Hexo</code> 可以通过内置的 <code>server</code> 来预览生成的网站的效果：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">hexo server --drafts</span><br><span class=\"line\">hexo s</span><br></pre></td></tr></tbody></table></figure>\n<p>默认情况下不会显示草稿，–drafts 参数可以强制显示草稿，或者是更改根目录下<code>_config.yml</code> 的配置项：<code>render_drafts: true</code></p>\n<h3 id=\"部署\">部署 <a class=\"header-anchor\" href=\"#部署\">¶</a></h3>\n<p>最后一步就是将你创作的内容发布，一般是通过这一个步骤将静态文件（也就是 <code>public</code> 文件夹）推送到 <code>GitHub</code> 的一个仓库中，生成 <code>Github Pages</code>，首先要更改根目录下<code>_config.yml</code> 的配置：</p>\n<figure class=\"highlight yaml\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">deploy:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">git</span></span><br><span class=\"line\">  <span class=\"attr\">repo:</span> <span class=\"string\">&lt;repository</span> <span class=\"string\">url&gt;</span></span><br><span class=\"line\">  <span class=\"attr\">branch:</span> [<span class=\"string\">branch</span>]</span><br></pre></td></tr></tbody></table></figure>\n<p>然后安装 <code>hexo-deployer-git</code> 插件，再执行下面的命令，就可以把 <code>public</code> 文件夹整体提交到 <code>GitHub</code> 的仓库中了：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">hexo deploy</span><br><span class=\"line\">hexo d</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"Q-A\">Q&amp;A<a class=\"header-anchor\" href=\"#Q-A\">¶</a></h2>\n<ul>\n<li> 为什么我不在本地搭建 <code>node.js</code> 环境，使用 <code>Github Pages</code> 搭建网站？<br>\n首先是因为我不想在自己的电脑上安装太多的东西；其次是我通过阿里云的学生优惠，购买了一台 ECS，尽管配置不高，但是应付我这个小站肯定是可以的，所以我想把它利用上。所以最终我才用的方案是：本机 <code>VS Code</code> 远程连接服务器进行写作，在服务器上进行部署，同时推送源码到 <code>GitHub</code> 仓库备份（强烈吹一波 <code>VS Code</code>）</li>\n<li>在本机 (<code>Windows</code>) 安装这些东西太麻烦，有没有什么简便的方法？<br>\n答案肯定是有的，可以使用 <code>Chocolate</code> 或者 <code>Scoop</code> 进行安装，强烈推荐这种方法，可以很方便的管理这些应用，不用担心把你的 C 盘搞得一团糟。</li>\n</ul>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ul>\n<li><a href=\"https://blog.csdn.net/itaffy/article/details/89455342\">阿里云 ECS 服务器上安装 nodejs</a></li>\n<li><a href=\"https://ccknbc.github.io/posts/hexo-toss/#%E5%AE%89%E8%A3%85-Node-js\">HEXO 折腾</a></li>\n<li><a href=\"https://hexo.io/zh-cn/docs/\">Hexo 中文文档</a></li>\n</ul>\n","categories":["软件/程序","博客成长日志"],"tags":["教程","Hexo"]},{"title":"折腾日志 | 利用 python 通过百度和必应 API 主动推送收录","url":"/posts/202012-a.html","content":"<p>自己写了博客，一般总是希望被更多的人看到，而他人找到你的网站的最好方法就是通过搜索引擎。所以为了能够让你的网站被收录在搜索引擎中，需要向搜索引擎主动提交 (当然，如果你是 dl，大可不必如此麻烦)</p>\n<span id=\"more\"></span>\n<p>如果你是通过 <code>Hexo</code> 建立的网站，有很多的插件可以提供你使用，例如 <a href=\"https://github.com/cjh0613/hexo-submit-urls-to-search-engine\">hexo-submit-urls-to-search-engine</a>，配置可以看插件的<a href=\"https://cjh0613.com/20200603HexoSubmitUrlsToSearchEngine.html\">文档</a>，除了这种方法之外，还可以自己用 <code>Python</code> 写一个自动提交的程序。</p>\n<h2 id=\"流程\">流程 <a class=\"header-anchor\" href=\"#流程\">¶</a></h2>\n<p><img src=\"https://asset.foolishfox.cn/2020/12/pushurl.png\" alt=\"流程\"><br>\n目前国内主要的搜索引擎就是百度，必应和谷歌，<s>如果需要主动推送谷歌的话，需要会科学上网，再加上个人觉得没什么必要，所以只添加了前两个的 push</s><br>\n2020.12.19: 谷歌可以自动抓取，没必要主动推送</p>\n<h2 id=\"依赖\">依赖 <a class=\"header-anchor\" href=\"#依赖\">¶</a></h2>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> re, os, urllib, requests</span><br><span class=\"line\"><span class=\"keyword\">from</span> urllib <span class=\"keyword\">import</span> request</span><br><span class=\"line\"><span class=\"keyword\">from</span> bs4 <span class=\"keyword\">import</span> BeautifulSoup</span><br><span class=\"line\"><span class=\"keyword\">import</span> xml.dom.minidom</span><br><span class=\"line\"><span class=\"keyword\">from</span> xml.dom.minidom <span class=\"keyword\">import</span> parse</span><br></pre></td></tr></tbody></table></figure>\n<p>一般情况下，只要安装 <code>BeautifulSoup</code> 就好了</p>\n<h2 id=\"收录情况\">收录情况 <a class=\"header-anchor\" href=\"#收录情况\">¶</a></h2>\n<p>在搜索引擎中输入 <code>site:example.com</code> 就可以查看你的网站的收录情况</p>\n<h3 id=\"百度\">百度 <a class=\"header-anchor\" href=\"#百度\">¶</a></h3>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">data      = requests.get(<span class=\"string\">'http://www.baidu.com/s?wd=site:'</span>+url)</span><br><span class=\"line\">content   = data.content.decode(<span class=\"string\">'utf-8'</span>)</span><br><span class=\"line\">soup      = BeautifulSoup(content,<span class=\"string\">'lxml'</span>)</span><br><span class=\"line\">link_list = soup.find_all(<span class=\"string\">'a'</span>)</span><br></pre></td></tr></tbody></table></figure>\n<p>这部分实现的是查询 <code>site:example.com</code>，并且获取页面中所有的链接</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">site_list = []</span><br><span class=\"line\"><span class=\"keyword\">for</span> link <span class=\"keyword\">in</span> link_list :</span><br><span class=\"line\">    url = link.get(<span class=\"string\">'href'</span>)</span><br><span class=\"line\">    rul = re.<span class=\"built_in\">compile</span>(<span class=\"string\">r'http://www.baidu.com/link\\?url=+.+'</span>)</span><br><span class=\"line\">    url = rul.findall(url)</span><br></pre></td></tr></tbody></table></figure>\n<p>这部分是将无关的链接全部排除；百度的搜索结果都是以 <code>http://www.baidu.com/link/?url=</code> 进行替换的，而我们要获得的是真实网址，所以下一步要通过访问这个链接，获取真实指向的网址：</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    response = request.urlopen(url[<span class=\"number\">0</span>])</span><br><span class=\"line\">    realurl  = response.geturl()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> realurl!=<span class=\"string\">''</span> :</span><br><span class=\"line\">        site_list.append(realurl)</span><br><span class=\"line\"><span class=\"keyword\">except</span> request.HTTPError <span class=\"keyword\">as</span> e :</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(e.code, e.reason)</span><br><span class=\"line\"><span class=\"keyword\">except</span> urllib.error.URLError <span class=\"keyword\">as</span> e :</span><br><span class=\"line\">    data = requests.get(url[<span class=\"number\">0</span>])</span><br></pre></td></tr></tbody></table></figure>\n<p><code>urllib.error.URLError</code> 是为了防止有时候 DNS 解析不到某些域名的网址，导致程序直接退出</p>\n<h3 id=\"必应\">必应 <a class=\"header-anchor\" href=\"#必应\">¶</a></h3>\n<p>必应和百度不同，搜索出来的结果直接就是页面链接，不需要获得真实网址：</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">data      = requests.get(<span class=\"string\">'https://cn.bing.com/search?q=site:{}&amp;first={}0'</span>.<span class=\"built_in\">format</span>(url, page))</span><br><span class=\"line\">content   = data.content.decode(<span class=\"string\">'utf-8'</span>)</span><br><span class=\"line\">soup      = BeautifulSoup(content,<span class=\"string\">'lxml'</span>)</span><br><span class=\"line\">link_list = soup.find_all(<span class=\"string\">'a'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">site_list = []</span><br><span class=\"line\"><span class=\"keyword\">for</span> link <span class=\"keyword\">in</span> link_list :</span><br><span class=\"line\">    url = link.get(<span class=\"string\">'href'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> url==<span class=\"literal\">None</span> :</span><br><span class=\"line\">        <span class=\"keyword\">continue</span></span><br><span class=\"line\">    rul = re.<span class=\"built_in\">compile</span>(<span class=\"string\">r'https://foolishfox.cn/+.+'</span>)</span><br><span class=\"line\">    url = rul.findall(url)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> url==<span class=\"literal\">None</span> <span class=\"keyword\">or</span> <span class=\"keyword\">not</span> url :</span><br><span class=\"line\">        <span class=\"keyword\">continue</span></span><br><span class=\"line\">    site_list.append(url[<span class=\"number\">0</span>])</span><br><span class=\"line\"><span class=\"keyword\">return</span> site_list</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"站点链接\">站点链接 <a class=\"header-anchor\" href=\"#站点链接\">¶</a></h2>\n<p>可以通过很多手段获得站点地图。以我的网站为例，使用 <code>hexo-generator-sitemap</code> 直接获得了 <code>sitemap.xml</code> 文件</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">DOMTree   = xml.dom.minidom.parse(path)</span><br><span class=\"line\">sizemap   = DOMTree.getElementsByTagName(<span class=\"string\">'loc'</span>)</span><br><span class=\"line\">site_list = []</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">0</span>, <span class=\"built_in\">len</span>(sizemap), <span class=\"number\">1</span>):</span><br><span class=\"line\">    url = sizemap[i].firstChild.data</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"string\">'tags'</span> <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> url <span class=\"keyword\">and</span> <span class=\"string\">'categories'</span> <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> url :</span><br><span class=\"line\">        site_list.append(url)</span><br><span class=\"line\"><span class=\"keyword\">return</span> site_list</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"百度提交\">百度提交 <a class=\"header-anchor\" href=\"#百度提交\">¶</a></h2>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">s_url = <span class=\"string\">'http://data.zz.baidu.com/urls?site=https://foolishfox.cn&amp;token='</span>+os.environ[<span class=\"string\">'baidu_token'</span>]</span><br><span class=\"line\">headers = {</span><br><span class=\"line\">    <span class=\"string\">'content-type'</span> : <span class=\"string\">'text/plain'</span>,</span><br><span class=\"line\">    <span class=\"string\">'User-Agent'</span>   : <span class=\"string\">'curl/7.12.1'</span>,</span><br><span class=\"line\">    <span class=\"string\">'Host'</span>         : <span class=\"string\">'data.zz.baidu.com'</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">url_string = <span class=\"string\">''</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> link <span class=\"keyword\">in</span> url_list :</span><br><span class=\"line\">    url_string += link+<span class=\"string\">'\\n'</span></span><br><span class=\"line\">response = requests.request(<span class=\"string\">'POST'</span>, url=s_url, data=url_string, headers=headers)</span><br><span class=\"line\"><span class=\"keyword\">return</span> response.text</span><br></pre></td></tr></tbody></table></figure>\n<p>百度 API 的 token 我已经提前设置在了环境变量中，可以避免对外公开。需要注意的是，<strong>百度 API 的格式要求是字符串</strong>，所以我将 <code>list</code> 拼接成了 <code>string</code>。</p>\n<h2 id=\"必应提交\">必应提交 <a class=\"header-anchor\" href=\"#必应提交\">¶</a></h2>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">s_url = <span class=\"string\">'https://ssl.bing.com/webmaster/api.svc/json/SubmitUrlbatch?apikey='</span>+os.environ[<span class=\"string\">'bing_token'</span>]</span><br><span class=\"line\">headers = {</span><br><span class=\"line\">    <span class=\"string\">'content-type'</span> : <span class=\"string\">'application/json'</span>,</span><br><span class=\"line\">    <span class=\"string\">'User-Agent'</span>   : <span class=\"string\">'curl/7.12.1'</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">url_json = {</span><br><span class=\"line\">    <span class=\"string\">'siteUrl'</span>: <span class=\"string\">'https://foolishfox.cn'</span>,</span><br><span class=\"line\">    <span class=\"string\">'urlList'</span>: []</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"keyword\">for</span> link <span class=\"keyword\">in</span> url_list :</span><br><span class=\"line\">    url_json[<span class=\"string\">'url'</span>].append(link)</span><br><span class=\"line\">response = requests.request(<span class=\"string\">'POST'</span>, url=s_url, json=url_json, headers=headers)</span><br><span class=\"line\"><span class=\"keyword\">return</span> response.text</span><br></pre></td></tr></tbody></table></figure>\n<p>必应可以采用 <code>xml</code> 和 <code>json</code> 两种格式提交，我用的是后者。如果提交单个链接，应该将 <code>s_url</code> 修改为 <code>https://ssl.bing.com/webmaster/api.svc/json/SubmitUrl?apikey=</code>，将 <code>json</code> 中的 <code>urlList</code> 修改为 <code>url</code></p>\n<h2 id=\"自动提交\">自动提交 <a class=\"header-anchor\" href=\"#自动提交\">¶</a></h2>\n<p>最简单的方式就是通过 <code>crontab</code> 了，如果使用 <code>Hexo</code>，还可以用 <code>node.js</code> 监听 <code>hexo</code> 事件，实现提交：</p>\n<figure class=\"highlight javascript\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span> {</span><br><span class=\"line\">\thexo.<span class=\"title function_\">on</span>(<span class=\"string\">'deployAfter'</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) {</span><br><span class=\"line\">\t\t<span class=\"title function_\">run</span>();</span><br><span class=\"line\">\t});</span><br><span class=\"line\">} <span class=\"keyword\">catch</span> (e) {</span><br><span class=\"line\">\t<span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">\"Error: \"</span> + e.<span class=\"title function_\">toString</span>());</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"更新\">更新 <a class=\"header-anchor\" href=\"#更新\">¶</a></h2>\n<ul>\n<li>2020.12.19: 修改代码中链接、流程和部分单词拼写错误</li>\n</ul>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ul>\n<li><a href=\"https://cjh0613.com/20200602pythonBingUrlPush.html\">python 主动推送链接至必应 Bing 平台</a></li>\n</ul>\n","categories":["软件/程序"],"tags":["Python","站点统计"]},{"title":"折腾日志 | Windows 包管理器 Scoop 的安装与使用","url":"/posts/202101-a.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> apt update</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt install git</span><br></pre></td></tr></tbody></table></figure>\n<p>在 <code>Ubuntu</code> 安装软件的时候敲入上面的命令是一件令人舒适的事情，而且也很便捷，想要在 <code>MacOS</code> 上这样操作，也可以使用 <code>homebrew</code> 等诸多的包管理工具。然而如果想在 <code>Windows</code> 安装软件，你<strong>可能</strong>需要：</p>\n<ol>\n<li>打开百度搜索软件</li>\n<li>在搜索结果中找到无毒无捆绑的版本</li>\n<li>进行安装，不停点击 <code>Next</code> 或者下一步</li>\n<li>结束安装</li>\n</ol>\n<span id=\"more\"></span>\n<p>在这个过程中，你还要担心是否会混入病毒，是否会有捆绑软件同时下载；软件还很可能会索要管理员权限，把它自己安装在 C 盘的好位置；有些开发工具还可能会搞乱你的环境变量；最最重要的是，最后你要卸载它的时候不知道有多麻烦。</p>\n<p>所以就有天降猛男来解决这个问题，开发了 <code>Windows</code> 的包管理工具。在 <code>scoop</code> 之前，<code>Windows</code> 上的包管理工具中比较出名的是 <code>Chocolaty</code>。在 <code>scoop</code> 横空出世之后，由于其自定义程度高、拓展性强的特性而发展迅猛，目前社区中总计有 2000 + 的软件；另外 <code>scoop</code> 安装软件不依赖管理员权限，安装路径和环境变量管理也深得我这一类 “绿色用户” 的欢心。</p>\n<h2 id=\"安装scoop\">安装 scoop<a class=\"header-anchor\" href=\"#安装scoop\">¶</a></h2>\n<h3 id=\"安装要求\">安装要求 <a class=\"header-anchor\" href=\"#安装要求\">¶</a></h3>\n<ul>\n<li>Windows 7 或更高版本</li>\n<li> PowerShell 5.0 或更高版本</li>\n<li>.NET Framework 4.5 或更高版本</li>\n<li> User Name 不含中文字符</li>\n<li>确认打开了远程安装权限 </li>\n</ul>\n<figure class=\"highlight powershell\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$PSVersionTable</span>.PSVersion.Major                      <span class=\"comment\"># 查看Powershell版本</span></span><br><span class=\"line\"><span class=\"variable\">$PSVersionTable</span>.CLRVersion.Major                     <span class=\"comment\"># 查看.NET Framework版本</span></span><br><span class=\"line\"><span class=\"built_in\">set-executionpolicy</span> remotesigned <span class=\"literal\">-scope</span> currentuser  <span class=\"comment\"># 打开远程权限</span></span><br></pre></td></tr></tbody></table></figure>\n<p>当然还有很重要的一点就是能够正常访问 <code>Github</code>。</p>\n<h3 id=\"配置\">配置 <a class=\"header-anchor\" href=\"#配置\">¶</a></h3>\n<p>默认情况下，scoop 以及大多数安装的软件都位于 <code>%USERPROFILE%\\scoop</code>, 全局安装的程序位于 <code>C:\\ProgramData\\scoop</code>，当然我们也可以自定义安装位置：</p>\n<figure class=\"highlight powershell\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$env:scoop</span>=<span class=\"string\">'D:\\scoop'</span></span><br><span class=\"line\">[<span class=\"type\">Environment</span>]::SetEnvironmentVariable(<span class=\"string\">'scoop'</span>, <span class=\"variable\">$env:scoop</span>, <span class=\"string\">'User'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$env:scoop_GLOBAL</span>=<span class=\"string\">'D:\\scoop\\GlobalApps'</span></span><br><span class=\"line\">[<span class=\"type\">Environment</span>]::SetEnvironmentVariable(<span class=\"string\">'scoop_GLOBAL'</span>, <span class=\"variable\">$env:scoop_GLOBAL</span>, <span class=\"string\">'Machine'</span>)</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"安装\">安装 <a class=\"header-anchor\" href=\"#安装\">¶</a></h3>\n<figure class=\"highlight powershell\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Invoke-Expression</span> (<span class=\"built_in\">New-Object</span> System.Net.WebClient).DownloadString(<span class=\"string\">'https://get.scoop.sh'</span>)</span><br><span class=\"line\"><span class=\"comment\"># or the shorter:</span></span><br><span class=\"line\"><span class=\"built_in\">iwr</span> <span class=\"literal\">-useb</span> get.scoop.sh | <span class=\"built_in\">iex</span></span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"卸载\">卸载 <a class=\"header-anchor\" href=\"#卸载\">¶</a></h3>\n<p>以毒攻毒，以 <code>scoop</code> 卸载 <code>scoop</code>(先卸载其他软件)：</p>\n<figure class=\"highlight powershell\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">scoop uninstall scoop</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"基础\">基础 <a class=\"header-anchor\" href=\"#基础\">¶</a></h2>\n<h3 id=\"常用命令\">常用命令 <a class=\"header-anchor\" href=\"#常用命令\">¶</a></h3>\n<p><code>scoop</code> 的命令设计逻辑是 <code>scoop + command + [object] + [options]</code>，例如 <code>scoop install git -g</code>，常用的基础命令有：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">命令</th>\n<th style=\"text-align:center\">作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"> help <command></command></td>\n<td style=\"text-align:center\">查看帮助</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> bucket add/rm [args]</td>\n<td style=\"text-align:center\"> 添加、删除仓库</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> bucket list/know</td>\n<td style=\"text-align:center\"> 查看已有 / 已知仓库</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> search <appname></appname></td>\n<td style=\"text-align:center\">匹配查找</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> info <app></app></td>\n<td style=\"text-align:center\">查看详情</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> home <app></app></td>\n<td style=\"text-align:center\">查看主页</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> install <app> [options]</app></td>\n<td style=\"text-align:center\"> 安装</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> uninstall <app> [options]</app></td>\n<td style=\"text-align:center\"> 卸载</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> update <app> [options]</app></td>\n<td style=\"text-align:center\"> 更新</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> list</td>\n<td style=\"text-align:center\"> 查看已安装软件</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> cache show/rm [app]</td>\n<td style=\"text-align:center\"> 查看或删除缓存</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> cleanup <app> [options]</app></td>\n<td style=\"text-align:center\"> 删除旧版本</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> checkup</td>\n<td style=\"text-align:center\"> 自检查</td>\n</tr>\n</tbody>\n</table>\n<p><img src=\"https://asset.foolishfox.cn/2021/01/command-1-min.gif\" alt=\"\"><br>\n<img src=\"https://asset.foolishfox.cn/2021/01/command-2-min.gif\" alt=\"\"><br>\n<img src=\"https://asset.foolishfox.cn/2021/01/command-3-min.gif\" alt=\"\"></p>\n<h3 id=\"安装位置\">安装位置 <a class=\"header-anchor\" href=\"#安装位置\">¶</a></h3>\n<p>在<a href=\"#%E9%85%8D%E7%BD%AE\">配置</a>这一步中，我们设置了 <code>scoop</code> 的安装位置为 <code>D:\\Scoop</code>，在这个文件夹下，会有这几个子目录：</p>\n<p><img src=\"https://asset.foolishfox.cn/2021/01/scoopdir.png\" alt=\"\"></p>\n<p><code>app</code> 就是软件的安装位置；<code>buckets</code> 则是已添加的仓库（后文会提到，<code>scoop</code> 的仓库实际上就是 <code>git</code> 的 <code>repository</code>，所以该文件夹下其实就是一个一个 <code>git repository</code>）；<code>cache</code> 是下载缓存；<code>GlobalApps</code> 是自定义的全局安装位置；<code>persist</code> 则是一些配置文件；<code>shim</code> 会创建一些应用的软链接，让应用之间不会互相干扰。</p>\n<h3 id=\"加速\">加速 <a class=\"header-anchor\" href=\"#加速\">¶</a></h3>\n<h4 id=\"使用aria2\">使用 aria2<a class=\"header-anchor\" href=\"#使用aria2\">¶</a></h4>\n<p><code>aria2</code> 可以利用多线程加速下载：</p>\n<figure class=\"highlight powershell\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">scoop install aria2</span><br><span class=\"line\"><span class=\"comment\"># 关闭aria2（默认开启）</span></span><br><span class=\"line\">scoop config aria2<span class=\"literal\">-enabled</span> false</span><br><span class=\"line\"><span class=\"comment\"># 配置aria2 ：重试秒数 单任务最大线程数(最大为16) 同一服务器最大连接数 最小文件分片大小</span></span><br><span class=\"line\">scoop config aria2<span class=\"literal\">-retry-wait</span> <span class=\"number\">4</span></span><br><span class=\"line\">scoop config aria2<span class=\"operator\">-split</span> <span class=\"number\">16</span></span><br><span class=\"line\">scoop config aria2<span class=\"literal\">-max-connection-per-server</span> <span class=\"number\">16</span></span><br><span class=\"line\">scoop config aria2<span class=\"literal\">-min-split-size</span> <span class=\"number\">4</span>M</span><br></pre></td></tr></tbody></table></figure>\n<h4 id=\"设置代理\">设置代理 <a class=\"header-anchor\" href=\"#设置代理\">¶</a></h4>\n<p><code>scoop</code> 在拉取仓库更新和下载大部分软件时，都需要从国外服务器下载，速度十分感人，因此使用代理可以大大加速下载。有两种方式可以在 <code>scoop</code> 下载时使用代理：</p>\n<ol>\n<li>在 Powershell 内设置环境变量：<code>$Env:http_proxy=\"http://127.0.0.1:1080\";$Env:https_proxy=\"http://127.0.0.1:1080\"</code></li>\n<li>更改代理设置：<code>scoop config proxy [username:password@]host:port</code>，具体配置可以查看<a href=\"#refer-5\">参考资料 5</a></li>\n</ol>\n<h2 id=\"Bucket管理\">Bucket 管理 <a class=\"header-anchor\" href=\"#Bucket管理\">¶</a></h2>\n<h3 id=\"介绍\">介绍 <a class=\"header-anchor\" href=\"#介绍\">¶</a></h3>\n<p><code>Bucket</code> 其实就是一个 <code>git repository</code>，主要组成就是描述如何安装软件的 <code>json</code> 文件。在安装 <code>scoop</code> 时已经附带安装 <code>main bucket</code>，然后这个仓库的收录标准十分严格：</p>\n<ul>\n<li>主流的开发者工具</li>\n<li>维护中的最新版本的软件</li>\n<li>完整版本的软件</li>\n<li>不可以有 GUI</li>\n<li>……</li>\n</ul>\n<p>这使得我们只能在 <code>main</code> 中找到部分软件，不可以有 <code>GUI</code> 这一点使得大部分日常使用软件都无法下载，所以我们需要添加其他仓库，可以使用 <code>scoop bucket know</code> 查看官方维护的仓库，还可以在<a href=\"https://scoop.netlify.app/buckets/\">这里</a>查看较受欢迎的仓库，较完整的仓库列表可以在<a href=\"https://github.com/rasa/scoop-directory/blob/master/by-score.md\">这里</a>查看。</p>\n<h3 id=\"管理\">管理 <a class=\"header-anchor\" href=\"#管理\">¶</a></h3>\n<p>官方维护的仓库可以直接添加，例如 <code>scoop bucket add extras</code>；对于社区维护的仓库，使用 <code>scoop bucket add &lt;name&gt; &lt;url&gt;</code> 进行添加，例如 <code>scoop bucket add dorado https://github.com/chawyehsu/dorado</code>。<br>\n每一次安装和更新软件之前，<code>scoop</code> 首先会从 <code>github</code> 拉取已添加仓库的更新，然后再进行操作。如果碰到不同的仓库中拥有名字相同的软件，可以加上仓库名以示区分，例如 <code>scoop install main/git</code>。</p>\n<h3 id=\"建立自己的bucket\">建立自己的 bucket<a class=\"header-anchor\" href=\"#建立自己的bucket\">¶</a></h3>\n<p>参考 <a href=\"https://zhuanlan.zhihu.com/p/165635039\">scoop 进阶 - 建立自己 的 Bucket</a></p>\n<h2 id=\"App查询\">App 查询 <a class=\"header-anchor\" href=\"#App查询\">¶</a></h2>\n<p>为了在 <code>scoop</code> 的许多仓库中找到自己需要的软件，可以在<a href=\"https://scoop.netlify.app/apps/\">这里</a>查询安装脚本所在的 bucket。</p>\n<h2 id=\"Q-A\">Q&amp;A<a class=\"header-anchor\" href=\"#Q-A\">¶</a></h2>\n<ul>\n<li> 还有其他的包管理工具吗？<br>\n有呀，例如 <a href=\"https://github.com/microsoft/winget-cli\">winget</a>，是由官方推出的推出命令行安装工具，全称 <code>windows package manager client</code></li>\n</ul>\n<h2 id=\"仓库\">仓库 <a class=\"header-anchor\" href=\"#仓库\">¶</a></h2>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"> 名称</th>\n<th style=\"text-align:center\">简介 </th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><a href=\"https://github.com/chawyehsu/dorado\">dorado</a></td>\n<td style=\"text-align:center\">Yet another bucket for scoop.</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><a href=\"https://github.com/integzz/scoopet\">scoopet</a></td>\n<td style=\"text-align:center\">A Bucket for the Best Windows Package Manager scoop : Continuously Assisting in Academic Research.</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><a href=\"https://github.com/kidonng/sushi\">sushi</a></td>\n<td style=\"text-align:center\">A tasty and inclusive scoop bucket, providing various kinds of applications.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><span id=\"refer-1\"><a href=\"https://www.jianshu.com/p/29e9d40bd7a2\">Windows 下最好的包管理器–scoop</a></span></li>\n<li><span id=\"refer-2\"><a href=\"https://www.jianshu.com/p/50993df76b1c\">scoop—— 强大的 Windows 命令行包管理工具</a></span></li>\n<li><span id=\"refer-3\"><a href=\"https://sspai.com/post/52710\">给 scoop 加上这些软件仓库，让它变成强大的 Windows 软件管理器</a></span></li>\n<li><span id=\"refer-4\"><a href=\"https://github.com/lukesampson/scoop/wiki/Using-scoop-behind-a-proxy\">Using scoop behind a proxy</a></span></li>\n<li><span id=\"refer-5\"><a href=\"https://github.com/lukesampson/scoop/wiki/Quick-Start\">Quick Start</a></span></li>\n<li><span id=\"refer-6\"><a href=\"https://chawyehsu.com/blog/talk-about-scoop-the-package-manager-for-windows-again\">再谈谈 scoop 这个 Windows 下的软件包管理器</a></span></li>\n<li><span id=\"refer-7\"><a href=\"https://blog.csdn.net/muoyangoren/article/details/79531851\">Aria2 下载简述</a></span></li>\n</ol>\n","categories":["软件/程序"],"tags":["教程","Scoop"]},{"title":"AE9/AP9/SPM | 介绍与安装","url":"/posts/202102-ae9-1.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p><code>AE9/AP9/SPM</code> 是由美国空军研究实验室 (Air Force Research Laboratory) 开发的，用于模拟近地空间辐射的模型。<code>AE9/AP9/SPM</code> 分别用于模拟高能电子，高能质子和等离子体模型，给定卫星轨道根数或星历表，该模型将返回指定量的通量，注量或剂量，并为这些量选择适合的统计数据。<code>AE9/AP9/SPM</code> 提供了两种安装模式：命令行版本和 GUI 版本。在国际合作者加入该项目之后，该模型被重命名为近地国际辐射环境 (IRENE)。</p>\n<span id=\"more\"></span>\n<h2 id=\"下载\">下载 <a class=\"header-anchor\" href=\"#下载\">¶</a></h2>\n<p><code>AE9/AP9/SPM</code> 的项目地址位于 <a href=\"https://www.vdl.afrl.af.mil/programs/ae9ap9/\">VDL</a>，该网站需要使用美国 IP 才可进行访问。我们选择使用 <code>Public AE9AP9 Account</code> 进行下载，而不使用 <code>VDL Account</code>，因为后者需要年满 18 周岁的美国政府雇员，承包商或学术人员才能够申请注册。</p>\n<p>在填写 <code>Public AE9AP9 Account</code> 注册信息时，注意邮箱不能使用国内邮箱或者 hotmail、yahoo，Zip Code 填写为 00000 即可。注册完成之后，密码将会通过注册邮箱发送给你，由于不可知的原因你很有可能无法收到邮件，你可以向 <code>ae9ap9@vdl.afrl.af.mil</code> 发送邮件进行询问，在得到回复之后选择重置密码即可。<br>\n<img src=\"https://asset.foolishfox.cn/2021/02/email_compressed.jpg\" alt=\"\"></p>\n<p><code>AE9/AP9/SPM</code> 默认只提供 Windows 版本，源代码或者 Linux 版本需要发邮件索求之后自行编译。</p>\n<h2 id=\"第三方依赖\">第三方依赖 <a class=\"header-anchor\" href=\"#第三方依赖\">¶</a></h2>\n<div class=\"note warning flat\"><p>只有编译源代码才需要安装依赖，否则直接使用即可！</p>\n</div>\n<h3 id=\"CMake\">CMake<a class=\"header-anchor\" href=\"#CMake\">¶</a></h3>\n<p><code>CMake</code> 版本不低于 2.6，推荐选择下载 Binary distributions，源代码需要编译才能使用。</p>\n<h3 id=\"Visual-Studio-2012\">Visual Studio 2012<a class=\"header-anchor\" href=\"#Visual-Studio-2012\">¶</a></h3>\n<p>下载旧版本的 <code>Visual Studio 2012</code> 或者 2008。</p>\n<div class=\"note quote flat\"><p>A Windows-based FORTRAN compiler is also needed for a full source code compilation, but unfortunately, is not freely available. However, by default, the build process links to an included pre-compiled library of these FORTRAN-based routines.</p>\n</div>\n<h3 id=\"Python-Recommended\">Python (Recommended)<a class=\"header-anchor\" href=\"#Python-Recommended\">¶</a></h3>\n<p>推荐下载 <code>Miniconda</code>，并且更改源：</p>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">pip config <span class=\"built_in\">set</span> global.index-url https://mirrors.aliyun.com/pypi/simple/</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"Qt-and-Qwt-optional\">Qt and Qwt (optional)<a class=\"header-anchor\" href=\"#Qt-and-Qwt-optional\">¶</a></h3>\n<p>QTW 是 QT 的一个第三方库，两者都可以直接下载安装。</p>\n<h3 id=\"HDF5-1-8-8\">HDF5 1.8.8<a class=\"header-anchor\" href=\"#HDF5-1-8-8\">¶</a></h3>\n<p>HDF 的全程是 <code>Hierarchical Data Format</code>，可以存储不同类型的图像和数码数据的文件格式，文件后缀名为<code>.hdf</code>，下载二进制版本安装即可。</p>\n<h3 id=\"Boost-1-58-0\">Boost 1.58.0<a class=\"header-anchor\" href=\"#Boost-1-58-0\">¶</a></h3>\n<p>Boost 是为 C++ 标准库提供扩展的程序库，下载解压后目录如图所示，依照参考资料 5 安装即可。<br>\n<img src=\"https://asset.foolishfox.cn/2021/02/boost_compressed.jpg\" alt=\"\"></p>\n<h2 id=\"解压\">解压 <a class=\"header-anchor\" href=\"#解压\">¶</a></h2>\n<p>下载得到的是一个压缩文件，解压后目录结构为：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">Ae9Ap9</span><br><span class=\"line\">  bin</span><br><span class=\"line\">    win32 - 预编译32位二进制文件(Windows XP/7)</span><br><span class=\"line\">    win64 - 预编译64位二进制文件(Windows 7)</span><br><span class=\"line\">  documents - 发行说明, 用户指南, 编译指南, 版权说明等</span><br><span class=\"line\">  modelData - 模型数据文件</span><br><span class=\"line\">  samples   - 模型样例</span><br><span class=\"line\">  unitTests - 模型的拓展数据集</span><br><span class=\"line\">  source    - 源代码根目录构建脚本(基础发行版中不存在源代码)</span><br><span class=\"line\">    Ae9Ap9Mpi      - Ae9Ap9 源代码</span><br><span class=\"line\">    SpWx_Ae9Ap9    - Ae9Ap9 所依赖的空间天气模型的源代码</span><br><span class=\"line\">    Ae9Ap9GuiMpi   - GUI 应用源代码</span><br><span class=\"line\">    buildAe9Ap9.py - Python 脚本, 用于linux, win32和win64平台的自动构建</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"编译\">编译 <a class=\"header-anchor\" href=\"#编译\">¶</a></h2>\n<div class=\"note warning flat\"><p>只有编译源代码才需要安装依赖，否则直接使用即可！</p>\n</div>\n<ol>\n<li>Taking note of the include and library paths for the third-party dependencies installed in the previous step, using a plain text editor, update these in the three build script configuration files:\n<ul>\n<li>Ae9Ap9/source/SpWx_Ae9Ap9/Common/internal_utils.cmake<br>\nThe configuration file contains several platform-specific sections of commands that set these paths.</li>\n</ul>\n <figure class=\"highlight cmake\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">Scroll down in the <span class=\"keyword\">file</span> to where these lines are showing:</span><br><span class=\"line\"><span class=\"comment\">##############################################################</span></span><br><span class=\"line\"><span class=\"comment\"># config_include_lib_paths</span></span><br><span class=\"line\">From here, all settings that may require modification are preceded with this line:</span><br><span class=\"line\"><span class=\"comment\"># &lt;&lt;== END-USER MODIFIABLE ==&gt;&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n <div class=\"note quote flat\"><p>For Windows, use forward slashes (<code>/</code>) in path references.Note the <code>set</code> of the EXT_LIBS_ROOT variable, and its subsequent reference $(EXT_LIBS_ROOT), for ease of use in multiple places. For Windows, it is suggested to set EXT_LIBS_ROOT to <code>C:/Program Files</code>.</p>\n</div>\n<ul>\n<li>Ae9Ap9/source/Ae9Ap9Mpi/internal_utils.cmake<br>\nThis file is updated in the same way as the previous file, if the GUI application is desired.</li>\n<li>Ae9Ap9/source/Ae9Ap9GuiMpi/trunk/Ae9Ap9Gui.pro<br>\nThe Ae9Ap9Gui source tree utilizes <code>qmake</code> (part of the Qt development environment) for the build process, and thus uses a slightly different file and syntax for defining the include and library paths. Important: on Linux systems, verify that the correct <code>qmake</code> version is being used; update the <code>path</code> environment variable as necessary.<br>\nThe Qt include and library paths will be automatically set properly with the installation of the Qt software. This file must only explicitly set paths for the Qwt include and library paths, as shown below. Note the platform-specific sections are also present here.</li>\n</ul>\n <figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">win32 {</span><br><span class=\"line\">  INCLUDEPATH += c:\\Qt\\qwt-5.2.1\\src</span><br><span class=\"line\">  LIBS += \"c:\\Qt\\qwt-5.2.1\\lib\\libqwt5.a\"</span><br><span class=\"line\">}</span><br><span class=\"line\">win64 {</span><br><span class=\"line\">  INCLUDEPATH += c:\\Qt64\\qwt-5.2.1\\src</span><br><span class=\"line\">  LIBS += \"c:\\Qt64\\qwt-5.2.1\\lib\\libqwt5.a\"</span><br><span class=\"line\">}</span><br><span class=\"line\">unix {</span><br><span class=\"line\">  INCLUDEPATH += /nas/ExternalLibs/Qt/qwt-5.2/src</span><br><span class=\"line\">  LIBS += /nas/ExternalLibs/Qt/qwt-5.2/lib/libqwt.so</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li>Automated Build<br>\nThe preferred method of building a source distribution of IRENE (AE9/AP9/SPM) on a supported platform is to utilize the python script called <a href=\"http://buildAe9Ap9.py\">buildAe9Ap9.py</a>, located in the Ae9Ap9/source directory of the distribution. This script will build the model library and the command-line and gui driver applications, then place them in a platform-specific subdirectory under Ae9Ap9/bin in the distribution.<br>\nDuring the build process, the script will generate a log file called buildAe9Ap9.log in the Ae9Ap9/source directory; this can be used to identify any build errors encountered. At a command prompt in the <code>Ae9Ap9/source</code> directory, invoke the python build script, specifying the operating system name and, if needed, the mode (defaults to <code>release</code>): python <a href=\"http://buildAe9Ap9.py\">buildAe9Ap9.py</a> --os=&lt;platform_name&gt; [ --mode=<type> ] [ --nompi ] [ --nogui ] where &lt;platform_name&gt; can be linux , win32 or win64, and <type> can be release or debug.<br>\nBy default, both the single- and multi-threaded versions of the programs are built, unless the optional argument <code>--nompi</code> (required for win32 builds) is specified. The GUI application is also built by default; to skip this, specify the optional argument <code>--nogui</code>. For RedHat EL or CentOS 5.x installations only, the --gcc=gcc44 option should also be included.</type></type></li>\n</ol>\n<div class=\"note warning flat\"><p><code>debug</code> mode increases program execution time by a factor of 10 to 20.</p>\n</div>\n<h2 id=\"安装测试\">安装测试 <a class=\"header-anchor\" href=\"#安装测试\">¶</a></h2>\n<h3 id=\"CLI\">CLI<a class=\"header-anchor\" href=\"#CLI\">¶</a></h3>\n<p>根据所用平台，在 PowerShell 中进入对应的二进制文件所在的目录 (例如 <code>Ae9Ap9\\bin\\win64</code>)，输入命令：</p>\n<figure class=\"highlight powershell\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">.\\CmdLineAe9Ap9.exe <span class=\"literal\">-i</span> ..\\..\\samples\\Ap9ShortInput.txt</span><br></pre></td></tr></tbody></table></figure>\n<p>生成的输出文件位于 <code>Ae9Ap9\\samples</code> 文件夹下，可以根据文件生成时间判断。我们可以通过验证生成的文件数量以及相应的文件内容是否与位于 <code>Ae9Ap9\\samples\\expectedOutput</code> 目录中以 <code>Ap9ShortOutput</code> 为前缀的文件是否相同来判断是否工作正常。</p>\n<h3 id=\"GUI\">GUI<a class=\"header-anchor\" href=\"#GUI\">¶</a></h3>\n<p>在同一命令行中，可以运行 <code>Ae9Ap9Gui.exe</code> 来启动 GUI 程序<br>\n<img src=\"https://asset.foolishfox.cn/2021/02/GUI.jpg\" alt=\"\"></p>\n<h3 id=\"其他\">其他 <a class=\"header-anchor\" href=\"#其他\">¶</a></h3>\n<p>在 <code>Ae9Ap9\\bin\\win64</code> 目录下还有很多其他文件，其中只有 <code>CmdLineAe9Ap9.exe</code>、<code>Ae9Ap9Gui.exe</code>、<code>TotalDose.exe</code>、<code>IntegralPlasma.exe</code>、<code>ConvertToXlsx.py</code> 需要用到，其他的都是辅助程序。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">参数</th>\n<th style=\"text-align:center\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"> -h</td>\n<td style=\"text-align:center\"> 帮助，列出所有参数说明</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> -v</td>\n<td style=\"text-align:center\"> 输出版本信息</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> -i <filename></filename></td>\n<td style=\"text-align:center\">指定模型输入文件</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> -n <numproc></numproc></td>\n<td style=\"text-align:center\">指定要使用的处理器数量（默认为 1）<br> 使用多线程时包括一个主处理器，会覆盖输入文件中的 NumProc 参数</td>\n</tr>\n</tbody>\n</table>\n<div class=\"note warning flat\"><p>在运行时不要更改输入输入文件，因为应用程序可能会多次访问该文件</p>\n</div>\n<h2 id=\"下载地址\">下载地址 <a class=\"header-anchor\" href=\"#下载地址\">¶</a></h2>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">Name</th>\n<th style=\"text-align:center\">Version</th>\n<th style=\"text-align:center\">URL</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">AE9/AP9/SPM</td>\n<td style=\"text-align:center\">1.50.1</td>\n<td style=\"text-align:center\"><a href=\"https://www.vdl.afrl.af.mil/programs/ae9ap9/downloads.php\">https://www.vdl.afrl.af.mil/programs/ae9ap9/downloads.php</a></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CMake</td>\n<td style=\"text-align:center\">≥2.6</td>\n<td style=\"text-align:center\"><a href=\"https://cmake.org/download/\">https://cmake.org/download/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Visual Studio</td>\n<td style=\"text-align:center\">2008 or 2012</td>\n<td style=\"text-align:center\"><a href=\"https://visualstudio.microsoft.com/zh-hans/vs/older-downloads/\">https://visualstudio.microsoft.com/zh-hans/vs/older-downloads/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Miniconda</td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\"><a href=\"https://mirrors.tuna.tsinghua.edu.cn/help/anaconda/\">https://mirrors.tuna.tsinghua.edu.cn/help/anaconda/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Qt</td>\n<td style=\"text-align:center\">4.6.2</td>\n<td style=\"text-align:center\"><a href=\"https://download.qt.io/archive/qt/4.6/\">https://download.qt.io/archive/qt/4.6/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">QtW</td>\n<td style=\"text-align:center\">5.2.1</td>\n<td style=\"text-align:center\"><a href=\"https://sourceforge.net/projects/qwt/files/qwt/5.2.1/\">https://sourceforge.net/projects/qwt/files/qwt/5.2.1/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">HDF5</td>\n<td style=\"text-align:center\">1.8.8</td>\n<td style=\"text-align:center\"><a href=\"https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8/hdf5-1.8.8/\">https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8/hdf5-1.8.8/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Boost</td>\n<td style=\"text-align:center\">1.58.0</td>\n<td style=\"text-align:center\"><a href=\"https://sourceforge.net/projects/boost/files/boost/1.58.0/\">https://sourceforge.net/projects/boost/files/boost/1.58.0/</a></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://www.vdl.afrl.af.mil/programs/ae9ap9/\">AE9/AP9/SPM</a></li>\n<li><a href=\"https://blog.csdn.net/weixin_40011728/article/details/77924614\">QT 第三方库：Qwt 的安装与使用</a></li>\n<li><a href=\"https://blog.csdn.net/maweifei/article/details/80961541\">Windows 下 HDF5 静态库的封装与测试</a></li>\n<li><a href=\"https://www.jianshu.com/p/bf2fd1752f7f\">在 windows 平台使用 CMAKE 安装 HDF5</a></li>\n<li><a href=\"https://blog.csdn.net/bxbjk/article/details/100760154\">Windows 环境下 Boost 的安装</a></li>\n</ol>\n","categories":["软件/程序"],"tags":["教程","AE9/AP9/SPM"]},{"title":"折腾日志 | 安装 MTProxy，轻松使用 Telegram","url":"/posts/202102-mtproxy.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>Telegram 是一款类似于 QQ 和微信的即时通讯软件，中文名叫电报。Telegram 最大的特点，也是主打的招牌就是加密与安全：除了服务器本身加密外，还可以额外用户对用户加密，还支持设置阅后即焚，保证通信隐私安全。目前最新版本的客户端支持发送所有类型的文件和进行语音通话。</p>\n<span id=\"more\"></span>\n<p>不过正是由于 Telegram 的加密特性，导致不少地区都对 Telegram 进行封杀，必须使用特殊手段才能使用 Telegram，基于此类问题，电报官方开发了一款专门用于 Telegram 的代理工具 ——MTProxy。</p>\n<p>MTProxy 特别适合主要通过手机使用 Telegram 的用户，电脑一般一直开启科学上网工具，但手机不同，所以使用 MTProxy 可以让手机更方便地使用 Telegram。</p>\n<h2 id=\"手动安装\">手动安装 <a class=\"header-anchor\" href=\"#手动安装\">¶</a></h2>\n<h3 id=\"准备\">准备 <a class=\"header-anchor\" href=\"#准备\">¶</a></h3>\n<p>在安装之前，需要确认你的服务器上拥有一些基本工具：<code>openssl</code>、<code>zlib</code>、<code>gcc</code> 等。</p>\n<h3 id=\"Build\">Build<a class=\"header-anchor\" href=\"#Build\">¶</a></h3>\n<ol>\n<li> 拉取源码 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/TelegramMessenger/MTProxy</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>编译，生成的二进制文件是 objs/bin/mtproto-proxy</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> MTProxy</span><br><span class=\"line\">make &amp;&amp; <span class=\"built_in\">cd</span> objs/bin</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"Config\">Config<a class=\"header-anchor\" href=\"#Config\">¶</a></h3>\n<ol start=\"3\">\n<li> 连接 Telegram 服务器，并获取配置文件 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">curl -s https://core.telegram.org/getProxySecret -o proxy-secret</span><br><span class=\"line\">curl -s https://core.telegram.org/getProxyConfig -o proxy-multi.conf</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"4\">\n<li>生成密钥，一定要<strong>记得记录下来 </strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">head</span> -c 16 /dev/urandom | xxd -ps</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"5\">\n<li>创建 systemd 服务文件，并且填充内容 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">nano /etc/systemd/system/MTProxy.service</span><br><span class=\"line\"></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=MTProxy</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">WorkingDirectory=/opt/MTProxy</span><br><span class=\"line\">ExecStart=/opt/MTProxy/mtproto-proxy -u <span class=\"variable\">$username</span> -p <span class=\"variable\">$localport</span> -H <span class=\"variable\">$connectport</span> -S <span class=\"variable\">$secret</span> --aes-pwd proxy-secret proxy-multi.conf -M <span class=\"variable\">$num</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">变量名</th>\n<th style=\"text-align:center\">含义</th>\n<th style=\"text-align:center\">备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"> username</td>\n<td style=\"text-align:center\"> 用户名</td>\n<td style=\"text-align:center\"></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> localport</td>\n<td style=\"text-align:center\"> 统计端口</td>\n<td style=\"text-align:center\"> wget localhost:8888/stats</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">connectport</td>\n<td style=\"text-align:center\"> 连接端口</td>\n<td style=\"text-align:center\"></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> secret</td>\n<td style=\"text-align:center\"> 密钥</td>\n<td style=\"text-align:center\"></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"> num</td>\n<td style=\"text-align:center\"> 进程数目</td>\n<td style=\"text-align:center\">默认为 1 即可</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"Run\">Run<a class=\"header-anchor\" href=\"#Run\">¶</a></h3>\n<ol start=\"6\">\n<li> 重新加载进程守护（daemons）</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl start MTProxy.service     <span class=\"comment\"># 启动MTProxy</span></span><br><span class=\"line\">systemctl stop MTProxy.service      <span class=\"comment\"># 停止MTProxy</span></span><br><span class=\"line\">systemctl restart MTProxy.service   <span class=\"comment\"># 重启MTProxy</span></span><br><span class=\"line\">systemctl status MTProxy.service    <span class=\"comment\"># 查看状态</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> MTProxy.service    <span class=\"comment\"># 允许开机自启</span></span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"7\">\n<li>获取链接：<code>tg://proxy?server=SERVER_IP/SERVER_DOMAIN&amp;port=PORT&amp;secret=SECRET</code>，将其发送至任一 tg 聊天窗口，点击添加链接即可</li>\n</ol>\n<h3 id=\"MTProxy-Admin-Bot\">MTProxy Admin Bot<a class=\"header-anchor\" href=\"#MTProxy-Admin-Bot\">¶</a></h3>\n<p>MTProxy Admin Bot 是 Telegram 官方帮助使用代理的工具，搜索添加后，通过 <code>/newproxy</code> 命令生成代理链接：<br>\n<img src=\"https://asset.foolishfox.cn/2021/02/proxy-min.gif\" alt=\"\"></p>\n<h2 id=\"脚本安装-TLS伪装\">脚本安装 + TLS 伪装 <a class=\"header-anchor\" href=\"#脚本安装-TLS伪装\">¶</a></h2>\n<p>上面的安装过程略显繁琐，容易出错，而且更重要的问题是这样安装的代理使用的流量特征十分明显，特别容易被 GFW 识别，导致服务器端口甚至 IP 被封，最好使用其他方法进行伪装，所以可以使用一键安装脚本，例如 <a href=\"https://github.com/sunpma/mtp\">MTProxy TLS</a> 或者 <a href=\"https://github.com/ellermister/mtproxy\">mtproxy</a>，安装过程与上面类似，使用方法在 Github 主页中有描述：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">bash mtproxy.sh start</span><br><span class=\"line\">bash mtproxy.sh debug</span><br><span class=\"line\">bash mtproxy.sh stop</span><br><span class=\"line\">bash mtproxy.sh restart</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"Q-A\">Q&amp;A<a class=\"header-anchor\" href=\"#Q-A\">¶</a></h2>\n<ol>\n<li> 脚本安装之后无法启动</li>\n</ol>\n<p>可以使用 <code>bash mtproxy.sh debug</code> 命令查看问题，一般问题都是类似这样：<br>\n<img src=\"https://asset.foolishfox.cn/2021/02/vultr-min-plus.png\" alt=\"\"></p>\n<p>这是因为脚本下载的 mtproto-proxy 版本太老了，可以看到是用 gcc-8 编译的去年的老版本，可能和你的电脑不匹配，我的解决方案是：<br>\n  ①. 下载原版：git clone <a href=\"https://github.com/TelegramMessenger/MTProxy\">https://github.com/TelegramMessenger/MTProxy</a><br>\n  ②. 使用服务器上的 gcc 进行编译，将编译产生的 mtproto-proxy 二进制文件复制到一键管理脚本所在目录下，再次启动<br>\n  ③. 有可能出现无法运行的情况，可以将原版代码中 common/pid.c 中的这一行注释掉，重新编译，重复上面的步骤：</p>\n<figure class=\"highlight c\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">assert (!(p &amp; <span class=\"number\">0xffff0000</span>));</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://github.com/TelegramMessenger/MTProxy\">MTProxy</a></li>\n<li><a href=\"https://github.com/sunpma/mtp\">MTProxy TLS 绿色版一键安装脚本</a></li>\n<li><a href=\"https://github.com/ellermister/mtproxy\">mtproxy</a></li>\n<li><a href=\"https://www.zxar520.com/linux/1439.html\">MTProxy+FakeTLS|Telegram 稳定代理配置教程</a></li>\n<li><a href=\"http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html\">Systemd 入门教程：命令篇</a></li>\n</ol>\n","categories":["软件/程序"],"tags":["教程","MTProxy"]},{"title":"博客成长日志 | 服务器迁移","url":"/posts/202103-move.html","content":"<div class=\"note info flat\"><p>本文记录迁移过程备忘，方便后面再次迁移</p>\n</div>\n<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>阿里云 ECS 学生机要过期了，由于自己曾经升级过 ECS 的带宽（从 1M 到 3M），所以不能享受续费优惠，无奈之下，只能选择进行服务器迁移。备选的方案有腾讯云 CVM、阿里云轻量应用服务器和硅云 ECS。</p>\n<span id=\"more\"></span>\n<p>硅云最早被 Pass，毕竟和前面两家大厂相比不论是产品可选择性还是可靠性都略显不足，只能放在次要选择。腾讯云有学生优惠，2H4G3M 服务器 400 + 一年，还可以同样价格续费，很实惠。不过最终综合价格和便捷，还是选择了阿里云，初购 96 / 年的轻量应用服务器，毕竟我的 RDS 数据库和 OSS（被我用又拍云云储存顶替了）都是阿里云的。</p>\n<h2 id=\"准备\">准备 <a class=\"header-anchor\" href=\"#准备\">¶</a></h2>\n<p>买好服务器后，首先配置一下 shh 免密码登录，方便后面的过程进行。</p>\n<p>下一步查看一下有哪些东西需要进行迁移。我的服务都已经添加了监控，可以直接在<a href=\"https://status.foolishfox.cn/\">监控 - 服务</a>看到：<br>\n<img src=\"https://asset.foolishfox.cn/2021/03/status.png\" alt=\"\"></p>\n<p>仔细清点过后，需要进行迁移的服务有：</p>\n<ul>\n<li>API-Img: 图片、视频等静态文件 API，阿里云 OSS -&gt; 又拍云云储存</li>\n<li> API-Waline: 评论后台，ECS -&gt; swas</li>\n<li>Site-Blog: 博客主体，ECS -&gt; swas</li>\n<li>Site-Editor: 在线编辑器，ECS -&gt; swas</li>\n<li>Site-Guard: ServerStatus，ECS -&gt; swas</li>\n<li>Site-Travel: 旅行地图，ECS -&gt; swas</li>\n</ul>\n<h2 id=\"迁移\">迁移 <a class=\"header-anchor\" href=\"#迁移\">¶</a></h2>\n<h3 id=\"API-Img\">API-Img<a class=\"header-anchor\" href=\"#API-Img\">¶</a></h3>\n<p>根据又拍云文档创建云储存服务，更改 asset.foolishfox.cn 的 CNAME 的解析，备份文件即可。</p>\n<h3 id=\"Site-Blog\">Site-Blog<a class=\"header-anchor\" href=\"#Site-Blog\">¶</a></h3>\n<p>又进行一次之前的迁移，可以看之前的<a href=\"/posts/202012-heog.html\">文章</a>。</p>\n<p>为了方便下一步的安装，可以选择安装 <code>n</code> 进行 <code>Node.js</code> 的版本管理，另外还可以更改 <code>npm</code> 源为淘宝源，加快下载、安装速度。<br>\n<img src=\"https://asset.foolishfox.cn/2021/03/nodejs.png\" alt=\"\"></p>\n<h3 id=\"Site-Editor\">Site-Editor<a class=\"header-anchor\" href=\"#Site-Editor\">¶</a></h3>\n<p>进行了上一步之后，服务器已经安装好了 <code>Node.js</code> 环境，剩下的只需要安照<a href=\"https://winwin_2011.gitee.io/winwin-hexo-editor/\">文档</a>安装即可。</p>\n<p>使用 <code>pm2</code> 启动后，需要设置 <code>Nginx</code> 反向代理，方便通过域名进行访问。例如 <code>winwin-hexo-editor</code> 运行在 8900 端口，设置 <code>write.foolishfox.cn</code> 的反向代理为 <code>127.0.0.1:8900</code>。</p>\n<h3 id=\"Site-Guard\">Site-Guard<a class=\"header-anchor\" href=\"#Site-Guard\">¶</a></h3>\n<p>ServerStatus 一开始是一个老外的项目，可以理解为多服务器探针、多服务器云监控。后来国人进行了汉化和修改，我这里使用的是 <a href=\"https://github.com/nyawork/\">nyawork</a> 开发的 <a href=\"https://github.com/nyawork/ServerStatus-Hotaru\">ServerStatus-Hotaru</a> 版本。安装十分简单，只需要下载好文件，按照步骤进行即可。</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">root@vultr:~# wget https://raw.githubusercontent.com/nyawork/ServerStatus-Hotaru/master/status.sh</span><br><span class=\"line\">root@vultr:~# <span class=\"built_in\">chmod</span> +x status.sh</span><br></pre></td></tr></tbody></table></figure>\n<p>因为要从 Github 下载文件，所以安装速度比较慢。例如下载 <code>master.zip</code>，可以打开 <code>status.sh</code> 文件找到下载链接，下载好之后更改文件名为 <code>master.zip</code>，再上传到 <code>/tmp</code> 文件夹下，这样速度会快很多。除了 <code>master.zip</code>，还有一个文件是 <code>jq</code>，事先创建好 <code>/usr/local/ServerStatus</code> 文件夹，将下载好的文件重命名后放在该文件下。<br>\n<img src=\"https://asset.foolishfox.cn/2021/03/file.png\" alt=\"\"></p>\n<p>要修改的话，可以直接更改 <code>/usr/local/ServerStatus/server/config.json</code> 文件，重启 <code>status.sh</code> 即可。</p>\n<h3 id=\"API-Waline\">API-Waline<a class=\"header-anchor\" href=\"#API-Waline\">¶</a></h3>\n<p><a href=\"https://waline.js.org/\">waline</a> 是由 <a href=\"https://github.com/lizheming\">lizheming</a> 开发的博客评论系统，是最难配置的一部分。Waline 有多达 48 钟部署方式，下面介绍两种部署方式：</p>\n<h4 id=\"Docker\">Docker<a class=\"header-anchor\" href=\"#Docker\">¶</a></h4>\n<p>由于有自己的服务器和数据库，最开始选择了 Waline/client+Docker+MySQL 的方式进行部署。</p>\n<ol>\n<li>修改 <code>Node.js</code> 淘宝源</li>\n<li>构建镜像 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/lizheming/waline.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> waline</span><br><span class=\"line\">docker build -t lizheming/waline -f packages/server/Dockerfile .</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>修改配置 <code>packages/client/.env</code></li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">SITE_NAME=Fox Home</span><br><span class=\"line\">SITE_URL=https://foolishfox.cn</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置参考：</span><br><span class=\"line\"># https://waline.js.org/server/databases.html</span><br><span class=\"line\"># https://waline.js.org/server/notification.html</span><br><span class=\"line\">MYSQL_HOST=127.0.0.1</span><br><span class=\"line\">MYSQL_DB=db_name</span><br><span class=\"line\">MYSQL_USER=db_user</span><br><span class=\"line\">MYSQL_PASSWORD=password</span><br><span class=\"line\">SC_KEY=SCK232027Td54bfab83cfabf0aereq2c31b6552cd35fe1a43720074</span><br><span class=\"line\">AUTHOR_EMAIL=fox@foolishfox.cn</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"4\">\n<li>运行镜像 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">docker run --env-file ./packages/client/.env -p 8360:8360 -d lizheming/waline</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"5\">\n<li>设置反向目录代理，将 <code>waline.foolishfox.cn</code> 指向 <code>127.0.0.1:8360</code></li>\n</ol>\n<h4 id=\"独立部署\">独立部署 <a class=\"header-anchor\" href=\"#独立部署\">¶</a></h4>\n<p>由于方便对配置进行修改，不需要更新镜像等原因，后来弃用了 Docker 部署，改为直接使用 <code>Node.js</code> 运行。</p>\n<ol>\n<li>安装 waline</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> walinejs &amp;&amp; <span class=\"built_in\">cd</span> walinejs</span><br><span class=\"line\">cnpm install @waline/vercel --save</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>编辑<code>.bashrc</code>，添加环境变量，最好将字符串用 <code>\"</code> 或者<code>'</code> 包起来，避免 <code>$</code>、<code>&amp;</code> 等字符的影响</li>\n<li>创建软链接，方便后续操作 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">ln</span> -s node_modules/@waline/vercel ./waline</span><br><span class=\"line\"><span class=\"built_in\">cd</span> waline</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"4\">\n<li>配置服务端 <code>vim config.js</code></li>\n</ol>\n<figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = {</span><br><span class=\"line\">    <span class=\"attr\">secureDomains</span>: [</span><br><span class=\"line\">        <span class=\"string\">'localhost'</span>,</span><br><span class=\"line\">        <span class=\"string\">'127.0.0.1'</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"5\">\n<li>修改主程序 <code>vanilla.js</code></li>\n</ol>\n<figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">Application</span> = <span class=\"built_in\">require</span>(<span class=\"string\">'thinkjs'</span>);</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">let</span> config = {}</span><br><span class=\"line\"><span class=\"keyword\">try</span> {</span><br><span class=\"line\">    config = <span class=\"built_in\">require</span>(<span class=\"string\">'./config.js'</span>);</span><br><span class=\"line\">} <span class=\"keyword\">catch</span>(e) {}</span><br><span class=\"line\">...</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"6\">\n<li>使用 pm2 运行程序 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">cnpm install -g pm2</span><br><span class=\"line\">pm2 start vanilla.js --name waline</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"7\">\n<li>设置反向目录代理，将 <code>waline.foolishfox.cn</code> 指向 <code>127.0.0.1:8360</code></li>\n</ol>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://segmentfault.com/a/1190000023054090\">Windows SSH 免密登录详解</a></li>\n<li><a href=\"/posts/202012-heog.html\">从 WordPress 搬迁 —— 使用 Hexo 搭建博客</a></li>\n<li><a href=\"https://newsn.net/say/node-n.html\">如何利用 n 轻松切换 nodejs 的版本</a></li>\n<li><a href=\"https://winwin_2011.gitee.io/winwin-hexo-editor/\">winwin-hexo-editor</a></li>\n<li><a href=\"https://github.com/nyawork/ServerStatus-Hotaru\">ServerStatus-Hotaru</a></li>\n<li><a href=\"https://github.com/yc111/footprint\">footprint</a></li>\n<li><a href=\"https://waline.js.org/\">waline</a></li>\n</ol>\n","categories":["软件/程序","博客成长日志"],"tags":["教程","Hexo","Waline"]},{"title":"折腾日志 | 使用 Echarts 绘制名侦探柯南人物关系图","url":"/posts/202104-conan.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>《名侦探柯南绯色的子弹》就要上映了，npy 想要和我一起去看，但是她又搞不懂人物关系，所以就用 <code>Echarts</code> 做一个柯南的人物关系表了解一下。</p>\n<p><code>ECharts</code> 是使用 <code>JavaScript</code> 实现的开源可视化库，可以做出很多精巧的图片，最初由百度团队开源，后于 2018 年初捐赠给 Apache 基金会，成为 ASF 孵化级项目。</p>\n<span id=\"more\"></span>\n<h2 id=\"步骤\">步骤 <a class=\"header-anchor\" href=\"#步骤\">¶</a></h2>\n<ol>\n<li> 引入 <code>jquery</code> 和 <code>echarts</code> 的 js 文件 </li>\n</ol>\n<figure class=\"highlight html\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"https://cdn.jsdelivr.net/npm/jquery@v3.6.0/dist/jquery.min.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"https://cdn.bootcdn.net/ajax/libs/echarts/5.0.2/echarts.min.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>获取<a href=\"https://asset.foolishfox.cn/files/2021/Detective-Conan.json\">人物关系 json 文件</a></li>\n</ol>\n<p>json 文件中主要分为 3 部分，分别是 <code>nodes</code> 表示人物，<code>links</code> 表示关系连接，<code>categories</code> 表示阵营 / 类别。</p>\n<ul>\n<li>nodes</li>\n</ul>\n<figure class=\"highlight json\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">{</span></span><br><span class=\"line\">    <span class=\"comment\">// 必填，二选一</span></span><br><span class=\"line\">    <span class=\"attr\">\"id\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"0\"</span><span class=\"punctuation\">,</span>   <span class=\"comment\">// 人物id</span></span><br><span class=\"line\">    <span class=\"attr\">\"name\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"柯南\"</span><span class=\"punctuation\">,</span>   <span class=\"comment\">// 人物名称</span></span><br><span class=\"line\">    <span class=\"comment\">// 选填</span></span><br><span class=\"line\">    <span class=\"attr\">\"symbolSize\"</span><span class=\"punctuation\">:</span> <span class=\"number\">50</span><span class=\"punctuation\">,</span>   <span class=\"comment\">// 点的大小</span></span><br><span class=\"line\">    <span class=\"attr\">\"value\"</span><span class=\"punctuation\">:</span> <span class=\"number\">100</span><span class=\"punctuation\">,</span>   <span class=\"comment\">// 力引导布局(force)中连线长度</span></span><br><span class=\"line\">    <span class=\"attr\">\"category\"</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span>   <span class=\"comment\">// 人物类别</span></span><br><span class=\"line\">    <span class=\"attr\">\"itemStyle\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span>   <span class=\"comment\">// 自定义样式</span></span><br><span class=\"line\">        <span class=\"attr\">\"normal\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">            <span class=\"attr\">\"color\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"blue\"</span></span><br><span class=\"line\">        <span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span></span><br><span class=\"line\"><span class=\"punctuation\">}</span></span><br></pre></td></tr></tbody></table></figure>\n<ul>\n<li>links</li>\n</ul>\n<figure class=\"highlight json\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">{</span></span><br><span class=\"line\">    <span class=\"comment\">// 必填</span></span><br><span class=\"line\">    <span class=\"attr\">\"source\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"1\"</span><span class=\"punctuation\">,</span>   <span class=\"comment\">// 源节点名称或者id</span></span><br><span class=\"line\">    <span class=\"attr\">\"target\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"0\"</span><span class=\"punctuation\">,</span>   <span class=\"comment\">// 目标节点名称或者id</span></span><br><span class=\"line\">    <span class=\"comment\">// 选填</span></span><br><span class=\"line\">    <span class=\"attr\">\"value\"</span><span class=\"punctuation\">:</span> <span class=\"number\">100</span><span class=\"punctuation\">,</span>   <span class=\"comment\">// 力引导布局(force)中连线长度</span></span><br><span class=\"line\">    <span class=\"attr\">\"name\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"伙伴\"</span>   <span class=\"comment\">// 关系名称</span></span><br><span class=\"line\"><span class=\"punctuation\">}</span></span><br></pre></td></tr></tbody></table></figure>\n<ul>\n<li>categories</li>\n</ul>\n<figure class=\"highlight json\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">{</span></span><br><span class=\"line\">    <span class=\"comment\">// 必填</span></span><br><span class=\"line\">    <span class=\"attr\">\"name\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"黑衣组织\"</span><span class=\"punctuation\">,</span>   <span class=\"comment\">// 类别名称</span></span><br><span class=\"line\">    <span class=\"comment\">// 选填</span></span><br><span class=\"line\">    <span class=\"attr\">\"symbol\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"circle\"</span><span class=\"punctuation\">,</span>   <span class=\"comment\">// 类目节点标记的图形</span></span><br><span class=\"line\">    <span class=\"attr\">\"symbolSize\"</span><span class=\"punctuation\">:</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span>   <span class=\"comment\">// 类目节点的默认大小</span></span><br><span class=\"line\"><span class=\"punctuation\">}</span></span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>配置前端 </li>\n</ol>\n<figure class=\"highlight html\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"conan_container\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n<figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> conan = echarts.<span class=\"title function_\">init</span>(<span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"conan_container\"</span>));</span><br><span class=\"line\">    <span class=\"keyword\">var</span> option;</span><br><span class=\"line\">    conan.<span class=\"title function_\">showLoading</span>();</span><br><span class=\"line\">    $.<span class=\"title function_\">getJSON</span>(<span class=\"string\">'https://asset.foolishfox.cn/files/2021/Detective-Conan.json'</span>, <span class=\"keyword\">function</span> (<span class=\"params\">graph</span>) {</span><br><span class=\"line\">        conan.<span class=\"title function_\">hideLoading</span>();</span><br><span class=\"line\">        option = {</span><br><span class=\"line\">            <span class=\"comment\">// 图表标题与位置</span></span><br><span class=\"line\">            <span class=\"attr\">title</span>: {</span><br><span class=\"line\">                <span class=\"attr\">text</span>: <span class=\"string\">'Detective Conan'</span>,</span><br><span class=\"line\">                <span class=\"attr\">top</span>: <span class=\"string\">'bottom'</span>,</span><br><span class=\"line\">                <span class=\"attr\">left</span>: <span class=\"string\">'right'</span></span><br><span class=\"line\">            },</span><br><span class=\"line\">            <span class=\"attr\">tooltip</span>: {},</span><br><span class=\"line\">            <span class=\"attr\">legend</span>: [{</span><br><span class=\"line\">                <span class=\"comment\">// selectedMode: 'single',</span></span><br><span class=\"line\">                <span class=\"attr\">data</span>: graph.<span class=\"property\">categories</span>.<span class=\"title function_\">map</span>(<span class=\"keyword\">function</span> (<span class=\"params\">a</span>) {</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> a.<span class=\"property\">name</span>;</span><br><span class=\"line\">                })</span><br><span class=\"line\">            }],</span><br><span class=\"line\">            <span class=\"attr\">animationDuration</span>: <span class=\"number\">1500</span>,</span><br><span class=\"line\">            <span class=\"attr\">animationEasingUpdate</span>: <span class=\"string\">'quinticInOut'</span>,</span><br><span class=\"line\">            <span class=\"attr\">series</span>: [</span><br><span class=\"line\">                {</span><br><span class=\"line\">                    <span class=\"attr\">name</span>: <span class=\"string\">'Detective Conan'</span>,</span><br><span class=\"line\">                    <span class=\"attr\">type</span>: <span class=\"string\">'graph'</span>,</span><br><span class=\"line\">                    <span class=\"comment\">// 布局，none使用节点中提供的x、y作为节点的位置；circular采用环形布局；force采用力引导布局</span></span><br><span class=\"line\">                    <span class=\"attr\">layout</span>: <span class=\"string\">'circular'</span>,</span><br><span class=\"line\">                    <span class=\"attr\">data</span>: graph.<span class=\"property\">nodes</span>,</span><br><span class=\"line\">                    <span class=\"attr\">links</span>: graph.<span class=\"property\">links</span>,</span><br><span class=\"line\">                    <span class=\"attr\">categories</span>: graph.<span class=\"property\">categories</span>,</span><br><span class=\"line\">                    <span class=\"attr\">symbolSize</span>: <span class=\"number\">15</span>,</span><br><span class=\"line\">                    <span class=\"attr\">value</span>: <span class=\"number\">30</span>,</span><br><span class=\"line\">                    <span class=\"attr\">roam</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">                    <span class=\"attr\">label</span>: {</span><br><span class=\"line\">                        <span class=\"attr\">show</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">                        <span class=\"attr\">position</span>: <span class=\"string\">'right'</span>,</span><br><span class=\"line\">                        <span class=\"attr\">formatter</span>: <span class=\"string\">'{b}'</span></span><br><span class=\"line\">                    },</span><br><span class=\"line\">                    <span class=\"attr\">labelLayout</span>: {</span><br><span class=\"line\">                        <span class=\"attr\">hideOverlap</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">                    },</span><br><span class=\"line\">                    <span class=\"attr\">lineStyle</span>: {</span><br><span class=\"line\">                        <span class=\"attr\">color</span>: <span class=\"string\">'source'</span>,</span><br><span class=\"line\">                        <span class=\"attr\">curveness</span>: <span class=\"number\">0.3</span></span><br><span class=\"line\">                    },</span><br><span class=\"line\">                    <span class=\"comment\">// 突出显示有连接的人物</span></span><br><span class=\"line\">                    <span class=\"attr\">emphasis</span>: {</span><br><span class=\"line\">                        <span class=\"attr\">focus</span>: <span class=\"string\">'adjacency'</span>,</span><br><span class=\"line\">                        <span class=\"attr\">lineStyle</span>: {</span><br><span class=\"line\">                            <span class=\"attr\">width</span>: <span class=\"number\">10</span></span><br><span class=\"line\">                        }</span><br><span class=\"line\">                    },</span><br><span class=\"line\">                    <span class=\"comment\">// 缩放限制</span></span><br><span class=\"line\">                    <span class=\"attr\">scaleLimit</span>: {</span><br><span class=\"line\">                        <span class=\"attr\">min</span>: <span class=\"number\">0.6</span>,</span><br><span class=\"line\">                        <span class=\"attr\">max</span>: <span class=\"number\">3</span></span><br><span class=\"line\">                    }</span><br><span class=\"line\">                    <span class=\"comment\">// 显示links的名称</span></span><br><span class=\"line\">                    <span class=\"comment\">// edgeSymbolSize: [4, 10],</span></span><br><span class=\"line\">                    <span class=\"comment\">// edgeLabel: {</span></span><br><span class=\"line\">                    <span class=\"comment\">//     show: true,</span></span><br><span class=\"line\">                    <span class=\"comment\">//     formatter: function (x) {</span></span><br><span class=\"line\">                    <span class=\"comment\">//         return x.data.name;</span></span><br><span class=\"line\">                    <span class=\"comment\">//     },</span></span><br><span class=\"line\">                    <span class=\"comment\">//     textStyle: {</span></span><br><span class=\"line\">                    <span class=\"comment\">//         fontSize: 20</span></span><br><span class=\"line\">                    <span class=\"comment\">//     }</span></span><br><span class=\"line\">                    <span class=\"comment\">// },</span></span><br><span class=\"line\">                    <span class=\"comment\">// 力引导布局的设置</span></span><br><span class=\"line\">                    <span class=\"comment\">// force: {</span></span><br><span class=\"line\">                    <span class=\"comment\">//     repulsion: 2500,</span></span><br><span class=\"line\">                    <span class=\"comment\">//     edgeLength: [10, 50]</span></span><br><span class=\"line\">                    <span class=\"comment\">// },</span></span><br><span class=\"line\">                }</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        };</span><br><span class=\"line\">        conan.<span class=\"title function_\">setOption</span>(option);</span><br><span class=\"line\">    });</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (option &amp;&amp; <span class=\"keyword\">typeof</span> option === <span class=\"string\">'object'</span>) {</span><br><span class=\"line\">        conan.<span class=\"title function_\">setOption</span>(option);</span><br><span class=\"line\">    }</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"效果展示\">效果展示 <a class=\"header-anchor\" href=\"#效果展示\">¶</a></h2>\n<script type=\"text/javascript\" src=\"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js\"></script>\n<script type=\"text/javascript\" src=\"https://cdn.bootcdn.net/ajax/libs/echarts/5.0.2/echarts.min.js\"></script>\n<div id=\"conan_container\" style=\"max-width: 900px;height: 600px;\"></div>\n\n<div class=\"js-pjax\">\n<script type=\"text/javascript\">\n    var conan = echarts.init(document.getElementById(\"conan_container\"));\n    var option;\n    conan.showLoading();\n    $.getJSON('https://asset.foolishfox.cn/files/2021/Detective-Conan.json', function (graph) {\n        conan.hideLoading();\n        option = {\n            title: {\n                text: 'Detective Conan',\n                top: 'bottom',\n                left: 'right'\n            },\n            tooltip: {\n                formatter: function (x) {\n                    return x.data.des;\n                }\n            },\n            legend: [{\n                // selectedMode: 'single',\n                data: graph.categories.map(function (a) {\n                    return a.name;\n                })\n            }],\n            animationDuration: 1500,\n            animationEasingUpdate: 'quinticInOut',\n            series: [\n                {\n                    name: 'Detective Conan',\n                    type: 'graph',\n                    layout: 'circular',\n                    data: graph.nodes,\n                    links: graph.links,\n                    categories: graph.categories,\n                    symbolSize: 15,\n                    value: 30,\n                    roam: true,\n                    label: {\n                        show: true,\n                        position: 'right',\n                        formatter: '{b}'\n                    },\n                    labelLayout: {\n                        hideOverlap: true\n                    },\n                    lineStyle: {\n                        color: 'source',\n                        curveness: 0.3\n                    },\n                    emphasis: {\n                        focus: 'adjacency',\n                        lineStyle: {\n                            width: 10\n                        }\n                    },\n                    scaleLimit: {\n                        min: 0.6,\n                        max: 3\n                    }\n                }\n            ]\n        };\n        conan.setOption(option);\n    });\n    if (option && typeof option === 'object') {\n        conan.setOption(option);\n    }\n</script>\n</div>\n\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://blog.csdn.net/weixin_38409915/article/details/114369054\">人物关系图谱：ECharts 实现</a></li>\n<li><a href=\"https://echarts.apache.org/examples/zh/index.html\">Echarts 文档</a></li>\n<li><a href=\"https://echarts.apache.org/zh/option.html\">Echarts 示例</a></li>\n</ol>\n","categories":["软件/程序"],"tags":["Echarts","名侦探柯南"]},{"title":"博客成长日志 | 宝塔 Nginx 反向代理导致资源等重定向过多","url":"/posts/202104-redirect.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>在之前的文章<a href=\"/posts/202103-move.html\">博客服务器迁移过程</a>中介绍了 <code>footprint</code> 打造旅行地图，然后使用 Nginx 反向代理，将 <code>ff.cn/travel</code> 指向 <code>127.0.0.1:886</code>，原本访问一切正常，但是昨天碰到了一个新的问题：css/js/png 等文件请求 301 重定向过多，花了蛮久才解决问题，所以记下来提醒自己。</p>\n<span id=\"more\"></span>\n<h2 id=\"复现\">复现 <a class=\"header-anchor\" href=\"#复现\">¶</a></h2>\n<p>在网站 <code>/travel/</code> 目录下创建 <code>hello.js</code> 文件，请求 <code>ff.cn/travel/hello.js</code>，显示 <code>ff.cn 将您重定向的次数过多</code>。<br>\n<img src=\"https://asset.foolishfox.cn/2021/04/redirect.png\" alt=\"\"><br>\n在开发者模式下查看网络请求，发现服务器将 <code>ff.cn/travel/hello.js</code> 重定向给自身，导致出现死循环。<br>\n<img src=\"https://asset.foolishfox.cn/2021/04/request.png\" alt=\"\"></p>\n<h2 id=\"解决\">解决 <a class=\"header-anchor\" href=\"#解决\">¶</a></h2>\n<ol>\n<li> 清除 cookie (无效)</li>\n</ol>\n<div class=\"note quote flat\"><p>当相应网页尝试对您进行重定向的次数过多时，您就会看到这条错误消息。<br>\n有时，网页打不开是因为 Cookie 出问题了。要修正该错误，请尝试清除 Cookie。</p>\n</div>\n<ol start=\"2\">\n<li>刷新 DNS / 更换 DNS (无效)</li>\n</ol>\n<p>重定向过多可能发生了 DNS 劫持，可以刷新 DNS 或者换一个 DNS 地址。</p>\n<ol start=\"3\">\n<li>SSL 证书问题 (无效)</li>\n</ol>\n<p>如果开启了强制访问 HTTPS 或者 SSL 证书更换，可能导致前后端接口不一致，陷入反复跳转，造成重定向过多，可以重置 SSL 证书或者重启强制访问 HTTPS。</p>\n<h2 id=\"分析\">分析 <a class=\"header-anchor\" href=\"#分析\">¶</a></h2>\n<p>查看 Nginx 日志，发现浏览器发出请求 <code>ff.cn/travel/hello.js</code> 时，本应该转给 <code>127.0.0.1:886/hello.js</code>，然而日志中显示回应请求的链接是 <code>127.0.0.1:80/travel/hello.js</code>，怀疑是代理设置出现问题。<br>\n查看 <code>ff.cn</code> 的配置文件如下：</p>\n<figure class=\"highlight nginx\"><figcaption><span>configuration</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span></span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl http2;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> ff.cn;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.php index.html index.htm default.php default.htm default.html;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /ff.cn;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">#SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则</span></span><br><span class=\"line\">    <span class=\"comment\">#error_page 404/404.html;</span></span><br><span class=\"line\">    <span class=\"comment\">#HTTP_TO_HTTPS_START</span></span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$server_port</span> !<span class=\"regexp\">~ 443)</span>{</span><br><span class=\"line\">        <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(/.*)$</span> https://<span class=\"variable\">$host</span><span class=\"variable\">$1</span> <span class=\"literal\">permanent</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">#SSL-END</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">#ERROR-PAGE-START  错误页配置，可以注释、删除或修改</span></span><br><span class=\"line\">    <span class=\"comment\">#error_page 404 /404.html;</span></span><br><span class=\"line\">    <span class=\"comment\">#error_page 502 /502.html;</span></span><br><span class=\"line\">    <span class=\"comment\">#ERROR-PAGE-END</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">#PHP-INFO-START  PHP引用配置，可以注释或修改</span></span><br><span class=\"line\">    <span class=\"comment\">#清理缓存规则</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">location</span> <span class=\"regexp\">~ /purge(/.*)</span> {</span><br><span class=\"line\">        <span class=\"attribute\">proxy_cache_purge</span> cache_one <span class=\"variable\">$host</span><span class=\"variable\">$1</span><span class=\"variable\">$is_args</span><span class=\"variable\">$args</span>;</span><br><span class=\"line\">        <span class=\"comment\">#access_log  /www/wwwlogs/ff.cn_purge_cache.log;</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"comment\">#引用反向代理规则，注释后配置的反向代理将无效</span></span><br><span class=\"line\">    <span class=\"attribute\">include</span> /www/server/panel/vhost/nginx/proxy/ff.cn/<span class=\"regexp\">*.conf</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">include</span> enable-php-<span class=\"number\">00</span>.conf;</span><br><span class=\"line\">    <span class=\"comment\">#PHP-INFO-END</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">#REWRITE-START URL重写规则引用,修改后将导致面板设置的伪静态规则失效</span></span><br><span class=\"line\">    <span class=\"attribute\">include</span> /www/server/panel/vhost/rewrite/ff.cn.conf;</span><br><span class=\"line\">    <span class=\"comment\">#REWRITE-END</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">#禁止访问的文件或目录</span></span><br><span class=\"line\">    <span class=\"section\">location</span> <span class=\"regexp\">~ ^/(\\.user.ini|\\.htaccess|\\.git|\\.svn|\\.project|LICENSE|README.md)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">404</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">#一键申请SSL证书验证目录相关设置</span></span><br><span class=\"line\">    <span class=\"section\">location</span> <span class=\"regexp\">~ \\.well-known</span>{</span><br><span class=\"line\">        <span class=\"attribute\">allow</span> all;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"attribute\">access_log</span>  /www/wwwlogs/ff.cn.log;</span><br><span class=\"line\">    <span class=\"attribute\">error_log</span>  /www/wwwlogs/ff.cn.<span class=\"literal\">error</span>.log;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<figure class=\"highlight nginx\"><figcaption><span>configuration</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#PROXY-START/travel/</span></span><br><span class=\"line\"><span class=\"section\">location</span>  <span class=\"regexp\">~* \\.(php|jsp|js|css|png|cgi|asp|aspx)$</span></span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"attribute\">proxy_pass</span> http://127.0.0.1;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> REMOTE-HOST <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"section\">location</span> /travel/</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"attribute\">proxy_pass</span> http://127.0.0.1:886/;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> REMOTE-HOST <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"attribute\">add_header</span> X-Cache <span class=\"variable\">$upstream_cache_status</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">#Set Nginx Cache</span></span><br><span class=\"line\">    <span class=\"attribute\">add_header</span> Cache-Control <span class=\"literal\">no</span>-cache;</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"comment\">#PROXY-END/travel/</span></span><br></pre></td></tr></tbody></table></figure>\n<p>可以发现，问题出现在了代理配置中的 <code>location  ~* \\.(php|jsp|js|css|png|cgi|asp|aspx)$</code> 这一块。当接受到 <code>ff.cn/travel/hello.js</code> 请求时，根据代理配置进行转发，js/css/png 等文件匹配上了第一条规则，于是请求被发往 <code>127.0.0.1:80/travel/hello.js</code>，也就刚好是 <code>ff.cn/travel/hello.js</code> 自身，造成了死循环。将这一片段或者 <code>js|css|png</code> 删除即可解决</p>\n<h2 id=\"后记\">后记 <a class=\"header-anchor\" href=\"#后记\">¶</a></h2>\n<p>宝塔确实有点诡异，上一秒还好好访问的，结果突然就重定向了。以后碰到问题多看日志，更容易发现问题所在的地方。</p>\n","categories":["软件/程序","博客成长日志"],"tags":["Nginx","反向代理"]},{"title":"博客成长日志 | 评论系统 Waline","url":"/posts/202104-waline.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p><a href=\"https://waline.js.org/\">waline</a> 是由 <a href=\"https://github.com/lizheming\">lizheming</a> 开发的博客评论系统，从 <a href=\"https://valine.js.org/\">Valine</a> 衍生的带后端评论系统。可以将 <code>Waline</code> 等价成 <code>With backend Valine</code>。</p>\n<p>Waline 的服务端可以部署在 <a href=\"https://vercel.com/\">Vercel</a>、<a href=\"https://www.cloudbase.net\">CloudBase</a> 或者服务器上，数据库可以使用 <a href=\"https://www.leancloud.cn/\">LeanCloud</a>、MySQL 等，总计有多达 48 钟部署方式。在官方教程中，使用云服务部署都介绍的比较详细，下面介绍两种本地部署方式，可以自定义端口，配合多种数据库使用。</p>\n<span id=\"more\"></span>\n<h2 id=\"直接部署\">直接部署 <a class=\"header-anchor\" href=\"#直接部署\">¶</a></h2>\n<p>直接部署方便对配置进行修改，不需要更新镜像，安装好模块后使用 <code>Node.js</code> 运行模块内的 <code>vanilla.js</code> 文件即可。</p>\n<ol>\n<li>安装 waline</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> walinejs &amp;&amp; <span class=\"built_in\">cd</span> walinejs</span><br><span class=\"line\">cnpm install @waline/vercel --save</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>创建软链接，方便后续操作 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">ln</span> -s node_modules/@waline/vercel ./waline</span><br><span class=\"line\"><span class=\"built_in\">cd</span> waline</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>创建 <code>config.js</code> 文件，在里面可以添加自定义 Hook，方便用户根据自身业务需求对 Waline 服务端行为进行定制，可以参考<a href=\"https://waline.js.org/reference/server/config.html#%E8%AF%84%E8%AE%BA-hooks\">评论 Hooks</a>，以下为示例：</li>\n</ol>\n<details class=\"toggle\"><summary class=\"toggle-button\" style=\"color: green\">config.js</summary><div class=\"toggle-content\"><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">forbiddenNicks = [</span><br><span class=\"line\">    <span class=\"string\">\"forbidden\"</span></span><br><span class=\"line\">]</span><br><span class=\"line\">forbiddenMails = [</span><br><span class=\"line\">    <span class=\"string\">\"forbidden@example.com\"</span></span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = {</span><br><span class=\"line\">    <span class=\"comment\">// 禁止昵称或邮箱</span></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"title function_\">preSave</span>(<span class=\"params\">comment</span>) {</span><br><span class=\"line\">        <span class=\"keyword\">const</span> nick = comment.<span class=\"property\">nick</span>;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> mail = comment.<span class=\"property\">mail</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">const</span> regNick = <span class=\"keyword\">new</span> <span class=\"title class_\">RegExp</span>(<span class=\"string\">'('</span> + forbiddenNicks.<span class=\"title function_\">join</span>(<span class=\"string\">'|'</span>) + <span class=\"string\">')'</span>, <span class=\"string\">'ig'</span>);</span><br><span class=\"line\">        <span class=\"keyword\">const</span> regMail = <span class=\"keyword\">new</span> <span class=\"title class_\">RegExp</span>(<span class=\"string\">'('</span> + forbiddenMails.<span class=\"title function_\">join</span>(<span class=\"string\">'|'</span>) + <span class=\"string\">')'</span>, <span class=\"string\">'ig'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (regNick.<span class=\"title function_\">test</span>(nick) || regMail.<span class=\"title function_\">test</span>(mail)) {</span><br><span class=\"line\">            think.<span class=\"property\">logger</span>.<span class=\"title function_\">debug</span>(<span class=\"string\">`Comment nick or mail check result: spam`</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">\"403\"</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\">    },</span><br><span class=\"line\">    <span class=\"comment\">// 自动获取QQ邮箱，优先级高于 Gravatar</span></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"title function_\">avatarUrl</span>(<span class=\"params\">comment</span>) {</span><br><span class=\"line\">        <span class=\"keyword\">const</span> mail = comment.<span class=\"property\">mail</span>;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> regQQ = <span class=\"keyword\">new</span> <span class=\"title class_\">RegExp</span>(<span class=\"string\">'(\\\\d+)@qq\\\\.com$'</span>, <span class=\"string\">'i'</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (regQQ.<span class=\"title function_\">test</span>(mail)) {</span><br><span class=\"line\">            <span class=\"keyword\">const</span> q = mail.<span class=\"title function_\">replace</span>(<span class=\"regexp\">/@qq\\.com/i</span>, <span class=\"string\">''</span>).<span class=\"title function_\">toLowerCase</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">'https://q1.qlogo.cn/headimg_dl?dst_uin='</span> + q + <span class=\"string\">'&amp;spec=4'</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\">    },</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure></div></details>\n<ol start=\"4\">\n<li>创建 <code>ecosystem.config.js</code> 文件，内容如下：</li>\n</ol>\n<div class=\"note info flat\"><p>如果你想使用配置中的邮件模板，请注意修改各种链接与标题等</p>\n</div>\n<details class=\"toggle\"><summary class=\"toggle-button\" style=\"color: green\">ecosystem.config.js</summary><div class=\"toggle-content\"><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = {</span><br><span class=\"line\">    apps : [{</span><br><span class=\"line\">        <span class=\"attr\">name</span>: <span class=\"string\">'Waline'</span>,</span><br><span class=\"line\">        <span class=\"attr\">cwd</span>: <span class=\"string\">'./'</span>,</span><br><span class=\"line\">        <span class=\"attr\">script</span>: <span class=\"string\">'./vanilla.js'</span>,</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"attr\">watch</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"attr\">error_file</span>: <span class=\"string\">\"./logs/error.log\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">out_file</span>: <span class=\"string\">\"./logs/out.log\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">log_date_format</span>: <span class=\"string\">\"Z\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">merge_logs</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">env</span>: {</span><br><span class=\"line\">            <span class=\"attr\">port</span>: <span class=\"number\">8360</span>,</span><br><span class=\"line\">            <span class=\"attr\">NODE_ENV</span>: <span class=\"string\">'production'</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"attr\">IPQPS</span>: <span class=\"number\">180</span>,</span><br><span class=\"line\">            <span class=\"attr\">secureDomains</span>: [</span><br><span class=\"line\">                <span class=\"string\">'foolishfox.cn'</span>,</span><br><span class=\"line\">                <span class=\"string\">'waline.foolishfox.cn'</span></span><br><span class=\"line\">            ],</span><br><span class=\"line\">            <span class=\"attr\">forbiddenWords</span>: [</span><br><span class=\"line\">                <span class=\"string\">'空包'</span>,</span><br><span class=\"line\">                <span class=\"string\">'快递'</span></span><br><span class=\"line\">            ],</span><br><span class=\"line\">            <span class=\"attr\">disallowIPList</span>: [</span><br><span class=\"line\">                <span class=\"string\">'171.110.238.38'</span></span><br><span class=\"line\">            ],</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"attr\">SITE_NAME</span>: <span class=\"string\">'Fox Home'</span>,</span><br><span class=\"line\">            <span class=\"attr\">SITE_URL</span>: <span class=\"string\">'https://foolishfox.cn'</span>,</span><br><span class=\"line\">            <span class=\"attr\">AUTHOR_EMAIL</span>: <span class=\"string\">'fox@foolishfox.cn'</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"attr\">AVATAR_PROXY</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">            <span class=\"attr\">GRAVATAR_STR</span>: <span class=\"string\">'https://cravatar.cn/avatar/{{mail|md5}}'</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"attr\">MYSQL_HOST</span>: <span class=\"string\">'localhost'</span>,</span><br><span class=\"line\">            <span class=\"attr\">MYSQL_DB</span>: <span class=\"string\">'db'</span>,</span><br><span class=\"line\">            <span class=\"attr\">MYSQL_USER</span>: <span class=\"string\">'user'</span>,</span><br><span class=\"line\">            <span class=\"attr\">MYSQL_PASSWORD</span>: <span class=\"string\">'password'</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"attr\">SMTP_USER</span>: <span class=\"string\">'fox@foolishfox.cn'</span>,</span><br><span class=\"line\">            <span class=\"attr\">SMTP_PASS</span>: <span class=\"string\">'password'</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"attr\">mailSubject</span>: <span class=\"string\">'叮咚！『Fox Home』上有人@了你'</span>,</span><br><span class=\"line\">            <span class=\"attr\">mailTemplate</span>: <span class=\"string\">`&lt;div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;style&gt;</span></span><br><span class=\"line\"><span class=\"string\">                .box{background-color:white;border-bottom:2px solid #EB6844;border-radius:10px;box-shadow:rgba(0, 0, 0, 0.08) 0 0 18px;line-height:180%;width:500px;margin:50px auto;color:#555555;font-family:'Century Gothic','Trebuchet MS','Hiragino Sans GB',微软雅黑,'Microsoft Yahei',Tahoma,Helvetica,Arial,'SimSun',sans-serif;font-size:12px;}</span></span><br><span class=\"line\"><span class=\"string\">                .box .head{border-bottom:1px solid whitesmoke;font-size:14px;font-weight:normal;padding-bottom:15px;margin-bottom:15px;text-align: center;line-height: 28px;}</span></span><br><span class=\"line\"><span class=\"string\">                .box .head h3{margin-bottom: 0;margin: 0;}</span></span><br><span class=\"line\"><span class=\"string\">                .box .head .title{color: #EB6844;font-weight:bold;}</span></span><br><span class=\"line\"><span class=\"string\">                .box .body{padding:0 15px}</span></span><br><span class=\"line\"><span class=\"string\">                .box .body .content{background-color: #f5f5f5;padding: 10px 15px;margin:18px 0;word-wrap:break-word;}</span></span><br><span class=\"line\"><span class=\"string\">                a{text-decoration:none; color:#EB6844}</span></span><br><span class=\"line\"><span class=\"string\">                img{max-width: 100%;display:block;margin:0 auto;border-radius: inherit;border-bottom-left-radius:unset;border-bottom-right-radius:unset;}</span></span><br><span class=\"line\"><span class=\"string\">                .button:hover{background:#EB6844;color:#ffffff}</span></span><br><span class=\"line\"><span class=\"string\">                .button{display: block;margin: 0 auto;width: 15%;line-height: 35px;padding: 0 15px;border:1px solid currentColor;border-radius: 50px;text-align: center;font-weight: bold;}</span></span><br><span class=\"line\"><span class=\"string\">                .vemoji{display: inline-block;vertical-align: middle;width: 1.25em;margin: 0.25em;}</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/style&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=\"box\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;img src=\"https://asset.foolishfox.cn/images/static/fox_paint.jpg\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div class=\"head\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;h3&gt; {{parent.nick}} ，&lt;/h3&gt;有人回复了你在 &lt;a href=\"https://foolishfox.cn\" target=\"_blank\"&gt; Fox Home &lt;/a&gt;上的评论！</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;你评论的：</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div class=\"body\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=\"content\"&gt;{{parent.comment | safe}}&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;p&gt;被 &lt;strong&gt; {{self.nick}} &lt;/strong&gt;回复：&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=\"content\"&gt;{{self.comment | safe}}&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;p style=\"margin:20px auto\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;a class=\"button\" href=\"https://foolishfox.cn{{self.url}}\" target=\"_blank\"&gt; 点击查看 &lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;center&gt;欢迎再来 &lt;a href=\"https://foolishfox.cn\" target=\"_blank\"&gt;Fox Home&lt;/a&gt; ！ &lt;/center&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;p&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;`</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"attr\">MAIL_SUBJECT_ADMIN</span>: <span class=\"string\">'叮咚！『Fox Home』上有新评论啦~'</span>,</span><br><span class=\"line\">            <span class=\"attr\">MAIL_TEMPLATE_ADMIN</span>: <span class=\"string\">`&lt;div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;style&gt;</span></span><br><span class=\"line\"><span class=\"string\">                .box{background-color:white;border-bottom:2px solid #EB6844;border-radius:10px;box-shadow:rgba(0, 0, 0, 0.08) 0 0 18px;line-height:180%;width:500px;margin:50px auto;color:#555555;font-family:'Century Gothic','Trebuchet MS','Hiragino Sans GB',微软雅黑,'Microsoft Yahei',Tahoma,Helvetica,Arial,'SimSun',sans-serif;font-size:12px;}</span></span><br><span class=\"line\"><span class=\"string\">                .box .head{border-bottom:1px solid whitesmoke;font-size:14px;font-weight:normal;padding-bottom:15px;margin-bottom:15px;text-align: center;line-height: 28px;}</span></span><br><span class=\"line\"><span class=\"string\">                .box .head h3{margin-bottom: 0;margin: 0;}</span></span><br><span class=\"line\"><span class=\"string\">                .box .head .title{color: #EB6844;font-weight:bold;}</span></span><br><span class=\"line\"><span class=\"string\">                .box .body{padding:0 15px}</span></span><br><span class=\"line\"><span class=\"string\">                .box .body .content{background-color: #f5f5f5;padding: 10px 15px;margin:18px 0;word-wrap:break-word;}</span></span><br><span class=\"line\"><span class=\"string\">                a{text-decoration:none; color:#EB6844}</span></span><br><span class=\"line\"><span class=\"string\">                img{max-width: 100%;display:block;margin:0 auto;border-radius: inherit;border-bottom-left-radius:unset;border-bottom-right-radius:unset;}</span></span><br><span class=\"line\"><span class=\"string\">                .button:hover{background:#EB6844;color:#ffffff}</span></span><br><span class=\"line\"><span class=\"string\">                .button{display: block;margin: 0 auto;width: 15%;line-height: 35px;padding: 0 15px;border:1px solid currentColor;border-radius: 50px;text-align: center;font-weight: bold;}</span></span><br><span class=\"line\"><span class=\"string\">                .vemoji{display: inline-block;vertical-align: middle;width: 1.25em;margin: 0.25em;}</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/style&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=\"box\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;img src=\"https://asset.foolishfox.cn/static/fox_paint.jpg\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div class=\"head\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;h3&gt; {{self.nick}} ，&lt;/h3&gt;在 &lt;a href=\"https://foolishfox.cn\" target=\"_blank\"&gt; Fox Home &lt;/a&gt;上评论了！</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div class=\"body\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=\"content\"&gt;{{self.comment | safe}}&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;p style=\"margin:20px auto\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;a class=\"button\" href=\"https://foolishfox.cn{{self.url}}\" target=\"_blank\"&gt; 点击查看 &lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;`</span></span><br><span class=\"line\">        },</span><br><span class=\"line\">    }],</span><br><span class=\"line\"></span><br><span class=\"line\">    deploy : {</span><br><span class=\"line\">        production : {</span><br><span class=\"line\">            user : <span class=\"string\">'SSH_USERNAME'</span>,</span><br><span class=\"line\">            host : <span class=\"string\">'SSH_HOSTMACHINE'</span>,</span><br><span class=\"line\">            ref    : <span class=\"string\">'origin/master'</span>,</span><br><span class=\"line\">            repo : <span class=\"string\">'GIT_REPOSITORY'</span>,</span><br><span class=\"line\">            path : <span class=\"string\">'DESTINATION_PATH'</span>,</span><br><span class=\"line\">            <span class=\"string\">'pre-deploy-local'</span>: <span class=\"string\">''</span>,</span><br><span class=\"line\">            <span class=\"string\">'post-deploy'</span> : <span class=\"string\">'npm install &amp;&amp; pm2 reload ecosystem.config.js --env production'</span>,</span><br><span class=\"line\">            <span class=\"string\">'pre-setup'</span>: <span class=\"string\">''</span></span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure></div></details>\n<ol start=\"5\">\n<li>使用 pm2 运行程序 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">cnpm install -g pm2</span><br><span class=\"line\">pm2 start ecosystem.config.js</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"6\">\n<li>设置反向目录代理，将 <code>waline.foolishfox.cn</code> 指向 <code>127.0.0.1:8360</code></li>\n</ol>\n<h2 id=\"Docker\">Docker<a class=\"header-anchor\" href=\"#Docker\">¶</a></h2>\n<div class=\"note danger flat\"><p>关于 Docker 的相关信息已经过时</p>\n</div>\n<details class=\"toggle\"><summary class=\"toggle-button\" style=\"color: red\">docker 配置</summary><div class=\"toggle-content\"><p>在 Docker 容器内运行 <code>vanilla.js</code> 文件。</p>\n<ol>\n<li>修改 <code>Node.js</code> 淘宝源 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 单次使用</span></span><br><span class=\"line\">npm install module_name --registry=https://registry.npm.taobao.org</span><br><span class=\"line\"><span class=\"comment\"># 永久修改</span></span><br><span class=\"line\">npm config <span class=\"built_in\">set</span> registry https://registry.npm.taobao.org</span><br><span class=\"line\"><span class=\"comment\"># 使用cnpm，安装了cnpm之后，npm install 都可以换成cnpm install</span></span><br><span class=\"line\">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>构建镜像 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/lizheming/waline.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> waline</span><br><span class=\"line\">docker build -t image_name -f packages/server/Dockerfile .</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>修改配置 <code>packages/client/.env</code>，参考文档中所需环境变量配置即可</li>\n</ol>\n<details class=\"toggle\"><summary class=\"toggle-button\" style=\"color: yellow\">.env</summary><div class=\"toggle-content\"><figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">SKIP_PREFLIGHT_CHECK=<span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 数据库配置，参考https://waline.js.org/server/databases.html</span></span><br><span class=\"line\">MYSQL_HOST=127.0.0.1</span><br><span class=\"line\">MYSQL_DB=db_name</span><br><span class=\"line\">MYSQL_USER=db_user</span><br><span class=\"line\">MYSQL_PASSWORD=password</span><br><span class=\"line\"></span><br><span class=\"line\">AKISMET_KEY=guess</span><br><span class=\"line\"></span><br><span class=\"line\">SITE_NAME=Fox Home</span><br><span class=\"line\">SITE_URL=https://foolishfox.cn</span><br><span class=\"line\">AUTHOR_EMAIL=fox@foolishfox.cn</span><br><span class=\"line\"></span><br><span class=\"line\">SC_KEY=SCK232027Td54bfab83cfabf0aereq2c31b6552cd35fe1a43720074</span><br><span class=\"line\"></span><br><span class=\"line\">SMTP_HOST=smtp.ym.163.com</span><br><span class=\"line\">SMTP_PORT=465</span><br><span class=\"line\">SMTP_USER=fox@foolishfox.cn</span><br><span class=\"line\">SMTP_PASS=password</span><br><span class=\"line\">SENDER_NAME=fox</span><br><span class=\"line\">SENDER_EMAIL=fox@foolishfox.cn</span><br></pre></td></tr></tbody></table></figure></div></details>\n<ol start=\"4\">\n<li>运行镜像 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">docker run --env-file ./packages/client/.env -p 8360:8360 -d image_name</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"5\">\n<li>设置反向目录代理，将 <code>waline.foolishfox.cn</code> 指向 <code>127.0.0.1:8360</code></li>\n<li>进入容器 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看容器id</span></span><br><span class=\"line\">root@iZ2ze8k2vy63cz277rsw8zZ:$ docker ps -a</span><br><span class=\"line\">CONTAINER ID   IMAGE              COMMAND                  CREATED          STATUS          PORTS                    NAMES</span><br><span class=\"line\">cebd15a83483   lizheming/waline   <span class=\"string\">\"docker-entrypoint.s…\"</span>   44 seconds ago   Up 42 seconds   0.0.0.0:8360-&gt;8360/tcp   admiring_noether</span><br><span class=\"line\"><span class=\"comment\"># 进入容器</span></span><br><span class=\"line\">root@iZ2ze8k2vy63cz277rsw8zZ:$ docker <span class=\"built_in\">exec</span> -it cebd15a83483 /bin/bash</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"7\">\n<li>安装 <code>vim</code>（可跳过）与验证组件 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">apt update</span><br><span class=\"line\">apt install vim</span><br><span class=\"line\">apt install apt-transport-https ca-certificates</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"8\">\n<li>更新软件源（使用<a href=\"https://mirrors.tuna.tsinghua.edu.cn/help/debian/\">清华源</a>）</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 备份</span></span><br><span class=\"line\"><span class=\"built_in\">mv</span> /etc/apt/sources.list /etc/apt/sources.list.bak</span><br><span class=\"line\"><span class=\"comment\"># vim修改</span></span><br><span class=\"line\">vim /etc/apt/sources.list</span><br><span class=\"line\"><span class=\"comment\"># echo修改</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free\"</span> &gt;/etc/apt/sources.list</span><br><span class=\"line\"><span class=\"comment\"># 更新</span></span><br><span class=\"line\">apt update</span><br><span class=\"line\">...</span><br></pre></td></tr></tbody></table></figure>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释</span><br><span class=\"line\">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free</span><br><span class=\"line\"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free</span><br><span class=\"line\">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free</span><br><span class=\"line\"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free</span><br><span class=\"line\">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free</span><br><span class=\"line\"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free</span><br><span class=\"line\">deb https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free</span><br><span class=\"line\"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"9\">\n<li>配置 <code>config.js</code>，路径为：<code>node_modules/@waline/vercel/config.js</code>，参考<a href=\"https://waline.js.org/server/basic.html#%E4%BB%A3%E7%A0%81%E9%85%8D%E7%BD%AE\">服务端配置</a></li>\n</ol>\n<figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = {</span><br><span class=\"line\">    <span class=\"attr\">secureDomains</span>: [</span><br><span class=\"line\">        <span class=\"string\">'foolishfox.cn'</span>,</span><br><span class=\"line\">        <span class=\"string\">'waline.foolishfox.cn'</span>,</span><br><span class=\"line\">        <span class=\"string\">'localhost'</span>,</span><br><span class=\"line\">        <span class=\"string\">'127.0.0.1'</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">forbiddenWords</span>: [</span><br><span class=\"line\">        <span class=\"string\">'空包'</span>,</span><br><span class=\"line\">        <span class=\"string\">'快递'</span>,</span><br><span class=\"line\">        <span class=\"string\">'下单'</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">disallowIPList</span>: [</span><br><span class=\"line\">        <span class=\"string\">'8.8.8.8'</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"10\">\n<li>修改主程序 <code>vanilla.js</code>，导入自定义配置（已提交 PR 进行修复，无需再进行更改）</li>\n</ol>\n<figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">Application</span> = <span class=\"built_in\">require</span>(<span class=\"string\">'thinkjs'</span>);</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">let</span> config = {}</span><br><span class=\"line\"><span class=\"keyword\">try</span> {</span><br><span class=\"line\">    config = <span class=\"built_in\">require</span>(<span class=\"string\">'./config.js'</span>);</span><br><span class=\"line\">} <span class=\"keyword\">catch</span>(e) {}</span><br><span class=\"line\">...</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"前端配置\">前端配置 <a class=\"header-anchor\" href=\"#前端配置\">¶</a></h2>\n<p>参考<a href=\"https://waline.js.org/client/basic.html\">文档</a>，需要注意的有：</p>\n<ol>\n<li>本地 (localhost) 访问不增加计数（以 <code>hexo</code> 为例）</li>\n</ol>\n<figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Waline</span>({</span><br><span class=\"line\">    <span class=\"attr\">el</span>: <span class=\"string\">'#waline'</span>,</span><br><span class=\"line\">    <span class=\"attr\">path</span>: location.<span class=\"property\">pathname</span>,</span><br><span class=\"line\">    <span class=\"attr\">serverURL</span>: <span class=\"string\">'https://your-serverURL.domain.com'</span>,</span><br><span class=\"line\">    <span class=\"attr\">visitor</span>: location.<span class=\"property\">hostname</span>!==<span class=\"string\">'localhost'</span> &amp;&amp; !{ theme.<span class=\"property\">waline</span>.<span class=\"property\">visitor</span> }</span><br><span class=\"line\">});</span><br></pre></td></tr></tbody></table></figure></div></details>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://waline.js.org/\">waline</a></li>\n<li><a href=\"/posts/move.html\">博客服务器迁移过程</a></li>\n<li><a href=\"https://www.e-learn.cn/content/qita/2389149\">pm2 入门</a></li>\n</ol>\n","categories":["软件/程序","博客成长日志"],"tags":["教程","Waline"]},{"title":"随记 | 大熊座与小熊座","url":"/posts/202105-constellation1.html","content":"<h2 id=\"传说\">传说 <a class=\"header-anchor\" href=\"#传说\">¶</a></h2>\n<p>在古代希腊的神话故事中，大熊是温柔美丽的少女卡力斯托的化身。传说卡力斯托被众神之王宙斯所爱，生下了儿子阿卡斯。宙斯的妻子赫拉知道后非常气愤，她决定要用法力对卡力斯托进行惩罚，于是她把卡力斯托白暂的双臂变成了长满黑毛的利爪，娇红的双唇变成了血盆似的大口，让卡力斯托变成了一只大母熊。后来宙斯知道了，就把大熊提升到天上，成为大熊星座。</p>\n<span id=\"more\"></span>\n<p>而小熊是大熊卡力斯托的儿子阿卡斯。卡力斯托被宙斯的妻子赫拉所害变成一只大熊后，在悲哀和痛苦中度过了 15 个年头，这时卡力斯托的儿子阿卡斯长大了，成为一名英俊出色的猎手。一天，阿卡斯在林中打猎，被他的母亲卡力斯托看见了，她忘记了自己已经是熊身，便伸开双臂准备拥抱亲爱的孩子。但阿卡斯不知道这只大熊是自己的母亲，他急忙向大熊举起手中的长枪准备射击。幸亏宙斯，也就是阿卡斯的父亲，在天上看见了，他担心阿卡斯会杀死母亲，便用法术把阿卡斯也变成了一只小熊，并将母子俩一起都提升到天上，成为大熊座和小熊座。</p>\n<p>赫拉看到卡力斯托母子都被弄到天上，嫉妒之心油然而生。 她去请自己的哥哥海神波塞冬帮忙：永远不让卡力斯托母子从天上下海来休息喝水。于是，母子俩只得永远在北极上空转圈，不能下海。尽管如此，赫拉还不满足，她又选派一个猎人带着两只凶猛的猎犬，紧跟在大熊和小熊的后面。这个猎人就是天上的牧夫座，而他牵着的两只猎犬就是猎犬座，猎人和猎犬忠实执行神后赫拉交付的任务：紧紧看守着大熊和小熊，不停地追捕着。</p>\n<h2 id=\"星空\">星空 <a class=\"header-anchor\" href=\"#星空\">¶</a></h2>\n<p>大熊座是北方天空中最明亮、最重要的星座之一，著名的北斗七星就在这个星座里。大熊座一年四季都能看到，春季黄昏后是观测它的最好时机。在星图上，大熊座的星星被想象为一只大熊，北斗七星的斗柄是大熊的长长的尾巴，斗勺的四颗星是大熊的身躯，另一些较暗的星构成了大熊的头和脚。<br>\n<img src=\"https://asset.foolishfox.cn/2021/05/1622203030.jpg\" alt=\"\"></p>\n<p>北斗七星从勺口到柄尾依次是天枢、天璇、天玑、天权、玉衡、开阳、摇光。前四颗组成了斗身，叫做魁；后三颗组成了斗柄，叫做杓。而开阳是一个奇特的目视双星系统，伴星叫做开阳增一（也称为辅）。后续的研究发现，开阳和辅实际上就是双星系统，开阳就被分为了开阳 A（大熊座<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi> ζ</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup></mrow><annotation encoding=\"application/x-tex\">\\zeta'</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.946332em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07378em;\">ζ</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span>）和开阳 B（大熊座<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi> ζ</mi><mrow><mo mathvariant=\"normal\">′</mo><mo mathvariant=\"normal\">′</mo></mrow></msup></mrow><annotation encoding=\"application/x-tex\">\\zeta''</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.946332em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07378em;\">ζ</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span>）。</p>\n<p>1989 年光谱观测首先发现开阳 A 是分光双星，后来又发现开阳 B 也是分光双星，可能是三合星，所以开阳实际上是一个四合星甚至五合星系统。1996 年通过极高分辨率的望远镜拍摄出开阳 A 的两颗子星 A1 和 A2。<br>\n<img src=\"https://asset.foolishfox.cn/2021/05/20210528194950.png\" alt=\"\"><br>\n<img src=\"http://inews.gtimg.com/newsapp_match/0/8453683962/0.jpg\" alt=\"\"></p>\n<p>小熊座的 7 颗星星也被称为小北斗，其中除<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi> α</mi></mrow><annotation encoding=\"application/x-tex\">\\alpha</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">α</span></span></span></span>、<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>β</mi></mrow><annotation encoding=\"application/x-tex\">\\beta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">β</span></span></span></span> 是较亮的 2 等星外，其他都是较暗的星。因此，小熊座不如北斗七星那样耀眼，在明月之夜或大城市里就不容易看到。小熊座<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi> α</mi></mrow><annotation encoding=\"application/x-tex\">\\alpha</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">α</span></span></span></span>（勾陈一）就是现在的北极星，处于北斗七星中天枢和天璇的延长线上。<br>\n<img src=\"https://asset.foolishfox.cn/2021/05/1622201708-1-.jpg\" alt=\"\"></p>\n<p>在大熊星座的东南方向，有两个紧挨着的 “邻居”：东边的是牧夫座，西边的是猎犬座。猎犬座原先是大熊座的一部份，是北天星座中的小星座。猎犬座也是最暗的星座之一，其中只有一颗三等星。<br>\n<img src=\"https://asset.foolishfox.cn/2021/05/1622203502.jpg\" alt=\"\"></p>\n<p>牧夫座的大角星是全天第四亮星，之所以叫做大角是因为它被看作是四象之一的东方苍龙的一只角。此外牧夫座还包括了 8 颗 4 等以上和 21 颗 5 等以上的亮星，其中几颗中等亮度的星构成了一个五边形，像个大风筝，而最亮的大角星就像挂在风筝下面的一盏明灯。5 月下旬，沿着北斗七星斗柄几颗的曲线顺势延伸出去，画出一条大弧线，就可以在天顶附近的星空找到大角星。<br>\n<img src=\"https://asset.foolishfox.cn/2021/05/1622203810.png\" alt=\"\"></p>\n","categories":["随记","天文","科普"],"tags":["星座","观星"]},{"title":"折腾日志 | Termux 安装云探针","url":"/posts/202105-termux-status.html","content":"<div class=\"note info flat\"><p>有关 Termux 的详细教程，请查看 <a href=\"https://www.sqlsec.com/2018/05/termux.html\">Termux 高级终端安装使用配置教程 - 国光</a><br>\n以下内容可适用于其他 Linux 发行版</p>\n</div>\n<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>ServerStatus 可以实时监控服务器的网络、负载、内存占用等信息，也被称为云探针、多服务器探针、云监控、多服务器云监控，本人追溯到最早源自于 <a href=\"https://github.com/BotoX\">BotoX</a> 的<a href=\"https://github.com/BotoX/ServerStatus\">项目</a>。</p>\n<div class=\"note quote flat\"><p>Display and monitor your servers statistics in a beatiful way</p>\n</div>\n<span id=\"more\"></span>\n<p>后人经过多位大佬的修改、汉化和美化，已经有多个版本的 ServerStatus 可供部署，本文采用的是由 <a href=\"https://github.com/CokeMine\">CokeMine</a> 开发的 <a href=\"https://github.com/CokeMine/ServerStatus-Hotaru\">ServerStatus-Hotaru</a> 版本。</p>\n<h2 id=\"安装\">安装 <a class=\"header-anchor\" href=\"#安装\">¶</a></h2>\n<h3 id=\"服务端\">服务端 <a class=\"header-anchor\" href=\"#服务端\">¶</a></h3>\n<ol>\n<li> 获取文件 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">wget https://raw.githubusercontent.com/CokeMine/ServerStatus-Hotaru/master/status.sh</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x status.sh</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>安装服务端</li>\n</ol>\n<p>运行<code>./status.sh s</code>，配置按推荐即可，如果服务器上有 Nginx/Apache，则不需要安装 Caddy，否则建议选择 Y 一键配置 HTTP 服务<br>\n<img src=\"https://asset.foolishfox.cn/2021/05/status.png\" alt=\"\"></p>\n<ol start=\"3\">\n<li>添加客户端信息：打开 <code>/usr/local/ServerStatus/server/config.json</code>，修改如下:</li>\n</ol>\n<figure class=\"highlight json\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">{</span><span class=\"attr\">\"servers\"</span><span class=\"punctuation\">:</span></span><br><span class=\"line\"> <span class=\"punctuation\">[</span></span><br><span class=\"line\">  <span class=\"punctuation\">{</span></span><br><span class=\"line\">   <span class=\"attr\">\"username\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"A\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">   <span class=\"attr\">\"password\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"A\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">   <span class=\"attr\">\"name\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Fox Home\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">   <span class=\"attr\">\"type\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"KVM\"</span><span class=\"punctuation\">,</span>  <span class=\"comment\">// 现在一般云服务器都是KVM</span></span><br><span class=\"line\">   <span class=\"attr\">\"host\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">   <span class=\"attr\">\"location\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"杭州\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">   <span class=\"attr\">\"disabled\"</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">   <span class=\"attr\">\"region\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"CN\"</span>   <span class=\"comment\">// region信息在文件/usr/local/ServerStatus/region.json中</span></span><br><span class=\"line\">  <span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"punctuation\">{</span></span><br><span class=\"line\">    <span class=\"attr\">\"username\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"B\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"password\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"B\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"name\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Fox Lab\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"type\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"KVM\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"host\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"location\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"香港\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"disabled\"</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"region\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"HK\"</span></span><br><span class=\"line\">   <span class=\"punctuation\">}</span></span><br><span class=\"line\"> <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">}</span></span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"4\">\n<li>启动服务端</li>\n</ol>\n<h3 id=\"客户端\">客户端 <a class=\"header-anchor\" href=\"#客户端\">¶</a></h3>\n<p>运行<code>./status.sh c</code> 安装客户端，配置信息按照前文服务端配置（<code>username</code> 和 <code>password</code>）填写即可</p>\n<h2 id=\"其他\">其他 <a class=\"header-anchor\" href=\"#其他\">¶</a></h2>\n<h3 id=\"Termux适配\">Termux 适配 <a class=\"header-anchor\" href=\"#Termux适配\">¶</a></h3>\n<div class=\"note warning flat\"><p>Termux 端不建议按照服务端</p>\n</div>\n<p>从仓库中下载 <a href=\"https://raw.githubusercontent.com/CokeMine/ServerStatus-Hotaru/master/clients/status-client.py\">status-client.py</a>，对一下内容进行修改：</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">get_hdd</span>():</span><br><span class=\"line\">    p = subprocess.check_output([<span class=\"string\">'df'</span>]).decode(<span class=\"string\">'utf-8'</span>)</span><br><span class=\"line\">    <span class=\"comment\"># 在终端中运行df命令，查看/data对应的那一行的行号就是X+1</span></span><br><span class=\"line\">    total = p.splitlines()[X]</span><br><span class=\"line\">    used = <span class=\"built_in\">int</span>(total.split()[<span class=\"number\">2</span>])/<span class=\"number\">1024</span></span><br><span class=\"line\">    size = <span class=\"built_in\">int</span>(total.split()[<span class=\"number\">1</span>])/<span class=\"number\">1024</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">int</span>(size), <span class=\"built_in\">int</span>(used)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">get_load</span>():</span><br><span class=\"line\">    p = subprocess.check_output([<span class=\"string\">'uptime'</span>]).decode(<span class=\"string\">'utf-8'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">round</span>(<span class=\"built_in\">float</span>(p.split(<span class=\"string\">', '</span>)[<span class=\"number\">3</span>].split(<span class=\"string\">': '</span>)[<span class=\"number\">1</span>]), <span class=\"number\">2</span>)*<span class=\"number\">100</span></span><br><span class=\"line\">...</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"修改前端-主题\">修改前端 / 主题 <a class=\"header-anchor\" href=\"#修改前端-主题\">¶</a></h3>\n<p>由于前端文件已经被打包过了，所以不建议直接修改格式化打包后的 js/css 文件，建议自行下载修改再打包，复制 dist 目录到服务器。</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/CokeMine/Hotaru_theme.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ./Hotaru_theme &amp;&amp; npm install</span><br><span class=\"line\"><span class=\"comment\"># 修改完成之后</span></span><br><span class=\"line\">npm run build</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"Windows适配\">Windows 适配 <a class=\"header-anchor\" href=\"#Windows适配\">¶</a></h3>\n<p>使用 <a href=\"https://raw.githubusercontent.com/CokeMine/ServerStatus-Hotaru/master/clients/status-psutil.py\">Psutil 版</a>即可使 ServerStatus 客户端在 Windows 等平台运行</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">pip install psutil</span><br><span class=\"line\"><span class=\"comment\"># 修改status-psutil.py</span></span><br><span class=\"line\">python status-psutil.py</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://github.com/CokeMine/ServerStatus-Hotaru\">ServerStatus-Hotaru</a></li>\n<li><a href=\"https://www.cokemine.com/serverstatus-hotaru.html\">ServerStatus-Hotaru 云探针的安装与配置</a></li>\n<li><a href=\"https://github.com/CokeMine/ServerStatus-Hotaru/issues/75\">想改网页内的几个字 如何操作</a></li>\n</ol>\n","categories":["软件/程序","Termux"],"tags":["教程","Python","ServerStatus","Termux"]},{"title":"博客成长日志 | 准实时访问统计","url":"/posts/202105-visit.html","content":"<div class=\"note danger flat\"><p>由于百度统计改版，对数据作出限制，已弃用该方案。目前使用自建服务进行统计，可查看<a href=\"/posts/202209-umami.html\">博客成长日志 | 自建 Umami 统计</a></p>\n</div>\n<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>通过百度统计、CNZZ 等服务，我们可以记录站点的访问地图、访问量和来源，如果想要展示数据，可以选择直接导向服务商提供的公开页面，但是样式丑陋，所以本文通过百度统计 API，使用 Echarts 制作站点访问准实时统计页面，效果可以参考<a href=\"/statistics/\">统计</a>。</p>\n<span id=\"more\"></span>\n<p>之所以说是准实时统计，是因为为了解决跨域问题（CROS error），本文采用的方法是定时通过百度统计 API 将数据下载保存为 json 文件，放置在网站目录下（后续可能会发展为 vercel api，挖坑）。不过作为个人博客，方式访问量不会很大，没有必要实时更新，目前本站设置是每隔 6 小时更新一次。</p>\n<h2 id=\"数据获取\">数据获取 <a class=\"header-anchor\" href=\"#数据获取\">¶</a></h2>\n<h3 id=\"百度统计\">百度统计 <a class=\"header-anchor\" href=\"#百度统计\">¶</a></h3>\n<p>在设置样式之前首先需要获取统计数据，使用百度账号登陆<a href=\"https://tongji.baidu.com/web/welcome/login\">百度统计</a>，根据<a href=\"#refer-4\">参考资料 4</a> 进行操作，获取 token 与 site_id，具体教程可以查看<a href=\"#refer-1\">参考资料 1</a>。</p>\n<h3 id=\"下载文件\">下载文件 <a class=\"header-anchor\" href=\"#下载文件\">¶</a></h3>\n<p>通过 6 个链接，我们可以获取：一年内每日访问统计、访问地图数据、月度访问统计、来源分类统计、搜索引擎访问统计和外部链接访问统计；通过 python 或者 nodejs 都可以很方便的下载文件保存，以下为 python 的示例：</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> time, datetime</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开始统计的日期</span></span><br><span class=\"line\">start_date   = <span class=\"string\">'20201218'</span></span><br><span class=\"line\">date         = datetime.datetime.now()</span><br><span class=\"line\"><span class=\"comment\"># 结束统计的日期</span></span><br><span class=\"line\">end_date     = <span class=\"built_in\">str</span>(date.year) + (<span class=\"built_in\">str</span>(date.month) <span class=\"keyword\">if</span> date.month &gt; <span class=\"number\">9</span> <span class=\"keyword\">else</span> (<span class=\"string\">'0'</span> + <span class=\"built_in\">str</span>(date.month))) + (<span class=\"built_in\">str</span>(date.day) <span class=\"keyword\">if</span> date.day &gt; <span class=\"number\">9</span> <span class=\"keyword\">else</span> (<span class=\"string\">'0'</span> + <span class=\"built_in\">str</span>(date.day)))</span><br><span class=\"line\"><span class=\"comment\"># token和siteid</span></span><br><span class=\"line\">access_token = <span class=\"string\">'121.6e...'</span></span><br><span class=\"line\">site_id      = <span class=\"string\">'16******'</span></span><br><span class=\"line\"><span class=\"comment\"># 百度统计API</span></span><br><span class=\"line\">dataUrl      = <span class=\"string\">'https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token='</span> + access_token + <span class=\"string\">'&amp;site_id='</span> + site_id</span><br><span class=\"line\"><span class=\"comment\"># 统计访问次数 PV 填写 'pv_count'，统计访客数 UV 填写 'visitor_count'，二选一</span></span><br><span class=\"line\">metrics      = <span class=\"string\">'pv_count'</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">downFile</span>(<span class=\"params\">url, fileName, prefix=<span class=\"string\">'/home/API/data/'</span></span>):</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">'downloading :'</span>, url)</span><br><span class=\"line\">    down_res = requests.get(url)</span><br><span class=\"line\">    <span class=\"keyword\">with</span> <span class=\"built_in\">open</span>(prefix+fileName, <span class=\"string\">'wb'</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        f.write(down_res.content)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">'writing :'</span>, prefix+fileName)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 访客地图</span></span><br><span class=\"line\">downFile(dataUrl + <span class=\"string\">'&amp;start_date='</span> + start_date + <span class=\"string\">'&amp;end_date='</span> + end_date + <span class=\"string\">'&amp;metrics='</span> + metrics + <span class=\"string\">'&amp;method=visit/district/a'</span>, </span><br><span class=\"line\">    <span class=\"string\">'map.json'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 访问趋势</span></span><br><span class=\"line\">downFile(dataUrl + <span class=\"string\">'&amp;start_date='</span> + start_date + <span class=\"string\">'&amp;end_date='</span> + end_date + <span class=\"string\">'&amp;metrics='</span> + metrics + <span class=\"string\">'&amp;method=trend/time/a&amp;gran=month'</span>, </span><br><span class=\"line\">    <span class=\"string\">'trends.json'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 访问来源</span></span><br><span class=\"line\">downFile(dataUrl + <span class=\"string\">'&amp;start_date='</span> + start_date + <span class=\"string\">'&amp;end_date='</span> + end_date + <span class=\"string\">'&amp;metrics='</span> + metrics + <span class=\"string\">'&amp;method=source/all/a'</span>, </span><br><span class=\"line\">    <span class=\"string\">'sources.json'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 搜索引擎</span></span><br><span class=\"line\">downFile(dataUrl + <span class=\"string\">'&amp;start_date='</span> + start_date + <span class=\"string\">'&amp;end_date='</span> + end_date + <span class=\"string\">'&amp;metrics='</span> + metrics + <span class=\"string\">'&amp;method=source/engine/a'</span>, </span><br><span class=\"line\">    <span class=\"string\">'engine.json'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 外部链接</span></span><br><span class=\"line\">downFile(dataUrl + <span class=\"string\">'&amp;start_date='</span> + start_date + <span class=\"string\">'&amp;end_date='</span> + end_date + <span class=\"string\">'&amp;metrics='</span> + metrics + <span class=\"string\">'&amp;method=source/link/a'</span>, </span><br><span class=\"line\">    <span class=\"string\">'link.json'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 访问日历</span></span><br><span class=\"line\"><span class=\"string\">'''</span></span><br><span class=\"line\"><span class=\"string\">访问日历需要获取一年内的数据，按照一年365天计算，大概为52周多一点，所以前面有完整的52排，获取方式只要通过开始日期年份-1即可</span></span><br><span class=\"line\"><span class=\"string\">然后就是第53排的处理，python中的date.weekday()获取的星期几是0对应周一，所以通过(date.weekday()+1)%7即可转换到0对应周日</span></span><br><span class=\"line\"><span class=\"string\">于是在52周的基础上，减去星期数，就可以得到新的start_date</span></span><br><span class=\"line\"><span class=\"string\">'''</span></span><br><span class=\"line\">date       = datetime.datetime(date.year-<span class=\"number\">1</span>, date.month, date.day)</span><br><span class=\"line\">date       = datetime.datetime.fromtimestamp(date.timestamp()-<span class=\"number\">3600</span>*<span class=\"number\">24</span>*((date.weekday()+<span class=\"number\">1</span>)%<span class=\"number\">7</span>))</span><br><span class=\"line\">start_date = <span class=\"built_in\">str</span>(date.year) + (<span class=\"built_in\">str</span>(date.month) <span class=\"keyword\">if</span> date.month &gt; <span class=\"number\">9</span> <span class=\"keyword\">else</span> (<span class=\"string\">'0'</span> + <span class=\"built_in\">str</span>(date.month))) + (<span class=\"built_in\">str</span>(date.day) <span class=\"keyword\">if</span> date.day &gt; <span class=\"number\">9</span> <span class=\"keyword\">else</span> (<span class=\"string\">'0'</span> + <span class=\"built_in\">str</span>(date.day)))</span><br><span class=\"line\">downFile(dataUrl + <span class=\"string\">'&amp;method=overview/getTimeTrendRpt'</span> + <span class=\"string\">'&amp;metrics='</span> + metrics + <span class=\"string\">'&amp;start_date='</span> + start_date + <span class=\"string\">'&amp;end_date='</span> + end_date,</span><br><span class=\"line\">    <span class=\"string\">'calendar.json'</span>)</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"自动更新\">自动更新 <a class=\"header-anchor\" href=\"#自动更新\">¶</a></h3>\n<p>在 Linux 中可以通过 <code>crontab</code> 设置定时任务，以下为每整 6 小时的 0 点执行一次任务：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">0 0 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log</span><br><span class=\"line\">0 6 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log</span><br><span class=\"line\">0 12 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log</span><br><span class=\"line\">0 18 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log</span><br><span class=\"line\"><span class=\"comment\"># 或者</span></span><br><span class=\"line\">0 0,6,12,18 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log</span><br><span class=\"line\"><span class=\"comment\"># 或者</span></span><br><span class=\"line\">0 */6 * * * /usr/bin/python /home/API/data/get.py &gt;&gt; /home/API/data/get.log</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"数据展示\">数据展示 <a class=\"header-anchor\" href=\"#数据展示\">¶</a></h2>\n<h3 id=\"统计图容器\">统计图容器 <a class=\"header-anchor\" href=\"#统计图容器\">¶</a></h3>\n<p>在 html 代码中插入：</p>\n<figure class=\"highlight html\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">\"https://cdn.jsdelivr.net/npm/echarts@4.7.0/dist/echarts.min.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">\"https://cdn.jsdelivr.net/npm/echarts@4.7.0/map/js/china.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">style</span>=<span class=\"string\">\"max-width: 90%;margin: 0 auto;\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"calendar_container\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"data-container\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"map_container\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"data-container\"</span> <span class=\"attr\">style</span>=<span class=\"string\">\"height: 500px;\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"trends_container\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"data-container\"</span> <span class=\"attr\">style</span>=<span class=\"string\">\"height: 350px;\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"sources_container\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"data-container\"</span> <span class=\"attr\">style</span>=<span class=\"string\">\"height: 450px;\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 更新：两个js文件合一 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">\"https://foolishfox.cn/js/census.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"访问日历\">访问日历 <a class=\"header-anchor\" href=\"#访问日历\">¶</a></h3>\n<p>访问日历类似于 Github 贡献日历，有两种方法实现。</p>\n<ol>\n<li>源自于 <a href=\"https://zfe.space/post/hexo-githubcalendar.html\">hexo-githubcalendar 插件</a>，由 <a href=\"https://blog.eurkon.com/\">Eurkon</a> 修改，原文见<a href=\"#refer-3\">参考资料 3</a>。需要修改的地方有：</li>\n</ol>\n<figure class=\"highlight javascript\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"><span class=\"comment\">// 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模</span></span><br><span class=\"line\"><span class=\"title function_\">fetch</span>(<span class=\"string\">'https://api.foolishfox.cn/data/calendar.json?date'</span>+<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> data.<span class=\"title function_\">json</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> {</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"comment\">// 统计访问次数 PV 填写 'pv_count'，统计访客数 UV 填写 'visitor_count'，二选一</span></span><br><span class=\"line\"><span class=\"title function_\">visit_calendar</span>(<span class=\"string\">'pv_count'</span>, visit_color);</span><br><span class=\"line\">...</span><br></pre></td></tr></tbody></table></figure>\n<p>另外，需要更改容器 id 可以直接搜索替换即可。</p>\n<ol start=\"2\">\n<li>通过 <a href=\"https://foolishfox.cn/js/census.js\">census.js</a> 进行设置，包括后续的访问地图、访问趋势（访问次数）和访问来源都是基于此文件通过 Echarts 实现的。</li>\n</ol>\n<figure class=\"highlight javascript\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 统计访问次数 PV 填写 'pv_count'，统计访客数 UV 填写 'visitor_count'，二选一</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> metrics     = <span class=\"string\">'pv_count'</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> metricsName = (metrics === <span class=\"string\">'pv_count'</span> ? <span class=\"string\">'访问次数'</span> : (metrics === <span class=\"string\">'visitor_count'</span> ? <span class=\"string\">'访客数'</span> : <span class=\"string\">''</span>))</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">calChart</span> (<span class=\"params\"></span>) {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"script\"</span>)</span><br><span class=\"line\">    <span class=\"comment\">// 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模</span></span><br><span class=\"line\">    <span class=\"title function_\">fetch</span>(<span class=\"string\">'https://api.foolishfox.cn/data/calendar.json?date'</span>+<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> data.<span class=\"title function_\">json</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> {</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"comment\">// 颜色盒，用于设置不同数据的展示颜色，可更改</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> colorBox = [<span class=\"string\">'#EBEDF0'</span>, <span class=\"string\">'#FFE9BB'</span>, <span class=\"string\">'#FFD1A7'</span>, <span class=\"string\">'#FFBB95'</span>, <span class=\"string\">'#FFA383'</span>, <span class=\"string\">'#FF8D70'</span>, <span class=\"string\">'#FF745C'</span>, <span class=\"string\">'#FF5C4A'</span>, <span class=\"string\">'#FF4638'</span>, <span class=\"string\">'#FF2E26'</span>, <span class=\"string\">'#FF1812'</span>];</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"访问地图\">访问地图 <a class=\"header-anchor\" href=\"#访问地图\">¶</a></h3>\n<p>最简单的就是访问地图，直接修改 json 文件的请求 url 即可：</p>\n<figure class=\"highlight javascript\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 访问地图</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">mapChart</span> (<span class=\"params\"></span>) {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"script\"</span>)</span><br><span class=\"line\">    <span class=\"comment\">// 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模</span></span><br><span class=\"line\">    <span class=\"title function_\">fetch</span>(<span class=\"string\">'https://api.foolishfox.cn/data/map.json?date'</span>+<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> data.<span class=\"title function_\">json</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> {</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"访问趋势\">访问趋势 <a class=\"header-anchor\" href=\"#访问趋势\">¶</a></h3>\n<p>访问趋势中按照年份，将 12 个月的数据展开，需要从 json 中获取到年份和月份信息，由于时间日期格式是固定的，所以可以直接截取。本部分代码以下列展示的为准：</p>\n<figure class=\"highlight javascript\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取年份和月份</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">get_year</span>(<span class=\"params\">s</span>) {</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">parseInt</span>(s.<span class=\"title function_\">substr</span>(<span class=\"number\">0</span>, <span class=\"number\">4</span>))</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">get_month</span>(<span class=\"params\">s</span>) {</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">parseInt</span>(s.<span class=\"title function_\">substr</span>(<span class=\"number\">5</span>, <span class=\"number\">2</span>))</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"comment\">// 访问趋势</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">trendsChart</span> (<span class=\"params\"></span>) {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"script\"</span>)</span><br><span class=\"line\">    <span class=\"comment\">// 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模</span></span><br><span class=\"line\">    <span class=\"title function_\">fetch</span>(<span class=\"string\">'https://api.foolishfox.cn/data/trends.json?date'</span>+<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> data.<span class=\"title function_\">json</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> {</span><br><span class=\"line\">        <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">        <span class=\"keyword\">let</span> monthValueArr = {};</span><br><span class=\"line\">        <span class=\"keyword\">let</span> monthName = data.<span class=\"property\">result</span>.<span class=\"property\">items</span>[<span class=\"number\">0</span>];</span><br><span class=\"line\">        <span class=\"keyword\">let</span> monthValue = data.<span class=\"property\">result</span>.<span class=\"property\">items</span>[<span class=\"number\">1</span>];</span><br><span class=\"line\">        <span class=\"comment\">// 2020是起始年份，改为你自己的</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i =<span class=\"number\">2020</span>; i &lt;= date.<span class=\"title function_\">getFullYear</span>(); i++)   monthValueArr[<span class=\"title class_\">String</span>(i)] = [ ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  ];</span><br><span class=\"line\">        monthValueArr</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; monthName.<span class=\"property\">length</span>; i++) {</span><br><span class=\"line\">            <span class=\"keyword\">let</span> year = <span class=\"title function_\">get_year</span>(monthName[i][<span class=\"number\">0</span>]);</span><br><span class=\"line\">            <span class=\"keyword\">let</span> month = <span class=\"title function_\">get_month</span>(monthName[i][<span class=\"number\">0</span>]);</span><br><span class=\"line\">            monthValueArr[<span class=\"title class_\">String</span>(year)][<span class=\"title class_\">String</span>(month-<span class=\"number\">1</span>)] = monthValue[i][<span class=\"number\">0</span>];</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"comment\">// 以后每过一年，需要手动添加以下legend和series</span></span><br><span class=\"line\">        script.<span class=\"property\">innerHTML</span> = <span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">        var trendsChart = echarts.init(document.getElementById('trends_container'), 'light');</span></span><br><span class=\"line\"><span class=\"string\">        var trendsOption = {</span></span><br><span class=\"line\"><span class=\"string\">            title: { text: '访问趋势', x: 'center' },</span></span><br><span class=\"line\"><span class=\"string\">            tooltip: { trigger: 'axis' },</span></span><br><span class=\"line\"><span class=\"string\">            legend: { data: ['2020', '2021', '2022'], x: 'right' },</span></span><br><span class=\"line\"><span class=\"string\">            xAxis: {</span></span><br><span class=\"line\"><span class=\"string\">                name: '日期', type: 'category', boundaryGap: false,</span></span><br><span class=\"line\"><span class=\"string\">                data: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月']</span></span><br><span class=\"line\"><span class=\"string\">            },</span></span><br><span class=\"line\"><span class=\"string\">            yAxis: { name: '<span class=\"subst\">${metricsName}</span>', type: 'value' },</span></span><br><span class=\"line\"><span class=\"string\">            series: [</span></span><br><span class=\"line\"><span class=\"string\">                {</span></span><br><span class=\"line\"><span class=\"string\">                    name: '2020', type: 'line', smooth: true,</span></span><br><span class=\"line\"><span class=\"string\">                    data: [<span class=\"subst\">${monthValueArr[<span class=\"string\">\"2020\"</span>]}</span>],</span></span><br><span class=\"line\"><span class=\"string\">                    markLine: { data: [{type: 'average', name: '平均值'}] }</span></span><br><span class=\"line\"><span class=\"string\">                },</span></span><br><span class=\"line\"><span class=\"string\">                {</span></span><br><span class=\"line\"><span class=\"string\">                    name: '2021', type: 'line', smooth: true,</span></span><br><span class=\"line\"><span class=\"string\">                    data: [<span class=\"subst\">${monthValueArr[<span class=\"string\">\"2021\"</span>]}</span>],</span></span><br><span class=\"line\"><span class=\"string\">                    markLine: { data: [{type: 'average', name: '平均值'}] }</span></span><br><span class=\"line\"><span class=\"string\">                },</span></span><br><span class=\"line\"><span class=\"string\">                {</span></span><br><span class=\"line\"><span class=\"string\">                    name: '2022', type: 'line', smooth: true,</span></span><br><span class=\"line\"><span class=\"string\">                    data: [<span class=\"subst\">${monthValueArr[<span class=\"string\">\"2022\"</span>]}</span>],</span></span><br><span class=\"line\"><span class=\"string\">                    markLine: { data: [{type: 'average', name: '平均值'}] }</span></span><br><span class=\"line\"><span class=\"string\">                }</span></span><br><span class=\"line\"><span class=\"string\">            ]</span></span><br><span class=\"line\"><span class=\"string\">        };</span></span><br><span class=\"line\"><span class=\"string\">        trendsChart.setOption(trendsOption);</span></span><br><span class=\"line\"><span class=\"string\">        window.addEventListener(\"resize\", () =&gt; { </span></span><br><span class=\"line\"><span class=\"string\">            trendsChart.resize();</span></span><br><span class=\"line\"><span class=\"string\">        });`</span></span><br><span class=\"line\">        <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">'trends_container'</span>).<span class=\"title function_\">after</span>(script);</span><br><span class=\"line\">    }).<span class=\"title function_\">catch</span>(<span class=\"keyword\">function</span> (<span class=\"params\">error</span>) {</span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    });</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"访问来源\">访问来源 <a class=\"header-anchor\" href=\"#访问来源\">¶</a></h3>\n<p>留在最后的是最复杂的访问来源，实际上百度的全部来源 (<code>source/all/a</code>) API 可以将来源分为：直达、外部链接和搜索引擎三个部分，直接使用并不困难。但是百度统计会将必应（<code>cn.bing.com</code> 和 <code>www.bing.com</code>）的来源归类到外部链接而不是搜索引擎，而且我自己还想统计来自于 Github、十年之约等网站的流量，所以需要获取多个数据文件。</p>\n<figure class=\"highlight javascript\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"><span class=\"comment\">// 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模</span></span><br><span class=\"line\"><span class=\"title function_\">fetch</span>(<span class=\"string\">'https://api.foolishfox.cn/data/sources.json?date'</span>+<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> data.<span class=\"title function_\">json</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> sourcesName = data.<span class=\"property\">result</span>.<span class=\"property\">items</span>[<span class=\"number\">0</span>];</span><br><span class=\"line\">    <span class=\"keyword\">let</span> sourcesValue = data.<span class=\"property\">result</span>.<span class=\"property\">items</span>[<span class=\"number\">1</span>];</span><br><span class=\"line\">    <span class=\"keyword\">let</span> sourcesArr = [];</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; sourcesName.<span class=\"property\">length</span>; i++)</span><br><span class=\"line\">        sourcesArr.<span class=\"title function_\">push</span>({ <span class=\"attr\">name</span>: sourcesName[i][<span class=\"number\">0</span>].<span class=\"property\">name</span>, <span class=\"attr\">value</span>: sourcesValue[i][<span class=\"number\">0</span>] });</span><br><span class=\"line\">    <span class=\"comment\">// 记录总体数据，方便后续调用（使用var定义在fetch外面）</span></span><br><span class=\"line\">    link = sourcesArr[<span class=\"number\">1</span>][<span class=\"string\">'value'</span>] ;</span><br><span class=\"line\">    search = sourcesArr[<span class=\"number\">2</span>][<span class=\"string\">'value'</span>];</span><br><span class=\"line\">    direct = sourcesArr[<span class=\"number\">0</span>][<span class=\"string\">'value'</span>];</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"comment\">// 下面的链接是本站点的访问数据，需要修改为自己的，为了防止浏览器缓存的干扰，在url后添加了时间戳，可以进一步优化为时间的小时数对6取模</span></span><br><span class=\"line\"><span class=\"title function_\">fetch</span>(<span class=\"string\">'https://api.foolishfox.cn/data/link.json?date'</span>+<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> data.<span class=\"title function_\">json</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> linksName = data.<span class=\"property\">result</span>.<span class=\"property\">items</span>[<span class=\"number\">0</span>];</span><br><span class=\"line\">    <span class=\"keyword\">let</span> linksValue = data.<span class=\"property\">result</span>.<span class=\"property\">items</span>[<span class=\"number\">1</span>];</span><br><span class=\"line\">    <span class=\"keyword\">let</span> linksArr = {};</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; linksName.<span class=\"property\">length</span>; i++)</span><br><span class=\"line\">        linksArr[linksName[i][<span class=\"number\">0</span>].<span class=\"property\">name</span>] = linksValue[i][<span class=\"number\">0</span>];</span><br><span class=\"line\">    <span class=\"comment\">// 除必应外，其他的都是自己想要统计的网站，都是http链接</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> sum = data.<span class=\"property\">result</span>.<span class=\"property\">sum</span>[<span class=\"number\">0</span>][<span class=\"number\">0</span>];</span><br><span class=\"line\">    <span class=\"keyword\">let</span> bing = linksArr[<span class=\"string\">'http://cn.bing.com'</span>]+linksArr[<span class=\"string\">'http://www.bing.com'</span>];</span><br><span class=\"line\">    <span class=\"keyword\">let</span> github = linksArr[<span class=\"string\">'http://github.com'</span>];</span><br><span class=\"line\">    <span class=\"keyword\">let</span> travel = linksArr[<span class=\"string\">'http://travellings.now.sh'</span>]+linksArr[<span class=\"string\">'http://travellings.vercel.app'</span>]+linksArr[<span class=\"string\">'http://www.foreverblog.cn'</span>];</span><br><span class=\"line\">    innerHTML += <span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">                    {value: <span class=\"subst\">${bing}</span>, name: '必应'},</span></span><br><span class=\"line\"><span class=\"string\">                    {value: <span class=\"subst\">${direct}</span>, name: '直达'},</span></span><br><span class=\"line\"><span class=\"string\">                    {value: <span class=\"subst\">${github}</span>, name: 'Github'},</span></span><br><span class=\"line\"><span class=\"string\">                    {value: <span class=\"subst\">${travel}</span>, name: '开往/十年之约'},`</span>+</span><br><span class=\"line\">                    <span class=\"comment\">// 将来自于必应的访问减去</span></span><br><span class=\"line\">                    <span class=\"string\">`{value: <span class=\"subst\">${sum-bing-github-travel}</span>, name: '其他'}</span></span><br><span class=\"line\"><span class=\"string\">                ]</span></span><br><span class=\"line\"><span class=\"string\">            },</span></span><br><span class=\"line\"><span class=\"string\">            {</span></span><br><span class=\"line\"><span class=\"string\">                name: '访问来源', type: 'pie', selectedMode: 'single', radius: [0, '30%'],</span></span><br><span class=\"line\"><span class=\"string\">                label: { position: 'inner', fontSize: 14},</span></span><br><span class=\"line\"><span class=\"string\">                labelLine: { show: false },</span></span><br><span class=\"line\"><span class=\"string\">                data: [`</span>+</span><br><span class=\"line\">                    <span class=\"comment\">// 将来自于必应的访问从外链中减去，加入搜索中</span></span><br><span class=\"line\">                    <span class=\"string\">`{value: <span class=\"subst\">${search+bing}</span>, name: '搜索', itemStyle: { color : 'green' }},</span></span><br><span class=\"line\"><span class=\"string\">                    {value: <span class=\"subst\">${direct}</span>, name: '直达', itemStyle: { color : '#FFDB5C' }},</span></span><br><span class=\"line\"><span class=\"string\">                    {value: <span class=\"subst\">${link-bing}</span>, name: '外链', itemStyle: { color : '#32C5E9' }}</span></span><br><span class=\"line\"><span class=\"string\">                ]</span></span><br><span class=\"line\"><span class=\"string\">            },</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">    };</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"Q-A\">Q&amp;A<a class=\"header-anchor\" href=\"#Q-A\">¶</a></h2>\n<ol>\n<li> 不想使用 python 下载文件保存，想要实时统计</li>\n</ol>\n<p><s>根据<a href=\"#refer-2\">参考资料 2</a> 中 4.3 节 —— 自建 Vercel API（可选）进行设置，替换上述文件中的 url 即可</s>（感谢秋水）</p>\n<p>根据<a href=\"#refer-2\">参考资料 2</a> 中 5.3 节进行设置，替换上述 <code>js</code> 文件中的 <code>url</code> 即可，具体形式可参考<a href=\"#refer-2\">参考资料 2</a> 中 4.2 节。</p>\n<ol start=\"2\">\n<li>依然出现跨域问题？</li>\n</ol>\n<p>请务必保证通过 2.2 节获取的文件保存在博客的网站目录下，并通过 url 可以访问；如果想要向我一样通过其他域名（例如 <code>api.foolishfox.cn/data/*.json</code>）访问，需要对服务器进行设置，以 Nginx 为例：</p>\n<figure class=\"highlight nginx\"><figcaption><span>configuration</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#data CROS</span></span><br><span class=\"line\"><span class=\"section\">location</span> <span class=\"regexp\">~ ^/data/</span> {</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$http_origin</span> <span class=\"regexp\">~* (http://localhost:4000|https://foolishfox.cn))</span> {</span><br><span class=\"line\">        <span class=\"attribute\">add_header</span> <span class=\"string\">'Access-Control-Allow-Origin'</span> <span class=\"string\">\"<span class=\"variable\">$http_origin</span>\"</span>;</span><br><span class=\"line\">        <span class=\"attribute\">add_header</span> <span class=\"string\">'Access-Control-Allow-Credentials'</span> <span class=\"string\">'true'</span>;</span><br><span class=\"line\">        <span class=\"attribute\">add_header</span> <span class=\"string\">'Access-Control-Allow-Methods'</span> <span class=\"string\">'GET, POST, OPTIONS'</span>;</span><br><span class=\"line\">        <span class=\"attribute\">add_header</span> <span class=\"string\">'Access-Control-Allow-Headers'</span> <span class=\"string\">'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type'</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>地图显示错误</li>\n</ol>\n<p>务必注意，Echarts 目前已经不提供地图 js/json 文件的下载，所以要通过 npm 获取到旧版本中的 <code>China.js</code> 文件，因此 Echarts 的版本最好也保持一致</p>\n<ol start=\"4\">\n<li>Echarts 绘制的访问日历无法自动适应窗口大小</li>\n</ol>\n<p>正在积极解决中…</p>\n<h2 id=\"更新\">更新 <a class=\"header-anchor\" href=\"#更新\">¶</a></h2>\n<ol>\n<li>2021.6.1：访问趋势中第 23 行代码应改为：</li>\n</ol>\n<figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">monthValueArr[<span class=\"title class_\">String</span>(year)][<span class=\"title class_\">String</span>(month-<span class=\"number\">1</span>)] = monthValue[i][<span class=\"number\">0</span>] === <span class=\"string\">'--'</span> ? <span class=\"number\">0</span> : monthValue[i][<span class=\"number\">0</span>];</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>自动更新 <code>token</code><br>\n百度统计的 <code>token</code> 需要每个月更新一次，手动更新很麻烦，所以可以在代码中添加这一功能。首先更改 <code>downFile</code> 函数：</li>\n</ol>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">downFile</span>(<span class=\"params\">url, fileName, prefix=<span class=\"string\">'./'</span></span>):</span><br><span class=\"line\">    res = requests.get(url)</span><br><span class=\"line\">    res = json.loads(res.content)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"string\">'error_code'</span> <span class=\"keyword\">in</span> res.keys()):</span><br><span class=\"line\">        update(prefix=prefix)</span><br><span class=\"line\">        downFile(url, fileName, prefix)</span><br><span class=\"line\">    <span class=\"keyword\">with</span> <span class=\"built_in\">open</span>(prefix+fileName, <span class=\"string\">'w'</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        json.dump(res, f)</span><br></pre></td></tr></tbody></table></figure>\n<p>当发现 <code>token</code> 错误时，我们执行 <code>update</code> 函数：</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">update</span>(<span class=\"params\">prefix, url=updateUrl</span>):</span><br><span class=\"line\">    res = requests.get(url)</span><br><span class=\"line\">    res = json.loads(res.content)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(res)</span><br><span class=\"line\"></span><br><span class=\"line\">    config[<span class=\"string\">'access'</span>]  = res[<span class=\"string\">'access_token'</span>]</span><br><span class=\"line\">    config[<span class=\"string\">'refresh'</span>] = res[<span class=\"string\">'refresh_token'</span>]</span><br><span class=\"line\">    <span class=\"keyword\">with</span> <span class=\"built_in\">open</span>(prefix + <span class=\"string\">'token.json'</span>, <span class=\"string\">'w'</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        json.dump(config, f)</span><br></pre></td></tr></tbody></table></figure>\n<p><code>config</code> 是通过 <code>json</code> 加载了目录下的 <code>token.json</code> 文件，格式如下所示，注意添加访问权限（例如 <code>Nginx</code> 中添加该路径返回 <code>403</code>）。</p>\n<figure class=\"highlight json\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// config = json.load(open('./token.json'))</span></span><br><span class=\"line\"><span class=\"punctuation\">{</span></span><br><span class=\"line\">    <span class=\"attr\">\"access\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"access token\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"refresh\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"refresh token\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"site_id\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"site id\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"api_key\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"api key\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"serect_key\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"serect key\"</span></span><br><span class=\"line\"><span class=\"punctuation\">}</span></span><br></pre></td></tr></tbody></table></figure>\n<p><code>updateUrl</code> 是自动更新的 <code>url</code>：</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">updateUrl  = <span class=\"string\">'http://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&amp;refresh_token='</span> + config[<span class=\"string\">'refresh'</span>] + <span class=\"string\">'&amp;client_id='</span> + config[<span class=\"string\">'api_key'</span>] + <span class=\"string\">'&amp;client_secret='</span> + config[<span class=\"string\">'serect_key'</span>]</span><br></pre></td></tr></tbody></table></figure>\n<p>完整的 <code>py</code> 文件可以点击<a href=\"https://api.foolishfox.cn/data/get.py\">下载</a>。</p>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><span id=\"refer-1\"><a href=\"https://blog.eurkon.com/post/ef1da941.html\">Hexo 博客访问统计图</a></span></li>\n<li><span id=\"refer-2\"><a href=\"https://blog.eurkon.com/post/61763977.html\">Hexo 博客实时访问统计图</a></span></li>\n<li><span id=\"refer-3\"><a href=\"https://blog.eurkon.com/post/1a169b5a.html\">Hexo 博客访问日历图</a></span></li>\n<li><span id=\"refer-4\"><a href=\"https://tongji.baidu.com/api/manual/\">百度统计用户手册</a></span></li>\n<li><span id=\"refer-5\"><a href=\"https://echarts.apache.org/examples/zh/index.html\">Echarts 文档</a></span></li>\n</ol>\n","categories":["软件/程序","博客成长日志"],"tags":["Hexo","站点统计","Echarts"]},{"title":"折腾日志 | Yourls—— 短链接生成器与短域名获取","url":"/posts/202105-yourls.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>你是否遇到过这样的场景？你有一个链接，例如 <code>https://detail.tmall.com/item.htm?spm=a230r.1.14.1.16b64046kb50gr&amp;id=563033197139&amp;ns=1&amp;abbucket=5</code>，需要分享给朋友，这个链接长而且不好记忆，需要经常用到的时候也不方便，假设你需要发微博，由于字数限制，链接长度越短越好，这时候如果有一个链接 <code>https://short.cn/tmall</code> 经过重定向可以指向前文的网址，那边就会很美观且方便，而这就需要用到短链接生成技术。</p>\n<span id=\"more\"></span>\n<p>其实短链接的作用主要在于数据统计、控制访问、便于管理。另外相同的页面，短链接与原链接生成的二维码的复杂度也大大不同。目前市面上主要的短链接服务可以参考：<a href=\"https://sina.lt/why.php\">短网址服务，我们该怎么选？</a>，其中安照优先级介绍了部分优质的服务提供商。</p>\n<p>除了使用服务商提供的短链接生成服务外，我们其实还可以自己搭建一个这样的服务。原理很简单，通过某种算法将长链接 <code>A</code> 转化为一个短字符串 <code>B</code>，浏览器结合域名 <code>C</code> 访问 <code>C/B</code>，服务器响应跳转至 <code>A</code>，并在过程中完成数据的统计。目前有很多开源的短链接服务，其中之一就是今天的主角 <code>Yourls</code>。<br>\n<img src=\"https://asset.foolishfox.cn/2021/05/1621008545.png\" alt=\"\"></p>\n<h2 id=\"Yourls\">Yourls<a class=\"header-anchor\" href=\"#Yourls\">¶</a></h2>\n<blockquote>\n<p>YOURLS stands for Your Own URL Shortener. It is a small set of PHP scripts that will allow you to run your own URL shortening service (a la TinyURL or Bitly).<br>\nRunning your own URL shortener is fun, geeky and useful: you own your data and do not depend on third-party services. It is also a great way to add branding to your short URLs, instead of using the same public URL shortener everyone uses.</p>\n</blockquote>\n<p><code>Yourls</code> 的特性是开源免费，可以管理、统计每一个短链接的数量，提供 API 接口，而且具有众多插件，便于进行二次开发，下面就一起搭建一个自己的软链接服务。</p>\n<h3 id=\"准备\">准备 <a class=\"header-anchor\" href=\"#准备\">¶</a></h3>\n<p><code>Yourls</code> 是基于 PHP 和 MySQL 开发的，所以需要提前准备好：</p>\n<ul>\n<li>Apache（2.4 版本及以上）或 Nginx 服务器</li>\n<li> PHP（7.4 版本及以上）</li>\n<li>MySQL（5.0 版本及以上）</li>\n</ul>\n<p>另外如果需要使用 API 接口，还需要安装 PHP <a href=\"https://www.php.net/curl\">cURL</a> 拓展。</p>\n<h3 id=\"安装\">安装 <a class=\"header-anchor\" href=\"#安装\">¶</a></h3>\n<h4 id=\"下载\">下载 <a class=\"header-anchor\" href=\"#下载\">¶</a></h4>\n<p>从 <a href=\"https://github.com/YOURLS/YOURLS/releases\">Releases</a> 下载最新版本的安装包，目前使用的是 1.8.1 版本，并解压至工作目录</p>\n<h4 id=\"配置文件\">配置文件 <a class=\"header-anchor\" href=\"#配置文件\">¶</a></h4>\n<p>将 <code>user</code> 目录下的 <code>config-sample.php</code> 复制备份命名为 <code>config.php</code>，修改配置如下，更多设置请参考 <a href=\"https://yourls.org/#Config\">Config</a></p>\n<figure class=\"highlight php\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 数据库配置</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_DB_USER'</span>, <span class=\"string\">'yourls'</span> );   <span class=\"comment\">//用户名</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_DB_PASS'</span>, <span class=\"string\">'xxxxxxxx'</span> );   <span class=\"comment\">//密码</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_DB_NAME'</span>, <span class=\"string\">'yourls'</span> );   <span class=\"comment\">//数据库名</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_DB_HOST'</span>, <span class=\"string\">'localhost'</span> );   <span class=\"comment\">//地址</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_DB_PREFIX'</span>, <span class=\"string\">'yourls_'</span> );   <span class=\"comment\">//表前缀</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 站点设置</span></span><br><span class=\"line\"><span class=\"comment\">#设置站点</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_SITE'</span>, <span class=\"string\">'http://ozh.in'</span> );   <span class=\"comment\">//域名</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_LANG'</span>, <span class=\"string\">''</span> );   <span class=\"comment\">//语言</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_UNIQUE_URLS'</span>, <span class=\"literal\">true</span> );   <span class=\"comment\">//是否允许长链接对应多个短链接</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_HOURS_OFFSET'</span>, <span class=\"string\">'-5'</span> );   <span class=\"comment\">//时区偏移</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_PRIVATE'</span>, <span class=\"string\">'true'</span> );   <span class=\"comment\">//是否私有，如果私有的，则api接口需要传递用户名和密码，如果公开，则可以自由访问后台</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_COOKIEKEY'</span>, <span class=\"string\">'modify this text with something random'</span> );   <span class=\"comment\">//设置cookie，可访问http://yourls.org/cookie生成</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 用户设置</span></span><br><span class=\"line\"><span class=\"variable\">$yourls_user_passwords</span> = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"string\">'username'</span> =&gt; <span class=\"string\">'password'</span>,   <span class=\"comment\">//用户名=&gt;密码，可填多个，登录成功后这里的明文密码会被加密</span></span><br><span class=\"line\">    );</span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_DEBUG'</span>, <span class=\"literal\">false</span> );   <span class=\"comment\">//是否开启调试</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">define</span>( <span class=\"string\">'YOURLS_URL_CONVERT'</span>, <span class=\"number\">62</span> );   <span class=\"comment\">//短链接字符串使用36进制或2进制，建议62进制</span></span><br><span class=\"line\"><span class=\"variable\">$yourls_reserved_URL</span> = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"string\">'porn'</span>, <span class=\"string\">'faggot'</span>, <span class=\"string\">'sex'</span>, <span class=\"string\">'nigger'</span>, <span class=\"string\">'fuck'</span>, <span class=\"string\">'cunt'</span>, <span class=\"string\">'dick'</span>,   <span class=\"comment\">//黑名单</span></span><br><span class=\"line\">);</span><br></pre></td></tr></tbody></table></figure>\n<h4 id=\"服务器设置\">服务器设置 <a class=\"header-anchor\" href=\"#服务器设置\">¶</a></h4>\n<ol>\n<li>Apache<br>\n需要开启 <code>mod_rewrite</code> 模块，编辑<a href=\"https://github.com/YOURLS/YOURLS/wiki/.htaccess\">.htaccess</a> 文件：</li>\n</ol>\n<figure class=\"highlight apache\"><figcaption><span>configuration</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 根目录http://yoursite/</span></span><br><span class=\"line\"><span class=\"comment\"># BEGIN YOURLS</span></span><br><span class=\"line\"><span class=\"section\">&lt;IfModule mod_rewrite.c&gt;</span></span><br><span class=\"line\"><span class=\"attribute\">RewriteEngine</span> <span class=\"literal\">On</span></span><br><span class=\"line\"><span class=\"attribute\">RewriteBase</span> /</span><br><span class=\"line\"><span class=\"attribute\">RewriteCond</span> <span class=\"variable\">%{REQUEST_FILENAME}</span> !-f</span><br><span class=\"line\"><span class=\"attribute\">RewriteCond</span> <span class=\"variable\">%{REQUEST_FILENAME}</span> !-d</span><br><span class=\"line\"><span class=\"attribute\">RewriteRule</span> ^.*$ /yourls-loader.php<span class=\"meta\"> [L]</span></span><br><span class=\"line\"><span class=\"section\">&lt;/IfModule&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># END YOURLS</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 二级目录http://yoursite/somedir/</span></span><br><span class=\"line\"><span class=\"comment\"># BEGIN YOURLS</span></span><br><span class=\"line\"><span class=\"section\">&lt;IfModule mod_rewrite.c&gt;</span></span><br><span class=\"line\"><span class=\"attribute\">RewriteEngine</span> <span class=\"literal\">On</span></span><br><span class=\"line\"><span class=\"attribute\">RewriteBase</span> /somedir/</span><br><span class=\"line\"><span class=\"attribute\">RewriteCond</span> <span class=\"variable\">%{REQUEST_FILENAME}</span> !-f</span><br><span class=\"line\"><span class=\"attribute\">RewriteCond</span> <span class=\"variable\">%{REQUEST_FILENAME}</span> !-d</span><br><span class=\"line\"><span class=\"attribute\">RewriteRule</span> ^.*$ /somedir/yourls-loader.php<span class=\"meta\"> [L]</span></span><br><span class=\"line\"><span class=\"section\">&lt;/IfModule&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># END YOURLS</span></span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>Nginx<br>\n请注意宝塔用户安照<a href=\"https://github.com/YOURLS/YOURLS/wiki/Nginx-configuration\">文档</a>中的操作可能无效，可以更改为：</li>\n</ol>\n<figure class=\"highlight nginx\"><figcaption><span>configuration</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> {</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># HTTP over IPv4 &amp; IPv6</span></span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span> [::]:<span class=\"number\">80</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># HTTPS over IPv4 &amp; IPv6</span></span><br><span class=\"line\">  <span class=\"comment\"># MUST BE EDITED TO REFLECT YOUR CONFIGURATION</span></span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span> [::]:<span class=\"number\">443</span> ssl;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate</span>     example.com.crt;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate_key</span> example.com.key;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Server names</span></span><br><span class=\"line\">  <span class=\"comment\"># MUST BE EDITED TO REFLECT YOUR CONFIGURATION</span></span><br><span class=\"line\">  <span class=\"attribute\">server_name</span> example.com www.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Root directory</span></span><br><span class=\"line\">  <span class=\"comment\"># MUST BE EDITED TO REFLECT YOUR CONFIGURATION</span></span><br><span class=\"line\">  <span class=\"attribute\">root</span> /path/to/yourls/files;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 更改部分在这里！！！</span></span><br><span class=\"line\">  <span class=\"comment\"># 更改部分在这里！！！</span></span><br><span class=\"line\">  <span class=\"comment\"># 更改部分在这里！！！</span></span><br><span class=\"line\">  <span class=\"section\">location</span> /  </span><br><span class=\"line\">  {  </span><br><span class=\"line\">    <span class=\"attribute\">if</span> (!-f <span class=\"variable\">$request_filename</span>){</span><br><span class=\"line\">      <span class=\"attribute\">set</span> <span class=\"variable\">$rule_0</span> <span class=\"number\">1</span><span class=\"variable\">$rule_0</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (!-d <span class=\"variable\">$request_filename</span>){</span><br><span class=\"line\">      <span class=\"attribute\">set</span> <span class=\"variable\">$rule_0</span> <span class=\"number\">2</span><span class=\"variable\">$rule_0</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$rule_0</span> = <span class=\"string\">\"21\"</span>){</span><br><span class=\"line\">      <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/.*$</span> /yourls-loader.php <span class=\"literal\">last</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># PHP engine</span></span><br><span class=\"line\">  <span class=\"section\">location</span> <span class=\"regexp\">~ \\.php$</span> {</span><br><span class=\"line\">    <span class=\"attribute\">include</span> fastcgi.conf;</span><br><span class=\"line\">    <span class=\"comment\"># OR</span></span><br><span class=\"line\">    <span class=\"comment\"># include fastcgi_params;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_index</span> index.php;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># MUST BE EDITED TO REFLECT YOUR CONFIGURATION</span></span><br><span class=\"line\">    <span class=\"attribute\">fastcgi_pass</span> unix:/var/run/php/php7.2-fpm.sock;</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<h4 id=\"安装-v2\">安装 <a class=\"header-anchor\" href=\"#安装-v2\">¶</a></h4>\n<p>访问 <code>http://domain.com/admin</code> 完成初安装，输入配置文件设置的账号、密码登陆后台。如果安装出错，可能是 PHP 或者 MySQL 版本不符合要求，或者是数据库初始化失败，可以按照<a href=\"#refer-3\">参考资料 3</a> 进行解决。</p>\n<h2 id=\"短域名\">短域名 <a class=\"header-anchor\" href=\"#短域名\">¶</a></h2>\n<p>短链接最重要的还是根域名要短，但是以<code>.com</code>、<code>.cn</code>、<code>.org</code>、<code>.top</code>、<code>.xyz</code> 等常见一级域名的短域名基本已经抢注完成，剩下的价格也很昂贵。为了减小这个问题带来的影响，有两种解决方案。</p>\n<h3 id=\"付费域名\">付费域名 <a class=\"header-anchor\" href=\"#付费域名\">¶</a></h3>\n<p>在我国的<code>.cn</code> 域名下有一类特殊的二级域名：按照国家各个省级行政区划分的行政区划域名，例如 <code>bj.cn</code> 代表北京，<code>sh.cn</code> 代表上海等。这些域名注册比较少，一些比较短的域名（例如 <code>fox.hn.cn</code>，湖南）很有可能没有被注册，而且价格很便宜。目前<a href=\"https://www.west.cn/\">西部数码</a>、<a href=\"https://www.diymysite.com/\">域趣网络</a>等都提供这一类域名的注册。</p>\n<h3 id=\"免费域名\">免费域名 <a class=\"header-anchor\" href=\"#免费域名\">¶</a></h3>\n<div class=\"note danger flat\"><p>由于特殊原因，Freenom 目前已经停止注册新的免费域名。</p>\n</div>\n<p><s><a href=\"https://www.freenom.com/\">Freenom</a> 是国际著名的免费域名提供商，可以提供<code>.tk</code>（托克劳）、<code>.ml</code>（马里）、<code>.ga</code>（加蓬）、<code>.cf</code>（中非共和国）、<code>.gq</code>（赤道几内亚）等国家一级域名，除特殊域名（少于 4 个字母，特殊含义等）外均可免费获取。</s></p>\n<!-- ![](https://asset.foolishfox.cn/2021/05/20210515005206.png) -->\n<p><s>在 Freenom 获取免费域名有几个需要注意的地方：</s><br>\n<s>1. 需要科学上网</s><br>\n<s>2. 注册账号时，填写的地址信息一定要与科学上网后的 IP 地址保持一致，最好在美国！最好在美国！最好在美国！</s><br>\n<s>3. 点击上图的<code>现在获取</code>会显示不可用，此时你只需要在搜索框中输入 <code>ffox.ga</code> 就可以解决，自动帮你添加购物车</s></p>\n<!-- ![](https://asset.foolishfox.cn/2021/05/1621011489-1-.png) -->\n<h2 id=\"拓展与配置\">拓展与配置 <a class=\"header-anchor\" href=\"#拓展与配置\">¶</a></h2>\n<p><code>Yourls</code> 具有丰富的插件和主题，还有各种语言的翻译包，所有的插件都能在 <a href=\"https://github.com/YOURLS/awesome-yourls\">awesome-yourls</a> 找到介绍与项目地址。下面介绍一些我使用的拓展。</p>\n<h3 id=\"插件\">插件 <a class=\"header-anchor\" href=\"#插件\">¶</a></h3>\n<ol>\n<li>Allow Hyphens in Short URLs</li>\n</ol>\n<p>自带的插件，允许短链接中出现连字符。</p>\n<ol start=\"2\">\n<li>Random ShortURLs</li>\n</ol>\n<p>默认情况下，短链接按照顺序生成，从 1 开始，但是更好的方式是使用时间戳或随机字符串，这一个插件就可以随机生成短链接字符串，还可以设置字符串的长度。</p>\n<ol start=\"3\">\n<li>Cache stat pages</li>\n</ol>\n<p>后台查看统计报表的数据都是实时统计的，此插件可以将缓存统计报表，加快访问速度。</p>\n<ol start=\"4\">\n<li>YOURLS Static Titles</li>\n</ol>\n<p>当你输入一个长链接生成短链时，YOURLS 会抓取长链接对应页面的标题信息，所以创建短链接的速度会受到页面访问速度的影响，此插件可以经过设置跳过抓取标题，加快生成速度。除了这一种方案以外，还可以根据<a href=\"#refer-4\">参考资料 4</a> 进行配置。</p>\n<h3 id=\"翻译\">翻译 <a class=\"header-anchor\" href=\"#翻译\">¶</a></h3>\n<p>下载<a href=\"https://github.com/ZvonimirSun/YOURLS-zh_CN\">汉化包</a>中的 <code>zh_CN.mo</code> 文件，移动至 <code>/user/languages</code> 文件夹下，设置配置文件中的语言为 <code>zh_CN</code> 即可。</p>\n<h3 id=\"主题\">主题 <a class=\"header-anchor\" href=\"#主题\">¶</a></h3>\n<p>目前官方页面的<a href=\"https://github.com/YOURLS/awesome-yourls#themes-\">主题</a>只有 3 个，大家可以搜寻比较好看的。我使用的主题是 <a href=\"https://github.com/Flynntes/Sleeky\">Sleeky</a>，不仅很好看而且还会添加前端首页。</p>\n<ol>\n<li>下载文件</li>\n<li>移动 <code>sleeky-frontend</code> 文件夹到网站根目录下</li>\n<li>配置 <code>frontend/config.php</code></li>\n<li>移动 <code>sleeky-backend</code> 文件夹至 <code>user/plugins/</code> 目录</li>\n<li>在后台管理中 <code>example.com/admin/plugins.php</code> 启用插件<br>\n<img src=\"https://asset.foolishfox.cn/2021/05/1621046193-1-.png\" alt=\"\"></li>\n</ol>\n<h2 id=\"其他\">其他 <a class=\"header-anchor\" href=\"#其他\">¶</a></h2>\n<p>查看统计数据，可以在后台的管理界面中数据统计查看，也可以在短链接后面添加 <code>+</code> 查看，例如 <code>https://short.cn/tmall+</code>，包括访问量、地区和来源等。<br>\n<img src=\"https://asset.foolishfox.cn/2021/05/1621046295-1-.jpg\" alt=\"\"></p>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><span id=\"refer-1\"><a href=\"https://yourls.org/\">YOURLS: Your Own URL Shortener</a></span></li>\n<li><span id=\"refer-2\"><a href=\"https://github.com/YOURLS/YOURLS/wiki\">YOURLS Wiki</a></span></li>\n<li><span id=\"refer-3\"><a href=\"https://www.cnblogs.com/myIvan/p/10582849.html\">用 yourls 搭建短链接地址服务</a></span></li>\n<li><span id=\"refer-4\"><a href=\"https://blog.csdn.net/hfut_wowo/article/details/108734217\">关于 yourls 生成短链耗时太长问题解决</a></span></li>\n<li><span id=\"refer-5\"><a href=\"https://hongcyu.cn/posts/hexo-bilibili.html\">HEXO 博客引用 B 站视频并自动适配</a></span></li>\n</ol>\n","categories":["软件/程序"],"tags":["教程","Yourls","短域名"]},{"title":"服务器安装 Jupyter Lab（Python 与 R 环境）","url":"/posts/202112-pyr_jupyter.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>这学期学的《概率论与数理统计》课有作业需要用到 R，加上双十一从腾讯云搞了一台 2H4G8M 的机器，性能大大提升，因此打算打造一个云服务来运行 Python，同时兼顾 R。</p>\n<p>在安装的过程中碰到了超级多的问题，所以下面介绍一下安装的流程，记录一些很久才解决的问题。</p>\n<span id=\"more\"></span>\n<div class=\"note info flat\"><p><strong>系统信息</strong><br>\nOS: Ubuntu 20.04<br>\nPython: 3.8.10</p>\n</div>\n<h2 id=\"方案\">方案 <a class=\"header-anchor\" href=\"#方案\">¶</a></h2>\n<p>目前常用的方式是 <code>Anaconda</code>+<code>R</code>(使用 <code>apt</code> 安装)，而 <code>Anaconda</code> 会安装很多不必要的包，而在服务器（无图形界面）使用 <code>apt</code> 安装的 <code>R</code> 中的画图功能需要安装 <code>X11</code> 的相关环境，还不一定能搞定，所以最终采用的方案如下：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">./</span><br><span class=\"line\">├─pycal              Python虚拟环境</span><br><span class=\"line\">├─rsource            R安装包的源代码</span><br><span class=\"line\">├─rcal               自定义安装的R</span><br><span class=\"line\">├─project            项目文件夹</span><br><span class=\"line\">│  ├─R               R项目</span><br><span class=\"line\">│  └─Python          Python项目</span><br><span class=\"line\">└─requirements.txt   Python需要的包</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"安装\">安装 <a class=\"header-anchor\" href=\"#安装\">¶</a></h2>\n<h3 id=\"Python相关环境\">Python 相关环境 <a class=\"header-anchor\" href=\"#Python相关环境\">¶</a></h3>\n<h4 id=\"安装虚拟环境\">安装虚拟环境 <a class=\"header-anchor\" href=\"#安装虚拟环境\">¶</a></h4>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">python -m venv pycal</span><br><span class=\"line\"><span class=\"built_in\">source</span> pycal/bin/activate</span><br><span class=\"line\">pip install -r requirements.txt</span><br></pre></td></tr></tbody></table></figure>\n<h4 id=\"Jupyter初步配置\">Jupyter 初步配置 <a class=\"header-anchor\" href=\"#Jupyter初步配置\">¶</a></h4>\n<ol>\n<li> 生成配置文件 </li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">jupyter lab --generate-config</span><br></pre></td></tr></tbody></table></figure>\n<p>如果是 <code>root</code> 用户，可以在后面添加 <code>--allow-root</code>，完成后会返回配置文件位置。</p>\n<div class=\"note danger flat\"><p><code>ValueError: Can not patch loop of type &lt;class 'NoneType'&gt;</code><br>\n这是由于 <code>nest_asyncio</code> 的 bug 导致的，将其版本回退为 <code>1.5.1</code> 即可解决。<sup><a href=\"#fn3\">[3]</a></sup></p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">pip uninstall nest_asyncio</span><br><span class=\"line\">pip install nest_asyncio==1.5.1</span><br></pre></td></tr></tbody></table></figure></div>\n<ol start=\"2\">\n<li>生成密码 </li>\n</ol>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">(pycal) ~/calhub ❯❯❯ ipython</span><br><span class=\"line\">Python <span class=\"number\">3.8</span><span class=\"number\">.10</span> (default, Sep <span class=\"number\">28</span> <span class=\"number\">2021</span>, <span class=\"number\">16</span>:<span class=\"number\">10</span>:<span class=\"number\">42</span>) </span><br><span class=\"line\"><span class=\"type\">Type</span> <span class=\"string\">'copyright'</span>, <span class=\"string\">'credits'</span> <span class=\"keyword\">or</span> <span class=\"string\">'license'</span> <span class=\"keyword\">for</span> more information</span><br><span class=\"line\">IPython <span class=\"number\">7.30</span><span class=\"number\">.0</span> -- An enhanced Interactive Python. <span class=\"type\">Type</span> <span class=\"string\">'?'</span> <span class=\"keyword\">for</span> <span class=\"built_in\">help</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">1</span>]: <span class=\"keyword\">from</span> notebook.auth <span class=\"keyword\">import</span> passwd</span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">2</span>]: passwd(<span class=\"string\">\"password\"</span>, <span class=\"string\">'sha1'</span>)</span><br><span class=\"line\">Out[<span class=\"number\">2</span>]: <span class=\"string\">'sha1:c3354c486202:4ddc858c5be0eef7b78547c6210c0d65df1023e9'</span></span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>修改配置</li>\n</ol>\n<p>修改配置文件，路径在 <code>2.1</code> 中给出，一般为 <code>~/.jupyter/jupyter_lab_config.py</code>；在这一步后可以启动 <code>jupyter lab</code>，访问 <code>http://[ip]:port</code> 进行预览。</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">c.ServerApp.ip = <span class=\"string\">'0.0.0.0'</span></span><br><span class=\"line\">c.ServerApp.open_browser = <span class=\"literal\">False</span></span><br><span class=\"line\">c.ServerApp.password = <span class=\"string\">u'sha1:c3354c486202:4ddc858c5be0eef7b78547c6210c0d65df1023e9'</span> <span class=\"comment\"># 2.2中得到的加密密码</span></span><br><span class=\"line\">c.ServerApp.port = <span class=\"number\">8080</span> <span class=\"comment\"># 自定义端口</span></span><br><span class=\"line\">c.ServerApp.root_dir = <span class=\"string\">'~/calhub/project'</span> <span class=\"comment\"># 自定义工作目录</span></span><br></pre></td></tr></tbody></table></figure>\n<div class=\"note warning flat\"><p>注意要在服务器的管理面板放行相关端口。</p>\n</div>\n<h3 id=\"R相关环境\">R 相关环境 <a class=\"header-anchor\" href=\"#R相关环境\">¶</a></h3>\n<h4 id=\"下载\">下载 <a class=\"header-anchor\" href=\"#下载\">¶</a></h4>\n<p>为了避免 <code>X11</code> 的配置问题，采用编译安装 <code>R</code> 的方式。从 <code>CRAN</code> 下载源代码（推荐<a href=\"https://mirrors.tuna.tsinghua.edu.cn/CRAN/\">清华镜像源</a>），将其解压：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">wget https://mirrors.tuna.tsinghua.edu.cn/CRAN/src/base/R-4/R-4.1.2.tar.gz</span><br><span class=\"line\">tar -zxvf R-4.1.2.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">mv</span> R-4.1.2 rsource &amp;&amp; <span class=\"built_in\">cd</span> rsource</span><br></pre></td></tr></tbody></table></figure>\n<h4 id=\"安装前配置\">安装前配置 <a class=\"header-anchor\" href=\"#安装前配置\">¶</a></h4>\n<div class=\"note info flat\"><p>有问题，多看手册：<a href=\"https://cran.r-project.org/doc/manuals/r-release/R-admin.html\">R Installation and Administration</a></p>\n</div>\n<p>在安装之前，我们需要先通过 <code>rsource</code> 目录下的 <code>configure</code> 文件生成安装的配置文件，在安装中我们需要指定 <code>Cairo</code> 代替 <code>X11</code> 环境（<code>--with-x=no</code> 和 <code>--with-cairo</code>），同时指定相应的图片格式（如 <code>--with-libpng</code> 代表 <code>png</code> 格式），还可以指定 <code>R</code> 的安装位置（<code>--prefix=your path</code>）。运行 <sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup>：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">./configure --prefix=~/calhub/rcal --with-libpng --with-jpeglib --with-libtiff --with-x=no --with-cairo</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"note warning flat\"><p>在这一步骤前，请先确认服务器上安装有以下包：<code>libcairo2-dev</code>、<code>libjpeg-dev</code>、<code>libtiff-dev</code>、<code>libpng-dev</code>。</p>\n</div>\n<div class=\"note danger flat\"><p><code>configure: error: No Fortran compiler found</code><br>\n直接安装 <code>Fortran</code> 的编译器即可，如 <code>sudo apt install gfortran</code>。</p>\n</div>\n<div class=\"note danger flat\"><p><code>configure: error: –with-readline=yes (default) and headers/libs are not available</code><br>\n安装 <code>readline</code>：<code>sudo apt install libreadline6-dev</code></p>\n</div>\n<div class=\"note info flat\"><p><code>configure: WARNING: you cannot build info or HTML versions of the R manuals</code><br>\n这个问题是无法获取 <code>R</code> 手册的 html 版本，通过 <code>sudo apt install texinfo</code> 解决。</p>\n</div>\n<h4 id=\"安装-v2\">安装 <a class=\"header-anchor\" href=\"#安装-v2\">¶</a></h4>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">make</span><br><span class=\"line\">make check</span><br><span class=\"line\">make install</span><br></pre></td></tr></tbody></table></figure>\n<h4 id=\"安装后配置\">安装后配置 <a class=\"header-anchor\" href=\"#安装后配置\">¶</a></h4>\n<ol>\n<li> 确认正常</li>\n</ol>\n<p>进入 <code>R</code> 环境（可以将 <code>~/calhub/rcal/bin</code> 加入环境变量），查看 <code>cairo</code> 是否启用，各类图片是否支持。</p>\n<figure class=\"highlight r\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">(</span>pycal<span class=\"punctuation\">)</span> <span class=\"operator\">~</span><span class=\"operator\">/</span>calhub ❯❯❯ .<span class=\"operator\">/</span>rcal<span class=\"operator\">/</span>bin<span class=\"operator\">/</span>R</span><br><span class=\"line\">R version <span class=\"number\">4.1</span>.2 <span class=\"punctuation\">(</span><span class=\"number\">2021</span><span class=\"operator\">-</span><span class=\"number\">11</span><span class=\"operator\">-</span><span class=\"number\">01</span><span class=\"punctuation\">)</span> <span class=\"operator\">-</span><span class=\"operator\">-</span> <span class=\"string\">\"Bird Hippie\"</span></span><br><span class=\"line\">...</span><br><span class=\"line\">Type <span class=\"string\">'q()'</span> to quit R.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"operator\">&gt;</span> capabilities<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">       jpeg         png        tiff       tcltk         X11        aqua </span><br><span class=\"line\">       <span class=\"literal\">TRUE</span>        <span class=\"literal\">TRUE</span>        <span class=\"literal\">TRUE</span>       <span class=\"literal\">FALSE</span>       <span class=\"literal\">FALSE</span>       <span class=\"literal\">FALSE</span> </span><br><span class=\"line\">   http<span class=\"operator\">/</span>ftp     sockets      libxml        fifo      cledit       iconv </span><br><span class=\"line\">       <span class=\"literal\">TRUE</span>        <span class=\"literal\">TRUE</span>        <span class=\"literal\">TRUE</span>        <span class=\"literal\">TRUE</span>        <span class=\"literal\">TRUE</span>        <span class=\"literal\">TRUE</span> </span><br><span class=\"line\">        NLS       Rprof     profmem       cairo         ICU long.double </span><br><span class=\"line\">       <span class=\"literal\">TRUE</span>        <span class=\"literal\">TRUE</span>       <span class=\"literal\">FALSE</span>        <span class=\"literal\">TRUE</span>        <span class=\"literal\">TRUE</span>        <span class=\"literal\">TRUE</span> </span><br><span class=\"line\">    libcurl </span><br><span class=\"line\">       <span class=\"literal\">TRUE</span> </span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>配置 <code>~/.Rprofile</code></li>\n</ol>\n<p><code>.Rprofile</code> 文件是 <code>R</code> 的开始配置文件（<code>Startup Configuration</code>），一般情况下在用户目录下建立该文件即可，也可以在工作目录或者 <code>R</code> 的安装目录编写 <sup class=\"footnote-ref\"><a href=\"#fn2\" id=\"fnref2\">[2]</a></sup>。通过该文件，我们指定图片默认使用 <code>cairo</code>，安装默认使用清华镜像源。</p>\n<figure class=\"highlight r\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Set default 'type' for png() calls - useful when X11 device is not available!</span></span><br><span class=\"line\"><span class=\"comment\">## <span class=\"doctag\">NOTE:</span> Needs 'cairo' capability</span></span><br><span class=\"line\">options<span class=\"punctuation\">(</span>bitmapType<span class=\"operator\">=</span><span class=\"string\">'cairo'</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">options<span class=\"punctuation\">(</span><span class=\"string\">\"repos\"</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>CRAN<span class=\"operator\">=</span><span class=\"string\">\"https://mirrors.tuna.tsinghua.edu.cn/CRAN/\"</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">cat<span class=\"punctuation\">(</span><span class=\"string\">\"\\nWelcome at\"</span><span class=\"punctuation\">,</span> date<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"string\">\"\\n\"</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>安装 <code>Cairo</code></li>\n</ol>\n<p>安装 <code>Cairo</code>，并查看是否支持各类图片格式。（未尝试过不安装是否可以）</p>\n<figure class=\"highlight r\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"operator\">&gt;</span> install.packages<span class=\"punctuation\">(</span><span class=\"string\">\"Cairo\"</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"operator\">&gt;</span> library<span class=\"punctuation\">(</span><span class=\"string\">\"Cairo\"</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"operator\">&gt;</span> Cairo.capabilities<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">   png   jpeg   tiff    pdf    svg     ps    x11    win raster </span><br><span class=\"line\">  <span class=\"literal\">TRUE</span>   <span class=\"literal\">TRUE</span>   <span class=\"literal\">TRUE</span>   <span class=\"literal\">TRUE</span>   <span class=\"literal\">TRUE</span>   <span class=\"literal\">TRUE</span>   <span class=\"literal\">TRUE</span>  <span class=\"literal\">FALSE</span>   <span class=\"literal\">TRUE</span></span><br></pre></td></tr></tbody></table></figure>\n<div class=\"note danger flat\"><p><code>ERROR: configuration failed for package ''Cairo'</code><br>\n服务器没有安装 <code>cairo</code> 的包，通过 <code>sudo apt install libcairo2-dev</code> 解决。</p>\n</div>\n<div class=\"note danger flat\"><p><code>fatal error: X11/Intrinsic.h: No such file or directory</code><br>\n这个包是在编译安装 <code>cairo</code> 过程中需要用到的，通过 <code>sudo apt install libxt-dev</code> 解决。<sup><a href=\"#fn4\">[4]</a></sup></p>\n</div>\n<h3 id=\"Jupyter配置\">Jupyter 配置 <a class=\"header-anchor\" href=\"#Jupyter配置\">¶</a></h3>\n<h4 id=\"添加R-kernel\">添加 <code>R kernel</code><a class=\"header-anchor\" href=\"#添加R-kernel\">¶</a></h4>\n<ol>\n<li> 安装依赖包 </li>\n</ol>\n<figure class=\"highlight r\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"operator\">&gt;</span> install.packages<span class=\"punctuation\">(</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">'repr'</span><span class=\"punctuation\">,</span> <span class=\"string\">'IRdisplay'</span><span class=\"punctuation\">,</span> <span class=\"string\">'evaluate'</span><span class=\"punctuation\">,</span> <span class=\"string\">'crayon'</span><span class=\"punctuation\">,</span> <span class=\"string\">'pbdZMQ'</span><span class=\"punctuation\">,</span> <span class=\"string\">'devtools'</span><span class=\"punctuation\">,</span> <span class=\"string\">'uuid'</span><span class=\"punctuation\">,</span> <span class=\"string\">'digest'</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></tbody></table></figure>\n<div class=\"note danger flat\"><p><code>installation of package 'devtools'/'gert'/'phangorn' had non-zero exit status</code><br>\n通过单独安装某个包（例如 <code>install.packages(\"devtools\")</code>）的方式，可以获取报错，发现都是因为 <code>git2</code> 导致的，通过 <code>sudo apt install libgit2-dev</code> 解决。<sup><a href=\"#fn5\">[5]</a></sup></p>\n</div>\n<ol start=\"2\">\n<li> 安装 <code>kernel</code></li>\n</ol>\n<figure class=\"highlight r\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"operator\">&gt;</span> devtools<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">'IRkernel/IRkernel'</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></tbody></table></figure>\n<div class=\"note warning flat\"><p>这一步对网络的要求比较高，可以设置代理进行。</p>\n</div>\n<div class=\"note danger flat\"><p><code>Error in loadNamespace(i, c(lib.loc, .libPaths()), versionCheck = vI[[i]]) : 载入了名字空间'rlang' 0.2.2，但需要的是&gt;= 0.3.0</code><br>\n先卸载 <code>rlang</code> 包，再重新安装：</p>\n<figure class=\"highlight r\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"operator\">&gt;</span> remove.packages<span class=\"punctuation\">(</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">'rlang'</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> lib<span class=\"operator\">=</span>file.path<span class=\"punctuation\">(</span><span class=\"string\">'包所在位置'</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\"><span class=\"comment\"># 或</span></span><br><span class=\"line\"><span class=\"operator\">&gt;</span> remove.packages<span class=\"punctuation\">(</span><span class=\"string\">'rlang'</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"operator\">&gt;</span> install.packages<span class=\"punctuation\">(</span><span class=\"string\">'rlang'</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></tbody></table></figure></div>\n<ol start=\"3\">\n<li>添加 <code>kernel</code></li>\n</ol>\n<figure class=\"highlight r\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 给自己安装</span></span><br><span class=\"line\"><span class=\"operator\">&gt;</span> IRkernel<span class=\"operator\">::</span>installspec<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># 给系统安装</span></span><br><span class=\"line\"><span class=\"operator\">&gt;</span> IRkernel<span class=\"operator\">::</span>installspec<span class=\"punctuation\">(</span>user <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></tbody></table></figure>\n<p>输出会给出 <code>kernel</code> 路径，如 <code>Installed kernelspec ir in ~/.local/share/jupyter/kernels/ir</code>。</p>\n<h4 id=\"Nginx配置\">Nginx 配置 <a class=\"header-anchor\" href=\"#Nginx配置\">¶</a></h4>\n<p>在完成上述步骤后，可以通过 <code>http://ip:port</code> 的方式进行访问，如果需要绑定域名，我们还需要对 Nginx 进行配置，主要是实现 <code>WebSocker</code> 转发。</p>\n<figure class=\"highlight nginx\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> /</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"attribute\">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> REMOTE-HOST <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># 持久化连接相关配置实现wss转发</span></span><br><span class=\"line\">    <span class=\"attribute\">proxy_connect_timeout</span> <span class=\"number\">30s</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_read_timeout</span> <span class=\"number\">86400s</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_send_timeout</span> <span class=\"number\">30s</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_http_version</span> <span class=\"number\">1</span>.<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> Upgrade <span class=\"variable\">$http_upgrade</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_set_header</span> Connection <span class=\"string\">\"upgrade\"</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_redirect</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"attribute\">add_header</span> X-Cache <span class=\"variable\">$upstream_cache_status</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">#Set Nginx Cache</span></span><br><span class=\"line\">    <span class=\"attribute\">add_header</span> Cache-Control <span class=\"literal\">no</span>-cache;</span><br><span class=\"line\">    </span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"服务与插件\">服务与插件 <a class=\"header-anchor\" href=\"#服务与插件\">¶</a></h2>\n<h3 id=\"服务设置\">服务设置 <a class=\"header-anchor\" href=\"#服务设置\">¶</a></h3>\n<p>为了使 <code>Jupyter</code> 在后台长期运行，可以选择使用 <code>nohup</code>，或者使用类似于 <code>tmux</code> 的应用，也可以选择创建系统服务：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">## /usr/lib/systemd/system/jupyter.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Jupyter Lab</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">User=ubuntu</span><br><span class=\"line\">Group=ubuntu</span><br><span class=\"line\">WorkingDirectory=/home/ubuntu/calhub</span><br><span class=\"line\">ExecStart=/home/ubuntu/calhub/pycal/bin/jupyter lab</span><br><span class=\"line\"></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=10</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure>\n<p>随后运行 <code>sudo systemctl daemon-reload</code> 重载以下，后面就可以通过以下命令控制 <code>Jupyter</code>:</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl start jupyter    <span class=\"comment\"># 启动</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl <span class=\"built_in\">enable</span> jupyter   <span class=\"comment\"># 设置开机自启</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl status jupyter   <span class=\"comment\"># 查看状态</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> journalctl -u jupyter      <span class=\"comment\"># 查看日志</span></span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"插件安装\">插件安装 <a class=\"header-anchor\" href=\"#插件安装\">¶</a></h3>\n<p><code>Jupyter Lab</code> 拥有众多的插件，在左侧的 <code>Extension Manager</code> 中可以对插件进行管理。目前安装了两个较为需要的插件。</p>\n<h4 id=\"lsp\">lsp<a class=\"header-anchor\" href=\"#lsp\">¶</a></h4>\n<div class=\"note quote flat\"><p>Coding assistance for JupyterLab (code navigation + hover suggestions + linters + autocompletion + rename) using Language Server Protocol</p>\n</div>\n<ol>\n<li>首先安装插件本体：</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">pip install <span class=\"string\">'jupyterlab&gt;=3.0.0,&lt;4.0.0a0'</span> jupyterlab-lsp</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>根据需要安装 <code>LSP language server</code>，例如我需要 <code>Python</code> 以及 <code>R</code> 语言：</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">pip install <span class=\"string\">'python-lsp-server[all]'</span></span><br><span class=\"line\">R -e <span class=\"string\">'install.packages(\"languageserver\")'</span></span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>重启 <code>Jupyter Lab</code> 服务</li>\n</ol>\n<h4 id=\"system-monitor\">system-monitor<a class=\"header-anchor\" href=\"#system-monitor\">¶</a></h4>\n<ol>\n<li> 安装插件本体：</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">pip install jupyterlab-system-monitor</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>修改 <code>Jupyter</code> 配置 <code>~/.jupyter/jupyter_lab_config.py</code>：</li>\n</ol>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># memory</span></span><br><span class=\"line\">c.ResourceUseDisplay.mem_limit = &lt;size_in_GB&gt; *<span class=\"number\">1024</span>*<span class=\"number\">1024</span>*<span class=\"number\">1024</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cpu</span></span><br><span class=\"line\">c.ResourceUseDisplay.track_cpu_percent = <span class=\"literal\">True</span></span><br><span class=\"line\">c.ResourceUseDisplay.cpu_limit = &lt;number_of_cpus&gt;</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>修改插件配置：在 <code>Settings</code> 中选择 <code>Advanced Settings Editor</code>，找到 <code>System Monitor</code>，在右侧写入自己的配置：</li>\n</ol>\n<figure class=\"highlight json\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">{</span></span><br><span class=\"line\">    <span class=\"comment\">// CPU Settings</span></span><br><span class=\"line\">    <span class=\"comment\">// Settings for the CPU indicator</span></span><br><span class=\"line\">    <span class=\"attr\">\"cpu\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">        <span class=\"attr\">\"label\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"CPU Usage: \"</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Memory Settings</span></span><br><span class=\"line\">    <span class=\"comment\">// Settings for the memory indicator</span></span><br><span class=\"line\">    <span class=\"attr\">\"memory\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">        <span class=\"attr\">\"label\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Memory Usage: \"</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Refresh Rate (ms)</span></span><br><span class=\"line\">    <span class=\"comment\">// Refresh Rate to sync metrics data</span></span><br><span class=\"line\">    <span class=\"attr\">\"refreshRate\"</span><span class=\"punctuation\">:</span> <span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"punctuation\">}</span></span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"附录\">附录 <a class=\"header-anchor\" href=\"#附录\">¶</a></h2>\n<h3 id=\"演示\">演示 <a class=\"header-anchor\" href=\"#演示\">¶</a></h3>\n<p><img src=\"https://asset.foolishfox.cn/2021/12/jupyter_1.png\" alt=\"\"><br>\n<img src=\"https://asset.foolishfox.cn/2021/12/jupyter_2.gif\" alt=\"\"></p>\n<h3 id=\"requirements内容\"><code>requirements</code> 内容 <a class=\"header-anchor\" href=\"#requirements内容\">¶</a></h3>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">numpy</span><br><span class=\"line\">pandas</span><br><span class=\"line\">matplotlib</span><br><span class=\"line\">tables</span><br><span class=\"line\">astropy</span><br><span class=\"line\">handcalcs</span><br><span class=\"line\">jupyterlab</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"保存文件失败\">保存文件失败 <a class=\"header-anchor\" href=\"#保存文件失败\">¶</a></h3>\n<ol>\n<li> 防火墙设置</li>\n</ol>\n<p>宝塔的专业版防火墙和免费 Nginx 防火墙都有 POST 最大参数限制，查看错误日志（如 <code>/www/wwwlogs/free_waf_log/</code>）发现有<code>参数值长度超过20w已被系统拦截</code>的字样，则说明防火墙出现问题，修改 <code>/www/server/free_waf/init.lua</code> 中的 <code>200000</code> 为更大的数字即可。</p>\n<ol start=\"2\">\n<li><code>websocket</code> 问题</li>\n</ol>\n<p>可参考官方推荐配置：</p>\n<figure class=\"highlight nginx\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">map</span> <span class=\"variable\">$http_upgrade</span> <span class=\"variable\">$connection_upgrade</span> {</span><br><span class=\"line\">        <span class=\"attribute\">default</span> upgrade;</span><br><span class=\"line\">        ''      close;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> {</span><br><span class=\"line\">        <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">        <span class=\"attribute\">server_name</span> jupyter.somewhere.cool;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"section\">location</span> / {</span><br><span class=\"line\">                <span class=\"attribute\">proxy_pass</span>            http://localhost:9999;</span><br><span class=\"line\">                <span class=\"attribute\">proxy_set_header</span>      Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">                <span class=\"attribute\">proxy_http_version</span>    <span class=\"number\">1</span>.<span class=\"number\">1</span>;</span><br><span class=\"line\">                <span class=\"attribute\">proxy_set_header</span>      Upgrade <span class=\"variable\">$http_upgrade</span>;</span><br><span class=\"line\">                <span class=\"attribute\">proxy_set_header</span>      Connection <span class=\"variable\">$connection_upgrade</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>权限问题</li>\n</ol>\n<p>请确认运行 <code>jupyter lab</code> 的用户拥有<code>.ipynb</code> 文件的读写权限。</p>\n<p><span hidden=\"\">脚注 <sup class=\"footnote-ref\"><a href=\"#fn3\" id=\"fnref3\">[3]</a></sup><sup class=\"footnote-ref\"><a href=\"#fn4\" id=\"fnref4\">[4]</a></sup><sup class=\"footnote-ref\"><a href=\"#fn5\" id=\"fnref5\">[5]</a></sup></span></p>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://zhuanlan.zhihu.com/p/434784775\">【上云第 1 期】访问云上的 jupyter 环境（保姆级搭建教程）</a></li>\n<li><a href=\"https://hijiangtao.github.io/2014/03/21/RSetupinLinux/\">Linux 环境下 R 语言安装笔记</a></li>\n<li><a href=\"https://blog.csdn.net/s1164548515/article/details/100747987\">jupyter 中加入 R 语言 kernel 操作指南</a></li>\n</ol>\n<hr class=\"footnotes-sep\">\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p><a href=\"https://stackoverflow.com/questions/26263934/compile-r-with-cairo-support-without-x11\">Compile R with Cairo support without X11</a> <a href=\"#fnref1\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn2\" class=\"footnote-item\"><p><a href=\"https://cran.r-project.org/web/packages/startup/vignettes/startup-intro.html\">startup: Friendly R Startup Configuration</a> <a href=\"#fnref2\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn3\" class=\"footnote-item\"><p><a href=\"https://github.com/jupyter/notebook/issues/6242\">Can not launch notebook after nest_asyncio upgraded to 1.5.2</a> <a href=\"#fnref3\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn4\" class=\"footnote-item\"><p><a href=\"https://blog.csdn.net/bedisdover/article/details/51840639\">【解决】fatal error: X11/XXXX.h: No such file or directory</a> <a href=\"#fnref4\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn5\" class=\"footnote-item\"><p><a href=\"https://stackoverflow.com/questions/65631688/ubuntu-how-to-deal-the-error-stdin110-fatal-error-git2-h-no-such-file-o\">Ubuntu, how to deal the error “&lt;stdin&gt;:1:10: fatal error: git2.h: No such file or directory”?</a> <a href=\"#fnref5\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n</ol>\n</section>\n","categories":["软件/程序","Jupyter"],"tags":["教程","Python","Jupyter","R"]},{"title":"Windows 下 Geant4 的安装与示例","url":"/posts/202204-g4b.html","content":"<p><code>Geant4</code>(GEometry ANd Tracking，几何和跟踪) 是由 <code>CERN</code>(欧洲核子研究组织) 基于 <code>C++</code> 面向对象技术开发的蒙特卡罗应用软件包，用于模拟粒子与物质的相互作用，在高能物理、加速器、核物理、辐射防护等多个领域都有着广泛的应用。</p>\n<span id=\"more\"></span>\n<h2 id=\"安装\">安装 <a class=\"header-anchor\" href=\"#安装\">¶</a></h2>\n<h3 id=\"环境要求\">环境要求 <a class=\"header-anchor\" href=\"#环境要求\">¶</a></h3>\n<ul>\n<li><a href=\"https://github.com/Geant4/geant4/releases\">源代码</a></li>\n<li><a href=\"https://www.visualstudio.com/\">MSVC</a> 19</li>\n<li><a href=\"https://cmake.org/\">CMaKe</a> &gt;= 3.16</li>\n<li><a href=\"https://download.qt.io/official_releases/online_installers/\">Qt5</a>（<strong>optional，可选</strong>）</li>\n</ul>\n<div class=\"note info flat\"><p><strong>MSVC</strong><br>\n只要求 <code>MSVC</code> 版本为 <code>19.X.X.X</code>，不要求 <code>Visual Studio</code> 版本为 <code>VS 2019</code>，通过在 <code>VS</code> 中打开 <code>isual Studio Tools (工具) → Developer Command Prompt for VS201X (Visual Studio 命令提示)</code> 可以查看 <code>MSVC</code> 版本：</p>\n<figure class=\"highlight cmd\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">&gt;cl</span><br><span class=\"line\">用于 x86 的 Microsoft (R) C/C++ 优化编译器 <span class=\"number\">19</span>.<span class=\"number\">31</span>.<span class=\"number\">31104</span> 版</span><br><span class=\"line\">版权所有(C) Microsoft Corporation。保留所有权利。</span><br><span class=\"line\"></span><br><span class=\"line\">用法: cl [ 选项... ] 文件名... [ /link 链接选项... ]</span><br></pre></td></tr></tbody></table></figure></div>\n<div class=\"note warning flat\"><p><strong>Qt</strong><br>\n必须是 <code>Qt5</code>，目前暂不支持 <code>Qt6</code>，推荐使用 <code>Qt 5.15 LTS</code>。</p>\n</div>\n<h3 id=\"安装前准备\">安装前准备 <a class=\"header-anchor\" href=\"#安装前准备\">¶</a></h3>\n<h4 id=\"CMaKe\">CMaKe<a class=\"header-anchor\" href=\"#CMaKe\">¶</a></h4>\n<p>推荐使用 <a href=\"https://foolishfox.cn/posts/202101-a.html\">Scoop</a> 进行安装，可以方便的进行版本更新，自动添加环境变量等：</p>\n<figure class=\"highlight cmd\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">scoop install cmake</span><br></pre></td></tr></tbody></table></figure>\n<h4 id=\"Qt（可选）\">Qt（可选）<a class=\"header-anchor\" href=\"#Qt（可选）\">¶</a></h4>\n<p><code>Qt</code> 是一个可选项，可以美化 <code>Geant4</code> 的 <code>GUI</code> 显示，注意版本必须为 <code>5.X.X</code>，目前最新的 LTS 版本是 <code>5.15.3</code>。从<a href=\"https://download.qt.io/official_releases/online_installers/\">下载页面</a>获取在线安装程序，本过程需要 <code>Qt</code> 账号，可以提前在官网注册好。</p>\n<p>在选择组件界面可以选择 <code>Qt</code> 的版本，以 <code>5.15.2</code> 为例，我们只需要其中的 <code>MSVC 2019</code> 部分，其余可根据需要自行选择：</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/28/1651106237252.png\" alt=\"图1 Qt的安装\"></div><span class=\"image-caption\">图 1 Qt 的安装</span></div>\n<p>安装完成后，找到安装目录下的动态链接库目录，如 <code>D:\\Qt\\5.15.2\\msvc2019_64\\bin</code>，将其添加至环境变量中的 <code>PATH</code>。</p>\n<h4 id=\"Geant4\">Geant4<a class=\"header-anchor\" href=\"#Geant4\">¶</a></h4>\n<p>从 <code>Github</code> 下载 <code>Geant4</code> 的源代码文件，解压至 <code>D:\\Geant4\\source</code> 目录下。</p>\n<h3 id=\"编译安装\">编译安装 <a class=\"header-anchor\" href=\"#编译安装\">¶</a></h3>\n<h4 id=\"无Qt\">无 Qt<a class=\"header-anchor\" href=\"#无Qt\">¶</a></h4>\n<p>无 <code>Qt</code> 版本的编译安装较为简单，进入 <code>D:\\Geant4</code> 目录，创建 <code>build</code> 文件夹并进入：</p>\n<figure class=\"highlight cmd\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">&gt; <span class=\"built_in\">cd</span> D:\\Geant4</span><br><span class=\"line\">&gt; <span class=\"built_in\">mkdir</span> build</span><br><span class=\"line\">&gt; <span class=\"built_in\">dir</span> /B</span><br><span class=\"line\">build</span><br><span class=\"line\">source</span><br><span class=\"line\">&gt; <span class=\"built_in\">cd</span> build</span><br></pre></td></tr></tbody></table></figure>\n<p>随后运行 <code>CMaKe</code>：</p>\n<figure class=\"highlight cmd\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">cmake -DCMAKE_INSTALL_PREFIX=\"D:\\Geant4\\disk\" \"D:\\Geant4\\source\"</span><br></pre></td></tr></tbody></table></figure>\n<p>其中 <code>CMAKE_INSTALL_PREFIX</code> 用于设置安装路径，即安装 <code>Geant4</code> 库、头文件和支持文件的目录，必须为<strong>绝对路径</strong>。后者为源代码的目录，可以为相对路径。<code>Geant4</code> 还有很多的可选编译选项，可以查阅 <a href=\"https://geant4-userdoc.web.cern.ch/UsersGuides/InstallationGuide/html/installguide.html#geant4buildoptions\">Geant4 Build Options</a>。</p>\n<figure class=\"highlight cmd\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">&gt; cmake -DCMAKE_INSTALL_PREFIX=\"D:\\Geant4\\disk\" \"D:\\Geant4\\source\"</span><br><span class=\"line\">-- Building <span class=\"keyword\">for</span>: Visual Studio <span class=\"number\">17</span> <span class=\"number\">2022</span></span><br><span class=\"line\">-- Selecting Windows SDK version <span class=\"number\">10</span>.<span class=\"number\">0</span>.<span class=\"number\">19041</span>.<span class=\"number\">0</span> to target Windows <span class=\"number\">10</span>.<span class=\"number\">0</span>.<span class=\"number\">19043</span>.</span><br><span class=\"line\">-- The C compiler identification is MSVC <span class=\"number\">19</span>.<span class=\"number\">31</span>.<span class=\"number\">31104</span>.<span class=\"number\">0</span></span><br><span class=\"line\">-- The CXX compiler identification is MSVC <span class=\"number\">19</span>.<span class=\"number\">31</span>.<span class=\"number\">31104</span>.<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">......</span><br><span class=\"line\"></span><br><span class=\"line\">-- The following Geant4 features are enabled:</span><br><span class=\"line\"><span class=\"function\">CMAKE_CXX_STANDARD: <span class=\"title\">Compiling</span> <span class=\"title\">against</span> <span class=\"title\">C</span>++ <span class=\"title\">Standard</span> '17'</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">GEANT4_BUILD_MULTITHREADED</span>: <span class=\"title\">Build</span> <span class=\"title\">multithread</span> <span class=\"title\">enabled</span> <span class=\"title\">libraries</span></span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">-- <span class=\"title\">Configuring</span> <span class=\"title\">done</span></span></span><br><span class=\"line\"><span class=\"function\">-- <span class=\"title\">Generating</span> <span class=\"title\">done</span></span></span><br><span class=\"line\"><span class=\"function\">-- <span class=\"title\">Build</span> <span class=\"title\">files</span> <span class=\"title\">have</span> <span class=\"title\">been</span> <span class=\"title\">written</span> <span class=\"title\">to</span>: <span class=\"title\">D</span>:/<span class=\"title\">Geant4</span>/<span class=\"title\">build</span></span></span><br></pre></td></tr></tbody></table></figure>\n<p>一般情况下你会看到警告，这只是一个建议项，提醒我们安装进行模拟所必须的数据文件，不影响后续的安装，可以等到安装完成后自行下载解压。</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">*WARNING*</span><br><span class=\"line\">  Geant4 has been pre-configured to look for datasets</span><br><span class=\"line\">  in the directory:</span><br><span class=\"line\"></span><br><span class=\"line\">  D:\\Geant4\\disk\\share\\Geant4-11.0.1\\data</span><br><span class=\"line\"></span><br><span class=\"line\">  but the following datasets are NOT present on disk at</span><br><span class=\"line\">  that location:</span><br></pre></td></tr></tbody></table></figure>\n<p>经过上面的步骤，<code>CMaKe</code> 会生成一个 <code>Visual Studio</code> 的解决方案，当然我们也可以通过命令行直接进行安装，注意我们选用了 <code>Release</code> 项，这是因为 <code>Geant4</code> 的 <code>Debug</code> 配置优化不是很好，不能带来最佳的性能。</p>\n<figure class=\"highlight cmd\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">&gt; cmake --build . --config Release --target install</span><br></pre></td></tr></tbody></table></figure>\n<h4 id=\"Qt\">Qt<a class=\"header-anchor\" href=\"#Qt\">¶</a></h4>\n<p>带有 <code>Qt</code> 的编译安装较为繁琐，所以我们可以借助 <code>CMaKe-GUI</code> 进行配置。选择源代码目录 <code>D:\\Geant4\\source</code> 和构建目录 <code>D:\\Geant4\\source</code> 后，我们添加一个配置项为 <code>CMAKE_PREFIX_PATH</code>，类型为 <code>PATH</code>，值为 <code>Qt</code> 动态链接库的上一级目录（如 <code>D:\\Qt\\5.15.2\\msvc2019_64</code>），随后点击左下角的 <code>Configure</code> 按钮。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/28/1651108142644.png\" alt=\"图2 CMAKE_PREFIX_PATH配置项\" style=\"height:200px;\"></div><span class=\"image-caption\">图 2 CMAKE_PREFIX_PATH 配置项</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/28/1651107988351.png\" alt=\"图3 CMaKe的Qt配置\" style=\"height:400px;\"></div><span class=\"image-caption\">图 3 CMaKe 的 Qt 配置</span></div>\n<p>随后，我们在自动添加的配置项中，将 <code>CMAKE_INSTALL_PREFIX</code>（安装目录）设置为 <code>D:\\Geant4\\disk</code>，将 <code>GEANT4_BUILD_MULTITHREADED</code>（多线程编译）勾选，将 <code>GEANT4_USE_OPENGL_WIN32</code> 和 <code>GEANT4_USE_QT</code> 勾选启用 <code>Qt</code>，再次点击左下角的 <code>Configure</code> 按钮，<code>CMaKe</code> 会自动帮助进行 <code>Qt</code> 的进一步配置，确认无误后再次点击左下角的 <code>Configure</code> 按钮，当所有的配置项均变为白色时，则配置完成，点击 <code>Configure</code> 右侧的 <code>Generate</code> 进行生成。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/28/6269ec165cfee.png\" alt=\"图4 CMaKe的Qt配置2\"></div><span class=\"image-caption\">图 4 CMaKe 的 Qt 配置 2</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/28/6269ed5521256.png\" alt=\"图5 CMaKe的Qt配置3\"></div><span class=\"image-caption\">图 5 CMaKe 的 Qt 配置 3</span></div>\n<p>点击 <code>Generate</code> 右侧的 <code>Open Project</code> 在 <code>Visual Studio</code> 中打开项目，在解决方案资源管理器中，选中 <code>ALL_BUILD</code> 到 <code>INSTALL</code> 中间的所有项目，打开属性（上端的扳手按钮），启用多处理器编译选项。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/28/6269ee9b6e977.png\" alt=\"图6 CMaKe的Qt构建1\"></div><span class=\"image-caption\">图 6 CMaKe 的 Qt 构建 1</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/28/6269ef010934c.jpg\" alt=\"图7 CMaKe的Qt构建2\"></div><span class=\"image-caption\">图 7 CMaKe 的 Qt 构建 2</span></div>\n<p>然后在 <code>ALL_BUILD</code> 项目上点击右键，再点击生成 (<code>Build</code>)，等待结束后在 <code>INSTALL</code> 项目上点击右键，再点击生成 (<code>Build</code>)，即可完成编译安装。</p>\n<h4 id=\"安装后配置\">安装后配置 <a class=\"header-anchor\" href=\"#安装后配置\">¶</a></h4>\n<p>在环境变量中添加 <code>D:\\Geant4\\dist\\bin</code>。</p>\n<p>在 <a href=\"https://geant4.web.cern.ch/support/download\">Download</a> 页面下载好数据文件，目前总计 12 个，约 2G 大小，将其解压至 <code>D:\\Geant4\\dist\\share\\Geant4-11.0.1\\data</code> 目录下（<code>data</code> 文件夹可能需要自己创建），解压后目录结构如下：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">D:\\GEANT4\\DIST\\SHARE\\GEANT4-11.0.1\\DATA</span><br><span class=\"line\">|---G4ABLA3.1</span><br><span class=\"line\">│   |---*.dat</span><br><span class=\"line\">│   `---sub directory</span><br><span class=\"line\">|---G4EMLOW8.0</span><br><span class=\"line\">|---G4ENSDFSTATE2.3</span><br><span class=\"line\">|---G4INCL1.0</span><br><span class=\"line\">|---G4NDL4.6</span><br><span class=\"line\">|---G4PARTICLEXS4.0</span><br><span class=\"line\">|---G4PII1.3</span><br><span class=\"line\">|---G4SAIDDATA2.0</span><br><span class=\"line\">|---G4TENDL1.4</span><br><span class=\"line\">|---PhotonEvaporation5.7</span><br><span class=\"line\">|---RadioactiveDecay5.6</span><br><span class=\"line\">`---RealSurface2.2</span><br></pre></td></tr></tbody></table></figure>\n<p>随后运行 <code>D:\\Geant4\\dist\\bin</code> 目录下的 <code>geant4.csh</code> 文件，复制设置环境变量的一段，并进行修改，将结果保存至 <code>reg.bat</code> 文件中并运行。</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">setx G4NEUTRONHPDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4NDL4.6</span><br><span class=\"line\">setx G4LEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4EMLOW8.0</span><br><span class=\"line\">setx G4LEVELGAMMADATA D:/Geant4/dist/share/Geant4-11.0.1/data/PhotonEvaporation5.7</span><br><span class=\"line\">setx G4RADIOACTIVEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/RadioactiveDecay5.6</span><br><span class=\"line\">setx G4PARTICLEXSDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4PARTICLEXS4.0</span><br><span class=\"line\">setx G4PIIDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4PII1.3</span><br><span class=\"line\">setx G4REALSURFACEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/RealSurface2.2</span><br><span class=\"line\">setx G4SAIDXSDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4SAIDDATA2.0</span><br><span class=\"line\">setx G4ABLADATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4ABLA3.1</span><br><span class=\"line\">setx G4INCLDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4INCL1.0</span><br><span class=\"line\">setx G4ENSDFSTATEDATA D:/Geant4/dist/share/Geant4-11.0.1/data/G4ENSDFSTATE2.3</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"示例\">示例 <a class=\"header-anchor\" href=\"#示例\">¶</a></h2>\n<h3 id=\"example-B1\">example B1<a class=\"header-anchor\" href=\"#example-B1\">¶</a></h3>\n<p><code>B1</code> 是用于计算吸收剂量的。几何模型可见图 8，半透明的蓝色长方体中填充了水（<code>G4_WATER</code>），外界为空气。在长方体内部有两个物体，第一个圆台状物体的材料为人体组织（<code>G4_A-150_TISSUE</code>），第二个梯形状物体的材料为骨（<code>G4_BONE_COMPACT_ICRU</code>）。</p>\n<p>粒子从圆台状物体的前方入射，分布范围是长方体前侧面积的 80%，从图 9 可以看出，有些粒子在长方体内与水发生反应，直接散射出去；有些粒子直接射在骨中；有些粒子经过组织后入射到骨中。通过计算粒子在骨中沉积的能量，再除以骨的质量，我们可以得到整个骨的平均吸收剂量。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/29/626bd4e893801.png\" alt=\"图8 B1的几何体\"></div><span class=\"image-caption\">图 8 B1 的几何体</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/29/626bd5dde6164.png\" alt=\"图9 B1粒子入射模拟\"></div><span class=\"image-caption\">图 9 B1 粒子入射模拟</span></div>\n<h4 id=\"试运行\">试运行 <a class=\"header-anchor\" href=\"#试运行\">¶</a></h4>\n<p>在 <code>D:\\Geant4\\dist\\share\\Geant4-11.0.1\\examples</code> 目录下有很多 <code>Geant4</code> 的示例代码，我们将 <code>basic/B1</code> 示例复制到 <code>~/exampleB1</code> 目录下，改名为 <code>source</code>，并创建同级目录 <code>build</code>：</p>\n<figure class=\"highlight cmd\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">&gt; <span class=\"built_in\">mkdir</span> -p ~/exampleB1/source</span><br><span class=\"line\">&gt; <span class=\"built_in\">Copy</span>-Item D:\\Geant4\\dist\\share\\Geant4-<span class=\"number\">11</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span>\\examples\\B1 -Recurse ~/exampleB1/source</span><br><span class=\"line\">&gt; <span class=\"built_in\">mkdir</span> -p ~/exampleB1/build</span><br></pre></td></tr></tbody></table></figure>\n<p>进入 <code>build</code> 目录进行构建，<code>Geant4_DIR</code> 是 <code>Geant4</code> 库文件的安装目录，<code>CMAKE_INSTALL_PREFIX</code> 是最终文件的目录：</p>\n<figure class=\"highlight cmd\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">&gt; <span class=\"built_in\">cd</span> build</span><br><span class=\"line\">&gt; cmake -DGeant4_DIR=\"D:\\Geant4\\dist\\lib\\Geant4-<span class=\"number\">11</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span>\" -DCMAKE_INSTALL_PREFIX=\"~/exampleB1/disk\" \"~/exampleB1/source\"</span><br></pre></td></tr></tbody></table></figure>\n<p>构建后会在 <code>build</code> 目录下生成一个<code>.sln</code> 文件，可以使用 <code>Visual Studio</code> 打开并编译，也可以使用命令行如下：</p>\n<figure class=\"highlight cmd\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">&gt; cmake --build . --config Release --target install</span><br></pre></td></tr></tbody></table></figure>\n<p>编译后会在 <code>~/exampleB1/disk/bin</code> 目录下生成一个<code>.exe</code> 文件，运行该文件还需要<code>.mac</code> 文件，因此我们复制 <code>build</code> 目录下的所有<code>.mac</code> 文件到 <code>~/exampleB1/disk/bin</code> 目录下，进入 <code>~/exampleB1/disk/bin</code> 目录，运行<code>.exe</code> 文件。</p>\n<figure class=\"highlight cmd\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">&gt; cp *.mac ~\\exampleB1\\disk\\bin\\</span><br><span class=\"line\">&gt; <span class=\"built_in\">cd</span> ~/exampleB1/disk/bin</span><br><span class=\"line\">&gt; .\\exampleB1.exe</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/28/6269f7268fadf.png\" alt=\"图10 exampleB1\"></div><span class=\"image-caption\">图 10 exampleB1</span></div>\n<h4 id=\"分析\">分析 <a class=\"header-anchor\" href=\"#分析\">¶</a></h4>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">.</span><br><span class=\"line\">|-- include</span><br><span class=\"line\">|   |-- *.hh</span><br><span class=\"line\">|-- src</span><br><span class=\"line\">|   `-- *.cc</span><br><span class=\"line\">|-- CMakeLists.txt</span><br><span class=\"line\">|-- GNUmakefile</span><br><span class=\"line\">|-- exampleB1.cc</span><br><span class=\"line\">`-- *.mac</span><br></pre></td></tr></tbody></table></figure>\n<p>目录下主要有 <code>include</code> 和 <code>src</code> 两个目录，存放的是自定义的头文件及其源文件；<code>CMakeLists.txt</code>，<code>GNUmakefile</code> 是用于编译的配置文件，我们只需要用到 <code>CMakeLists.txt</code>；<code>exampleB1.cc</code> 是程序的主文件，程序入口也在该文件中；<code>*.mac</code> 可以存储需要运行的命令，作为脚本运行。</p>\n<p><code>Geant4</code> 中主要有 4 个概念，分别为 <code>Run</code>，<code>Event</code>，<code>Step</code>，<code>Track</code>：</p>\n<ul>\n<li><code>Run</code>：一次模拟过程，注意一个程序中可以进行多次模拟</li>\n<li><code>Event</code>：一次入射事件，每次入射事件可能入射多个粒子，注意包含次级粒子的反应过程</li>\n<li><code>Step</code>：某个粒子一次模拟的过程，是模拟的最小单位，包含有起始位置、花费时间、能量增量等粒子信息</li>\n<li><code>Track</code>：粒子的信息，包含有该粒子的 <code>Step</code> 的信息</li>\n</ul>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/29/626bd9bbb87ad.png\" alt=\"图11 Geant4概念的联系\"></div><span class=\"image-caption\">图 11 Geant4 概念的联系</span></div>\n<p>在 <code>Geant4</code> 中，有一些类需要有用户自行定义，其中某些类是必须的（强制类）。在主程序中，我们需要自己编写 <code>main</code> 函数，并至少创建运行管理类，将强制类设置到运行管理类中。下面我们按照模拟的流程介绍 <code>B1</code> 示例，其中 <code>G4VUserDetectorConstruction</code>、<code>G4VUserPhysicsList</code> 和 <code>G4VUserPrimaryGeneratorAction</code>（或其派生类）是 <code>Geant4</code> 的 3 个强制类。</p>\n<h5 id=\"几何体类\">几何体类 <a class=\"header-anchor\" href=\"#几何体类\">¶</a></h5>\n<p>我们需要从 <code>G4VUserDetectorConstruction</code> 类派生出具体类，并且在虚函数 <code>Construct</code> 中定义几何体的几何框架、材料，并进行放置。在 <code>DetectorConstruction.hh</code> 文件中，我们定义了 <code>DetectorConstruction</code> 类，其中 <code>Construct</code> 将会实现具体的构造，而 <code>fScoringVolume</code> 用于计算剂量，指定为梯形状物体（即 <code>shape2</code>）。</p>\n<figure class=\"highlight cpp\"><figcaption><span>DetectorConstruction.hh</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">DetectorConstruction</span> : <span class=\"keyword\">public</span> G4VUserDetectorConstruction {</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"built_in\">DetectorConstruction</span>();            <span class=\"comment\">// 构造</span></span><br><span class=\"line\">    ~<span class=\"built_in\">DetectorConstruction</span>() <span class=\"keyword\">override</span>;  <span class=\"comment\">// 构析</span></span><br><span class=\"line\">    <span class=\"function\">G4VPhysicalVolume* <span class=\"title\">Construct</span><span class=\"params\">()</span> <span class=\"keyword\">override</span></span>;  <span class=\"comment\">// 函数，描述探测器，返回物理体</span></span><br><span class=\"line\">    <span class=\"function\">G4LogicalVolume* <span class=\"title\">GetScoringVolume</span><span class=\"params\">()</span> <span class=\"type\">const</span> </span>{ <span class=\"keyword\">return</span> fScoringVolume; }  <span class=\"comment\">// 自定义计数函数 返回指针fScoringVolume</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    G4LogicalVolume* fScoringVolume = <span class=\"literal\">nullptr</span>;  <span class=\"comment\">// 用于计数</span></span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n<p><code>Geant4</code> 中一个几何体需要设置几何框架（<code>solid</code>）、材料（<code>logic</code>）、放置（<code>physical</code>）等操作，其中最大的几何体被称为 <code>World volume</code>，它应该所有其他的几何体。</p>\n<p>定义几何框架首先需要指定形状，例如长方体、圆柱、空心圆柱、圆锥等等（可参见 <a href=\"https://geant4-userdoc.web.cern.ch/UsersGuides/ForApplicationDeveloper/html/Detector/Geometry/geomSolids.html\">Solids</a>）。在本例中使用的是长方体，需要注意的是尺寸都是半数：</p>\n<figure class=\"highlight cpp\"><figcaption><span>DetectorConstruction.cc</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">G4Box* solidWorld = <span class=\"keyword\">new</span> <span class=\"built_in\">G4Box</span>(<span class=\"string\">\"World\"</span>, x_length, y_length, z_length);</span><br></pre></td></tr></tbody></table></figure>\n<p>随后我们需要查找材料，部分材料在前文已经提到过，例如水（<code>G4_WATER</code>）、组织（<code>G4_A-150_TISSUE</code>）、骨（<code>G4_BONE_COMPACT_ICRU</code>）和空气（<code>G4_AIR</code>）等等（可参见 <a href=\"https://geant4-userdoc.web.cern.ch/UsersGuides/ForApplicationDeveloper/html/Detector/material.html\">Material</a>）。材料的管理是通过 <code>G4NistManager</code> 类实现的：</p>\n<figure class=\"highlight cpp\"><figcaption><span>DetectorConstruction.cc</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">G4NistManager* nist = G4NistManager::<span class=\"built_in\">Instance</span>();</span><br><span class=\"line\">G4Material* world_mat = nist-&gt;<span class=\"built_in\">FindOrBuildMaterial</span>(<span class=\"string\">\"G4_AIR\"</span>);</span><br></pre></td></tr></tbody></table></figure>\n<p>然后将几何框架与材料结合，构建 <code>Logical Volumes</code>，只负责记录物体的几何特性，并增加了物理特性，包括材料、探针、磁场等，而不记录物体的位置信息：</p>\n<figure class=\"highlight cpp\"><figcaption><span>DetectorConstruction.cc</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">G4LogicalVolume* logicWorld = <span class=\"keyword\">new</span> <span class=\"built_in\">G4LogicalVolume</span>(solidWorld, world_mat, <span class=\"string\">\"World\"</span>);</span><br></pre></td></tr></tbody></table></figure>\n<p>最后需要将几何体放置到环境中，使用 <code>G4PVPlacement</code> 进行，返回值是一个 <code>Logical Volumes</code> 的实例，被称为 <code>Physical Volume</code>。由于 <code>Construct</code> 函数需要返回最大环境的物理体，因此我们通过 <code>physWorld</code> 变量进行这一操作：</p>\n<figure class=\"highlight cpp\"><figcaption><span>DetectorConstruction.cc</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">G4VPhysicalVolume* physWorld = <span class=\"keyword\">new</span> <span class=\"built_in\">G4PVPlacement</span>(<span class=\"number\">0</span>,                <span class=\"comment\">// 旋转</span></span><br><span class=\"line\">                                                <span class=\"built_in\">G4ThreeVector</span>(),  <span class=\"comment\">// 中心位置，World必须在 (0,0,0)</span></span><br><span class=\"line\">                                                logicWorld,       <span class=\"comment\">// 材料</span></span><br><span class=\"line\">                                                <span class=\"string\">\"World\"</span>,          <span class=\"comment\">// 名称</span></span><br><span class=\"line\">                                                <span class=\"number\">0</span>,                <span class=\"comment\">// 母体环境（Mother Volume）</span></span><br><span class=\"line\">                                                <span class=\"literal\">false</span>,            <span class=\"comment\">// no boolean operation</span></span><br><span class=\"line\">                                                <span class=\"number\">0</span>,                <span class=\"comment\">// copy number</span></span><br><span class=\"line\">                                                <span class=\"literal\">true</span>);            <span class=\"comment\">// overlaps checking</span></span><br></pre></td></tr></tbody></table></figure>\n<p>仿照上面的过程，我们可以定义水箱 <code>Envelope</code>、圆台状物体 <code>Shape1</code> 和梯形状物体 <code>Shape2</code>，并且将它们放置在 <code>Mother Logical Volumes</code> 中，而且 <code>Logical Volumes</code> 中可以包含多个物体：</p>\n<figure class=\"highlight cpp\"><figcaption><span>DetectorConstruction.cc</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">G4Material* env_mat = nist-&gt;<span class=\"built_in\">FindOrBuildMaterial</span>(<span class=\"string\">\"G4_WATER\"</span>);</span><br><span class=\"line\">G4Box* solidEnv = <span class=\"keyword\">new</span> <span class=\"built_in\">G4Box</span>(<span class=\"string\">\"Envelope\"</span>, x_length, y_length, z_length);</span><br><span class=\"line\">G4LogicalVolume* logicEnv = <span class=\"keyword\">new</span> <span class=\"built_in\">G4LogicalVolume</span>(solidEnv,     <span class=\"comment\">// 几何框架</span></span><br><span class=\"line\">                                                env_mat,      <span class=\"comment\">// 材料</span></span><br><span class=\"line\">                                                <span class=\"string\">\"Envelope\"</span>);  <span class=\"comment\">// 名称</span></span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"built_in\">G4PVPlacement</span>(<span class=\"number\">0</span>, <span class=\"built_in\">G4ThreeVector</span>(), logicEnv, <span class=\"string\">\"Envelope\"</span>, logicWorld,   <span class=\"comment\">// Mother Logical Volumes，即 World</span></span><br><span class=\"line\">                  <span class=\"literal\">false</span>, <span class=\"number\">0</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">...shape<span class=\"number\">1.</span>..</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"built_in\">G4PVPlacement</span>(<span class=\"number\">0</span>, pos1, logicShape1, <span class=\"string\">\"Shape1\"</span>, logicEnv, <span class=\"literal\">false</span>, <span class=\"number\">0</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">...shape<span class=\"number\">2.</span>..</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"built_in\">G4PVPlacement</span>(<span class=\"number\">0</span>, pos2, logicShape2, <span class=\"string\">\"Shape2\"</span>, logicEnv, <span class=\"literal\">false</span>, <span class=\"number\">0</span>, <span class=\"literal\">true</span>);</span><br></pre></td></tr></tbody></table></figure>\n<h5 id=\"物理类\">物理类 <a class=\"header-anchor\" href=\"#物理类\">¶</a></h5>\n<p><code>G4VUserPhysicsList</code> 或其派生类用于定义模拟中使用的所有粒子、物理过程和截止范围，而物理过程用于描述粒子与材料的相互作用过程。<code>PhysicsList</code> 是需要由用户指定或定义的类，一般情况下我们都会使用 <code>Geant4</code> 提供的物理过程，例如本例中的 <code>QBBC</code> 一般用于医学剂量评估和空间辐射物理的模拟，适用于需要精确模拟质子和中子的低能量传输的场景，对于薄靶实验，当粒子能量低于 1 GeV 时，有很好的效果。</p>\n<figure class=\"highlight cpp\"><figcaption><span>exampleB1.cc</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">G4VModularPhysicsList* physicsList = <span class=\"keyword\">new</span> QBBC;</span><br></pre></td></tr></tbody></table></figure>\n<h5 id=\"主事件生成类\">主事件生成类 <a class=\"header-anchor\" href=\"#主事件生成类\">¶</a></h5>\n<p>产生初级粒子的 <code>Event</code> 被称为 <code>Primary Events</code>，我们可以理解为粒子源，由 <code>G4VUserPrimaryGeneratorAction</code> 或其派生类进行定义，而实际粒子的产生则有 <code>G4VPrimaryGenerator</code> 或其派生类负责。<code>G4VuserPrimaryGeneratorAction</code> 有一个函数为 <code>GeneratePrimaries</code>，在每个 <code>Event</code> 开始时都会调用此方法。</p>\n<figure class=\"highlight cpp\"><figcaption><span>PrimaryGeneratorAction.hh</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">PrimaryGeneratorAction</span> : <span class=\"keyword\">public</span> G4VUserPrimaryGeneratorAction {</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"built_in\">PrimaryGeneratorAction</span>();</span><br><span class=\"line\">    ~<span class=\"built_in\">PrimaryGeneratorAction</span>() <span class=\"keyword\">override</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">GeneratePrimaries</span><span class=\"params\">(G4Event*)</span> <span class=\"keyword\">override</span></span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">const</span> G4ParticleGun* <span class=\"title\">GetParticleGun</span><span class=\"params\">()</span> <span class=\"type\">const</span> </span>{ <span class=\"keyword\">return</span> fParticleGun; }</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">    G4ParticleGun* fParticleGun = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">    G4Box* fEnvelopeBox = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n<p>在 <code>GeneratePrimaries</code> 我们需要使用 <code>G4VPrimaryGenerator</code> 或其派生类生成实际的粒子。<code>Geant4</code> 为我们提供了 3 个具体的类为：<code>G4ParticleGun</code>，<code>G4GeneralParticleSource</code>（被称为 <code>GPS</code>）和 <code>G4HEPEvtInterface</code>，在 <code>B1</code> 中使用的是 <code>G4ParticleGun</code>。</p>\n<p><code>G4ParticleGun</code> 可以生成具有给定动量和位置的初级粒子，不提供任何类型的随机化过程，但是在实际应用中我们经常需要一定的位置、能量的随机化，在 <code>B1</code> 例子中就需要在长方体前向面的 80% 范围内随机粒子的位置。我们可以在 <code>GeneratePrimaries</code> 函数中，调用自己编写的随机函数，生成随机的位置赋予给 <code>G4ParticleGun</code>，然后再生成粒子。与 <code>G4ParticleGun</code> 相比，<code>G4GeneralParticleSourceGPS</code> 可以定义初级粒子的能谱、空间和角分布等信息，可以更加灵活地实现随机源的生成。</p>\n<figure class=\"highlight cpp\"><figcaption><span>PrimaryGeneratorAction.cc</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">PrimaryGeneratorAction::GeneratePrimaries</span><span class=\"params\">(G4Event* anEvent)</span> </span>{</span><br><span class=\"line\">    <span class=\"comment\">// 几何参数用于调整源的空间分布</span></span><br><span class=\"line\">    G4double envSizeXY = xy;</span><br><span class=\"line\">    G4double envSizeZ = z;</span><br><span class=\"line\">    G4double size = <span class=\"number\">0.8</span>;</span><br><span class=\"line\">    G4double x0 = size * envSizeXY * (<span class=\"built_in\">G4UniformRand</span>() - <span class=\"number\">0.5</span>);</span><br><span class=\"line\">    G4double y0 = size * envSizeXY * (<span class=\"built_in\">G4UniformRand</span>() - <span class=\"number\">0.5</span>);</span><br><span class=\"line\">    G4double z0 = <span class=\"number\">-0.5</span> * envSizeZ;</span><br><span class=\"line\">    <span class=\"comment\">// 设置此次的位置并发射</span></span><br><span class=\"line\">    fParticleGun-&gt;<span class=\"built_in\">SetParticlePosition</span>(<span class=\"built_in\">G4ThreeVector</span>(x0, y0, z0));  </span><br><span class=\"line\">    fParticleGun-&gt;<span class=\"built_in\">GeneratePrimaryVertex</span>(anEvent);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<p>当然，在 <code>Event</code> 之前我们需要初始化，创建 <code>G4ParticleGun</code> 实例，并在 <code>Event</code> 结束后销毁。</p>\n<figure class=\"highlight cpp\"><figcaption><span>PrimaryGeneratorAction.cc</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">PrimaryGeneratorAction::<span class=\"built_in\">PrimaryGeneratorAction</span>() {</span><br><span class=\"line\">    <span class=\"comment\">// 初始化粒子枪，每个 event 有 n_particle 个粒子</span></span><br><span class=\"line\">    G4int n_particle = <span class=\"number\">1</span>;</span><br><span class=\"line\">    fParticleGun = <span class=\"keyword\">new</span> <span class=\"built_in\">G4ParticleGun</span>(n_particle);</span><br><span class=\"line\">    <span class=\"comment\">// 粒子列表的查找器</span></span><br><span class=\"line\">    G4ParticleTable* particleTable = G4ParticleTable::<span class=\"built_in\">GetParticleTable</span>();</span><br><span class=\"line\">    <span class=\"comment\">// 设置为 6 MeV 沿 z 轴正方向的 gamma 源</span></span><br><span class=\"line\">    G4ParticleDefinition* particle = particleTable-&gt;<span class=\"built_in\">FindParticle</span>(<span class=\"string\">\"gamma\"</span>);</span><br><span class=\"line\">    fParticleGun-&gt;<span class=\"built_in\">SetParticleDefinition</span>(particle);</span><br><span class=\"line\">    fParticleGun-&gt;<span class=\"built_in\">SetParticleMomentumDirection</span>(<span class=\"built_in\">G4ThreeVector</span>(<span class=\"number\">0.</span>, <span class=\"number\">0.</span>, <span class=\"number\">1.</span>));</span><br><span class=\"line\">    fParticleGun-&gt;<span class=\"built_in\">SetParticleEnergy</span>(<span class=\"number\">6.</span> * MeV);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\">PrimaryGeneratorAction::~<span class=\"built_in\">PrimaryGeneratorAction</span>() { <span class=\"keyword\">delete</span> fParticleGun; }</span><br></pre></td></tr></tbody></table></figure>\n<h5 id=\"用户行为类\">用户行为类 <a class=\"header-anchor\" href=\"#用户行为类\">¶</a></h5>\n<p>对于模拟中 <code>Run</code>，<code>Event</code>，<code>Step</code>，<code>Track</code> 等各个阶段，我们都可以自定义相应的行为，来实现我们需要的效果，例如统计某个物体内的沉积能量，剂量随深度的变化曲线等等。</p>\n<p>在 <code>B1</code> 中我们需要获取几何体 <code>Shape2</code> 的吸收剂量，所以我们需要获得粒子在其中损失的能量，这一部分信息被记录在 <code>Step</code> 中，因此可以根据以下的逻辑实现吸收剂量的统计：判断当前 <code>Step</code> 是否在 <code>Shape2</code> 中，如果在，则将沉积能量累加给当前 <code>Event</code> 的一个统计变量 <code>eDep</code>，在当前 <code>Event</code> 结束时，再将 <code>eDep</code> 统计给当前 <code>Run</code>，在当前 <code>Run</code> 结束时，通过计算总沉积能量与 <code>Shape2</code> 的质量比值来得到吸收剂量。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/30/626d376a468eb.png\" alt=\"图12 B1统计吸收剂量的流程\"></div><span class=\"image-caption\">图 12 B1 统计吸收剂量的流程</span></div>\n<p>相应的，我们需要在 <code>Run</code>，<code>Event</code>，<code>Step</code> 这 3 个阶段，定义行为来实现统计与返回：</p>\n<figure class=\"highlight cpp\"><figcaption><span>SteppingAction.hh</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">EventAction</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">SteppingAction</span> : <span class=\"keyword\">public</span> G4UserSteppingAction {</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"built_in\">SteppingAction</span>(EventAction* eventAction);</span><br><span class=\"line\">    ~<span class=\"built_in\">SteppingAction</span>() <span class=\"keyword\">override</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 每个 step 调用一次</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">UserSteppingAction</span><span class=\"params\">(<span class=\"type\">const</span> G4Step*)</span> <span class=\"keyword\">override</span></span>;</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">    EventAction* fEventAction = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">    G4LogicalVolume* fScoringVolume = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// SteppingAction.cc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 初始化 fEventAction，即获取到当前 Step 所在的 Event</span></span><br><span class=\"line\">SteppingAction::<span class=\"built_in\">SteppingAction</span>(EventAction* eventAction) : <span class=\"built_in\">fEventAction</span>(eventAction) {}  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 每个 step 调用一次</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">SteppingAction::UserSteppingAction</span><span class=\"params\">(<span class=\"type\">const</span> G4Step* step)</span> </span>{</span><br><span class=\"line\">    <span class=\"comment\">// 这段代码的目的是获得 Shape2 所代表的 Logical Volume</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!fScoringVolume) {</span><br><span class=\"line\">        <span class=\"type\">const</span> DetectorConstruction* detConstruction =</span><br><span class=\"line\">            <span class=\"built_in\">static_cast</span>&lt;<span class=\"type\">const</span> DetectorConstruction*&gt;(G4RunManager::<span class=\"built_in\">GetRunManager</span>()-&gt;<span class=\"built_in\">GetUserDetectorConstruction</span>());</span><br><span class=\"line\">        fScoringVolume = detConstruction-&gt;<span class=\"built_in\">GetScoringVolume</span>();</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"comment\">// 获取当前的 Volume</span></span><br><span class=\"line\">    G4LogicalVolume* volume = step-&gt;<span class=\"built_in\">GetPreStepPoint</span>()-&gt;<span class=\"built_in\">GetTouchableHandle</span>()-&gt;<span class=\"built_in\">GetVolume</span>()-&gt;<span class=\"built_in\">GetLogicalVolume</span>();</span><br><span class=\"line\">    <span class=\"comment\">// 检查是否在计算的 Volume （Shape 2）</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (volume != fScoringVolume) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 获取当前 step 的沉积能量</span></span><br><span class=\"line\">    G4double edepStep = step-&gt;<span class=\"built_in\">GetTotalEnergyDeposit</span>();</span><br><span class=\"line\">    fEventAction-&gt;<span class=\"built_in\">AddEdep</span>(edepStep);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<figure class=\"highlight cpp\"><figcaption><span>EventAction.hh</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">RunAction</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">EventAction</span> : <span class=\"keyword\">public</span> G4UserEventAction {</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"built_in\">EventAction</span>(RunAction* runAction);</span><br><span class=\"line\">    ~<span class=\"built_in\">EventAction</span>() <span class=\"keyword\">override</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">BeginOfEventAction</span><span class=\"params\">(<span class=\"type\">const</span> G4Event* event)</span> <span class=\"keyword\">override</span></span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">EndOfEventAction</span><span class=\"params\">(<span class=\"type\">const</span> G4Event* event)</span> <span class=\"keyword\">override</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// 对每个 step 累加，最后一个 step 输出一个 event 的能量沉积</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">AddEdep</span><span class=\"params\">(G4double edep)</span> </span>{ fEdep += edep; }</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">    RunAction* fRunAction = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">    G4double fEdep = <span class=\"number\">0.</span>;</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// EventAction.cc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 初始化 fEventAction，即获取到当前 Event 所在的 Run</span></span><br><span class=\"line\">EventAction::<span class=\"built_in\">EventAction</span>(RunAction* runAction) : <span class=\"built_in\">fRunAction</span>(runAction) {}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">EventAction::BeginOfEventAction</span><span class=\"params\">(<span class=\"type\">const</span> G4Event*)</span> </span>{ fEdep = <span class=\"number\">0.</span>; }</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">EventAction::EndOfEventAction</span><span class=\"params\">(<span class=\"type\">const</span> G4Event*)</span> </span>{</span><br><span class=\"line\">    <span class=\"comment\">// 将 event 中的沉积能量返回给 run</span></span><br><span class=\"line\">    fRunAction-&gt;<span class=\"built_in\">AddEdep</span>(fEdep);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<figure class=\"highlight cpp\"><figcaption><span>RunAction.hh</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">RunAction</span> : <span class=\"keyword\">public</span> G4UserRunAction {</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"built_in\">RunAction</span>();</span><br><span class=\"line\">    ~<span class=\"built_in\">RunAction</span>() <span class=\"keyword\">override</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">BeginOfRunAction</span><span class=\"params\">(<span class=\"type\">const</span> G4Run*)</span> <span class=\"keyword\">override</span></span>;  <span class=\"comment\">// Run 开始时执行</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">EndOfRunAction</span><span class=\"params\">(<span class=\"type\">const</span> G4Run*)</span> <span class=\"keyword\">override</span></span>;    <span class=\"comment\">// Run 结束时执行</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">AddEdep</span><span class=\"params\">(G4double edep)</span></span>;  <span class=\"comment\">// 计算累计沉积的能量</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">    G4Accumulable&lt;G4double&gt; fEdep = <span class=\"number\">0.</span>;</span><br><span class=\"line\">    G4Accumulable&lt;G4double&gt; fEdep2 = <span class=\"number\">0.</span>;</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// RunAction.cc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">RunAction::EndOfRunAction</span><span class=\"params\">(<span class=\"type\">const</span> G4Run* run)</span> </span>{</span><br><span class=\"line\">    <span class=\"comment\">// event 的数目</span></span><br><span class=\"line\">    G4int nofEvents = run-&gt;<span class=\"built_in\">GetNumberOfEvent</span>();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nofEvents == <span class=\"number\">0</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 合并累加的值</span></span><br><span class=\"line\">    G4AccumulableManager* accumulableManager = G4AccumulableManager::<span class=\"built_in\">Instance</span>();</span><br><span class=\"line\">    accumulableManager-&gt;<span class=\"built_in\">Merge</span>();</span><br><span class=\"line\">    <span class=\"comment\">// 计算总沉积能量</span></span><br><span class=\"line\">    G4double edep = fEdep.<span class=\"built_in\">GetValue</span>();</span><br><span class=\"line\">    <span class=\"comment\">// 剂量 =  / 质量</span></span><br><span class=\"line\">    <span class=\"type\">const</span> DetectorConstruction* detConstruction =</span><br><span class=\"line\">        <span class=\"built_in\">static_cast</span>&lt;<span class=\"type\">const</span> DetectorConstruction*&gt;(G4RunManager::<span class=\"built_in\">GetRunManager</span>()-&gt;<span class=\"built_in\">GetUserDetectorConstruction</span>());</span><br><span class=\"line\">    G4double mass = detConstruction-&gt;<span class=\"built_in\">GetScoringVolume</span>()-&gt;<span class=\"built_in\">GetMass</span>();</span><br><span class=\"line\">    G4double dose = edep / mass;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/04/29/626bda2ae29da.png\" alt=\"图13 统计过程中的调用关系（点击放大）\"></div><span class=\"image-caption\">图 13 统计过程中的调用关系（点击放大）</span></div>\n<h5 id=\"初始化与管理类\">初始化与管理类 <a class=\"header-anchor\" href=\"#初始化与管理类\">¶</a></h5>\n<p>实现了各种强制类和用户行为的定义后，我们需要回到 <code>main</code> 函数，将这些类添加到运行中，其中首先要做的就是创建 <code>G4RunManager</code> 类的一个实例，它负责管理整个模拟进程的运行与循环，有多线程下的 <code>G4MTRunManager</code> 类和其他情况下的 <code>G4RunManager</code> 类两种，通过 <code>G4RunManagerFactory</code> 可以自动识别是否创建多线程类。</p>\n<figure class=\"highlight cpp\"><figcaption><span>exampleB1.cc</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">auto</span>* runManager = G4RunManagerFactory::<span class=\"built_in\">CreateRunManager</span>(G4RunManagerType::Default);</span><br></pre></td></tr></tbody></table></figure>\n<p><code>G4RunManager</code> 还负责进行初始化，即前文所说的强制类与用户行为。为了方便进行初始化，我们从 <code>G4VUserActionInitialization</code> 派生出 <code>ActionInitialization</code> 用于统筹所有的用户自定义行为和粒子生成：</p>\n<figure class=\"highlight cpp\"><figcaption><span>ActionInitialization.hh</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ActionInitialization</span> : <span class=\"keyword\">public</span> G4VUserActionInitialization {</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"built_in\">ActionInitialization</span>();</span><br><span class=\"line\">    ~<span class=\"built_in\">ActionInitialization</span>() <span class=\"keyword\">override</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">BuildForMaster</span><span class=\"params\">()</span> <span class=\"type\">const</span> <span class=\"keyword\">override</span></span>;  <span class=\"comment\">// 多线程的用户行为初始化</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Build</span><span class=\"params\">()</span> <span class=\"type\">const</span> <span class=\"keyword\">override</span></span>;           <span class=\"comment\">// 单线程的用户行为初始化</span></span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ActionInitialization::BuildForMaster</span><span class=\"params\">()</span> <span class=\"type\">const</span> </span>{</span><br><span class=\"line\">    RunAction* runAction = <span class=\"keyword\">new</span> RunAction;</span><br><span class=\"line\">    <span class=\"built_in\">SetUserAction</span>(runAction);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ActionInitialization.cc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ActionInitialization::Build</span><span class=\"params\">()</span> <span class=\"type\">const</span> </span>{</span><br><span class=\"line\">    <span class=\"built_in\">SetUserAction</span>(<span class=\"keyword\">new</span> PrimaryGeneratorAction);</span><br><span class=\"line\">    RunAction* runAction = <span class=\"keyword\">new</span> RunAction;</span><br><span class=\"line\">    <span class=\"built_in\">SetUserAction</span>(runAction);</span><br><span class=\"line\">    EventAction* eventAction = <span class=\"keyword\">new</span> <span class=\"built_in\">EventAction</span>(runAction);</span><br><span class=\"line\">    <span class=\"built_in\">SetUserAction</span>(eventAction);</span><br><span class=\"line\">    <span class=\"built_in\">SetUserAction</span>(<span class=\"keyword\">new</span> <span class=\"built_in\">SteppingAction</span>(eventAction));</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<p>随后我们在 <code>G4RunManager</code> 中设置用户初始化为 <code>ActionInitialization</code>，同时加入其他的强制类：</p>\n<figure class=\"highlight cpp\"><figcaption><span>exampleB1.cc</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">runManager-&gt;<span class=\"built_in\">SetUserInitialization</span>(<span class=\"keyword\">new</span> <span class=\"built_in\">DetectorConstruction</span>());</span><br><span class=\"line\">runManager-&gt;<span class=\"built_in\">SetUserInitialization</span>(<span class=\"keyword\">new</span> QBBC);</span><br><span class=\"line\">runManager-&gt;<span class=\"built_in\">SetUserInitialization</span>(<span class=\"keyword\">new</span> <span class=\"built_in\">ActionInitialization</span>());</span><br></pre></td></tr></tbody></table></figure>\n<h5 id=\"运行模式\">运行模式 <a class=\"header-anchor\" href=\"#运行模式\">¶</a></h5>\n<p><code>Geant4</code> 的运行可以分为 4 种模式：写在代码中的纯硬编码批处理模式、读取文件（<code>macro of commands</code>）的批处理模式、基于命令行的交互模式、基于图形界面的交互模式。一般情况下我们会使用图形界面的交互模式进行 <code>Debug</code> 与展示，通过读取文件的批处理模式进行实际模拟，因此我们也可以在代码中实现两种模式的切换。</p>\n<p>在 <code>main</code> 函数的参数中，会有 <code>argc</code> 提供命令参数的个数，字符串数组 <code>argv</code> 提供具体的命令参数，而默认的第一个参数是可执行文件本身，因此我们可以根据参数的个数，进行模式的判断：</p>\n<figure class=\"highlight cpp\"><figcaption><span>exampleB1.cc</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>** argv)</span> </span>{</span><br><span class=\"line\">    <span class=\"comment\">// argc 为 1 时，说明参数只有可执行文件本身，运行在GUI模式下</span></span><br><span class=\"line\">    <span class=\"comment\">// 如果 argc 不为 1，则运行在 batch mode，例如 example.exe run1.mac</span></span><br><span class=\"line\">    G4UIExecutive* ui = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc == <span class=\"number\">1</span>) {</span><br><span class=\"line\">        ui = <span class=\"keyword\">new</span> <span class=\"built_in\">G4UIExecutive</span>(argc, argv);</span><br><span class=\"line\">    }</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    <span class=\"comment\">// 根据模式，选择开始进行模拟，或打开GUI</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!ui) {</span><br><span class=\"line\">        <span class=\"comment\">// batch mode via reading a macro of commands</span></span><br><span class=\"line\">        G4String command = <span class=\"string\">\"/control/execute \"</span>;</span><br><span class=\"line\">        G4String fileName = argv[<span class=\"number\">1</span>];</span><br><span class=\"line\">        UImanager-&gt;<span class=\"built_in\">ApplyCommand</span>(command + fileName);</span><br><span class=\"line\">    } <span class=\"keyword\">else</span> {</span><br><span class=\"line\">        <span class=\"comment\">// interactive mode via a Graphical User Interface</span></span><br><span class=\"line\">        UImanager-&gt;<span class=\"built_in\">ApplyCommand</span>(<span class=\"string\">\"/control/execute init_vis.mac\"</span>);</span><br><span class=\"line\">        ui-&gt;<span class=\"built_in\">SessionStart</span>();</span><br><span class=\"line\">        <span class=\"keyword\">delete</span> ui;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<h5 id=\"常用命令\">常用命令 <a class=\"header-anchor\" href=\"#常用命令\">¶</a></h5>\n<p>在读取文件的批处理模式下，我们将需要用到的命令保存在<code>.mac</code> 文件中，我们可以通过命令更改初始条件，指定发射粒子的类别、位置、能量等信息，改变几何、角度等。其中最常用的两条命令为：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">/run/initialize     // 初始化</span><br><span class=\"line\">/run/beamOn 1000    // 运行一次模拟，包含1000个粒子</span><br></pre></td></tr></tbody></table></figure>\n<p>此外，比较常用的命令还有：</p>\n<ol>\n<li>粒子枪 </li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">/gun/particle proton   // 设定为光子</span><br><span class=\"line\">/gun/energy 210 MeV    // 能量为 210 MeV</span><br><span class=\"line\">...</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>输出控制<br>\n许多类都有一个 <code>verbose</code> 表示，用于控制输出的详细程度，当 <code>verbose=0</code> 时，不会有任何输出，后面的数字越大输出越详细，最大为 4。</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">/run/verbose 2</span><br><span class=\"line\">/event/verbose 1</span><br><span class=\"line\">/tracking/verbose 0</span><br><span class=\"line\">...</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>网格划分<br>\n推荐观看<a href=\"https://www.bilibili.com/video/BV1G54y1S7U2\">在 Geant4 中关于 Command-based Scoring 基于命令计数器的用法</a></li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">/score/create/boxMesh water_box          // 定义一个网格</span><br><span class=\"line\">/score/mesh/boxSize 319. 315. 277.5 mm   // 设置尺寸</span><br><span class=\"line\">/score/mesh/nBin 1 1 555                 // 分bin的数目</span><br><span class=\"line\"></span><br><span class=\"line\">/score/quantity/energyDeposit eDep       // 想要获取的物理信息：剂量</span><br><span class=\"line\">/score/quantity/doseDeposit Dose         // 想要获取的物理信息：沉积能量</span><br><span class=\"line\"></span><br><span class=\"line\">/score/dumpQuantityToFile water_box eDep eDep_1.txt   // 导出获取的物理信息：剂量</span><br><span class=\"line\">/score/dumpQuantityToFile water_box Dose Dose_1.txt   // 导出获取的物理信息：沉积能量</span><br></pre></td></tr></tbody></table></figure>\n<p>更多的命令或者命令的说明，可以在 GUI 模式下的左侧帮助手册中查询，也可以查看推荐阅读材料中的 <code>Geant4 Commands</code> 进行在线查询。</p>\n<h3 id=\"水箱模型\">水箱模型 <a class=\"header-anchor\" href=\"#水箱模型\">¶</a></h3>\n<p>放疗水箱常用于放疗装置的剂量校准，其尺寸为（x=638mm，y=630mm，z=555mm）。现假设一笔形束从 x-y 平面中心处，自水箱外向下射入放疗水箱。请用 <code>Geant4</code> 模拟计算不同能量的光子（1MeV、5MeV、10MeV）入射后在放疗水箱的 z 方向上的吸收剂量变化曲线。</p>\n<p>这是一个非常简单的示例，首先定义几何体：</p>\n<figure class=\"highlight cpp\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">G4NistManager* nist = G4NistManager::<span class=\"built_in\">Instance</span>();</span><br><span class=\"line\">G4Box* solid_world = <span class=\"keyword\">new</span> <span class=\"built_in\">G4Box</span>(<span class=\"string\">\"world\"</span>, <span class=\"number\">638</span> / <span class=\"number\">2</span> * mm, <span class=\"number\">630</span> / <span class=\"number\">2</span> * mm, <span class=\"number\">555.</span> / <span class=\"number\">2</span> * mm);</span><br><span class=\"line\">G4LogicalVolume* logic_world = <span class=\"keyword\">new</span> <span class=\"built_in\">G4LogicalVolume</span>(solid_world, nist-&gt;<span class=\"built_in\">FindOrBuildMaterial</span>(<span class=\"string\">\"G4_WATER\"</span>), <span class=\"string\">\"world\"</span>);</span><br><span class=\"line\">G4VPhysicalVolume* physics_world = <span class=\"keyword\">new</span> <span class=\"built_in\">G4PVPlacement</span>(<span class=\"number\">0</span>, <span class=\"built_in\">G4ThreeVector</span>(), logic_world, <span class=\"string\">\"world\"</span>, <span class=\"number\">0</span>, <span class=\"literal\">false</span>, <span class=\"number\">0</span>, <span class=\"literal\">true</span>);</span><br></pre></td></tr></tbody></table></figure>\n<p>随后在<code>.mac</code> 中进行网格划分与模拟：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">/score/create/boxMesh water_box</span><br><span class=\"line\">/score/mesh/boxSize 319. 315. 277.5 mm</span><br><span class=\"line\">/score/mesh/nBin 1 1 555</span><br><span class=\"line\">/score/quantity/energyDeposit eDep</span><br><span class=\"line\">/score/quantity/doseDeposit Dose</span><br><span class=\"line\">/score/close</span><br><span class=\"line\"></span><br><span class=\"line\">/gun/particle gamma</span><br><span class=\"line\">/gun/energy 1 MeV</span><br><span class=\"line\">/run/beamOn 100000</span><br><span class=\"line\">/score/dumpQuantityToFile water_box eDep eDep_1.txt</span><br><span class=\"line\">/score/dumpQuantityToFile water_box Dose Dose_1.txt</span><br><span class=\"line\"></span><br><span class=\"line\">/gun/energy 5 MeV</span><br><span class=\"line\">/run/beamOn 100000</span><br><span class=\"line\">/score/dumpQuantityToFile water_box eDep eDep_5.txt</span><br><span class=\"line\">/score/dumpQuantityToFile water_box Dose Dose_5.txt</span><br><span class=\"line\"></span><br><span class=\"line\">/gun/particle gamma</span><br><span class=\"line\">/gun/energy 10 MeV</span><br><span class=\"line\">/run/beamOn 100000</span><br><span class=\"line\">/score/dumpQuantityToFile water_box eDep eDep_10.txt</span><br><span class=\"line\">/score/dumpQuantityToFile water_box Dose Dose_10.txt</span><br></pre></td></tr></tbody></table></figure>\n<p>其余部分参考 <code>B1</code> 示例。</p>\n<h2 id=\"附录\">附录 <a class=\"header-anchor\" href=\"#附录\">¶</a></h2>\n<h3 id=\"示例源码\">示例源码 <a class=\"header-anchor\" href=\"#示例源码\">¶</a></h3>\n<ol>\n<li><a href=\"https://git.foolishfox.cn/fox/G4-ExampleB1\">exampleB1 带注释代码</a></li>\n<li><a href=\"https://git.foolishfox.cn/fox/G4-ExampleB0\">水箱模型</a></li>\n</ol>\n<h3 id=\"CMakeLists\">CMakeLists<a class=\"header-anchor\" href=\"#CMakeLists\">¶</a></h3>\n<p>很多人在尝试编译示例时，会有以下错误：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">CMake Error at CMakeLists.txt:16 (find_package):</span><br><span class=\"line\">By not providing \"FindGeant4.cmake\" in CMAKE_MODULE_PATH this project has</span><br><span class=\"line\">asked CMake to find a package configuration file provided by \"Geant4\", but</span><br><span class=\"line\">CMake did not find one.</span><br><span class=\"line\"></span><br><span class=\"line\">Could not find a package configuration file provided by \"Geant4\" with any</span><br><span class=\"line\">of the following names:</span><br><span class=\"line\"></span><br><span class=\"line\">Geant4Config.cmake</span><br><span class=\"line\">geant4-config.cmake</span><br><span class=\"line\"></span><br><span class=\"line\">Add the installation prefix of \"Geant4\" to CMAKE_PREFIX_PATH or set</span><br><span class=\"line\">\"Geant4_DIR\" to a directory containing one of the above files.  If \"Geant4\"</span><br><span class=\"line\">provides a separate development package or SDK, be sure it has been</span><br><span class=\"line\">installed.</span><br></pre></td></tr></tbody></table></figure>\n<p>可以在 <code>CMakeLists.txt</code> 文件中添加一行即可解决：</p>\n<figure class=\"highlight cmake\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">cmake_minimum_required</span>(VERSION <span class=\"number\">3.16</span>)</span><br><span class=\"line\"><span class=\"keyword\">set</span>(Geant4_DIR D:/Geant4/dist/lib/Geant4-<span class=\"number\">11.0</span>.<span class=\"number\">1</span>)</span><br><span class=\"line\"><span class=\"keyword\">project</span>(exampleB0)</span><br><span class=\"line\">...</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://geant4-userdoc.web.cern.ch/UsersGuides/InstallationGuide/html/index.html\">Installation Guide</a></li>\n<li><a href=\"https://www.bilibili.com/video/BV1yz4y1k7gP\">Geant4 入门教程</a></li>\n<li><a href=\"https://blog.csdn.net/sinat_33249803/article/details/116067709\">Geant4 学习 —— 入门 (基本概念、Geant4 工具包的结构、强制类、可选类)</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/64271648\">Geant4–是怎样使用的？–（1. 信息抽取）</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/60615096\">Geant4 入门讲解篇 - 1</a></li>\n</ol>\n<h2 id=\"推荐阅读\">推荐阅读 <a class=\"header-anchor\" href=\"#推荐阅读\">¶</a></h2>\n<ol>\n<li><a href=\"https://geant4-userdoc.web.cern.ch/UsersGuides/ForApplicationDeveloper/html/index.html\">Book For Application Developers</a></li>\n<li><a href=\"https://geant4-userdoc.web.cern.ch/UsersGuides/PhysicsReferenceManual/html/index.html\">Physics Reference Manual</a></li>\n<li><a href=\"https://geant4-userdoc.web.cern.ch/UsersGuides/PhysicsListGuide/html/index.html\">Guide for Physics Lists</a></li>\n<li><a href=\"https://www.hep.ph.ic.ac.uk/~yoshiu/COMET/comet_g4HTMLdoc/\">Geant4 Commands</a></li>\n<li><a href=\"https://space.bilibili.com/30515356\">liuchangqi</a></li>\n<li><a href=\"https://www.bilibili.com/video/BV1G54y1S7U2\">在 Geant4 中关于 Command-based Scoring 基于命令计数器的用法</a></li>\n</ol>\n","categories":["软件/程序","Geant4"],"tags":["教程","核技术","Geant4"]},{"title":"博客成长日志 | 自建 Umami 统计","url":"/posts/202209-umami.html","content":"<p>在一年多之前，我写了一篇博客（<a href=\"/posts/202105-visit.html\">博客成长日志 | 准实时访问统计</a>）介绍如何使用百度统计的 API 实现准实时的访问统计与展示。然而今年百度统计宣布个人版只允许保存一年的数据，而且很多功能会被关闭（例如 OS 统计等），再加上其 API 使用也不方便，因此我开始谋求其他的站点统计系统。</p>\n<p>与百度统计同类型的竞品还有谷歌统计、51La、CNZZ 等，但是这些网站与百度统计也或多或少存在类似类似的问题，同时作为个人小站，也不需要收集过于精细的用户信息（如年龄、详细地区等），所以我开始寻找自建的统计工具。</p>\n<span id=\"more\"></span>\n<p>目前常用的一些开源统计工具可以查看：<a href=\"https://www.imydl.com/wzjs/15065.html\">5 款免费开源的网站流量分析统计工具</a>，在这其中 <code>Umami</code> 和 <code>Plausible</code> 是我认为不错的选择，再结合枋柚梓的<a href=\"https://inkss.cn/post/f7886cf2/\">自建个人网站数据统计分析系统</a>，最终决定采用 <code>Umami</code>。</p>\n<div class=\"note warning flat\"><p><code>Umami</code> 也存在问题：</p>\n<ol>\n<li>只记录了 country，无法精确到省份</li>\n<li>地图存在问题，如果使用要避免直接展示地图</li>\n</ol>\n</div>\n<h2 id=\"介绍\">介绍 <a class=\"header-anchor\" href=\"#介绍\">¶</a></h2>\n<div class=\"note quote flat\"><p>Umami is an open source, privacy-focused alternative to Google Analytics. Umami provides you with a powerful web analytics solution that does not violate the privacy of your users. Additionally, when you self-host Umami you are in complete control of your data.</p>\n</div>\n<p><code>Umami</code> 是一个开源的，关注隐私的谷歌统计替代品，由 <code>Nodejs</code> 编写，我们可以使用多种方式部署，包括 <code>Server</code> 自部署、<code>Docker</code> 部署以及 <code>SeverLess</code> 服务部署。</p>\n<p>在本文中，我们会在服务器上直接部署服务，使用 <code>MySQL</code> 作为数据库。</p>\n<h2 id=\"安装\">安装 <a class=\"header-anchor\" href=\"#安装\">¶</a></h2>\n<div class=\"note info flat\"><p>环境要求：</p>\n<ul>\n<li>Nodejs</li>\n<li>yarn</li>\n</ul>\n</div>\n<ol>\n<li> 源代码 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/umami-software/umami.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> umami</span><br><span class=\"line\">yarn install</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>环境变量<br>\n在目录下创建<code>.env</code> 文件，写入内容：</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">PORT=8000</span><br><span class=\"line\">DATABASE_URL=mysql://username:mypassword@localhost:3306/mydb</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>构建与运行 </li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">yarn build</span><br><span class=\"line\">yarn start-dev</span><br></pre></td></tr></tbody></table></figure>\n<p>随后即可在 <code>localhost:8000</code> 上打开网页，初始默认用户名为 <code>admin</code>，密码为 <code>umami</code>。</p>\n<h2 id=\"统计展示\">统计展示 <a class=\"header-anchor\" href=\"#统计展示\">¶</a></h2>\n<h3 id=\"API\">API<a class=\"header-anchor\" href=\"#API\">¶</a></h3>\n<p><code>Umami</code> 将通过 <code>https://&lt;your-umami&gt;/api</code> 调用 API，并返回 json 格式的数据。在构建过程中，我们需要使用到以下三个 API：</p>\n<ol>\n<li><code>POST /api/auth/login</code><br>\n通过这个 API 我们可以获取 TOKEN，作为后续 API 的认证，使用 Python 获取：</li>\n</ol>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">import</span> request</span><br><span class=\"line\">url = <span class=\"string\">\"https://&lt;your-umami&gt;/api/auth/login\"</span></span><br><span class=\"line\">data = {</span><br><span class=\"line\">    <span class=\"string\">\"username\"</span>: <span class=\"string\">\"your-username\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"password\"</span>: <span class=\"string\">\"your-password\"</span></span><br><span class=\"line\">}</span><br><span class=\"line\">res = requests.post(url, data=data)</span><br><span class=\"line\">res = json.loads(res.content)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(res)</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>\n<p><code>GET /api/website/{id}/pageviews</code><br>\n通过这个 API，我们可以获取选定时段的访问量和访问人数等信息，时间颗粒度可以选择为月、天、小时等。</p>\n</li>\n<li>\n<p><code>GET /api/website/{id}/metrics</code><br>\n通过这个 API，我们可以进一步获取国家 / 地区、来源等信息。</p>\n</li>\n</ol>\n<p>但是由于以下个原因，我们尽量避免直接使用 API：</p>\n<ol>\n<li>保密 token：使用 API 需要将 token 作为请求 header，容易暴露</li>\n<li>地图需要转换：Umami 中国家 / 地区使用二字代码存储，而 Echarts 需要用到其他格式，需要一步转换</li>\n<li>地图问题：涉及香港、澳门、台湾等地</li>\n</ol>\n<p>因此最终我们可以自建一个 API，使用 python 的 <code>FastAPI</code> 库，代码如下：</p>\n<details class=\"toggle\"><summary class=\"toggle-button\" style=\"color: green\">main.py</summary><div class=\"toggle-content\"><figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">from</span> fastapi <span class=\"keyword\">import</span> FastAPI</span><br><span class=\"line\"><span class=\"keyword\">from</span> fastapi.middleware.cors <span class=\"keyword\">import</span> CORSMiddleware</span><br><span class=\"line\"></span><br><span class=\"line\">app = FastAPI()</span><br><span class=\"line\">origins = [</span><br><span class=\"line\">    <span class=\"string\">\"http://localhost\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"example.com\"</span></span><br><span class=\"line\">]</span><br><span class=\"line\">app.add_middleware(</span><br><span class=\"line\">    CORSMiddleware,</span><br><span class=\"line\">    allow_origins=origins,</span><br><span class=\"line\">    allow_credentials=<span class=\"literal\">True</span>,</span><br><span class=\"line\">    allow_methods=[<span class=\"string\">\"GET\"</span>],</span><br><span class=\"line\">    allow_headers=[<span class=\"string\">\"*\"</span>],</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">root_path = <span class=\"string\">\"https://&lt;your-umami&gt;/api/website/1\"</span></span><br><span class=\"line\">header = {</span><br><span class=\"line\">    <span class=\"string\">\"accept\"</span>: <span class=\"string\">\"application/json\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"authorization\"</span>: <span class=\"string\">\"Bearer YOUR TOKEN\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"content-type\"</span>: <span class=\"string\">\"application/json\"</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\">namemap = json.load(<span class=\"built_in\">open</span>(<span class=\"string\">\"world.json\"</span>, <span class=\"string\">\"r\"</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.get(<span class=\"params\"><span class=\"string\">\"/day_view\"</span></span>)</span></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">root</span>(<span class=\"params\">start_at, end_at</span>):</span><br><span class=\"line\">    url = root_path + <span class=\"string\">\"/pageviews?start_at={:d}&amp;end_at={:d}&amp;unit=day&amp;tz=Asia/Shanghai\"</span>.<span class=\"built_in\">format</span>(</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(start_at),</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(end_at)</span><br><span class=\"line\">    )</span><br><span class=\"line\">    res = requests.get(url, headers=header)</span><br><span class=\"line\">    res = json.loads(res.content)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.get(<span class=\"params\"><span class=\"string\">\"/month_view\"</span></span>)</span></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">root</span>(<span class=\"params\">start_at, end_at</span>):</span><br><span class=\"line\">    url = root_path + <span class=\"string\">\"/pageviews?start_at={:d}&amp;end_at={:d}&amp;unit=month&amp;tz=Asia/Shanghai\"</span>.<span class=\"built_in\">format</span>(</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(start_at),</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(end_at)</span><br><span class=\"line\">    )</span><br><span class=\"line\">    res = requests.get(url, headers=header)</span><br><span class=\"line\">    res = json.loads(res.content)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.get(<span class=\"params\"><span class=\"string\">\"/referrer\"</span></span>)</span></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">root</span>(<span class=\"params\">start_at, end_at</span>):</span><br><span class=\"line\">    url = root_path + <span class=\"string\">\"/metrics?start_at={:d}&amp;end_at={:d}&amp;type=referrer\"</span>.<span class=\"built_in\">format</span>(</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(start_at),</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(end_at)</span><br><span class=\"line\">    )</span><br><span class=\"line\">    res = requests.get(url, headers=header)</span><br><span class=\"line\">    res = json.loads(res.content)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.get(<span class=\"params\"><span class=\"string\">\"/country\"</span></span>)</span></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">root</span>(<span class=\"params\">start_at, end_at</span>):</span><br><span class=\"line\">    url = root_path + <span class=\"string\">\"/metrics?start_at={:d}&amp;end_at={:d}&amp;type=country\"</span>.<span class=\"built_in\">format</span>(</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(start_at),</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(end_at)</span><br><span class=\"line\">    )</span><br><span class=\"line\">    res = requests.get(url, headers=header)</span><br><span class=\"line\">    res = json.loads(res.content)</span><br><span class=\"line\">    ans = []</span><br><span class=\"line\">    <span class=\"keyword\">for</span> item <span class=\"keyword\">in</span> res:</span><br><span class=\"line\">        name = namemap[item[<span class=\"string\">\"x\"</span>]]</span><br><span class=\"line\">        ans.append({</span><br><span class=\"line\">            <span class=\"string\">\"x\"</span>: name,</span><br><span class=\"line\">            <span class=\"string\">\"y\"</span>: item[<span class=\"string\">\"y\"</span>]</span><br><span class=\"line\">        })</span><br><span class=\"line\">    china = <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> k <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"built_in\">len</span>(ans)):</span><br><span class=\"line\">        item = ans[k]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> item[<span class=\"string\">\"x\"</span>] <span class=\"keyword\">in</span> [<span class=\"string\">\"Hong Kong\"</span>, <span class=\"string\">\"Taiwan\"</span>, <span class=\"string\">\"Macau\"</span>]:</span><br><span class=\"line\">            china += item[<span class=\"string\">\"y\"</span>]</span><br><span class=\"line\">            <span class=\"keyword\">del</span> ans[k]</span><br><span class=\"line\">    <span class=\"keyword\">for</span> item <span class=\"keyword\">in</span> ans:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> item[<span class=\"string\">\"x\"</span>] == <span class=\"string\">\"China\"</span>:</span><br><span class=\"line\">            item[<span class=\"string\">\"y\"</span>] += china</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ans</span><br></pre></td></tr></tbody></table></figure></div></details>\n<p>其中 <code>world.json</code> 是一个用于国家 / 地区转换的文件，内容如下：</p>\n<details class=\"toggle\"><summary class=\"toggle-button\" style=\"color: blue\">world.json</summary><div class=\"toggle-content\"><figure class=\"highlight json\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">{</span></span><br><span class=\"line\">    <span class=\"attr\">\"ES\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Spain\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"DE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Germany\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"IE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Ireland\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"IT\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Italy\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"AT\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Austria\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"FR\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"France\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Belgium\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"FI\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Finland\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"DK\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Denmark\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CZ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Czech Republic\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"EE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Estonia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"HU\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Hungaryngary\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"JE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Jersey\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"LU\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Luxembourg\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"LV\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Latvia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MT\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Malta\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"NL\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Netherlands\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"PT\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Portugal\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"RO\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Romania\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SI\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Slovenia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SK\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Slovakia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"AE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"United Arab Emirates\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"AF\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Afghanistan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"AL\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Albania\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"AM\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Armenia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"AO\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Angola\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"AR\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Argentina\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"AU\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Australia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"AZ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Azerbaijan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BD\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Bangladesh\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BF\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Burkina Faso\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BG\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Bulgaria\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BH\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Bahrein\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BI\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Burundi\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BJ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Benin\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BN\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Brunei Darussalam\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BO\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Bolivia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BR\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Brazil\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BW\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Botswana\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"BY\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Byelorussia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CA\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Canada\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CF\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Central Africa\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CG\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Congo\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CH\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Switzerland\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CL\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Chile\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CM\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Cameroon\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CN\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"China\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CO\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Colombia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CR\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Costa Rica\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CS\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Czech Repubic\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CU\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Cuba\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"CY\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Cyprus\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"DO\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Dominican Republic\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"DZ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Algeria\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"EC\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Ecuador\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"EG\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Egypt\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"ET\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Ethiopia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"FJ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Fiji\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"GA\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Gabon\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"GB\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"United Kingdom\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"GD\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Grenada\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"GE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Georgia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"GH\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Ghana\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"GN\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Guinea\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"GR\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Greece\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"GT\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Guatemala\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"HK\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Hong Kong\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"HN\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Honduras\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"ID\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Indonesia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"IL\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Israel\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"IN\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"India\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"IQ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Iraq\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"IR\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Iran\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"IS\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Iceland\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"JM\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Jamaica\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"JO\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Jordan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"JP\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Japan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"KG\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Kyrgyzstan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"KH\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Cambodia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"KP\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Dem. Rep. Korea\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"KR\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Korea\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"KT\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Ivory Coast\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"KW\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Kuwati\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"KZ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Kazakhstan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"LA\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Laos\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"LB\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Lebanon\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"LC\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Saint Lueia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"LI\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Liechtenstein\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"LK\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Sri Lanka\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"LR\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Liberia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"LT\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Lithuania\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"LY\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Libyan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MA\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Morocco\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MC\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Monaco\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MD\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Moldova\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MG\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Madagascar\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"ML\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Mali\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MM\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Myanmar\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MN\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Mongolia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MO\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Macau\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MU\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Mauritius\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MW\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Malawi\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MX\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Mexico\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MY\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Malaysia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"MZ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Mozambique\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"NA\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Namibia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"NE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Niger\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"NG\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Nigeria\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"NI\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Nicaragua\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"NO\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Norway\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"NP\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Nepal\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"NZ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"New Zealand\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"OM\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Oman\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"PA\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Panama\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"PE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Peru\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"PG\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Papua New Guinea\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"PH\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Philippines\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"PK\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Pakistan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"PL\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Poland\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"PY\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Paraguay\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"QA\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Qatar\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"RU\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Russian Federation\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SA\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Saudi Arabia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SC\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Republic of Seychelles\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SD\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Sudan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Sweden\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SG\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Singapore\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SM\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"San Marino\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SN\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Senegal\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SO\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Somalia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SY\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Syria\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"SZ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Swaziland\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"TD\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Chad\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"TG\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Togo\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"TH\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Thailand\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"TJ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Tajikistan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"TM\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Turkmenistan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"TN\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Tunisia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"TR\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Turkey\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"TW\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Taiwan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"TZ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Tanzania\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"UA\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Ukraine\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"UG\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Uganda\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"US\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"United States\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"UY\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Uruguay\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"UZ\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Uzbekistan\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"VC\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Saint Vincent\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"VE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Venezuela\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"VN\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Viet Nam\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"YE\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Yemen\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"YU\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Yugoslavia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"ZA\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"South Africa\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"ZM\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Zambia\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"ZR\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Zaire\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"ZW\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Zimbabwe\"</span></span><br><span class=\"line\"><span class=\"punctuation\">}</span></span><br></pre></td></tr></tbody></table></figure></div></details>\n<h3 id=\"数据显示\">数据显示 <a class=\"header-anchor\" href=\"#数据显示\">¶</a></h3>\n<p>构建完 API 后，我们开始改写之前的 <code>census.js</code>，内容如下：</p>\n<details class=\"toggle\"><summary class=\"toggle-button\" style=\"color: red\">census.js</summary><div class=\"toggle-content\"><figure class=\"highlight javascript\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 访问日历</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">generatePieces</span>(<span class=\"params\">maxValue, colorBox</span>) {</span><br><span class=\"line\">    <span class=\"keyword\">var</span> pieces = [];</span><br><span class=\"line\">    <span class=\"keyword\">var</span> quotient = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> temp = {<span class=\"string\">'lt'</span>: <span class=\"number\">1</span>, <span class=\"string\">'label'</span>: <span class=\"string\">'0'</span>, <span class=\"string\">'color'</span>: colorBox[<span class=\"number\">0</span>]};</span><br><span class=\"line\">    pieces.<span class=\"title function_\">push</span>(temp);</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (maxValue &amp;&amp; maxValue &gt;= <span class=\"number\">10</span>) {</span><br><span class=\"line\">        quotient = <span class=\"title class_\">Math</span>.<span class=\"title function_\">floor</span>(maxValue / <span class=\"number\">10</span>)+<span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">1</span>; i &lt;= <span class=\"number\">10</span>; i++) {</span><br><span class=\"line\">            <span class=\"keyword\">var</span> temp = {};</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i == <span class=\"number\">1</span>)   temp.<span class=\"property\">gte</span> = <span class=\"number\">1</span>;</span><br><span class=\"line\">            <span class=\"keyword\">else</span>   temp.<span class=\"property\">gte</span> = quotient * (i - <span class=\"number\">1</span>);</span><br><span class=\"line\">            temp.<span class=\"property\">lte</span> = quotient * i;</span><br><span class=\"line\">            temp.<span class=\"property\">color</span> = colorBox[i];</span><br><span class=\"line\">            pieces.<span class=\"title function_\">push</span>(temp);</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(pieces);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">append_div_visitcalendar</span>(<span class=\"params\">parent, text</span>) {</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (parent !== <span class=\"literal\">null</span>) {</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> text === <span class=\"string\">'string'</span>) {</span><br><span class=\"line\">            <span class=\"keyword\">var</span> temp = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">'div'</span>);</span><br><span class=\"line\">            temp.<span class=\"property\">innerHTML</span> = text;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> frag = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createDocumentFragment</span>();</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (temp.<span class=\"property\">firstChild</span>) {</span><br><span class=\"line\">                frag.<span class=\"title function_\">appendChild</span>(temp.<span class=\"property\">firstChild</span>);</span><br><span class=\"line\">            }</span><br><span class=\"line\">            parent.<span class=\"title function_\">appendChild</span>(frag);</span><br><span class=\"line\">        } <span class=\"keyword\">else</span> {</span><br><span class=\"line\">            parent.<span class=\"title function_\">appendChild</span>(text);</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">};</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">compareFunction</span>(<span class=\"params\">propertyName</span>){</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">function</span> (<span class=\"params\">o1, o2</span>) {</span><br><span class=\"line\">        <span class=\"comment\">//获取比较的值</span></span><br><span class=\"line\">        <span class=\"keyword\">var</span> v1 = o1[propertyName];</span><br><span class=\"line\">        <span class=\"keyword\">var</span> v2 = o2[propertyName];</span><br><span class=\"line\">        <span class=\"keyword\">return</span> v1 &gt; v2 ? <span class=\"number\">1</span> : (v1 == v2 ? <span class=\"number\">0</span> : -<span class=\"number\">1</span>);</span><br><span class=\"line\">    };</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">filterTime</span>(<span class=\"params\">time</span>) {</span><br><span class=\"line\">    <span class=\"keyword\">const</span> date = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(time)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> Y = date.<span class=\"title function_\">getFullYear</span>()</span><br><span class=\"line\">    <span class=\"keyword\">const</span> M = date.<span class=\"title function_\">getMonth</span>() + <span class=\"number\">1</span> &lt; <span class=\"number\">10</span> ? <span class=\"string\">'0'</span> + (date.<span class=\"title function_\">getMonth</span>() + <span class=\"number\">1</span>) : date.<span class=\"title function_\">getMonth</span>() + <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> D = date.<span class=\"title function_\">getDate</span>() &lt; <span class=\"number\">10</span> ? <span class=\"string\">'0'</span> + (date.<span class=\"title function_\">getDate</span>()) : date.<span class=\"title function_\">getDate</span>()</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">`<span class=\"subst\">${Y}</span>-<span class=\"subst\">${M}</span>-<span class=\"subst\">${D}</span>`</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">calChart</span>(<span class=\"params\"></span>) {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"script\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">let</span> now = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">    date.<span class=\"title function_\">setFullYear</span>(now.<span class=\"title function_\">getFullYear</span>() - <span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> start_at = date.<span class=\"title function_\">getTime</span>() - <span class=\"number\">3600</span> * <span class=\"number\">24</span> * ((date.<span class=\"title function_\">getDay</span>() + <span class=\"number\">1</span>) % <span class=\"number\">7</span>);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> end_at = now.<span class=\"title function_\">getTime</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// API根据自己的实际更改</span></span><br><span class=\"line\">    <span class=\"title function_\">fetch</span>(<span class=\"string\">'https://api.foolishfox.cn/umami/day_view?start_at='</span> + start_at + <span class=\"string\">'&amp;end_at='</span> + end_at).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> data.<span class=\"title function_\">json</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> {</span><br><span class=\"line\">        data = data.<span class=\"property\">pageviews</span>;</span><br><span class=\"line\">        data.<span class=\"title function_\">sort</span>(<span class=\"title function_\">compareFunction</span>(<span class=\"string\">\"t\"</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">let</span> calArr = [];</span><br><span class=\"line\">        <span class=\"keyword\">let</span> maxValue = <span class=\"number\">0</span>, total = <span class=\"number\">0</span>, weekdatacore = <span class=\"number\">0</span>, thisweekdatacore = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> colorBox = [<span class=\"string\">'#EBEDF0'</span>, <span class=\"string\">'#FFE9BB'</span>, <span class=\"string\">'#FFD1A7'</span>, <span class=\"string\">'#FFBB95'</span>, <span class=\"string\">'#FFA383'</span>, <span class=\"string\">'#FF8D70'</span>, <span class=\"string\">'#FF745C'</span>, <span class=\"string\">'#FF5C4A'</span>, <span class=\"string\">'#FF4638'</span>, <span class=\"string\">'#FF2E26'</span>, <span class=\"string\">'#FF1812'</span>];</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; data.<span class=\"property\">length</span>; i++) {</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i &gt; <span class=\"number\">0</span>) {</span><br><span class=\"line\">                <span class=\"keyword\">let</span> pre = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(data[i - <span class=\"number\">1</span>].<span class=\"property\">t</span>.<span class=\"title function_\">replace</span>(<span class=\"regexp\">/-/g</span>, <span class=\"string\">\"/\"</span>));</span><br><span class=\"line\">                <span class=\"keyword\">let</span> tmp = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(data[i].<span class=\"property\">t</span>.<span class=\"title function_\">replace</span>(<span class=\"regexp\">/-/g</span>, <span class=\"string\">\"/\"</span>));</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (tmp.<span class=\"title function_\">getTime</span>() - pre.<span class=\"title function_\">getTime</span>() != <span class=\"number\">86400</span> * <span class=\"number\">1000</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> k = <span class=\"number\">1</span>; k &lt; (tmp.<span class=\"title function_\">getTime</span>() - pre.<span class=\"title function_\">getTime</span>()) / (<span class=\"number\">86400</span> * <span class=\"number\">1000</span>); k++) {</span><br><span class=\"line\">                        tmp = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(pre.<span class=\"title function_\">getTime</span>() + <span class=\"number\">86400</span> * <span class=\"number\">1000</span> * k);</span><br><span class=\"line\">                        calArr.<span class=\"title function_\">push</span>([<span class=\"title function_\">filterTime</span>(tmp), <span class=\"number\">0</span>]);</span><br><span class=\"line\">                    }</span><br><span class=\"line\">            }</span><br><span class=\"line\"></span><br><span class=\"line\">            calArr.<span class=\"title function_\">push</span>([data[i].<span class=\"property\">t</span>, data[i].<span class=\"property\">y</span>]);</span><br><span class=\"line\">            maxValue = data[i].<span class=\"property\">y</span> &gt; maxValue ? data[i].<span class=\"property\">y</span> : maxValue;</span><br><span class=\"line\">            total += data[i].<span class=\"property\">y</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (calArr[calArr.<span class=\"property\">length</span> - <span class=\"number\">1</span>][<span class=\"number\">0</span>] != <span class=\"title function_\">filterTime</span>(now))   calArr.<span class=\"title function_\">push</span>([<span class=\"title function_\">filterTime</span>(now), <span class=\"number\">0</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = calArr.<span class=\"property\">length</span> - <span class=\"number\">1</span>; i &gt;= calArr.<span class=\"property\">length</span> - <span class=\"number\">7</span>; i--)   weekdatacore += calArr[i][<span class=\"number\">1</span>];</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = calArr.<span class=\"property\">length</span> - <span class=\"number\">1</span>; i &gt;= calArr.<span class=\"property\">length</span> - <span class=\"number\">30</span>; i--)   thisweekdatacore += calArr[i][<span class=\"number\">1</span>];</span><br><span class=\"line\">        <span class=\"keyword\">let</span> calArrJson = <span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(calArr);</span><br><span class=\"line\">        script.<span class=\"property\">innerHTML</span> = <span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">        var calChart = echarts.init(document.getElementById(\"calendar_container\"));</span></span><br><span class=\"line\"><span class=\"string\">        var option = {</span></span><br><span class=\"line\"><span class=\"string\">            title: { text: '访问日历', x: 'center' },</span></span><br><span class=\"line\"><span class=\"string\">            tooltip: {</span></span><br><span class=\"line\"><span class=\"string\">                padding: 10,</span></span><br><span class=\"line\"><span class=\"string\">                backgroundColor: '#555',</span></span><br><span class=\"line\"><span class=\"string\">                borderColor: '#777',</span></span><br><span class=\"line\"><span class=\"string\">                borderWidth: 1,</span></span><br><span class=\"line\"><span class=\"string\">                textStyle: { color: '#fff' },</span></span><br><span class=\"line\"><span class=\"string\">                formatter: function (obj) {</span></span><br><span class=\"line\"><span class=\"string\">                    var value = obj.value;</span></span><br><span class=\"line\"><span class=\"string\">                    return '&lt;div style=\"font-size: 14px;\"&gt;' + value[0] + ': ' + value[1] + '&lt;/div&gt;';</span></span><br><span class=\"line\"><span class=\"string\">                }</span></span><br><span class=\"line\"><span class=\"string\">            },</span></span><br><span class=\"line\"><span class=\"string\">            visualMap: {</span></span><br><span class=\"line\"><span class=\"string\">                show: false,</span></span><br><span class=\"line\"><span class=\"string\">                showLabel: true,</span></span><br><span class=\"line\"><span class=\"string\">                min: 0,</span></span><br><span class=\"line\"><span class=\"string\">                max: <span class=\"subst\">${maxValue}</span>,</span></span><br><span class=\"line\"><span class=\"string\">                type: 'piecewise',</span></span><br><span class=\"line\"><span class=\"string\">                orient: 'horizontal',</span></span><br><span class=\"line\"><span class=\"string\">                left: 'center',</span></span><br><span class=\"line\"><span class=\"string\">                bottom: 0,</span></span><br><span class=\"line\"><span class=\"string\">                pieces: <span class=\"subst\">${generatePieces(maxValue, colorBox)}</span></span></span><br><span class=\"line\"><span class=\"string\">            },</span></span><br><span class=\"line\"><span class=\"string\">            calendar: [{</span></span><br><span class=\"line\"><span class=\"string\">                left: 'center',</span></span><br><span class=\"line\"><span class=\"string\">                range: ['<span class=\"subst\">${calArr[<span class=\"number\">0</span>][<span class=\"number\">0</span>]}</span>', '<span class=\"subst\">${calArr[calArr.length - <span class=\"number\">1</span>][<span class=\"number\">0</span>]}</span>'],</span></span><br><span class=\"line\"><span class=\"string\">                cellSize: [14, 14],</span></span><br><span class=\"line\"><span class=\"string\">                splitLine: {</span></span><br><span class=\"line\"><span class=\"string\">                    show: false</span></span><br><span class=\"line\"><span class=\"string\">                },</span></span><br><span class=\"line\"><span class=\"string\">                itemStyle: {</span></span><br><span class=\"line\"><span class=\"string\">                    color: '#ebedf0',</span></span><br><span class=\"line\"><span class=\"string\">                    borderColor: '#fff',</span></span><br><span class=\"line\"><span class=\"string\">                    borderWidth: 2</span></span><br><span class=\"line\"><span class=\"string\">                },</span></span><br><span class=\"line\"><span class=\"string\">                yearLabel: {</span></span><br><span class=\"line\"><span class=\"string\">                    show: false</span></span><br><span class=\"line\"><span class=\"string\">                },</span></span><br><span class=\"line\"><span class=\"string\">                monthLabel: {</span></span><br><span class=\"line\"><span class=\"string\">                    nameMap: 'cn',</span></span><br><span class=\"line\"><span class=\"string\">                    fontSize: 11</span></span><br><span class=\"line\"><span class=\"string\">                },</span></span><br><span class=\"line\"><span class=\"string\">                dayLabel: {</span></span><br><span class=\"line\"><span class=\"string\">                    formatter: '{start}  1st',</span></span><br><span class=\"line\"><span class=\"string\">                    nameMap: 'cn',</span></span><br><span class=\"line\"><span class=\"string\">                    fontSize: 11</span></span><br><span class=\"line\"><span class=\"string\">                }</span></span><br><span class=\"line\"><span class=\"string\">            }],</span></span><br><span class=\"line\"><span class=\"string\">            series: [{</span></span><br><span class=\"line\"><span class=\"string\">                type: 'heatmap',</span></span><br><span class=\"line\"><span class=\"string\">                coordinateSystem: 'calendar',</span></span><br><span class=\"line\"><span class=\"string\">                calendarIndex: 0,</span></span><br><span class=\"line\"><span class=\"string\">                data: <span class=\"subst\">${calArrJson}</span>,</span></span><br><span class=\"line\"><span class=\"string\">            }]</span></span><br><span class=\"line\"><span class=\"string\">        };</span></span><br><span class=\"line\"><span class=\"string\">        calChart.setOption(option);`</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> style = <span class=\"string\">'&lt;style&gt;.number{margin-top: 10px;text-align:center;width:100%;padding:10px;margin:0 auto;}.contrib-column{text-align:center;border-left:1px solid #ddd;border-top:1px solid #ddd;}.contrib-column-first{border-left:0;}.table-column{padding:10px;display:table-cell;flex:1;vertical-align:top;}.contrib-number{font-weight:400;line-height:1.3em;font-size:24px;display:block;}.left.text-muted{float:left;margin-left:9px;color:#767676;}.left.text-muted a{color:#4078c0;text-decoration:none;}.left.text-muted a:hover{text-decoration:underline;}h2.f4.text-normal.mb-3{display:none;}.float-left.text-gray{float:left;}.position-relative{width:100%;}@media screen and (max-width:650px){.contrib-column{display:none}}&lt;/style&gt;'</span>;</span><br><span class=\"line\">        style = <span class=\"string\">'&lt;div style=\"display:flex;width:100%\" class=\"number\"&gt;&lt;div class=\"contrib-column contrib-column-first table-column\"&gt;&lt;span class=\"text-muted\"&gt;过去一年访问&lt;/span&gt;&lt;span class=\"contrib-number\"&gt;'</span> + total + <span class=\"string\">'&lt;/span&gt;&lt;span class=\"text-muted\"&gt;'</span> + calArr[<span class=\"number\">0</span>][<span class=\"number\">0</span>] + <span class=\"string\">'&amp;nbsp;-&amp;nbsp;'</span> + calArr[calArr.<span class=\"property\">length</span> - <span class=\"number\">1</span>][<span class=\"number\">0</span>] + <span class=\"string\">'&lt;/span&gt;&lt;/div&gt;&lt;div class=\"contrib-column table-column\"&gt;&lt;span class=\"text-muted\"&gt;最近30天访问&lt;/span&gt;&lt;span class=\"contrib-number\"&gt;'</span> + thisweekdatacore + <span class=\"string\">'&lt;/span&gt;&lt;span class=\"text-muted\"&gt;'</span> + calArr[calArr.<span class=\"property\">length</span> - <span class=\"number\">30</span>][<span class=\"number\">0</span>] + <span class=\"string\">'&amp;nbsp;-&amp;nbsp;'</span> + calArr[calArr.<span class=\"property\">length</span> - <span class=\"number\">1</span>][<span class=\"number\">0</span>] + <span class=\"string\">'&lt;/span&gt;&lt;/div&gt;&lt;div class=\"contrib-column table-column\"&gt;&lt;span class=\"text-muted\"&gt;最近7天访问&lt;/span&gt;&lt;span class=\"contrib-number\"&gt;'</span> + weekdatacore + <span class=\"string\">'&lt;/span&gt;&lt;span class=\"text-muted\"&gt;'</span> + calArr[calArr.<span class=\"property\">length</span> - <span class=\"number\">7</span>][<span class=\"number\">0</span>] + <span class=\"string\">'&amp;nbsp;-&amp;nbsp;'</span> + calArr[calArr.<span class=\"property\">length</span> - <span class=\"number\">1</span>][<span class=\"number\">0</span>] + <span class=\"string\">'&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;'</span> + style;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"calendar_container\"</span>).<span class=\"title function_\">after</span>(script);</span><br><span class=\"line\">        <span class=\"title function_\">append_div_visitcalendar</span>(calendar_container, style);</span><br><span class=\"line\">    }).<span class=\"title function_\">catch</span>(<span class=\"keyword\">function</span> (<span class=\"params\">error</span>) {</span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    });</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 访问地图</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">mapChart</span> (<span class=\"params\"></span>) {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"script\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">let</span> now = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">    <span class=\"comment\">// 这个根据自己开始的时间修改</span></span><br><span class=\"line\">    date.<span class=\"title function_\">setFullYear</span>(<span class=\"number\">2021</span>, <span class=\"number\">01</span>, <span class=\"number\">01</span>);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> start_at = date.<span class=\"title function_\">getTime</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> end_at = now.<span class=\"title function_\">getTime</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// API根据自己的实际更改</span></span><br><span class=\"line\">    <span class=\"title function_\">fetch</span>(<span class=\"string\">'https://api.foolishfox.cn/umami/country?start_at='</span> + start_at + <span class=\"string\">'&amp;end_at='</span> + end_at).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> data.<span class=\"title function_\">json</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> {</span><br><span class=\"line\">        <span class=\"keyword\">let</span> mapArr = [];</span><br><span class=\"line\">        <span class=\"keyword\">let</span> maxValue = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; data.<span class=\"property\">length</span>; i++) {</span><br><span class=\"line\">            maxValue = data[i].<span class=\"property\">y</span> &gt; maxValue ? data[i].<span class=\"property\">y</span> : maxValue ;</span><br><span class=\"line\">            mapArr.<span class=\"title function_\">push</span>({ <span class=\"attr\">name</span>: data[i].<span class=\"property\">x</span>, <span class=\"attr\">value</span>: data[i].<span class=\"property\">y</span> });</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"keyword\">let</span> mapArrJson = <span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(mapArr);</span><br><span class=\"line\">        script.<span class=\"property\">innerHTML</span> = <span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">        var mapChart = echarts.init(document.getElementById('map_container'), 'light');</span></span><br><span class=\"line\"><span class=\"string\">        var mapOption = {</span></span><br><span class=\"line\"><span class=\"string\">            title: { text: '访问地点(按人数记)', x: 'center' },</span></span><br><span class=\"line\"><span class=\"string\">            tooltip: { trigger: 'item' },</span></span><br><span class=\"line\"><span class=\"string\">            visualMap: {</span></span><br><span class=\"line\"><span class=\"string\">                min: 0,</span></span><br><span class=\"line\"><span class=\"string\">                max: <span class=\"subst\">${maxValue}</span>,</span></span><br><span class=\"line\"><span class=\"string\">                left: 'left',</span></span><br><span class=\"line\"><span class=\"string\">                top: 'bottom',</span></span><br><span class=\"line\"><span class=\"string\">                text: ['高','低'],</span></span><br><span class=\"line\"><span class=\"string\">                color: ['#1E90FF', '#AAFAFA'],</span></span><br><span class=\"line\"><span class=\"string\">                calculable: true</span></span><br><span class=\"line\"><span class=\"string\">            },</span></span><br><span class=\"line\"><span class=\"string\">            series: [{</span></span><br><span class=\"line\"><span class=\"string\">                name: '访问人数',</span></span><br><span class=\"line\"><span class=\"string\">                type: 'map',</span></span><br><span class=\"line\"><span class=\"string\">                mapType: 'world',</span></span><br><span class=\"line\"><span class=\"string\">                showLegendSymbol: false,</span></span><br><span class=\"line\"><span class=\"string\">                label: {</span></span><br><span class=\"line\"><span class=\"string\">                    emphasis: { show: false }</span></span><br><span class=\"line\"><span class=\"string\">                },</span></span><br><span class=\"line\"><span class=\"string\">                itemStyle: {</span></span><br><span class=\"line\"><span class=\"string\">                    normal: {</span></span><br><span class=\"line\"><span class=\"string\">                        areaColor: 'rgba(255, 255, 255, 0.1)',</span></span><br><span class=\"line\"><span class=\"string\">                        borderColor: '#121212'</span></span><br><span class=\"line\"><span class=\"string\">                    },</span></span><br><span class=\"line\"><span class=\"string\">                    emphasis: { areaColor: 'gold' }</span></span><br><span class=\"line\"><span class=\"string\">                },</span></span><br><span class=\"line\"><span class=\"string\">                data: <span class=\"subst\">${mapArrJson}</span></span></span><br><span class=\"line\"><span class=\"string\">            }]</span></span><br><span class=\"line\"><span class=\"string\">        };</span></span><br><span class=\"line\"><span class=\"string\">        mapChart.setOption(mapOption);`</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">'map_container'</span>).<span class=\"title function_\">after</span>(script);</span><br><span class=\"line\">    }).<span class=\"title function_\">catch</span>(<span class=\"keyword\">function</span> (<span class=\"params\">error</span>) {</span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    });</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">get_year</span>(<span class=\"params\">s</span>) {</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">parseInt</span>(s.<span class=\"title function_\">substr</span>(<span class=\"number\">0</span>, <span class=\"number\">4</span>));</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">get_month</span>(<span class=\"params\">s</span>) {</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">parseInt</span>(s.<span class=\"title function_\">substr</span>(<span class=\"number\">5</span>, <span class=\"number\">2</span>));</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 访问趋势</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">trendsChart</span> (<span class=\"params\"></span>) {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"script\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">let</span> now = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">    <span class=\"comment\">// 这个根据自己开始的时间修改</span></span><br><span class=\"line\">    date.<span class=\"title function_\">setFullYear</span>(<span class=\"number\">2021</span>, <span class=\"number\">01</span>, <span class=\"number\">01</span>);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> start_at = date.<span class=\"title function_\">getTime</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> end_at = now.<span class=\"title function_\">getTime</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// API根据自己的实际更改</span></span><br><span class=\"line\">    <span class=\"title function_\">fetch</span>(<span class=\"string\">'https://api.foolishfox.cn/umami/month_view?start_at='</span> + start_at + <span class=\"string\">'&amp;end_at='</span> + end_at).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> data.<span class=\"title function_\">json</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> {</span><br><span class=\"line\">        data = data.<span class=\"property\">pageviews</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">        <span class=\"keyword\">let</span> monthValueArr = {};</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i =<span class=\"number\">2020</span>; i &lt;= date.<span class=\"title function_\">getFullYear</span>(); i++)   monthValueArr[<span class=\"title class_\">String</span>(i)] = [ ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  ];</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; data.<span class=\"property\">length</span>; i++) {</span><br><span class=\"line\">            <span class=\"keyword\">let</span> year = <span class=\"title function_\">get_year</span>(data[i].<span class=\"property\">t</span>);</span><br><span class=\"line\">            <span class=\"keyword\">let</span> month = <span class=\"title function_\">get_month</span>(data[i].<span class=\"property\">t</span>);</span><br><span class=\"line\">            monthValueArr[<span class=\"title class_\">String</span>(year)][<span class=\"title class_\">String</span>(month-<span class=\"number\">1</span>)] = data[i].<span class=\"property\">y</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\">        script.<span class=\"property\">innerHTML</span> = <span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">        var trendsChart = echarts.init(document.getElementById('trends_container'), 'light');</span></span><br><span class=\"line\"><span class=\"string\">        var trendsOption = {</span></span><br><span class=\"line\"><span class=\"string\">            title: { text: '访问趋势', x: 'center' },</span></span><br><span class=\"line\"><span class=\"string\">            tooltip: { trigger: 'axis' },</span></span><br><span class=\"line\"><span class=\"string\">            legend: { data: ['2021', '2022'], x: 'right' },</span></span><br><span class=\"line\"><span class=\"string\">            xAxis: {</span></span><br><span class=\"line\"><span class=\"string\">                name: '日期', type: 'category', boundaryGap: false,</span></span><br><span class=\"line\"><span class=\"string\">                data: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月']</span></span><br><span class=\"line\"><span class=\"string\">            },</span></span><br><span class=\"line\"><span class=\"string\">            yAxis: { name: '访问次数', type: 'value' },</span></span><br><span class=\"line\"><span class=\"string\">            series: [</span></span><br><span class=\"line\"><span class=\"string\">                {</span></span><br><span class=\"line\"><span class=\"string\">                    name: '2021', type: 'line', smooth: true,</span></span><br><span class=\"line\"><span class=\"string\">                    data: [<span class=\"subst\">${monthValueArr[<span class=\"string\">\"2021\"</span>]}</span>],</span></span><br><span class=\"line\"><span class=\"string\">                    markLine: { data: [{type: 'average', name: '平均值'}] }</span></span><br><span class=\"line\"><span class=\"string\">                },</span></span><br><span class=\"line\"><span class=\"string\">                {</span></span><br><span class=\"line\"><span class=\"string\">                    name: '2022', type: 'line', smooth: true,</span></span><br><span class=\"line\"><span class=\"string\">                    data: [<span class=\"subst\">${monthValueArr[<span class=\"string\">\"2022\"</span>]}</span>],</span></span><br><span class=\"line\"><span class=\"string\">                    markLine: { data: [{type: 'average', name: '平均值'}] }</span></span><br><span class=\"line\"><span class=\"string\">                }</span></span><br><span class=\"line\"><span class=\"string\">            ]</span></span><br><span class=\"line\"><span class=\"string\">        };</span></span><br><span class=\"line\"><span class=\"string\">        trendsChart.setOption(trendsOption);`</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">'trends_container'</span>).<span class=\"title function_\">after</span>(script);</span><br><span class=\"line\">    }).<span class=\"title function_\">catch</span>(<span class=\"keyword\">function</span> (<span class=\"params\">error</span>) {</span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    });</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 访问来源</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">sourcesChart</span> (<span class=\"params\"></span>) {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"script\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> link = <span class=\"number\">0</span>, direct = <span class=\"number\">0</span>, search = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> google = <span class=\"number\">0</span>, baidu = <span class=\"number\">0</span>, bing = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> github = <span class=\"number\">0</span>, travel = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">let</span> now = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">    <span class=\"comment\">// 这个根据自己开始的时间修改</span></span><br><span class=\"line\">    date.<span class=\"title function_\">setFullYear</span>(<span class=\"number\">2021</span>, <span class=\"number\">01</span>, <span class=\"number\">01</span>);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> start_at = date.<span class=\"title function_\">getTime</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> end_at = now.<span class=\"title function_\">getTime</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// API根据自己的实际更改</span></span><br><span class=\"line\">    <span class=\"title function_\">fetch</span>(<span class=\"string\">'https://api.foolishfox.cn/umami/referrer?start_at='</span> + start_at + <span class=\"string\">'&amp;end_at='</span> + end_at).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> data.<span class=\"title function_\">json</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> {</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; data.<span class=\"property\">length</span>; i++) {</span><br><span class=\"line\">            <span class=\"keyword\">var</span> ref = data[i].<span class=\"property\">x</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(ref == <span class=\"string\">\"\"</span> || ref.<span class=\"title function_\">includes</span>(<span class=\"string\">\"foolishfox.cn\"</span>))  direct += data[i].<span class=\"property\">y</span>;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ref.<span class=\"title function_\">includes</span>(<span class=\"string\">\"bing.com\"</span>))   bing += data[i].<span class=\"property\">y</span>;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ref.<span class=\"title function_\">includes</span>(<span class=\"string\">\"baidu.com\"</span>))   baidu += data[i].<span class=\"property\">y</span>;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ref.<span class=\"title function_\">includes</span>(<span class=\"string\">\"google.com\"</span>))   google += data[i].<span class=\"property\">y</span>;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ref.<span class=\"title function_\">includes</span>(<span class=\"string\">\"sogou.com\"</span>) || ref.<span class=\"title function_\">includes</span>(<span class=\"string\">\"sm.cn\"</span>) || ref.<span class=\"title function_\">includes</span>(<span class=\"string\">\"toutiao.com\"</span>) || ref.<span class=\"title function_\">includes</span>(<span class=\"string\">\"so.com\"</span>))</span><br><span class=\"line\">                search += data[i].<span class=\"property\">y</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ref.<span class=\"title function_\">includes</span>(<span class=\"string\">\"github.com\"</span>))   github += data[i].<span class=\"property\">y</span>;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ref.<span class=\"title function_\">includes</span>(<span class=\"string\">\"travellings\"</span>) || ref.<span class=\"title function_\">includes</span>(<span class=\"string\">\"foreverblog\"</span>))   travel += data[i].<span class=\"property\">y</span>;</span><br><span class=\"line\">            <span class=\"keyword\">else</span>   link += data[i].<span class=\"property\">y</span></span><br><span class=\"line\">        }</span><br><span class=\"line\"></span><br><span class=\"line\">        link += github + travel;</span><br><span class=\"line\">        search += baidu + google + bing;</span><br><span class=\"line\">        script.<span class=\"property\">innerHTML</span> += <span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">        var sourcesChart = echarts.init(document.getElementById('sources_container'), 'light');</span></span><br><span class=\"line\"><span class=\"string\">        var sourcesOption = {</span></span><br><span class=\"line\"><span class=\"string\">            title: { text: '访问来源', x: 'center', },</span></span><br><span class=\"line\"><span class=\"string\">            tooltip: { trigger: 'item', formatter: '{a} &lt;br/&gt;{b}: {c} ({d}%)' },</span></span><br><span class=\"line\"><span class=\"string\">            legend: {</span></span><br><span class=\"line\"><span class=\"string\">                data: ['直达', '外链', '搜索', '百度', '谷歌', '必应', 'Github', '开往/十年之约'],</span></span><br><span class=\"line\"><span class=\"string\">                y: 'bottom'</span></span><br><span class=\"line\"><span class=\"string\">            },</span></span><br><span class=\"line\"><span class=\"string\">            series: [</span></span><br><span class=\"line\"><span class=\"string\">                {</span></span><br><span class=\"line\"><span class=\"string\">                    name: '来源明细', type: 'pie', radius: ['45%', '60%'],</span></span><br><span class=\"line\"><span class=\"string\">                    labelLine: { length: 30 },</span></span><br><span class=\"line\"><span class=\"string\">                    label: {</span></span><br><span class=\"line\"><span class=\"string\">                        formatter: '{a|{a}}{abg|}\\\\n{hr|}\\\\n  {b|{b}: }{c}  {per|{d}%}  ',</span></span><br><span class=\"line\"><span class=\"string\">                        backgroundColor: '#F6F8FC', borderColor: '#8C8D8E',</span></span><br><span class=\"line\"><span class=\"string\">                        borderWidth: 1, borderRadius: 4,</span></span><br><span class=\"line\"><span class=\"string\">                        rich: {</span></span><br><span class=\"line\"><span class=\"string\">                            a: { color: '#6E7079', lineHeight: 22, align: 'center' },</span></span><br><span class=\"line\"><span class=\"string\">                            hr: { borderColor: '#8C8D8E', width: '100%', borderWidth: 1, height: 0 },</span></span><br><span class=\"line\"><span class=\"string\">                            b: { color: '#4C5058', fontSize: 14, fontWeight: 'bold', lineHeight: 33 },</span></span><br><span class=\"line\"><span class=\"string\">                            per: { color: '#fff', backgroundColor: '#4C5058', padding: [3, 4], borderRadius: 4 }</span></span><br><span class=\"line\"><span class=\"string\">                        }</span></span><br><span class=\"line\"><span class=\"string\">                    },</span></span><br><span class=\"line\"><span class=\"string\">                    data: [</span></span><br><span class=\"line\"><span class=\"string\">                        {value: <span class=\"subst\">${search - google - baidu - bing}</span>, name: '其他', itemStyle: { color : '#008000' }},</span></span><br><span class=\"line\"><span class=\"string\">                        {value: <span class=\"subst\">${google}</span>, name: '谷歌', itemStyle: { color : '#009000' }},</span></span><br><span class=\"line\"><span class=\"string\">                        {value: <span class=\"subst\">${baidu}</span>, name: '百度', itemStyle: { color : '#00A000' }},</span></span><br><span class=\"line\"><span class=\"string\">                        {value: <span class=\"subst\">${bing}</span>, name: '必应', itemStyle: { color : '#00B000' }},</span></span><br><span class=\"line\"><span class=\"string\">                        {value: <span class=\"subst\">${direct}</span>, name: '直达', itemStyle: { color : '#FFDB5C' }},</span></span><br><span class=\"line\"><span class=\"string\">                        {value: <span class=\"subst\">${github}</span>, name: 'Github', itemStyle: { color : '#10A3C7' }},</span></span><br><span class=\"line\"><span class=\"string\">                        {value: <span class=\"subst\">${travel}</span>, name: '开往/十年之约', itemStyle: { color : '#21B4D8' }},</span></span><br><span class=\"line\"><span class=\"string\">                        {value: <span class=\"subst\">${link - github - travel}</span>, name: '其他', itemStyle: { color : '#32C5E9' }}</span></span><br><span class=\"line\"><span class=\"string\">                    ]</span></span><br><span class=\"line\"><span class=\"string\">                },</span></span><br><span class=\"line\"><span class=\"string\">                {</span></span><br><span class=\"line\"><span class=\"string\">                    name: '访问来源', type: 'pie', selectedMode: 'single', radius: [0, '30%'],</span></span><br><span class=\"line\"><span class=\"string\">                    label: { position: 'inner', fontSize: 14},</span></span><br><span class=\"line\"><span class=\"string\">                    labelLine: { show: false },</span></span><br><span class=\"line\"><span class=\"string\">                    data: [</span></span><br><span class=\"line\"><span class=\"string\">                        {value: <span class=\"subst\">${search}</span>, name: '搜索', itemStyle: { color : '#008000' }},</span></span><br><span class=\"line\"><span class=\"string\">                        {value: <span class=\"subst\">${direct}</span>, name: '直达', itemStyle: { color : '#FFDB5C' }},</span></span><br><span class=\"line\"><span class=\"string\">                        {value: <span class=\"subst\">${link}</span>, name: '外链', itemStyle: { color : '#32C5E9' }}</span></span><br><span class=\"line\"><span class=\"string\">                    ]</span></span><br><span class=\"line\"><span class=\"string\">                },</span></span><br><span class=\"line\"><span class=\"string\">            ]</span></span><br><span class=\"line\"><span class=\"string\">        };</span></span><br><span class=\"line\"><span class=\"string\">        sourcesChart.setOption(sourcesOption);</span></span><br><span class=\"line\"><span class=\"string\">        window.addEventListener(\"resize\", () =&gt; { </span></span><br><span class=\"line\"><span class=\"string\">            calChart.resize();</span></span><br><span class=\"line\"><span class=\"string\">            mapChart.resize();</span></span><br><span class=\"line\"><span class=\"string\">            trendsChart.resize();</span></span><br><span class=\"line\"><span class=\"string\">            sourcesChart.resize();</span></span><br><span class=\"line\"><span class=\"string\">        });`</span>;</span><br><span class=\"line\">    }).<span class=\"title function_\">catch</span>(<span class=\"keyword\">function</span> (<span class=\"params\">error</span>) {</span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(error);</span><br><span class=\"line\">    });</span><br><span class=\"line\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">'sources_container'</span>).<span class=\"title function_\">after</span>(script);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"calendar_container\"</span>))   <span class=\"title function_\">calChart</span>();</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">'map_container'</span>))   <span class=\"title function_\">mapChart</span>();</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">'trends_container'</span>))   <span class=\"title function_\">trendsChart</span>();</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">'sources_container'</span>))   <span class=\"title function_\">sourcesChart</span>();</span><br></pre></td></tr></tbody></table></figure></div></details>\n<h3 id=\"效果展示\">效果展示 <a class=\"header-anchor\" href=\"#效果展示\">¶</a></h3>\n<p>动态展示页面：<a href=\"/statistics\">戳这里</a></p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/09/29/6334810a37e76.png\" alt=\"日历图与地图\"></div><span class=\"image-caption\">日历图与地图</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2022/09/29/6334810a85e69.png\" alt=\"访问趋势与来源\"></div><span class=\"image-caption\">访问趋势与来源</span></div>\n<h2 id=\"V2-版本更新\">V2 版本更新 <a class=\"header-anchor\" href=\"#V2-版本更新\">¶</a></h2>\n<h3 id=\"Umami-更新\">Umami 更新 <a class=\"header-anchor\" href=\"#Umami-更新\">¶</a></h3>\n<p>本文安装时 <code>Umami</code> 的版本是 <code>1.38.0</code>，目前已经更新到了 <code>2.6.2</code>，跨大版本升级需要更新数据库，大致流程如下：</p>\n<ol>\n<li>拉取最新仓库：</li>\n</ol>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">git pull</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>更新到 <code>V1</code> 的最新版本 <code>1.40.0</code>：</li>\n</ol>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">git checkout cc2be9f4</span><br><span class=\"line\">yarn install</span><br><span class=\"line\">yarn build</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>进行数据迁移 </li>\n</ol>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">npx @umami/migrate-v1-v2@latest</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"4\">\n<li>升级到 <code>V2</code>：</li>\n</ol>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">git checkout master</span><br><span class=\"line\">yarn install</span><br><span class=\"line\">yarn build</span><br></pre></td></tr></tbody></table></figure>\n<p>注意在安装 <code>sharp</code> 包时可能会由于网络下载相关内容超时导致失败，可以在<code>.npmrc</code> 中添加：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">sharp_binary_host=https://npm.taobao.org/mirrors/sharp</span><br><span class=\"line\">sharp_libvips_binary_host=https://npm.taobao.org/mirrors/sharp-libvips</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"API程序更新\">API 程序更新 <a class=\"header-anchor\" href=\"#API程序更新\">¶</a></h3>\n<p>在升级之后，<code>Umami</code> 的 API 也发生了改变，主要包括：</p>\n<ol>\n<li><code>GET /api/website/{id}/pageviews</code> 中的 <code>id</code> 进行了修改，变成了由数字和字母组成的混合字符串，例如 <code>74204a9f-8aca-4adf-9f03-d509f0a07116</code>，此外 <code>website</code> 变为了 <code>websites</code></li>\n<li>API 中的时间起止从 <code>start_at</code> 和 <code>end_at</code> 改为了 <code>startAt</code> 和 <code>endAt</code></li>\n<li>API 中的时区标识从 <code>tz</code> 改为 <code>timezone</code></li>\n<li><s>最长只能获取 90 天内的每日浏览数据，超过 90 天将会自动归并为每月的访问数据</s> <pangu> </pangu><a href=\"https://github.com/umami-software/umami/issues/2294\">Fixed in v2.9.0.</a></li>\n<li> 返回数据中时间标识从 <code>t</code> 改为了 <code>x</code></li>\n</ol>\n<p>根据上述更新，我们需要对 <code>main.py</code> 和 <code>census.js</code> 进行修改，示例如下：</p>\n<ul>\n<li><code>main.py</code></li>\n</ul>\n<details class=\"toggle\"><summary class=\"toggle-button\" style=\"color: green\">main.py</summary><div class=\"toggle-content\"><figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">root_path = <span class=\"string\">\"https://&lt;your-umami&gt;/api/websites/{}\"</span></span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"meta\">@app.get(<span class=\"params\"><span class=\"string\">\"/day_view\"</span></span>)</span></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">root</span>(<span class=\"params\">startAt, endAt</span>):</span><br><span class=\"line\">    url = root_path + <span class=\"string\">\"/pageviews?startAt={:d}&amp;endAt={:d}&amp;unit=day&amp;timezone=Asia/Shanghai\"</span>.<span class=\"built_in\">format</span>(</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(startAt),</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(endAt)</span><br><span class=\"line\">    )</span><br><span class=\"line\">    res = requests.get(url, headers=header)</span><br><span class=\"line\">    res = json.loads(res.content)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res</span><br><span class=\"line\">...</span><br></pre></td></tr></tbody></table></figure></div></details>\n<ul>\n<li><code>census.js</code></li>\n</ul>\n<details class=\"toggle\"><summary class=\"toggle-button\" style=\"color: red\">census.js</summary><div class=\"toggle-content\"><figure class=\"highlight javascript\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">calChart</span>(<span class=\"params\"></span>) {</span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"comment\">// 90 天版本</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> now = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> endAt = now.<span class=\"title function_\">getTime</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> startAt = endAt - <span class=\"number\">90</span> * <span class=\"number\">86400</span> * <span class=\"number\">1000</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 1 年版本</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> now = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span><br><span class=\"line\">    date.<span class=\"title function_\">setFullYear</span>(now.<span class=\"title function_\">getFullYear</span>() - <span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> startAt = date.<span class=\"title function_\">getTime</span>() - <span class=\"number\">3600</span> * <span class=\"number\">24</span> * ((date.<span class=\"title function_\">getDay</span>() + <span class=\"number\">1</span>) % <span class=\"number\">7</span>);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> endAt = now.<span class=\"title function_\">getTime</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// API根据自己的实际更改</span></span><br><span class=\"line\">    <span class=\"title function_\">fetch</span>(<span class=\"string\">'https://api.foolishfox.cn/umami/day_view?startAt='</span> + startAt + <span class=\"string\">'&amp;endAt='</span> + endAt).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> data.<span class=\"title function_\">json</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">data</span> =&gt;</span> {</span><br><span class=\"line\">        data = data.<span class=\"property\">pageviews</span>;</span><br><span class=\"line\">        data.<span class=\"title function_\">sort</span>(<span class=\"title function_\">compareFunction</span>(<span class=\"string\">\"x\"</span>));</span><br><span class=\"line\">...</span><br><span class=\"line\">                <span class=\"keyword\">let</span> pre = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(data[i - <span class=\"number\">1</span>].<span class=\"property\">x</span>.<span class=\"title function_\">replace</span>(<span class=\"regexp\">/-/g</span>, <span class=\"string\">\"/\"</span>));</span><br><span class=\"line\">                <span class=\"keyword\">let</span> tmp = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(data[i].<span class=\"property\">x</span>.<span class=\"title function_\">replace</span>(<span class=\"regexp\">/-/g</span>, <span class=\"string\">\"/\"</span>));</span><br><span class=\"line\">...</span><br><span class=\"line\">            calArr.<span class=\"title function_\">push</span>([data[i].<span class=\"property\">x</span>, data[i].<span class=\"property\">y</span>]);</span><br><span class=\"line\">        }</span><br><span class=\"line\">...</span><br><span class=\"line\">    }</span><br><span class=\"line\">...</span><br></pre></td></tr></tbody></table></figure></div></details>\n<h2 id=\"广告反屏蔽\">广告反屏蔽 <a class=\"header-anchor\" href=\"#广告反屏蔽\">¶</a></h2>\n<p><code>Umami</code> 的默认跟踪代码提供的链接是 <code>https://umami.foolishfox.cn/script.js</code>，会被大多数的广告插件屏蔽（如 <code>AdGuard</code>），统计不到访客信息。通过设置 <code>TRACKER_SCRIPT_NAME</code> 可以修改链接，起到反屏蔽的效果，修改后的跟踪代码链接为 <code>https://umami.foolishfox.cn/Bf5ZmaKLu245LG</code>。</p>\n<figure class=\"highlight yaml\"><figcaption><span>docker-compose.yml</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"3.9\"</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">    <span class=\"attr\">umami:</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">ghcr.io/umami-software/umami:mysql-latest</span></span><br><span class=\"line\">        <span class=\"attr\">environment:</span></span><br><span class=\"line\">            <span class=\"attr\">TRACKER_SCRIPT_NAME:</span> <span class=\"string\">Bf5ZmaKLu245LG</span></span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://umami.is/docs/migrate-v1-v2\">Migrating v1 to v2</a></li>\n<li><a href=\"https://www.cnblogs.com/volta-lemon/p/16891023.html\">一站式解决 Node 项目中遇到的 诸如 sharp: Command failed. 或 Building fresh packages… 始终执行问题</a></li>\n<li><a href=\"https://umami.is/docs/environment-variables\">Environment variables</a></li>\n</ol>\n","categories":["软件/程序","博客成长日志"],"tags":["教程","站点统计","Echarts","Umami"]},{"title":"学习笔记 | 贝叶斯块算法","url":"/posts/202310-bayesian-block.html","content":"<script defer=\"\" src=\"https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js\"></script>\n<script defer=\"\" src=\"https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js\" onload=\"renderMathInElement(document.body);\"></script>\n<div class=\"note warning flat\"><p>施工中</p>\n</div>\n<p>获取探测器的计数随时间或其他物理量的变化可以帮助了解发生的物理过程的各种性质。例如在 X 射线和 γ 射线天文学中十分关注光子计数随时间的变化，这一类变化被称为光变曲线，可以借此计算相应物理过程的空间尺度等性质。</p>\n<h2 id=\"基础知识\">基础知识 <a class=\"header-anchor\" href=\"#基础知识\">¶</a></h2>\n<h3 id=\"核辐射测量的统计性质\">核辐射测量的统计性质 <a class=\"header-anchor\" href=\"#核辐射测量的统计性质\">¶</a></h3>\n<p>探测 X/γ 射线需要使用核辐射探测器，每探测到一个事例，探测器将会记录相应事例的物理信息，如时间、能量、径迹等。核辐射的测量充满了随机性，但是可以用统计分布来描述其中的随机性。单个放射性粒子的衰变过程是一个伯努利事件，其衰变常数为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi></mrow><annotation encoding=\"application/x-tex\">\\lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">λ</span></span></span></span>，则在时间 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mo>∼</mo><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">0\\sim t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∼</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span> 内发生衰变的可能性为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\np = 1 - e^{-\\l…\">\\begin{align}\np = 1 - e^{-\\lambda t}\n\\end{align}\n</p>\n<p>对于由 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>n</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">n_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 个放射性粒子组成的体系，彼此之间发生衰变是独立的，则体系的衰变过程是一个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>n</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">n_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 重伯努利过程，即 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span> 时刻发生了衰变的粒子数目 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 满足二项分布：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\nP…\">\\begin{equation}\\begin{split}\nP(n|n_0) &amp;= C_{n_0}^np^n(1-p)^{n_0-n} \\\\\n\\mu &amp;= E(n) = n_0p \\\\\n\\sigma^2 &amp;= D(n) = n_0p(1-p)\n\\end{split}\\end{equation}\n</p>\n<p>当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>n</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">n_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 足够大，而 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span> 足够小时，二项分布可以近似为泊松分布：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\nP…\">\\begin{equation}\\begin{split}\nP(n) &amp;= \\frac{\\mu^n}{n!}e^{-\\mu} \\\\\n\\mu &amp;= n_0p \\\\\n\\sigma &amp;= \\sqrt{\\mu}\n\\end{split}\\end{equation}\n</p>\n<p>对于一般的物理过程而言，都满足该条件。当均值 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>μ</mi></mrow><annotation encoding=\"application/x-tex\">\\mu</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">μ</span></span></span></span> 足够大时，泊松分布可以进一步近似为高斯分布。在辐射测量中，我们获取到的是探测时间 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">d</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">\\mathrm{d}t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">d</span></span><span class=\"mord mathnormal\">t</span></span></span></span> 内的总计数，假设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">d</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">\\mathrm{d}t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">d</span></span><span class=\"mord mathnormal\">t</span></span></span></span> 时间内源的强度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi></mrow><annotation encoding=\"application/x-tex\">\\lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">λ</span></span></span></span> （单位为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi mathvariant=\"normal\">s</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding=\"application/x-tex\">\\mathrm{s}^{-1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">s</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span></span></span></span>）不变，则有：</p>\n<p class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>μ</mi><mo>=</mo><mi>λ</mi><mi mathvariant=\"normal\">d</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">\\mu = \\lambda\\mathrm{d}t\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">μ</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">λ</span><span class=\"mord\"><span class=\"mord mathrm\">d</span></span><span class=\"mord mathnormal\">t</span></span></span></span></span></p>\n<p>两个相邻事例的时间间隔为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi></mrow><annotation encoding=\"application/x-tex\">T</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span></span></span></span> 表示在第一个事例后 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mo>∼</mo><mi>T</mi></mrow><annotation encoding=\"application/x-tex\">0\\sim T</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∼</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span></span></span></span> 时间内没有事例，而在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi><mo>∼</mo><mi>T</mi><mo>+</mo><mi mathvariant=\"normal\">d</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">T\\sim T+\\mathrm{d}t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∼</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">d</span></span><span class=\"mord mathnormal\">t</span></span></span></span> 时间内有一个事例，其概率可以表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\nP…\">\\begin{equation}\\begin{split}\nP(t\\le T \\le t+\\mathrm{d}t) &amp;= P_t(0)\\times P_{\\mathrm{d}t}(1)\\\\\nP_t(0) = \\frac{(\\lambda t)^0}{0!}e^{-\\lambda t} &amp;= e^{-\\lambda t} \\\\\nP_{\\mathrm{d}t}(1) = \\frac{(\\lambda\\mathrm{d}t)^1}{1!}e^{-\\lambda\\mathrm{d}t} &amp;\\approx \\lambda\\mathrm{d}t\\quad(e^{-\\lambda\\mathrm{d}t} \\to 1)\n\\end{split}\\end{equation}\n</p>\n<p>设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">f(t)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span></span></span></span> 为概率密度函数，则有：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nf(t)\\mathrm{d}…\">\\begin{align}\nf(t)\\mathrm{d}t = P(t\\le T \\le t+\\mathrm{d}t) = \\lambda e^{-\\lambda t}\\mathrm{d}t\n\\end{align}\n</p>\n<p>可见时间间隔 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi></mrow><annotation encoding=\"application/x-tex\">T</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span></span></span></span> 满足指数分布，可以求得其期望值 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>t</mi><mo stretchy=\"true\">‾</mo></mover><mo>=</mo><mfrac><mn>1</mn><mi>λ</mi></mfrac></mrow><annotation encoding=\"application/x-tex\">\\overline{t}=\\frac{1}{\\lambda}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.81508em;vertical-align:0em;\"></span><span class=\"mord overline\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.81508em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span></span></span><span style=\"top:-3.73508em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"overline-line\" style=\"border-bottom-width:0.04em;\"></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">λ</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>。</p>\n<h3 id=\"贝叶斯定理\">贝叶斯定理 <a class=\"header-anchor\" href=\"#贝叶斯定理\">¶</a></h3>\n<p>对于一个模型 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">M</mi></mrow><annotation encoding=\"application/x-tex\">\\mathscr{M}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span></span></span></span>，假设其所有参数构成向量 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>θ</mi></mrow><annotation encoding=\"application/x-tex\">\\theta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span></span></span></span>。则根据已知数据 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>，贝叶斯定理可以表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nP(\\theta|D,\\ma…\">\\begin{align}\nP(\\theta|D,\\mathscr{M}) = \\frac{P(D|\\theta,\\mathscr{M})P(\\theta|\\mathscr{M})}{P(D|\\mathscr{M})}\n\\end{align}\n</p>\n<p id=\"eq-bayesian\" class=\"anchor\">eq-bayesian</p>\n<p>其中：</p>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>θ</mi><mi mathvariant=\"normal\">∣</mi><mi>D</mi><mo separator=\"true\">,</mo><mi mathvariant=\"script\">M</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(\\theta|D,\\mathscr{M})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"mclose\">)</span></span></span></span> 为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>θ</mi></mrow><annotation encoding=\"application/x-tex\">\\theta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span></span></span></span> 的后验概率（已知 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span> 情况下 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>θ</mi></mrow><annotation encoding=\"application/x-tex\">\\theta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span></span></span></span> 的条件概率）</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>θ</mi><mi mathvariant=\"normal\">∣</mi><mi mathvariant=\"script\">M</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(\\theta|\\mathscr{M})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span><span class=\"mord\">∣</span><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"mclose\">)</span></span></span></span> 为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>θ</mi></mrow><annotation encoding=\"application/x-tex\">\\theta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span></span></span></span> 的先验概率</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi> P</mi><mo stretchy=\"false\">(</mo><mi>D</mi><mi mathvariant=\"normal\">∣</mi><mi>θ</mi><mo separator=\"true\">,</mo><mi mathvariant=\"script\">M</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(D|\\theta,\\mathscr{M})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"mclose\">)</span></span></span></span> 为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span> 的后验概率或者在特定 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span> 下，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>θ</mi></mrow><annotation encoding=\"application/x-tex\">\\theta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span></span></span></span> 的似然性，即 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi><mo stretchy=\"false\">(</mo><mi>θ</mi><mi mathvariant=\"normal\">∣</mi><mi>D</mi><mo separator=\"true\">,</mo><mi mathvariant=\"script\">M</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">L(\\theta|D,\\mathscr{M})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"mclose\">)</span></span></span></span></li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>D</mi><mi mathvariant=\"normal\">∣</mi><mi mathvariant=\"script\">M</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(D|\\mathscr{M})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord\">∣</span><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"mclose\">)</span></span></span></span> 为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span> 的先验概率</li>\n</ul>\n<p>对于一组模型 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"script\">M</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi mathvariant=\"script\">M</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><msub><mi mathvariant=\"script\">M</mi><mi>n</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathscr{M}_1,\\mathscr{M}_2,\\dots,\\mathscr{M}_n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8944399999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，所有的约束、相关背景知识或者假设被称为信息背景，记作 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi></mrow><annotation encoding=\"application/x-tex\">I</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span></span></span></span>。则在给定 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi></mrow><annotation encoding=\"application/x-tex\">I</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span></span></span></span> 的情况下，不同模型的后验概率可以表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nP(\\mathscr{M}_…\">\\begin{align}\nP(\\mathscr{M}_k|D,I) = \\frac{P(D|\\mathscr{M}_k,I)P(\\mathscr{M}_k|I)}{P(D|I)}\n\\end{align}\n</p>\n<p>信息背景应当是不变的，所以我们可以省略。因此两种模型对数据的符合程度可以使用其后验概率的比值（即 odds ratio）表示：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\mathscr{O}_{i…\">\\begin{align}\n\\mathscr{O}_{ij} = \\frac{P(\\mathscr{M}_i|D)}{P(\\mathscr{M}_j|D)} = \\frac{P(D|\\mathscr{M}_i)P(\\mathscr{M}_i)}{P(D|\\mathscr{M}_j)P(\\mathscr{M}_j)}\n\\end{align}\n</p>\n<p>根据贝叶斯公式，由于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><msub><mi>θ</mi><mi>k</mi></msub><mi mathvariant=\"normal\">∣</mi><mi>D</mi><mo separator=\"true\">,</mo><msub><mi mathvariant=\"script\">M</mi><mi>k</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(\\theta_k|D,\\mathscr{M}_k)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 归一化，由式 (<a href=\"#eq-bayesian\">eq-bayesian</a>) 可以得到：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\mathscr{L}(\\m…\">\\begin{align}\n\\mathscr{L}(\\mathscr{M}_k|D) \\equiv P(D|\\mathscr{M}_k) = \\int P(D|\\theta_k,\\mathscr{M}_k)P(\\theta_k|\\mathscr{M}_k)\\mathrm{d}\\theta_k \\\\\nJ(\\mathscr{M}_k|D) \\equiv P(\\mathscr{M}_k)\\int P(D|\\theta_k,\\mathscr{M}_k)P(\\theta_k|\\mathscr{M}_k)\\mathrm{d}\\theta_k\n\\end{align}\n</p>\n<p id=\"eq-global-likelihood\" class=\"anchor\">eq-global-likelihood</p>\n<p>其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">L</mi><mo stretchy=\"false\">(</mo><msub><mi mathvariant=\"script\">M</mi><mi>k</mi></msub><mi mathvariant=\"normal\">∣</mi><mi>D</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\mathscr{L}(\\mathscr{M}_k|D)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.19189em;\">L</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mclose\">)</span></span></span></span> 被称为全局似然函数（global likelihood，叫边缘概率更多，marginal probability），<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>J</mi><mo stretchy=\"false\">(</mo><msub><mi mathvariant=\"script\">M</mi><mi>k</mi></msub><mi mathvariant=\"normal\">∣</mi><mi>D</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">J(\\mathscr{M}_k|D)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.09618em;\">J</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mclose\">)</span></span></span></span> 是数据和模型的联合概率（joint probability），包含了先验信息而与模型参数无关，则有：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\mathscr{O}_{i…\">\\begin{align}\n\\mathscr{O}_{ij} = \\frac{\\mathscr{L}(\\mathscr{M}_i|D)}{\\mathscr{L}(\\mathscr{M}_j|D)}\\rho\n\\end{align}\n</p>\n<p id=\"eq-odds-ratio\" class=\"anchor\">eq-odds-ratio</p>\n<p>其中：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\rho = \\frac{P…\">\\begin{align}\n\\rho = \\frac{P(\\mathscr{M}_i)}{P(\\mathscr{M}_j)}\n\\end{align}\n</p>\n<h3 id=\"光变曲线\">光变曲线 <a class=\"header-anchor\" href=\"#光变曲线\">¶</a></h3>\n<p>一定时间范围内的计数随时间的变化曲线就是我们所需的光变曲线，因此光变曲线可以理解为探测事例根据时间绘制的频数分布直方图。直方图的每一组在这里被称为分箱（bin），组距被称为 bin 宽，各组的界限值被称为 bin edge，直方图一个很重要的特性的分箱之间是等距的。</p>\n<p>对事例进行分箱的会丢弃大量信息，而且分箱的大小和位置对最终分析结果的影响很大。bin 宽越小，能够展现更精细的结构，但是单一分箱内的计数过少，统计性不足；bin 宽越大，统计性越强，但是丢失的物理信息更多。所以我们需要一种方法，既能够保证统计性，同时还能尽可能地展现精细的结构。这种方法应当允许分箱拥有不同的 bin 宽，而且 bin edge 能够根据数据自适应确定。</p>\n<p>一个简单的想法是遍历每一种可能的分箱方案，而可能方案的总数为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>N</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8413309999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8413309999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span></span></span></span></span></span></span></span></span></span></span> ，其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span> 为数据点的数目。显而易见随着数据量的增大，这种方法很快变得不可用。Scargle 在 1998 年提出了基于似然函数的迭代算法 <sup><a href=\"#refer-1\">(1)</a></sup>，能够在可接受的时间范围内得出近似解；而在 2013 年，Scargle 基于动态规划（<code>Dynamic Programming</code>）和块评价函数提出了一种新算法 <sup><a href=\"#refer-2\">(2)</a></sup>，能够在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(N^2)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.064108em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 的时间内求出最优解。在本文中，前者称为近似算法，后者为 DP 算法，两者统称为贝叶斯块算法。</p>\n<h3 id=\"贝叶斯块算法\">贝叶斯块算法 <a class=\"header-anchor\" href=\"#贝叶斯块算法\">¶</a></h3>\n<p>贝叶斯块算法将光变曲线表示为亮度随时间的分段常数，可以用于估计背景水平以及物理事件的时间尺度、空间尺度与强度等信息。</p>\n<p>在该算法中，单个的数据点被称为 <code>Cell</code>，而对数据进行分割的点被称为分割点 <code>Change Point</code>（简写为 <code>cp</code>），而相邻两个分割点之间（包括第一个分割点之前与最后一个分割点之后的）的所有数据点的集合被称为块 <code>Block</code>，某种特定的分割方案（或分割点的组合）被称为组合 <code>Partition</code>。</p>\n<p>算法的关键思想是不同块之间的评价是独立的，仅取决于该块的性质（例如块的长度、数据的情况等）。例如简单的分段常数模型具有这些参数：</p>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>N</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">N_\\mathrm{cp}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span>：分割点的数目</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi> t</mi><mi>k</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">t^\\mathrm{cp}_k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.083608em;vertical-align:-0.3013079999999999em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7823em;\"><span style=\"top:-2.3986920000000005em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3013079999999999em;\"><span></span></span></span></span></span></span></span></span></span>：第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> 个块的起始点（即第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">k-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 个和第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> 个块的分割点）</li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>X</mi><mi>k</mi></msub></mrow><annotation encoding=\"application/x-tex\">X_k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>：第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> 个块的信号强度</li>\n</ul>\n<p>其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi><mo>∈</mo><mo stretchy=\"false\">{</mo><mn>1</mn><mo separator=\"true\">,</mo><mn>2</mn><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><msub><mi>N</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi></mrow></msub><mo>+</mo><mn>1</mn><mo stretchy=\"false\">}</mo></mrow><annotation encoding=\"application/x-tex\">k\\in\\{1,2,\\dots,N_\\mathrm{cp}+1\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.73354em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mopen\">{</span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">2</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">}</span></span></span></span>，块最重要的两个参数是强度（即 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>X</mi><mi>k</mi></msub></mrow><annotation encoding=\"application/x-tex\">X_k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>）与长度（起始点与下一个分割点之间的间隔）。模型关键的问题在于要分多少个块，近似算法和 DP 算法对此的处理方式有所区别，具体参见后文。</p>\n<h2 id=\"数据模式\">数据模式 <a class=\"header-anchor\" href=\"#数据模式\">¶</a></h2>\n<h3 id=\"Time-Tagged-Event-Data\">Time-Tagged Event Data<a class=\"header-anchor\" href=\"#Time-Tagged-Event-Data\">¶</a></h3>\n<p>Time-Tagged Event（时间标记事件，TTE）是指记录事例入射时间的模式，表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nD_\\mathrm{TTE}…\">\\begin{align}\nD_\\mathrm{TTE}: \\{t_n,n=1\\dots N\\}\n\\end{align}\n</p>\n<p id=\"eq-tte-1\" class=\"anchor\">eq-tte-1</p>\n<p>事件记录的精度取决于采集系统的频率，以 20 MHz 的晶振为例，其时钟间隔 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>δ</mi><mi>t</mi><mo>=</mo><mn>50</mn><mtext>&nbsp;</mtext><mrow><mi mathvariant=\"normal\">n</mi><mi mathvariant=\"normal\">s</mi></mrow></mrow><annotation encoding=\"application/x-tex\">\\delta t = 50\\ \\mathrm{ns}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03785em;\">δ</span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mspace\">&nbsp;</span><span class=\"mord\"><span class=\"mord mathrm\">n</span><span class=\"mord mathrm\">s</span></span></span></span></span>，因此式 (<a href=\"#eq-tte-1\">eq-tte-1</a>) 可以表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nD_\\mathrm{TTE}…\">\\begin{align}\nD_\\mathrm{TTE}: \\{m_n,n=1\\dots N\\}\n\\end{align}\n</p>\n<p id=\"eq-tte-2\" class=\"anchor\">eq-tte-2</p>\n<p>其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>m</mi><mi>n</mi></msub></mrow><annotation encoding=\"application/x-tex\">m_n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">m</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 为时间刻度（time ticks），其代表的时间与总的刻度数为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nt_m &amp;= m\\delta…\">\\begin{align}\nt_m &amp;= m\\delta t \\\\\nM &amp;= \\frac{T}{\\delta t}\n\\end{align}\n</p>\n<p>进一步，式 (<a href=\"#eq-tte-1\">eq-tte-1</a>) 可以使用可观测量 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>X</mi><mi>m</mi></msub></mrow><annotation encoding=\"application/x-tex\">X_m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nD_\\mathrm{TTE}…\">\\begin{align}\nD_\\mathrm{TTE}: X_m = \\begin{cases}\n0, \\mathrm{no\\ event\\ during\\ tick\\ m} \\\\\n1, \\mathrm{otherwise}\n\\end{cases}\n\\end{align}\n</p>\n<p>其概率可以表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\nP…\">\\begin{equation}\\begin{split}\nP(X_m=0|\\Lambda) &amp;= e^{-\\Lambda} = p_0 \\\\\nP(X_m=1|\\Lambda) = 1 - p_0 &amp;= p_1 = e^{-\\Lambda}\\sum\\limits_{k=1}^{\\infty}\\frac{\\Lambda^k}{k!} \\\\\n\\Lambda &amp;= \\lambda\\delta t\n\\end{split}\\end{equation}\n</p>\n<p>由于时间间隔 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>δ</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">\\delta t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03785em;\">δ</span><span class=\"mord mathnormal\">t</span></span></span></span> 极短，所以当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi></mrow><annotation encoding=\"application/x-tex\">\\lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">λ</span></span></span></span> 不太大时，在一个时间间隔内多于 1 个入射事例的可能性相当低，则有：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\np_1 = 1 - e^{-…\">\\begin{align}\np_1 = 1 - e^{-\\lambda\\delta t} \\approx \\lambda\\delta t = \\Lambda\n\\end{align}\n</p>\n<p id=\"eq-tte-p1\" class=\"anchor\">eq-tte-p1</p>\n<h3 id=\"Binned-Data\">Binned Data<a class=\"header-anchor\" href=\"#Binned-Data\">¶</a></h3>\n<p>Binned Data 是已经分箱数据，将时间区间 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi></mrow><annotation encoding=\"application/x-tex\">T</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span></span></span></span> 均分为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>M</mi></mrow><annotation encoding=\"application/x-tex\">M</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span></span></span></span> 个区间，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>X</mi><mi>m</mi></msub></mrow><annotation encoding=\"application/x-tex\">X_m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">m</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 表示第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span> 个区间的事例计数，则有：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nD_\\mathrm{BIN}…\">\\begin{align}\nD_\\mathrm{BIN}: \\{X_m,m=1,\\dots,M\\} \\\\\nP(X_m|\\Lambda) = \\frac{\\Lambda^{X_m}}{X_m!}e^{-\\Lambda}\n\\end{align}\n</p>\n<h3 id=\"Time-to-Spill-Data\">Time-to-Spill Data<a class=\"header-anchor\" href=\"#Time-to-Spill-Data\">¶</a></h3>\n<p>Time-to-Spill（TTS）是指为了减少数据量，而每隔 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> 个事例记录一个事例数据的模式，可表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nD_\\mathrm{TTS}…\">\\begin{align}\nD_\\mathrm{TTS}: \\{\\tau_n,n=1,\\dots,N-1\\}\n\\end{align}\n</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>τ</mi><mi>n</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\tau_n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.1132em;\">τ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.1132em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 是第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个和第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">n+1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 个记录的事例之间的时间间隔（以刻度数表示，即实际时间间隔为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>τ</mi><mi>n</mi></msub><mi>δ</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">\\tau_n\\delta t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.1132em;\">τ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.1132em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.03785em;\">δ</span><span class=\"mord mathnormal\">t</span></span></span></span>），其分布满足：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nP(\\tau|\\Lambda…\">\\begin{align}\nP(\\tau|\\Lambda) = \\frac{\\Lambda^S}{\\Gamma(S)}\\tau^{S-1}e^{-\\Lambda\\tau}\n\\end{align}\n</p>\n<h3 id=\"混合模式\">混合模式 <a class=\"header-anchor\" href=\"#混合模式\">¶</a></h3>\n<p>实际观测过程中，同一事件的数据模式可能会发生改变。例如计数率太高时可能从 TTE 模式更改为 BIN 或者 TTS 模式，但只要选择的块评价函数对于不同数据模式而言是一致的，则可以处理任意混合模式的数据。</p>\n<h3 id=\"曝光\">曝光 <a class=\"header-anchor\" href=\"#曝光\">¶</a></h3>\n<p>在观测过程中，受到各种因素的影响，仪器的相应并不是一致的，例如辐射源的强度可能会改变探测器的探测效率，天气和环境的改变也可能会造成遮挡或噪声。这些因素的综合影响被称为曝光（<code>Exposure</code>），可以直接从整个探测系统（包含环境）的性质出发进行计算得到，或者通过仪器的刻度与标定获得。在实际中我们可以将第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个数据点的曝光表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n0\\le e_n \\le 1…\">\\begin{align}\n0\\le e_n \\le 1\n\\end{align}\n</p>\n<p>在实际计算中，需要将曝光的影响进行归一化，即将计数率乘以一个因子 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mn>1</mn><msub><mi>e</mi><mi>n</mi></msub></mfrac></mrow><annotation encoding=\"application/x-tex\">\\frac{1}{e_n}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2902079999999998em;vertical-align:-0.44509999999999994em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">e</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.16454285714285719em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.44509999999999994em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>。对于 TTE 数据我们得到的只是离散的时间序列，为了将其转化为计数率，需要除以事例间隔长度，具体而言对于第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个事例，其计数率 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>C</mi><mi>n</mi></msub></mrow><annotation encoding=\"application/x-tex\">C_n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 可以表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nC_n &amp;= \\frac{1…\">\\begin{align}\nC_n &amp;= \\frac{1}{e_n\\Delta t_n} \\\\\n\\Delta t_n &amp;= (t_{n+1}-t_{n-1}) / 2\n\\end{align}\n</p>\n<p>可以证明 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>C</mi><mi>n</mi></msub></mrow><annotation encoding=\"application/x-tex\">C_n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 满足一个仅与第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个事例时的真实计数率相关的分布。</p>\n<h2 id=\"近似算法\">近似算法 <a class=\"header-anchor\" href=\"#近似算法\">¶</a></h2>\n<h3 id=\"常数泊松分布模型\">常数泊松分布模型 <a class=\"header-anchor\" href=\"#常数泊松分布模型\">¶</a></h3>\n<p>假定在时间区间 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi></mrow><annotation encoding=\"application/x-tex\">T</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span></span></span></span> 内，辐射源的强度恒定不变，用单位时间的光子数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">\\lambda &gt; 0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.73354em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\">λ</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span></span></span></span> 表示。将观测时段以固定时间间隔 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Δ</mi><mi>T</mi></mrow><annotation encoding=\"application/x-tex\">\\Delta T</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Δ</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span></span></span></span> 划分为若干子区间，每个子区间上的计数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> 均满足泊松分布，即：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\nP…\">\\begin{equation}\\begin{split}\nP(k|\\Lambda) &amp;= \\frac{\\Lambda^ke^{-\\Lambda}}{k!} \\\\\n\\Lambda &amp;\\equiv \\lambda\\Delta T\n\\end{split}\\end{equation}\n</p>\n<p>使用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">M</mi><mo stretchy=\"false\">(</mo><mi mathvariant=\"normal\">Λ</mi><mo separator=\"true\">,</mo><mi>T</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\mathscr{M}(\\Lambda, T)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"mopen\">(</span><span class=\"mord\">Λ</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mclose\">)</span></span></span></span> 表示该模型类。除了常数模型外，还有线性模型与指数模型等，其表达式分别为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\lambda(t) &amp;= …\">\\begin{align}\n\\lambda(t) &amp;= \\lambda_0[1+a(t-t_0)] \\\\\n\\lambda(t) &amp;= \\lambda_0 e^{a(t-t_0)}\n\\end{align}\n</p>\n<p>其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">\\lambda_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 是基准强度，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">t_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 是基准时间，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi></mrow><annotation encoding=\"application/x-tex\">a</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">a</span></span></span></span> 是强度的变化速率。</p>\n<h4 id=\"TTE-Data\">TTE Data<a class=\"header-anchor\" href=\"#TTE-Data\">¶</a></h4>\n<p>由于不同入射事例之间是彼此独立的，则 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>D</mi><mrow><mi mathvariant=\"normal\">T</mi><mi mathvariant=\"normal\">T</mi><mi mathvariant=\"normal\">E</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">D_\\mathrm{TTE}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">T</span><span class=\"mord mathrm mtight\">T</span><span class=\"mord mathrm mtight\">E</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的联合概率可以表示为每一刻度上概率的乘积：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\nP…\">\\begin{equation}\\begin{split}\nP[D_\\mathrm{TTE}|\\mathscr{M}(\\Lambda, T)] &amp;= \\prod\\limits_{m=1}^MP(X_m|\\Lambda) \\\\\n&amp;= p_1^Np_0^{M-N}\n\\end{split}\\end{equation}\n</p>\n<p id=\"eq-tte-join\" class=\"anchor\">eq-tte-join</p>\n<p>可以发现与参数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi></mrow><annotation encoding=\"application/x-tex\">T</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span></span></span></span> 无关，模型类可简写为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">M</mi><mo stretchy=\"false\">(</mo><mi mathvariant=\"normal\">Λ</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\mathscr{M}(\\Lambda)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"mopen\">(</span><span class=\"mord\">Λ</span><span class=\"mclose\">)</span></span></span></span>。由二项分布可知当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">p_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 满足：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\frac{N}{M+1}\\…\">\\begin{align}\n\\frac{N}{M+1}\\le p_1 \\le \\frac{N+1}{M+1}\n\\end{align}\n</p>\n<p>时，式 (<a href=\"#eq-tte-join\">eq-tte-join</a>) 有最大值，由于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>M</mi></mrow><annotation encoding=\"application/x-tex\">M</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span></span></span></span> 都较大，不妨取 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub><mo>=</mo><mfrac><mi>N</mi><mi>M</mi></mfrac></mrow><annotation encoding=\"application/x-tex\">p_1=\\frac{N}{M}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.217331em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.872331em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">M</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>。则由式 (<a href=\"#eq-tte-p1\">eq-tte-p1</a>) 有：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\lambda &amp;= -\\f…\">\\begin{align}\n\\lambda &amp;= -\\frac{1}{\\delta t}\\ln\\left(1-\\frac{N}{M}\\right) \\\\\n&amp;\\approx \\frac{1}{\\delta t}\\frac{N}{M}\n\\end{align}\n</p>\n<p id=\"eq-tte-lambda-max-1\" class=\"anchor\">eq-tte-lambda-max-1</p>\n<p id=\"eq-tte-lambda-max-2\" class=\"anchor\">eq-tte-lambda-max-2</p>\n<p>使用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">p_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 代替 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Λ</mi></mrow><annotation encoding=\"application/x-tex\">\\Lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Λ</span></span></span></span> 作为模型参数，设参数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">p_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的先验分布为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nP(p_1|\\mathscr…\">\\begin{align}\nP(p_1|\\mathscr{M}) = \\begin{cases}\n1, 0 \\le p_1 \\le 1 \\\\\n0, \\mathrm{otherwise}\n\\end{cases}\n\\end{align}\n</p>\n<p>代入式 (<a href=\"#eq-global-likelihood\">eq-global-likelihood</a>) 中的全局似然函数，可得：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\nP…\">\\begin{equation}\\begin{split}\nP(D_\\mathrm{TTE}|\\mathscr{M}) &amp;= \\int P[D_\\mathrm{TTE}|\\mathscr{M}(p_1)]P(p_1|\\mathscr{M})\\mathrm{d}p_1 \\\\\n&amp;= \\int_0^1 p_1^N(1-p_1)^{M-N}\\mathrm{d}p_1 \\\\\n&amp;= B(N+1, M-N+1)\n\\end{split}\\end{equation}\n</p>\n<p>其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">B(x,y)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span> 为贝塔函数，可以用伽马函数表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nB(x,y) = \\frac…\">\\begin{align}\nB(x,y) = \\frac{\\Gamma(x)\\Gamma(y)}{\\Gamma(x+y)}\n\\end{align}\n</p>\n<p>因此可得：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\n\\…\">\\begin{equation}\\begin{split}\n\\mathscr{L}(\\mathscr{M}|D_\\mathrm{TTE}) &amp;= \\frac{\\Gamma(N+1)\\Gamma(M-N+1)}{\\Gamma(M+2)} \\\\\n&amp;= \\frac{N!(M-N)!}{(M+1)!}\n\\end{split}\\end{equation}\n</p>\n<p id=\"eq-tte-likelihood\" class=\"anchor\">eq-tte-likelihood</p>\n<h4 id=\"BIN-Data\">BIN Data<a class=\"header-anchor\" href=\"#BIN-Data\">¶</a></h4>\n<p>同上可得 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>D</mi><mrow><mi mathvariant=\"normal\">B</mi><mi mathvariant=\"normal\">I</mi><mi mathvariant=\"normal\">N</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">D_\\mathrm{BIN}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">B</span><span class=\"mord mathrm mtight\">I</span><span class=\"mord mathrm mtight\">N</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的联合概率为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nP[D_{BIN}|\\mat…\">\\begin{align}\nP[D_{BIN}|\\mathscr{M}(\\Lambda)] = \\frac{\\Lambda^Ne^{-M\\Lambda}}{\\prod\\limits_{m=1}^MX_m!},\\ N = \\sum\\limits_{m=1}^MX_m\n\\end{align}\n</p>\n<p id=\"eq-bin-joint\" class=\"anchor\">eq-bin-joint</p>\n<p>将式 (<a href=\"#eq-bin-joint\">eq-bin-joint</a>) 中的分子对 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Λ</mi></mrow><annotation encoding=\"application/x-tex\">\\Lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Λ</span></span></span></span> 求导可得：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\frac{\\mathrm{…\">\\begin{align}\n\\frac{\\mathrm{d}(\\Lambda^Ne^{-M\\Lambda})}{\\mathrm{d}\\Lambda} = N\\Lambda^{N-1}e^{-M\\Lambda}-M\\Lambda^Ne^{-M\\Lambda}\n\\end{align}\n</p>\n<p>令其等于 0 则可得最大概率的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Λ</mi></mrow><annotation encoding=\"application/x-tex\">\\Lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Λ</span></span></span></span> 取值为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\Lambda = \\fra…\">\\begin{align}\n\\Lambda = \\frac{N}{M}\n\\end{align}\n</p>\n<p id=\"eq-bin-lambda-max\" class=\"anchor\">eq-bin-lambda-max</p>\n<p>与式 (<a href=\"#eq-tte-lambda-max-2\">eq-tte-lambda-max-2</a>) 中的近似值一致。设参数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Λ</mi></mrow><annotation encoding=\"application/x-tex\">\\Lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Λ</span></span></span></span> 的先验分布为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nP(\\Lambda|\\mat…\">\\begin{align}\nP(\\Lambda|\\mathscr{M}) = \\begin{cases}\n\\frac{e^{-\\Lambda}}{1 - e^{-C}}, 0 \\le\\Lambda\\le C \\\\\n0, \\mathrm{otherwise}\n\\end{cases}\n\\end{align}\n</p>\n<p id=\"eq-bin-prior\" class=\"anchor\">eq-bin-prior</p>\n<p>可以证明该分布等价于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">p_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">[</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>C</mi></mrow></msup><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[e^{-C},1]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0913309999999998em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8413309999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">C</span></span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">]</span></span></span></span> 上的均匀分布。此处的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span> 可以近似用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mi>T</mi><mrow><mi>M</mi><msub><mi>t</mi><mi>d</mi></msub></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\frac{T}{Mt_d}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.323191em;vertical-align:-0.4508599999999999em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.872331em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">d</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15122857142857138em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.4508599999999999em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span> 表示，其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mi>d</mi></msub></mrow><annotation encoding=\"application/x-tex\">t_d</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">d</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 表示仪器的死时间。对于特定的一组数据，不同模型中式 (<a href=\"#eq-bin-joint\">eq-bin-joint</a>) 中的分母不会发生改变，可以略去。当考虑 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi><mo>→</mo><mi mathvariant=\"normal\">∞</mi></mrow><annotation encoding=\"application/x-tex\">C\\to\\infty</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord\">∞</span></span></span></span> 时，则有：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\n\\…\">\\begin{equation}\\begin{split}\n\\mathscr{L}(M|D_\\mathrm{BIN}) = \\int_0^\\infty\\Lambda^Ne^{-(M+1)\\Lambda}\\mathrm{d}\\Lambda = \\frac{\\Gamma(N+1)}{(M+1)^{N+1}}\n\\end{split}\\end{equation}\n</p>\n<p id=\"eq-bin-likelihood\" class=\"anchor\">eq-bin-likelihood</p>\n<h4 id=\"TTS-Data\">TTS Data<a class=\"header-anchor\" href=\"#TTS-Data\">¶</a></h4>\n<p>同上可得 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>D</mi><mrow><mi mathvariant=\"normal\">T</mi><mi mathvariant=\"normal\">T</mi><mi mathvariant=\"normal\">S</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">D_\\mathrm{TTS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">T</span><span class=\"mord mathrm mtight\">T</span><span class=\"mord mathrm mtight\">S</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的联合概率为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nP[D_\\mathrm{TT…\">\\begin{align}\nP[D_\\mathrm{TTS}|\\mathscr{M}(\\Lambda)] = \\left[\\frac{\\Lambda^S}{\\Gamma(S)}\\right]^{N-1}\\left(\\prod\\limits_{n=1}^{N-1}\\tau_n\\right)^{S-1}e^{-\\Lambda M},\\ M=\\sum\\limits_{n=1}^{N-1}\\tau_n\n\\end{align}\n</p>\n<p>同理可求得最大概率处 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Λ</mi></mrow><annotation encoding=\"application/x-tex\">\\Lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Λ</span></span></span></span> 的取值为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\Lambda = \\fra…\">\\begin{align}\n\\Lambda = \\frac{SN}{M}\n\\end{align}\n</p>\n<p id=\"eq-tts-lambda-max\" class=\"anchor\">eq-tts-lambda-max</p>\n<p>结合式 (<a href=\"#eq-bin-prior\">eq-bin-prior</a>)，当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi><mo>→</mo><mi mathvariant=\"normal\">∞</mi></mrow><annotation encoding=\"application/x-tex\">C\\to\\infty</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord\">∞</span></span></span></span> 时可求得似然函数为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\mathscr{L}(\\m…\">\\begin{align}\n\\mathscr{L}(\\mathscr{M}|D_\\mathrm{TTS}) = \\frac{\\left(\\prod_{n=1}^{N-1}\\tau_n\\right)^{S-1}}{\\Gamma(S)^{N-1}}\\frac{\\Gamma[S(N-1)+1]}{(M+1)^{S(N-1)+1}}\n\\end{align}\n</p>\n<p id=\"eq-tts-likelihood\" class=\"anchor\">eq-tts-likelihood</p>\n<h4 id=\"总结\">总结 <a class=\"header-anchor\" href=\"#总结\">¶</a></h4>\n<p>在常数泊松分布模型下，不同数据情况下的似然度仅取决于时间区间 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi></mrow><annotation encoding=\"application/x-tex\">T</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span></span></span></span> 的长度（以刻度数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>M</mi></mrow><annotation encoding=\"application/x-tex\">M</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span></span></span></span> 表示）和区间内的事例数目 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span>，因此可以写成：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\mathscr{L}(\\m…\">\\begin{align}\n\\mathscr{L}(\\mathscr{M}_1|D) = \\phi_D(N,M)\n\\end{align}\n</p>\n<p>其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"script\">M</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">\\mathscr{M}_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.85em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 代表常数泊松分布模型。不同 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span> 情况下的似然函数由式 (<a href=\"#eq-tte-likelihood\">eq-tte-likelihood</a>), (<a href=\"#eq-bin-likelihood\">eq-bin-likelihood</a>), (<a href=\"#eq-tts-likelihood\">eq-tts-likelihood</a>) 给出：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\phi_\\mathrm{T…\">\\begin{align}\n\\phi_\\mathrm{TTE} &amp;= \\frac{\\Gamma(N+1)\\Gamma(M-N+1)}{\\Gamma(M+2)} = \\frac{N!(M-N)!}{(M+1)!} \\\\\n\\phi_\\mathrm{BIN} &amp;= \\frac{\\Gamma(N+1)}{(M+1)^{N+1}} \\\\\n\\phi_\\mathrm{TTS} &amp;= \\frac{\\left(\\prod_{n=1}^{N-1}\\tau_n\\right)^{S-1}}{\\Gamma(S)^{N-1}}\\frac{\\Gamma[S(N-1)+1]}{(M+1)^{S(N-1)+1}}\n\\end{align}\n</p>\n<h3 id=\"分段常数泊松分布模型\">分段常数泊松分布模型 <a class=\"header-anchor\" href=\"#分段常数泊松分布模型\">¶</a></h3>\n<p>在未分段的常数泊松分布模型上改进，将整个时间区间分为若干子区间，每一个子区间内都是恒定的泊松分布模型。考虑最简单的二分段模型，可以使用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"script\">M</mi><mn>2</mn></msub><mo stretchy=\"false\">(</mo><msub><mi mathvariant=\"normal\">Λ</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi mathvariant=\"normal\">Λ</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><msub><mi>t</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi></mrow></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\mathscr{M}_2(\\Lambda_1,\\Lambda_2,t_\\mathrm{cp})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.15981em;\">M</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord\">Λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\">Λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 表示，该模型可以表示为两个简单模型的复合：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\mathscr{M}_2(…\">\\begin{align}\n\\mathscr{M}_2(\\Lambda_1,\\Lambda_2,t_\\mathrm{cp}) = \\mathscr{M}_1(\\Lambda_1,M_1)\\otimes\\mathscr{M}_1(\\Lambda_2,M_2)\n\\end{align}\n</p>\n<p>其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">t_\\mathrm{cp}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9011879999999999em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 表示两段的分割点（Change Point），在该点处泊松分布的参数从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"normal\">Λ</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">\\Lambda_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\">Λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 改变为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"normal\">Λ</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">\\Lambda_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\">Λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，前后两段的计数分别为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>N</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">N_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>N</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">N_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，长度分别为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>M</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">M_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>M</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">M_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。由于前后两个过程是独立的，因此复合模型的概率可以表示为两个子模型的乘积：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nP[D|\\mathscr{M…\">\\begin{align}\nP[D|\\mathscr{M}_2(\\Lambda_1,\\Lambda_2,t_\\mathrm{cp})] = P[D_1|\\mathscr{M}_1(\\Lambda_1,M_1)]\\times P[D_2|\\mathscr{M}_1(\\Lambda_2,M_2)]\n\\end{align}\n</p>\n<p>进而可得到全局似然函数：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\n\\…\">\\begin{equation}\\begin{split}\n\\mathscr{L}(\\mathscr{M}_2|D) = &amp;\\int\\mathrm{d}t_\\mathrm{cp}\\int\\mathrm{d}\\Lambda_1\\int\\mathrm{d}\\Lambda_2 P_\\mathrm{cp}(t_\\mathrm{cp}) \\\\\n&amp;\\times P[D_1|\\mathscr{M}_1(\\Lambda_1,M_1)]P_\\Lambda(\\Lambda_1|\\mathscr{M}_1) \\\\\n&amp;\\times P[D_2|\\mathscr{M}_1(\\Lambda_2,M_2)]P_\\Lambda(\\Lambda_2|\\mathscr{M}_1)\n\\end{split}\\end{equation}\n</p>\n<p>积分后的表达式应当与参数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"normal\">Λ</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">\\Lambda_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\">Λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>， <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"normal\">Λ</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">\\Lambda_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\">Λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">t_\\mathrm{cp}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9011879999999999em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 无关。两个子模型之间应当是无关的，因此可分离变量为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\psi(t_\\mathrm…\">\\begin{align}\n\\psi(t_\\mathrm{cp}) = \\phi(N_1,M_1)\\phi(N_2,M_2) \\\\\n\\mathscr{L}(\\mathscr{M}_2|D) = \\int P_\\mathrm{cp}(t_\\mathrm{cp})\\psi(t_\\mathrm{cp})\\mathrm{d}t_\\mathrm{cp}\n\\end{align}\n</p>\n<p>实际上各种数据中时间点都是离散的，因此 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">d</mi><msub><mi>t</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathrm{d}t_\\mathrm{cp}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">d</span></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 的积分可以使用求和代替。考虑 TTE 情况下的数据，可以使用时间刻度来表示分割点。在没有事例记录的时间点进行分割是没有意义的，因此分割点应当在式 (<a href=\"#eq-tte-2\">eq-tte-2</a>) 表示的数据点中，使用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>m</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi></mrow></msub><mo>=</mo><msub><mi>m</mi><msub><mi>n</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi></mrow></msub></msub></mrow><annotation encoding=\"application/x-tex\">m_\\mathrm{cp} = m_{n_\\mathrm{cp}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">m</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7778799999999999em;vertical-align:-0.34731999999999996em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">m</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.16454285714285716em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2818857142857143em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.34731999999999996em;\"><span></span></span></span></span></span></span></span></span></span> 表示，则有：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\nN…\">\\begin{equation}\\begin{split}\nN_1 &amp;= n_\\mathrm{cp} \\\\\nN_2 &amp;= N - N_1 \\\\\nM_1 &amp;= m_\\mathrm{cp} \\\\\nM_2 &amp;= M - M_1\n\\end{split}\\end{equation}\n</p>\n<p>设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>m</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">m_\\mathrm{cp}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">m</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 的先验分布为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nP(m_\\mathrm{cp…\">\\begin{align}\nP(m_\\mathrm{cp}|\\mathscr{M}_2) = \\begin{cases}\n\\frac{1}{N}, m_\\mathrm{cp}\\in D_\\mathrm{TTE} \\\\\n0, \\mathrm{otherwise}\n\\end{cases}\n\\end{align}\n</p>\n<p>则似然函数可以表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\psi(n_\\mathrm…\">\\begin{align}\n\\psi(n_\\mathrm{cp}) &amp;= \\phi(N_1,M_1)\\phi(N_2,M_2)\\\\\n\\mathscr{L}(\\mathscr{M}_2|D) &amp;= \\frac{1}{N}\\sum\\limits_{n_\\mathrm{cp}=1}^N\\psi(n_\\mathrm{cp})\\Delta t_{n_\\mathrm{cp}}\n\\end{align}\n</p>\n<p id=\"eq-piecewise-psi\" class=\"anchor\">eq-piecewise-psi</p>\n<p id=\"eq-piecewise-likelihood\" class=\"anchor\">eq-piecewise-likelihood</p>\n<p>式 (<a href=\"#eq-piecewise-likelihood\">eq-piecewise-likelihood</a>) 前的常数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mn>1</mn><mi>N</mi></mfrac></mrow><annotation encoding=\"application/x-tex\">\\frac{1}{N}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span> 可忽略，而 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Δ</mi><msub><mi>t</mi><msub><mi>n</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi></mrow></msub></msub></mrow><annotation encoding=\"application/x-tex\">\\Delta t_{n_\\mathrm{cp}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.03065em;vertical-align:-0.34731999999999996em;\"></span><span class=\"mord\">Δ</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.16454285714285716em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2818857142857143em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.34731999999999996em;\"><span></span></span></span></span></span></span></span></span></span> 是相邻两个事例间的时间间隔，一般而言是一个可忽略的小修正项。</p>\n<h3 id=\"分块数目\">分块数目 <a class=\"header-anchor\" href=\"#分块数目\">¶</a></h3>\n<p>根据式 (<a href=\"#eq-odds-ratio\">eq-odds-ratio</a>) 有：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\mathscr{O}_{2…\">\\begin{align}\n\\mathscr{O}_{21} = \\frac{J(\\mathscr{M}_2|D)}{J(\\mathscr{M}_1|D)} = \\rho\\frac{\\mathscr{L}(\\mathscr{M}_2|D)}{\\mathscr{L}(\\mathscr{M}_1|D)}\n\\end{align}\n</p>\n<p>当先验概率比值 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ρ</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">\\rho=1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">ρ</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 时，该比值被称为贝叶斯因子（Bayes Factor，BF）。如果分段模型更占优，则由式 (<a href=\"#eq-piecewise-psi\">eq-piecewise-psi</a>) 计算最可能的分段点的位置，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Λ</mi></mrow><annotation encoding=\"application/x-tex\">\\Lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Λ</span></span></span></span> 的最可几取值可由式 (<a href=\"#eq-tte-lambda-max-1\">eq-tte-lambda-max-1</a>)，(<a href=\"#eq-tte-lambda-max-2\">eq-tte-lambda-max-2</a>)，(<a href=\"#eq-bin-lambda-max\">eq-bin-lambda-max</a>)，(<a href=\"#eq-tts-lambda-max\">eq-tts-lambda-max</a>) 确定。对于具有 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span> 个分割点的模型，可以逐一求解分割点位置，也可以使用迭代的方法进行近似计算。</p>\n<p>迭代方法对整体区间分为两段，如果 BF 更支持分段模型，则对分段后的子区间继续同样的过程，该方法得到的分段方案与直接计算得到的方案十分接近。结束条件可以是所有的子区间 BF 都更支持不分段模型，但是大量的数据显示绝大部分的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"script\">O</mi><mn>21</mn></msub></mrow><annotation encoding=\"application/x-tex\">\\mathscr{O}_{21}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.85em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.08078em;\">O</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 都比 1 大一点，因此会存在区间划分过细的问题。</p>\n<p>一个方法是设置子区间允许的最小事例数目以保持良好的统计性，当事例数目达到或小于这一设定值时不再进行分段；另一种方案是改变模型的先验概率值使其更倾向于不分段的模型，即调整 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"script\">O</mi><mn>21</mn></msub></mrow><annotation encoding=\"application/x-tex\">\\mathscr{O}_{21}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.85em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathscr\" style=\"margin-right:0.08078em;\">O</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding=\"application/x-tex\">\\rho</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">ρ</span></span></span></span> 的大小。</p>\n<h2 id=\"DP-算法\">DP 算法 <a class=\"header-anchor\" href=\"#DP-算法\">¶</a></h2>\n<h3 id=\"块评价函数\">块评价函数 <a class=\"header-anchor\" href=\"#块评价函数\">¶</a></h3>\n<p>块评价函数用于评价划分出的块的优劣，以此为基础解决分块的最优化问题。贝叶斯块算法要求块评价函数具有可加性（block-additive），即分组的整体评价是各个块的评价函数值之和。对于某个块评价函数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mo stretchy=\"false\">(</mo><msub><mi>B</mi><mi>k</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">f(B_k)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 和某种分组 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi></mrow><annotation encoding=\"application/x-tex\">P</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span></span></span></span>，分组的整体评价为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nF(P)=\\sum\\limi…\">\\begin{align}\nF(P)=\\sum\\limits_{k=1}^{N_\\mathrm{b}}f(B_k)\n\\end{align}\n</p>\n<p>其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>B</mi><mi>k</mi></msub></mrow><annotation encoding=\"application/x-tex\">B_k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> ​代表第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> 个块，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>N</mi><mi mathvariant=\"normal\">b</mi></msub></mrow><annotation encoding=\"application/x-tex\">N_\\mathrm{b}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">b</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 为分组 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi></mrow><annotation encoding=\"application/x-tex\">P</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span></span></span></span> 中分块的数目。特定的分组方式被记为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">s</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">P_\\mathrm{cps}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">c</span><span class=\"mord mathrm mtight\">p</span><span class=\"mord mathrm mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>k</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(k)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mclose\">)</span></span></span></span> 表示前 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> 个数据点的分组方式。贝叶斯块算法的目标是选取恰当的分组方式，使得整体评价最优，可以表示为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\n\\max\\limits_{\\…\">\\begin{align}\n\\max\\limits_{\\mathrm{cps}}F(P_\\mathrm{cps})\n\\end{align}\n</p>\n<h3 id=\"实现步骤\">实现步骤 <a class=\"header-anchor\" href=\"#实现步骤\">¶</a></h3>\n<p>假设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">t</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>k</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P_\\mathrm{opt}(k)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.28055599999999997em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">o</span><span class=\"mord mathrm mtight\">p</span><span class=\"mord mathrm mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mclose\">)</span></span></span></span> 为前 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> 个点的最佳分组，根据 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">t</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P_\\mathrm{opt}(k+1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.28055599999999997em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">o</span><span class=\"mord mathrm mtight\">p</span><span class=\"mord mathrm mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 的定义，其最后一个块的右边界一定为第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">k+1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 个点。定义 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span> 满足 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">t</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P_\\mathrm{opt}(k+1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.28055599999999997em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">o</span><span class=\"mord mathrm mtight\">p</span><span class=\"mord mathrm mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 的最后一个块的左边界为第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span> 个点，则 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span> 共有 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">k+1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 种可能，即 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo separator=\"true\">,</mo><mn>2</mn><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1,2,\\dots,k+1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">2</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span>，最后一个块的评价表示为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mo stretchy=\"false\">(</mo><mi>r</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">f(r)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mclose\">)</span></span></span></span>。</p>\n<p>可以证明对于所有以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span> 为最后一个块的左边界的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(k+1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 分组的集合，仅有 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">t</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>r</mi><mo>−</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P_\\mathrm{opt}(r-1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.28055599999999997em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">o</span><span class=\"mord mathrm mtight\">p</span><span class=\"mord mathrm mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 与这最后一个块组成的方案才可能为最佳分组：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nF[P_\\mathrm{cp…\">\\begin{align}\nF[P_\\mathrm{cps}(r-1)] &amp;\\le F[P_\\mathrm{opt}(r-1)] \\nonumber \\\\\nF[P_\\mathrm{cps}(r-1)] + f(r) &amp;\\le F[P_\\mathrm{opt}(r-1)] + f(r)\n\\end{align}\n</p>\n<p>由于块评价函数具有可加性，因此:</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: equation at position 7: \\begin{̲e̲q̲u̲a̲t̲i̲o̲n̲}̲\\begin{split}\nF…\">\\begin{equation}\\begin{split}\nF[P^r(k+1)] = f(r) + \\begin{cases}\n0 &amp;; r=1\\cr\nF[P_\\mathrm{opt}(r-1)] &amp;; r=2,3,...,R+1\n\\end{cases}\n\\end{split}\\end{equation}\n</p>\n<p>​当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">r=1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 时，所有数据点都在同一个块中，不存在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">r-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 对应的块评价函数。遍历 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">k+1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 种 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span> 的取值可能，然后取 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>r</mi><mrow><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">t</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">r_\\mathrm{opt}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.28055599999999997em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">o</span><span class=\"mord mathrm mtight\">p</span><span class=\"mord mathrm mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 满足：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nr_\\mathrm{opt}…\">\\begin{align}\nr_\\mathrm{opt}=\\mathop{\\mathrm{argmax}}\\limits_{r}F[P^r(k+1)]\n\\end{align}\n</p>\n<p>结合 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">t</mi></mrow></msub><mo stretchy=\"false\">(</mo><msub><mi>r</mi><mrow><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">t</mi></mrow></msub><mo>−</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P_\\mathrm{opt}(r_\\mathrm{opt}-1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.28055599999999997em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">o</span><span class=\"mord mathrm mtight\">p</span><span class=\"mord mathrm mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.28055599999999997em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">o</span><span class=\"mord mathrm mtight\">p</span><span class=\"mord mathrm mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 可得 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">t</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P_\\mathrm{opt}(k+1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.28055599999999997em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">o</span><span class=\"mord mathrm mtight\">p</span><span class=\"mord mathrm mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span>，进而得到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">t</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>k</mi><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo><mi>k</mi><mo>=</mo><mn>1</mn><mo separator=\"true\">,</mo><mn>2</mn><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">P_\\mathrm{opt}(k), k=1,2,\\dots,N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.28055599999999997em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">o</span><span class=\"mord mathrm mtight\">p</span><span class=\"mord mathrm mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">2</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span>，最优的分组方案即 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mrow><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">t</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>N</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P_\\mathrm{opt}(N)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.28055599999999997em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">o</span><span class=\"mord mathrm mtight\">p</span><span class=\"mord mathrm mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mclose\">)</span></span></span></span>。</p>\n<h3 id=\"分块数目-v2\">分块数目 <a class=\"header-anchor\" href=\"#分块数目-v2\">¶</a></h3>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>N</mi><mi mathvariant=\"normal\">b</mi></msub></mrow><annotation encoding=\"application/x-tex\">N_\\mathrm{b}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">b</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的先验分布，如：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nP(N_\\mathrm{b}…\">\\begin{align}\nP(N_\\mathrm{b}) = P_0\\gamma^{N_\\mathrm{b}}\n\\end{align}\n</p>\n<p>其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mo>≤</mo><msub><mi>N</mi><mi mathvariant=\"normal\">b</mi></msub><mo>≤</mo><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">0 \\le N_\\mathrm{b} \\le N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.78041em;vertical-align:-0.13597em;\"></span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">b</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mo>≤</mo><mi>γ</mi><mo>≤</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">0 \\le \\gamma \\le 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.78041em;vertical-align:-0.13597em;\"></span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8304100000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05556em;\">γ</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 是唯一的参数，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mi>N</mi><mi mathvariant=\"normal\">b</mi></msub><mo stretchy=\"true\">‾</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\overline{N_\\mathrm{b}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.03333em;vertical-align:-0.15em;\"></span><span class=\"mord overline\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8833300000000001em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">b</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.80333em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"overline-line\" style=\"border-bottom-width:0.04em;\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 可以计算得出：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\nP_0 &amp;= \\frac{1…\">\\begin{align}\nP_0 &amp;= \\frac{1 - \\gamma}{1 - \\gamma^{N+1}} \\\\\n\\overline{N_\\mathrm{b}} &amp;= \\frac{N\\gamma^{N+1}+1}{\\gamma^{N+1}-1}+\\frac{1}{1-\\gamma}\n\\end{align}\n</p>\n<p>定义误报率 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">p_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 为，正确率 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">p_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 为：</p>\n<p class=\"katex-block katex-error\" title=\"ParseError: KaTeX parse error: No such environment: align at position 7: \\begin{̲a̲l̲i̲g̲n̲}̲\np_0 \\equiv 1 -…\">\\begin{align}\np_0 \\equiv 1 - p_1\n\\end{align}\n</p>\n<div class=\"note warning flat\"><p>未完待续</p>\n</div>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><span id=\"refer-1\">Scargle J D. Studies in astronomical time series analysis. V. Bayesian blocks, a new method to analyze structure in photon counting data[J]. The Astrophysical Journal, 1998, 504(1): 405.</span></li>\n<li><span id=\"refer-2\">Scargle J D, Norris J P, Jackson B, et al. Studies in astronomical time series analysis. VI. Bayesian Block representations[J]. The Astrophysical Journal, 2013, 764(2): 167.</span></li>\n<li><a href=\"https://docs.astropy.org/en/stable/api/astropy.stats.bayesian_blocks.html#bayesian-blocks\">bayesian_blocks</a></li>\n</ol>\n","categories":["学习笔记"],"tags":["Python","核技术","贝叶斯分析"]},{"title":"使用 wine 安装 SRIM","url":"/posts/202310-wine-srim.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>SRIM 是一个 Windows 平台上用于计算带电粒子能损的软件包，典型的应用包括计算入射离子在靶材中的射程和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><mi>E</mi><mi mathvariant=\"normal\">/</mi><mi>d</mi><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">dE/dx</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord\">/</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span></span></span></span> 能损曲线等。由于这是一个单字节程序，因此在中文系统中会存在显示问题，可以通过更改系统的区域和语言为美国 / 英语重启之后解决<sup> [2]</sup>，但是会很麻烦，而且可能导致其他软件出现问题（例如部分软件可能读取到错误的区域），如下图所示。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2023/10/12/6526c9256b3e9.png\" alt=\"错误显示的 SRIM\" style=\"height:200px;\"></div><span class=\"image-caption\">错误显示的 SRIM</span></div>\n<p>为了解决这个问题，我们可以选择在 WSL 上安装 wine，通过 wine 来调用 SRIM。请注意，此处需要 WSL 更新到最新版本以支持 <a href=\"https://learn.microsoft.com/zh-cn/windows/wsl/tutorials/gui-apps\">WSLG</a>。</p>\n<div class=\"note info flat\"><p><strong>本机环境</strong><br>\nWSL: 1.2.5.0<br>\nWSLg: 1.0.51<br>\nUbuntu: 20.04.6<br>\nwine: 8.0.2</p>\n</div>\n<h2 id=\"wine\">wine<a class=\"header-anchor\" href=\"#wine\">¶</a></h2>\n<p>wine 目前最新稳定版本更新至 8.0.2，但是 ubuntu 自带的软件源中仍为 5.0 版本。可以根据需要自行选择安装版本。</p>\n<h3 id=\"wine-5-0\">wine 5.0<a class=\"header-anchor\" href=\"#wine-5-0\">¶</a></h3>\n<ol>\n<li> 更新与安装 wine。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> apt update &amp;&amp; <span class=\"built_in\">sudo</span> apt install wine -y</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>检查 wine32 是否安装，如果没有则另外安装。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> dpkg --add-architecture i386</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt update &amp;&amp; <span class=\"built_in\">sudo</span> apt install wine32 -y</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>配置 Windows 10 环境。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">winecfg</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2023/10/12/6527510b561c9.png\" alt=\"wine 配置\" style=\"height:300px;\"></div><span class=\"image-caption\">wine 配置</span></div>\n<h3 id=\"wine-8-0\">wine 8.0<a class=\"header-anchor\" href=\"#wine-8-0\">¶</a></h3>\n<p>ubuntu 提供的 wine 已经落后了好几个版本，所以可以通过 WineHQ 自己的储存库安装较新版本的 wine。WineHQ 存储库仅提供适用于 AMD64 和 i386 的软件包，如果需要 ARM 版本，可以使用 Ubuntu 软件包。<sup>[4]</sup></p>\n<ol>\n<li>开启 32 位支持。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> dpkg --add-architecture i386 </span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>下载并添加仓库密钥，随后添加仓库并更新。<sup>[5]</sup></li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> wget -nc -O /usr/share/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> su</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"deb [arch=amd64,i386 signed-by=/usr/share/keyrings/winehq-archive.key] https://mirrors.tuna.tsinghua.edu.cn/wine-builds/ubuntu/ focal main\"</span> &gt;&gt; /etc/apt/sources.list.d/winehq.list</span><br><span class=\"line\"><span class=\"built_in\">exit</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt update</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"3\">\n<li>安装 wine 8.0。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Stable</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt install --install-recommends winehq-stable</span><br><span class=\"line\"><span class=\"comment\"># Develop</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt install --install-recommends winehq-devel</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"4\">\n<li>按照 5.0 中的设置选择 Windows 10。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">winecfg</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"SRIM\">SRIM<a class=\"header-anchor\" href=\"#SRIM\">¶</a></h2>\n<h3 id=\"SRIM-2008-与-2013\">SRIM 2008 与 2013<a class=\"header-anchor\" href=\"#SRIM-2008-与-2013\">¶</a></h3>\n<p>直接安装 SRIM 2013 会提示组件缺失，而按照官方教程去安装组件较为繁琐，而且可能失败。因此一个取巧的方法是先安装 SRIM 2008，这一版本的 SRIM 附带有自动安装程序，完成后卸载 2008 版本并<strong>保留相关组件</strong>，随后再安装 SRIM 2013。两个版本的下载地址如下：</p>\n<ul>\n<li><a href=\"http://www.srim.org/SRIM/SRIM-2008.e\">SRIM 2008</a></li>\n<li><a href=\"http://www.srim.org/SRIM/SRIM-2013-Std.e\">SRIM 2013</a></li>\n</ul>\n<p>下载完成之后，我们需要将其后缀名从 <code>e</code> 改为 <code>exe</code>，方便后续操作。</p>\n<h3 id=\"SRIM-2008-的安装\">SRIM 2008 的安装 <a class=\"header-anchor\" href=\"#SRIM-2008-的安装\">¶</a></h3>\n<ol>\n<li> 创建临时目录，下载安装包并运行命令提取安装包中的文件到目录中。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> srim08 &amp;&amp; <span class=\"built_in\">cd</span> ~/srim08</span><br><span class=\"line\">wget http://www.srim.org/SRIM/SRIM-2008.e</span><br><span class=\"line\"><span class=\"built_in\">mv</span> SRIM-2008.e SRIM-2008.exe</span><br><span class=\"line\">wine SRIM-2008.exe</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2023/10/12/652754583809a.png\" alt=\"提取 SRIM-2008 文件\" style=\"height:200px;\"></div><span class=\"image-caption\">提取 SRIM-2008 文件</span></div>\n<ol start=\"2\">\n<li>运行 <code>SETUP.exe</code> 进行安装，安装位置可以随意填写，例如 <code>~/.wine/drive_c/Program\\ Files/SRIM</code>。如果提示图标安装失败，选择 <code>Ignore</code> 即可。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">wine SETUP.exe</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2023/10/12/65277122f2257.png\" alt=\"设置安装路径\" style=\"height:200px;\"></div><span class=\"image-caption\">设置安装路径</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2023/10/12/6527850161c98.png\" alt=\"忽略错误\" style=\"height:100px;\"></div><span class=\"image-caption\">忽略错误</span></div>\n<ol start=\"3\">\n<li>检查组件是否安装到位，在 <code>~/.wine/drive_c/windows/syswow64</code> 目录中应当存在 4 个 <code>OCX</code> 文件。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">~/srim08 ❯ <span class=\"built_in\">ls</span> ~/.wine/drive_c/windows/syswow64 | rg OCX</span><br><span class=\"line\">.rw-r--r--   594Ki fox  fox   23 May  2000  COMCTL32.OCX</span><br><span class=\"line\">.rw-r--r--   137Ki fox  fox   23 May  2000  COMDLG32.OCX</span><br><span class=\"line\">.rw-r--r--   207Ki fox  fox   10 Mar  2004  RICHTX32.OCX</span><br><span class=\"line\">.rw-r--r--   204Ki fox  fox   31 Aug  2001  TABCTL32.OCX</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"4\">\n<li>卸载 SRIM 2008。运行命令打开管理器，选中 SRIM 进行卸载。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">wine uninstaller</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2023/10/12/652785737369d.png\" alt=\"移除 SRIM 2008\" style=\"height:200px;\"></div><span class=\"image-caption\">移除 SRIM 2008</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2023/10/12/652786600379c.png\" alt=\"保留组件\" style=\"height:200px;\"></div><span class=\"image-caption\">保留组件</span></div>\n<h3 id=\"SRIM-2013-的安装与配置\">SRIM 2013 的安装与配置 <a class=\"header-anchor\" href=\"#SRIM-2013-的安装与配置\">¶</a></h3>\n<ol>\n<li> 创建临时目录，下载安装包并运行命令提取安装包中的文件到目录中。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> srim13 &amp;&amp; <span class=\"built_in\">cd</span> ~/srim13</span><br><span class=\"line\">wget http://www.srim.org/SRIM/SRIM-2013-Std.e</span><br><span class=\"line\"><span class=\"built_in\">mv</span> SRIM-2013-Std.e SRIM-2013-Std.exe</span><br><span class=\"line\">wine SRIM-2013-Std.exe</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>测试能否正常运行。</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">wine SRIM.exe</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2023/10/12/6527870506f8a.jpg\" alt=\"SRIM 2013\" style=\"height:200px;\"></div><span class=\"image-caption\">SRIM 2013</span></div>\n<ol start=\"3\">\n<li>在 <code>.zshrc</code> （或者 <code>.bashrc</code>） 中添加指令。</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">alias srim=\"wine ~/srim13/SRIM.exe\"</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"问题\">问题 <a class=\"header-anchor\" href=\"#问题\">¶</a></h2>\n<ol>\n<li> 提示 <code>sh: 1: xdg-open: not found</code>，安装 <code>xdg-utils</code> <sup><a href=\"#参考资料\">[6]</a></sup></li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">sudo apt-get install xdg-utils</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://blog.csdn.net/m0_37921318/article/details/115915223\">Linux 虚拟机用 wine 安装仿真软件 SRIM</a></li>\n<li><a href=\"https://blog.csdn.net/ytzlln/article/details/82870037\">【离子注入】TRIM2013pro 仿真卡屏解决方法（win10）</a></li>\n<li><a href=\"https://appdb.winehq.org/objectManager.php?sClass=version&amp;iId=13202\">SRIM - wineHQ</a></li>\n<li><a href=\"https://wiki.winehq.org/Ubuntu_zhcn\">Ubuntu - wineHQ</a></li>\n<li><a href=\"https://mirrors-i.tuna.tsinghua.edu.cn/help/wine-builds/\">Wine builds 软件仓库镜像使用帮助</a></li>\n<li><a href=\"https://askubuntu.com/questions/704712/in-ubuntu-xdg-open-command-is-not-working\">In Ubuntu, xdg-open command is not working</a></li>\n</ol>\n<!-- 6. [Wine Mono 环境安装并运行.Net WPF](https://blog.csdn.net/x740073529/article/details/119461344)\n7. [[分享]终于解决了wine慢的问题](https://forum.ubuntu.com.cn/viewtopic.php?t=18727) -->\n","categories":["软件/程序"],"tags":["教程","核技术","SRIM"]},{"title":"CERN ROOT 的 Jupyter 环境","url":"/posts/202309-root-jupyter.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>ROOT 是由 CERN 开发的用于实验大数据处理的框架，主要应用于核物理和高能物理领域。ROOT 主要由 C++ 编写，但较新版本中也提供了 Python 的借口，通过引入 <code>pyroot</code> 实现。</p>\n<p>一般而言，通常在命令行输入 <code>root</code> 后，通过 <code>TBrowser</code> 浏览文件；或者使用 C++ 编写数据处理的函数，在 ROOT 中进行调用。而使用 Jupyter 来编写 ROOT 程序在学习和开发阶段较为便利。由于预编译版本的 ROOT 已经绑定了特定 Python 版本，有可能与本机的 Python 版本不匹配，所以通过源代码编译安装的方式能够避免绝大部分的兼容性问题。</p>\n<h2 id=\"安装\">安装 <a class=\"header-anchor\" href=\"#安装\">¶</a></h2>\n<div class=\"note info flat\"><p><strong>本机环境</strong><br>\nUbuntu 20.04.6<br>\nPython 3.10.11</p>\n</div>\n<p>目前 ROOT 的最新版本为 6.28，但为了兼容本机上的 Garfield Plus Plus，因此选择 6.26 版本。在 <a href=\"https://root.cern/install/all_releases/\">ROOT Releases</a> 页面下载对应版本的安装包。</p>\n<h3 id=\"依赖\">依赖 <a class=\"header-anchor\" href=\"#依赖\">¶</a></h3>\n<p>在 <a href=\"https://root.cern/install/dependencies\">ROOT Install Dependencies</a> 查看对应系统版本要求的依赖，对于 Ubuntu 使用一行命令解决必备依赖：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> apt-get install dpkg-dev cmake g++ gcc binutils libx11-dev libxpm-dev \\</span><br><span class=\"line\">libxft-dev libxext-dev python libssl-dev</span><br></pre></td></tr></tbody></table></figure>\n<p>其余推荐依赖按照需求进行安装，我只需要 ROOT 的基础功能，因此没有安装其他依赖，在后续编译过程中可以设置部分编译选项加快速度。此外推荐安装 <code>ccmake</code> 方便后续编译。</p>\n<h3 id=\"编译\">编译 <a class=\"header-anchor\" href=\"#编译\">¶</a></h3>\n<p>解压下载好的安装包，新建与安装包同级的目录 <code>build</code>，进入目录后进行编译安装：</p>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">tar -zxvf root_v6.26.10.source.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> build &amp;&amp; <span class=\"built_in\">cd</span> build</span><br><span class=\"line\">cmake -DCMAKE_INSTALL_PREFIX=<span class=\"variable\">$INSTALL_PREFIX</span> -DCMAKE_CXX_STANDARD=17 -DCXX_STANDARD_STRING=17 -Ddavix=OFF -Dfftw3=OFF -Dgdml=OFF -Dgfal=OFF -Dmysql=OFF -Doracle=OFF -Dpgsql=OFF -Dpythia6=OFF -Dpythia8=OFF -Dxml=OFF -Dbuiltin_zstd=ON -Dbuiltin_glew=ON -Dbuiltin_gl2ps=ON -Dbuiltin_xrootd=ON -Dbuiltin_ftgl=ON ../root-6.26.10</span><br><span class=\"line\">ccmake .</span><br></pre></td></tr></tbody></table></figure>\n<p><code>$INSTALL_PREFIX</code> 是需要安装到的目录，<code>CMAKE_CXX_STANDARD</code> 根据自己的 gcc 版本和需要来选择，可以通过以下命令查看：</p>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">&gt; gcc -E -dM - &lt;/dev/null | grep <span class=\"string\">\"STDC_VERSION\"</span></span><br><span class=\"line\"><span class=\"comment\">#define __STDC_VERSION__ 201710L</span></span><br></pre></td></tr></tbody></table></figure>\n<p><code>2017</code> 代表支持 c17 标准。<code>ccmake</code> 可以生成一个在命令行的简略界面方便我们对编译选项进行调整。调整完成后根据下方的提示操作，多次按 <code>c</code> 进行确认直至出现 <code>Press [g] ... </code>的提示，此时可以按 <code>g</code> 生成相关文件，随后进行编译安装：</p>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">make -j 12</span><br><span class=\"line\">make install -j 12</span><br></pre></td></tr></tbody></table></figure>\n<p><code>-j</code> 参数后面是使用的线程数，我的计算机有 8 核 16 线程，16GB 内存。不推荐使用全部线程，因为编译会占用很大内存，可能会导致编译失败，可以根据线程数和内存大小酌情调整。最后修改自己的 shell 配置文件（例如<code>.bashrc</code>，<code>.zshrc</code>），在适当位置添加：</p>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> <span class=\"variable\">$INSTALL_PREFIX</span>/bin/thisroot.sh</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"添加内核\">添加内核 <a class=\"header-anchor\" href=\"#添加内核\">¶</a></h3>\n<p>使用下列命令安装 Python 所需的包：</p>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">pip install jupyter metakernel</span><br></pre></td></tr></tbody></table></figure>\n<p>安装后有两种方式可以在 Jupyter 中使用 ROOT：</p>\n<ol>\n<li>ROOT-flavored 的 notebook</li>\n</ol>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">root --notebook</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>全功能的 Jupyter Lab（<strong>推荐</strong>）</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">cp -r $INSTALL_PREFIX/etc/notebook/kernels/root ~/.local/share/jupyter/kernels</span><br><span class=\"line\">jupyter lab</span><br></pre></td></tr></tbody></table></figure>\n<p>关于 Jupyter Lab 的相关配置，可以查看 <a href=\"/posts/202112-pyr_jupyter.html#%E6%9C%8D%E5%8A%A1%E4%B8%8E%E6%8F%92%E4%BB%B6\">服务与插件</a>。</p>\n<h3 id=\"试用\">试用 <a class=\"header-anchor\" href=\"#试用\">¶</a></h3>\n<p>一个在 Jupyter ROOT Block 中绘制直方图的示例：</p>\n<figure class=\"highlight c++\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">TCanvas c;</span><br><span class=\"line\"><span class=\"function\">TH1F <span class=\"title\">h</span><span class=\"params\">(<span class=\"string\">\"h\"</span>,<span class=\"string\">\"ROOT Histo;X;Y\"</span>,<span class=\"number\">64</span>,<span class=\"number\">-4</span>,<span class=\"number\">4</span>)</span></span>;</span><br><span class=\"line\">h.<span class=\"built_in\">FillRandom</span>(<span class=\"string\">\"gaus\"</span>);</span><br><span class=\"line\">h.<span class=\"built_in\">Draw</span>();</span><br><span class=\"line\">c.<span class=\"built_in\">Draw</span>();</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2023/09/20/650a62246e7d6.png\" alt=\"效果图\"></div><span class=\"image-caption\">效果图</span></div>\n<h2 id=\"问题\">问题 <a class=\"header-anchor\" href=\"#问题\">¶</a></h2>\n<ol>\n<li>WSL 中使用 <code>new TBrowser</code> 将会开启 HTTP 服务而不是窗口 <sup><a href=\"#参考资料\">[3]</a></sup><br>\n在家目录（例如 <code>/home/fox</code>）下创建 <code>.rootrc</code> 文件并写入：</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">Browser.Name: TRootBrowser</span><br></pre></td></tr></tbody></table></figure>\n<ol start=\"2\">\n<li>ROOT 6.28 版本以下使用 Python 3.11 及以上版本编译安装时报错 <sup><a href=\"#参考资料\">[4,5,6]</a></sup></li>\n</ol>\n<figure class=\"highlight c\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">[.....]/CPPOverload.cxx:<span class=\"number\">5</span>:<span class=\"number\">10</span>: fatal error: <span class=\"string\">'code.h'</span> file not found</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">\"code.h\"</span> <span class=\"comment\">// from Python</span></span></span><br><span class=\"line\">^~~~~~~~</span><br></pre></td></tr></tbody></table></figure>\n<p>修改 <code>CPPOverload.cxx</code> 文件，将原本的内容：</p>\n<figure class=\"highlight c++\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> PY_VERSION_HEX &gt;= 0x02050000</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">\"code.h\"</span>            <span class=\"comment\">// from Python</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">\"compile.h\"</span>         <span class=\"comment\">// from Python</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br></pre></td></tr></tbody></table></figure>\n<p>修改为：</p>\n<figure class=\"highlight c++\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> PY_VERSION_HEX &lt; 0x02050000</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">\"compile.h\"</span>         <span class=\"comment\">// from Python</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">elif</span> PY_VERSION_HEX &lt; 0x030b0000</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">\"code.h\"</span>            <span class=\"comment\">// from Python</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br></pre></td></tr></tbody></table></figure>\n<p>这是因为 Python 3.11 及以上版本将其移动到了 <code>Include/cpython</code> 中，已经被 <code>Python.h</code> 包含。</p>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://root.cern/install/build_from_source\">Building ROOT from source</a></li>\n<li><a href=\"https://github.com/root-project/root/tree/master/bindings/jupyroot\">JupyROOT</a></li>\n<li><a href=\"https://root-forum.cern.ch/t/tbrowser-wsl-starts-in-the-web-browser/45243\">TBrowser WSL starts in the web browser</a></li>\n<li><a href=\"https://root-forum.cern.ch/t/include-code-h-and-python-3-11/52425\">Include “code.h” and Python 3.11</a></li>\n<li><a href=\"https://github.com/root-project/root/pull/12501\">[v6-24][PyROOT] code.h must not be included directly in 3.11</a></li>\n<li><a href=\"https://docs.python.org/3.11/whatsnew/3.11.html\">What’s New In Python 3.11</a></li>\n<li><a href=\"https://root.cern.ch/notebooks/HowTos/HowTo_ROOT-Notebooks.html\">How to use ROOT in a Jupyter notebook</a></li>\n</ol>\n","categories":["软件/程序","Jupyter","ROOT"],"tags":["教程","Jupyter","核技术","ROOT"]},{"title":"排版工具 Typst 教程与 Snippets","url":"/posts/202401-typst.html","content":"<div class=\"note info flat\"><p>个人的自用模板代码可以查看 <a href=\"https://git.foolishfox.cn/fox/Typst-Snippets\">Typst-Snippets</a></p>\n</div>\n<p>Typst 是 2019 年才出现的使用 Rust 编写的基于标记的排版语言，定位在 Markdown、Word 等初级工具和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding=\"application/x-tex\">\\LaTeX</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.89883em;vertical-align:-0.2155em;\"></span><span class=\"mord text\"><span class=\"mord textrm\">L</span><span class=\"mspace\" style=\"margin-right:-0.36em;\"></span><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.68333em;\"><span style=\"top:-2.904999em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"mord\"><span class=\"mord textrm mtight sizing reset-size6 size3\">A</span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:-0.15em;\"></span><span class=\"mord text\"><span class=\"mord textrm\">T</span><span class=\"mspace\" style=\"margin-right:-0.1667em;\"></span><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.46782999999999997em;\"><span style=\"top:-2.7845em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord textrm\">E</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2155em;\"><span></span></span></span></span><span class=\"mspace\" style=\"margin-right:-0.125em;\"></span><span class=\"mord textrm\">X</span></span></span></span></span></span> 一类的高级工具之间，官方宣称其功能可以和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding=\"application/x-tex\">\\LaTeX</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.89883em;vertical-align:-0.2155em;\"></span><span class=\"mord text\"><span class=\"mord textrm\">L</span><span class=\"mspace\" style=\"margin-right:-0.36em;\"></span><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.68333em;\"><span style=\"top:-2.904999em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"mord\"><span class=\"mord textrm mtight sizing reset-size6 size3\">A</span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:-0.15em;\"></span><span class=\"mord text\"><span class=\"mord textrm\">T</span><span class=\"mspace\" style=\"margin-right:-0.1667em;\"></span><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.46782999999999997em;\"><span style=\"top:-2.7845em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord textrm\">E</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2155em;\"><span></span></span></span></span><span class=\"mspace\" style=\"margin-right:-0.125em;\"></span><span class=\"mord textrm\">X</span></span></span></span></span></span> 一样强大，但是和 Markdown 一样简单、易用，主要应用于数学、物理和工程方面（特别是包含大量公式、图表）的论文、文章、作业、书籍和报告的编写。</p>\n<h2 id=\"基础教程\">基础教程 <a class=\"header-anchor\" href=\"#基础教程\">¶</a></h2>\n<p>MacOS 和 Arch Linux 用户可以使用包管理器进行安装：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># macOS or Linux using Homebrew</span></span><br><span class=\"line\">brew install typst</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Arch Linux</span></span><br><span class=\"line\">pacman -S typst</span><br></pre></td></tr></tbody></table></figure>\n<p>具体支持的发行版本可以查看 <a href=\"#refer-5\">参考资料 (5)</a>。Ubuntu 目前还只能下载编译好的二进制文件，或者安装 Rust 后从源码编译进行安装。除此之外，还需要安装编辑器的插件实现代码提示、预览等功能，VS Code 上的主要插件有：</p>\n<ul>\n<li><a href=\"https://marketplace.visualstudio.com/items?itemName=nvarner.typst-lsp\">Typst LSP</a></li>\n<li><a href=\"https://marketplace.visualstudio.com/items?itemName=mgt19937.typst-preview\">Typst Preview</a></li>\n</ul>\n<p>除此之外，还有 <a href=\"https://marketplace.visualstudio.com/items?itemName=OrangeX4.vscode-typst-sympy-calculator\">Typst Sympy Calculator</a> 插件实现了和 Python 的 SymPy 库的联动，可以进行公式的转化和计算。</p>\n<p>对于从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding=\"application/x-tex\">\\LaTeX</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.89883em;vertical-align:-0.2155em;\"></span><span class=\"mord text\"><span class=\"mord textrm\">L</span><span class=\"mspace\" style=\"margin-right:-0.36em;\"></span><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.68333em;\"><span style=\"top:-2.904999em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"mord\"><span class=\"mord textrm mtight sizing reset-size6 size3\">A</span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:-0.15em;\"></span><span class=\"mord text\"><span class=\"mord textrm\">T</span><span class=\"mspace\" style=\"margin-right:-0.1667em;\"></span><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.46782999999999997em;\"><span style=\"top:-2.7845em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord textrm\">E</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2155em;\"><span></span></span></span></span><span class=\"mspace\" style=\"margin-right:-0.125em;\"></span><span class=\"mord textrm\">X</span></span></span></span></span></span> 和 Markdown 迁移过来的用户，绝大部分语法内容都可以新学习，比较重要的区别有：</p>\n<ol>\n<li>公式中命令不需要 <code>\\</code> 开头，直接使用即可，例如使用 <code>$e^(pi eta)$</code> 显示 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>e</mi><mrow><mi>π</mi><mi>η</mi></mrow></msup></mrow><annotation encoding=\"application/x-tex\">e^{\\pi\\eta}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.664392em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">π</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">η</span></span></span></span></span></span></span></span></span></span></span></span>，要在公式中显示成段的，不是命令的字符，可以使用 <code>\"</code> 包裹起来。更具体而言，Typst 区分两种模式：「标记模式」和「代码模式」，前者是正常的文本模式，类似于 Markdown 的编写逻辑，后者以 <code>#</code> 开头，在该模式内的命令省略 <code>#</code>（个人认为，公式是一种特殊的代码模式，命令在公式中也可以省略 <code>#</code>）</li>\n<li>函数定义要求函数名 + 括号，参数可以是位置参数或者命名参数，格式为 <code>myfunc(keya: valuea, keyb: valueb)</code></li>\n<li>Typst 的代码模式十分强大，通过 <code>#if</code> 条件判断和 <code>#for</code> 循环语句，可以实现 <a href=\"#refer-7\">参考资料 (7)</a> 中的效果：</li>\n</ol>\n<!-- autoplay=\"autoplay\" loop=\"loop\"  -->\n<p><video src=\"https://asset.foolishfox.cn/2024/01/04/typst.mp4\" controls=\"controls\" style=\"max-width: 100%;display: block;margin: auto;max-height: 400px;\">your browser does not support the video tag</video></p>\n<p>具体的内容可以查看 <a href=\"#refer-3\">参考资料 (3)</a>，入门的教程可以查看 <a href=\"#refer-2\">参考资料 (2)</a>，一些 Typst、Markdown 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>LaTeX</mtext></mrow><annotation encoding=\"application/x-tex\">\\LaTeX</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.89883em;vertical-align:-0.2155em;\"></span><span class=\"mord text\"><span class=\"mord textrm\">L</span><span class=\"mspace\" style=\"margin-right:-0.36em;\"></span><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.68333em;\"><span style=\"top:-2.904999em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"mord\"><span class=\"mord textrm mtight sizing reset-size6 size3\">A</span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:-0.15em;\"></span><span class=\"mord text\"><span class=\"mord textrm\">T</span><span class=\"mspace\" style=\"margin-right:-0.1667em;\"></span><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.46782999999999997em;\"><span style=\"top:-2.7845em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord textrm\">E</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2155em;\"><span></span></span></span></span><span class=\"mspace\" style=\"margin-right:-0.125em;\"></span><span class=\"mord textrm\">X</span></span></span></span></span></span> 之间的对比可以查看 <a href=\"#refer-7\">参考资料 (7)</a></p>\n<h2 id=\"常用代码\">常用代码 <a class=\"header-anchor\" href=\"#常用代码\">¶</a></h2>\n<h3 id=\"官方模组\">官方模组 <a class=\"header-anchor\" href=\"#官方模组\">¶</a></h3>\n<p>目前官方收录的模组可以在 <a href=\"https://typst.app/docs/packages/\">Typst Packages</a> 进行查询，此外还有 <a href=\"https://github.com/qjcg/awesome-typst\">Awesome Typst</a> 项目收录了很多实用了模组，下面列举了部分常用的模组，一些我进行了自定义的模组将会在 (<a href=\"#自定义模板\">下一小节</a>) 进行介绍。</p>\n<ol>\n<li><a href=\"https://github.com/OrangeX4/typst-pinit\">Pinit</a> 包用于创建批注，在制作 slides 的时候特别有用，效果如下：</li>\n</ol>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/04/65966b17c1a87.png\" alt=\"Pinit\" style=\"height:300px;\"></div><span class=\"image-caption\">Pinit</span></div>\n<ol start=\"2\">\n<li><a href=\"https://github.com/Leedehai/typst-physics\">Physics</a> 实现了向量、场、微分、导数、狄拉克符号等物理中常用符合的定义：</li>\n</ol>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/04/65966bb4944a9.png\" alt=\"Physics\" style=\"height:300px;\"></div><span class=\"image-caption\">Physics</span></div>\n<ol start=\"3\">\n<li><a href=\"https://github.com/Pablo-Gonzalez-Calderon/showybox-package\">Showybox</a> 可以创建自定义的彩色盒，可以用于定义、定理等场景：</li>\n</ol>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/04/65966cd4b1d0f.png\" alt=\"Showybox\" style=\"height:200px;\"></div><span class=\"image-caption\">Showybox</span></div>\n<ol start=\"4\">\n<li><a href=\"https://github.com/PgBiel/typst-tablex\">Tablex</a> 实现了高级的表格：</li>\n</ol>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/04/65966d37a9441.png\" alt=\"Tablex\" style=\"height:300px;\"></div><span class=\"image-caption\">Tablex</span></div>\n<ol start=\"5\">\n<li><a href=\"https://github.com/flavio20002/typst-orange-template\">Typst orange template</a> 使用 Typst 实现了 <a href=\"https://www.latextemplates.com/template/legrand-orange-book\">Legrand Orange Book</a>：</li>\n</ol>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/05/6596e1628f3d8.png\" alt=\"Typst orange template\" style=\"height:300px;\"></div><span class=\"image-caption\">Typst orange template</span></div>\n<ol start=\"6\">\n<li><a href=\"https://github.com/RubixDev/typst-i-figured\">i-figured</a> 实现了图表、公式的按章节编号，参见 (<a href=\"#论文\">论文</a>)</li>\n</ol>\n<h3 id=\"自定义模板\">自定义模板 <a class=\"header-anchor\" href=\"#自定义模板\">¶</a></h3>\n<h4 id=\"幻灯片\">幻灯片 <a class=\"header-anchor\" href=\"#幻灯片\">¶</a></h4>\n<p><a href=\"https://github.com/qjcg/awesome-typst\">Awesome Typst</a> 中推荐的幻灯片模板中，个人推荐使用 <a href=\"https://github.com/andreasKroepelin/polylux\">Polylux</a> 模板，提供了多种主题，目前我常用的是 [University] 主题，并进行了一定的修改。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/04/65966f57d4f07.png\" alt=\"封面\" style=\"height:300px;\"></div><span class=\"image-caption\">封面</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/04/65966f5838ad1.png\" alt=\"目录\" style=\"height:300px;\"></div><span class=\"image-caption\">目录</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/04/65966f589ecad.png\" alt=\"分栏\" style=\"height:300px;\"></div><span class=\"image-caption\">分栏</span></div>\n<ul>\n<li>给分栏页加入页眉和页脚 </li>\n</ul>\n<figure class=\"highlight typst\"><table><tbody><tr><td class=\"code\"><pre><span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"title function_\">matrix-slide</span><span class=\"punctuation\">(</span>\n  <span class=\"variable\">title</span><span class=\"punctuation\">:</span> <span class=\"keyword\">none</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">new-section</span><span class=\"punctuation\">:</span> <span class=\"keyword\">none</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">columns</span><span class=\"punctuation\">:</span> <span class=\"keyword\">none</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">rows</span><span class=\"punctuation\">:</span> <span class=\"keyword\">none</span><span class=\"punctuation\">,</span>\n  <span class=\"operator\">..</span><span class=\"variable\">bodies</span>\n<span class=\"punctuation\">)</span> <span class=\"operator\">=</span> <span class=\"punctuation\">{</span>\n  <span class=\"keyword\">let</span> <span class=\"variable\">header</span> <span class=\"operator\">=</span> <span class=\"punctuation\">{</span>\n    <span class=\"keyword\">set</span> <span class=\"title function_\">align</span><span class=\"punctuation\">(</span><span class=\"variable\">top</span><span class=\"punctuation\">)</span>\n    <span class=\"title function_\">grid</span><span class=\"punctuation\">(</span><span class=\"variable\">rows</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">(</span><span class=\"keyword\">auto</span><span class=\"punctuation\">,</span> <span class=\"keyword\">auto</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"variable\">row-gutter</span><span class=\"punctuation\">:</span> <span class=\"number\">3mm</span><span class=\"punctuation\">,</span> <span class=\"variable\">progress-barline</span><span class=\"punctuation\">,</span> <span class=\"title function_\">header-text</span><span class=\"punctuation\">(</span><span class=\"variable\">title</span><span class=\"punctuation\">:</span> <span class=\"variable\">title</span><span class=\"punctuation\">,</span> <span class=\"variable\">new-section</span><span class=\"punctuation\">:</span> <span class=\"variable\">new-section</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span>\n  <span class=\"punctuation\">}</span>\n\n  <span class=\"keyword\">let</span> <span class=\"variable\">footer</span> <span class=\"operator\">=</span> <span class=\"punctuation\">{</span>\n    <span class=\"keyword\">set</span> <span class=\"title function_\">text</span><span class=\"punctuation\">(</span><span class=\"variable\">size</span><span class=\"punctuation\">:</span> <span class=\"number\">10pt</span><span class=\"punctuation\">)</span>\n    <span class=\"keyword\">set</span> <span class=\"title function_\">align</span><span class=\"punctuation\">(</span><span class=\"variable\">center</span> <span class=\"operator\">+</span> <span class=\"variable\">bottom</span><span class=\"punctuation\">)</span>\n    <span class=\"keyword\">let</span> <span class=\"title function_\">cell</span><span class=\"punctuation\">(</span><span class=\"variable\">fill</span><span class=\"punctuation\">:</span> <span class=\"keyword\">none</span><span class=\"punctuation\">,</span> <span class=\"variable\">it</span><span class=\"punctuation\">)</span> <span class=\"operator\">=</span> <span class=\"title function_\">rect</span><span class=\"punctuation\">(</span>\n      <span class=\"variable\">width</span><span class=\"punctuation\">:</span> <span class=\"number\">100%</span><span class=\"punctuation\">,</span> <span class=\"variable\">height</span><span class=\"punctuation\">:</span> <span class=\"number\">100%</span><span class=\"punctuation\">,</span> <span class=\"variable\">inset</span><span class=\"punctuation\">:</span> <span class=\"number\">1mm</span><span class=\"punctuation\">,</span> <span class=\"variable\">outset</span><span class=\"punctuation\">:</span> <span class=\"number\">0mm</span><span class=\"punctuation\">,</span> <span class=\"variable\">fill</span><span class=\"punctuation\">:</span> <span class=\"variable\">fill</span><span class=\"punctuation\">,</span> <span class=\"variable\">stroke</span><span class=\"punctuation\">:</span> <span class=\"keyword\">none</span><span class=\"punctuation\">,</span>\n      <span class=\"title function_\">align</span><span class=\"punctuation\">(</span><span class=\"variable\">horizon</span><span class=\"punctuation\">,</span> <span class=\"title function_\">text</span><span class=\"punctuation\">(</span><span class=\"variable\">fill</span><span class=\"punctuation\">:</span> <span class=\"variable\">white</span><span class=\"punctuation\">,</span> <span class=\"variable\">it</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span>\n    <span class=\"punctuation\">)</span>\n    <span class=\"title function_\">locate</span><span class=\"punctuation\">(</span> <span class=\"variable\">loc</span> <span class=\"operator\">=&gt;</span> <span class=\"punctuation\">{</span>\n      <span class=\"keyword\">let</span> <span class=\"variable\">colors</span> <span class=\"operator\">=</span> <span class=\"variable\">uni</span><span class=\"operator\">.</span><span class=\"variable\">uni-colors</span><span class=\"operator\">.</span><span class=\"title function_\">at</span><span class=\"punctuation\">(</span><span class=\"variable\">loc</span><span class=\"punctuation\">)</span>\n\n      <span class=\"keyword\">show</span><span class=\"punctuation\">:</span> <span class=\"variable\">block</span><span class=\"operator\">.</span><span class=\"title function_\">with</span><span class=\"punctuation\">(</span><span class=\"variable\">width</span><span class=\"punctuation\">:</span> <span class=\"number\">100%</span><span class=\"punctuation\">,</span> <span class=\"variable\">height</span><span class=\"punctuation\">:</span> <span class=\"keyword\">auto</span><span class=\"punctuation\">,</span> <span class=\"variable\">fill</span><span class=\"punctuation\">:</span> <span class=\"variable\">colors</span><span class=\"operator\">.</span><span class=\"variable\">b</span><span class=\"punctuation\">)</span>\n      <span class=\"title function_\">grid</span><span class=\"punctuation\">(</span>\n        <span class=\"variable\">columns</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">(</span><span class=\"number\">25%</span><span class=\"punctuation\">,</span> <span class=\"number\">1fr</span><span class=\"punctuation\">,</span> <span class=\"number\">15%</span><span class=\"punctuation\">,</span> <span class=\"number\">10%</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n        <span class=\"variable\">rows</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">(</span><span class=\"number\">1.5em</span><span class=\"punctuation\">,</span> <span class=\"keyword\">auto</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n        <span class=\"title function_\">cell</span><span class=\"punctuation\">(</span><span class=\"variable\">fill</span><span class=\"punctuation\">:</span> <span class=\"variable\">colors</span><span class=\"operator\">.</span><span class=\"variable\">a</span><span class=\"punctuation\">,</span> <span class=\"variable\">uni</span><span class=\"operator\">.</span><span class=\"variable\">uni-short-author</span><span class=\"operator\">.</span><span class=\"title function_\">display</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n        <span class=\"title function_\">cell</span><span class=\"punctuation\">(</span><span class=\"variable\">uni</span><span class=\"operator\">.</span><span class=\"variable\">uni-short-title</span><span class=\"operator\">.</span><span class=\"title function_\">display</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n        <span class=\"title function_\">cell</span><span class=\"punctuation\">(</span><span class=\"variable\">uni</span><span class=\"operator\">.</span><span class=\"variable\">uni-short-date</span><span class=\"operator\">.</span><span class=\"title function_\">display</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n        <span class=\"title function_\">cell</span><span class=\"punctuation\">(</span><span class=\"variable\">logic</span><span class=\"operator\">.</span><span class=\"variable\">logical-slide</span><span class=\"operator\">.</span><span class=\"title function_\">display</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> <span class=\"punctuation\">[</span><span class=\"char escape_\">~</span>/<span class=\"char escape_\">~</span><span class=\"punctuation\">]</span> <span class=\"operator\">+</span> <span class=\"variable\">utils</span><span class=\"operator\">.</span><span class=\"variable\">last-slide-number</span><span class=\"punctuation\">)</span>\n      <span class=\"punctuation\">)</span>\n    <span class=\"punctuation\">}</span><span class=\"punctuation\">)</span>\n  <span class=\"punctuation\">}</span>\n\n  <span class=\"keyword\">set</span> <span class=\"title function_\">page</span><span class=\"punctuation\">(</span>\n    <span class=\"variable\">margin</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">(</span> <span class=\"variable\">top</span><span class=\"punctuation\">:</span> <span class=\"number\">2em</span><span class=\"punctuation\">,</span> <span class=\"variable\">bottom</span><span class=\"punctuation\">:</span> <span class=\"number\">1em</span><span class=\"punctuation\">,</span> <span class=\"variable\">x</span><span class=\"punctuation\">:</span> <span class=\"number\">0em</span> <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">header</span><span class=\"punctuation\">:</span> <span class=\"variable\">header</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">footer</span><span class=\"punctuation\">:</span> <span class=\"variable\">footer</span><span class=\"punctuation\">,</span><span class=\"keyword\"></span>\n    <span class=\"variable\">footer-descent</span><span class=\"punctuation\">:</span> <span class=\"number\">0em</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">header-ascent</span><span class=\"punctuation\">:</span> <span class=\"number\">.6em</span><span class=\"punctuation\">,</span>\n  <span class=\"punctuation\">)</span>\n\n  <span class=\"variable\">uni</span><span class=\"operator\">.</span><span class=\"title function_\">matrix-slide</span><span class=\"punctuation\">(</span><span class=\"operator\">..</span><span class=\"variable\">bodies</span><span class=\"punctuation\">)</span>\n<span class=\"punctuation\">}</span></pre></td></tr></tbody></table></figure>\n<ul>\n<li>添加目录页 </li>\n</ul>\n<figure class=\"highlight typst\"><table><tbody><tr><td class=\"code\"><pre><span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"title function_\">slide-outline-length</span><span class=\"punctuation\">(</span><span class=\"variable\">loc</span><span class=\"punctuation\">)</span> <span class=\"operator\">=</span> <span class=\"punctuation\">{</span>\n  <span class=\"keyword\">let</span> <span class=\"variable\">section-state</span> <span class=\"operator\">=</span> <span class=\"title function_\">state</span><span class=\"punctuation\">(</span><span class=\"string\">\"polylux-sections\"</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span>\n  <span class=\"keyword\">let</span> <span class=\"variable\">sections</span> <span class=\"operator\">=</span> <span class=\"variable\">section-state</span><span class=\"operator\">.</span><span class=\"title function_\">final</span><span class=\"punctuation\">(</span><span class=\"variable\">loc</span><span class=\"punctuation\">)</span>\n  <span class=\"variable\">sections</span><span class=\"operator\">.</span><span class=\"title function_\">len</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">-</span> <span class=\"number\">1</span>\n<span class=\"punctuation\">}</span>\n\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"title function_\">slide-outline</span><span class=\"punctuation\">(</span><span class=\"variable\">num</span><span class=\"punctuation\">)</span> <span class=\"operator\">=</span> <span class=\"punctuation\">{</span>\n  <span class=\"keyword\">set</span> <span class=\"title function_\">text</span><span class=\"punctuation\">(</span><span class=\"variable\">font</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Cascadia Mono\"</span><span class=\"punctuation\">)</span>\n  <span class=\"title function_\">locate</span><span class=\"punctuation\">(</span><span class=\"variable\">loc</span> <span class=\"operator\">=&gt;</span> <span class=\"punctuation\">{</span>\n    <span class=\"keyword\">let</span> <span class=\"variable\">section-state</span> <span class=\"operator\">=</span> <span class=\"title function_\">state</span><span class=\"punctuation\">(</span><span class=\"string\">\"polylux-sections\"</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span>\n    <span class=\"keyword\">let</span> <span class=\"variable\">sections</span> <span class=\"operator\">=</span> <span class=\"variable\">section-state</span><span class=\"operator\">.</span><span class=\"title function_\">final</span><span class=\"punctuation\">(</span><span class=\"variable\">loc</span><span class=\"punctuation\">)</span>\n    <span class=\"keyword\">for</span> <span class=\"variable\">p</span> <span class=\"keyword\">in</span> <span class=\"title function_\">range</span><span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"variable\">num</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span>\n      <span class=\"keyword\">let</span> <span class=\"variable\">section</span> <span class=\"operator\">=</span> <span class=\"variable\">sections</span><span class=\"operator\">.</span><span class=\"title function_\">at</span><span class=\"punctuation\">(</span><span class=\"variable\">p</span><span class=\"punctuation\">)</span>\n      <span class=\"keyword\">let</span> <span class=\"variable\">content</span> <span class=\"operator\">=</span> <span class=\"punctuation\">{</span>\n        <span class=\"keyword\">let</span> <span class=\"variable\">url</span> <span class=\"operator\">=</span> <span class=\"title function_\">link</span><span class=\"punctuation\">(</span><span class=\"variable\">section</span><span class=\"operator\">.</span><span class=\"variable\">loc</span><span class=\"punctuation\">,</span> <span class=\"variable\">section</span><span class=\"operator\">.</span><span class=\"variable\">body</span><span class=\"punctuation\">)</span>\n        <span class=\"keyword\">let</span> <span class=\"variable\">page</span> <span class=\"operator\">=</span> <span class=\"variable\">logic</span><span class=\"operator\">.</span><span class=\"variable\">logical-slide</span><span class=\"operator\">.</span><span class=\"title function_\">at</span><span class=\"punctuation\">(</span><span class=\"variable\">section</span><span class=\"operator\">.</span><span class=\"variable\">loc</span><span class=\"punctuation\">)</span><span class=\"operator\">.</span><span class=\"title function_\">at</span><span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">)</span>\n        <span class=\"keyword\">let</span> <span class=\"variable\">length</span> <span class=\"operator\">=</span> <span class=\"number\">46</span> <span class=\"operator\">-</span> <span class=\"title function_\">str</span><span class=\"punctuation\">(</span><span class=\"variable\">page</span><span class=\"punctuation\">)</span><span class=\"operator\">.</span><span class=\"title function_\">len</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">-</span> <span class=\"title function_\">count-length</span><span class=\"punctuation\">(</span><span class=\"variable\">section</span><span class=\"operator\">.</span><span class=\"variable\">body</span><span class=\"punctuation\">)</span>\n        <span class=\"keyword\">let</span> <span class=\"variable\">dots</span> <span class=\"operator\">=</span> <span class=\"string\">\" \"</span> <span class=\"operator\">+</span> <span class=\"string\">\".\"</span> * <span class=\"title function_\">length</span>\n        <span class=\"punctuation\">[</span><span class=\"title function_\">#</span><span class=\"title function_\">grid</span><span class=\"punctuation\">(</span>\n          <span class=\"variable\">columns</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">(</span><span class=\"keyword\">auto</span><span class=\"punctuation\">,</span> <span class=\"number\">1fr</span><span class=\"punctuation\">,</span> <span class=\"number\">1fr</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n          <span class=\"variable\">url</span><span class=\"punctuation\">,</span> <span class=\"title function_\">align</span><span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">dots</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"title function_\">align</span><span class=\"punctuation\">(</span><span class=\"variable\">right</span><span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">page</span><span class=\"punctuation\">]</span>\n        <span class=\"punctuation\">)</span><span class=\"punctuation\">]</span>\n      <span class=\"punctuation\">}</span>\n      <span class=\"punctuation\">[</span><span class=\"bullet\">+</span> <span class=\"variable\">#</span><span class=\"variable\">content</span> <span class=\"punctuation\">]</span>\n    <span class=\"punctuation\">}</span>\n  <span class=\"punctuation\">}</span><span class=\"punctuation\">)</span>\n<span class=\"punctuation\">}</span></pre></td></tr></tbody></table></figure>\n<h4 id=\"论文\">论文 <a class=\"header-anchor\" href=\"#论文\">¶</a></h4>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/05/6596e1cb96028.png\" alt=\"LaPreprint\" style=\"height:400px;\"></div><span class=\"image-caption\">LaPreprint</span></div>\n<p><a href=\"https://github.com/LaPreprint/typst\">LaPreprint</a> 是一个很美观的预印本模板，主要适用于英文，为了适应一些中文的需求，个人做出了一些修改：</p>\n<ul>\n<li>增加目录与语言选项 </li>\n</ul>\n<figure class=\"highlight typst\"><table><tbody><tr><td class=\"code\"><pre><span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"title function_\">lapreprint</span><span class=\"punctuation\">(</span>\n  <span class=\"comment\">// ......</span>\n  <span class=\"comment\">// The outline</span>\n  <span class=\"variable\">outline-show</span><span class=\"punctuation\">:</span> <span class=\"literal\">true</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">outline-depth</span><span class=\"punctuation\">:</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span>\n  <span class=\"comment\">// Language of the document</span>\n  <span class=\"variable\">lang</span><span class=\"punctuation\">:</span> <span class=\"string\">\"en\"</span><span class=\"punctuation\">,</span>\n  <span class=\"comment\">// The paper's content.</span>\n  <span class=\"variable\">body</span>\n<span class=\"punctuation\">)</span> <span class=\"operator\">=</span> <span class=\"punctuation\">{</span>\n  <span class=\"comment\">// ......</span>\n  <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">outline-show</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span><span class=\"title function_\">outline</span><span class=\"punctuation\">(</span>\n    <span class=\"variable\">title</span><span class=\"punctuation\">:</span> <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">lang</span> <span class=\"operator\">==</span> <span class=\"string\">\"en\"</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span><span class=\"string\">\"Content\"</span><span class=\"punctuation\">}</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">{</span><span class=\"string\">\"目录\"</span><span class=\"punctuation\">}</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">indent</span><span class=\"punctuation\">:</span> <span class=\"number\">2em</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">depth</span><span class=\"punctuation\">:</span> <span class=\"variable\">outline-depth</span><span class=\"punctuation\">,</span>\n  <span class=\"punctuation\">)</span><span class=\"punctuation\">}</span>\n  <span class=\"comment\">// ......</span>\n<span class=\"punctuation\">}</span></pre></td></tr></tbody></table></figure>\n<ul>\n<li>修改页边距 </li>\n</ul>\n<figure class=\"highlight typst\"><table><tbody><tr><td class=\"code\"><pre><span class=\"comment\">// 首页 &amp; 目录页</span>\n<span class=\"title function_\">#</span><span class=\"title function_\">lapreprint</span><span class=\"punctuation\">(</span>\n  <span class=\"keyword\">set</span> <span class=\"title function_\">page</span><span class=\"punctuation\">(</span>\n    <span class=\"variable\">paper-size</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">margin</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">(</span><span class=\"variable\">left</span><span class=\"punctuation\">:</span> <span class=\"number\">20%</span><span class=\"punctuation\">,</span> <span class=\"variable\">bottom</span><span class=\"punctuation\">:</span> <span class=\"number\">1.5cm</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n  <span class=\"punctuation\">)</span>\n<span class=\"punctuation\">)</span>\n\n<span class=\"comment\">// 后续页</span>\n<span class=\"title function_\">#</span><span class=\"title function_\">lapreprint</span><span class=\"punctuation\">(</span>\n  <span class=\"keyword\">set</span> <span class=\"title function_\">page</span><span class=\"punctuation\">(</span>\n    <span class=\"variable\">paper-size</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">margin</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">(</span><span class=\"variable\">left</span><span class=\"punctuation\">:</span> <span class=\"keyword\">auto</span><span class=\"punctuation\">,</span> <span class=\"variable\">bottom</span><span class=\"punctuation\">:</span> <span class=\"number\">1.5cm</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n  <span class=\"punctuation\">)</span>\n<span class=\"punctuation\">)</span></pre></td></tr></tbody></table></figure>\n<ul>\n<li>中文显示 </li>\n</ul>\n<figure class=\"highlight typst\"><table><tbody><tr><td class=\"code\"><pre><span class=\"title function_\">#</span><span class=\"title function_\">lapreprint</span><span class=\"punctuation\">(</span>\n  <span class=\"keyword\">set</span> <span class=\"title function_\">page</span><span class=\"punctuation\">(</span>\n    <span class=\"comment\">// ......</span>\n    <span class=\"variable\">footer</span><span class=\"punctuation\">:</span> <span class=\"title function_\">block</span><span class=\"punctuation\">(</span>\n      <span class=\"comment\">// ......</span>\n                <span class=\"keyword\">if</span><span class=\"punctuation\">(</span><span class=\"variable\">date</span> <span class=\"operator\">!=</span> <span class=\"keyword\">none</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span>\n                  <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">lang</span> <span class=\"operator\">==</span> <span class=\"string\">\"en\"</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span>\n                    <span class=\"variable\">date</span><span class=\"operator\">.</span><span class=\"title function_\">display</span><span class=\"punctuation\">(</span><span class=\"string\">\"[month repr:short] [day], [year]\"</span><span class=\"punctuation\">)</span>\n                  <span class=\"punctuation\">}</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">{</span>\n                    <span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">date</span><span class=\"operator\">.</span><span class=\"title function_\">year</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> 年 <span class=\"variable\">#</span><span class=\"variable\">date</span><span class=\"operator\">.</span><span class=\"title function_\">month</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> 月 <span class=\"variable\">#</span><span class=\"variable\">date</span><span class=\"operator\">.</span><span class=\"title function_\">day</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> 日<span class=\"punctuation\">]</span>\n                  <span class=\"punctuation\">}</span>\n                <span class=\"punctuation\">}</span>\n      <span class=\"comment\">// ......</span>\n    <span class=\"punctuation\">)</span>\n  <span class=\"punctuation\">)</span>\n\n  <span class=\"comment\">// ......</span>\n  <span class=\"title function_\">place</span><span class=\"punctuation\">(</span>\n    <span class=\"comment\">// ......</span>\n              <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">lang</span> <span class=\"operator\">==</span> <span class=\"string\">\"en\"</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span>\n                <span class=\"title function_\">text</span><span class=\"punctuation\">(</span><span class=\"variable\">size</span><span class=\"punctuation\">:</span> <span class=\"number\">7pt</span><span class=\"punctuation\">,</span> <span class=\"variable\">d</span><span class=\"operator\">.</span><span class=\"variable\">date</span><span class=\"operator\">.</span><span class=\"title function_\">display</span><span class=\"punctuation\">(</span><span class=\"string\">\"[month repr:short] [day], [year]\"</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span>\n              <span class=\"punctuation\">}</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">{</span><span class=\"punctuation\">[</span>\n                <span class=\"keyword\">#</span><span class=\"keyword\">set</span> <span class=\"title function_\">text</span><span class=\"punctuation\">(</span><span class=\"number\">7pt</span><span class=\"punctuation\">)</span>\n                <span class=\"variable\">#</span><span class=\"variable\">d</span><span class=\"operator\">.</span><span class=\"variable\">date</span><span class=\"operator\">.</span><span class=\"title function_\">year</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span>-<span class=\"variable\">#</span><span class=\"variable\">d</span><span class=\"operator\">.</span><span class=\"variable\">date</span><span class=\"operator\">.</span><span class=\"title function_\">month</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span>-<span class=\"variable\">#</span><span class=\"variable\">d</span><span class=\"operator\">.</span><span class=\"variable\">date</span><span class=\"operator\">.</span><span class=\"title function_\">day</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span>\n              <span class=\"punctuation\">]</span><span class=\"punctuation\">}</span>\n    <span class=\"comment\">// ......</span>\n  <span class=\"punctuation\">)</span>\n\n  <span class=\"comment\">// ......</span>\n  <span class=\"keyword\">if</span> <span class=\"variable\">abstracts</span> <span class=\"operator\">!=</span> <span class=\"keyword\">none</span> <span class=\"punctuation\">{</span>\n    <span class=\"comment\">// ......</span>\n        <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">lang</span> <span class=\"operator\">==</span> <span class=\"string\">\"en\"</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span>\n          <span class=\"title function_\">text</span><span class=\"punctuation\">(</span><span class=\"variable\">fill</span><span class=\"punctuation\">:</span> <span class=\"variable\">theme</span><span class=\"punctuation\">,</span> <span class=\"variable\">weight</span><span class=\"punctuation\">:</span> <span class=\"string\">\"semibold\"</span><span class=\"punctuation\">,</span> <span class=\"string\">\"Keywords\"</span><span class=\"punctuation\">)</span>\n        <span class=\"punctuation\">}</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">{</span>\n          <span class=\"title function_\">text</span><span class=\"punctuation\">(</span><span class=\"variable\">fill</span><span class=\"punctuation\">:</span> <span class=\"variable\">theme</span><span class=\"punctuation\">,</span> <span class=\"variable\">weight</span><span class=\"punctuation\">:</span> <span class=\"string\">\"semibold\"</span><span class=\"punctuation\">,</span> <span class=\"string\">\"关键词\"</span><span class=\"punctuation\">)</span>\n        <span class=\"punctuation\">}</span>\n    <span class=\"comment\">// ......</span>\n  <span class=\"punctuation\">}</span>\n<span class=\"punctuation\">)</span></pre></td></tr></tbody></table></figure>\n<ul>\n<li>图表、公式编号，按章节区分 </li>\n</ul>\n<figure class=\"highlight typst\"><table><tbody><tr><td class=\"code\"><pre><span class=\"title function_\">#</span><span class=\"title function_\">lapreprint</span><span class=\"punctuation\">(</span>\n  <span class=\"comment\">// Configure i-figured</span>\n  <span class=\"keyword\">show</span> <span class=\"variable\">figure</span><span class=\"punctuation\">:</span> <span class=\"variable\">i-figured</span><span class=\"operator\">.</span><span class=\"variable\">show-figure</span>\n  <span class=\"keyword\">show</span> <span class=\"variable\">figure</span><span class=\"operator\">.</span><span class=\"title function_\">where</span><span class=\"punctuation\">(</span>\n    <span class=\"variable\">kind</span><span class=\"punctuation\">:</span> <span class=\"variable\">table</span>\n  <span class=\"punctuation\">)</span><span class=\"punctuation\">:</span> <span class=\"keyword\">set</span> <span class=\"variable\">figure</span><span class=\"operator\">.</span><span class=\"title function_\">caption</span><span class=\"punctuation\">(</span><span class=\"variable\">position</span><span class=\"punctuation\">:</span> <span class=\"variable\">top</span><span class=\"punctuation\">)</span>\n  <span class=\"keyword\">show</span> <span class=\"variable\">math</span><span class=\"operator\">.</span><span class=\"variable\">equation</span><span class=\"punctuation\">:</span> <span class=\"variable\">i-figured</span><span class=\"operator\">.</span><span class=\"variable\">show-equation</span>\n<span class=\"punctuation\">)</span></pre></td></tr></tbody></table></figure>\n<ul>\n<li>交叉引用 </li>\n</ul>\n<figure class=\"highlight typst\"><table><tbody><tr><td class=\"code\"><pre><span class=\"title function_\">#</span><span class=\"title function_\">lapreprint</span><span class=\"punctuation\">(</span>\n  <span class=\"comment\">// Configure Reference Link</span>\n  <span class=\"keyword\">show</span> <span class=\"variable\">link</span><span class=\"punctuation\">:</span> <span class=\"variable\">it</span> <span class=\"operator\">=&gt;</span> <span class=\"punctuation\">[</span><span class=\"title function_\">#</span><span class=\"title function_\">text</span><span class=\"punctuation\">(</span><span class=\"variable\">fill</span><span class=\"punctuation\">:</span> <span class=\"variable\">theme</span><span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">it</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span>\n  <span class=\"keyword\">show</span> <span class=\"variable\">ref</span><span class=\"punctuation\">:</span> <span class=\"variable\">it</span> <span class=\"operator\">=&gt;</span> <span class=\"punctuation\">[</span><span class=\"title function_\">#</span><span class=\"title function_\">text</span><span class=\"punctuation\">(</span><span class=\"variable\">fill</span><span class=\"punctuation\">:</span> <span class=\"variable\">theme</span><span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">it</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span>\n  <span class=\"keyword\">show</span> <span class=\"variable\">ref</span><span class=\"punctuation\">:</span> <span class=\"variable\">it</span> <span class=\"operator\">=&gt;</span> <span class=\"punctuation\">{</span>\n    <span class=\"keyword\">let</span> <span class=\"variable\">el</span> <span class=\"operator\">=</span> <span class=\"variable\">it</span><span class=\"operator\">.</span><span class=\"variable\">element</span>\n    <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">el</span> <span class=\"operator\">!=</span> <span class=\"keyword\">none</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span>\n      <span class=\"keyword\">let</span> <span class=\"variable\">fn</span> <span class=\"operator\">=</span> <span class=\"title function_\">repr</span><span class=\"punctuation\">(</span><span class=\"variable\">el</span><span class=\"operator\">.</span><span class=\"title function_\">func</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span>\n      <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">fn</span> <span class=\"operator\">==</span> <span class=\"string\">\"equation\"</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span><span class=\"title function_\">link</span><span class=\"punctuation\">(</span>\n        <span class=\"variable\">it</span><span class=\"operator\">.</span><span class=\"variable\">target</span><span class=\"punctuation\">,</span>\n        <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">lang</span> <span class=\"operator\">==</span> <span class=\"string\">\"en\"</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span><span class=\"string\">\"Eq.\"</span><span class=\"punctuation\">}</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">{</span><span class=\"string\">\"式 \"</span><span class=\"punctuation\">}</span> <span class=\"operator\">+</span> \n        <span class=\"title function_\">numbering</span><span class=\"punctuation\">(</span>\n          <span class=\"variable\">el</span><span class=\"operator\">.</span><span class=\"variable\">numbering</span><span class=\"punctuation\">,</span>\n          <span class=\"operator\">..</span><span class=\"title function_\">counter</span><span class=\"punctuation\">(</span><span class=\"variable\">math</span><span class=\"operator\">.</span><span class=\"variable\">equation</span><span class=\"punctuation\">)</span><span class=\"operator\">.</span><span class=\"title function_\">at</span><span class=\"punctuation\">(</span><span class=\"variable\">el</span><span class=\"operator\">.</span><span class=\"title function_\">location</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span>\n        <span class=\"punctuation\">)</span>\n      <span class=\"punctuation\">)</span><span class=\"punctuation\">}</span> <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">fn</span> <span class=\"operator\">==</span> <span class=\"string\">\"heading\"</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span><span class=\"title function_\">link</span><span class=\"punctuation\">(</span>\n        <span class=\"variable\">it</span><span class=\"operator\">.</span><span class=\"variable\">target</span><span class=\"punctuation\">,</span>\n        <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">lang</span> <span class=\"operator\">==</span> <span class=\"string\">\"en\"</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span><span class=\"string\">\"Section \"</span><span class=\"punctuation\">}</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">{</span><span class=\"string\">\"第 \"</span><span class=\"punctuation\">}</span> <span class=\"operator\">+</span> \n        <span class=\"title function_\">numbering</span><span class=\"punctuation\">(</span>\n          <span class=\"variable\">el</span><span class=\"operator\">.</span><span class=\"variable\">numbering</span><span class=\"punctuation\">,</span>\n          <span class=\"operator\">..</span><span class=\"title function_\">counter</span><span class=\"punctuation\">(</span><span class=\"variable\">heading</span><span class=\"punctuation\">)</span><span class=\"operator\">.</span><span class=\"title function_\">at</span><span class=\"punctuation\">(</span><span class=\"variable\">el</span><span class=\"operator\">.</span><span class=\"title function_\">location</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span>\n        <span class=\"punctuation\">)</span> <span class=\"operator\">+</span> <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">lang</span> <span class=\"operator\">==</span> <span class=\"string\">\"zh\"</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span><span class=\"string\">\" 节\"</span><span class=\"punctuation\">}</span>\n      <span class=\"punctuation\">)</span><span class=\"punctuation\">}</span>\n      <span class=\"keyword\">else</span> <span class=\"punctuation\">{</span> <span class=\"variable\">it</span> <span class=\"punctuation\">}</span>\n    <span class=\"punctuation\">}</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">{</span><span class=\"variable\">it</span><span class=\"punctuation\">}</span>\n  <span class=\"punctuation\">}</span>\n<span class=\"punctuation\">)</span></pre></td></tr></tbody></table></figure>\n<h4 id=\"其他\">其他 <a class=\"header-anchor\" href=\"#其他\">¶</a></h4>\n<ol>\n<li> 借助 <a href=\"https://github.com/PgBiel/typst-tablex\">Tablex</a> 可以实现三线表的样式：</li>\n</ol>\n<figure class=\"highlight typst\"><table><tbody><tr><td class=\"code\"><pre><span class=\"comment\">// 定义</span>\n<span class=\"keyword\">#</span><span class=\"keyword\">import</span> <span class=\"string\">\"@preview/tablex:0.0.6\"</span><span class=\"punctuation\">:</span> <span class=\"variable\">tablex</span><span class=\"punctuation\">,</span> <span class=\"variable\">rowspanx</span><span class=\"punctuation\">,</span> <span class=\"variable\">colspanx</span><span class=\"punctuation\">,</span> <span class=\"variable\">hlinex</span><span class=\"punctuation\">,</span> <span class=\"variable\">vlinex</span>\n\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"title function_\">three-line-table</span><span class=\"punctuation\">(</span><span class=\"variable\">columns</span><span class=\"punctuation\">,</span> <span class=\"variable\">headers</span><span class=\"punctuation\">,</span> <span class=\"variable\">contents</span><span class=\"punctuation\">,</span> <span class=\"variable\">caption</span><span class=\"punctuation\">,</span> <span class=\"variable\">lang</span><span class=\"punctuation\">:</span> <span class=\"string\">\"en\"</span><span class=\"punctuation\">,</span><span class=\"variable\">rows</span><span class=\"punctuation\">:</span> <span class=\"keyword\">auto</span><span class=\"punctuation\">)</span> <span class=\"operator\">=</span> <span class=\"punctuation\">{</span><span class=\"title function_\">figure</span><span class=\"punctuation\">(</span>\n  <span class=\"title function_\">tablex</span><span class=\"punctuation\">(</span>\n    <span class=\"variable\">columns</span><span class=\"punctuation\">:</span> <span class=\"variable\">columns</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">rows</span><span class=\"punctuation\">:</span> <span class=\"variable\">rows</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">align</span><span class=\"punctuation\">:</span> <span class=\"variable\">center</span> <span class=\"operator\">+</span> <span class=\"variable\">horizon</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">auto-lines</span><span class=\"punctuation\">:</span> <span class=\"literal\">false</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">repeat-header</span><span class=\"punctuation\">:</span> <span class=\"literal\">true</span><span class=\"punctuation\">,</span>\n    <span class=\"title function_\">hlinex</span><span class=\"punctuation\">(</span><span class=\"variable\">stroke</span><span class=\"punctuation\">:</span> <span class=\"number\">1.5pt</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n    <span class=\"operator\">..</span><span class=\"variable\">headers</span><span class=\"punctuation\">,</span>\n    <span class=\"title function_\">hlinex</span><span class=\"punctuation\">(</span><span class=\"variable\">stroke</span><span class=\"punctuation\">:</span> <span class=\"number\">0.75pt</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n    <span class=\"operator\">..</span><span class=\"variable\">contents</span><span class=\"punctuation\">,</span>\n    <span class=\"title function_\">hlinex</span><span class=\"punctuation\">(</span><span class=\"variable\">stroke</span><span class=\"punctuation\">:</span> <span class=\"number\">1.5pt</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n  <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">kind</span><span class=\"punctuation\">:</span> <span class=\"variable\">table</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">supplement</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"keyword\">#</span><span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">lang</span> <span class=\"operator\">==</span> <span class=\"string\">\"en\"</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span><span class=\"string\">\"Table\"</span><span class=\"punctuation\">}</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">{</span><span class=\"string\">\"表\"</span><span class=\"punctuation\">}</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">caption</span><span class=\"punctuation\">:</span> <span class=\"variable\">caption</span><span class=\"punctuation\">,</span>\n<span class=\"punctuation\">)</span><span class=\"punctuation\">}</span>\n\n<span class=\"comment\">// 使用</span>\n<span class=\"title function_\">#</span><span class=\"title function_\">three-line-table</span><span class=\"punctuation\">(</span>\n  <span class=\"number\">2</span><span class=\"punctuation\">,</span>\n  <span class=\"punctuation\">(</span><span class=\"punctuation\">[</span><span class=\"strong\">*</span><span class=\"strong\">参数</span><span class=\"strong\">*</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">[</span><span class=\"strong\">*</span><span class=\"strong\">结果</span><span class=\"strong\">*</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n  <span class=\"punctuation\">(</span>\n    <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">sin</span><span class=\"formula\">^</span><span class=\"formula\">2</span><span class=\"formula\">(</span><span class=\"formula\">2</span><span class=\"formula\"> </span><span class=\"formula\">theta</span><span class=\"formula\">_</span><span class=\"formula\">(</span><span class=\"formula\">12</span><span class=\"formula\">)</span><span class=\"formula\">)</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">0.857</span><span class=\"formula\"> </span><span class=\"formula\">pm</span><span class=\"formula\"> </span><span class=\"formula\">0.024</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span>\n    <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">sin</span><span class=\"formula\">^</span><span class=\"formula\">2</span><span class=\"formula\">(</span><span class=\"formula\">2</span><span class=\"formula\"> </span><span class=\"formula\">theta</span><span class=\"formula\">_</span><span class=\"formula\">(</span><span class=\"formula\">23</span><span class=\"formula\">)</span><span class=\"formula\">)</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">&gt;</span><span class=\"formula\"> </span><span class=\"formula\">0.95</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span>\n    <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">sin</span><span class=\"formula\">^</span><span class=\"formula\">2</span><span class=\"formula\">(</span><span class=\"formula\">2</span><span class=\"formula\"> </span><span class=\"formula\">theta</span><span class=\"formula\">_</span><span class=\"formula\">(</span><span class=\"formula\">13</span><span class=\"formula\">)</span><span class=\"formula\">)</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">0.098</span><span class=\"formula\"> </span><span class=\"formula\">pm</span><span class=\"formula\"> </span><span class=\"formula\">0.013</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span>\n    <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">Delta</span><span class=\"formula\">\\m</span><span class=\"formula\">_</span><span class=\"formula\">(</span><span class=\"formula\">12</span><span class=\"formula\">)</span><span class=\"formula\">^</span><span class=\"formula\">2</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">(</span><span class=\"formula\">7.50</span><span class=\"formula\"> </span><span class=\"formula\">pm</span><span class=\"formula\"> </span><span class=\"formula\">0.20</span><span class=\"formula\">)</span><span class=\"formula\"> </span><span class=\"formula\">times</span><span class=\"formula\"> </span><span class=\"formula\">10</span><span class=\"formula\">^</span><span class=\"formula\">(</span><span class=\"formula\">-</span><span class=\"formula\">5</span><span class=\"formula\">)</span><span class=\"formula\"> </span><span class=\"formula\">\"eV\"</span><span class=\"formula\">^</span><span class=\"formula\">2</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span>\n    <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">Delta</span><span class=\"formula\">\\m</span><span class=\"formula\">_</span><span class=\"formula\">(</span><span class=\"formula\">23</span><span class=\"formula\">)</span><span class=\"formula\">^</span><span class=\"formula\">2</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">0.00232</span><span class=\"formula\">_</span><span class=\"formula\">(</span><span class=\"formula\">-</span><span class=\"formula\">0.00008</span><span class=\"formula\">)</span><span class=\"formula\">^</span><span class=\"formula\">(</span><span class=\"formula\">+</span><span class=\"formula\">0.00012</span><span class=\"formula\">)</span><span class=\"formula\"> </span><span class=\"formula\">\"eV\"</span><span class=\"formula\">^</span><span class=\"formula\">2</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span>\n    <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">delta</span><span class=\"formula\">\\/</span><span class=\"formula\">pi</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">1.35</span><span class=\"formula\">_</span><span class=\"formula\">(</span><span class=\"formula\">-</span><span class=\"formula\">0.43</span><span class=\"formula\">)</span><span class=\"formula\">^</span><span class=\"formula\">(</span><span class=\"formula\">+</span><span class=\"formula\">0.64</span><span class=\"formula\">)</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span>\n  <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n  <span class=\"punctuation\">[</span>中微子振荡参数测量结果<span class=\"title function_\">#</span><span class=\"title function_\">super</span><span class=\"punctuation\">[</span><span class=\"variable\">@zqw2015daya</span> <span class=\"variable\">@zym2018daya</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span><span class=\"keyword\"></span>\n  <span class=\"variable\">lang</span><span class=\"punctuation\">:</span> <span class=\"string\">\"zh\"</span><span class=\"punctuation\">,</span>\n<span class=\"punctuation\">)</span> <span class=\"variable\">&lt;nu_para&gt;</span></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/05/6596e6d81be91.png\" alt=\"三线表\" style=\"height:300px;\"></div><span class=\"image-caption\">三线表</span></div>\n<ol start=\"2\">\n<li>公式块 </li>\n</ol>\n<figure class=\"highlight typst\"><table><tbody><tr><td class=\"code\"><pre><span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"title function_\">box-quote</span><span class=\"punctuation\">(</span><span class=\"variable\">body</span><span class=\"punctuation\">,</span> <span class=\"variable\">width</span><span class=\"punctuation\">:</span> <span class=\"number\">100%</span><span class=\"punctuation\">,</span> <span class=\"variable\">inset</span><span class=\"punctuation\">:</span> <span class=\"number\">5pt</span><span class=\"punctuation\">,</span> <span class=\"variable\">outset</span><span class=\"punctuation\">:</span> <span class=\"number\">0pt</span><span class=\"punctuation\">)</span> <span class=\"operator\">=</span> <span class=\"punctuation\">{</span><span class=\"title function_\">block</span><span class=\"punctuation\">(</span>\n  <span class=\"variable\">fill</span><span class=\"punctuation\">:</span> <span class=\"variable\">green</span><span class=\"operator\">.</span><span class=\"title function_\">lighten</span><span class=\"punctuation\">(</span><span class=\"number\">80%</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">width</span><span class=\"punctuation\">:</span> <span class=\"variable\">width</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">inset</span><span class=\"punctuation\">:</span> <span class=\"variable\">inset</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">outset</span><span class=\"punctuation\">:</span> <span class=\"variable\">outset</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">radius</span><span class=\"punctuation\">:</span> <span class=\"number\">4pt</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">stroke</span><span class=\"punctuation\">:</span> <span class=\"variable\">green</span><span class=\"operator\">.</span><span class=\"title function_\">darken</span><span class=\"punctuation\">(</span><span class=\"number\">60%</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">breakable</span><span class=\"punctuation\">:</span> <span class=\"literal\">true</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">body</span>\n<span class=\"punctuation\">)</span><span class=\"punctuation\">}</span>\n\n<span class=\"comment\">// 使用</span>\n<span class=\"title function_\">#</span><span class=\"title function_\">box-quote</span><span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">\n</span><span class=\"formula\">P</span><span class=\"formula\">_</span><span class=\"formula\">(</span><span class=\"formula\">nu</span><span class=\"formula\">_</span><span class=\"formula\">alpha</span><span class=\"formula\"> </span><span class=\"formula\">-&gt;</span><span class=\"formula\"> </span><span class=\"formula\">nu</span><span class=\"formula\">_</span><span class=\"formula\">beta</span><span class=\"formula\">)</span><span class=\"formula\"> </span><span class=\"formula\">approx</span><span class=\"formula\"> </span><span class=\"formula\">sin</span><span class=\"formula\">^</span><span class=\"formula\">(</span><span class=\"formula\">2</span><span class=\"formula\">)</span><span class=\"formula\">2</span><span class=\"formula\">theta</span><span class=\"formula\"> </span><span class=\"formula\">sin</span><span class=\"formula\">^</span><span class=\"formula\">(</span><span class=\"formula\">2</span><span class=\"formula\">)</span><span class=\"formula\">(</span><span class=\"formula\">(</span><span class=\"formula\">m</span><span class=\"formula\">_</span><span class=\"formula\">1</span><span class=\"formula\">^</span><span class=\"formula\">2</span><span class=\"formula\">-</span><span class=\"formula\">m</span><span class=\"formula\">_</span><span class=\"formula\">2</span><span class=\"formula\">^</span><span class=\"formula\">2</span><span class=\"formula\">)</span><span class=\"formula\">/</span><span class=\"formula\">(</span><span class=\"formula\">4</span><span class=\"formula\">p</span><span class=\"formula\">)</span><span class=\"formula\">t</span><span class=\"formula\">)</span><span class=\"formula\"> </span><span class=\"formula\">approx</span><span class=\"formula\"> </span><span class=\"formula\">sin</span><span class=\"formula\">^</span><span class=\"formula\">(</span><span class=\"formula\">2</span><span class=\"formula\">)</span><span class=\"formula\">2</span><span class=\"formula\">theta</span><span class=\"formula\"> </span><span class=\"formula\">sin</span><span class=\"formula\">^</span><span class=\"formula\">(</span><span class=\"formula\">2</span><span class=\"formula\">)</span><span class=\"formula\">(</span><span class=\"formula\">Delta</span><span class=\"formula\">\\m</span><span class=\"formula\">^</span><span class=\"formula\">2</span><span class=\"formula\"> </span><span class=\"formula\">L</span><span class=\"formula\">/</span><span class=\"formula\">(</span><span class=\"formula\">4</span><span class=\"formula\">E</span><span class=\"formula\">)</span><span class=\"formula\">)</span><span class=\"formula\">\n</span><span class=\"punctuation\">$</span> <span class=\"variable\">&lt;2flavor_mix_4&gt;</span><span class=\"punctuation\">]</span></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/05/6596e74850568.png\" alt=\"公式块\" style=\"width:80%;\"></div><span class=\"image-caption\">公式块</span></div>\n<ol start=\"3\">\n<li>数学符号的简易别名 </li>\n</ol>\n<figure class=\"highlight typst\"><table><tbody><tr><td class=\"code\"><pre><span class=\"keyword\">#</span><span class=\"keyword\">import</span> <span class=\"string\">\"@preview/physica:0.9.0\"</span> <span class=\"keyword\">as</span> <span class=\"variable\">ph</span>\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"variable\">sp</span> <span class=\"operator\">=</span> <span class=\"punctuation\">[</span><span class=\"title function_\">#</span><span class=\"title function_\">h</span><span class=\"punctuation\">(</span><span class=\"number\">0.5em</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span>\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"variable\">pm</span> <span class=\"operator\">=</span> <span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">sym</span><span class=\"operator\">.</span><span class=\"variable\">plus</span><span class=\"operator\">.</span><span class=\"variable\">minus</span><span class=\"punctuation\">]</span>\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"variable\">le</span> <span class=\"operator\">=</span> <span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">sym</span><span class=\"operator\">.</span><span class=\"variable\">lt</span><span class=\"operator\">.</span><span class=\"variable\">eq</span><span class=\"operator\">.</span><span class=\"variable\">slant</span><span class=\"punctuation\">]</span>\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"variable\">ge</span> <span class=\"operator\">=</span> <span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">sym</span><span class=\"operator\">.</span><span class=\"variable\">gt</span><span class=\"operator\">.</span><span class=\"variable\">eq</span><span class=\"operator\">.</span><span class=\"variable\">slant</span><span class=\"punctuation\">]</span>\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"variable\">sim</span> <span class=\"operator\">=</span> <span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">sym</span><span class=\"operator\">.</span><span class=\"variable\">tilde</span><span class=\"operator\">.</span><span class=\"variable\">op</span><span class=\"punctuation\">]</span>\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"variable\">inf</span> <span class=\"operator\">=</span> <span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">sym</span><span class=\"operator\">.</span><span class=\"variable\">infinity</span><span class=\"punctuation\">]</span>\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"title function_\">rm</span><span class=\"punctuation\">(</span><span class=\"variable\">body</span><span class=\"punctuation\">)</span> <span class=\"operator\">=</span> <span class=\"punctuation\">{</span><span class=\"variable\">math</span><span class=\"operator\">.</span><span class=\"title function_\">upright</span><span class=\"punctuation\">(</span><span class=\"variable\">body</span><span class=\"punctuation\">)</span><span class=\"punctuation\">}</span>\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"title function_\">iso</span><span class=\"punctuation\">(</span><span class=\"variable\">b</span><span class=\"punctuation\">,</span> <span class=\"variable\">A</span><span class=\"punctuation\">)</span> <span class=\"operator\">=</span> <span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">ph</span><span class=\"operator\">.</span><span class=\"title function_\">isotope</span><span class=\"punctuation\">(</span><span class=\"variable\">b</span><span class=\"punctuation\">,</span> <span class=\"variable\">a</span><span class=\"punctuation\">:</span> <span class=\"variable\">A</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span>\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"title function_\">isoz</span><span class=\"punctuation\">(</span><span class=\"variable\">b</span><span class=\"punctuation\">,</span> <span class=\"variable\">A</span><span class=\"punctuation\">,</span> <span class=\"variable\">Z</span><span class=\"punctuation\">)</span> <span class=\"operator\">=</span> <span class=\"punctuation\">[</span><span class=\"variable\">#</span><span class=\"variable\">ph</span><span class=\"operator\">.</span><span class=\"title function_\">isotope</span><span class=\"punctuation\">(</span><span class=\"variable\">b</span><span class=\"punctuation\">,</span> <span class=\"variable\">a</span><span class=\"punctuation\">:</span> <span class=\"variable\">A</span><span class=\"punctuation\">,</span> <span class=\"variable\">z</span><span class=\"punctuation\">:</span> <span class=\"variable\">Z</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span>\n\n<span class=\"comment\">// 使用</span>\n<span class=\"title function_\">#</span><span class=\"title function_\">box-quote</span><span class=\"punctuation\">[</span><span class=\"punctuation\">$</span><span class=\"formula\">\n</span><span class=\"formula\">1</span><span class=\"formula\"> </span><span class=\"formula\">pm</span><span class=\"formula\"> </span><span class=\"formula\">2</span><span class=\"formula\"> </span><span class=\"formula\">le</span><span class=\"formula\"> </span><span class=\"formula\">3</span><span class=\"formula\"> </span><span class=\"formula\">ge</span><span class=\"formula\"> </span><span class=\"formula\">4</span><span class=\"formula\"> </span><span class=\"formula\">sim</span><span class=\"formula\"> </span><span class=\"formula\">5</span><span class=\"formula\"> </span><span class=\"formula\">inf</span><span class=\"formula\"> </span><span class=\"formula\">6</span><span class=\"formula\"> </span><span class=\"formula\">sp</span><span class=\"formula\"> </span><span class=\"formula\">rm</span><span class=\"formula\">(</span><span class=\"formula\">A</span><span class=\"formula\">\\b</span><span class=\"formula\">)</span><span class=\"formula\"> </span><span class=\"formula\">sp</span><span class=\"formula\"> </span><span class=\"formula\">7</span><span class=\"formula\"> </span><span class=\"formula\">sp</span><span class=\"formula\"> </span><span class=\"formula\">\"Ab\"</span><span class=\"formula\"> </span><span class=\"formula\">8</span><span class=\"formula\"> </span><span class=\"formula\">sp</span><span class=\"formula\"> </span><span class=\"formula\">iso</span><span class=\"formula\">(</span><span class=\"formula\">U</span><span class=\"formula\">,</span><span class=\"formula\"> </span><span class=\"formula\">235</span><span class=\"formula\">)</span><span class=\"formula\"> </span><span class=\"formula\">sp</span><span class=\"formula\"> </span><span class=\"formula\">9</span><span class=\"formula\"> </span><span class=\"formula\">sp</span><span class=\"formula\"> </span><span class=\"formula\">isoz</span><span class=\"formula\">(</span><span class=\"formula\">L</span><span class=\"formula\">\\i</span><span class=\"formula\">,</span><span class=\"formula\"> </span><span class=\"formula\">7</span><span class=\"formula\">,</span><span class=\"formula\"> </span><span class=\"formula\">3</span><span class=\"formula\">)</span><span class=\"formula\">\n</span><span class=\"punctuation\">$</span><span class=\"punctuation\">]</span></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/01/05/6596e8661e0e6.png\" alt=\"数学符号\" style=\"width:80%;\"></div><span class=\"image-caption\">数学符号</span></div>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><span id=\"refer-1\"><a href=\"https://github.com/typst/typst\">Typst</a></span></li>\n<li><span id=\"refer-2\"><a href=\"https://typst.app/docs\">Documentation</a></span></li>\n<li><span id=\"refer-3\"><a href=\"https://zhuanlan.zhihu.com/p/646119837\">为 LaTeX 用户准备的 Typst 入门</a></span></li>\n<li><span id=\"refer-4\"><a href=\"https://www.el42.cc/posts/typst-tablex-usage/\">Typst Tablex 简单教程</a></span></li>\n<li><span id=\"refer-5\"><a href=\"https://repology.org/project/typst/versions\">Typst on Repology</a></span></li>\n<li><span id=\"refer-6\"><a href=\"https://typst-doc-cn.github.io/docs/chinese/\">中文用户指南</a></span></li>\n<li><span id=\"refer-7\"><a href=\"https://zhuanlan.zhihu.com/p/618910802\">Typst-\"超越\"LaTeX 的文档排版工具</a></span></li>\n<li><span id=\"refer-8\"><a href=\"https://sitandr.github.io/typst-examples-book/book/\">Typst Examples Book</a></span></li>\n</ol>\n","categories":["软件/程序"],"tags":["教程","typst"]},{"title":"Hexo 配置 Typst 代码高亮","url":"/posts/202402-typst-block.html","content":"<p><code>Hexo</code> 处理的代码块会被包裹在 <code>figure table tbody tr &gt; td.code pre</code> 中，每一行代码又被 <code>span</code> 包裹，如果需要加入对 <code>Typst</code> 的支持，需要将所有的代码重新提取出来，处理后之后再填入，有两种方法可以选择：</p>\n<ol>\n<li>前端修改：在 <code>html</code> 页面中读取代码块元素，提取代码处理后再填入 <sup><a href=\"#refer-1\">(1)</a></sup></li>\n<li><a href=\"#%E6%A0%87%E7%AD%BE%E6%8F%92%E4%BB%B6\">标签插件（<strong>推荐</strong>）</a>：在 <code>hexo</code> 生成的过程中使用标签插件 <sup><a href=\"#refer-2\">(2)</a></sup> 处理</li>\n</ol>\n<h2 id=\"前端修改\">前端修改 <a class=\"header-anchor\" href=\"#前端修改\">¶</a></h2>\n<div class=\"note danger flat\"><p>此方法可能需要刷新才能正常显示<br>\n此方法会将所有的 <code>plaintext</code> 识别为 <code>typst</code>，可以通过在第一行加一行说明语言来处理</p>\n</div>\n<h3 id=\"引入js文件\">引入 <code>js</code> 文件 <a class=\"header-anchor\" href=\"#引入js文件\">¶</a></h3>\n<figure class=\"highlight html\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">crossorigin</span>=<span class=\"string\">\"anonymous\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"https://foolishfox.cn/js/hl.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">id</span>=<span class=\"string\">\"script-main\"</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">src</span>=<span class=\"string\">\"https://cdn.jsdelivr.net/npm/@myriaddreamin/highlighter-typst/dist/cjs/contrib/hljs/typst.bundle.js\"</span></span></span><br><span class=\"line\"><span class=\"tag\">&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"注册-Typst\">注册 <code>Typst</code><a class=\"header-anchor\" href=\"#注册-Typst\">¶</a></h3>\n<figure class=\"highlight javascript\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">run</span> = (<span class=\"params\"></span>) =&gt; {</span><br><span class=\"line\">    $typst$parserModule.<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> {</span><br><span class=\"line\">        hljs.<span class=\"title function_\">registerLanguage</span>(</span><br><span class=\"line\">            <span class=\"string\">'typst'</span>,</span><br><span class=\"line\">            <span class=\"variable language_\">window</span>.<span class=\"title function_\">hljsTypst</span>({</span><br><span class=\"line\">                <span class=\"attr\">codeBlockDefaultLanguage</span>: <span class=\"string\">'typst'</span>,</span><br><span class=\"line\">            }),</span><br><span class=\"line\">        );</span><br><span class=\"line\">        hljs.<span class=\"title function_\">configure</span>({</span><br><span class=\"line\">            <span class=\"attr\">classPrefix</span>: <span class=\"string\">''</span> <span class=\"comment\">// don't append class prefix</span></span><br><span class=\"line\">        });</span><br><span class=\"line\">    }).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> {</span><br><span class=\"line\">        <span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelectorAll</span>(<span class=\"string\">'figure table tbody tr &gt; td.code pre'</span>).<span class=\"title function_\">forEach</span>(<span class=\"function\"><span class=\"params\">el</span> =&gt;</span> {</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!el.<span class=\"title function_\">getAttribute</span>(<span class=\"string\">'data-highlighted'</span>)) {</span><br><span class=\"line\">                <span class=\"keyword\">var</span> pre = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"pre\"</span>);</span><br><span class=\"line\">                <span class=\"keyword\">var</span> lang = el.<span class=\"property\">parentNode</span>.<span class=\"property\">parentNode</span>.<span class=\"property\">parentNode</span>.<span class=\"property\">parentNode</span>.<span class=\"property\">parentNode</span>.<span class=\"property\">classList</span>[<span class=\"number\">1</span>];</span><br><span class=\"line\">                <span class=\"keyword\">var</span> code = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; el.<span class=\"property\">childElementCount</span>; i++){</span><br><span class=\"line\">                    ch = el.<span class=\"property\">children</span>[i];</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (ch.<span class=\"property\">tagName</span> == <span class=\"string\">\"SPAN\"</span>) code += ch.<span class=\"property\">textContent</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (ch.<span class=\"property\">tagName</span> == <span class=\"string\">\"BR\"</span>) code += <span class=\"string\">\"\\n\"</span>;</span><br><span class=\"line\">                }</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (lang == <span class=\"string\">\"plaintext\"</span>) {</span><br><span class=\"line\">                    lang = <span class=\"string\">\"typst\"</span>;</span><br><span class=\"line\">                }</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (lang != <span class=\"string\">\"plaintext\"</span>) {</span><br><span class=\"line\">                    el.<span class=\"property\">innerHTML</span> = hljs.<span class=\"title function_\">highlight</span>(code, {<span class=\"attr\">language</span>: lang}).<span class=\"property\">value</span></span><br><span class=\"line\">                }</span><br><span class=\"line\">            }</span><br><span class=\"line\">        });</span><br><span class=\"line\">    });</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"title function_\">run</span>();</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"标签插件\">标签插件 <a class=\"header-anchor\" href=\"#标签插件\">¶</a></h2>\n<div class=\"note info flat\"><p>文件下载：</p>\n<ul>\n<li><a href=\"https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.js\">typst.js</a> <sup> 修改自 <a href=\"#refer-4\">(4)</a></sup></li>\n<li><a href=\"https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.bundle.js\">typst.bundle.js</a> <sup> 修改自 <a href=\"#refer-3\">(3)</a></sup><br>\n下载后放置在 <code>Hexo</code> 根目录下的 <code>scripts</code> 目录中</li>\n</ul>\n</div>\n<p>查看 <code>Hexo</code> 原生处理代码块的逻辑 <sup><a href=\"#refer-4\">(4)</a></sup>：</p>\n<figure class=\"highlight js\"><figcaption><span>register</span><a href=\"https://github.com/hexojs/hexo/blob/master/lib/plugins/tag/index.ts\">plugins/tag/index.ts</a></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> code = <span class=\"built_in\">require</span>(<span class=\"string\">'./code'</span>)(ctx);</span><br><span class=\"line\"></span><br><span class=\"line\">tag.<span class=\"title function_\">register</span>(<span class=\"string\">'code'</span>, code, <span class=\"literal\">true</span>);</span><br><span class=\"line\">tag.<span class=\"title function_\">register</span>(<span class=\"string\">'codeblock'</span>, code, <span class=\"literal\">true</span>);</span><br></pre></td></tr></tbody></table></figure>\n<p>在 <code>code</code> 模块中，先对传入的参数进行了解析，然后再调用 <code>hexo-utils</code> 的 <code>highlight</code> 进行渲染：</p>\n<figure class=\"highlight js\"><figcaption><span>code</span><a href=\"https://github.com/hexojs/hexo/blob/master/lib/plugins/tag/code.ts\">plugins/tag/code.ts</a></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">parseArgs</span>(<span class=\"params\">args: string[]</span>): <span class=\"title class_\">HighlightOptions</span> {</span><br><span class=\"line\">  ......</span><br><span class=\"line\">  <span class=\"keyword\">return</span> {</span><br><span class=\"line\">    lang,</span><br><span class=\"line\">    language_attr,</span><br><span class=\"line\">    firstLine,</span><br><span class=\"line\">    caption,</span><br><span class=\"line\">    line_number,</span><br><span class=\"line\">    line_threshold,</span><br><span class=\"line\">    mark,</span><br><span class=\"line\">    wrap</span><br><span class=\"line\">  };</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = <span class=\"function\"><span class=\"params\">ctx</span> =&gt;</span> <span class=\"keyword\">function</span> <span class=\"title function_\">codeTag</span>(<span class=\"params\">args, content</span>) {</span><br><span class=\"line\">    ......</span><br><span class=\"line\">    <span class=\"keyword\">const</span> options = <span class=\"title function_\">parseArgs</span>(args);</span><br><span class=\"line\">    options.<span class=\"property\">lines_length</span> = content.<span class=\"title function_\">split</span>(<span class=\"string\">'\\n'</span>).<span class=\"property\">length</span>;</span><br><span class=\"line\">    content = ctx.<span class=\"property\">extend</span>.<span class=\"property\">highlight</span>.<span class=\"title function_\">exec</span>(ctx.<span class=\"property\">config</span>.<span class=\"property\">syntax_highlighter</span>, {</span><br><span class=\"line\">        <span class=\"attr\">context</span>: ctx,</span><br><span class=\"line\">        <span class=\"attr\">args</span>: [content, options]</span><br><span class=\"line\">    });</span><br><span class=\"line\">    <span class=\"keyword\">return</span> content.<span class=\"title function_\">replace</span>(<span class=\"regexp\">/{/g</span>, <span class=\"string\">'&amp;#123;'</span>).<span class=\"title function_\">replace</span>(<span class=\"regexp\">/}/g</span>, <span class=\"string\">'&amp;#125;'</span>);</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n<p>所以我们可以在返回 <code>content</code> 之前对其进行处理，处理的逻辑与前一种方法是类似的，首先导入所需要的模块：</p>\n<figure class=\"highlight js\"><figcaption><span>import</span><a href=\"https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.js\">typst.js</a></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> hljs = <span class=\"built_in\">require</span>(<span class=\"string\">'highlight.js'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> highlight = <span class=\"built_in\">require</span>(<span class=\"string\">'hexo-util'</span>).<span class=\"property\">highlight</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> typstBunlde = <span class=\"built_in\">require</span>(<span class=\"string\">'./typst.bundle'</span>);</span><br></pre></td></tr></tbody></table></figure>\n<p>然后获取 <code>highlight</code> 处理过后的代码块：</p>\n<figure class=\"highlight js\"><figcaption><span>highlight process</span><a href=\"https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.js\">typst.js</a></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">codeTypst</span> = (<span class=\"params\">args, content</span>) =&gt; {</span><br><span class=\"line\">    <span class=\"keyword\">const</span> options = <span class=\"title function_\">parseArgs</span>(args);</span><br><span class=\"line\">    options.<span class=\"property\">lines_length</span> = content.<span class=\"title function_\">split</span>(<span class=\"string\">'\\n'</span>).<span class=\"property\">length</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> line_threshold = options.<span class=\"property\">line_threshold</span> || <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> shouldUseLineNumbers = options.<span class=\"property\">line_number</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> surpassesLineThreshold = options.<span class=\"property\">lines_length</span> &gt; line_threshold;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> gutter = shouldUseLineNumbers &amp;&amp; surpassesLineThreshold;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> hljsOptions = {</span><br><span class=\"line\">        <span class=\"attr\">caption</span>: options.<span class=\"property\">caption</span>,</span><br><span class=\"line\">        <span class=\"attr\">firstLine</span>: options.<span class=\"property\">firstLine</span>,</span><br><span class=\"line\">        gutter,</span><br><span class=\"line\">        <span class=\"attr\">mark</span>: options.<span class=\"property\">mark</span>,</span><br><span class=\"line\">    };</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> contentHljs = <span class=\"title function_\">highlight</span>(content, hljsOptions);</span><br><span class=\"line\">    contentHljs = contentHljs.<span class=\"title function_\">replace</span>(<span class=\"regexp\">/{/g</span>, <span class=\"string\">'&amp;#123;'</span>).<span class=\"title function_\">replace</span>(<span class=\"regexp\">/}/g</span>, <span class=\"string\">'&amp;#125;'</span>);</span><br><span class=\"line\">    ......</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<p>然后注册 <code>Typst</code> 语言，并提取代码进行处理：</p>\n<figure class=\"highlight js\"><figcaption><span>extract and process</span><a href=\"https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.js\">typst.js</a></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">codeTypst</span> = (<span class=\"params\">args, content</span>) =&gt; {</span><br><span class=\"line\">    ......</span><br><span class=\"line\">    <span class=\"keyword\">return</span> typstBunlde.<span class=\"property\">parserModule</span>.<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> {</span><br><span class=\"line\">        hljs.<span class=\"title function_\">registerLanguage</span>(</span><br><span class=\"line\">            <span class=\"string\">'typst'</span>,</span><br><span class=\"line\">            typstBunlde.<span class=\"title function_\">hljsTypst</span>({</span><br><span class=\"line\">                <span class=\"attr\">codeBlockDefaultLanguage</span>: <span class=\"string\">'typst'</span>,</span><br><span class=\"line\">            }),</span><br><span class=\"line\">        )</span><br><span class=\"line\">    }).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> {</span><br><span class=\"line\">        <span class=\"keyword\">var</span> re = <span class=\"regexp\">/&lt;td class=\"code\"&gt;&lt;pre&gt;(.+)&lt;\\/pre&gt;&lt;\\/td&gt;/i</span>;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> code = hljs.<span class=\"title function_\">highlight</span>(content, {<span class=\"attr\">language</span>: <span class=\"string\">'typst'</span>}).<span class=\"property\">value</span>;</span><br><span class=\"line\">        contentHljs = contentHljs.<span class=\"title function_\">replace</span>(<span class=\"string\">\"highlight plaintext\"</span>, <span class=\"string\">\"highlight typst\"</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> contentHljs.<span class=\"title function_\">replace</span>(re, <span class=\"string\">`&lt;td class=\"code\"&gt;&lt;pre&gt;<span class=\"subst\">${code}</span>&lt;/pre&gt;&lt;/td&gt;`</span>);</span><br><span class=\"line\">    });</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<p>最后在 <code>Hexo</code> 中注册这个标签插件，由于注册 <code>Typst</code> 语言并处理的过程是异步的，所以这里也要开启异步选项：</p>\n<figure class=\"highlight js\"><figcaption><span>register with async</span><a href=\"https://gist.githubusercontent.com/YiHui-Liu/35d2f3b7e2665c0995e18e1f998ed122/raw/caf17c5dc07da5583eae8b9f80d961ddc27a7588/typst.js\">typst.js</a></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">hexo.<span class=\"property\">extend</span>.<span class=\"property\">tag</span>.<span class=\"title function_\">register</span>(<span class=\"string\">'typst'</span>, codeTypst, {<span class=\"attr\">ends</span>: <span class=\"literal\">true</span>, <span class=\"attr\">async</span>: <span class=\"literal\">true</span>});</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"示例\">示例 <a class=\"header-anchor\" href=\"#示例\">¶</a></h2>\n<h3 id=\"使用方法\">使用方法 <a class=\"header-anchor\" href=\"#使用方法\">¶</a></h3>\n<figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Typst Code block tag</span></span><br><span class=\"line\"><span class=\"comment\"> * Syntax:</span></span><br><span class=\"line\"><span class=\"comment\"> * {% typst [options] %}</span></span><br><span class=\"line\"><span class=\"comment\"> * code snippet</span></span><br><span class=\"line\"><span class=\"comment\"> * {% endtypst %}</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> {<span class=\"type\">String</span>} title Caption text</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> {<span class=\"type\">String</span>} url Source link</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> {<span class=\"type\">String</span>} link_text Text of the link</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> {<span class=\"type\">Object</span>} line_number Show line number, value must be a boolean</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> {<span class=\"type\">Object</span>} first_line Specify the first line number, value must be a number</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> {<span class=\"type\">Object</span>} mark Line highlight specific line(s), each value separated by a comma. Specify number range using a dash</span></span><br><span class=\"line\"><span class=\"comment\"> * Example: `mark:1,4-7,10` will mark line 1, 4 to 7 and 10.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@returns</span> {<span class=\"type\">String</span>} Code snippet with code highlighting</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"预览\">预览 <a class=\"header-anchor\" href=\"#预览\">¶</a></h3>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">{% typst %}</span><br><span class=\"line\">#import \"@preview/tablex:0.0.6\": tablex, rowspanx, colspanx, hlinex, vlinex</span><br><span class=\"line\"></span><br><span class=\"line\">#let three-line-table(columns, headers, contents, caption, lang: \"en\",rows: auto) = {figure(</span><br><span class=\"line\">  tablex(</span><br><span class=\"line\">    columns: columns,</span><br><span class=\"line\">    rows: rows,</span><br><span class=\"line\">    align: center + horizon,</span><br><span class=\"line\">    auto-lines: false,</span><br><span class=\"line\">    repeat-header: true,</span><br><span class=\"line\">    hlinex(stroke: 1.5pt),</span><br><span class=\"line\">    ..headers,</span><br><span class=\"line\">    hlinex(stroke: 0.75pt),</span><br><span class=\"line\">    ..contents,</span><br><span class=\"line\">    hlinex(stroke: 1.5pt),</span><br><span class=\"line\">  ),</span><br><span class=\"line\">  kind: table,</span><br><span class=\"line\">  supplement: [#if (lang == \"en\") {\"Table\"} else {\"表\"}],</span><br><span class=\"line\">  caption: caption,</span><br><span class=\"line\">)}</span><br><span class=\"line\">{% endtypst %}</span><br></pre></td></tr></tbody></table></figure>\n<figure class=\"highlight typst\"><table><tbody><tr><td class=\"code\"><pre><span class=\"keyword\">#</span><span class=\"keyword\">import</span> <span class=\"string\">\"@preview/tablex:0.0.6\"</span><span class=\"punctuation\">:</span> <span class=\"variable\">tablex</span><span class=\"punctuation\">,</span> <span class=\"variable\">rowspanx</span><span class=\"punctuation\">,</span> <span class=\"variable\">colspanx</span><span class=\"punctuation\">,</span> <span class=\"variable\">hlinex</span><span class=\"punctuation\">,</span> <span class=\"variable\">vlinex</span>\n\n<span class=\"keyword\">#</span><span class=\"keyword\">let</span> <span class=\"title function_\">three-line-table</span><span class=\"punctuation\">(</span><span class=\"variable\">columns</span><span class=\"punctuation\">,</span> <span class=\"variable\">headers</span><span class=\"punctuation\">,</span> <span class=\"variable\">contents</span><span class=\"punctuation\">,</span> <span class=\"variable\">caption</span><span class=\"punctuation\">,</span> <span class=\"variable\">lang</span><span class=\"punctuation\">:</span> <span class=\"string\">\"en\"</span><span class=\"punctuation\">,</span><span class=\"variable\">rows</span><span class=\"punctuation\">:</span> <span class=\"keyword\">auto</span><span class=\"punctuation\">)</span> <span class=\"operator\">=</span> <span class=\"punctuation\">{</span><span class=\"title function_\">figure</span><span class=\"punctuation\">(</span>\n  <span class=\"title function_\">tablex</span><span class=\"punctuation\">(</span>\n    <span class=\"variable\">columns</span><span class=\"punctuation\">:</span> <span class=\"variable\">columns</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">rows</span><span class=\"punctuation\">:</span> <span class=\"variable\">rows</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">align</span><span class=\"punctuation\">:</span> <span class=\"variable\">center</span> <span class=\"operator\">+</span> <span class=\"variable\">horizon</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">auto-lines</span><span class=\"punctuation\">:</span> <span class=\"literal\">false</span><span class=\"punctuation\">,</span>\n    <span class=\"variable\">repeat-header</span><span class=\"punctuation\">:</span> <span class=\"literal\">true</span><span class=\"punctuation\">,</span>\n    <span class=\"title function_\">hlinex</span><span class=\"punctuation\">(</span><span class=\"variable\">stroke</span><span class=\"punctuation\">:</span> <span class=\"number\">1.5pt</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n    <span class=\"operator\">..</span><span class=\"variable\">headers</span><span class=\"punctuation\">,</span>\n    <span class=\"title function_\">hlinex</span><span class=\"punctuation\">(</span><span class=\"variable\">stroke</span><span class=\"punctuation\">:</span> <span class=\"number\">0.75pt</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n    <span class=\"operator\">..</span><span class=\"variable\">contents</span><span class=\"punctuation\">,</span>\n    <span class=\"title function_\">hlinex</span><span class=\"punctuation\">(</span><span class=\"variable\">stroke</span><span class=\"punctuation\">:</span> <span class=\"number\">1.5pt</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n  <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">kind</span><span class=\"punctuation\">:</span> <span class=\"variable\">table</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">supplement</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"keyword\">#</span><span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"variable\">lang</span> <span class=\"operator\">==</span> <span class=\"string\">\"en\"</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span><span class=\"string\">\"Table\"</span><span class=\"punctuation\">}</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">{</span><span class=\"string\">\"表\"</span><span class=\"punctuation\">}</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span>\n  <span class=\"variable\">caption</span><span class=\"punctuation\">:</span> <span class=\"variable\">caption</span><span class=\"punctuation\">,</span>\n<span class=\"punctuation\">)</span><span class=\"punctuation\">}</span></pre></td></tr></tbody></table></figure>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><span id=\"refer-1\"><a href=\"https://www.el42.cc/posts/hugo-typst-highlight/\">在 Hugo 中为 Typst 配置语法高亮（PaperMod 主题）</a></span></li>\n<li><span id=\"refer-2\"><a href=\"https://hexo.io/zh-cn/api/tag\">标签插件（Tag）</a></span></li>\n<li><span id=\"refer-3\"><a href=\"https://github.com/Myriad-Dreamin/typst.ts/tree/main/projects/highlighter\">highlighter</a></span></li>\n<li><span id=\"refer-4\"><a href=\"https://hexo.io/zh-cn/docs/syntax-highlight.html\">代码高亮</a></span></li>\n</ol>\n","categories":["软件/程序"],"tags":["教程","typst"]},{"title":"微信聊天记录分析：去年和你的猪聊了什么？","url":"/posts/202402-WeChatMsgAnalysis.html","content":"<div class=\"note danger flat\"><p><strong>评论不填写邮箱，将收不到回复通知</strong></p>\n</div>\n<div class=\"note warning flat\"><p><strong>多图预警</strong></p>\n</div>\n<div class=\"note info flat\"><p><code>ipynb</code> 文件<strong>最好从上往下依次运行，不要回过头来重新搞</strong>，获取方式：</p>\n<ul>\n<li>在 <a href=\"https://colab.research.google.com/drive/1hbvPPUOnW88CgQtwKNEa1Rzh7s5aOGHv?usp=sharing\">Google Colab</a> 使用在线环境运行（推荐）</li>\n<li>下载 <a href=\"https://gist.github.com/YiHui-Liu/1ed2f9484c5e20587d016e5d7854c273\">ipynb 文件</a> 直接运行</li>\n<li>下载 <a href=\"https://api.foolishfox.cn/msg.zip\">运行所需文件</a></li>\n</ul>\n</div>\n<h2 id=\"准备\">准备 <a class=\"header-anchor\" href=\"#准备\">¶</a></h2>\n<h3 id=\"导出聊天记录\">导出聊天记录 <a class=\"header-anchor\" href=\"#导出聊天记录\">¶</a></h3>\n<p>依照 <a href=\"https://github.com/LC044/WeChatMsg\">WeChatMsg</a> 的教程导出 <code>csv</code> 文件，只需要导出文本即可。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb125a50b43.png\" alt=\"图1 导出聊天记录\" style=\"height:200px;\"></div><span class=\"image-caption\">图 1 导出聊天记录</span></div>\n<h3 id=\"安装所需包\">安装所需包 <a class=\"header-anchor\" href=\"#安装所需包\">¶</a></h3>\n<p>推荐在虚拟环境中安装。</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">pip install numpy seaborn pandas wordcloud tqdm paddlepaddle paddlenlp</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"引入包\">引入包 <a class=\"header-anchor\" href=\"#引入包\">¶</a></h3>\n<ul>\n<li>pandas: 基础数据框架</li>\n<li> matplotlib &amp; seaborn: 绘图</li>\n<li> jieba: 中文分词</li>\n<li> wordcloud: 词云</li>\n<li> paddlenlp: 情感分析 </li>\n</ul>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"><span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd</span><br><span class=\"line\"><span class=\"keyword\">import</span> jieba</span><br><span class=\"line\"><span class=\"keyword\">import</span> jieba.posseg <span class=\"keyword\">as</span> pseg</span><br><span class=\"line\"><span class=\"keyword\">from</span> PIL <span class=\"keyword\">import</span> Image</span><br><span class=\"line\"><span class=\"keyword\">from</span> wordcloud <span class=\"keyword\">import</span> WordCloud</span><br><span class=\"line\"><span class=\"keyword\">import</span> seaborn <span class=\"keyword\">as</span> sns</span><br><span class=\"line\"><span class=\"keyword\">import</span> matplotlib.ticker <span class=\"keyword\">as</span> mticker</span><br><span class=\"line\"><span class=\"keyword\">import</span> matplotlib.transforms <span class=\"keyword\">as</span> mtransforms</span><br><span class=\"line\"><span class=\"keyword\">from</span> matplotlib.colors <span class=\"keyword\">import</span> ListedColormap</span><br><span class=\"line\"><span class=\"keyword\">from</span> matplotlib <span class=\"keyword\">import</span> pyplot <span class=\"keyword\">as</span> plt</span><br><span class=\"line\"><span class=\"keyword\">from</span> matplotlib <span class=\"keyword\">import</span> font_manager <span class=\"keyword\">as</span> fm</span><br><span class=\"line\"><span class=\"keyword\">from</span> tqdm <span class=\"keyword\">import</span> tqdm</span><br><span class=\"line\"><span class=\"keyword\">from</span> paddlenlp <span class=\"keyword\">import</span> Taskflow</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"绘图设置\">绘图设置 <a class=\"header-anchor\" href=\"#绘图设置\">¶</a></h3>\n<ul>\n<li><code>font</code>: 字体路径，至少支持中文，最好同时支持中文和 emoji</li>\n</ul>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">sns.set_theme(style=<span class=\"string\">\"ticks\"</span>)</span><br><span class=\"line\">font = <span class=\"string\">\"/usr/share/fonts/winfont/simsun.ttc\"</span></span><br><span class=\"line\">fp = fm.FontProperties(fname=font)</span><br><span class=\"line\">plt.rcParams[<span class=\"string\">\"axes.unicode_minus\"</span>] = <span class=\"literal\">False</span></span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"人名标签\">人名标签 <a class=\"header-anchor\" href=\"#人名标签\">¶</a></h3>\n<p>在这里修改双方的称呼：</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">labels = [<span class=\"string\">\"LL\"</span>, <span class=\"string\">\"FF\"</span>]</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"数据读取\">数据读取 <a class=\"header-anchor\" href=\"#数据读取\">¶</a></h3>\n<ul>\n<li><code>filePath</code>: 消息记录文件的路径</li>\n<li><code>dStart</code>: 开始的时间</li>\n<li><code>dEnd</code>: 结束的时间 </li>\n</ul>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">filePath = <span class=\"string\">\"msg.csv\"</span></span><br><span class=\"line\">dStart = <span class=\"string\">\"2023-01-01 00:00:00\"</span></span><br><span class=\"line\">dEnd = <span class=\"string\">\"2023-12-31 23:59:59\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">df = pd.read_csv(filePath, encoding=<span class=\"string\">\"utf-8\"</span>)</span><br><span class=\"line\">df = df.query(</span><br><span class=\"line\">    <span class=\"string\">\"CreateTime &gt;= {:d} and CreateTime &lt;= {:d}\"</span>.<span class=\"built_in\">format</span>(</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(time.mktime(time.strptime(dStart, <span class=\"string\">\"%Y-%m-%d %H:%M:%S\"</span>))),</span><br><span class=\"line\">        <span class=\"built_in\">int</span>(time.mktime(time.strptime(dEnd, <span class=\"string\">\"%Y-%m-%d %H:%M:%S\"</span>))),</span><br><span class=\"line\">    )</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">df.loc[:, <span class=\"string\">\"StrTime\"</span>] = pd.to_datetime(df[<span class=\"string\">\"StrTime\"</span>])</span><br><span class=\"line\">df.loc[:, <span class=\"string\">\"day\"</span>] = df[<span class=\"string\">\"StrTime\"</span>].dt.dayofweek</span><br><span class=\"line\">df.loc[:, <span class=\"string\">\"hour\"</span>] = df[<span class=\"string\">\"StrTime\"</span>].dt.hour</span><br><span class=\"line\">df.loc[:, <span class=\"string\">\"Count\"</span>] = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果出错就用</span></span><br><span class=\"line\">df[<span class=\"string\">\"StrTime\"</span>] = pd.to_datetime(df[<span class=\"string\">\"StrTime\"</span>])</span><br><span class=\"line\">df[<span class=\"string\">\"day\"</span>] = df[<span class=\"string\">\"StrTime\"</span>].dt.dayofweek</span><br><span class=\"line\">df[<span class=\"string\">\"hour\"</span>] = df[<span class=\"string\">\"StrTime\"</span>].dt.hour</span><br><span class=\"line\">df[<span class=\"string\">\"Count\"</span>] = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">dfs = [df.query(<span class=\"string\">\"IsSender == 0\"</span>), df.query(<span class=\"string\">\"IsSender == 1\"</span>)]</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"消息过滤\">消息过滤 <a class=\"header-anchor\" href=\"#消息过滤\">¶</a></h3>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">textFilter</span>(<span class=\"params\">text: <span class=\"built_in\">str</span></span>):</span><br><span class=\"line\">    text = text.lower()</span><br><span class=\"line\">    <span class=\"comment\"># 过滤 emoji</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        co = re.<span class=\"built_in\">compile</span>(<span class=\"string\">\"[\\U00010000-\\U0010ffff]\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">except</span> re.error:</span><br><span class=\"line\">        co = re.<span class=\"built_in\">compile</span>(<span class=\"string\">\"[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]\"</span>)</span><br><span class=\"line\">    text = co.sub(<span class=\"string\">\" \"</span>, text)</span><br><span class=\"line\">    <span class=\"comment\"># 过滤微信表情</span></span><br><span class=\"line\">    co = re.<span class=\"built_in\">compile</span>(<span class=\"string\">\"\\[[\\u4e00-\\u9fa5]+\\]\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> co.sub(<span class=\"string\">\" \"</span>, text)</span><br><span class=\"line\"></span><br><span class=\"line\">texts = [</span><br><span class=\"line\">    [textFilter(i) <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> dfs[<span class=\"number\">0</span>].query(<span class=\"string\">\"Type == 1\"</span>)[<span class=\"string\">\"StrContent\"</span>].to_list()],</span><br><span class=\"line\">    [textFilter(i) <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> dfs[<span class=\"number\">1</span>].query(<span class=\"string\">\"Type == 1\"</span>)[<span class=\"string\">\"StrContent\"</span>].to_list()],</span><br><span class=\"line\">]</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"消息频率分析\">消息频率分析 <a class=\"header-anchor\" href=\"#消息频率分析\">¶</a></h2>\n<h3 id=\"类型分析\">类型分析 <a class=\"header-anchor\" href=\"#类型分析\">¶</a></h3>\n<p>根据消息的类型进行分类，可以看出喜欢发送的消息类型，同时也可以看出谁发的多</p>\n<ul>\n<li>1 = Text</li>\n<li>3 = Image</li>\n<li>34 = Voice</li>\n<li>43 = Video</li>\n<li>47 = Sticker</li>\n<li>48 = Location</li>\n<li>10000 = System</li>\n</ul>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">data = {}</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">2</span>):</span><br><span class=\"line\">    data[labels[i]] = [</span><br><span class=\"line\">        <span class=\"built_in\">len</span>(dfs[i].query(<span class=\"string\">\"Type == 1\"</span>)),</span><br><span class=\"line\">        <span class=\"built_in\">len</span>(dfs[i].query(<span class=\"string\">\"Type == 3\"</span>)),</span><br><span class=\"line\">        <span class=\"built_in\">len</span>(dfs[i].query(<span class=\"string\">\"Type == 34\"</span>)),</span><br><span class=\"line\">        <span class=\"built_in\">len</span>(dfs[i].query(<span class=\"string\">\"Type == 43\"</span>)),</span><br><span class=\"line\">        <span class=\"built_in\">len</span>(dfs[i].query(<span class=\"string\">\"Type == 47\"</span>)),</span><br><span class=\"line\">    ]</span><br><span class=\"line\"></span><br><span class=\"line\">data = (</span><br><span class=\"line\">    pd.DataFrame(data, index=[<span class=\"string\">\"Text\"</span>, <span class=\"string\">\"Image\"</span>, <span class=\"string\">\"Voice\"</span>, <span class=\"string\">\"Video\"</span>, <span class=\"string\">\"Sticker\"</span>])</span><br><span class=\"line\">    .reset_index()</span><br><span class=\"line\">    .melt(<span class=\"string\">\"index\"</span>)</span><br><span class=\"line\">    .rename(columns={<span class=\"string\">\"index\"</span>: <span class=\"string\">\"Type\"</span>, <span class=\"string\">\"variable\"</span>: <span class=\"string\">\"Person\"</span>, <span class=\"string\">\"value\"</span>: <span class=\"string\">\"Count\"</span>})</span><br><span class=\"line\">)</span><br><span class=\"line\">g = sns.catplot(data, kind=<span class=\"string\">\"bar\"</span>, x=<span class=\"string\">\"Type\"</span>, y=<span class=\"string\">\"Count\"</span>, hue=<span class=\"string\">\"Person\"</span>, palette=<span class=\"string\">\"dark\"</span>, alpha=<span class=\"number\">0.6</span>, height=<span class=\"number\">6</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> ax <span class=\"keyword\">in</span> g.axes.ravel():</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">2</span>):</span><br><span class=\"line\">        ax.bar_label(ax.containers[i], fontsize=<span class=\"number\">9</span>)</span><br><span class=\"line\">sns.move_legend(g, <span class=\"string\">\"upper right\"</span>)</span><br><span class=\"line\">plt.yscale(<span class=\"string\">\"log\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">g.figure.set_size_inches(<span class=\"number\">6</span>, <span class=\"number\">5</span>)</span><br><span class=\"line\">g.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb1395f1d68.png\" alt=\"图2 消息类型\" style=\"height:300px;\"></div><span class=\"image-caption\">图 2 消息类型</span></div>\n<h3 id=\"消息长度分析\">消息长度分析 <a class=\"header-anchor\" href=\"#消息长度分析\">¶</a></h3>\n<ul>\n<li><code>sN</code>: 设置显示范围：</li>\n</ul>\n<p class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>μ</mi><mo>+</mo><mrow><mi mathvariant=\"normal\">s</mi><mi mathvariant=\"normal\">N</mi></mrow><mo>∗</mo><mi>σ</mi></mrow><annotation encoding=\"application/x-tex\">\\mu + \\mathrm{sN} * \\sigma\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7777700000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">μ</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">s</span><span class=\"mord mathrm\">N</span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span></span></span></span></span></p>\n<ul>\n<li><code>multiple</code>: 直方图堆叠格式 </li>\n</ul>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">sN = <span class=\"number\">3</span></span><br><span class=\"line\">multiple = <span class=\"string\">\"dodge\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">mu, std = <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">data = {<span class=\"string\">\"Length\"</span>: [], <span class=\"string\">\"Person\"</span>: []}</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">2</span>):</span><br><span class=\"line\">    length = [<span class=\"built_in\">len</span>(textFilter(i)) <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> texts[i]]</span><br><span class=\"line\">    data[<span class=\"string\">\"Length\"</span>] += length</span><br><span class=\"line\">    data[<span class=\"string\">\"Person\"</span>] += [labels[i]] * <span class=\"built_in\">len</span>(length)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> np.mean(length) + sN * np.std(length) &gt; mu + std:</span><br><span class=\"line\">        mu, std = np.mean(length), np.std(length)</span><br><span class=\"line\">xlim = <span class=\"built_in\">int</span>(np.ceil(mu + sN * std))</span><br><span class=\"line\"></span><br><span class=\"line\">data = pd.DataFrame(data)</span><br><span class=\"line\">bins = np.linspace(<span class=\"number\">0</span>, xlim, xlim + <span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax = sns.histplot(</span><br><span class=\"line\">    data=data,</span><br><span class=\"line\">    x=<span class=\"string\">\"Length\"</span>,</span><br><span class=\"line\">    hue=<span class=\"string\">\"Person\"</span>,</span><br><span class=\"line\">    bins=bins,</span><br><span class=\"line\">    multiple=multiple,</span><br><span class=\"line\">    edgecolor=<span class=\"string\">\".3\"</span>,</span><br><span class=\"line\">    linewidth=<span class=\"number\">0.5</span>,</span><br><span class=\"line\">    palette=<span class=\"string\">\"dark\"</span>,</span><br><span class=\"line\">    alpha=<span class=\"number\">0.6</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\">ax.set_xlim(<span class=\"number\">0</span>, xlim)</span><br><span class=\"line\">ax.set_xlabel(<span class=\"string\">\"Length of Message\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax.figure.set_size_inches(<span class=\"number\">8</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb141cd3165.png\" alt=\"图3 消息长度\" style=\"height:300px;\"></div><span class=\"image-caption\">图 3 消息长度</span></div>\n<h3 id=\"每日活跃分析\">每日活跃分析 <a class=\"header-anchor\" href=\"#每日活跃分析\">¶</a></h3>\n<p>划分每日 24 小时内每小时发送的消息数，可以得知每天的活跃的时间段</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">data = {<span class=\"string\">\"Time\"</span>: [], <span class=\"string\">\"Person\"</span>: []}</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">2</span>):</span><br><span class=\"line\">    hour = dfs[i][<span class=\"string\">\"hour\"</span>].to_list()</span><br><span class=\"line\">    data[<span class=\"string\">\"Time\"</span>] += hour</span><br><span class=\"line\">    data[<span class=\"string\">\"Person\"</span>] += [labels[i]] * <span class=\"built_in\">len</span>(hour)</span><br><span class=\"line\"></span><br><span class=\"line\">data = pd.DataFrame(data)</span><br><span class=\"line\">bins = np.arange(<span class=\"number\">0</span>, <span class=\"number\">25</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax = sns.histplot(</span><br><span class=\"line\">    data=data,</span><br><span class=\"line\">    x=<span class=\"string\">\"Time\"</span>,</span><br><span class=\"line\">    hue=<span class=\"string\">\"Person\"</span>,</span><br><span class=\"line\">    bins=bins,</span><br><span class=\"line\">    multiple=multiple,</span><br><span class=\"line\">    edgecolor=<span class=\"string\">\".3\"</span>,</span><br><span class=\"line\">    linewidth=<span class=\"number\">0.5</span>,</span><br><span class=\"line\">    palette=<span class=\"string\">\"dark\"</span>,</span><br><span class=\"line\">    alpha=<span class=\"number\">0.6</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\">ax.set_xticks(bins)</span><br><span class=\"line\">ax.set_xticklabels(bins)</span><br><span class=\"line\">ax.set_xlabel(<span class=\"string\">\"Hour\"</span>)</span><br><span class=\"line\">ax.set_xlim(<span class=\"number\">0</span>, <span class=\"number\">24</span>)</span><br><span class=\"line\">sns.move_legend(ax, loc=<span class=\"string\">\"upper center\"</span>, bbox_to_anchor=(<span class=\"number\">0.5</span>, <span class=\"number\">1.2</span>), ncol=<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax.figure.set_size_inches(<span class=\"number\">8</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb14564b8de.png\" alt=\"图4 每日活跃时间\" style=\"height:300px;\"></div><span class=\"image-caption\">图 4 每日活跃时间</span></div>\n<h3 id=\"每周活跃分析\">每周活跃分析 <a class=\"header-anchor\" href=\"#每周活跃分析\">¶</a></h3>\n<p>查看一周内从周一到周日每天发送的消息数</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">grouper = pd.Grouper(key=<span class=\"string\">\"day\"</span>)</span><br><span class=\"line\">data = df.groupby(grouper)[<span class=\"string\">\"Count\"</span>].<span class=\"built_in\">sum</span>()</span><br><span class=\"line\">data = data.sort_index()</span><br><span class=\"line\">data.index = [<span class=\"string\">\"Mon\"</span>, <span class=\"string\">\"Tue\"</span>, <span class=\"string\">\"Wed\"</span>, <span class=\"string\">\"Thu\"</span>, <span class=\"string\">\"Fri\"</span>, <span class=\"string\">\"Sat\"</span>, <span class=\"string\">\"Sun\"</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">ax = sns.barplot(data=data, errorbar=<span class=\"literal\">None</span>)</span><br><span class=\"line\">ax.set_xlabel(<span class=\"string\">\"Weekday\"</span>)</span><br><span class=\"line\">ax.bar_label(ax.containers[<span class=\"number\">0</span>], fontsize=<span class=\"number\">10</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax.figure.set_size_inches(<span class=\"number\">5</span>, <span class=\"number\">5</span>)</span><br><span class=\"line\">ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb149541466.png\" alt=\"图5 每周活跃分析\" style=\"height:300px;\"></div><span class=\"image-caption\">图 5 每周活跃分析</span></div>\n<h3 id=\"按周划分年度活跃分析\">按周划分年度活跃分析 <a class=\"header-anchor\" href=\"#按周划分年度活跃分析\">¶</a></h3>\n<p>划分每 7 天内发送的消息数，可以得知每周的活跃的时间段</p>\n<ul>\n<li><code>wTicks</code>: 每个刻度相差的数值</li>\n</ul>\n<div class=\"note warning flat\"><p><strong>请注意此处修改：</strong></p>\n<ul>\n<li><code>wStart</code>: <strong>当年</strong>或者<strong>聊天开始日期之后</strong>第一个周一的日期</li>\n<li><code>wEnd</code>: <strong>次年</strong>或者<strong>聊天结束日期之后</strong>第一个周一的日期 </li>\n</ul>\n</div>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">wTicks = <span class=\"number\">500</span></span><br><span class=\"line\">wStart = <span class=\"string\">\"2023-01-02\"</span></span><br><span class=\"line\">wEnd = <span class=\"string\">\"2024-01-01\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">grouper = pd.Grouper(key=<span class=\"string\">\"StrTime\"</span>, freq=<span class=\"string\">\"W-MON\"</span>)</span><br><span class=\"line\">data = df.groupby(grouper)[<span class=\"string\">\"Count\"</span>].<span class=\"built_in\">sum</span>().to_frame()</span><br><span class=\"line\">data.index = pd.date_range(start=wStart, end=wEnd, freq=<span class=\"string\">\"W-MON\"</span>).strftime(<span class=\"string\">\"%m-%d\"</span>)</span><br><span class=\"line\">data.columns = [<span class=\"string\">\"Count\"</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">vM = np.ceil(data[<span class=\"string\">\"Count\"</span>].<span class=\"built_in\">max</span>() / wTicks) * wTicks</span><br><span class=\"line\">norm = plt.Normalize(<span class=\"number\">0</span>, vM)</span><br><span class=\"line\">sm = plt.cm.ScalarMappable(cmap=<span class=\"string\">\"Reds\"</span>, norm=norm)</span><br><span class=\"line\"></span><br><span class=\"line\">ax = sns.barplot(x=data.index, y=data[<span class=\"string\">\"Count\"</span>], hue=data[<span class=\"string\">\"Count\"</span>], hue_norm=norm, palette=<span class=\"string\">\"Reds\"</span>)</span><br><span class=\"line\">ax.set_xlabel(<span class=\"string\">\"Date\"</span>)</span><br><span class=\"line\">plt.xticks(rotation=<span class=\"number\">60</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> bar <span class=\"keyword\">in</span> ax.containers:</span><br><span class=\"line\">    ax.bar_label(bar, fontsize=<span class=\"number\">10</span>, fmt=<span class=\"string\">\"%.0f\"</span>)</span><br><span class=\"line\">ax.get_legend().remove()</span><br><span class=\"line\"></span><br><span class=\"line\">axpos = ax.get_position()</span><br><span class=\"line\">caxpos = mtransforms.Bbox.from_extents(axpos.x1 + <span class=\"number\">0.02</span>, axpos.y0, axpos.x1 + <span class=\"number\">0.03</span>, axpos.y1)</span><br><span class=\"line\">cax = ax.figure.add_axes(caxpos)</span><br><span class=\"line\"></span><br><span class=\"line\">locator = mticker.MultipleLocator(wTicks)</span><br><span class=\"line\">formatter = mticker.StrMethodFormatter(<span class=\"string\">\"{x:.0f}\"</span>)</span><br><span class=\"line\">cax.figure.colorbar(sm, cax=cax, ticks=locator, <span class=\"built_in\">format</span>=formatter)</span><br><span class=\"line\"></span><br><span class=\"line\">ax.figure.set_size_inches(<span class=\"number\">20</span>, <span class=\"number\">8</span>)</span><br><span class=\"line\">ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb14cd53593.png\" alt=\"图5 按周划分年度活跃分析\" style=\"height:300px;\"></div><span class=\"image-caption\">图 5 按周划分年度活跃分析</span></div>\n<h3 id=\"按周划分聊天热情分析\">按周划分聊天热情分析 <a class=\"header-anchor\" href=\"#按周划分聊天热情分析\">¶</a></h3>\n<p>划分每 7 天内的聊天热情指数，聊天热情指数为发送的消息数减去收到的消息数与总消息数的比值：</p>\n<p class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>E</mi><mo>=</mo><mfrac><mrow><msub><mi>Q</mi><mi mathvariant=\"normal\">S</mi></msub><mo>−</mo><msub><mi>Q</mi><mi mathvariant=\"normal\">R</mi></msub></mrow><mrow><msub><mi>Q</mi><mi mathvariant=\"normal\">S</mi></msub><mo>+</mo><msub><mi>Q</mi><mi mathvariant=\"normal\">R</mi></msub></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">E = \\frac{Q_\\mathrm{S} - Q_\\mathrm{R}}{Q_\\mathrm{S} + Q_\\mathrm{R}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.24077em;vertical-align:-0.8804400000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3603299999999998em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">Q</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">S</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">Q</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">R</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">Q</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">S</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">Q</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathrm mtight\">R</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8804400000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">grouper = pd.Grouper(key=<span class=\"string\">\"StrTime\"</span>, freq=<span class=\"string\">\"W-MON\"</span>)</span><br><span class=\"line\">df_W1 = dfs[<span class=\"number\">0</span>].groupby(grouper)[<span class=\"string\">\"Count\"</span>].<span class=\"built_in\">sum</span>()</span><br><span class=\"line\">df_W2 = dfs[<span class=\"number\">1</span>].groupby(grouper)[<span class=\"string\">\"Count\"</span>].<span class=\"built_in\">sum</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">data = pd.DataFrame({<span class=\"string\">\"E\"</span>: (df_W1 - df_W2) / (df_W1 + df_W2)})</span><br><span class=\"line\">data.index = pd.date_range(start=wStart, end=wEnd, freq=<span class=\"string\">\"W-MON\"</span>).strftime(<span class=\"string\">\"%m-%d\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">vM = data[<span class=\"string\">\"E\"</span>].<span class=\"built_in\">abs</span>().<span class=\"built_in\">max</span>()</span><br><span class=\"line\">norm = plt.Normalize(-vM, vM)</span><br><span class=\"line\">sm = plt.cm.ScalarMappable(cmap=<span class=\"string\">\"coolwarm\"</span>, norm=norm)</span><br><span class=\"line\"></span><br><span class=\"line\">ax = sns.barplot(x=data.index, y=data[<span class=\"string\">\"E\"</span>], hue=data[<span class=\"string\">\"E\"</span>], hue_norm=norm, palette=<span class=\"string\">\"coolwarm\"</span>)</span><br><span class=\"line\">ax.set_xlabel(<span class=\"string\">\"Date\"</span>)</span><br><span class=\"line\">plt.xticks(rotation=<span class=\"number\">60</span>)</span><br><span class=\"line\">ax.set_ylabel(<span class=\"string\">\"Enthusiasm Index\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> bar <span class=\"keyword\">in</span> ax.containers:</span><br><span class=\"line\">    ax.bar_label(bar, fontsize=<span class=\"number\">10</span>, fmt=<span class=\"string\">\"%.2f\"</span>)</span><br><span class=\"line\">ax.get_legend().remove()</span><br><span class=\"line\"></span><br><span class=\"line\">axpos = ax.get_position()</span><br><span class=\"line\">caxpos = mtransforms.Bbox.from_extents(axpos.x1 + <span class=\"number\">0.02</span>, axpos.y0, axpos.x1 + <span class=\"number\">0.03</span>, axpos.y1)</span><br><span class=\"line\">cax = ax.figure.add_axes(caxpos)</span><br><span class=\"line\"></span><br><span class=\"line\">locator = mticker.MultipleLocator(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">formatter = mticker.StrMethodFormatter(<span class=\"string\">\"{x:.1f}\"</span>)</span><br><span class=\"line\">cax.figure.colorbar(sm, cax=cax, ticks=locator, <span class=\"built_in\">format</span>=formatter)</span><br><span class=\"line\"></span><br><span class=\"line\">ax.figure.set_size_inches(<span class=\"number\">20</span>, <span class=\"number\">8</span>)</span><br><span class=\"line\">ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb150cdc34d.png\" alt=\"图6 按周划分聊天热情分析\" style=\"height:300px;\"></div><span class=\"image-caption\">图 6 按周划分聊天热情分析</span></div>\n<h3 id=\"按日划分年度活跃分析\">按日划分年度活跃分析 <a class=\"header-anchor\" href=\"#按日划分年度活跃分析\">¶</a></h3>\n<p>以热力图的方式展示按日划分的年度活跃情况</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">grouper = pd.Grouper(key=<span class=\"string\">\"StrTime\"</span>, freq=<span class=\"string\">\"D\"</span>)</span><br><span class=\"line\">data = df.groupby(grouper)[<span class=\"string\">\"Count\"</span>].<span class=\"built_in\">sum</span>()</span><br><span class=\"line\">data = data.to_frame()</span><br><span class=\"line\"></span><br><span class=\"line\">data[<span class=\"string\">\"date\"</span>] = data.index</span><br><span class=\"line\">data[<span class=\"string\">\"week\"</span>] = data[<span class=\"string\">\"date\"</span>].dt.isocalendar()[<span class=\"string\">\"week\"</span>]</span><br><span class=\"line\">data[<span class=\"string\">\"day\"</span>] = data[<span class=\"string\">\"date\"</span>].dt.dayofweek</span><br><span class=\"line\">data.index = <span class=\"built_in\">range</span>(<span class=\"built_in\">len</span>(data))</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">7</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> data.loc[i, <span class=\"string\">\"week\"</span>] &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">        data.loc[i, <span class=\"string\">\"week\"</span>] = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">data = data.pivot(index=<span class=\"string\">\"day\"</span>, columns=<span class=\"string\">\"week\"</span>, values=<span class=\"string\">\"Count\"</span>)</span><br><span class=\"line\">data.index = [<span class=\"string\">\"Mon\"</span>, <span class=\"string\">\"Tue\"</span>, <span class=\"string\">\"Wed\"</span>, <span class=\"string\">\"Thu\"</span>, <span class=\"string\">\"Fri\"</span>, <span class=\"string\">\"Sat\"</span>, <span class=\"string\">\"Sun\"</span>]</span><br><span class=\"line\">data.columns = pd.date_range(start=wStart, end=wEnd, freq=<span class=\"string\">\"W-MON\"</span>).strftime(<span class=\"string\">\"%m-%d\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax = sns.heatmap(</span><br><span class=\"line\">    data,</span><br><span class=\"line\">    annot=<span class=\"literal\">False</span>,</span><br><span class=\"line\">    linewidths=<span class=\"number\">0.5</span>,</span><br><span class=\"line\">    cbar_kws={<span class=\"string\">\"orientation\"</span>: <span class=\"string\">\"vertical\"</span>, <span class=\"string\">\"location\"</span>: <span class=\"string\">\"left\"</span>, <span class=\"string\">\"pad\"</span>: <span class=\"number\">0.03</span>},</span><br><span class=\"line\">    cmap=<span class=\"string\">\"Reds\"</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\">ax.set_xlabel(<span class=\"string\">\"Week\"</span>)</span><br><span class=\"line\">ax.set_ylabel(<span class=\"string\">\"Weekday\"</span>)</span><br><span class=\"line\">ax.figure.set_size_inches(<span class=\"number\">24</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb155505c24.png\" alt=\"图7 按日划分年度活跃分析\" style=\"height:250px;\"></div><span class=\"image-caption\">图 7 按日划分年度活跃分析</span></div>\n<h2 id=\"词语分析\">词语分析 <a class=\"header-anchor\" href=\"#词语分析\">¶</a></h2>\n<h3 id=\"分词词典、停止词与去除词性\">分词词典、停止词与去除词性 <a class=\"header-anchor\" href=\"#分词词典、停止词与去除词性\">¶</a></h3>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">jieba.load_userdict(<span class=\"string\">\"thuocl.txt\"</span>)</span><br><span class=\"line\">jieba.load_userdict(<span class=\"string\">\"userdict.txt\"</span>)</span><br><span class=\"line\">stopwords = [line.strip() <span class=\"keyword\">for</span> line <span class=\"keyword\">in</span> <span class=\"built_in\">open</span>(<span class=\"string\">\"stopwords.txt\"</span>, <span class=\"string\">\"r\"</span>).readlines()] + [<span class=\"string\">\" \"</span>, <span class=\"string\">\"\\n\"</span>, <span class=\"string\">\"\\r\\n\"</span>]</span><br><span class=\"line\">wordclass = [<span class=\"string\">\"v\"</span>, <span class=\"string\">\"u\"</span>, <span class=\"string\">\"vd\"</span>, <span class=\"string\">\"r\"</span>, <span class=\"string\">\"p\"</span>, <span class=\"string\">\"w\"</span>]</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"分词函数\">分词函数 <a class=\"header-anchor\" href=\"#分词函数\">¶</a></h3>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">wordSplit</span>(<span class=\"params\">texts, wordclass</span>):</span><br><span class=\"line\">    words = []</span><br><span class=\"line\">    pbar = tqdm(total=<span class=\"built_in\">len</span>(texts))</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"built_in\">len</span>(texts)):</span><br><span class=\"line\">        res = pseg.lcut(texts[i])</span><br><span class=\"line\">        <span class=\"keyword\">for</span> pair <span class=\"keyword\">in</span> res:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> pair.word <span class=\"keyword\">in</span> stopwords:</span><br><span class=\"line\">                <span class=\"keyword\">continue</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> pair.flag <span class=\"keyword\">in</span> wordclass:</span><br><span class=\"line\">                <span class=\"keyword\">continue</span></span><br><span class=\"line\">            words.append(pair.word)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> i % <span class=\"number\">1000</span> == <span class=\"number\">0</span>:</span><br><span class=\"line\">            pbar.update(<span class=\"number\">1000</span>)</span><br><span class=\"line\">    pbar.close()</span><br><span class=\"line\">    <span class=\"keyword\">return</span> words</span><br><span class=\"line\"></span><br><span class=\"line\">words = [wordSplit(texts[i], wordclass) <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">2</span>)]</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"词云绘制\">词云绘制 <a class=\"header-anchor\" href=\"#词云绘制\">¶</a></h3>\n<ul>\n<li><code>mask</code>: 词云的蒙版，影响词云的形状</li>\n<li><code>cmap</code>: 色阶 </li>\n</ul>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">mask = np.array(Image.<span class=\"built_in\">open</span>(<span class=\"string\">\"mask.png\"</span>))</span><br><span class=\"line\">masks = [np.array(Image.<span class=\"built_in\">open</span>(<span class=\"string\">\"mask_L.jpg\"</span>)), np.array(Image.<span class=\"built_in\">open</span>(<span class=\"string\">\"mask_F.jpg\"</span>))]</span><br><span class=\"line\">cmap = ListedColormap(</span><br><span class=\"line\">    [</span><br><span class=\"line\">        <span class=\"string\">\"#fac1cf\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"#a9d7ba\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"#58b1db\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"#f296ab\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"#5dab81\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"#3d9ec4\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"#e16a8d\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"#237b50\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"#1e8299\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"#8d3549\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"#35563b\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"#2d5d73\"</span>,</span><br><span class=\"line\">    ]</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">wordCloud</span>(<span class=\"params\">text, font, mask, cmap</span>):</span><br><span class=\"line\">    wc = WordCloud(</span><br><span class=\"line\">        background_color=<span class=\"string\">\"white\"</span>,</span><br><span class=\"line\">        scale=<span class=\"number\">5</span>,</span><br><span class=\"line\">        font_path=font,</span><br><span class=\"line\">        mask=mask,</span><br><span class=\"line\">        colormap=cmap,</span><br><span class=\"line\">        collocations=<span class=\"literal\">False</span>,</span><br><span class=\"line\">    ).generate(text)</span><br><span class=\"line\">    plt.imshow(wc)</span><br><span class=\"line\">    plt.axis(<span class=\"string\">\"off\"</span>)</span><br><span class=\"line\">    plt.show()</span><br><span class=\"line\"></span><br><span class=\"line\">wordCloud(<span class=\"string\">\" \"</span>.join(words[<span class=\"number\">0</span>] + words[<span class=\"number\">1</span>]), font, mask, cmap)</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb17047a719.png\" alt=\"图8 词云图\" style=\"height:300px;\"></div><span class=\"image-caption\">图 8 词云图</span></div>\n<h3 id=\"高频词排行\">高频词排行 <a class=\"header-anchor\" href=\"#高频词排行\">¶</a></h3>\n<p>列出常用的 N 个词，并且展示双方的贡献</p>\n<ul>\n<li><code>wN</code>: 词的数目，默认为 50</li>\n</ul>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">wN = <span class=\"number\">50</span></span><br><span class=\"line\"></span><br><span class=\"line\">data = pd.DataFrame(</span><br><span class=\"line\">    {</span><br><span class=\"line\">        <span class=\"string\">\"words\"</span>: words[<span class=\"number\">0</span>] + words[<span class=\"number\">1</span>],</span><br><span class=\"line\">        <span class=\"string\">\"L\"</span>: [<span class=\"number\">1</span>] * <span class=\"built_in\">len</span>(words[<span class=\"number\">0</span>]) + [<span class=\"number\">0</span>] * <span class=\"built_in\">len</span>(words[<span class=\"number\">1</span>]),</span><br><span class=\"line\">        <span class=\"string\">\"F\"</span>: [<span class=\"number\">0</span>] * <span class=\"built_in\">len</span>(words[<span class=\"number\">0</span>]) + [<span class=\"number\">1</span>] * <span class=\"built_in\">len</span>(words[<span class=\"number\">1</span>]),</span><br><span class=\"line\">        <span class=\"string\">\"S\"</span>: [<span class=\"number\">1</span>] * <span class=\"built_in\">len</span>(words[<span class=\"number\">0</span>]) + [<span class=\"number\">1</span>] * <span class=\"built_in\">len</span>(words[<span class=\"number\">1</span>]),</span><br><span class=\"line\">    }</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">grouper = pd.Grouper(key=<span class=\"string\">\"words\"</span>)</span><br><span class=\"line\">data = data.groupby(grouper).<span class=\"built_in\">sum</span>()</span><br><span class=\"line\">data = data.sort_values(by=<span class=\"string\">\"S\"</span>, ascending=<span class=\"literal\">False</span>)</span><br><span class=\"line\">data = data.iloc[:wN]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将部分无法识别的 emoji 转化为文字</span></span><br><span class=\"line\">tmp = data.index.to_list()</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(wN):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> tmp[i] == <span class=\"string\">\"😘\"</span>:</span><br><span class=\"line\">        tmp[i] = <span class=\"string\">\"[亲亲]\"</span></span><br><span class=\"line\">    <span class=\"keyword\">elif</span> tmp[i] == <span class=\"string\">\"😂\"</span>:</span><br><span class=\"line\">        tmp[i] = <span class=\"string\">\"[笑哭]\"</span></span><br><span class=\"line\">    <span class=\"keyword\">elif</span> tmp[i] == <span class=\"string\">\"🤦\"</span>:</span><br><span class=\"line\">        tmp[i] = <span class=\"string\">\"[捂脸]\"</span></span><br><span class=\"line\">    <span class=\"keyword\">elif</span> tmp[i] == <span class=\"string\">\"😁\"</span>:</span><br><span class=\"line\">        tmp[i] = <span class=\"string\">\"[呲牙]\"</span></span><br><span class=\"line\">data.index = tmp</span><br><span class=\"line\"></span><br><span class=\"line\">ratio = data[<span class=\"string\">\"L\"</span>] / data[<span class=\"string\">\"S\"</span>]</span><br><span class=\"line\">norm = plt.Normalize(<span class=\"number\">0</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">sm = plt.cm.ScalarMappable(cmap=<span class=\"string\">\"coolwarm\"</span>, norm=norm)</span><br><span class=\"line\"></span><br><span class=\"line\">fig = plt.figure(figsize=(<span class=\"number\">10</span>, <span class=\"number\">10</span>), dpi=<span class=\"number\">300</span>)</span><br><span class=\"line\">grid = plt.GridSpec(<span class=\"number\">1</span>, <span class=\"number\">4</span>, wspace=<span class=\"number\">0.5</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax0 = fig.add_subplot(grid[<span class=\"number\">0</span>, <span class=\"number\">0</span>])</span><br><span class=\"line\">sns.barplot(x=-data[<span class=\"string\">\"L\"</span>], y=data.index, ax=ax0, hue=ratio, hue_norm=norm, palette=<span class=\"string\">\"coolwarm\"</span>)</span><br><span class=\"line\">ax1 = fig.add_subplot(grid[<span class=\"number\">0</span>, <span class=\"number\">1</span>:])</span><br><span class=\"line\">sns.barplot(x=data[<span class=\"string\">\"F\"</span>], y=data.index, ax=ax1, hue=(<span class=\"number\">1</span> - ratio), hue_norm=norm, palette=<span class=\"string\">\"coolwarm\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax0.set_xlabel(<span class=\"string\">\"词频\"</span>)</span><br><span class=\"line\">ax0.set_ylabel(<span class=\"string\">\"\"</span>)</span><br><span class=\"line\">ax0.set_xticks(<span class=\"built_in\">range</span>(-<span class=\"number\">400</span>, <span class=\"number\">1</span>, <span class=\"number\">200</span>))</span><br><span class=\"line\">ax0.set_xticklabels([<span class=\"number\">400</span>, <span class=\"number\">200</span>, <span class=\"number\">0</span>])</span><br><span class=\"line\">ax0.set_xlim(-<span class=\"number\">400</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">ax0.set_yticks([])</span><br><span class=\"line\">ax0.spines[<span class=\"string\">\"left\"</span>].set_visible(<span class=\"literal\">False</span>)</span><br><span class=\"line\">ax0.spines[<span class=\"string\">\"top\"</span>].set_visible(<span class=\"literal\">False</span>)</span><br><span class=\"line\">ax0.spines[<span class=\"string\">\"right\"</span>].set_visible(<span class=\"literal\">False</span>)</span><br><span class=\"line\">ax0.set_title(<span class=\"string\">\"LL\"</span>)</span><br><span class=\"line\">ax0.get_legend().remove()</span><br><span class=\"line\"></span><br><span class=\"line\">ax1.set_xlabel(<span class=\"string\">\"词频\"</span>)</span><br><span class=\"line\">ax1.set_ylabel(<span class=\"string\">\"\"</span>)</span><br><span class=\"line\">ax1.set_xticks(<span class=\"built_in\">range</span>(<span class=\"number\">0</span>, <span class=\"number\">1201</span>, <span class=\"number\">200</span>))</span><br><span class=\"line\">ax1.set_xticklabels([<span class=\"number\">0</span>, <span class=\"number\">200</span>, <span class=\"number\">400</span>, <span class=\"number\">600</span>, <span class=\"number\">800</span>, <span class=\"number\">1000</span>, <span class=\"number\">1200</span>])</span><br><span class=\"line\">ax1.set_xlim(<span class=\"number\">0</span>, <span class=\"number\">1200</span>)</span><br><span class=\"line\">ax1.set_yticks([])</span><br><span class=\"line\">ax1.spines[<span class=\"string\">\"left\"</span>].set_visible(<span class=\"literal\">False</span>)</span><br><span class=\"line\">ax1.spines[<span class=\"string\">\"top\"</span>].set_visible(<span class=\"literal\">False</span>)</span><br><span class=\"line\">ax1.spines[<span class=\"string\">\"right\"</span>].set_visible(<span class=\"literal\">False</span>)</span><br><span class=\"line\">ax1.set_title(<span class=\"string\">\"FF\"</span>)</span><br><span class=\"line\">ax1.get_legend().remove()</span><br><span class=\"line\"></span><br><span class=\"line\">axpos = ax1.get_position()</span><br><span class=\"line\">caxpos = mtransforms.Bbox.from_extents(axpos.x0 + <span class=\"number\">0.06</span>, axpos.y0 + <span class=\"number\">0.03</span>, axpos.x1, axpos.y0 + <span class=\"number\">0.04</span>)</span><br><span class=\"line\">cax = ax1.figure.add_axes(caxpos)</span><br><span class=\"line\"></span><br><span class=\"line\">locator = mticker.MultipleLocator(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">formatter = mticker.StrMethodFormatter(<span class=\"string\">\"{x:.1f}\"</span>)</span><br><span class=\"line\">cax.figure.colorbar(sm, cax=cax, orientation=<span class=\"string\">\"horizontal\"</span>, ticks=locator, <span class=\"built_in\">format</span>=formatter)</span><br><span class=\"line\">cax.set_title(<span class=\"string\">\"ratio\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">x0 = ax0.get_position().x1</span><br><span class=\"line\">x1 = ax1.get_position().x0</span><br><span class=\"line\">xm = (x0 + x1) / <span class=\"number\">2</span></span><br><span class=\"line\">y0 = ax0.get_position().y0</span><br><span class=\"line\">y1 = ax0.get_position().y1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(wN):</span><br><span class=\"line\">    fig.text(</span><br><span class=\"line\">        xm, y0 + (y1 - y0) * (wN - i - <span class=\"number\">0.5</span>) / wN, data.index[i],</span><br><span class=\"line\">        color=<span class=\"string\">\"black\"</span>, ha=<span class=\"string\">\"center\"</span>, va=<span class=\"string\">\"center\"</span>, fontproperties=fp</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">fig.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb17553fc6f.png\" alt=\"图9 高频词排行\"></div><span class=\"image-caption\">图 9 高频词排行</span></div>\n<h2 id=\"情感分析\">情感分析 <a class=\"header-anchor\" href=\"#情感分析\">¶</a></h2>\n<p>使用 <code>paddlenlp</code> 进行情感分析，得到的分数在 [-1, 1] 之间，越小越消极，越大越积极</p>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">dfE = df.query(<span class=\"string\">\"Type == 1\"</span>)[[<span class=\"string\">\"IsSender\"</span>, <span class=\"string\">\"StrContent\"</span>, <span class=\"string\">\"StrTime\"</span>, <span class=\"string\">\"hour\"</span>]]</span><br><span class=\"line\">dfE.index = <span class=\"built_in\">range</span>(<span class=\"built_in\">len</span>(dfE))</span><br><span class=\"line\"></span><br><span class=\"line\">senta = Taskflow(<span class=\"string\">\"sentiment_analysis\"</span>)</span><br><span class=\"line\">scores = pd.DataFrame(senta([textFilter(i) <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> dfE[<span class=\"string\">\"StrContent\"</span>].to_list()]))</span><br><span class=\"line\">scores.loc[scores[<span class=\"string\">\"label\"</span>] == <span class=\"string\">\"negative\"</span>, <span class=\"string\">\"score\"</span>] = <span class=\"number\">1</span> - scores.loc[scores[<span class=\"string\">\"label\"</span>] == <span class=\"string\">\"negative\"</span>, <span class=\"string\">\"score\"</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">dfE[<span class=\"string\">\"score\"</span>] = scores[<span class=\"string\">\"score\"</span>]</span><br><span class=\"line\">dfE[<span class=\"string\">\"score\"</span>] = <span class=\"number\">2</span> * dfE[<span class=\"string\">\"score\"</span>] - <span class=\"number\">1</span></span><br><span class=\"line\">dfE[<span class=\"string\">\"Person\"</span>] = dfE.apply(<span class=\"keyword\">lambda</span> x: labels[x[<span class=\"string\">\"IsSender\"</span>]], axis=<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">dfEs = [dfE.query(<span class=\"string\">\"IsSender == 0\"</span>), dfE.query(<span class=\"string\">\"IsSender == 1\"</span>)]</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"年度总体情感分布\">年度总体情感分布 <a class=\"header-anchor\" href=\"#年度总体情感分布\">¶</a></h3>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">ax = sns.histplot(data=dfE, x=<span class=\"string\">\"score\"</span>, hue=<span class=\"string\">\"Person\"</span>, palette=<span class=\"string\">\"dark\"</span>, alpha=<span class=\"number\">0.6</span>, bins=<span class=\"number\">100</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax.set_xlabel(<span class=\"string\">\"Sentiment Score\"</span>)</span><br><span class=\"line\">ax.set_ylabel(<span class=\"string\">\"Count\"</span>)</span><br><span class=\"line\">ax.set_title(<span class=\"string\">\"Sentiment Distribution\"</span>)</span><br><span class=\"line\">ax.set_xlim(-<span class=\"number\">1</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax.figure.set_size_inches(<span class=\"number\">8</span>, <span class=\"number\">3</span>)</span><br><span class=\"line\">ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb17b7df694.png\" alt=\"图10 年度总体情感分布\" style=\"height:300px;\"></div><span class=\"image-caption\">图 10 年度总体情感分布</span></div>\n<h3 id=\"按周统计平均情感指数\">按周统计平均情感指数 <a class=\"header-anchor\" href=\"#按周统计平均情感指数\">¶</a></h3>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">weekAvgSenScore</span>(<span class=\"params\">df</span>):</span><br><span class=\"line\">    grouper = pd.Grouper(key=<span class=\"string\">\"StrTime\"</span>, freq=<span class=\"string\">\"W-MON\"</span>)</span><br><span class=\"line\">    data = df.groupby(grouper)[<span class=\"string\">\"score\"</span>].mean().to_frame()</span><br><span class=\"line\">    data.index = pd.date_range(start=wStart, end=wEnd, freq=<span class=\"string\">\"W-MON\"</span>).strftime(<span class=\"string\">\"%m-%d\"</span>)</span><br><span class=\"line\">    data.columns = [<span class=\"string\">\"score\"</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    vM = data[<span class=\"string\">\"score\"</span>].<span class=\"built_in\">abs</span>().<span class=\"built_in\">max</span>()</span><br><span class=\"line\">    norm = plt.Normalize(-vM, vM)</span><br><span class=\"line\">    sm = plt.cm.ScalarMappable(cmap=<span class=\"string\">\"coolwarm\"</span>, norm=norm)</span><br><span class=\"line\"></span><br><span class=\"line\">    ax = sns.barplot(x=data.index, y=data[<span class=\"string\">\"score\"</span>], hue=data[<span class=\"string\">\"score\"</span>], hue_norm=norm, palette=<span class=\"string\">\"coolwarm\"</span>)</span><br><span class=\"line\">    ax.set_xlabel(<span class=\"string\">\"Date\"</span>)</span><br><span class=\"line\">    plt.xticks(rotation=<span class=\"number\">60</span>)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> bar <span class=\"keyword\">in</span> ax.containers:</span><br><span class=\"line\">        ax.bar_label(bar, fontsize=<span class=\"number\">10</span>, fmt=<span class=\"string\">\"%.2f\"</span>)</span><br><span class=\"line\">    ax.get_legend().remove()</span><br><span class=\"line\"></span><br><span class=\"line\">    axpos = ax.get_position()</span><br><span class=\"line\">    caxpos = mtransforms.Bbox.from_extents(axpos.x1 + <span class=\"number\">0.02</span>, axpos.y0, axpos.x1 + <span class=\"number\">0.03</span>, axpos.y1)</span><br><span class=\"line\">    cax = ax.figure.add_axes(caxpos)</span><br><span class=\"line\"></span><br><span class=\"line\">    locator = mticker.MultipleLocator(<span class=\"number\">0.05</span>)</span><br><span class=\"line\">    formatter = mticker.StrMethodFormatter(<span class=\"string\">\"{x:.2f}\"</span>)</span><br><span class=\"line\">    cax.figure.colorbar(sm, cax=cax, ticks=locator, <span class=\"built_in\">format</span>=formatter)</span><br><span class=\"line\"></span><br><span class=\"line\">    ax.figure.set_size_inches(<span class=\"number\">20</span>, <span class=\"number\">8</span>)</span><br><span class=\"line\">    ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">    plt.show()</span><br><span class=\"line\">    plt.close()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> data[<span class=\"string\">\"score\"</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">avgSenScore0 = weekAvgSenScore(dfEs[<span class=\"number\">0</span>])</span><br><span class=\"line\">avgSenScore1 = weekAvgSenScore(dfEs[<span class=\"number\">1</span>])</span><br><span class=\"line\">_ = weekAvgSenScore(dfE)</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb180c8a248.png\" alt=\"图11 按周统计平均情感指数\" style=\"height:300px;\"></div><span class=\"image-caption\">图 11 按周统计平均情感指数</span></div>\n<h3 id=\"平均情感指数变化折线图\">平均情感指数变化折线图 <a class=\"header-anchor\" href=\"#平均情感指数变化折线图\">¶</a></h3>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">ax = sns.lineplot(data=avgSenScore0, linewidth=<span class=\"number\">3</span>, marker=<span class=\"string\">\"s\"</span>, markersize=<span class=\"number\">15</span>, label=labels[<span class=\"number\">0</span>])</span><br><span class=\"line\">ax = sns.lineplot(data=avgSenScore1, linewidth=<span class=\"number\">3</span>, marker=<span class=\"string\">\"^\"</span>, markersize=<span class=\"number\">15</span>, ax=ax, label=labels[<span class=\"number\">1</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">ax.set_xlabel(<span class=\"string\">\"Date\"</span>)</span><br><span class=\"line\">plt.xticks(rotation=<span class=\"number\">60</span>)</span><br><span class=\"line\">ax.set_ylabel(<span class=\"string\">\"Average Sentiment Score\"</span>)</span><br><span class=\"line\">ax.set_xlim(<span class=\"number\">0</span>, <span class=\"number\">52</span>)</span><br><span class=\"line\">ax.legend(prop={<span class=\"string\">\"size\"</span>: <span class=\"number\">24</span>})</span><br><span class=\"line\"></span><br><span class=\"line\">ax.figure.set_size_inches(<span class=\"number\">20</span>, <span class=\"number\">8</span>)</span><br><span class=\"line\">ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb185144ea8.png\" alt=\"图12 平均变化折线图\" style=\"height:300px;\"></div><span class=\"image-caption\">图 12 平均变化折线图</span></div>\n<h3 id=\"按周统计累计情感指数\">按周统计累计情感指数 <a class=\"header-anchor\" href=\"#按周统计累计情感指数\">¶</a></h3>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">weekTotSenScore</span>(<span class=\"params\">df</span>):</span><br><span class=\"line\">    grouper = pd.Grouper(key=<span class=\"string\">\"StrTime\"</span>, freq=<span class=\"string\">\"W-MON\"</span>)</span><br><span class=\"line\">    data = df.groupby(grouper)[<span class=\"string\">\"score\"</span>].<span class=\"built_in\">sum</span>().to_frame()</span><br><span class=\"line\">    data.index = pd.date_range(start=wStart, end=wEnd, freq=<span class=\"string\">\"W-MON\"</span>).strftime(<span class=\"string\">\"%m-%d\"</span>)</span><br><span class=\"line\">    data.columns = [<span class=\"string\">\"score\"</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    vM = data[<span class=\"string\">\"score\"</span>].<span class=\"built_in\">abs</span>().<span class=\"built_in\">max</span>()</span><br><span class=\"line\">    norm = plt.Normalize(-vM, vM)</span><br><span class=\"line\">    sm = plt.cm.ScalarMappable(cmap=<span class=\"string\">\"coolwarm\"</span>, norm=norm)</span><br><span class=\"line\"></span><br><span class=\"line\">    ax = sns.barplot(x=data.index, y=data[<span class=\"string\">\"score\"</span>], hue=data[<span class=\"string\">\"score\"</span>], hue_norm=norm, palette=<span class=\"string\">\"coolwarm\"</span>)</span><br><span class=\"line\">    ax.set_xlabel(<span class=\"string\">\"Date\"</span>)</span><br><span class=\"line\">    plt.xticks(rotation=<span class=\"number\">60</span>)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> bar <span class=\"keyword\">in</span> ax.containers:</span><br><span class=\"line\">        ax.bar_label(bar, fontsize=<span class=\"number\">10</span>, fmt=<span class=\"string\">\"%.2f\"</span>)</span><br><span class=\"line\">    ax.get_legend().remove()</span><br><span class=\"line\"></span><br><span class=\"line\">    axpos = ax.get_position()</span><br><span class=\"line\">    caxpos = mtransforms.Bbox.from_extents(axpos.x1 + <span class=\"number\">0.02</span>, axpos.y0, axpos.x1 + <span class=\"number\">0.03</span>, axpos.y1)</span><br><span class=\"line\">    cax = ax.figure.add_axes(caxpos)</span><br><span class=\"line\"></span><br><span class=\"line\">    locator = mticker.MultipleLocator(<span class=\"number\">20</span>)</span><br><span class=\"line\">    formatter = mticker.StrMethodFormatter(<span class=\"string\">\"{x:.2f}\"</span>)</span><br><span class=\"line\">    cax.figure.colorbar(sm, cax=cax, ticks=locator, <span class=\"built_in\">format</span>=formatter)</span><br><span class=\"line\"></span><br><span class=\"line\">    ax.figure.set_size_inches(<span class=\"number\">20</span>, <span class=\"number\">8</span>)</span><br><span class=\"line\">    ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">    plt.show()</span><br><span class=\"line\">    plt.close()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> data[<span class=\"string\">\"score\"</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">totSenScore0 = weekTotSenScore(dfEs[<span class=\"number\">0</span>])</span><br><span class=\"line\">totSenScore1 = weekTotSenScore(dfEs[<span class=\"number\">1</span>])</span><br><span class=\"line\">_ = weekTotSenScore(dfE)</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb188b7e6c1.png\" alt=\"图13 按周统计累计情感指数\" style=\"height:300px;\"></div><span class=\"image-caption\">图 13 按周统计累计情感指数</span></div>\n<h3 id=\"累计情感指数变化折线图\">累计情感指数变化折线图 <a class=\"header-anchor\" href=\"#累计情感指数变化折线图\">¶</a></h3>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">ax = sns.lineplot(data=totSenScore0, linewidth=<span class=\"number\">3</span>, marker=<span class=\"string\">\"s\"</span>, markersize=<span class=\"number\">15</span>, label=labels[<span class=\"number\">0</span>])</span><br><span class=\"line\">ax = sns.lineplot(data=totSenScore1, linewidth=<span class=\"number\">3</span>, marker=<span class=\"string\">\"^\"</span>, markersize=<span class=\"number\">15</span>, ax=ax, label=labels[<span class=\"number\">1</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">ax.set_xlabel(<span class=\"string\">\"Date\"</span>)</span><br><span class=\"line\">plt.xticks(rotation=<span class=\"number\">60</span>)</span><br><span class=\"line\">ax.set_ylabel(<span class=\"string\">\"Total Sentiment Score\"</span>)</span><br><span class=\"line\">ax.set_xlim(<span class=\"number\">0</span>, <span class=\"number\">52</span>)</span><br><span class=\"line\">ax.legend(prop={<span class=\"string\">\"size\"</span>: <span class=\"number\">24</span>})</span><br><span class=\"line\"></span><br><span class=\"line\">ax.figure.set_size_inches(<span class=\"number\">20</span>, <span class=\"number\">8</span>)</span><br><span class=\"line\">ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb18bf41a2b.png\" alt=\"图14 累计变化折线图\" style=\"height:300px;\"></div><span class=\"image-caption\">图 14 累计变化折线图</span></div>\n<h3 id=\"每日平均情感分析\">每日平均情感分析 <a class=\"header-anchor\" href=\"#每日平均情感分析\">¶</a></h3>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">grouper = pd.Grouper(key=<span class=\"string\">\"hour\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">data = []</span><br><span class=\"line\"><span class=\"keyword\">for</span> k <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">2</span>):</span><br><span class=\"line\">    tmp = dfEs[k].groupby(grouper)[<span class=\"string\">\"score\"</span>].mean().sort_index()</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">24</span>):</span><br><span class=\"line\">        <span class=\"keyword\">if</span> i <span class=\"keyword\">in</span> tmp.index:</span><br><span class=\"line\">            data.append(tmp[i])</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            data.append(<span class=\"number\">0</span>)</span><br><span class=\"line\">    data.append(<span class=\"number\">0</span>)</span><br><span class=\"line\">data = pd.DataFrame(</span><br><span class=\"line\">    {</span><br><span class=\"line\">        <span class=\"string\">\"Score\"</span>: data,</span><br><span class=\"line\">        <span class=\"string\">\"Person\"</span>: [labels[<span class=\"number\">0</span>]] * <span class=\"number\">25</span> + [labels[<span class=\"number\">1</span>]] * <span class=\"number\">25</span>,</span><br><span class=\"line\">    }</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">xBins = [i <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">25</span>)]</span><br><span class=\"line\">ax = sns.histplot(</span><br><span class=\"line\">    data=data,</span><br><span class=\"line\">    x=xBins * <span class=\"number\">2</span>,</span><br><span class=\"line\">    bins=xBins,</span><br><span class=\"line\">    weights=<span class=\"string\">\"Score\"</span>,</span><br><span class=\"line\">    hue=<span class=\"string\">\"Person\"</span>,</span><br><span class=\"line\">    multiple=multiple,</span><br><span class=\"line\">    edgecolor=<span class=\"string\">\".3\"</span>,</span><br><span class=\"line\">    linewidth=<span class=\"number\">0.5</span>,</span><br><span class=\"line\">    palette=<span class=\"string\">\"dark\"</span>,</span><br><span class=\"line\">    alpha=<span class=\"number\">0.6</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">ax.set_xticks(<span class=\"built_in\">range</span>(<span class=\"number\">25</span>))</span><br><span class=\"line\">ax.set_xticklabels(<span class=\"built_in\">range</span>(<span class=\"number\">25</span>))</span><br><span class=\"line\">ax.set_xlabel(<span class=\"string\">\"Hour\"</span>)</span><br><span class=\"line\">ax.set_xlim(<span class=\"number\">0</span>, <span class=\"number\">24</span>)</span><br><span class=\"line\">ax.set_ylim(np.<span class=\"built_in\">min</span>([<span class=\"number\">0</span>, np.floor(data[<span class=\"string\">\"Score\"</span>].<span class=\"built_in\">min</span>() / <span class=\"number\">0.05</span>) * <span class=\"number\">0.05</span>]), np.ceil(data[<span class=\"string\">\"Score\"</span>].<span class=\"built_in\">max</span>() / <span class=\"number\">0.05</span>) * <span class=\"number\">0.05</span>)</span><br><span class=\"line\">sns.move_legend(ax, loc=<span class=\"string\">\"upper center\"</span>, bbox_to_anchor=(<span class=\"number\">0.5</span>, <span class=\"number\">1.2</span>), ncol=<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax.figure.set_size_inches(<span class=\"number\">8</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb190954b05.png\" alt=\"图15 每日平均情感分析\" style=\"height:300px;\"></div><span class=\"image-caption\">图 15 每日平均情感分析</span></div>\n<h3 id=\"每日累计情感分析\">每日累计情感分析 <a class=\"header-anchor\" href=\"#每日累计情感分析\">¶</a></h3>\n<figure class=\"highlight python\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">grouper = pd.Grouper(key=<span class=\"string\">\"hour\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">data = []</span><br><span class=\"line\"><span class=\"keyword\">for</span> k <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">2</span>):</span><br><span class=\"line\">    tmp = dfEs[k].groupby(grouper)[<span class=\"string\">\"score\"</span>].<span class=\"built_in\">sum</span>().sort_index()</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">24</span>):</span><br><span class=\"line\">        <span class=\"keyword\">if</span> i <span class=\"keyword\">in</span> tmp.index:</span><br><span class=\"line\">            data.append(tmp[i])</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            data.append(<span class=\"number\">0</span>)</span><br><span class=\"line\">    data.append(<span class=\"number\">0</span>)</span><br><span class=\"line\">data = pd.DataFrame(</span><br><span class=\"line\">    {</span><br><span class=\"line\">        <span class=\"string\">\"Score\"</span>: data,</span><br><span class=\"line\">        <span class=\"string\">\"Person\"</span>: [labels[<span class=\"number\">0</span>]] * <span class=\"number\">25</span> + [labels[<span class=\"number\">1</span>]] * <span class=\"number\">25</span>,</span><br><span class=\"line\">    }</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">xBins = [i <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">25</span>)]</span><br><span class=\"line\">ax = sns.histplot(</span><br><span class=\"line\">    data=data,</span><br><span class=\"line\">    x=xBins * <span class=\"number\">2</span>,</span><br><span class=\"line\">    bins=xBins,</span><br><span class=\"line\">    weights=<span class=\"string\">\"Score\"</span>,</span><br><span class=\"line\">    hue=<span class=\"string\">\"Person\"</span>,</span><br><span class=\"line\">    multiple=multiple,</span><br><span class=\"line\">    edgecolor=<span class=\"string\">\".3\"</span>,</span><br><span class=\"line\">    linewidth=<span class=\"number\">0.5</span>,</span><br><span class=\"line\">    palette=<span class=\"string\">\"dark\"</span>,</span><br><span class=\"line\">    alpha=<span class=\"number\">0.6</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">ax.set_xticks(<span class=\"built_in\">range</span>(<span class=\"number\">25</span>))</span><br><span class=\"line\">ax.set_xticklabels(<span class=\"built_in\">range</span>(<span class=\"number\">25</span>))</span><br><span class=\"line\">ax.set_xlabel(<span class=\"string\">\"Hour\"</span>)</span><br><span class=\"line\">ax.set_xlim(<span class=\"number\">0</span>, <span class=\"number\">24</span>)</span><br><span class=\"line\">ax.set_ylim(np.<span class=\"built_in\">min</span>([<span class=\"number\">0</span>, np.floor(data[<span class=\"string\">\"Score\"</span>].<span class=\"built_in\">min</span>() / <span class=\"number\">0.05</span>) * <span class=\"number\">0.05</span>]), np.ceil(data[<span class=\"string\">\"Score\"</span>].<span class=\"built_in\">max</span>() / <span class=\"number\">0.05</span>) * <span class=\"number\">0.05</span>)</span><br><span class=\"line\">sns.move_legend(ax, loc=<span class=\"string\">\"upper center\"</span>, bbox_to_anchor=(<span class=\"number\">0.5</span>, <span class=\"number\">1.2</span>), ncol=<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ax.figure.set_size_inches(<span class=\"number\">8</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">ax.figure.set_dpi(<span class=\"number\">150</span>)</span><br><span class=\"line\">plt.show()</span><br><span class=\"line\">plt.close()</span><br></pre></td></tr></tbody></table></figure>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/02/01/65bb1931b4174.png\" alt=\"图16 每日累计情感分析\" style=\"height:300px;\"></div><span class=\"image-caption\">图 16 每日累计情感分析</span></div>\n<h2 id=\"工具\">工具 <a class=\"header-anchor\" href=\"#工具\">¶</a></h2>\n<ol>\n<li><a href=\"https://github.com/LC044/WeChatMsg\">WeChatMsg</a></li>\n<li><a href=\"https://github.com/PaddlePaddle/PaddleNLP\">PaddleNLP</a></li>\n<li><a href=\"http://thuocl.thunlp.org/\">THUOCL：清华大学开放中文词库</a></li>\n<li><a href=\"https://github.com/goto456/stopwords\">中文常用停用词表</a></li>\n<li><a href=\"https://github.com/fxsjy/jieba\">jieba 中文分词</a></li>\n</ol>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://github.com/saturn-opposition/wechat_analysis\">wechat_analysis</a></li>\n<li><a href=\"http://xhslink.com/oC4OHA\">Python 制作日历图｜可视化聊天记录</a></li>\n<li><a href=\"http://xhslink.com/ZNdPHA\">1 年的聊天记录写成论文作为老婆生日礼物</a></li>\n<li><a href=\"http://xhslink.com/KqhPHA\">当我把和男朋友两年半的聊天记录可视化</a></li>\n<li><a href=\"http://xhslink.com/IOkPHA\">90 万人看过的聊天记录可视化第二弹来啦</a></li>\n<li><a href=\"https://stackoverflow.com/questions/49761221/make-seaborn-show-a-colorbar-instead-of-a-legend-when-using-hue-in-a-bar-plot\">Make seaborn show a colorbar instead of a legend when using hue in a bar plot?</a></li>\n<li><a href=\"https://zhajiman.github.io/post/matplotlib_colorbar/\">Matplotlib 系列：colorbar 的设置</a></li>\n<li><a href=\"https://blog.csdn.net/sinat_32570141/article/details/113048947\">matplotlib 绘图之坐标变换</a></li>\n</ol>\n","categories":["软件/程序"],"tags":["教程","Python","Jupyter","微信","聊天记录"]},{"title":"使君与府君，到底该怎么喊？","url":"/posts/202407-nameresearch.html","content":"<h2 id=\"前言\">前言 <a class=\"header-anchor\" href=\"#前言\">¶</a></h2>\n<p>三国演义中有一段经典剧情青梅煮酒论英雄，说献帝的舅舅董承与刘备暗中结盟欲除去曹操，刘备怕曹操生疑，因此每日浇水种豆。曹操听说后请刘备饮酒，议论天下英雄：</p>\n<blockquote>\n<p>  随至小亭，已设樽俎：盘置青梅，一樽煮酒。二人对坐，开怀畅饮。酒至半酣，忽阴云漠漠，骤雨将至。从人遥指天外龙挂，操与玄德凭栏观之。操曰：“使君知龙之变化否？” 玄德曰：“未知其详。” 操曰：“龙能大能小，能升能隐；大则兴云吐雾，小则隐介藏形；升则飞腾于宇宙之间，隐则潜伏于波涛之内。方今春深，龙乘时变化，犹人得志而纵横四海。龙之为物，可比世之英雄。玄德久历四方，必知当世英雄。请试指言之。” 玄德曰：“备肉眼安识英雄？” 操曰：“休得过谦。” 玄德曰：“备叨恩庇，得仕于朝。天下英雄，实有未知。” 操曰：“既不识其面，亦闻其名。” 玄德曰：“淮南袁术，兵粮足备，可为英雄？” 操笑曰：“冢中枯骨，吾早晚必擒之！” 玄德曰：“河北袁绍，四世三公，门多故吏；今虎踞冀州之地，部下能事者极多，可为英雄？“操笑曰：“袁绍色厉胆薄，好谋无断；干大事而惜身，见小利而忘命：非英雄也。玄德曰：“有一人名称七俊，威镇九州：刘景升可为英雄？” 操曰：“刘表虚名无实，非英雄也。” 玄德曰：“有一人血气方刚，江东领袖 —— 孙伯符乃英雄也？” 操曰：“孙策藉父之名，非英雄也。” 玄德曰：“益州刘季玉，可为英雄乎？” 操曰：“刘璋虽系宗室，乃守户之犬耳，何足为英雄！” 玄德曰：“如张绣、张鲁、韩遂等辈皆何如？” 操鼓掌大笑曰：“此等碌碌小人，何足挂齿！” 玄德曰：“舍此之外，备实不知。” 操曰：“夫英雄者，胸怀大志，腹有良谋，有包藏宇宙之机，吞吐天地之志者也。” 玄德曰：“谁能当之？” 操以手指玄德，后自指，曰：“今天下英雄，惟使君与操耳！” 玄德闻言，吃了一惊，手中所执匙箸，不觉落于地下。时正值天雨将至，雷声大作。玄德乃从容俯首拾箸曰：“一震之威，乃至于此。” 操曰：“丈夫亦畏雷乎？” 玄德曰：“圣人迅雷风烈必变，安得不畏？” 将闻言失箸缘故，轻轻掩饰过了。操遂不疑玄德。</p>\n</blockquote>\n<p>这一段内容在《三国志・蜀志二・先主传》中也有记载 <sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup>：</p>\n<blockquote>\n<p>  先主未出时，献帝舅车骑将军董承<sub>臣松之按：董承，汉灵帝母董太后之侄，于献帝为丈人。盖古无丈人之名，故谓之舅也。</sub>辞受帝衣带中密诏，当诛曹公。先主未发。是时曹公从容谓先主曰：「今天下英雄，惟<strong>使君</strong>与操耳。本初之徒，不足数也。」</p>\n</blockquote>\n<p>前段时间看小说的时候，和人讨论了这么一个问题，因此去查找了《后汉书》和《三国志》中的原文看看是什么情况，顺带也查看了一下《汉书》中的用法。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/07/04/668657dbe7ee4.jpg\" alt=\"image\" style=\"height:200px;\"></div></div>\n<h2 id=\"使君\">使君 <a class=\"header-anchor\" href=\"#使君\">¶</a></h2>\n<p>使君可以理解为身负使命的官员，特别是代表皇帝出使或者巡视地方的官员。元封五年（公元前 107 年），汉武帝将天下划分为 13 州，每州各派刺史一人监察所属州的郡国官员 <sup class=\"footnote-ref\"><a href=\"#fn2\" id=\"fnref2\">[2]</a></sup>。在众多地方官员中，刺史身负皇命，直接向皇帝负责，因此被称为使君，此外监察北军的北军中候，领护西羌的护羌校尉等被皇帝授予特殊使命的官员也被称为使君。</p>\n<p>使君最早出现在汉书中是在《汉书・卷六十六》。武帝末年，各地郡县盗贼群起，武帝任命暴胜之为直指使者，穿著绣衣，持御赐上方斧，故称为绣衣御史。暴胜之巡查各地，追捕盗贼诛杀两千石以下不听从命令的官吏。当暴胜之来到被阳时想要诛杀时任被阳县令王欣，而王欣已经解开衣服趴在案上，跟暴胜之说：“使君手握生杀的权利，已经威震郡国，今天再把我杀了，不足以增添您的权威。不如根据情况有所宽大，表明您的仁义，我愿意以后尽全力报答”。颜师古在此处作注称，暴胜之是皇帝的使者，故称为使君。<sup class=\"footnote-ref\"><a href=\"#fn3\" id=\"fnref3\">[3]</a></sup> 汉书中还有一处称呼使君的地方，出自《汉书・卷七十二》。王莽掌权后，故渤海太守、光禄大夫龚胜辞官回乡。等到王莽篡国，王莽多次派遣五威将帅、使者慰问龚胜，并征召龚胜担任太子师友祭酒，龚胜屡次拒绝，最终绝食而死。<sup class=\"footnote-ref\"><a href=\"#fn4\" id=\"fnref4\">[4]</a></sup></p>\n<p>《后汉书》、《三国志》中有关使君的记载统计如下：</p>\n<ul>\n<li>《后汉书・卷四十六》护羌校尉邓训 <sup class=\"footnote-ref\"><a href=\"#fn5\" id=\"fnref5\">[5]</a></sup></li>\n<li>《后汉书・卷四十六》更始帝使者 <sup class=\"footnote-ref\"><a href=\"#fn6\" id=\"fnref6\">[6]</a></sup></li>\n<li>《后汉书・卷六十一》并州牧郭伋 <sup class=\"footnote-ref\"><a href=\"#fn7\" id=\"fnref7\">[7]</a></sup></li>\n<li>《后汉书・卷七十一》兖州刺史第五种 <sup class=\"footnote-ref\"><a href=\"#fn8\" id=\"fnref8\">[8]</a></sup></li>\n<li>《后汉书・卷八十二》司隶校尉陈禅 <sup class=\"footnote-ref\"><a href=\"#fn9\" id=\"fnref9\">[9]</a></sup></li>\n<li>《后汉书・卷八十八》凉州刺史耿鄙 <sup class=\"footnote-ref\"><a href=\"#fn10\" id=\"fnref10\">[10]</a></sup></li>\n<li>《后汉书・卷八十八》凉州刺史梁鹄 <sup class=\"footnote-ref\"><a href=\"#fn11\" id=\"fnref11\">[11]</a></sup></li>\n<li>《后汉书・卷八十八》凉州刺史左昌 <sup class=\"footnote-ref\"><a href=\"#fn12\" id=\"fnref12\">[12]</a></sup></li>\n<li>《后汉书・卷一百》兖州牧曹操 <sup class=\"footnote-ref\"><a href=\"#fn13\" id=\"fnref13\">[13]</a></sup></li>\n<li>《后汉书・卷一百四》荆州刺史刘表 <sup class=\"footnote-ref\"><a href=\"#fn14\" id=\"fnref14\">[14]</a></sup></li>\n<li>《后汉书・卷一百五》扬州牧袁术 <sup class=\"footnote-ref\"><a href=\"#fn15\" id=\"fnref15\">[15]</a></sup></li>\n<li>《后汉书・卷一百十三》冀州刺史 <sup class=\"footnote-ref\"><a href=\"#fn16\" id=\"fnref16\">[16]</a></sup></li>\n<li>《后汉书・卷一百十七》中郎将任尚 <sup class=\"footnote-ref\"><a href=\"#fn17\" id=\"fnref17\">[17]</a></sup></li>\n<li>《三国志・魏志八》引韦曜《吴书》徐州牧陶谦 <sup class=\"footnote-ref\"><a href=\"#fn18\" id=\"fnref18\">[18]</a></sup></li>\n<li>《三国志・魏志十》兖州牧曹操 <sup class=\"footnote-ref\"><a href=\"#fn19\" id=\"fnref19\">[19]</a></sup></li>\n<li>《三国志・魏志十一》青州牧袁谭 <sup class=\"footnote-ref\"><a href=\"#fn20\" id=\"fnref20\">[20]</a></sup></li>\n<li>《三国志・魏志十四》兖州牧曹操 <sup class=\"footnote-ref\"><a href=\"#fn21\" id=\"fnref21\">[21]</a></sup></li>\n<li>《三国志・魏志二十三》引傅畅《晋诸公赞》代指上司 <sup class=\"footnote-ref\"><a href=\"#fn22\" id=\"fnref22\">[22]</a></sup></li>\n<li>《三国志・魏志二十四》幽州刺史崔林 <sup class=\"footnote-ref\"><a href=\"#fn23\" id=\"fnref23\">[23]</a></sup></li>\n<li>《三国志・魏志二十五》引皇甫谧《列女传》凉州刺史韦康 <sup class=\"footnote-ref\"><a href=\"#fn24\" id=\"fnref24\">[24]</a></sup></li>\n<li>《三国志・魏志二十八》引《魏略》兖州刺史令狐愚 <sup class=\"footnote-ref\"><a href=\"#fn25\" id=\"fnref25\">[25]</a></sup><sup class=\"footnote-ref\"><a href=\"#fn26\" id=\"fnref26\">[26]</a></sup></li>\n<li>《三国志・魏志二十九》冀州刺史裴徽 <sup class=\"footnote-ref\"><a href=\"#fn27\" id=\"fnref27\">[27]</a></sup></li>\n<li>《三国志・魏志三十》辅国将军鲜于辅 <sup class=\"footnote-ref\"><a href=\"#fn28\" id=\"fnref28\">[28]</a></sup></li>\n<li>《三国志・蜀志一》益州牧刘璋 <sup class=\"footnote-ref\"><a href=\"#fn29\" id=\"fnref29\">[29]</a></sup></li>\n<li>《三国志・蜀志二》豫州刺史刘备 <sup class=\"footnote-ref\"><a href=\"#fn30\" id=\"fnref30\">[30]</a></sup></li>\n<li>《三国志・蜀志二》左将军、豫州牧刘备 <sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1:1\">[1:1]</a></sup></li>\n<li>《三国志・蜀志二》益州牧刘璋 <sup class=\"footnote-ref\"><a href=\"#fn31\" id=\"fnref31\">[31]</a></sup></li>\n<li>《三国志・蜀志十五》尚书邓芝 <sup class=\"footnote-ref\"><a href=\"#fn32\" id=\"fnref32\">[32]</a></sup></li>\n<li>《三国志・吴志一》引张勃《吴录》荆州刺史王叡 <sup class=\"footnote-ref\"><a href=\"#fn33\" id=\"fnref33\">[33]</a></sup></li>\n<li>《三国志・吴志一》引虞溥《江表传》扬州刺史、徐州伯袁术 <sup class=\"footnote-ref\"><a href=\"#fn34\" id=\"fnref34\">[34]</a></sup><sup class=\"footnote-ref\"><a href=\"#fn35\" id=\"fnref35\">[35]</a></sup></li>\n<li>《三国志・吴志四》兖州刺史 <sup class=\"footnote-ref\"><a href=\"#fn36\" id=\"fnref36\">[36]</a></sup></li>\n<li>《三国志・吴志七》豫州牧诸葛瑾 <sup class=\"footnote-ref\"><a href=\"#fn37\" id=\"fnref37\">[37]</a></sup></li>\n<li>《三国志・吴志十五》大司马、扬州牧曹休 <sup class=\"footnote-ref\"><a href=\"#fn38\" id=\"fnref38\">[38]</a></sup></li>\n<li>《三国志・吴志十九》荆州牧诸葛恪 <sup class=\"footnote-ref\"><a href=\"#fn39\" id=\"fnref39\">[39]</a></sup></li>\n</ul>\n<p>上述统计中共出现刺史 13 人、司隶校尉 1 人、州牧 10 人、护羌校尉 1 人、中郎将 1 人、辅国将军 1 人、尚书 1 人、使者 1 人、不明上司 1 人（曹操、袁术、刘璋重复出现总计 4 次）。其中刺史为中央派至地方的监察官；司隶校尉是监察中央和司隶地区 <sup class=\"footnote-ref\"><a href=\"#fn40\" id=\"fnref40\">[40]</a></sup> 官员的监察官 <sup class=\"footnote-ref\"><a href=\"#fn41\" id=\"fnref41\">[41]</a></sup>；州牧由刺史升格而来；护羌校尉管理西羌事务，在晋惠帝元康时期被并入凉州刺史职责中 <sup class=\"footnote-ref\"><a href=\"#fn42\" id=\"fnref42\">[42]</a></sup>；中郎将、辅国将军、尚书职责变化较大，但任尚、鲜于辅等人也应当有监察西羌、鲜卑各部的职责。</p>\n<h2 id=\"府君\">府君 <a class=\"header-anchor\" href=\"#府君\">¶</a></h2>\n<p>府君在汉代多是对国相、太守的尊称，在《后汉书》和《三国志》的例子包括：</p>\n<ul>\n<li>《后汉书・卷三》郁林太守刘外（光武帝刘秀曾祖父，景帝曾孙，长沙定王刘发之孙，舂陵节侯刘买次子）<sup class=\"footnote-ref\"><a href=\"#fn43\" id=\"fnref43\">[43]</a></sup></li>\n<li>《后汉书・卷五》郁林太守刘外 <sup class=\"footnote-ref\"><a href=\"#fn44\" id=\"fnref44\">[44]</a></sup></li>\n<li>《后汉书・卷四十六》上谷太守耿况 <sup class=\"footnote-ref\"><a href=\"#fn6\" id=\"fnref6:1\">[6:1]</a></sup></li>\n<li>《后汉书・卷六十七》沛国相郭府君 <sup class=\"footnote-ref\"><a href=\"#fn45\" id=\"fnref45\">[45]</a></sup></li>\n<li>《后汉书・卷六十九》彭城太守孙萌 <sup class=\"footnote-ref\"><a href=\"#fn46\" id=\"fnref46\">[46]</a></sup></li>\n<li>《后汉书・卷七十三》南阳太守阮况 <sup class=\"footnote-ref\"><a href=\"#fn47\" id=\"fnref47\">[47]</a></sup></li>\n<li>《后汉书・卷八十六》南阳太守王畅 <sup class=\"footnote-ref\"><a href=\"#fn48\" id=\"fnref48\">[48]</a></sup></li>\n<li>《三国志・魏志二十三》河内太守王匡 <sup class=\"footnote-ref\"><a href=\"#fn49\" id=\"fnref49\">[49]</a></sup></li>\n<li>《三国志・魏志二十九》广陵太守陈登 <sup class=\"footnote-ref\"><a href=\"#fn50\" id=\"fnref50\">[50]</a></sup></li>\n<li>《三国志・吴志四》交址太守士燮 <sup class=\"footnote-ref\"><a href=\"#fn51\" id=\"fnref51\">[51]</a></sup></li>\n</ul>\n<h2 id=\"总结\">总结 <a class=\"header-anchor\" href=\"#总结\">¶</a></h2>\n<p>总体而言，在两汉三国时期，使君多用于称呼刺史以及与刺史同一级别的，带有监察性质或特殊使命的官员，而府君多用于称呼太守、国相。在两汉之后，使君、府君的使用范围逐渐扩大，演变为对他人的泛用尊称，例如：</p>\n<blockquote>\n<p>《世说新语・规茂》:<br>\n  闻贺司空出，至破冈，连名诣贺诉。贺曰 “身被微作礼官，不关此事。” 群小叩头曰：“若<strong>府君</strong>复不见治，便无所诉。”</p>\n</blockquote>\n<blockquote>\n<p>《宋史・外戚列传第二百二十二》:<br>\n  知青涧城种世衡又遣王嵩以枣及画龟为书置蜡丸中遗旺荣，谕以早归之意，欲元昊得之，疑旺荣。旺荣得之笑曰：「种<strong>使君</strong>亦长矣，何为此儿戏耶！」</p>\n</blockquote>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://zhuanlan.zhihu.com/p/44185732\">曹操为什么称呼刘备 “使君”，而 “使君” 一般代指何人？</a></li>\n<li><a href=\"https://ctext.org/wiki.pl?if=gb&amp;res=533615&amp;remap=gb\">颜师古注《汉书》</a></li>\n<li><a href=\"https://ctext.org/wiki.pl?if=gb&amp;res=716836&amp;remap=gb\">李贤注《后汉书》</a></li>\n<li><a href=\"https://ctext.org/wiki.pl?if=gb&amp;res=339496&amp;remap=gb\">裴松之注《三国志》</a></li>\n<li>吴会娟。中古汉语谦敬称谓研究 [D]. 南京师范大学，2008.</li>\n<li> 田顺芝.《三国演义》称谓词研究 [D]. 山东大学，2007.</li>\n</ol>\n<div class=\"note info flat\"><p>参考典籍所注内容字号均小于原文，位于下标位置。</p>\n</div>\n<hr class=\"footnotes-sep\">\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p>《三国志・蜀志二》：先主未出时，献帝舅车骑将军董承<sub>臣松之按：董承，汉灵帝母董太后之侄，于献帝为丈人。盖古无丈人之名，故谓之舅也。</sub>辞受帝衣带中密诏，当诛曹公。先主未发。是时曹公从容谓先主曰：「今天下英雄，惟<strong>使君</strong>与操耳。本初之徒，不足数也。」 <a href=\"#fnref1\" class=\"footnote-backref\">↩︎</a> <a href=\"#fnref1:1\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn2\" class=\"footnote-item\"><p>《汉书・卷六・武帝纪》：初置刺史部十三州。<sub>师古曰：「汉旧仪云初分十三州，假刺史印绶，有常治所。常以秋分行部，御史为驾四封乘传。到所部，郡国各遣一吏迎之界上，所察六条。」</sub> <a href=\"#fnref2\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn3\" class=\"footnote-item\"><p>《汉书・卷六十六・公孙刘田王杨蔡陈郑传第三十六》：武帝末，军旅数发，郡国盗贼羣起，绣衣御史暴胜之使持斧逐捕盗贼，以军兴从事，诛二千石以下。胜之过被阳，欲斩欣，欣已解衣伏质<sub>师古曰：「质，鍖也，欲斩人皆伏于鍖上也。鍖音竹林反。」</sub>，仰言曰：「<strong>使君</strong>颛杀生之柄<sub>师古曰：「为使者，故谓之</sub><sub><strong>使君</strong></sub><sub>。使音所吏反。颛与专同。」</sub>，威震郡国，今复斩一欣，不足以增威，不如时有所宽，以明恩贷<sub>师古曰：「贷犹假也，言饶假之。贷音土戴反。」</sub>，令尽死力。」 <a href=\"#fnref3\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn4\" class=\"footnote-item\"><p>《汉书・卷七十二・王贡两龚鲍传第四十二》：使者入户，西行南面立，致诏付玺书，迁延再拜奉印绶，内安车驷马，进谓胜曰：「圣朝未甞忘君，制作未定，待君为政，思闻所欲施行，以安海内。」胜对曰：「素愚，加以年老被病，命在朝夕，随<strong>使君</strong>上道<sub>师古曰：「示若尊敬使者，故谓之</sub><sub><strong>使君</strong></sub><sub>。」</sub>，必死道路，无益万分。」 <a href=\"#fnref4\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn5\" class=\"footnote-item\"><p>《后汉书・卷四十六・邓𡨥列传第六》：由是湟中诸胡<sub>湟中，月氏胡所居，今鄯州湟水县也。</sub>皆言：「汉家常欲鬬我曹，今<strong>邓使君</strong>待我以恩信，开门内我妻子，乃得父母！」咸欢喜叩头曰：「唯<strong>使君</strong>所命。」训遂抚养其中少年勇者数百人，以为义从。 <a href=\"#fnref5\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn6\" class=\"footnote-item\"><p>《后汉书・卷四十六・邓𡨥列传第六》：王莽败，更始立，使使者徇郡国，曰「先降者复爵位」。恂从耿况迎使者于界上，况上印绶，使者纳之，一宿无还意。恂勒兵入见使者，就请之。使者不与，曰：「天王使者，功曹欲胁之邪？」恂曰：「非敢胁<strong>使君</strong><sub>君者，尊之称也。</sub>，窃伤计之不详也。今天下初定，国信未宣，<strong>使君</strong>建节衔命以临四方，郡国莫不延颈倾耳，望风归命。今始至上谷而先堕大信<sub>堕，毁也。</sub>，沮向化之心，生离畔之隙，将复何以号令它郡乎？且<strong>耿府君</strong>在上谷，乆为吏人所亲，今易之，得贤则造次未安，不贤则秖更生乱。为<strong>使君</strong>计，莫若复之以安百姓。」 <a href=\"#fnref6\" class=\"footnote-backref\">↩︎</a> <a href=\"#fnref6:1\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn7\" class=\"footnote-item\"><p>《后汉书・卷六十一・郭杜孔张廉王苏羊贾陆列传》：始至行部，到西河美稷，有童儿数百，各骑竹马，道次迎拜。伋问「儿曹何自远来」<sub>曹，辈也。</sub>。对曰：「闻<strong>使君</strong>到，喜，故来奉迎。」伋辞谢之。及事讫，诸儿复送至郭外，问「<strong>使君</strong>何日当还」。伋谓别驾从事，计日当告之。 <a href=\"#fnref7\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn8\" class=\"footnote-item\"><p>《后汉书・卷七十一・第五锺离宋寒列传》：初，种为衞相，以门下掾孙斌贤，善遇之。及当徙斥，斌具闻超谋，乃谓其友人同县闾子直及高密甄子然曰：「盖盗憎其主，从来旧矣。<strong>第五使君</strong>当投裔土，而单超外属为彼郡守。夫危者易仆，可为寒心。吾今方追<strong>使君</strong>，庶免其难。若奉<strong>使君</strong>以还，将以付子。」 <a href=\"#fnref8\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn9\" class=\"footnote-item\"><p>《后汉书・卷八十二・崔駰列传》：时陈禅为司隷校尉，召瑗谓曰：「弟听祇上书，禅请为之证。」<sub>弟，但也。司马相如传曰：「弟如临邛。」</sub>瑗曰：「此譬犹儿妾屏语耳，愿<strong>使君</strong>勿复出口。」遂辞归，不复应州郡命。 <a href=\"#fnref9\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn10\" class=\"footnote-item\"><p>《后汉书・卷八十八・虞傅盖臧列传》：时刺史耿鄙委任治中程球，球为通奸利，士人怨之<sub>汉官曰，司隷功曹从事，即持中也。</sub>。中平四年，鄙率六郡兵讨金城贼王国、韩遂等。爕知鄙失衆，必败，谏曰：「<strong>使君</strong>统政日浅，人未知敎。孔子曰：『不敎人战，是谓弃之。』今率不习之人，越大陇之阻，将十举十危，而贼闻大军将至，必万人一心。边兵多勇，其锋难当，而新合之衆，上下未和，万一内变，虽悔无及。不若息军养德，明赏必罚。贼得宽挺<sub>挺，解也。</sub>，必谓我怯，羣恶争埶，其离可必。然后率已敎之人，讨已离之贼，其功可坐而待也。今不为万全之福，而就必危之祸，窃为<strong>使君</strong>不取。」鄙不从。行至狄道，果有反者，先杀程球，次害鄙，贼遂进围汉阳。城中兵少粮尽，爕犹固守。 <a href=\"#fnref10\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn11\" class=\"footnote-item\"><p>《后汉书・卷八十八・虞傅盖臧列传》：凉州刺史梁鹄畏惧贵戚，欲杀正和以免其负，乃访之于勋。勋素与正和有仇，或劝勋可因此报隙。勋曰：「不可。谋事杀良，非忠也；乘人之危，非仁也。」乃谏鹄曰：「夫绁食鹰鸢欲其鸷<sub>绁，系也。广雅曰：「鸷，执也。」苍颉解诂曰：「鸢，鸱也。」食音嗣。</sub>，鸷而亨之，将何用哉？」鹄从其言。正和喜于得免，而诣勋求谢。勋不见，曰：「吾为<strong>梁使君</strong>谋，不为苏正和也。」怨之如初。 <a href=\"#fnref11\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn12\" class=\"footnote-item\"><p>《后汉书・卷八十八・虞傅盖臧列传》：中平元年，北地羌胡与边章等寇乱陇右，刺史左昌因军兴断盗数千万<sub>断谓割截。</sub>。…… 皆曰：「左<strong>使君</strong>若早从君言，以兵临我，庶可自改。今罪已重，不得降也。」乃解围而去。昌坐断盗徵，以扶风宋枭代之<sub>续汉书「枭」字作「泉」也。</sub>。 <a href=\"#fnref12\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn13\" class=\"footnote-item\"><p>《后汉书・卷一百・郑孔荀列传》：兴平元年，操东击陶谦，使彧守甄城<sub>县名，属济阴郡，今濮州县也。「甄」今作「鄄」，音绢。</sub>，任以留事。会张邈、陈宫以兖州反操<sub>典略「宫字公台，东郡人。刚直烈壮，少与海内知名之士皆相连结」也。</sub>，而潜迎吕布。布旣至，诸城悉应之。邈乃使人谲彧曰<sub>谲，诈也。</sub>：「吕将军来助<strong>曹使君</strong>击陶谦，宜亟供军实。」 <a href=\"#fnref13\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn14\" class=\"footnote-item\"><p>《后汉书・卷一百四・袁绍刘表列传下》：初平元年，长沙太守孙坚杀荆州刺史王睿<sub>王氏谱曰：「睿字通曜，晋太保祥之伯父也。」吴录曰：「睿见执，惊曰：『我何罪？』坚曰：『坐无所知。』睿穷迫，刮金饮之而死。」</sub>，诏书以表为荆州刺史。时江南宗贼大盛，宗党共为贼。又袁术阻兵屯鲁阳，表不能得至，乃单马入宜城<sub>宜城，县，属南郡，本鄢，惠帝三年改名宜城。</sub>，请南郡人蒯越、襄阳人蔡瑁与共谋画<sub>傅子曰：「越字异度，魏太祖平荆州，与荀彧书曰：『不喜得荆州，喜得异度耳。』」</sub>。表谓越曰：「宗贼虽盛而衆不附，若袁术因之，祸必至矣。吾欲徵兵，恐不能集，其策焉出？」对曰：「理平者先仁义，理乱者先权谋。兵不在多，贵乎得人。袁术骄而无谋，宗贼率多贪暴。越有所素养者，使人示之以利，必持衆来。<strong>使君</strong>诛其无道，施其才用，威德旣行，襁负而至矣。兵集衆附，南据江陵，北守襄阳，荆州八郡<sub>汉官仪曰，荆州管长沙、零陵、桂阳、南阳、江夏、武陵、南郡、章陵等是也。</sub>可传檄而定。公路虽至，无能为也。」表曰：「善。」 <a href=\"#fnref14\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn15\" class=\"footnote-item\"><p>《后汉书・卷一百五・刘焉袁术吕布列传》：自孙坚死，子策复领其部曲，术遣击杨州刺史刘繇，破之，策因据江东。策闻术将欲僭号，与书谏曰：「董卓无道，陵虐王室，祸加太后，暴及弘农，天子播越，<sub>左传曰，王子朝云「兹不谷震荡播越」。播，迁也。越，逸也。言失其所居。</sub>宫庙焚毁，是以豪桀发愤，沛然俱起。<sub>沛然，自恣纵貌也。沛音片害反。</sub>元恶旣毙，幼主东顾，乃使王人奉命，宣明朝恩，偃武修文，与之更始。然而河北异谋于黑山，<sub>谓袁绍为兾州牧，与黑山贼相连。</sub>曹操毒被于东徐，刘表僭乱于南荆，公孙叛逆于朔北，正礼阻兵，<sub>刘繇也。</sub>玄德争盟，<sub>刘备也。</sub>是以未获从命，櫜弓戢戈。当谓<strong>使君</strong>与国同规，而舍是弗恤，完然有自取之志，<sub>完然，自得貌。</sub>惧非海内企望之意也。成汤讨桀，称『有夏多罪』；尚书汤誓曰：「有夏多罪，天命殛之。」武王伐纣，曰『殷有重罚』。<sub>史记曰：「武王遍告诸侯曰：『殷有重罚，不可不伐。』」</sub>此二王者，虽有圣德，假使时无失道之过，无由逼而取也。今主上非有恶于天下，徒以幼子胁于强臣，异于汤武之时也。又闻幼主明智聦敏，有夙成之德，夙，早也。天下虽未被其恩，咸归心焉。若辅而兴之，则旦、奭之美，率土所望也。<strong>使君</strong>五世相承，<sub>安生京，京生汤，汤生逢，逢生术，凡五代。</sub>为汉宰辅，荣宠之盛，莫与为比，宜効忠守节，以报王室。时人多惑图纬之言，妄牵非类之文，苟以恱主为美，不顾成败之计，古今所慎，可不孰虑！忠言逆耳，驳议致憎，<sub>驳，杂也，议不同也。前书张良曰：「忠言逆耳利于行，良药苦口利于病。」</sub>苟有益于尊明，无所敢辞。」术不纳，策遂绝之。 <a href=\"#fnref15\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn16\" class=\"footnote-item\"><p>《后汉书・卷一百十三・逸民列传》：台佟字孝威，<sub>佟音大冬反。</sub>魏郡邺人也。隐于武安山，<sub>武安县之山也。</sub>凿穴为居，采药自业。建初中，州辟不就。刺史行部，乃使从事致谒。佟载病往谢。刺史乃执贽见佟曰：<sub>嵇康高士传曰：「刺史执枣栗之贽往。」</sub>「孝威居身如是，甚苦，如何？」佟曰：「佟幸得保终性命，存神养和。如<strong>明使君</strong>奉宣诏书，夕惕庶事，反不苦邪？」遂去，隐逸，终不见。 <a href=\"#fnref16\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn17\" class=\"footnote-item\"><p>《后汉书・卷一百十七・西羌传》：后遣任尚为中郎将，将羽林、缇骑、五营子弟三千五百人，代班雄屯三辅。尚临行，怀令虞诩说尚曰：「<strong>使君</strong>频奉国命讨逐寇贼，三州屯兵二十馀万人，弃农桑，疲苦徭役，而未有功効，劳费日滋。若此出不克，诚为<strong>使君</strong>危之。」尚曰：「忧惶乆矣，不知所如。」诩曰：「兵法弱不攻强，走不逐飞，自然之埶也。今虏皆马骑，日行数百，来如风雨，去如绝弦，以步追之，埶不相及，所以旷而无功也。为<strong>使君</strong>计者，莫如罢诸郡兵，各令出钱数千，二十人共市一马，如此，可舍甲胄，驰轻兵，以万骑之衆，逐数千之虏，追尾掩𢧵，<sub>尾犹寻也。</sub>其道自穷。便人利事，大功立矣。」尚大喜，即上言用其计。乃遣轻骑钞击杜季贡于丁奚城，斩首四百馀级，获牛马羊数千头。 <a href=\"#fnref17\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn18\" class=\"footnote-item\"><p>《三国志・魏志八》：兴平元年，复东征，略定琅邪、东海诸县。谦恐，欲走归丹杨。会张邈叛迎吕布，太祖还击布。是岁，谦病死。<sub>吴书曰：谦死时，年六十三，张昭等为之哀辞曰：“猗欤</sub><sub><strong>使君</strong></sub><sub>，君侯将军，膺秉懿德，允武允文，体足刚直，守以温仁。令舒及卢，遗爱于民；牧幽曁徐，甘棠是均。憬憬夷貊，赖侯以清；蠢蠢妖寇，匪侯不宁。唯帝念绩，爵命以章，旣牧且侯，启土溧阳。遂升上将，受号安东，将平世难，社稷是崇。降年不永，奄忽殂薨，丧覆失恃，民知困穷。曾不旬日，五郡溃崩，哀我人斯，将谁仰凭？追思靡及，仰叫皇穹。呜呼哀哉！” 谦二子：商、应，皆不仕。</sub> <a href=\"#fnref18\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn19\" class=\"footnote-item\"><p>《三国志・魏志十》：明年，太祖领兖州牧，后为镇东将军，彧常以司马从。兴平元年，太祖征陶谦，任彧留事。会张邈、陈宫以兖州反，潜迎吕布。布旣至，邈乃使刘翊告彧曰：「吕将军来助<strong>曹使君</strong>击陶谦，宜亟供其军食。」 <a href=\"#fnref19\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn20\" class=\"footnote-item\"><p>《三国志・魏志十一》：谭复欲攻尚，修谏曰：「兄弟还相攻击，是败亡之道也。」谭不恱，然知其忠节。后又问修：「计安出？」修曰：「夫兄弟者，左右手也。譬人将鬬而断其右手，而曰『我必胜』，若是者可乎？夫弃兄弟而不亲，天下其谁亲之！属有谗人，固将交鬬其间，以求一朝之利，愿<strong>明使君</strong>塞耳勿听也。若斩佞臣数人，复相亲睦，以御四方，可以横行天下。」谭不听，遂与尚相攻击，请救于太祖。 <a href=\"#fnref20\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn21\" class=\"footnote-item\"><p>《三国志・魏志十四》：刘岱为黄巾所杀。太祖临兖州，辟昱。…… 昱乃归，过范，说其令靳允曰：「闻吕布执君母弟妻子，孝子诚不可为心！今天下大乱，英雄并起，必有命世，能息天下之乱者，此智者所详择也。得主者昌，失主者亡。陈宫叛迎吕布而百城皆应，似能有为，然以君观之，布何如人哉！夫布，粗中少亲，刚而无礼，匹夫之雄耳。宫等以势假合，不能相君也。兵虽衆，终必无成。<strong>曹使君</strong>智略不世出，殆天所授！君必固范，我守东阿，则田单之功可立也。孰与违忠从恶而母子俱亡乎？唯君详虑之！」允流涕曰：「不敢有贰心。」时泛嶷已在县，允乃见嶷，伏兵刺杀之，归勒兵守。 <a href=\"#fnref21\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn22\" class=\"footnote-item\"><p>《三国志・魏志二十三》：<sub>繇为人机捷，善持论，而干讷口，临时屈无以应。繇谓干曰：「公羊高竟为左丘明服矣。」干曰：「直故吏为</sub><sub><strong>明使君</strong></sub><sub>服耳，公羊未肯也。」</sub> <a href=\"#fnref22\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn23\" class=\"footnote-item\"><p>《三国志・魏志二十四》：文帝践阼，拜尚书，出为幽州刺史。北中郎将吴质统河北军事，涿郡太守王雄谓林别驾曰：「吴中郎将，上所亲重，国之贵臣也。杖节统事，州郡莫不奉笺致敬，而<strong>崔使君</strong>初不与相闻。若以边塞不修斩卿，<strong>使君</strong>宁能护卿邪？」 <a href=\"#fnref23\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn24\" class=\"footnote-item\"><p>《三国志・魏志二十五》：陇右平定，太祖封讨超之功，侯者十一人，赐阜爵关内侯。阜让曰：「阜君存无捍难之功，君亡无死节之効，于义当绌，于法当诛；超又不死，无宜苟荷爵禄。」太祖报曰：「君与羣贤共建大功，西土之人以为美谈。子贡辞赏，仲尼谓之止善。君其剖心以顺国命。姜叙之母，劝叙早发，明智乃尔，虽杨敞之妻盖不过此。贤哉，贤哉！良史记录，必不坠于地矣。」<sub>皇甫谧列女传曰：姜叙母者，天水姜伯弈之母也。建安中，马超攻兾，害凉州刺史韦康，州人凄然，莫不感愤。叙为抚夷将军，拥兵屯历。叙姑子杨阜，故为康从事，同等十馀人，皆略属超，阴相结为康报仇，未有闲。会阜妻死，辞超宁归西，因过至历，候叙母，说康被害及兾中之难，相对泣良乆。姜叙举室感悲，叙母曰：「咄！伯弈，</sub><sub><strong>韦使君</strong></sub><sub>遇难，岂一州之耻，亦汝之负，岂独义山哉？汝无顾我，事淹变生。人谁不死？死国，忠义之大者。但当速发，我自为汝当之，不以馀年累汝也。」</sub> <a href=\"#fnref24\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn25\" class=\"footnote-item\"><p>《三国志・魏志二十八》：<sub>魏书曰：愚字公浩，本名浚，黄初中，为和戎护军。乌丸校尉田豫讨胡有功，小违节度，愚以法绳之。帝怒，械系愚，免官治罪，诏曰「浚何愚」！遂以名之。正始中，为曹爽长史，后出为兖州刺史。魏畧曰：愚闻楚王彪有智勇。初东郡有譌言云：「白马河出妖马，夜过官牧边鸣呼，衆马皆应，明日见其迹，大如斛，行数里，还入河中。」又有谣言：「白马素羁西南驰，其谁乘者朱虎骑。」楚王小字朱虎，故愚与王淩阴谋立楚王。乃先使人通意于王，言「</sub><sub><strong>使君</strong></sub><sub>谢王，天下事不可知，愿王自爱」！彪亦阴知其意，荅言「谢</sub><sub><strong>使君</strong></sub><sub>，知厚意也。」</sub> <a href=\"#fnref25\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn26\" class=\"footnote-item\"><p>《三国志・魏志二十八》：<sub>魏畧载：山阳单固，字恭夏，为人有器实。正始中，兖州刺史令狐愚与固父伯龙善，辟固，欲以为别驾。固不乐为州吏，辞以疾。愚礼意愈厚，固不欲应。固母夏侯氏谓固曰：「</sub><sub><strong>使君</strong></sub><sub>与汝父乆善，故命汝不止，汝亦故当仕进，自可往耳。」固不获已，遂往，与兼治中从事杨康并为愚腹心。后愚与王淩通谋，康、固皆知其计。会愚病，康应司徒召诣洛阳，固亦以疾解禄。康在京师露其事，太傅乃东取王淩。到寿春，固见太傅，太傅问曰：「卿知其事为邪？」固对不知。太傅曰：「且置近事。问卿，令狐反乎？」固又曰无。而杨康白，事事与固连。遂收捕固及家属，皆系廷尉，考实数十，固故云无有。太傅录杨康，与固对相诘。固辞穷，乃骂康曰：「老庸旣负</sub><sub><strong>使君</strong></sub><sub>，又灭我族，顾汝当活邪！」</sub> <a href=\"#fnref26\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn27\" class=\"footnote-item\"><p>《三国志・魏志二十九》：当此之时，辂之邻里，外户不闭，无相偷窃者。清河太守华表，召辂为文学掾。安平赵孔曜荐辂于兾州刺史裴徽曰：「辂雅性宽大，与世无忌，仰观天文则同妙甘公、石申，俯览周易则齐思季主。今<strong>明使君</strong>方垂神幽薮，留精九臯，辂宜蒙阴和之应，得及羽仪之时。」徽于是辟为文学从事，引与相见，大善友之。徙部钜鹿，迁治中别驾。 <a href=\"#fnref27\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn28\" class=\"footnote-item\"><p>《三国志・魏志三十》：比能使别小帅琐奴拒豫，豫进讨，破走之，由是怀贰。乃与辅国将军鲜于辅书曰：「夷狄不识文字，故校尉阎柔保我于天子。我与素利为雠，往年攻击之，而田校尉助素利。我临阵使琐奴往，闻<strong>使君</strong>来，即便引军退。步度根数数钞盗，又杀我弟，而诬我以钞盗。我夷狄虽不知礼义，兄弟子孙受天子印绶，牛马尚知美水草，况我有人心邪！将军当保明我于天子。」辅得书以闻帝，帝复使豫招纳安慰。 <a href=\"#fnref28\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn29\" class=\"footnote-item\"><p>《三国志・蜀志一》：州大吏赵韪等贪璋温仁，共上璋为益州刺史，诏书因以为监军使者，领益州牧，以韪为征东中郎将，率衆击刘表。…… 璋复遣别驾张松诣曹公，曹公时已定荆州，走先主，不复存录松，松以此怨。会曹公军不利于赤壁，兼以疫死。松还，疵毁曹公，劝璋自绝，<sub>汉书春秋曰：张松见曹公，曹公方自矜伐，不存录松。松归，乃劝璋自绝。习凿齿曰：昔齐桓一矜其功而叛者九国，曹操暂自骄伐而天下三分，皆勤之于数十年之内而弃之于俯仰之顷，岂不惜乎！是以君子劳谦日仄，虑以下人，功高而居之以让，势尊而守之以卑。情近于物，故虽贵而人不猒其重；德洽羣生，故业广而天下愈欣其庆。夫然，故能有以富贵，保其功业，隆显当时，传福百世，何骄矜之有哉！君子是以知曹操之不能遂兼天下者也。</sub>因说璋曰：「刘豫州，<strong>使君</strong>之肺腑，可与交通。」璋皆然之，遣法正连好先主，寻又令正及孟达送兵数千助先主守御，正遂还。 <a href=\"#fnref29\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn30\" class=\"footnote-item\"><p>《三国志・蜀志二》：谦表先主为豫州刺史，屯小沛。谦病笃，谓别驾麋竺曰：「非刘备不能安此州也。」谦死，竺率州人迎先主，先主未敢当。下邳陈登谓先主曰：「今汉室陵迟，海内倾覆，立功立事，在于今日。彼州殷富，户口百万，欲屈<strong>使君</strong>抚临州事。」先主曰：「袁公路近在寿春，此君四世五公，海内所归，君可以州与之。」登曰：「公路骄豪，非治乱之主。今欲为<strong>使君</strong>合步骑十万，上可以匡主济民，成五霸之业，下可以割地守境，书功于竹帛。若<strong>使君</strong>不见听许，登亦未敢听<strong>使君</strong>也。」 <a href=\"#fnref30\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn31\" class=\"footnote-item\"><p>《三国志・蜀志二》：十六年，益州牧刘璋遥闻曹公将遣锺繇等向汉中讨张鲁，内怀恐惧。别驾从事蜀郡张松说璋曰：「曹公兵强无敌于天下，若因张鲁之资以取蜀土，谁能御之者乎？」璋曰：「吾固忧之而未有计。」松曰：「刘豫州，<strong>使君</strong>之宗室而曹公之深雠也，善用兵，若使之讨鲁，鲁必破。鲁破，则益州强，曹公虽来，无能为也。」璋然之，遣法正将四千人迎先主，前后赂遗以巨亿计。正因陈益州可取之策。 <a href=\"#fnref31\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn32\" class=\"footnote-item\"><p>《三国志・蜀志十五》：（芝）所在清严有治绩，入为尚书。先主薨于永安。先是，吴王孙权请和，先主累遣宋玮、费禕等与相报荅。丞相诸葛亮深虑权闻先主殂陨，恐有异计，未知所如。芝见亮曰：「今主上幼弱，初在位，宜遣大使重申吴好。」亮荅之曰：「吾思之乆矣，未得其人耳，今日始得之。」芝问其人为谁？亮曰：「即<strong>使君</strong>也。」乃遣芝修好于权。 <a href=\"#fnref32\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn33\" class=\"footnote-item\"><p>《三国志・吴志一》：灵帝崩，卓擅朝政，横恣京城。诸州郡并兴义兵，欲以讨卓。<sub>江表传曰：坚闻之，拊膺叹曰：「张公昔从吾言，朝廷今无此难也。」</sub>坚亦举兵。荆州刺史王睿素遇坚无礼，坚过杀之。<sub>案王氏谱，睿字通耀，晋太保祥伯父也。吴录曰：睿先与坚共击零、桂贼，以坚武官，言颇轻之。及睿举兵欲讨卓，素与武陵太守曹寅不相能，杨言当先杀寅。寅惧，诈作案行使者光禄大夫温毅檄，移坚，说睿罪过，令收行刑讫，以状上。坚即承檄勒兵袭睿。睿闻兵至，登楼望之，遣问欲何为，坚前部荅曰：「兵乆战劳苦，所得赏，不足以为衣服，诣</sub><sub><strong>使君</strong></sub><sub>更乞资直耳。」睿曰：「刺史岂有所吝？」便开库藏，使自入视之，知有所遗不。兵进及楼下，睿见坚，惊曰：「兵自求赏，</sub><sub><strong>孙府君</strong></sub><sub>何以在其中？」坚曰：「被使者檄诛君。」睿曰：「我何罪？」坚曰：「坐无所知。」睿穷迫，刮金饮之而死。</sub> <a href=\"#fnref33\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn34\" class=\"footnote-item\"><p>《三国志・吴志一》：徐州牧陶谦深忌策。策舅吴景，时为丹杨太守，策乃载母徙曲阿，与吕范、孙河俱就景，因缘召募得数百人。兴平元年，从袁术。术甚奇之，以坚部曲还策。<sub>江表传曰：策径到寿春见袁术，涕泣而言曰：「亡父昔从长沙入讨董卓，与</sub><sub><strong>使君</strong></sub><sub>会于南阳，同盟结好；不幸遇难，勋业不终。策感惟先人旧恩，欲自凭结，愿</sub><sub><strong>明使君</strong></sub><sub>垂察其诚。」术甚贵异之，然未肯还其父兵。术谓策曰：「孤始用贵舅为丹杨太守，贤从伯阳为都尉，彼精兵之地，可还依召募。」策遂诣丹杨依舅，得数百人，而为泾县大帅祖郎所袭，几至危殆。于是复往见术，术以坚馀兵千馀人还策。</sub> <a href=\"#fnref34\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn35\" class=\"footnote-item\"><p>《三国志・吴志一》：策乃说术，乞助景等平定江东。<sub>江表传曰：策说术云：「家有旧恩在东，愿助舅讨横江；横江拔，因投本土召募，可得三万兵，以佐</sub><sub><strong>明使君</strong></sub><sub>匡济汉室。」术知其恨，而以刘繇据曲阿，王朗在会稽，谓策未必能定，故许之。</sub> <a href=\"#fnref35\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn36\" class=\"footnote-item\"><p>《三国志・吴志四》：平原陶丘洪荐繇，欲令举茂才。刺史曰：「前年举公山，柰何复举正礼乎？」洪曰：「若<strong>明使君</strong>用公山于前，擢正礼于后，所谓御二龙于长涂，骋骐骥于千里，不亦可乎！」 <a href=\"#fnref36\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn37\" class=\"footnote-item\"><p>《三国志・吴志七》：颍川周昭著书称步骘及严畯等曰：「古今贤士大夫所以失名丧身倾家害国者，其由非一也，然要其大归，总其常患，四者而已。急而论议一也，争名势二也，重朋党三也，务欲速四也。急论议则伤人，争名势则败友，重朋党则蔽主，务欲速则失德，此四者不除，未有能全也。当世君子能不然者，亦比有之，岂独古人乎！然论其绝异，未若顾豫章、<strong>诸葛使君</strong>、步丞相、严衞尉、张奋威之为美也。论语言『夫子恂恂然善诱人』，又曰『成人之美，不成人之恶』，豫章有之矣。『望之俨然，即之也温，听其言也厉』，<strong>使君</strong>体之矣。『恭而安，威而不猛』，丞相履之矣。学不求禄，心无苟得，衞尉、奋威蹈之矣。此五君者，虽德实有差，轻重不同，至于趣舍大检，不犯四者，俱一揆也。昔丁諝出于孤家，吾粲由于牧竖，豫章扬其善，以并陆、全之列，是以人无幽滞而风俗厚焉。<strong>使君</strong>、丞相、衞尉三君，昔以布衣俱相友善，诸论者因各叙其优劣。初，先衞尉，次丞相，而后有<strong>使君</strong>也；其后并事明主，经营世务，出处之才有不同，先后之名须反其初，此世常人所决勤薄也。至于三君分好，卒无亏损，岂非古人交哉！又鲁横江昔杖万兵，屯据陆口，当世之美业也，能与不能，孰不愿焉？而横江旣亡，衞尉应其选，自以才非将帅，深辞固让，终于不就。后徙九列，迁典八座，荣不足以自曜，禄不足以自奉。至于二君，皆位为上将，穷富极贵。衞尉旣无求欲，二君又不称荐，各守所志，保其名好。孔子曰：『君子矜而不争，羣而不党。』斯有风矣。又奋威之名，亦三君之次也，当一方之戍，受上将之任，与<strong>使君</strong>、丞相不异也。然历国事，论功劳，实有先后，故爵位之荣殊焉。而奋威将处此，决能明其部分，心无失道之欲，事无充诎之求，每升朝堂，循礼而动，辞气謇謇，罔不惟忠。叔嗣虽亲贵，言忧其败，蔡文至虽疏贱，谈称其贤。女配太子，受礼若吊，慷忾之趋，惟笃人物，成败得失，皆如所虑，可谓守道见机，好古之士也。若乃经国家，当军旅，于驰骛之际，立霸王之功，此五者未为过人。至其纯粹履道，求不苟得，升降当世，保全名行，邈然绝俗，实有所师。故粗论其事，以示后之君子。」周昭者字恭远，与韦曜、薛莹、华核并述吴书，后为中书郎，坐事下狱，核表救之，孙休不听，遂伏法云。 <a href=\"#fnref37\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn38\" class=\"footnote-item\"><p>《三国志・吴志十五》：被命密求山中旧族名帅为北敌所闻知者，令谲挑魏大司马扬州牧曹休。鲂答，恐民帅小丑不足仗任，事或漏泄，不能致休，乞遣亲人赍笺七条以诱休：…… 一则伤慈损计，二则杜绝向化者心，惟<strong>明使君</strong>远览前世，矜而愍之，留神所质，速赐秘报。…… 愿<strong>明使君</strong>少垂详察，忖度其言。今此郡民，虽外名降首，而故在山草，看伺空隙，欲复为乱，为乱之日，鲂命讫矣。…… 若<strong>明使君</strong>以万兵从皖南首江渚，鲂便从此率厉吏民，以为内应。此方诸郡，前后举事，垂成而败者，由无外援使其然耳；若北军临境，传檄属城，思咏之民，谁不企踵？愿<strong>明使君</strong>上观天时，下察人事，中参蓍龟，则足昭往言之不虚也。…… 私恐<strong>使君</strong>未深保明，岑、南二人可留其一，以为后信。…… 今<strong>使君</strong>若从皖道进住江上，鲂当从南对岸历口为应。…… <strong>明使君</strong>速垂救济，诚宜疾密。王靖之变，其鉴不远。今鲂归命，非复在天，正在<strong>明使君</strong>耳。若见救以往，则功可必成，如见救不时，则与靖等同祸。前彭绮时，闻旌麾在逢龙，此郡民大小欢喜，并思立效。若留一月日间，事当大成，恨去电速，东得增衆专力讨绮，绮始败耳。愿<strong>使君</strong>深察此言。 <a href=\"#fnref38\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn39\" class=\"footnote-item\"><p>《三国志・吴志十九》：会逊卒，恪迁大将军，假节，驻武昌，代逊领荆州事。……\t及将见，驻车宫门，峻已伏兵于帷中，恐恪不时入，事泄，自出见恪曰：「<strong>使君</strong>若尊体不安，自可须后，峻当具白主上。」欲以甞知恪。恪荅曰：「当自力入。」散骑常侍张约、朱恩等密书与恪曰：「今日张设非常，疑有他故。」恪省书而去。未出路门，逢太常滕胤，恪曰：「卒腹痛，不任入。」胤不知峻阴计，谓恪曰：「君自行旋未见，今上置酒请君，君已至门，宜当力进。」恪踌躇而还，劒履上殿，谢亮，还坐。设酒，恪疑未饮，峻因曰：「<strong>使君</strong>病未善平，当有常服药酒，自可取之。」 <a href=\"#fnref39\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn40\" class=\"footnote-item\"><p>司隶地区：首都及其周边地区，在两汉指三辅、三河以及弘农地区，包括京兆尹、左冯翊、右扶风、河东、河南、河内和弘农。 <a href=\"#fnref40\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn41\" class=\"footnote-item\"><p>《汉书・百官公卿表》：司隶校尉，周官，武帝征和四年初置。持节，从中都官徒千二百人，捕巫蛊，督大奸猾。后罢其兵。察三辅、三河、弘农。元帝初元四年去节。成帝元延四年省。绥和二年，哀帝复置，但为司隶，冠进贤冠，属大司空，比司直。 <a href=\"#fnref41\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn42\" class=\"footnote-item\"><p>《晋书・志第十四・职官》：护羌、夷、蛮等校尉，案武帝置南蛮校尉于襄阳，西戎校尉于长安，南夷校尉于宁州。元康中，护羌校尉为凉州刺史，西戎校尉为雍州刺史，南蛮校尉为荆州刺史。及江左初，省南蛮校尉，寻又置于江陵，改南夷校尉曰镇蛮校尉。及安帝时，于襄阳置宁蛮校尉。 <a href=\"#fnref42\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn43\" class=\"footnote-item\"><p>《后汉书・卷三・帝纪第三肃宗孝章皇帝》：辛丑，幸章陵，祠旧宅园庙，见宗室故人，赏赐各有差。冬十月己未，进幸江陵，诏庐江太守祠南岳，又诏长沙、零陵太守祠长沙定王、舂陵节侯、<strong>郁林府君</strong>。还，幸宛。十一月己丑，车驾还宫，赐从者各有差。 <a href=\"#fnref43\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn44\" class=\"footnote-item\"><p>《后汉书・卷三・帝纪第五孝安皇帝》：庚申，幸宛，帝不豫。辛酉，令大将军耿宝行太尉事。祠章陵园庙，告长沙、零陵太守，祠定王、节侯、<strong>郁林府君</strong>。乙丑，自宛还。丁卯，幸叶，帝崩于乘舆，年三十二。 <a href=\"#fnref44\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn45\" class=\"footnote-item\"><p>《后汉书・卷六十七・桓荣丁鸿列传第二十七》：父麟，字元凤，早有才惠。<sub>华峤书曰「酆生麟」也。</sub>桓帝初，为议郎，入侍讲禁中，以直道啎左右，出为许令，<sub>许，县名，今许州许昌县也。</sub>病免。会母终，麟不胜丧，未祥而卒，年四十一。所著碑、诔、赞、说、书凡二十一篇。<sub>案挚虞文章志，麟文见在者十八篇，有碑九首，诔七首，七说一首，沛相</sub><sub><strong>郭府君</strong></sub><sub>书一首。</sub> <a href=\"#fnref45\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn46\" class=\"footnote-item\"><p>《后汉书・卷六十九・刘赵淳于江刘周赵列传第二十九》：建武初，平狄将军庞萌反于彭城，攻败郡守孙萌。平时复为郡吏，冒白刃伏萌身上，被七创，困顿不知所为，号泣请曰：「愿以身代<strong>府君</strong>。」贼乃敛兵止，曰：「此义士也，勿杀。」遂解去。萌伤甚气绝，有顷苏，渴求饮。平倾其创血以饮之。后数日萌竟死，平乃裹创，扶送萌丧，至其本县。 <a href=\"#fnref46\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn47\" class=\"footnote-item\"><p>《后汉书・卷七十三・朱乐何列传第三十三》：朱晖字文季，南阳宛人也。…… 后为郡吏，太守阮况甞欲市晖婢，晖不从。<sub>东观记曰：「晖为督邮，况当归女，欲买晖婢，晖不敢与。后况卒，晖送其家金三斤。」</sub>及况卒，晖乃厚赠送其家。人或讥焉，晖曰：「前<strong>阮府君</strong>有求于我，所以不敢闻命，诚恐以财货汚君。今而相送，明吾非有爱也。」 <a href=\"#fnref47\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn48\" class=\"footnote-item\"><p>《后汉书・卷八十六・张王种陈列传第四十六》：畅字叔茂。…… 由是复为尚书。寻拜南阳太守。…… 郡中豪族多以奢靡相尚，畅常布衣皮褥，车马羸败，以矫其敝。同郡刘表时年十七，从畅受学。进谏曰：「夫奢不僭上，俭不逼下，<sub>礼记曰「君子上不僭上，下不逼下」也。</sub>循道行礼，贵处可否之闲。蘧伯玉耻独为君子。<strong>府君</strong>不希孔圣之明训，而慕夷齐之末操，<sub>论语孔子曰：「奢则不逊，俭则固。」言仲尼得奢俭之中，而夷齐饥死，是末操也。</sub>无乃皎然自贵于世乎？」畅曰：「昔公仪休在鲁，拔园葵，去织妇；<sub>史记曰，鲁相公仪休之其家，见织帛，怒而出其妇，食于舍而茹葵，愠而拔其葵，曰：「吾已食禄，又夺园夫女子利乎？」</sub>孙叔敖相楚，其子被裘刈薪。<sub>史记曰，孙叔敖为楚相，且死，属其子曰：「我死，汝贫困，往见优孟，言孙叔敖子也。」居数年，其子贫，负薪逢优孟。优孟言之于王，封之寝丘四百户也。</sub>夫以约失之鲜矣。<sub>论语孔子之辞也。言俭则无失。</sub>闻伯夷之风者，贪夫廉，懦夫有立志。<sub>孟子之辞。</sub>虽以不德，敢慕遗烈。」 <a href=\"#fnref48\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn49\" class=\"footnote-item\"><p>《三国志・魏志二十三》：常林字伯槐，河内温人也。…… 太守王匡起兵讨董卓，遣诸生于属县微伺吏民罪负，便收之，考责钱谷赎罪，稽迟则夷灭宗族，以崇威严。林叔父檛客，为诸生所白，匡怒收治。举宗惶怖，不知所责多少，惧系者不救。林往见匡同县胡母彪曰：“<strong>王府君</strong>以文武高才，临吾鄙郡。鄙郡表里山河，土广民殷，又多贤能，惟所择用。今主上幼冲，贼臣虎据，华夏震栗，雄才奋用之秋也。若欲诛天下之贼，扶王室之微，智者望风，应之若响，克乱在和，何征不捷。苟无恩德，任失其人，覆亡将至，何暇匡翼朝廷，崇立功名乎？君其藏之！” 因说叔父见拘之意。 <a href=\"#fnref49\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn50\" class=\"footnote-item\"><p>《三国志・魏志二十九》：广陵太守陈登得病，胷中烦懑，靣赤不食。佗脉之曰：“<strong>府君</strong>胃中有虫数升，欲成内疽，食腥物所为也。” 即作汤二升，先服一升，斯须尽服之。食顷，吐出三升许虫，赤头皆动，半身是生鱼脍也，所苦便愈。佗曰：“此病后三期当发，遇良医乃可济救。” 依期果发动，时佗不在，如言而死。 <a href=\"#fnref50\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn51\" class=\"footnote-item\"><p>《三国志・吴志四》：父赐丧阕后，举茂才，除巫令，迁交址太守。…… 燮体器宽厚，谦虚下士，中国士人往依避难者以百数。耽玩春秋，为之注解。陈国袁徽与尚书令荀彧书曰：“交址<strong>士府君</strong>旣学问优博，又达于从政，处大乱之中，保全一郡，二十馀年疆埸无事，民不失业，羁旅之徒，皆蒙其庆，虽窦融保河西，曷以加之？官事小阕，辄玩习书传，春秋左氏传尤简练精微，吾数以咨问传中诸疑，皆有师说，意思甚密。又尚书兼通古今，大义详备。闻京师古今之学是非忿争，今欲条左氏、尚书长义上之。” 其见称如此。 <a href=\"#fnref51\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n</ol>\n</section>\n","categories":["随记","历史"],"tags":["历史","三国","汉朝","使君","称呼","礼仪"]},{"title":"使用油猴脚本优化期刊阅读体验","url":"/posts/202408-journalviewer.html","content":"<div class=\"note info flat\"><p>安装浏览器油猴（TemperMonkey）拓展请参考：</p>\n<ol>\n<li><a href=\"https://zhuanlan.zhihu.com/p/494577326\">全网最完整 Tampermonkey 油猴脚本管理器安装教程</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/128453110\">Tampermonkey 油猴插件 —— 安装与使用教程</a></li>\n</ol>\n</div>\n<div class=\"note danger flat\"><p>使用油猴脚本请谨慎辨别安全性，使用前仔细阅读脚本的说明文档。<br>\n完整代码可以通过 Greasy Fork 获得：<a href=\"https://greasyfork.org/zh-CN/scripts/503800-journal-viewer\">Journal Viewer</a></p>\n</div>\n<p>在 PC 网页端在线阅读一些期刊时，往往会有一些侧边栏占据了很大的空间，极其影响阅读体验。但是通过查看网页元素，可以发现这些侧边栏存在很明显的特征，我们可以通过 JavaScript 代码来获取这些元素并删除，同时调整正文的样式，获取更好的阅读体验。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/08/16/66bede05abd77.png\" alt=\"图1 APS 原始界面\" style=\"height:200px;\"></div><span class=\"image-caption\">图 1 APS 原始界面</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/08/16/66bede0640b52.png\" alt=\"图2 Science Direct 原始界面\" style=\"height:200px;\"></div><span class=\"image-caption\">图 2 Science Direct 原始界面</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/08/16/66bede06be1d5.png\" alt=\"图3 Nature 原始界面\" style=\"height:200px;\"></div><span class=\"image-caption\">图 3 Nature 原始界面</span></div>\n<p>对于 APS 旗下的期刊，可以使用以下代码：</p>\n<figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> aps_sidebar = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"article-sidebar\"</span>);</span><br><span class=\"line\">aps_sidebar.<span class=\"title function_\">remove</span>();</span><br><span class=\"line\"><span class=\"keyword\">let</span> aps_content = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"article-content\"</span>);</span><br><span class=\"line\">aps_content.<span class=\"property\">style</span>.<span class=\"property\">width</span> = <span class=\"string\">\"100%\"</span>;</span><br></pre></td></tr></tbody></table></figure>\n<p>效果如下图所示。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/08/16/66bedf9396a9a.png\" alt=\"图4 APS 优化后界面\" style=\"height:200px;\"></div><span class=\"image-caption\">图 4 APS 优化后界面</span></div>\n<p>同理可以优化其他期刊。</p>\n","categories":["软件/程序","工具"],"tags":["TemperMonkey","油猴","脚本","文献","期刊"]},{"title":"独立博客自省问卷 15 题 - 2024","url":"/posts/202410-refle-24.html","content":"<blockquote>\n<p>以下问卷纯粹自省自娱，自我调侃，勿对号入座。<br>\n如有不适，请及时关闭浏览器窗口。<br>\n如有启发，建议每隔一段时间服用一次。<br>\nFrom <a href=\"https://yayu.net/4626.html\">独立博客自省问卷 15 题</a></p>\n</blockquote>\n<ol>\n<li>你的博客更新频率是多少？<br>\nA. 每周更新<br>\nB. 一周数篇<br>\nC. 一月 1-2 篇<br>\n✅ D. 几个月一篇</li>\n</ol>\n<blockquote>\n<p>一直很想写，但是懒…… 发 <a href=\"https://foolishfox.cn/memos/\">Memos</a> 更多了。</p>\n</blockquote>\n<ol start=\"2\">\n<li>你的博客上次更新是什么时候？<br>\nA. 本周<br>\nB. 上周<br>\nC. 上个月<br>\n✅ D. 上季度</li>\n</ol>\n<blockquote>\n<p>现在手上还有两三个内容等着写，咕咕咕（<s>这不又水了一篇</s></p>\n</blockquote>\n<ol start=\"3\">\n<li>你的博客文章是原创的吗？<br>\n✅ A. 坚持原创<br>\nB. 部分借鉴<br>\n<a href=\"http://C.AI\">C.AI</a> 帮我写的<br>\nD. 搬运别人的，而且不署名</li>\n</ol>\n<blockquote>\n<p>坚决抵制<s>学术</s>博客不端，内容原创，参考留名</p>\n</blockquote>\n<ol start=\"4\">\n<li>你觉得自己的文章对他人有帮助吗？<br>\nA. 旨在对他人有启示<br>\n✅ B. 多少有点意义<br>\nC. 每日每周流水账<br>\n✅ D. 自我陶醉就好，管他呢</li>\n</ol>\n<blockquote>\n<p>自己以后用得上也是意义</p>\n</blockquote>\n<ol start=\"5\">\n<li>你上次换博客主题 / 程序是什么时候？<br>\nA. 上周<br>\nB. 上个月<br>\n✅ C. 去年<br>\nD. 凭良心说，我多年都是一个主题</li>\n</ol>\n<blockquote>\n<p>从 <a href=\"https://github.com/liuyib/hexo-theme-stun\">stun</a> 迁移过来的，主要像侧边栏 <code>widget</code> 之类的自己写太麻烦，最终找了个现成的</p>\n</blockquote>\n<ol start=\"6\">\n<li>你上一次捣腾博客主题代码是什么时候？<br>\nA. 昨天，撸代码到凌晨<br>\nB. 每周必捣腾<br>\nC. 每月有那么一次<br>\n✅ D. 一年有那么一次</li>\n</ol>\n<blockquote>\n<p>个人博客的意义在于记录与折腾</p>\n</blockquote>\n<ol start=\"7\">\n<li>你会对博客主题进行二次开发？<br>\nA. 直接配置使用，省心不折腾<br>\n✅ B. 时不时自己改改，搞点新花样，换图片，换字体，爽<br>\nC. 删除主题作者版权信息，改改样式，然后自我感觉良好<br>\nD. 改得面目全非，但保留原作者版权信息或注明</li>\n</ol>\n<blockquote>\n<p>同上，有些功能也得自己加，例如首页的 <code>Memos</code> 轮播</p>\n</blockquote>\n<ol start=\"8\">\n<li>你多久打开自己博客自我陶醉一次？<br>\nA. 每天数次<br>\n✅ B. 每周一次<br>\nC. 看心情<br>\nD. 一般都是照镜子，不看博客</li>\n</ol>\n<blockquote>\n<p>因为有 <a href=\"https://foolishfox.cn/link/moments\">Moments 朋友圈</a>的存在，每周都会打开看看博友们发了什么新文章</p>\n</blockquote>\n<ol start=\"9\">\n<li>你近期对自己博客域名什么感受？<br>\nA. 想搞到一个 .COM 的域名<br>\n✅ B. 如果域名能再短几个字符就更好了<br>\nC. 今年才换双拼域名了，明年再看看<br>\nD. 目前挺好，没想法</li>\n</ol>\n<blockquote>\n<p>现在域名虽然好记，但是确实有点太长了，但是又没有什么缩短的方向，<code>ff.cn</code>？还是 <code>ff.sh.cn</code> 或者 <code>ffox</code> 之类的</p>\n</blockquote>\n<ol start=\"10\">\n<li>你每天都会看网站的流量统计吗？<br>\nA. 每天看几次，今天又多了 100PV<br>\n✅ B. 每周回顾，看看流量趋势<br>\nC. 记得就看看<br>\nD. 没有搞流量统计，都是浮云</li>\n</ol>\n<blockquote>\n<p>虽然没什么人，但是自建了 <a href=\"https://umami.foolishfox.cn/dashboard\">Umami</a> 和<a href=\"https://foolishfox.cn/statistics/\">统计</a>，并且每天会自动给我发送报告</p>\n</blockquote>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/10/17/6710f7bc2a765.png\" alt=\"通过<a href=https://sct.ftqq.com/>Server酱</a>发送每日报告\"></div><span class=\"image-caption\">通过 <a href=\"https://sct.ftqq.com/\">Server 酱</a>发送每日报告</span></div>\n<ol start=\"11\">\n<li>你通过博客的广告赚到钱了吗？<br>\nA. 有，能覆盖建站费用<br>\nB. 有，但付出大于收入<br>\nC. 没考虑通过博客流量赚钱<br>\n✅ D. 拒绝广告，保证阅读体验</li>\n</ol>\n<blockquote>\n<p><s>主要是接不到广告</s></p>\n</blockquote>\n<ol start=\"12\">\n<li>你去浏览别人的博客 / 网站主要为什么？<br>\n✅ A. 学习别人分享的知识<br>\nB. 搬运别人的内容<br>\n✅ C. 看看别人怎么装修博客，自己也抄一下，感觉都比自己的好<br>\nD. 不爱看别人博客，自己爱写啥写啥</li>\n</ol>\n<blockquote>\n<p>两者大概三比一吧</p>\n</blockquote>\n<ol start=\"13\">\n<li>看到别人分享了一篇文章，你打开第一反应是什么？<br>\nA. 哇，这域名真不错，怎么我没想到<br>\nB. 哇，这网站速度真快，图片延迟加载丝滑<br>\n✅ C. 哇，这程序 / 主题不错，我也要抄一抄 / 留言问问哪里搞的<br>\n✅ D. 看看文章内容</li>\n</ol>\n<blockquote>\n<p>首看内容，然后跑偏……</p>\n</blockquote>\n<ol start=\"14\">\n<li>你觉得博客哪方面更重要？<br>\nA. 域名<br>\n✅ B. 服务器<br>\nC. 主题<br>\n✅ D. 内容</li>\n</ol>\n<blockquote>\n<p>首重内容，但是也要能打开😂</p>\n</blockquote>\n<ol start=\"15\">\n<li>近期通过写博客有哪些新收获？<br>\n✅ A. 知识面有拓展<br>\n✅ B. 认识了新朋友<br>\n✅ C. 写作水平提升<br>\nD. 通过知识变现</li>\n</ol>\n<blockquote>\n<p>就是主打一个与 Money 无缘</p>\n</blockquote>\n"},{"title":"阻止 Bing/Google 收录自建 Gitea 链接","url":"/posts/202501-bing-gitea.html","content":"<style>\n.imgdiv a {\n    width: 45%;\n}\n</style>\n<p>最近去检查 Bing 和 Google 的网站收录情况，发现收录了一大堆自建的 Gitea 和 Memos 链接，这些链接不太希望直接发布在收索引擎中，而且变换比较快，参考意义不大，所以想阻止被收录。</p>\n<div style=\"margin: 0 auto; display: flex; justify-content: space-around;\" class=\"imgdiv\">\n<img src=\"https://asset.foolishfox.cn/2025/01/15/67871e554f9bb.png\">\n<img src=\"https://asset.foolishfox.cn/2025/01/15/67871e55bb515.png\">\n</div>\n<h2 id=\"临时删除\">临时删除 <a class=\"header-anchor\" href=\"#临时删除\">¶</a></h2>\n<p>如果只需要临时删除这些索引，Google 和 Bing 都提供了入口，不过需要每一定时间手动延期。</p>\n<div style=\"margin: 0 auto; display: flex; justify-content: space-around;\" class=\"imgdiv\">\n<img src=\"https://asset.foolishfox.cn/2025/01/15/678722b971b6b.png\" alt=\"Google 管理界面删除索引入口\">\n<img src=\"https://asset.foolishfox.cn/2025/01/15/678722b9cc279.png\" alt=\"Google 推荐选项\">\n</div>\n<div style=\"margin: 0 auto; display: flex; justify-content: space-around;\" class=\"imgdiv\">\n<img src=\"https://asset.foolishfox.cn/2025/01/15/6787231a133f0.png\" alt=\"Bing 管理界面阻止索引入口\">\n<img src=\"https://asset.foolishfox.cn/2025/01/15/6787231a415e8.png\" alt=\"Bing 推荐选项\">\n</div>\n<h2 id=\"永久阻止\">永久阻止 <a class=\"header-anchor\" href=\"#永久阻止\">¶</a></h2>\n<p>对于使用 docker 部署的 Gitea，按照<a href=\"https://docs.gitea.com/installation/install-with-docker\">官网的安装教程</a>挂载了卷，例如：</p>\n<figure class=\"highlight yaml\"><figcaption><span>docker-compose.yml</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">...</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">docker.io/gitea/gitea:1.23.1</span></span><br><span class=\"line\">    <span class=\"string\">...</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./gitea:/data</span></span><br><span class=\"line\">    <span class=\"string\">...</span></span><br></pre></td></tr></tbody></table></figure>\n<p>容器中的 <code>/data/gitea</code> 目录与宿主机的<code>./gitea/gitea</code> 目录对应，这个目录是用于存放自定义文件的，创建目录 <code>templates/custom</code>，在该目录下创建 <code>header.tmpl</code> 文件，并写入：</p>\n<figure class=\"highlight html\"><figcaption><span>header.tmpl</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">\"robots\"</span> <span class=\"attr\">content</span>=<span class=\"string\">\"noindex\"</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n<p>重启 Gitea 查看效果即可：</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2025/01/15/678721976e722.png\" alt=\"image\" style=\"height:200px;\"></div></div>\n<h2 id=\"搜索过程\">搜索过程 <a class=\"header-anchor\" href=\"#搜索过程\">¶</a></h2>\n<p>在 Google 和 Bing 的官方文档中都提到了不要使用 <code>robots.txt</code> 作为屏蔽机制，而推荐了三种方法：</p>\n<ol>\n<li>将 <code>noindex</code> 元标记添加到页面的 <code>&lt;head&gt;</code> 部分，安全性较低，还可能被收录</li>\n<li>禁止访问（例如需要密码），但操作不现实，除非全部私有化仓库</li>\n<li>移除网站，404 Not Found，更不可行</li>\n</ol>\n<p>所以下一步是查找怎么在 Gitea 中找到页面 <code>&lt;head&gt;</code> 部分并且修改。右键查看自建 Gitea 网页的源代码，找到已有的元标记，然后在 <a href=\"https://github.com/go-gitea/gitea\">Gitea 的官方 Github 仓库</a>中搜索，找到包含这部分的文件，即 <code>templates/base/head.tmpl</code>。</p>\n<div style=\"margin: 0 auto; display: flex; justify-content: space-around;\" class=\"imgdiv\">\n<img src=\"https://asset.foolishfox.cn/2025/01/15/6787249defcb0.png\" alt=\"Gitea 页面源代码\">\n<img src=\"https://asset.foolishfox.cn/2025/01/15/678724e4dcc19.png\" alt=\"Github 仓库搜索结果\">\n</div>\n<p>在代码中包含了这样一段：</p>\n<figure class=\"highlight html\"><figcaption><span>templates/base/head.tmpl</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">\"{{ctx.Locale.Lang}}\"</span> <span class=\"attr\">data-theme</span>=<span class=\"string\">\"{{UserThemeName .SignedUser}}\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">    {{template \"base/head_opengraph\" .}}</span><br><span class=\"line\">    {{template \"base/head_style\" .}}</span><br><span class=\"line\">    {{template \"custom/header\" .}}</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n<p>结合 Gitea 自定义模板的内容，在自定义目录下创建 <code>templates/custom</code>，并在其中创建 <code>header.tmpl</code> 文件，写入：</p>\n<figure class=\"highlight html\"><figcaption><span>header.tmpl</span></figcaption><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">\"robots\"</span> <span class=\"attr\">content</span>=<span class=\"string\">\"noindex\"</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>\n<p>即可实现效果。</p>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://docs.gitea.com/installation/install-with-docker\">Installation with Docker</a></li>\n<li><a href=\"https://support.google.com/webmasters/answer/9689846#block_content\">“移除” 工具和 “安全搜索” 举报工具</a></li>\n<li><a href=\"https://www.bing.com/webmasters/help/block-urls-from-bing-264e560a\">Block URLs from Bing</a></li>\n<li><a href=\"https://github.com/go-gitea/gitea/blob/main/templates/base/head.tmpl\">templates/base/head.tmpl</a></li>\n</ol>\n","categories":["软件/程序","工具"],"tags":["网站收录","bing","google","gitea"]},{"title":"在 zsh 中自动补全命令参数","url":"/posts/202501-zsh-comp.html","content":"<p><a href=\"https://github.com/skywind3000/z.lua\">z.lua</a> 是一个很好的工具，可以快速地进入想要的目录。我在本机 WSL 和多个服务器上都安装了这个程序，但是在执行一些命令（例如 <code>z -c</code>，在当前目录下的子目录中选择）的时候，自动补全有时候可以用，有时候不能用，很不方便。所以我决定自己写一个 <code>zsh</code> 的自动补全脚本。</p>\n<h2 id=\"实现\">实现 <a class=\"header-anchor\" href=\"#实现\">¶</a></h2>\n<p>首先，通过 <code>which z</code> 命令拿到实际的命令执行函数：</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2025/01/06/677ba7f259a48.png\" alt=\"image\" style=\"height:100px;\"></div></div>\n<p>在 <code>z.lua</code> 脚本中给出了如何对 <code>z</code> 命令进行补全的方法：</p>\n<figure class=\"highlight zsh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"title\">_zlua_zsh_tab_completion</span></span>() {</span><br><span class=\"line\">\t<span class=\"comment\"># tab completion</span></span><br><span class=\"line\">\t(( $+compstate )) &amp;&amp; compstate[insert]=menu <span class=\"comment\"># no expand</span></span><br><span class=\"line\">\t<span class=\"built_in\">local</span> -a tmp=(<span class=\"variable\">${(f)\"$(_zlua --complete \"<span class=\"variable\">${words/_zlua/z}</span>\")\"}</span>)</span><br><span class=\"line\">\t_describe <span class=\"string\">\"directory\"</span> tmp -U</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">${+functions[compdef]}</span>\"</span> -ne 0 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">\tcompdef _zlua_zsh_tab_completion _zlua 2&gt; /dev/null</span><br><span class=\"line\">\tcompdef <span class=\"variable\">${_ZL_CMD:-z}</span>=_zlua</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></tbody></table></figure>\n<p>其中：</p>\n<ul>\n<li><code>_zlua_zsh_tab_completion</code> 是自动补全函数；</li>\n<li><code>${(f)\"$(_zlua --complete \"${words/_zlua/z}\")\"}</code> 是获取补全的内容，并且按照每行分割转化为数组；</li>\n<li><code>_describe</code> 是定义补全的内容，第一个参数是描述，第二个参数是补全的内容；</li>\n<li><code>compdef</code> 是定义自动补全函数，第一个参数是自动补全函数，第二个参数是实际的命令执行函数。</li>\n</ul>\n<p>参照上面的内容写了一个自动补全脚本：</p>\n<figure class=\"highlight zsh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"title\">_z_comp</span></span>() {</span><br><span class=\"line\">    <span class=\"built_in\">local</span> -a list=(<span class=\"variable\">${(f)\"$(_zlua --complete \"<span class=\"variable\">${words/_zlua/z}</span>\")\"}</span>)</span><br><span class=\"line\">    _describe <span class=\"string\">\"directory\"</span> list -U</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">_zc_comp</span></span>() {</span><br><span class=\"line\">    <span class=\"built_in\">local</span> -a list=(<span class=\"string\">\"<span class=\"variable\">${(@f)$(fdfind -t d -d 1 .)}</span>\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> ((i=<span class=\"number\">1</span>;i&lt;=<span class=\"variable\">$#list</span>;i++)){</span><br><span class=\"line\">        list[i]=<span class=\"variable\">${list[i]/\\//}</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">    _describe <span class=\"string\">\"subdirectory\"</span> list -U</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">_zlua_comp</span></span>() {</span><br><span class=\"line\">    _arguments -C -S -s \\</span><br><span class=\"line\">        <span class=\"string\">'*:enter directory order by frecent:_z_comp'</span>  \\</span><br><span class=\"line\">        <span class=\"string\">'-c:enter subdirectory:_zc_comp'</span></span><br><span class=\"line\">}</span><br><span class=\"line\">compdef _zlua_comp _zlua &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\">compdef <span class=\"variable\">${_ZL_CMD:-z}</span>=_zlua</span><br></pre></td></tr></tbody></table></figure>\n<p>首先定义了两个补全函数 <code>_z_comp</code> 和 <code>_zc_comp</code>，分别对应 <code>z</code> 和 <code>z -c</code> 命令的补全内容。然后定义了一个 <code>_zlua_comp</code> 函数，通过 <code>_arguments</code> 定义了命令的参数和补全内容。最后通过 <code>compdef</code> 定义了自动补全函数。需要注意的是，<code>_zc_comp</code> 函数中得到的子目录是带有 <code>/</code> 的，所以需要去掉 <code>/</code>，否则可能会进入到所选择子目录下的深度更深的目录：</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2025/01/07/677bff470f203.png\" alt=\"image\" style=\"height:100px;\"></div></div>\n<p>最后在脚本末尾加入：</p>\n<figure class=\"highlight zsh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">autoload</span> -Uz compinit &amp;&amp; compinit</span><br></pre></td></tr></tbody></table></figure>\n<p>这样就可以实现自动补全：</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2025/01/07/677c022581eb5.gif\" alt=\"image\" style=\"height:150px;\"></div></div>\n<h2 id=\"FZF\">FZF<a class=\"header-anchor\" href=\"#FZF\">¶</a></h2>\n<p>如果想要使用 <code>fzf</code>，同样可以参考 <code>z.lua</code> 中的 <code>script_fzf_complete_zsh</code> 脚本，一个示例如下：</p>\n<figure class=\"highlight zsh\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">bindkey</span> <span class=\"string\">'\\e[0n'</span> kill-whole-line</span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">_z_comp</span></span>() {</span><br><span class=\"line\">    <span class=\"built_in\">local</span> list=$(_zlua -l <span class=\"variable\">${words[2,-1]}</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$list</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">local</span> selected=$(<span class=\"built_in\">print</span> <span class=\"variable\">$list</span> | <span class=\"variable\">${=zlua_fzf}</span> | sed <span class=\"string\">'s/^[0-9,.]* *//'</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$selected</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">cd</span> <span class=\"variable\">${selected}</span></span><br><span class=\"line\">            <span class=\"built_in\">printf</span> <span class=\"string\">'\\e[5n'</span></span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">_zc_comp</span></span>() {</span><br><span class=\"line\">    <span class=\"built_in\">local</span> -a list=(<span class=\"string\">\"<span class=\"variable\">${(@f)$(fdfind -t d -d 1 .)}</span>\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> ((i=<span class=\"number\">1</span>;i&lt;=<span class=\"variable\">$#list</span>;i++)){</span><br><span class=\"line\">        list[i]=<span class=\"variable\">${list[i]/\\//}</span></span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$list</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">local</span> selected=$(<span class=\"built_in\">print</span> <span class=\"variable\">$list</span> | awk -F <span class=\"string\">\" \"</span> <span class=\"string\">'{for(row=1;row&lt;=NF;row++) print $row;}'</span> | <span class=\"variable\">${=zlua_fzf}</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$selected</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">cd</span> <span class=\"variable\">${selected}</span></span><br><span class=\"line\">            <span class=\"built_in\">printf</span> <span class=\"string\">'\\e[5n'</span></span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">_zlua_comp</span></span>() {</span><br><span class=\"line\">    _arguments -C -S -s \\</span><br><span class=\"line\">        <span class=\"string\">'*:enter directory order by frecent:_z_comp'</span>  \\</span><br><span class=\"line\">        <span class=\"string\">'-c:enter subdirectory:_zc_comp'</span></span><br><span class=\"line\">}</span><br><span class=\"line\">compdef _zlua_comp _zlua &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\">compdef <span class=\"variable\">${_ZL_CMD:-z}</span>=_zlua</span><br></pre></td></tr></tbody></table></figure>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><a href=\"https://zsh.sourceforge.io/Doc/Release/Completion-System.html\">Completion System</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/466684661\">给 zsh 自定义命令添加参数自动补全</a></li>\n<li><a href=\"https://www.cnblogs.com/wang_yb/p/5969451.html\">命令行自动补全原理</a></li>\n<li><a href=\"https://thevaluable.dev/zsh-completion-guide-examples/\">A Guide to the Zsh Completion with Examples</a></li>\n</ol>\n","categories":["软件/程序","工具"],"tags":["zsh","shell","linux"]},{"title":"博客成长日志 | 又一次服务器迁移","url":"/posts/202411-migrate-24.html","content":"<p>之前本站一直使用的腾讯云轻量应用服务器服务器一次性买了 3 年，这个月月底就要到期了，但是一看续费的价格，十分的美丽。其实服务器的 4 个核心一直负载都不大，但是内存使用经常在 3G 作用，因此综合考虑下决定入手一个 2H4G 的服务器，再通过自定义镜像迁移过去。</p>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/11/06/672b719af0074.png\" alt=\"图1 同配置续费3年的价格\" style=\"height:200px;\"></div><span class=\"image-caption\">图 1 同配置续费 3 年的价格</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2024/11/06/672b7221cd570.png\" alt=\"图2 双十一活动新购服务器\" style=\"height:200px;\"></div><span class=\"image-caption\">图 2 双十一活动新购服务器</span></div>\n<p>但是正当我购置好了服务器，正打算用自定义镜像重装系统的时候，请注意图中两个服务器的硬盘大小，旧的服务器硬盘是 80 GB，虽然我只使用了 40+ GB，但是导出的镜像是完整的 80 GB，而新的服务器硬盘只有 70 GB😒😒😒。</p>\n<p>于是只好手动把所有的内容同步到新的服务器上去了，幸好基本大部分的数据都在 home 目录下，同时万分感谢自己在从阿里云迁移到腾讯云的时候将所有的服务都使用 Docker 进行了容器化，所以一行命令迁移：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">scp -r <span class=\"variable\">$HOME</span>/docker user@IP:/home/user</span><br></pre></td></tr></tbody></table></figure>\n<p>然后在新服务器上安装 Docker，启动所有的容器就解决了大部分的工作，仅剩的是一些 Docker 的配置文件，也使用 scp 复制过去就行，两台服务器都在同一个区域，直接使用内网 IP 的传输速度还是挺快的，哪怕有很多的小文件。</p>\n<p>so，that’s all，新的服务器已经<s>（看上去）</s>正常运行。如果算上一次同价续费和拼团赠送的 3 个月有效期，这次又能苟 2 年多，希望不要有什么问题。</p>\n<p>PS：腾讯云最近开放了 IPv6 的测试申请，已经通过了，后面捣鼓一下看看有啥用处。下一期讲一下在 Portainer 里面 TLS 连接远程的 Docker 服务。</p>\n","categories":["软件/程序","博客成长日志"],"tags":["服务器","Docker","腾讯云"]},{"title":"Geant4 综合模板","url":"/posts/202502-g4template.html","content":"<p>几年前在 <a href=\"https://foolishfox.cn/posts/202204-g4b.html\">Geant4 示例</a> 中我介绍了 Windows 下 Geant4 的安装与示例。今天分享一个 Geant4 综合模板，帮助快速开始一个项目，实现了以下功能：</p>\n<ul>\n<li>构建模块化的 TAS 探测器</li>\n<li>统计模拟过程中的核反应信息，包括类型、反应道、产物能量分布、伽马射线母核统计等 (<a href=\"#1\">1</a>, <a href=\"#2\">2</a>)</li>\n<li> 利用 Sensitive Detector 统计粒子在探测器中的沉积能量 (<a href=\"#3\">3</a>)</li>\n<li> 通过 Analysis Manager 保存数据到 ROOT 文件 (<a href=\"#4\">4</a>, <a href=\"#5\">5</a>)</li>\n</ul>\n<p>模板的核心功能时序图如下：</p>\n<pre class=\"mermaid\">sequenceDiagram\nautonumber\npar\n    RunManager-&gt;&gt;RunStat: Initialization\nand\n    RunManager-&gt;&gt;AnalysisManager: Initialization\nend\nRunManager-&gt;&gt;+Run: Begin run\nrect rgb(200, 150, 255)\nRun-&gt;&gt;SD: Initialization\nend\nloop Number of particles\n    Run-&gt;&gt;+Event: Primary Generator\n    Event-&gt;&gt;+Step: Particle Transport\n    loop Particle alive\n        rect rgb(191, 223, 255)\n        alt Have secondary particles\n            Step--&gt;&gt;RunStat: Reaction information\n        else In SD\n            Step--&gt;&gt;SD: Step information\n        end\n        end\n        Step-&gt;&gt;Step: Particle Transport\n    end\n    Step-&gt;&gt;-Event: E = 0 or been absorbed\n    rect rgb(200, 150, 255)\n    SD--&gt;&gt;AnalysisManager: SD statistics\n    end\n    Event-&gt;&gt;-Run: End event\nend\nAnalysisManager--&gt;&gt;Output: Data file (root format or others)\nRun-&gt;&gt;-RunManager: End run\nRunStat--&gt;&gt;Output: Reaction statistics\n</pre>\n<style>\n.mermaid {\n    background: var(--heo-background) !important;\n}\n</style>\n<script type=\"module\">\n    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';\n</script>\n<h2 id=\"主要功能\">主要功能 <a class=\"header-anchor\" href=\"#主要功能\">¶</a></h2>\n<h3 id=\"SD，Hits与Analysis-Manager\">SD，Hits 与 Analysis Manager<a class=\"header-anchor\" href=\"#SD，Hits与Analysis-Manager\">¶</a></h3>\n<p>Sensitive detector 和 Hits 是 Geant4 中的重要工具，用于统计粒子径迹在我们感兴趣的区域沉积的能量。在模板中，我们定义了一个 Sensitive detector: <code>TemplateSD</code>，用于划定感兴趣的区域；以及一个 Hits 类: <code>TemplateHit</code>，用于记录所需要的信息（例如沉积能量、粒子类别、名称等）。</p>\n<p>由于不同人员的需求以及工具喜好不同，Geant4 并没有提供一个完备的数据分析工具，但是通过 <code>G4AnalysisManager</code> 实现了对于数据的管理。数据可以分为两类：<code>n-tuple</code> 和 <code>histogram</code>，前者类似于表格，行是每一个事件，列是各种物理信息；后者是对于某一物理量的统计，例如能量分布、角度分布等。<code>G4AnalysisManager</code> 类是<strong>线程安全</strong>的，并且可以自动合并多线程的数据。(<a href=\"#5\">5</a>)</p>\n<p><code>TemplateSD::ProcessHits</code> 函数将 <code>TemplateHit</code> 的信息收集到 <code>TemplateHitsCollection</code> 中，随后在 <code>EventAction::EndOfEventAction</code> 函数中读出，并且通过 <code>analysisManager</code>（<code>G4AnalysisManager</code> 类的实例）保存，最后在 <code>RunAction::EndOfRunAction</code> 中输出到 ROOT 文件中。</p>\n<h3 id=\"核反应统计\">核反应统计 <a class=\"header-anchor\" href=\"#核反应统计\">¶</a></h3>\n<p>统计的过程完全发生在 <code>SteppingAction::UserSteppingAction</code> 方法中，并定义了 <code>RunStat</code> 类进行协助。<code>RunStat</code> 类的主要功能是记录核反应的信息（例如反应类型、反应道与 Q 值）以及核反应产物的信息（例如产物能量、数量，以及伽马射线的母核统计），这些信息在 <code>RunStat::print</code> 中输出到日志文件中，同时也保存在 <code>analysisManager</code> 中。</p>\n<h2 id=\"示例\">示例 <a class=\"header-anchor\" href=\"#示例\">¶</a></h2>\n<h3 id=\"探测器构建\">探测器构建 <a class=\"header-anchor\" href=\"#探测器构建\">¶</a></h3>\n<ul>\n<li> 靶\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Φ</mi></mrow><annotation encoding=\"application/x-tex\">\\Phi</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Φ</span></span></span></span> 15 mm</li>\n<li> 样品: 100% <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mrow></mrow><mn>98</mn></msup><mrow><mi mathvariant=\"normal\">M</mi><mi mathvariant=\"normal\">o</mi></mrow></mrow><annotation encoding=\"application/x-tex\">^{98}\\mathrm{Mo}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">9</span><span class=\"mord mtight\">8</span></span></span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathrm\">M</span><span class=\"mord mathrm\">o</span></span></span></span></span>, 1.5 um 绿色 (红色)</li>\n<li> 衬底: Al, 5 um 绿色 (蓝色)</li>\n</ul>\n</li>\n<li> 探测器\n<ul>\n<li>Si: 10 mm <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>×</mo></mrow><annotation encoding=\"application/x-tex\">\\times</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord\">×</span></span></span></span> 10 mm <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>×</mo></mrow><annotation encoding=\"application/x-tex\">\\times</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord\">×</span></span></span></span> 3 mm (白色)</li>\n<li>BGO: 100 mm <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>×</mo></mrow><annotation encoding=\"application/x-tex\">\\times</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord\">×</span></span></span></span> 100 mm <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>×</mo></mrow><annotation encoding=\"application/x-tex\">\\times</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord\">×</span></span></span></span> 200 mm, 六边形\n<ul>\n<li>中心：束流孔 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Φ</mi></mrow><annotation encoding=\"application/x-tex\">\\Phi</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Φ</span></span></span></span> 40 mm (黄色，1 个)</li>\n<li> 外层 (灰色，总计 6 个)</li>\n</ul>\n</li>\n</ul>\n</li>\n<li> 屏蔽\n<ul>\n<li>PEEK: <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Φ</mi></mrow><annotation encoding=\"application/x-tex\">\\Phi</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Φ</span></span></span></span> 20 ~ 35 mm, 200 mm 长 (青色)</li>\n<li>Pb: 50 mm 厚 (绿色)</li>\n</ul>\n</li>\n</ul>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2025/02/21/67b841b177649.png\" alt=\"探测器侧视图\" style=\"height:300px;\"></div><span class=\"image-caption\">探测器侧视图</span></div>\n<h3 id=\"核反应统计-v2\">核反应统计 <a class=\"header-anchor\" href=\"#核反应统计-v2\">¶</a></h3>\n<p>入射粒子为 13 MeV 的质子，反应主要以库伦散射为主，质子非弹主要以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mrow></mrow><mn>98</mn></msup><mrow><mi mathvariant=\"normal\">M</mi><mi mathvariant=\"normal\">o</mi></mrow></mrow><annotation encoding=\"application/x-tex\">^{98}\\mathrm{Mo}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">9</span><span class=\"mord mtight\">8</span></span></span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathrm\">M</span><span class=\"mord mathrm\">o</span></span></span></span></span> 的 (n,p) 反应为主，产物为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mrow></mrow><mn>98</mn></msup><mrow><mi mathvariant=\"normal\">T</mi><mi mathvariant=\"normal\">c</mi></mrow></mrow><annotation encoding=\"application/x-tex\">^{98}\\mathrm{Tc}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">9</span><span class=\"mord mtight\">8</span></span></span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathrm\">T</span><span class=\"mord mathrm\">c</span></span></span></span></span></p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">&gt;&gt;&gt; Process calls frequency:</span><br><span class=\"line\">         CoulombScat =     103207</span><br><span class=\"line\">     Radioactivation =       2522</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;&gt;&gt; List of nuclear reactions: </span><br><span class=\"line\">                         As75[264.658] --&gt; N gamma or e- + As75 / Radioactivation:       1   Q =      264.658 keV</span><br><span class=\"line\">                         ...</span><br><span class=\"line\">                                                   gamma --&gt; N gamma or e- / phot:  121754   Q =     -249.463 eV </span><br><span class=\"line\">                                          gamma --&gt; gamma + N gamma or e- / compt:   46219   Q =            0 eV </span><br><span class=\"line\">                                          ...</span><br><span class=\"line\">               proton + Mo98 --&gt; N gamma or e- + neutron + Tc98 / protonInelastic:    5106   Q =     -3.47829 MeV</span><br><span class=\"line\">               ...</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;&gt;&gt; List of generated particles:</span><br><span class=\"line\">               As75 :        18  Emean =      9.91766 eV \t(  501.954 meV --&gt;  15.9164 eV )</span><br><span class=\"line\">               ...</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;&gt;&gt; List of gamma parents:</span><br><span class=\"line\">     0 :            Tc98 up</span><br><span class=\"line\">     ...</span><br></pre></td></tr></tbody></table></figure>\n<h3 id=\"伽马能谱与母核\">伽马能谱与母核 <a class=\"header-anchor\" href=\"#伽马能谱与母核\">¶</a></h3>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2025/02/21/67b8434e12ba3.png\" alt=\"Mo-98的伽马能谱（产物为Mo-98基态）\" style=\"height:300px;\"></div><span class=\"image-caption\">Mo-98 的伽马能谱（产物为 Mo-98 基态）</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2025/02/21/67b8434e57835.png\" alt=\"单块BGO伽马总能谱\" style=\"height:300px;\"></div><span class=\"image-caption\">单块 BGO 伽马总能谱</span></div>\n<div class=\"img-wrap\"><div class=\"img-bg\"><img class=\"lazyload lazyload-gif zooming\" src=\"https://asset.foolishfox.cn/2025/02/21/67b8434edd9a6.png\" alt=\"1.607~1.610 MeV伽马射线母核统计\" style=\"height:300px;\"></div><span class=\"image-caption\">1.607~1.610 MeV 伽马射线母核统计</span></div>\n<h2 id=\"跳转链接\">跳转链接 <a class=\"header-anchor\" href=\"#跳转链接\">¶</a></h2>\n<div class=\"flink\"><div class=\"flink-list\">\n      <div class=\"flink-list-item\">\n        <a href=\"https://foolishfox.cn/posts/202204-g4b.html\" title=\"Geant4 示例\" target=\"_blank\">\n          <div class=\"flink-item-icon\">\n            <img class=\"no-lightbox\" src=\"https://asset.foolishfox.cn/2023/07/22/64bb4e6fc0c4a.png\" onerror=\"this.onerror=null;this.src=&quot;/img/friend_404.gif&quot;\" alt=\"Geant4 示例\">\n          </div>\n          <div class=\"flink-item-name\">Geant4 示例</div>\n          <div class=\"flink-item-desc\" title=\"Windows 下 Geant4 的安装与示例\">Windows 下 Geant4 的安装与示例</div>\n        </a>\n      </div>\n      <div class=\"flink-list-item\">\n        <a href=\"https://git.foolishfox.cn/fox/G4Template\" title=\"G4Template\" target=\"_blank\">\n          <div class=\"flink-item-icon\">\n            <img class=\"no-lightbox\" src=\"https://asset.foolishfox.cn/2025/02/21/67b82e1c1a0d4.png\" onerror=\"this.onerror=null;this.src=&quot;/img/friend_404.gif&quot;\" alt=\"G4Template\">\n          </div>\n          <div class=\"flink-item-name\">G4Template</div>\n          <div class=\"flink-item-desc\" title=\"Geant4 综合模板\">Geant4 综合模板</div>\n        </a>\n      </div></div></div>\n<h2 id=\"参考资料\">参考资料 <a class=\"header-anchor\" href=\"#参考资料\">¶</a></h2>\n<ol>\n<li><span id=\"refer-1\"><a href=\"https://geant4-userdoc.web.cern.ch/Doxygen/examples_doc/html/ExampleHadr03.html\">Example Hadr03</a></span></li>\n<li><span id=\"refer-2\"><a href=\"https://geant4-forum.web.cern.ch/t/differences-with-physics-list-choice-in-hadr03-example/11492\">Differences with physics list choice in Hadr03 example</a></span></li>\n<li><span id=\"refer-3\"><a href=\"https://geant4-userdoc.web.cern.ch/Doxygen/examples_doc/html/ExampleB2.html\">Example B2</a></span></li>\n<li><span id=\"refer-4\"><a href=\"https://geant4-userdoc.web.cern.ch/Doxygen/examples_doc/html/ExampleB4.html\">Example B4</a></span></li>\n<li><span id=\"refer-5\"><a href=\"https://indico.cern.ch/event/776050/contributions/3241822/attachments/1789267/2921102/Analysis-v3.pdf\">ANALYSIS</a></span></li>\n</ol>\n","categories":["软件/程序","Geant4"],"tags":["核技术","Geant4","C/C++"]}]